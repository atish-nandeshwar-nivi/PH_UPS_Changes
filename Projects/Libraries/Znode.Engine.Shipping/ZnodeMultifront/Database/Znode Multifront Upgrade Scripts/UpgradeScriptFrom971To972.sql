IF EXISTS (SELECT TOP 1 1 FROM Sys.Tables WHERE Name = 'ZnodeMultifront')
BEGIN 
IF EXISTS (SELECT TOP 1 1 FROM ZnodeMultifront where BuildVersion =   972 and VersionName = 'Znode_Multifront_9_7_2_GA' )
BEGIN 
PRINT 'Script is already executed....'
 SET NOEXEC ON 
END 
END
ELSE 
BEGIN 
  SET NOEXEC ON
END 
INSERT INTO [dbo].[ZnodeMultifront] ( [VersionName], [Descriptions], [MajorVersion], [MinorVersion], [LowerVersion], [BuildVersion], [PatchIndex], [CreatedBy], 
[CreatedDate], [ModifiedBy], [ModifiedDate]) 
VALUES ( N'Znode_Multifront_9_7_2_GA', N'Upgrade GA Release by 972',9,7,2,972,0,2, GETDATE(),2, GETDATE())
GO 
SET ANSI_NULLS ON
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup
GO

IF EXISTS(SELECT 1 FROM sys.types WHERE is_table_type = 1 AND name = 'TT_SavecartLineitems')
	DROP TYPE TT_SavecartLineitems;
GO
	CREATE TYPE [dbo].[TT_SavecartLineitems] AS TABLE (
    [RowId]                           INT             NULL,
    [OmsSavedCartLineItemId]          INT             NULL,
    [ParentOmsSavedCartLineItemId]    INT             NULL,
    [OmsSavedCartId]                  INT             NULL,
    [SKU]                             NVARCHAR (600)  NULL,
    [Quantity]                        NUMERIC (28, 6) NULL,
    [OrderLineItemRelationshipTypeID] INT             NULL,
    [CustomText]                      NVARCHAR (MAX)  NULL,
    [CartAddOnDetails]                NVARCHAR (MAX)  NULL,
    [Sequence]                        INT             NULL,
    [AddOnValueIds]                   VARCHAR (MAX)   NULL,
    [BundleProductIds]                VARCHAR (MAX)   NULL,
    [ConfigurableProductIds]          VARCHAR (MAX)   NULL,
    [GroupProductIds]                 VARCHAR (MAX)   NULL,
    [PersonalisedAttribute]           XML             NULL,
    [AutoAddon]                       VARCHAR (MAX)   NULL,
    [OmsOrderId]                      INT             NULL,
    [ItemDetails]                     NVARCHAR (MAX)  NULL,
    [Custom1]                         NVARCHAR (MAX)  NULL,
    [Custom2]                         NVARCHAR (MAX)  NULL,
    [Custom3]                         NVARCHAR (MAX)  NULL,
    [Custom4]                         NVARCHAR (MAX)  NULL,
    [Custom5]                         NVARCHAR (MAX)  NULL,
    [GroupId]                         NVARCHAR (MAX)  NULL,
    [ProductName]                     NVARCHAR (1000) NULL,
    [Description]                     NVARCHAR (MAX)  NULL,
    [AddOnQuantity]                   NVARCHAR (MAX)  NULL
	);

GO

IF EXISTS(SELECT 1 FROM sys.views WHERE name='View_CustomerReferralCommissionDetail' AND type='v')
DROP VIEW View_CustomerReferralCommissionDetail;
GO

CREATE VIEW [dbo].[View_CustomerReferralCommissionDetail]
AS
SELECT DISTINCT A.UserId, C.ReferralCommission, A.ReferralStatus, B.Name, C.ReferralCommissionTypeId, C.OmsReferralCommissionId, 
	C.OmsOrderDetailsId, C.Description, C.OrderCommission, F.CurrencyCode, H.OrderNumber, ZC.CultureCode
FROM dbo.ZnodeUser AS A
INNER JOIN dbo.ZnodeOmsReferralCommission AS C ON A.UserId = C.UserId 
INNER JOIN dbo.ZnodeReferralCommissionType AS B ON C.ReferralCommissionTypeId = B.ReferralCommissionTypeId 
INNER JOIN dbo.ZnodeUserPortal AS D ON A.UserId = D.UserId 
INNER JOIN dbo.ZnodePortalUnit AS E ON D.PortalId = E.PortalId 
INNER JOIN dbo.ZnodeCurrency AS F ON E.CurrencyId = F.CurrencyId 
INNER JOIN dbo.ZnodeOmsOrderDetails AS G ON C.OmsOrderDetailsId = G.OmsOrderDetailsId 
INNER JOIN dbo.ZnodeOmsOrder AS H ON G.OmsOrderId = H.OmsOrderId
INNER JOIN dbo.ZnodeCulture ZC ON F.CurrencyId = ZC.CurrencyId AND ZC.IsDefault = 1
GO

update ZnodeEmailTemplateLocale 
set Content = '<!DOCTYPE html><html><body><p></p>  <div>  <div style="font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;">  <div style="background-color: #eff3fb; color: #292a2a; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;">#StoreLogo# #SiteName# Customer Receipt</div>  <div style="padding: 10px;">  <div style="font-family: Verdana; color: #333333; font-size: 11px;">#ReceiptText#</div>  <table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0">  <tbody>  <tr>  <td colspan="5"><hr /></td>  </tr>  <tr>  <td colspan="2" align="left" nowrap="nowrap" width="25%">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div>  </td>  <td colspan="2" align="left" nowrap="nowrap">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div>  </td>  </tr>  <tr>  <td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td>  <td align="left" nowrap="nowrap" width="30%">#OrderId#</td>  <td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td>  <td align="left" nowrap="nowrap">#CustomerServiceEmail#</td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Order Date:</strong></td>  <td align="left" nowrap="nowrap">#OrderDate#</td>  <td align="left" nowrap="nowrap"><strong>Phone:</strong></td>  <td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td>  </tr>  <tr>  <td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong></td>  <td align="left" nowrap="nowrap">#PromotionCode#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td>  <td align="left" nowrap="nowrap">#PaymentName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>#CardTransactionLabel#</strong></td>  <td align="left" nowrap="nowrap">#CardTransactionID#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap" style="padding-right: 10px;"><strong>#PurchaseNumberLabel#:</strong></td>  <td align="left" nowrap="nowrap">#PONumber#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>AccountNumber:</strong></td>  <td align="left" nowrap="nowrap">#AccountNumber#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>ShippingMethod:</strong></td>  <td align="left" nowrap="nowrap">#ShippingName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Job / Project Name:</strong></td>  <td align="left" nowrap="nowrap">#JobName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td colspan="4"><hr /></td>  </tr>  <tr>  <td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div>  </td>  <td colspan="2" align="left">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div>  </td>  </tr>  <tr>  <td colspan="2" align="Left" nowrap="nowrap">#BillingAddress#</td>  <td colspan="3" valign="top">#ShippingAddress#</td>  </tr>  <tr>  <td align="Left" nowrap="nowrap" colspan="2"> </td>  <td valign="top" colspan="3"><hr /><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelInHandDate#: </span>#InHandDate#<br /><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelShippingConstraintsCode#: </span>#ShippingConstraintCode#<br /><br /></td>  </tr>  <tr>  <td colspan="7"></td>  </tr>  </tbody>  </table>  <div data-info="#AddressItems#">  <table width="100%" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">#ShipmentNo#</td>  </tr>  <tr>  <td style="color: black; font-size: 10px;" colspan="6">#ShipTo#</td>  </tr>  <tr style="background-color: #eff3fb;">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="2"><strong>Total</strong></td>  </tr>  <tr data-info="#LineItems#OmsOrderShipmentID##">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#  <p>#ShortDescription#</p>  #UOMDescription# <br /><br />#Column1#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#Price#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#ExtendedPrice#</td>  </tr>  <tr data-info="#AmountLineItems#OmsOrderShipmentID##">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#Amount#</td>  </tr>  <tr data-info="#GrandAmountLineItems#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#Amount#</td>  </tr>  <tr data-info="#TaxSummaryHead#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right"><strong>#TaxName#</strong></td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%"><strong>#Rates#</strong></td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right"><strong>#Amount#</strong></td>  </tr>  <tr data-info="#TaxSummary#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right">#TaxName#</td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%">#Rates#</td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right">#Amount#</td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2"><strong>#TotalCost#</strong></td>  </tr>  </tbody>  </table>  </div>  <table style="width: 100%; padding: 10px; display: inline-block;" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">#AdditionalInstructLabel#</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2">  <div style="width: 675px;" align="justify">#AdditionalInstructions#</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2">  <div style="margin-bottom: 5px;"></div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">#FeedBack#</td>  </tr>  </tbody>  </table>  </div>  </div>  </div></body></html>'
where EmailTemplateId = (select top 1 EmailTemplateId from ZnodeEmailTemplate where TemplateName='OrderReceipt')
	and LocaleId = 1

GO

Update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>HighlightId</name>      <headertext>Checkbox</headertext>      <width>10</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>HighlightId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>Image</name>      <headertext>Image</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Single</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>MediaPath,HighlightName</imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>imageicon</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>HighlightName</name>      <headertext>Name</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/Highlight/Edit</islinkactionurl>      <islinkparamfield>HighlightId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>HighlightType</name>      <headertext>Highlight Type</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>IsActive</name>      <headertext>Status</headertext>      <width>10</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>DisplayOrder</name>      <headertext>Display Order</headertext>      <width>10</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>MediaId</name>      <headertext>MediaId</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Highlight/Edit|/Highlight/Delete</manageactionurl>      <manageparamfield>HighlightId,LocaleId|HighlightId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
Where ItemName = 'ZnodeHighlight'

GO

Update ZnodeOmsOrderState 
set OrderStateName = 'CANCELED' , Description = 'Canceled' 
where OrderStateName = 'CANCELLED'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'ZnodeDevExpressReport_GetCouponFiltered')
	DROP PROC ZnodeDevExpressReport_GetCouponFiltered
GO

CREATE PROCEDURE [dbo].[ZnodeDevExpressReport_GetCouponFiltered]  
(   
 @BeginDate  DATE        ,  
 @EndDate  DATE         ,  
 @StoreName  VARCHAR(MAX)  = '',  
 @DiscountType   NVARCHAR(MAX) 
)  
AS   
/*  
     Summary:- this procedure is used to get coupon filtered ( include promotion details )  
      
     EXEC ZnodeDevExpressReport_GetCouponFiltered_bak @PromotionCode = 'sale10' ,@DiscountType = 'pro', @BeginDate = '2019-05-07 10:46:57.190', @EndDate = '2019-05-07 10:53:17.617'  
  
   EXEC ZnodeDevExpressReport_GetCouponFiltered  @BeginDate = '2019-05-08 11:56:45.570', @EndDate = '2019-05-15 12:49:34.120'  , @DiscountType ='PROMOCODE|COUPONCODE'
*/  
     BEGIN  
  BEGIN TRY  
         SET NOCOUNT ON;   
  
  
      DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('PriceRoundOff'); 
	  DECLARE @DefaultCurrencySymbol varchar(100) = dbo.Fn_GetDefaultCurrencySymbol() 
  
   CREATE TABLE #TBL_PortalId (PortalId INT );  
   INSERT INTO #TBL_PortalId  
   SELECT PortalId   
   FROM ZnodePortal ZP   
   INNER JOIN dbo.split(@StoreName,'|') SP ON (SP.Item = ZP.StoreName)  
  
   CREATE TABLE #ZnodeOmsOrderDiscount ( OmsOrderDetailsId  INT,OmsOrderLineItemId INT,OmsDiscountTypeId  INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28, 6),  
   Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME,PortalId INT,Total NUMERIC(28, 6), Symbol NVARCHAR(100), OmsOrderDate Datetime,
   OmsOrderDiscountId INT);  
  

   INSERT INTO #ZnodeOmsOrderDiscount  
   (OmsOrderDetailsId,OmsDiscountTypeId,DiscountCode,DiscountAmount,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PortalId,Total,Symbol, OmsOrderDate,OmsOrderDiscountId)  
   SELECT Distinct ISNULL(zood.OmsOrderDetailsId, zooli.OmsOrderDetailsId) OmsOrderDetailsId,zood.OmsDiscountTypeId,zood.DiscountCode,zood.DiscountAmount,zood.Description,  
   zood.CreatedBy,zood.CreatedDate, zood.ModifiedBy,zood.ModifiedDate,zoods.PortalId, zoods.Total, ISNULL(ZC.Symbol,@DefaultCurrencySymbol) Symbol,zoods.OrderDate
   ,zood.OmsOrderDiscountId  
   FROM ZnodeOmsOrderDiscount AS zood  
   INNER JOIN ZnodeOmsDiscountType ODT ON (ODT.OmsDiscountTypeId = zood.OmsDiscountTypeId)  
   LEFT  JOIN ZnodeOmsOrderLineItems AS zooli ON zood.OmsOrderLineItemId = zooli.OmsOrderLineItemsId  
   LEFT  JOIN ZnodeOmsOrderDetails AS zoods ON ISNULL(zood.OmsOrderDetailsId, zooli.OmsOrderDetailsId) = zoods.OmsOrderDetailsId  
   INNER JOIN ZnodeOmsOrderState ZOOS ON (ZOODS.OmsOrderStateId = ZOOS.OmsOrderStateId)   
   LEFT JOIN ZnodeCulture ZC ON (ZC.CultureCode = ZOODS.CurrencyCode)  
   WHERE (EXISTS (SELECT TOP 1 1 FROM #TBL_PortalId rt WHERE rt.PortalId = zoods.PortalId)  
   OR NOT EXISTS (SELECT TOP 1 1 FROM #TBL_PortalId ))  
   AND ZOODS.IsActive = 1  
   AND ZOOS.OrderStateName NOT IN ('CANCELED','RETURNED','REJECTED','FAILED')   
   AND ODT.Name NOT IN ('PARTIALREFUND','GIFTCARD')
        
 	 
   --;WITH CTE_GetCouponFiltered AS
   --(    
   SELECT zood.DiscountCode CouponCode,zdt.[Name] AS DiscountType,zp.[StoreName] AS StoreName,COUNT(zood.OmsOrderDiscountId) AS TotalCount,  
  [dbo].[Fn_GetDefaultPriceRoundOff](zood.Total) AS Total 
   ,[dbo].[Fn_GetDefaultPriceRoundOff](SUM(zood.DiscountAmount)) AS DiscountAmount,  
   ISNULL(zpr.[description], znpc.[description]) AS Description,  
   ISNULL(zpr.StartDate, znpc.StartDate) AS BeginDate,ISNULL(zpr.EndDate, znpc.EndDate) AS EndDate,Symbol, zpr.PromoCode AS PromotionCode , zpr.Name AS PromotionName  
   ,OmsOrderDetailsId
   INTO #CTE_GetCouponFiltered
   FROM #ZnodeOmsOrderDiscount AS zood   
   INNER JOIN ZnodePortal AS zp ON zood.PortalId = zp.PortalId  
   LEFT JOIN ZNodePromotion AS zpr ON zood.DiscountCode = zpr.PromoCode  
   LEFT JOIN ZnodePromotionCoupon AS zprc ON zood.DiscountCode = zprc.Code  
   LEFT JOIN ZNodePromotion AS znpc ON zprc.PromotionId = znpc.PromotionId  
   LEFT JOIN ZnodeOmsDiscountType AS zdt ON zood.OmsDiscountTypeId = zdt.OmsDiscountTypeId  
    WHERE CAST(ZOOD.OmsOrderDate AS DATETIME) BETWEEN @BeginDate AND @EndDate       
    AND zdt.[Name] IN (select Item from dbo.split(@DiscountType,'|'))    
    GROUP BY zp.StoreName,zood.DiscountCode
	,ISNULL(zpr.[description], znpc.[description]),ISNULL(zpr.StartDate, znpc.StartDate),ISNULL(zpr.EndDate, znpc.EndDate),  
    zdt.Name,zood.PortalId,Symbol,zpr.PromoCode,zpr.Name, zood.OmsOrderDetailsId,zood.Total
	--)  
    
   

   SELECT CouponCode, --CASE WHEN DiscountType='promocode' THEN '' ELSE CouponCode END 
   DiscountType,StoreName,SUM(TotalCount) AS NumberOfUses
   ,SUM(convert(numeric(28,6),Total)) SalesTotal
   ,SUM(convert(numeric(28,6),DiscountAmount)) DiscountTotal,
   Description,BeginDate AS ActivationDate,EndDate AS ExpirationDate,
   CASE WHEN DiscountType='couponcode' THEN '' ELSE ISNULL(PromotionCode,CouponCode) END 
   PromotionCode,
   CASE WHEN DiscountType='couponcode' THEN '' ELSE PromotionName END 
   PromotionName 
   FROM #CTE_GetCouponFiltered 
   GROUP BY CouponCode ,DiscountType,StoreName,Description,BeginDate,EndDate,CASE WHEN DiscountType='couponcode' THEN '' ELSE ISNULL(PromotionCode,CouponCode) END 
   ,PromotionName --CASE WHEN DiscountType='promocode' THEN '' ELSE CouponCode END 

   
       
  END TRY  
  BEGIN CATCH  
  DECLARE @Status BIT ;  
       SET @Status = 0;  
       DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),  
    @ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeReport_GetCouponFiltered @BeginDate='+CAST(@BeginDate AS VARCHAR(200))+',@EndDate='+CAST(@EndDate AS VARCHAR(200))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
             EXEC Znode_InsertProcedureErrorLog  
    @ProcedureName = 'ZnodeReport_GetCouponFiltered',  
    @ErrorInProcedure = @Error_procedure,  
    @ErrorMessage = @ErrorMessage,  
    @ErrorLine = @ErrorLine,  
    @ErrorCall = @ErrorCall;  
  END CATCH  
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'ZnodeDevExpressReport_GetPopularProductFiltered')
	DROP PROC ZnodeDevExpressReport_GetPopularProductFiltered
GO


  
CREATE PROCEDURE [dbo].[ZnodeDevExpressReport_GetPopularProductFiltered](  
      @BeginDate   DATETIME          ,  
      @EndDate     DATETIME          ,  
      @StoreName   NVARCHAR(max) = '',  
   @ShowAllProducts BIT = 1,    
   @TopProducts INT = 10   
   )  
AS   
/*  
     Sumarry : - This Procedure is used to find the Popular products filtered   
     Unit Testing   
     EXEC ZnodeDevExpressReport_GetPopularProductFiltered @BeginDate = '2018/01/01',@EndDate= '2018/12/12'     
 */  
     BEGIN  
         BEGIN TRY  
             SET NOCOUNT ON;  
          DECLARE @SQL NVARCHAR(MAX)  
    DECLARE @PageNo int = 1;   
    DECLARE @TBL_PortalId TABLE (PortalId INT );  
    DECLARE @TBL_ReportPopularProduct TABLE (PortalId INT,StoreName NVARCHAR(MAX),SKU NVARCHAR(MAX),ProductName  NVARCHAR(MAX),QuantityOrdered NUMERIC(28,6)  
    ,UnitOfMeasurement nvarchar(20)  
    )--,  TotalAmtSold NUMERIC(28,6))  
  
    IF OBJECT_ID('TEMPDB..#PopularProduct') IS NOT NULL  
       DROP TABLE #PopularProduct    
  
   INSERT INTO @TBL_PortalId  
   SELECT PortalId   
   FROM ZnodePortal ZP   
   INNER JOIN dbo.split(@StoreName,'|') SP ON (SP.Item = ZP.StoreName)  
  
   SELECT distinct SKU,ProductName,UOM 
     INTO #PopularProduct  
     FROM  
     (  
     SELECT  c.pimproductId,PA.attributecode,e.AttributeValue 
     FROM znodePimProduct c   
      INNER JOIN ZnodePimAttributeValue d on (c.PimProductid = d.PimProductid)  
      INNER JOIN ZnodePimAttributeValueLocale e on (d.PimAttributeValueId = e.PimAttributeValueId)  
      INNER JOIN ZnodePimAttribute PA ON (PA.PimAttributeId = d.PimAttributeId)  
     WHERE  AttributeCode IN ('SKU','ProductName')  
     UNION ALL  
  
     SELECT a.PimProductId, c.AttributeCode,ZPADV.AttributeDefaultValueCode
     FROM ZnodePimProductAttributeDefaultValue ZPPADV  
     INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON (ZPPADV.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)  
     INNER JOIN ZnodePimAttributeValue a ON (a.PimAttributeValueId = ZPPADV.PimAttributeValueId )  
     INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId  )  
     WHERE AttributeCode IN ('UOM')  
     ) piv PIVOT(MAX(AttributeValue) FOR AttributeCode in ( SKU,ProductName,UOM))AS PVT  
  
  
   INSERT INTO @TBL_ReportPopularProduct  
       SELECT  ZOOD.PortalId,ZP.StoreName AS 'StoreName' , ZOOLI.SKU , ZOOLI.ProductName , SUM(ZOOLI.Quantity) AS 'QuantityOrdered'  
    ,PP.UOM UnitOfMeasurement  
                      FROM ZnodeOmsOrder AS ZOO INNER JOIN ZnodeOmsOrderDetails AS ZOOD ON ( ZOOD.OmsOrderId = ZOO.OmsOrderId )  
                                                INNER JOIN ZnodeOmsOrderLineItems AS ZOOLI ON (Zood.OmsOrderDetailsId = ZOOLI.OmsOrderDetailsId)  
            INNER JOIN #PopularProduct PP ON (PP.SKU = ZOOLI.Sku)  
                                                INNER JOIN ZnodePortal AS ZP ON (Zp.PortalID = ZOOD.PortalId)  
            INNER JOIN ZnodeOmsOrderState ZOOS ON (ZOOD.OmsOrderStateId = ZOOS.OmsOrderStateId)  
                                        
                      WHERE  CAST(ZOOD.OrderDate AS DATETIME) BETWEEN @BeginDate AND @EndDate  
       AND (EXISTS (SELECT TOP 1 1 FROM @TBL_PortalId rt WHERE rt.PortalId = ZOOD.PortalId)  
          OR NOT EXISTS (SELECT TOP 1 1 FROM @TBL_PortalId ))    
       AND ZOOS.OrderStateName NOT IN ('CANCELED','RETURNED','REJECTED','FAILED')  
       AND ZOOLI.OrderLineItemStateId NOT IN (SELECT OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName  IN ('CANCELED','RETURNED','REJECTED','FAILED'))                       
       AND ParentOmsOrderLineItemsId IS NOT NULL  
                      GROUP BY ZP.StoreName , ZOOLI.SKU , ZOOLI.ProductName , ZOOD.PortalId ,PP.UOM  
                      HAVING SUM(ZOOLI.Quantity) > 0   
        
    SET @TopProducts = CASE WHEN @ShowAllProducts = 1 THEN (SELECT COUNT(1) FROM @TBL_ReportPopularProduct ) ELSE @TopProducts END   
  
  
     Select TOP (@TopProducts)  SKU , ProductName ,StoreName ,QuantityOrdered,UnitOfMeasurement     
     from @TBL_ReportPopularProduct    
     ORder by StoreName ASC, CAST (QuantityOrdered AS Numeric) DESC, ProductName ASC  
  
      
        
        IF OBJECT_ID('TEMPDB..#PopularProduct') IS NOT NULL  
       DROP TABLE #PopularProduct   
  
         END TRY  
  
         BEGIN CATCH  
             DECLARE @Status BIT ;  
       SET @Status = 0;  
       DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),  
    @ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeReport_GetPopularProductFiltered @BeginDate='+CAST(@BeginDate AS VARCHAR(200))+',@EndDate='+CAST(@EndDate AS VARCHAR(200))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
             EXEC Znode_InsertProcedureErrorLog  
    @ProcedureName = 'ZnodeReport_GetPopularProductFiltered',  
    @ErrorInProcedure = @Error_procedure,  
    @ErrorMessage = @ErrorMessage,  
    @ErrorLine = @ErrorLine,  
    @ErrorCall = @ErrorCall;  
         END CATCH;  
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'ZnodeDevExpressReport_GetTopOrderingcustomers')
	DROP PROC ZnodeDevExpressReport_GetTopOrderingcustomers
GO

CREATE PROCEDURE [dbo].[ZnodeDevExpressReport_GetTopOrderingcustomers]  
(   
	 @BeginDate			DATETIME ,  
	 @EndDate			DATETIME ,   
	 @StoreName			NVARCHAR(max) = '',  
	 @ShowAllCustomers  BIT = 0,  
	 @TopCustomers		INT = 100 
 )  
AS   
/*  
     Summary :- This Procedure is used to get frequently Appear users    
     Unit Testing   
     EXEC ZnodeDevExpressReport_GetTopOrderingcustomers @BeginDate = '2018-10-13 14:29:34.513', @EndDate = '2018-10-13 14:29:34.513'  
  
     exec ZnodeDevExpressReport_GetTopOrderingcustomers_bak '2018/01/01','2018/12/12'  
*/   
BEGIN  
  BEGIN TRY  
   DECLARE @TBL_ReportOrderUser TABLE (OrderCount INT, UserId     INT, PortalId   INT ,Total NUMERIC(28,8),Symbol  VARCHAR(100)  );  
   DECLARE @TBL_PortalId TABLE (PortalId INT );
    INSERT INTO @TBL_PortalId
	SELECT PortalId 
	FROM ZnodePortal ZP 
	INNER JOIN dbo.split(@StoreName,'|') SP ON (SP.Item = ZP.StoreName) 
			
	INSERT INTO @TBL_ReportOrderUser (OrderCount, UserId,PortalId)                     
    SELECT COUNT(ZOOD.OmsOrderId) OrderCount, UserId, PortalId
	FROM ZnodeOmsOrderDetails ZOOD 
	INNER JOIN ZnodeOmsOrderState ZOOS ON (ZOOD.OmsOrderStateId = ZOOS.OmsOrderStateId) 
	WHERE ZOOD.IsActive = 1   
	AND (EXISTS (SELECT TOP 1 1 FROM @TBL_PortalId rt WHERE rt.PortalId = ZOOD.PortalId)
				OR NOT EXISTS (SELECT TOP 1 1 FROM @TBL_PortalId ))   
    AND CAST(OrderDate AS DATETIME) BETWEEN @BeginDate AND @EndDate 
	AND ZOOS.OrderStateName NOT IN ('CANCELED','RETURNED','REJECTED','FAILED')		               
    GROUP BY UserId,PortalId;  
	
	SET @TopCustomers = CASE WHEN @ShowAllCustomers = 1 THEN (SELECT COUNT(1) FROM @TBL_ReportOrderUser ) ELSE @TopCustomers END 

    SELECT TOP (@TopCustomers) TBL.UserID , CASE WHEN REPLACE(ISNULL(FirstName,'')+' '+ISNULL(LastName,''),' ','') = '' THEN APZ.UserName ELSE ISNULL(FirstName,'')+' '+ISNULL(LastName,'') END  CustomerName 
				, StoreName , OrderCount , --dbo.Fn_GetDefaultPriceRoundOffReturnNumeric(Total) Total, Symbol,
				ZU.Email, CASE WHEN  ZU.AspNetUserId IS NULL THEN 'Guest User' ELSE 'Registered User' END  CustomerType  
	FROM @TBL_ReportOrderUser TBL
	INNER JOIN ZnodePortal ZP ON (ZP.portalId = TBL.PortalId )
	LEFT JOIN ZnodeUser  ZU ON (ZU.UserId = TBL.UserId )
	LEFT JOIN AspNetUsers AP ON (AP.Id = ZU.AspNetUserId)
	LEFT JOIN AspNetZnodeUser APZ ON (APZ.AspNetZnodeUserId = AP.UserName)
	ORDER BY StoreName ASC ,OrderCount DESC,CustomerName ASC ,Email ASC 

	END TRY  
    BEGIN CATCH  
             DECLARE @Status BIT ;  
       SET @Status = 0;  
       DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),  
    @ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeReport_GetFrequentUsers @BeginDate='+CAST(@BeginDate AS VARCHAR(200))+',@EndDate='+CAST(@EndDate AS VARCHAR(200))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
             EXEC Znode_InsertProcedureErrorLog  
    @ProcedureName = 'ZnodeReport_GetFrequentUsers',  
    @ErrorInProcedure = @Error_procedure,  
    @ErrorMessage = @ErrorMessage,  
    @ErrorLine = @ErrorLine,  
    @ErrorCall = @ErrorCall;  
         END CATCH;  
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'ZnodeDevExpressReport_GetTopSpendingCustomers')
	DROP PROC ZnodeDevExpressReport_GetTopSpendingCustomers
GO

CREATE PROCEDURE [dbo].[ZnodeDevExpressReport_GetTopSpendingCustomers]
(   @BeginDate    DATETIME        ,
	@EndDate      DATETIME       ,
	@StoreName    NVARCHAR(max) = '',
	@ShowAllCustomers BIT = 1,  
    @TopCustomers INT = 100 ,
	@AmountGreaterThan NVARCHAR(50) = 0 
	)
AS 
/*
     Summary :- This Procedure is used to get frequently Appear users  
     Unit Testing 
     EXEC ZnodeDevExpressReport_GetTopSpendingCustomers_bak @BeginDate = '2018/01/01',@EndDate= '2018/12/12'  , @AmountGreaterThan = '40'
*/
     BEGIN
	 BEGIN TRY
         DECLARE @TBL_ReportOrderUser TABLE (OrderCount INT, UserId     INT, PortalId   INT ,Total NUMERIC(28,6),Symbol  VARCHAR(100),
		 TotalShippingCost NUMERIC(28,6),TotalTaxCost NUMERIC(28,6),SubTotalAmount  NUMERIC(28,6) );  
         DECLARE @TBL_PortalId TABLE (PortalId INT );
		 INSERT INTO @TBL_PortalId
		 SELECT PortalId 
		 FROM ZnodePortal ZP 
		 INNER JOIN dbo.split(@StoreName,'|') SP ON (SP.Item = ZP.StoreName) 
	
	INSERT INTO @TBL_ReportOrderUser (OrderCount, UserId,PortalId,Total,Symbol,TotalShippingCost,TotalTaxCost,SubTotalAmount)                     
    SELECT COUNT(ZOOD.OmsOrderId) OrderCount, UserId, PortalId, SUM(Total)  Total, ZC.Symbol, SUM(ShippingCost) AS TotalShippingCost,
	Sum(TaxCost) AS TotalTaxCost, SUM(SubTotal) AS SubTotalAmount
	FROM ZnodeOmsOrderDetails ZOOD  
	INNER JOIN ZnodeCulture ZC ON (ZC.CultureCode  = ZOOD.CultureCode )
	INNER JOIN ZnodeOmsOrderState ZOOS ON (ZOOD.OmsOrderStateId = ZOOS.OmsOrderStateId)  
	WHERE ZOOD.IsActive = 1   
	AND (EXISTS (SELECT TOP 1 1 FROM @TBL_PortalId rt WHERE rt.PortalId = ZOOD.PortalId)
				OR NOT EXISTS (SELECT TOP 1 1 FROM @TBL_PortalId ))   
    AND CAST(OrderDate AS DATETIME) BETWEEN @BeginDate AND @EndDate 
	AND ZOOS.OrderStateName NOT IN ('CANCELED','RETURNED','REJECTED','FAILED')				               
    GROUP BY UserId,PortalId,ZC.Symbol
	HAVING SUM(Total)  >= CAST(@AmountGreaterThan AS NUMERIC(28,6))  
	;  
	
	SET @TopCustomers = CASE WHEN @ShowAllCustomers = 1 THEN (SELECT COUNT(1) FROM @TBL_ReportOrderUser ) ELSE @TopCustomers END 

    SELECT TOP (@TopCustomers) TBL.UserID , CASE WHEN REPLACE(ISNULL(FirstName,'')+' '+ISNULL(LastName,''),' ','') = '' THEN APZ.UserName ELSE ISNULL(FirstName,'')+' '+ISNULL(LastName,'') END  CustomerName 
				, StoreName , OrderCount ,dbo.Fn_GetDefaultPriceRoundOffReturnNumeric(Total) TotalAmount, Symbol,ZU.Email, CASE WHEN  ZU.AspNetUserId IS NULL THEN 'Guest User' ELSE 'Registered User' END  CustomerType  
				,dbo.Fn_GetDefaultPriceRoundOffReturnNumeric(Total/OrderCount)  AverageTotalAmount,TotalShippingCost,TotalTaxCost,SubTotalAmount
	FROM @TBL_ReportOrderUser TBL
	INNER JOIN ZnodePortal ZP ON (ZP.portalId = TBL.PortalId )
	LEFT JOIN ZnodeUser  ZU ON (ZU.UserId = TBL.UserId )
	LEFT JOIN AspNetUsers AP ON (AP.Id = ZU.AspNetUserId)
	LEFT JOIN AspNetZnodeUser APZ ON (APZ.AspNetZnodeUserId = AP.UserName)
	ORDER BY StoreName ASC,TotalAmount DESC ,CustomerName ASC
                 
         END TRY
         BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC ZnodeReport_GetTopSpendingCustomers @BeginDate='+CAST(@BeginDate AS VARCHAR(200))+',@EndDate='+CAST(@EndDate AS VARCHAR(200))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'ZnodeReport_GetTopSpendingCustomers',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY

	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku VARCHAR(600), GroupIdentifier INT)
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT, GroupIdentifier INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);

	DECLARE @OrderLineItemRelationshipTypeIdConfig int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber NVARCHAR(max),TrackingNumber NVARCHAR(1000),CouponCode NVARCHAR(1000),
		PromoDescription NVARCHAR(max),ReferralUserId int,PurchaseOrderNumber NVARCHAR(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken NVARCHAR(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument NVARCHAR(600),IsActive bit,ExternalId NVARCHAR(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber VARCHAR(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId NVARCHAR(800),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),Custom5 NVARCHAR(MAX),FirstName NVARCHAR(200),LastName NVARCHAR(200),CardType VARCHAR(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost NUMERIC(28,6),PaymentDisplayName NVARCHAR(2000),PaymentExternalId NVARCHAR(2000),
		CultureCode VARCHAR(200),DisplayName NVARCHAR(2000),InHandDate datetime,IpAddress VARCHAR(100),JobName NVARCHAR(200),
		ShippingConstraintCode NVARCHAR(100),ShippingDiscount NUMERIC(28,6),ShippingHandlingCharges NUMERIC(28,6),ReturnCharges NUMERIC(28,6),
		IsCalculateTaxAfterDiscount bit,Email VARCHAR(50),PhoneNumber VARCHAR(50),OrderTotalWithoutVoucher NUMERIC(28,6),ImportDuty NUMERIC(28,6),
		TaxCost NUMERIC(28,6),ShippingCost NUMERIC(28,6), SubTotal NUMERIC(28,6),CurrencyCode VARCHAR(100),OverDueAmount NUMERIC(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int
	)

	CREATE TABLE #TempOrderBillingAddress
	(
		AddressId INT,BillingFirstName VARCHAR(300),BillingLastName VARCHAR(300),BillingCountry VARCHAR(3000),BillingStateCode VARCHAR(300),
		BillingPostalCode VARCHAR(50),BillingPhoneNumber VARCHAR(50),BillingEmailId VARCHAR(50),BillingStreet1 VARCHAR(300),BillingStreet2 VARCHAR(300),
		BillingCity VARCHAR(3000),BillingCompanyName NVARCHAR(1200)
	)
	
	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), GroupIdentifier INT
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku NVARCHAR(600), GroupIdentifier INT
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId NVARCHAR(max), GroupIdentifier INT
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId NVARCHAR(max),
		GroupIdentifier INT
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId NVARCHAR(max)
	)

	--------Getting Order details
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
		CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
		CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
		CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
		CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
		CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
		CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
		CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
		CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
		Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
		Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
		CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
		Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
		CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
		Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
		Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
		CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
		CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
		Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
		CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
		Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
		Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
		Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
		CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
		Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
		Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
		Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
		Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
		Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
		Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
		Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
		Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
		Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
		CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
		CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
		Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
		Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
		CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
		CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
		Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
		Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
		Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);


	--Getting billing address info
	INSERT INTO #TempOrderBillingAddress
	(
		AddressId,BillingFirstName,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,
		BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber,BillingEmailId
	)
	SELECT
		Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) AS AddressId,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CompanyName[1]', 'NVARCHAR(Max)' ) AS CompanyName,
		Tbl.Col.value( 'Street1[1]', 'NVARCHAR(Max)' ) AS Street1 ,
		Tbl.Col.value( 'Street2[1]', 'NVARCHAR(Max)' ) AS Street2,
		Tbl.Col.value( 'City[1]', 'NVARCHAR(Max)' ) AS City,
		Tbl.Col.value( 'StateCode[1]', 'NVARCHAR(Max)' ) AS StateCode,
		Tbl.Col.value( 'PostalCode[1]', 'NVARCHAR(Max)' ) AS PostalCode,
		Tbl.Col.value( 'Country[1]', 'NVARCHAR(Max)' ) AS Country,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		Tbl.Col.value( 'EmailId[1]', 'NVARCHAR(Max)' ) AS EmailId
	FROM @OrderXML.nodes( '//PlaceOrderModel/BillingAddressModel' ) AS Tbl(Col);
	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	--Updating parent for simple products
	UPDATE #TempChildLineItemDetails SET ParentSku = Sku WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

BEGIN TRAN OrderInsert

	--Inserting order number which are unique and getting in xml from code side
	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, IsOldOrder
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	--If order is new then creating new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,OBA.BillingCompanyName,
			OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry,OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,
			OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
			,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
			,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId

	END
	--If order managed then creating new order details and disable old order details
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM  #TempOrderData OD WHERE OOD.OmsOrderId = OD.OmsOrderId) AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName --1
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry --2
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total --3
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId --4
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive --5
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited --6
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName --7
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName, --8
			PaymentExternalId,CultureCode, --9
			DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges --10
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty --11 
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,--1
			OBA.BillingCompanyName,OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry, --2
			OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total, --3
			OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId, --4
			OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive --5
			,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited, --6
			OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName, --7
			OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName, --8
			CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode, --9 
			OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges, --10
			OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty --11
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId
	
		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'CANCELED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	----Geting new OmsOrderDetailsId always
	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order notes only for new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
			@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId,INSERTED.GroupIdentifier INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description--1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, --5
		ParentSku, GroupIdentifier --6
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku, INSERTED.GroupIdentifier INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,PLID.ProductName,PLID.Description, --1
		PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber, --2
		PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,--3
		PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy, --4
		PLID.ModifiedDate,PLID.AutoAddonSKU,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,PLID.GroupId,PLID.BundleQuantity, --5
		case when PLID.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple then PLID.Sku else PLID.ParentSku end AS ParentSku, GroupIdentifier --6
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items for simple, group and configurable products
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.GroupIdentifier = a.GroupIdentifier AND A.ParentSku = D.Sku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	FROM @OmsOrderLineItems a
	WHERE a.OrderLineItemRelationshipTypeId NOT IN ( @OrderLineItemRelationshipTypeIdAddon, @OrderLineItemRelationshipTypeIdGroup)  
	AND a.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for child line items for group products
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup)
	BEGIN
		---Getting child lineitems for group product
		;WITH Cte_GroupProductChild AS
		(
			SELECT GroupIdentifier,Sku, ParentSku, OmsOrderLineItemsId, ParentOmsOrderLineItemsId,Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsOrderLineItems
			WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup
		)
		---Getting parent lineitems for group product
		,Cte_GroupProductParent AS 
		(
			SELECT GroupIdentifier,Sku, OmsOrderLineItemsId, Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsParentOrderLineItems a
			WHERE OrderLineItemRelationshipTypeId IS NULL
			AND EXISTS(SELECT * FROM @OmsOrderLineItems b WHERE a.GroupIdentifier = b.GroupIdentifier AND a.Sku = b.ParentSku)
		)
		--Updating ParentOmsOrderLineItemsId on child for group products
		UPDATE a SET a.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM Cte_GroupProductChild a
		INNER JOIN Cte_GroupProductParent B ON A.GroupIdentifier = B.GroupIdentifier AND a.RowId1 = b.RowId1 AND b.Sku = a.ParentSku 
	END

	---Updating ParentOmsOrderLineItemsId for addons if present
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	BEGIN
		--Updating ParentOmsOrderLineItemsId for addon with Simple products , group products and configurable products
		UPDATE b SET b.ParentOmsOrderLineItemsId = c.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsOrderLineItems b on b.ParentSku = c.Sku AND c.GroupIdentifier = b.GroupIdentifier
		WHERE c.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon and c.OrderLineItemRelationshipTypeId is not null
		and b.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND b.ParentOmsOrderLineItemsId IS NULL
		
		--Updating ParentOmsOrderLineItemsId for addon with bundle products
		UPDATE c SET c.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsParentOrderLineItems b on B.sku = C.parentsku AND c.GroupIdentifier= b.GroupIdentifier
		WHERE B.OrderLineItemRelationshipTypeId is null 
		AND c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND C.ParentOmsOrderLineItemsId IS NULL
	 END
	 ---Updating ParentOmsOrderLineItemsId in main table
	 UPDATE a SET a.ParentOmsOrderLineItemsId = b.ParentOmsOrderLineItemsId
	 FROM  ZnodeOmsOrderLineItems a
	 INNER JOIN @OmsOrderLineItems b on a.OmsOrderLineItemsId = b.OmsOrderLineItemsId

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	IF (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
		SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
		FROM #TempOrderData OD
	END

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsParentOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes FROM xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId, GroupIdentifier )
	SELECT
		Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
		Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/OrderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'') AND OA.GroupIdentifier = POLI.GroupIdentifier
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId, GroupIdentifier)
	SELECT
		Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
		Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
		Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsParentOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'') AND OPI.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId 
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
		Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		@UserId,@GetDate,@UserId,@GetDate,
		CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
		CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
		CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
		Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
		CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
		Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
		Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	--Inserting product level discount for simple and group products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
		OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
		OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'') 
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdSimple , @OrderLineItemRelationshipTypeIdGroup)
	
	--Inserting product level discount for config and bundle products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.ParentOmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.ParentSku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdBundles , @OrderLineItemRelationshipTypeIdConfig)
	
	--Inserting order level discount 
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,NULL,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	WHERE isnull(OD.Sku,'') = ''
	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
		CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'') 
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end
	
	DECLARE @OmsOrderId INT
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM @OMSOrder)
	END
	ELSE
	BEGIN 
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
	END
	----RMA details start
	IF (SELECT TOP 1 OmsOrderId FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId AS NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	END
	----RMA details end
	
	---Inserting OrderTaxDetails
	IF(NOT EXISTS(SELECT 1 from ZnodeOmsTaxRule where OmsOrderId= @OmsOrderId)) AND (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		DECLARE @TaxRate Numeric(28,6), @TaxRuleId INT
		SET @TaxRate = (SELECT TOP 1 TaxRate FROM #TempOrderData)
		SET @TaxRuleId = (SELECT TOP 1 TaxRuleId FROM #TempChildLineItemDetails)

		 EXEC [Znode_InsertOrderTaxDetails] @OmsOrderId = @OmsOrderId, @TaxRuleId = @TaxRuleId, @TaxRate = @TaxRate, @Status = 0
	END

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 AS bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 AS OmsOrderId,0 AS OmsOrderDetailsId, cast(0 AS bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, isnull(PaymentTransactionToken,''),Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records FROM order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO


update ZnodeApplicationSetting 
set Setting='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContentContainerId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>ContainerKey</name>      <headertext>Container Key</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Tags</name>      <headertext>Tags</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>ModifiedDate</name>      <headertext>Modified Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>yyyy-MM-dd HH:mm:ss</format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>PublishStatus</name>      <headertext>Publish Status</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Publish|Trigger|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Publish|Create Scheduler|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/ContentContainer/Edit|/ContentContainer/PublishContentContainer|/ContentContainer/CreateScheduler|/ContentContainer/Delete</manageactionurl>      <manageparamfield>containerKey|ContainerKey,TargetPublishState|ConnectorTouchPoints,SchedulerCallFor|contentContainerId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='ZnodeCMSContentContainer'

GO

UPDATE a
SET a.IsSystemDefined = 1
from ZnodePimAttributeGroupMapper a
INNER JOIN ZnodePimAttribute b ON a.PimAttributeId = b.PimAttributeId
WHERE AttributeCode IN ('CategoryBanner','CategoryName','CategoryTitle','CategoryImage','Brand','Vendor','Highlights')
and b.IsSystemDefined = 1

GO

insert into ZnodeGlobalAttribute
(AttributeTypeId, AttributeCode, IsRequired, IsLocalizable, IsActive, DisplayOrder,HelpDescription,CreatedBy, CreatedDate, ModifiedBy,ModifiedDate, IsSystemDefined, GlobalEntityId)
select 
(select top 1 AttributeTypeId from ZnodeAttributeType where AttributeTypeName ='Yes/No' ),N'EnableReturnRequest',0,1,1,2,'When enabled, customers will be able to create return requests for the eligible orders from the web store',2,getdate(),2,getdate(),0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where not exists  (select AttributeCode from  ZnodeGlobalAttribute where AttributeCode ='EnableReturnRequest')

INSERT INTO ZnodeGlobalAttributeLocale(LocaleId,GlobalAttributeId,AttributeName,Description,CreatedBy,
CreatedDate,ModifiedBy,ModifiedDate)
SELECT 1,(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='EnableReturnRequest'),'Enable Return Requests From Webstore',
NULL,2,GETDATE(),2,GETDATE()
where not exists (select * from ZnodeGlobalAttributeLocale 
	where GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='EnableReturnRequest')
	and LocaleId = 1)
	
insert into ZnodeGlobalAttributeGroup
(GroupCode,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsSystemDefined,GlobalEntityId)
select N'ReturnSetting', NULL, 2, GETDATE(), 2, GETDATE(), 0, (select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where  not exists   (select top 1 GroupCode from ZnodeGlobalAttributeGroup where GroupCode =N'ReturnSetting') 

INSERT INTO ZnodeGlobalAttributeGroupLocale(LocaleId,GlobalAttributeGroupId,AttributeGroupName,Description,CreatedBy,CreatedDate,
ModifiedBy,ModifiedDate)
SELECT 1,(SELECT TOP 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode=N'ReturnSetting'),'Return Setting',NULL,2,
GETDATE(),2,GETDATE()
where not exists (select * from ZnodeGlobalAttributeGroupLocale 
where GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode=N'ReturnSetting') 
and LocaleId = 1)


insert into ZnodeGlobalAttributeGroupMapper (GlobalAttributeGroupId,GlobalAttributeId,AttributeDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'ReturnSetting'),
(select top 1 GlobalAttributeId from ZnodeGlobalAttribute where AttributeCode = 'EnableReturnRequest'),null,2,getdate(),2,getdate()
where not exists(select * from ZnodeGlobalAttributeGroupMapper 
     where GlobalAttributeGroupId = (select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'ReturnSetting')
	 and GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where AttributeCode = 'EnableReturnRequest'))


INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId, GlobalAttributeGroupId, AttributeGroupDisplayOrder,CreatedBy, CreatedDate, ModifiedBy, ModifiedDate)
SELECT
(SELECT top 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode = 'Store'),
(SELECT top 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'ReturnSetting' AND GlobalEntityId = (select top 1 GlobalEntityId from ZnodeGlobalEntity where EntityName = 'Store')), 9r,
2, getdate(), 2, getdate()
WHERE NOT EXISTS(select * from ZnodeGlobalFamilyGroupMapper where
GlobalAttributeFamilyId = (SELECT top 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode = 'Store') and
GlobalAttributeGroupId = (SELECT top 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'ReturnSetting' AND GlobalEntityId = (select top 1 GlobalEntityId from ZnodeGlobalEntity where EntityName = 'Store'))
)

INSERT INTO ZnodeGlobalGroupEntityMapper (GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'ReturnSetting'),(select top 1 GlobalEntityId from ZnodeGlobalEntity where EntityName = 'Store') ,
	9,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE  GlobalAttributeGroupId = (select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'ReturnSetting') AND 
		GlobalEntityId = (select top 1 GlobalEntityId from ZnodeGlobalEntity where EntityName = 'Store'))

insert into ZnodePortalGlobalAttributeValue(PortalId,GlobalAttributeId,GlobalAttributeDefaultValueId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select PortalId,(select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'EnableReturnRequest'),null,null,2,getdate(),2,getdate()
from ZnodePortal ZP
where not exists(select * from ZnodePortalGlobalAttributeValue ZPGA where ZP.PortalId = ZPGA.PortalId
      and ZPGA.GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'EnableReturnRequest'))

insert into ZnodePortalGlobalAttributeValueLocale(PortalGlobalAttributeValueId,	LocaleId,	AttributeValue	,CreatedBy,	CreatedDate,	ModifiedBy	,ModifiedDate)
select PortalGlobalAttributeValueId,1,'true',2,getdate(),2,getdate()
from ZnodePortalGlobalAttributeValue ZPGA
where ZPGA.GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'EnableReturnRequest')
and not exists(select * from ZnodePortalGlobalAttributeValueLocale ZPGAVL where ZPGAVL.PortalGlobalAttributeValueId = ZPGA.PortalGlobalAttributeValueId
and LocaleId = 1)

update ZnodeGlobalFamilyGroupMapper set AttributeGroupDisplayOrder=1 
where GlobalAttributeGroupId=(select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'WebstoreAuthentication')
update ZnodeGlobalFamilyGroupMapper set AttributeGroupDisplayOrder=2 
where GlobalAttributeGroupId=(select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'Redirections')
update ZnodeGlobalFamilyGroupMapper set AttributeGroupDisplayOrder=3 
where GlobalAttributeGroupId=(select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'EnableBudgetManagement')
update ZnodeGlobalFamilyGroupMapper set AttributeGroupDisplayOrder=4 
where GlobalAttributeGroupId=(select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'StoreAddressSettings')
update ZnodeGlobalFamilyGroupMapper set AttributeGroupDisplayOrder=5 
where GlobalAttributeGroupId=(select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'Captcha')
update ZnodeGlobalFamilyGroupMapper set AttributeGroupDisplayOrder=6 
where GlobalAttributeGroupId=(select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'WarehouseStockLevels')
update ZnodeGlobalFamilyGroupMapper set AttributeGroupDisplayOrder=7 
where GlobalAttributeGroupId=(select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'Cloudflaresetting')
update ZnodeGlobalFamilyGroupMapper set AttributeGroupDisplayOrder=8 
where GlobalAttributeGroupId=(select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'QuotesSettings')
update ZnodeGlobalFamilyGroupMapper set AttributeGroupDisplayOrder=9 
where GlobalAttributeGroupId=(select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'ReturnSetting')

GO

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>GiftCardId</name>      <headertext>Checkbox</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>StoreName</name>      <headertext>Store Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>CardNumber</name>      <headertext>Voucher Number</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Name</name>      <headertext>Voucher Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/GiftCard/Edit</islinkactionurl>      <islinkparamfield>giftCardId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>CreatedDate</name>      <headertext>Created Date</headertext>      <width>0</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>StartDate</name>      <headertext>Start Date</headertext>      <width>0</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>ExpirationDate</name>      <headertext>Expiration Date</headertext>      <width>0</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Amount</name>      <headertext>Voucher Amount</headertext>      <width>0</width>      <datatype>Double</datatype>      <columntype>Double</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>RemainingAmount</name>      <headertext>Remaining Amount</headertext>      <width>0</width>      <datatype>Double</datatype>      <columntype>Double</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>CustomerName</name>      <headertext>Customer Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>11</id>      <name>AccountCode</name>      <headertext>Account Code</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>12</id>      <name>AccountName</name>      <headertext>Account Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>13</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Disable|Delete</format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Activate|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/GiftCard/Edit|/GiftCard/ActiveDeactiveSingleVoucher|/GiftCard/Delete</manageactionurl>      <manageparamfield>giftCardId|giftCardId,IsActive|giftCardId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeGiftCard'

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>GiftCardId</name>      <headertext>Checkbox</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>CardNumber</name>      <headertext>Voucher Number</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Name</name>      <headertext>Voucher Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/GiftCard/Edit</islinkactionurl>      <islinkparamfield>giftCardId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>StartDate</name>      <headertext>Start Date</headertext>      <width>0</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>ExpirationDate</name>      <headertext>Expiration Date</headertext>      <width>0</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>Amount</name>      <headertext>Voucher Amount</headertext>      <width>0</width>      <datatype>Double</datatype>      <columntype>Double</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>RemainingAmount</name>      <headertext>Remaining Amount</headertext>      <width>0</width>      <datatype>Double</datatype>      <columntype>Double</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Disable</format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Disable</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/GiftCard/Edit|/GiftCard/ActiveDeactiveSingleVoucher</manageactionurl>      <manageparamfield>giftCardId|giftCardId,IsActive</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeUserVoucherList'

GO

update ZnodeEmailTemplateLocale set Content = '<!DOCTYPE html><html><body><p></p>  <div>  <div style="font-family: Arial, Helvetica; font-size: 10px; text-align: left; color: #292a2a; border: solid 1px #c3c3c3; margin-top: 10px;">  <div style="background-color: #eff3fb; color: #292a2a; font-size: 1.5em; font-weight: bold; padding: .5em; border-bottom: solid 1px #c3c3c3;">#StoreLogo# #SiteName# Customer Receipt</div>  <div style="padding: 10px;">  <div style="font-family: Verdana; color: #333333; font-size: 11px;">#ReceiptText#</div>  <table style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" border="0" width="100%" cellspacing="3" cellpadding="0">  <tbody>  <tr>  <td colspan="5"><hr /></td>  </tr>  <tr>  <td colspan="2" align="left" nowrap="nowrap" width="25%">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Order Information</div>  </td>  <td colspan="2" align="left" nowrap="nowrap">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Customer Service</div>  </td>  </tr>  <tr>  <td align="left" nowrap="nowrap" width="10%"><strong>Order Number:</strong></td>  <td align="left" nowrap="nowrap" width="30%">#OrderId#</td>  <td align="left" nowrap="nowrap" width="4%"><strong>E-Mail:</strong></td>  <td align="left" nowrap="nowrap">#CustomerServiceEmail#</td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Order Date:</strong></td>  <td align="left" nowrap="nowrap">#OrderDate#</td>  <td align="left" nowrap="nowrap"><strong>Phone:</strong></td>  <td align="left" nowrap="nowrap">#CustomerServicePhoneNumber#</td>  </tr>  <tr>  <td style="vertical-align: top;" align="left" nowrap="nowrap"><strong>Promotion Code:</strong></td>  <td align="left" nowrap="nowrap">#PromotionCode#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Payment Method:</strong></td>  <td align="left" nowrap="nowrap">#PaymentName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>#CardTransactionLabel#</strong></td>  <td align="left" nowrap="nowrap">#CardTransactionID#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap" style="padding-right: 10px;"><strong>#PurchaseNumberLabel#</strong></td>  <td align="left" nowrap="nowrap">#PONumber#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>AccountNumber:</strong></td>  <td align="left" nowrap="nowrap">#AccountNumber#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>ShippingMethod:</strong></td>  <td align="left" nowrap="nowrap">#ShippingName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td align="left" nowrap="nowrap"><strong>Job / Project Name:</strong></td>  <td align="left" nowrap="nowrap">#JobName#</td>  <td></td>  <td></td>  </tr>  <tr>  <td colspan="4"><hr /></td>  </tr>  <tr>  <td style="font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap" width="45%">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Billing Address</div>  </td>  <td colspan="2" align="left">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">Shipping Address</div>  </td>  </tr>  <tr>  <td colspan="2" align="Left" nowrap="nowrap">#BillingAddress#</td>  <td colspan="3" valign="top">#ShippingAddress#</td>  </tr>  <tr>  <td align="Left" nowrap="nowrap" colspan="2"> </td>  <td valign="top" colspan="3"><hr /><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelInHandDate#: </span>#InHandDate#<br /><span style="width: 130px; display: inline-block; font-weight: bold;">#LabelShippingConstraintsCode#: </span>#ShippingConstraintCode#<br /><br /></td>  </tr>  <tr>  <td colspan="7"></td>  </tr>  </tbody>  </table>  <div data-info="#AddressItems#">  <table width="100%" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;" colspan="6">#ShipmentNo#</td>  </tr>  <tr>  <td style="color: black; font-size: 10px;" colspan="6">#ShipTo#</td>  </tr>  <tr style="background-color: #eff3fb;">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>SKU</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Item</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Description</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" align="center"><strong>Qty</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;"><strong>Price</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="2"><strong>Total</strong></td>  </tr>  <tr data-info="#LineItems#OmsOrderShipmentID##">  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="10%">#SKU#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Name#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="25%">#Description#  <p>#ShortDescription#</p>  #UOMDescription# <br /><br />#Column1#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="center" width="5%">#Quantity#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" align="left" width="20%">#Price#</td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#ExtendedPrice#</td>  </tr>  <tr data-info="#AmountLineItems#OmsOrderShipmentID##">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#Amount#</td>  </tr>  <tr data-info="#GrandAmountLineItems#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; padding: 0 5px;" colspan="5" align="right"><strong>#Title#</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2">#Amount#</td>  </tr>  <tr data-info="#TaxSummaryHead#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right"><strong>#TaxName#</strong></td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%"><strong>#Rates#</strong></td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right"><strong>#Amount#</strong></td>  </tr>  <tr data-info="#TaxSummary#">  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" colspan="5" align="right">#TaxName#</td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="center" width="8%">#Rates#</td>  <td style="border: 1px solid silver; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 9px; padding: 0 5px;" align="right">#Amount#</td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #292a2a; font-size: 11px; padding: 0 5px 5px 5px;" colspan="5" align="right"><strong>Total</strong></td>  <td style="border: silver 1px solid; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px; min-width: 170px; padding: 0 5px;" align="right" width="20%" colspan="2"><strong>#TotalCost#</strong></td>  </tr>  </tbody>  </table>  </div>  <table style="width: 100%; padding: 10px; display: inline-block;" cellspacing="0" cellpadding="3">  <tbody>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">  <div style="color: #292a2a; font-weight: bold; font-size: 11px; padding-bottom: 5px;">#AdditionalInstructLabel#</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2">  <div style="width: 675px;" align="justify">#AdditionalInstructions#</div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2">  <div style="margin-bottom: 5px;"></div>  </td>  </tr>  <tr>  <td style="border: none; font-family: Verdana, Helvetica, sans-serif; color: #333333; font-size: 10px;" colspan="2" align="left" nowrap="nowrap">#FeedBack#</td>  </tr>  </tbody>  </table>  </div>  </div>  </div></body></html>'
where EmailTemplateId = (select top 1 EmailTemplateId from ZnodeEmailTemplate where TemplateName='OrderReceipt')
and LocaleId = 1

GO

Update ZnodeApplicationSetting 
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>SearchKeywordsRedirectId</name><headertext>Checkbox</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>SearchKeywordsRedirectId</name><headertext>ID</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl>/SearchConfiguration/EditSearchKeywords</islinkactionurl><islinkparamfield>SearchKeywordsRedirectId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Keywords</name><headertext>Keywords</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>URL</name><headertext>URL</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SearchConfiguration/EditSearchKeywordsRedirect|/SearchConfiguration/DeleteSearchKeywordsRedirect</manageactionurl><manageparamfield>SearchKeywordsRedirectId|SearchKeywordsRedirectId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>' 
where ItemName = 'ZnodeSearchKeywordsRedirectList'

GO

update ZnodeApplicationSetting
set Setting ='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>UserAddressId</name>      <headertext>Checkbox</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>UserAddressId</name>      <headertext>User Address Id</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>y</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>AddressId</name>      <headertext>Checkbox</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>IsDefaultBilling</name>      <headertext>Is Default Billing</headertext>      <width>0</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>IsDefaultShipping</name>      <headertext>Is Default Shipping</headertext>      <width>0</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>DisplayAddress</name>      <headertext>Address</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>AccountId</name>      <headertext>AccountId</headertext>      <width>0</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Customer/EditAddress|/Customer/DeleteAddress</manageactionurl>      <manageparamfield>UserAddressId,UserId|UserAddressId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where itemName='ZnodeUserAddress'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetConfigurableVariantData')
	DROP PROC Znode_GetConfigurableVariantData
GO

CREATE PROCEDURE [dbo].[Znode_GetConfigurableVariantData]
(   
	@PortalId         INT,
	@UserId			  INT = 2,
	@catalogVersionId int, 
	@currentUtcDate    VARCHAR(200) = '',
	@publishProductId   int

)

AS 
     BEGIN
         BEGIN TRY
		  DECLARE @PublishProductIds  NVARCHAR(max) ,@SKU NVARCHAR(max) 
	
		       CREATE TABLE #Tlb_ProductData 
				(
				  ZnodeProductId INT,
				  SKU              NVARCHAR(100),
				  Name NVARCHAR(100),
				  Attributes nvarchar(max),
				  IsActive bit,
				  AssociatedProductDisplayOrder int,
				  ConfigurableAttributeCodes nvarchar(max)
			     );
				Create TABLE #Tbl_PriceList
                (
				  SKU            VARCHAR(300),
				  RetailPrice    NUMERIC(28, 6),
				  SalesPrice     NUMERIC(28, 6),
				  TierPrice      NUMERIC(28, 6),
				  TierQuantity   NUMERIC(28, 6),
				  CurrencyCode   Varchar(100),
				  CurrencySuffix Varchar(1000),
				  CultureCode      VARCHAr(1000),
				  ExternalId NVARCHAR(2000),
				  Custom1        NVARCHAR(MAX),
				  Custom2        NVARCHAR(MAX),
				  Custom3        NVARCHAR(MAX)
                );

				Create TABLE #Tbl_Inventory
				(
				  SKU            VARCHAR(300),
				  Quantity    NUMERIC(28, 6),
				  ReOrderLevel     NUMERIC(28, 6),
				  PortalId      int,
				  WarehouseName	varchar(100),
			      WarehouseCode	varchar(100),
			      DefaultInventoryCount varchar(1000),
				
			    );

				 insert into #Tlb_ProductData (ZnodeProductId, SKU, Name, Attributes, IsActive, AssociatedProductDisplayOrder,ConfigurableAttributeCodes)
				 select ZPE.ZnodeProductId, ZPE.SKU, ZPE.Name,zpe.Attributes, zpe.IsActive, ZPCE.AssociatedProductDisplayOrder, ZPCE.ConfigurableAttributeCodes from ZnodePublishProductEntity as ZPE
				 inner join ZnodePublishConfigurableProductEntity as ZPCE on ZPCE.AssociatedZnodeProductId = ZPE.ZnodeProductId
				 where ZPCE.ZnodeProductId = @publishProductId and ZPCE.VersionId = @catalogVersionId and ZPE.VersionId = @catalogVersionId and ZPE.IsActive = 1

				SELECT @SKU = Substring((SELECT ',' + SKU FROM #Tlb_ProductData FOR XML PAth('')), 2, 4000)

				INSERT INTO #Tbl_PriceList( SKU, RetailPrice,SalesPrice,TierPrice,TierQuantity,CurrencyCode,CurrencySuffix,CultureCode,ExternalId,Custom1,Custom2,Custom3)
				EXEC Znode_GetPublishProductPricingBySku @SKU = @SKU ,@PortalId = @PortalId ,@currentUtcDate = @currentUtcDate,@UserId = @UserId
		
				insert into #Tbl_Inventory (SKU,	Quantity,	ReOrderLevel,	PortalId, WarehouseName, WarehouseCode, DefaultInventoryCount)
				EXEC Znode_GetInventoryBySkus @SKUs=@SKU,@PortalId=@PortalId

				select PD.ZnodeProductId AS PublishProductId, PD.SKU, PD.Name,PD.Attributes, PD.IsActive, PD.AssociatedProductDisplayOrder,PD.ConfigurableAttributeCodes,
				pl.RetailPrice, pl.SalesPrice, pl.CultureCode, pl.CurrencySuffix, tl.Quantity, tl.ReOrderLevel, tl.DefaultInventoryCount, tl.WarehouseName
				from #Tlb_ProductData as PD 
				left join #Tbl_PriceList as PL on pd.SKU = pl.SKU
				left join #Tbl_Inventory as TL on pd.SKU = tl.sku
		END TRY 
			

		 BEGIN CATCH

		 	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
			@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetConfigurableVariantData
			@PortalId = '+CAST(@PortalId AS int)+',
			@UserId='+CAST(@UserId AS int)+',
			@catalogVersionId='+CAST(@catalogVersionId AS int)+',
			@currentUtcDate='+CAST(@currentUtcDate AS VARCHAR(200))+',
			@publishProductId='+CAST(@publishProductId AS int);

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetConfigurableVariantData',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
		  END CATCH
	End

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateDefaultChildProductOfParent')
	DROP PROC Znode_UpdateDefaultChildProductOfParent
GO

CREATE PROCEDURE [dbo].[Znode_UpdateDefaultChildProductOfParent]
(
	@PimParentProductId int,
	@PimProductId int,
	@IsDefault bit = 1,
	@DisplayOrder int,
	@Status bit = 0 out
)
as
--execute Znode_UpdateDefaultChildProductOfParent @PimParentProductId = 89, @PimProductId =1, @IsDefault = 'true'
Begin 
	SET NOCOUNT ON
	BEGIN TRY

		update ZnodePimProductTypeAssociation set IsDefault = 0 
		where IsDefault = 1 and PimParentProductId = @PimParentProductId

		update ZnodePimProductTypeAssociation set IsDefault = @IsDefault , DisplayOrder = @DisplayOrder
		where PimParentProductId = @PimParentProductId and PimProductId = @PimProductId
		
		set @Status = 1
		select @PimParentProductId Id, @Status Status
	END TRY
	BEGIN CATCH
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_UpdateDefaultChildProductOfParent @PimParentProductId = '+cast(@PimParentProductId as varchar(10))+',@PimProductId = '+cast(@PimProductId as varchar(10))+',@IsDefault='+CAST(@IsDefault AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		    
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_UpdateDefaultChildProductOfParent',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
End

GO

update ZnodeApplicationSetting 
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>PimProductTypeAssociationId</name><headertext>Checkbox</headertext><width>20</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield>PimProductTypeAssociationId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>RelatedProductId</name><headertext>RelatedProductId</headertext><width>20</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>PimProductTypeAssociationId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>ProductId</name><headertext>ID</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>productId</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Image</name><headertext>Image</headertext><width>20</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield>ImagePath,ProductName</imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>imageicon</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ProductName</name><headertext>Product Name</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>ProductType</name><headertext>Product Type</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>SKU</name><headertext>SKU</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>SKU</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>AvailableInventory</name><headertext>Available Inventory</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>SKU</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>Assortment</name><headertext>Assortment</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>DisplayOrder</name><headertext>Display Order</headertext><width>10</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>3</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>Text</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>IsDefault</name><headertext>Is Default</headertext><width>40</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype>HiddenField</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>isDefaultVariant</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>DisplayOrder</name><headertext>Display Order</headertext><width>10</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>5</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>y</iscontrol><controltype>Text</controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>DisplayOrder</Class><SearchControlType>Text</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/PIM/Products/UpdateAssociatedConfigurableProducts|/PIM/Products/UnassociateProducts</manageactionurl><manageparamfield>PimProductTypeAssociationId,PimProductId,RelatedProductId,IsDefault,ProductId|PimProductTypeAssociationId,ProductId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'View_ManageProductTypeList'

GO

DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,AttributeTypeId int,AttributeCode nvarchar(300))
INSERT INTO ZnodePimAttribute (AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined
,IsConfigurable,IsPersonalizable,IsShowOnGrid,DisplayOrder,HelpDescription,IsCategory,IsHidden,IsSwatch,
CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
OUTPUT Inserted.PimAttributeId,Inserted.AttributeTypeId,Inserted.AttributeCode INTO @InsertedPimAttributeIds  		
SELECT (SELECT AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName = 'Yes/No')
,'DisplayVariantsOnGrid',0,0,0,1,0,0,0,7,'When enabled, all the product variants are displayed on grid on the Quick View and Product Details Page on the web store for bulk ordering',0,0,null,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttribute ZPA WHERE ZPA.AttributeCode = 'DisplayVariantsOnGrid')
		
INSERT INTO ZnodePimAttributeLocale (LocaleId,PimAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 1 ,IPAS.PimAttributeId, 'Display Variants On Grid', null, 2,GETDATE(),2,GETDATE()   
FROM @InsertedPimAttributeIds IPAS 
		
insert into ZnodePimFrontendProperties 
(PimAttributeId,IsComparable,IsUseInSearch,IsHtmlTags,IsFacets,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
Select IPA.PimAttributeId,0 IsComparable, 0 IsUseInSearch, 0 IsHtmlTags,0 IsFacets,2,getdate(),2,getdate()
from @InsertedPimAttributeIds IPA
		
INSERT INTO ZnodePimAttributeGroupMapper
(PimAttributeGroupId,PimAttributeId,AttributeDisplayOrder,IsSystemDefined,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select PimAttributeGroupId from ZnodePimAttributeGroup where GroupCode = 'ProductSetting'),(select PimAttributeId from znodePimattribute where AttributeCode = 'DisplayVariantsOnGrid'),null,0,2,getdate(),2,getdate()
WHERE NOT EXISTS (select * from ZnodePimAttributeGroupMapper where PimAttributeGroupId =(select PimAttributeGroupId from ZnodePimAttributeGroup where GroupCode = 'ProductSetting') AND
PimAttributeId = (select PimAttributeId from znodePimattribute where AttributeCode = 'DisplayVariantsOnGrid') )
GO

INSERT INTO ZnodePimFamilyGroupMapper (PimAttributeFamilyId,PimAttributeGroupId,PimAttributeId,GroupDisplayOrder,IsSystemDefined
,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT PimAttributeFamilyId, (SELECT TOP 1 PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'ProductSetting'),
(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'DisplayVariantsOnGrid'),500,1,2,GETDATE(),2,GETDATE()
FROM  ZnodePimAttributeFamily PAF
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimFamilyGroupMapper PFG WHERE 
PimAttributeId = (SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'DisplayVariantsOnGrid')
AND PimAttributeGroupId = (SELECT TOP 1 PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'ProductSetting') 
AND PFG.PimAttributeFamilyId = PAF.PimAttributeFamilyId)
AND PAF.IsCategory = 0 

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOmsAccountOrderList')
	DROP PROC Znode_GetOmsAccountOrderList
GO

CREATE PROCEDURE [dbo].[Znode_GetOmsAccountOrderList]  
( @WhereClause NVARCHAR(MAX),  
  @Rows        INT           = 100,  
  @PageNo      INT           = 1,  
  @Order_BY    VARCHAR(100)  = '',  
  @RowsCount   INT OUT,  
  @AccountId   INT)  
AS   
 /*  
  Summary :- This procedure is used to get the Quote list of account and Users   
    Fn_GetRecurciveAccounts is used to fetch AccountId and Its recursive ParentId   
    The result id fetched on the basis of AccountId of the User  
     Unit Testing    
     EXEC Znode_GetOmsAccountOrderList '' ,@RowsCount = 0 ,@AccountId = 1  
   
*/  
     BEGIN  
         BEGIN TRY  
             SET NOCOUNT ON;  
             DECLARE @SQL NVARCHAR(MAX);  
  
             DECLARE @TBL_QuoteDetails TABLE (OmsOrderId INT,UserName NVARCHAR(300),OrderAmount NUMERIC(28, 6),[Status] VARCHAR(300),CreatedDate DATETIME,OmsPaymentStateId INT,OmsPaymentState NVARCHAR(MAX),  
                     PaymentTypeId INT,PaymentType VARCHAR(50),OrderNumber VARCHAR(200),IsInRMA BIT ,RowId INT,CountNo INT,CurrencyCode VARCHAR(100),PaymentDisplayName Nvarchar(1200),CultureCode VARCHAR(100)
					 ,PortalId INT, UserId INT);
              
    SET @Order_BY = REPLACE(@Order_BY,'OmsOrderId','CTEQD.OmsOrderId')  
    SET @SQL = '  
  
   ;With Cte_GetQuoteDetail AS   
   (  
  
   SELECT Zu.UserId ,ZOO.OmsOrderId,APZU.UserName UserName ,Total  OrderTotal , ZOOS.OrderStateName OrderState  
    ,ZOOD.OrderDate ,ZOPS.OmsPaymentStateId,ZOPS.Name PaymentStatus  ,ZOOD.PaymentTypeId , ZPT.Name PaymentType,ZOO.OrderNumber,ZOOD.CurrencyCode  
    ,CASE WHEN ARJT.PaymentDisplayName IS NULL THEN ZPS.PaymentDisplayName ELSE  ARJT.PaymentDisplayName END PaymentDisplayName ,ZOOD.CultureCode 
	,ZOOD.PortalId
   FROM ZnodeOmsOrder ZOO  
   INNER JOIN ZnodeOmsOrderDetails ZOOD ON (ZOOD.OmsOrderId = ZOO.OmsOrderId AND ZOOD.IsActive = 1 )  
   LEFT JOIN ZnodePaymentSetting ZPS ON (ZPS.PaymentSettingId = ZOOD.PaymentSettingId)  
   INNER JOIN ZnodeUser ZU ON (ZU.UserId = ZOOD.UserId)  
   LEFT JOIN ZnodeOmsPaymentState ZOPS ON (ZOPS.OmsPaymentStateId = ZOOD.OmsPaymentStateId )  
   LEFT JOIN ZnodeOmsOrderState ZOOS ON (ZOOS.OmsOrderStateId = ZOOD.OmsOrderStateId )  
   LEFT JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZOOD.PaymentTypeId)  
   LEFT JOIN AspNetUsers ASNU ON (ASNU.Id =ZU.AspNetUserId  )  
   LEFT JOIN AspNetZnodeUser  APZU ON (APZU.AspNetZnodeUserId = ASNU.UserName AND (APZU.PortalId = ZOOD.PortalId OR APZU.PortalId IS NULL  ))  
   LEFT JOIN ZnodePortalPaymentSetting ARJT ON (ARJT.PortalId = ZOOD.PortalId AND ARJT.PaymentSettingId = ZOOD.PaymentSettingId )  
   WHERE EXISTS (SELECT TOP 1 1 FROM [dbo].[Fn_GetRecurciveAccounts]('+CAST(@AccountId AS VARCHAR(100))+') FNRA WHERE FNRA.AccountId= ZU.AccountId)   
     
   )  
   ,Cte_GetRMAdetails AS  
   (  
     SELECT OmsOrderId   
  FROM ZnodeOmsOrderDetails ZOOD   
  INNER JOIN ZnodeOmsOrderLIneItems ZOODLI ON (ZOODLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId )  
  INNER JOIN ZnodeRmaRequestItem ZRRI ON (ZRRI.OmsOrderLineItemsId = ZOODLI.OmsOrderLineItemsId )  
     
   )  
   , Cte_GetQuote AS   
   (  
    SELECT CTEQD.*,CASE WHEN CTERD.OmsOrderid IS NULL THEN 0 ELSE 1 END IsInRMA   ,'+dbo.Fn_GetPagingRowId(@Order_BY,'CTEQD.OmsOrderId DESC')+',Count(*)Over() CountNo   
    FROM Cte_GetQuoteDetail CTEQD   
    LEFT JOIN Cte_GetRMAdetails CTERD ON (CTERD.OmsOrderId = CTEQD.OmsOrderid )  
       WHERE 1=1   
    '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'  
   )  
  
   SELECT OmsOrderId,UserName , OrderTotal QuoteAmount, OrderState Status ,OrderDate,OmsPaymentStateId  ,PaymentStatus,PaymentTypeId,PaymentType,OrderNumber,IsInRMA,RowId,CountNo,CurrencyCode,PaymentDisplayName,CultureCode
		,PortalId, UserId
   FROM Cte_GetQuote   
   WHERE '+dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' RowId ');  
            
      PRINT @SQL  
    INSERT INTO @TBL_QuoteDetails   
             EXEC (@SQL);  
             SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_QuoteDetails ), 0);  
  
             SELECT OmsOrderId,UserName,OrderAmount,[Status] AS 'OrderState',CreatedDate AS 'OrderDate',OmsPaymentStateId,OmsPaymentState AS 'PaymentStatus',PaymentTypeId,PaymentType,OrderNumber,IsInRMA,CurrencyCode,PaymentDisplayName,CultureCode
				,PortalId, UserId
             FROM @TBL_QuoteDetails;  
      
         END TRY  
         BEGIN CATCH  
             DECLARE @Status BIT ;  
       SET @Status = 0;  
       DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOmsAccountOrderList @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@AccountId = '+CAST(@AccountId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));  
                    
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                      
      
             EXEC Znode_InsertProcedureErrorLog  
    @ProcedureName = 'Znode_GetOmsAccountOrderList',  
    @ErrorInProcedure = @Error_procedure,  
    @ErrorMessage = @ErrorMessage,  
    @ErrorLine = @ErrorLine,  
    @ErrorCall = @ErrorCall;  
         END CATCH;  
     END;

GO

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OmsOrderId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>OrderNumber</name>      <headertext>Order No</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/Order/Manage</islinkactionurl>      <islinkparamfield>OmsOrderId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>UserName</name>      <headertext>Customer Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Email</name>      <headertext>Email</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PhoneNumber</name>      <headertext>Phone Number</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>StoreName</name>      <headertext>Store Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>OrderState</name>      <headertext>Order Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>orderState</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>PaymentStatus</name>      <headertext>Payment Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>paymentStatus</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>PaymentDisplayName</name>      <headertext>Payment Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>paymentType</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>OrderTotalWithCurrency</name>      <headertext>Total</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>11</id>      <name>Total</name>      <headertext>Total</headertext>      <width>30</width>      <datatype>Decimal</datatype>      <columntype>Decimal</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>12</id>      <name>SubTotalAmount</name>      <headertext>SubTotal</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>13</id>      <name>Tax</name>      <headertext>Tax</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>14</id>      <name>Shipping</name>      <headertext>Shipping</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>15</id>      <name>BillingPostalCode</name>      <headertext>Billing Zip Code</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>16</id>      <name>ShippingPostalCode</name>      <headertext>Shipping Zip Code</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>17</id>      <name>OrderDateWithTime</name>      <headertext>Order Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>18</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>19</id>      <name>PublishState</name>      <headertext>Application Type</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>20</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>21</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>View|return|shopping-cart</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>View|Create Return|Reorder</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Order/Manage|/RMAReturn/CheckOrderEligibleForReturn|/Order/ReorderCompleteOrder</manageactionurl>      <manageparamfield>OmsOrderId|orderNumber,userId,portalId,omsOrderId|userId,portalId,omsOrderId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='ZnodeOrder'

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OrderNumber</name>      <headertext>Order No</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/Order/Manage</islinkactionurl>      <islinkparamfield>OmsOrderId,accountId,updatePageType</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>StoreName</name>      <headertext>Store Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>OrderState</name>      <headertext>Order Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>PaymentStatus</name>      <headertext>Payment Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PaymentDisplayName</name>      <headertext>Payment Type</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>paymentType</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>OrderTotalWithCurrency</name>      <headertext>Order Amount</headertext>      <width>30</width>      <datatype>Decimal</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>OrderDate</name>      <headertext>Order Date</headertext>      <width>30</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>View|shopping-cart</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>View|Reorder</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Order/Manage|/Order/ReorderCompleteOrder</manageactionurl>      <manageparamfield>OmsOrderId,accountId,updatePageType|userId,portalId,omsOrderId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='CustomerOrderHistory'

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OmsOrderId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>OrderNumber</name>      <headertext>Order No</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/Order/Manage</islinkactionurl>      <islinkparamfield>OmsOrderId,accountId,updatePageType</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>UserName</name>      <headertext>Username</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>OrderState</name>      <headertext>Order Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PaymentStatus</name>      <headertext>Payment Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>paymentStatus</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>PaymentDisplayName</name>      <headertext>Payment Type</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>OrderTotalWithCurrency</name>      <headertext>Order Amount</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>OrderDate</name>      <headertext>Order Date</headertext>      <width>30</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>IsInRMA</name>      <headertext>IsInRMA</headertext>      <width>40</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>IsInRMA</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Guest User</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>IsInRMA</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>View|shopping-cart</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>View|Reorder</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Order/Manage|/Order/ReorderCompleteOrder</manageactionurl>      <manageparamfield>OmsOrderId,accountId,updatePageType|userId,portalId,omsOrderId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='AccountUserOrderList'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemConfigurable]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdConfigurable INT
	,@OrderLineItemRelationshipTypeIdAddon INT	
)
AS 
BEGIN 
BEGIN TRY 
 SET NOCOUNT ON 
	--Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT, OmsSavedCartId INT,SKU NVARCHAr(max),GroupId  NVARCHAr(max),ParentOmsSavedCartLineItemId INT,OrderLineItemRelationshipTypeId INT  ) 
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,ConfigurableProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.ConfigurableProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	 CREATE TABLE #NewConfigSavecartLineitemDetails 
	 (
		 GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(configurable product)
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new configurable product save cart data
	INSERT INTO #NewConfigSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdConfigurable, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE ConfigurableProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	--Getting new configurable products save cart data if addon is present for any line item
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 
		 SELECT * 
		INTO #ZnodeOmsSavedCartLineItem_NT
		FROM ZnodeOmsSavedCartLineItem a 
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId)

    CREATE TABLE #OldConfigSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old configurable save cart data if present for same SKU in the new save cart data for configurable product	 
	INSERT INTO #OldConfigSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM #ZnodeOmsSavedCartLineItem_NT a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.ConfigurableProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable   

	--Getting the old save cart Parent data
	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldConfigSavecartLineitemDetails
		  
	DELETE a FROM #OldConfigSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldConfigSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		
		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN
		
		
			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM #ZnodeOmsSavedCartLineItem_NT b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId AND OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null AND OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.ConfigurableProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

			

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b ON a.SKU = b.SKU AND a.AddOns = b.AddOns )
		BEGIN
			   
			DELETE FROM #OldConfigSavecartLineitemDetails 
	
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldConfigSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
			 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			 INSERT INTO  @parenTofAddon 
			 SELECT  ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails a  WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  #ZnodeOmsSavedCartLineItem_NT  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  

			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
					AND ParentOmsSavedCartLineItemId IS NOT NULL  
					AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #ZnodeOmsSavedCartLineItem_NT   WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM #ZnodeOmsSavedCartLineItem_NT a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
		    AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldConfigSavecartLineitemDetails 
		  END  
		 ELSE IF  EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItem_NT Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 

		END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present		
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		 DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		    DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
		    SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		    AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		    OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		    AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		 
		   DELETE n FROM #OldConfigSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldConfigSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldConfigSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails )
	BEGIN
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.ConfigurableProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldConfigSavecartLineitemDetails b1 ON a1.SKU = b1.SKU
		INNER JOIN #OldConfigSavecartLineitemDetails c1 ON (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId AND a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldConfigSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldConfigSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldConfigSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	 

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewConfigSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon
		 
		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S ON a.OmsSavedCartId = s.OmsSavedCartId AND a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewConfigSavecartLineitem   
		 FROM  #NewConfigSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
       	    
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid INTo new save cart line item as new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewConfigSavecartLineitem m  
			INNER JOIN  #InsertNewConfigSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewConfigSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
           
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewConfigSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,	CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
        OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.OmsSavedCartId,inserted.SKU,inserted.GroupId,INSERTED.ParentOmsSavedCartLineItemId,INSERTED.OrderLineItemRelationshipTypeId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewConfigSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO   #Cte_newData
		FROM @OmsInsertedData a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			  
	
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )

	---------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData1 
		FROM @OmsInsertedData a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon     
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId AND 
		 a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null  ) 
 
	---------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId  )RowIdNo
		INTO #NewConfigProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) ON b.sku = c.sku AND b.OmsSavedCartId=c.OmsSavedCartId AND b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) AND c.ParentOmsSavedCartLineItemId is null
  
	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a with (nolock)
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewConfigSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewConfigProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewConfigProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewConfigSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewConfigSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		(  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  

		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b with (nolock) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)--  and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
		
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 




END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper')
	DROP PROC Znode_InsertUpdateSaveCartLineItemQuantityWrapper
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemQuantityWrapper]
(
	@CartLineItemXML xml, 
	@UserId int,
	@PortalId Int,
	@OmsCookieMappingId INT = 0 
)
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
BEGIN TRAN InsertUpdateSaveCartLineItem;
BEGIN TRY
SET NOCOUNT ON;
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate();
	DECLARE @AddOnQuantity numeric(28, 6)= 0;
	DECLARE @IsAddProduct   BIT = 0 
	DECLARE @OmsSavedCartLineItemId INT = 0
	
	DECLARE @TBL_SavecartLineitems TABLE
	( 
		RowId int IDENTITY(1,1), OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
		CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
		AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
		Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
		nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max)
	);

	--Set the OrderLineItemRelationshipTypeId for Addons product
	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);
	--Set the OrderLineItemRelationshipTypeId for simple product
	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);
	--Set the OrderLineItemRelationshipTypeId for group product
	DECLARE @OrderLineItemRelationshipTypeIdGroup int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);
	--Set the OrderLineItemRelationshipTypeId for Configurable product
	DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);
	--Set the OrderLineItemRelationshipTypeId for Bundles product	
	DECLARE @OrderLineItemRelationshipTypeIdBundle int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	-----Getting OmsSaveCartId FROM @OmsCookieMappingId
	DECLARE @OmsSavedCartId int
	--Getting OmsCookieMappingId on basis of @UserId and portalid if @UserId > 0 (Not a guest User)
	IF isnull(@OmsCookieMappingId,0)=0 and isnull(@UserId,0) <> 0  
	Begin
		SET @OmsCookieMappingId = (SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) where isnull(UserId,0) = @UserID AND isnull(PortalId,0) = @PortalId)
	END

	IF Not Exists(SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) Where OmsCookieMappingId = @OmsCookieMappingId)
	Begin
		INSERT INTO ZnodeOmsCookieMapping (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT case when @UserId = 0 then null else @UserId end ,@PortalId,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsCookieMappingId = @@IDENTITY
	End
	----To get the oms savecartid on basis of @OmsCookieMappingId 
	SET @OmsSavedCartId = (SELECT top 1 OmsSavedCartId FROM ZnodeOmsSavedCart with (nolock) where OmsCookieMappingId = @OmsCookieMappingId)
	
	----If omssavecartid not present in ZnodeOmsSavedCart table then inserting new record to generated omssavecartid 
	IF isnull(@OmsSavedCartId,0) = 0
	BEGIN
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @OmsCookieMappingId,Null,Null,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsSavedCartId = @@IDENTITY
	END

	--Fetching data FROM xml to table format and inserted into table @TBL_SavecartLineitems
	INSERT INTO @TBL_SavecartLineitems( OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
	Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity )
	SELECT Tbl.Col.value( 'OmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartLineItemId, Tbl.Col.value( 'ParentOmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsSavedCartLineItemId, @OmsSavedCartId AS OmsSavedCartId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
	, Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ) AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
			Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
			Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
			Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
			Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
			Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
			Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
			Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
			Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
			Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
			Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity
	FROM @CartLineItemXML.nodes( '//ArrayOfSavedCartLineItemModel/SavedCartLineItemModel' ) AS Tbl(Col);
			  
	IF OBJECT_ID('tempdb..#TBL_SavecartLineitems') is not null
		DROP TABLE #TBL_SavecartLineitems

	IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
		DROP TABLE #OldValueForAddon

	SELECT * INTO #TBL_SavecartLineitems FROM @TBL_SavecartLineitems
			
	UPDATE ZnodeOmsSavedCart
	SET ModifiedDate = GETDATE()
	WHERE OmsSavedCartId = (SELECT TOP 1  OmsSavedCartId FROM @TBL_SavecartLineitems)

	UPDATE  @TBL_SavecartLineitems
	SET 	Description = ISNUll(Description,'') 

	--Save cart execution code for bundle product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
			, ModifiedDate = @GetDate
			WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
			OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.BundleProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 

		--Getting bundle save cart line item entries into table to pass for bundle prodcut sp
		DECLARE @TBL_bundleProduct TT_SavecartLineitems 
		INSERT INTO @TBL_bundleProduct 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(BundleProductIds,'') <> '' 
				
		EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
		DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
		SET @OmsSavedCartLineItemId = 0 
	END 
	--Save cart execution code for configurable product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 

			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			, ModifiedDate = @GetDate
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.ConfigurableProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for configurable prodcut sp
		DECLARE @TBL_Configurable TT_SavecartLineitems 
		INSERT INTO @TBL_Configurable 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> '' 
		  
		EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
		DELETE FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	--Save cart execution code for group product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			--Updating the existing save cart for group product
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.GroupProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for group prodcut sp
		DECLARE @TBL_Group TT_SavecartLineitems 
		INSERT INTO @TBL_Group 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(GroupProductIds,'') <> '' 
		
		EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
		
		--After update the existing cart with new save cart then deleting those records which are updated
		DELETE FROM @TBL_SavecartLineitems WHERE ISNULL(GroupProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	
	--This part is for updating the cart for existing line items for simple product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
	BEGIN 
				 
		SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
		, ModifiedDate = @GetDate
		WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
		INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
		WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
		DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
	END 
	--Save cart execution code for Simple product
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
	--Inserting the personalise data into variable table @TBL_Personalise for inserting the personalise data for new products
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId int,SKU Varchar(600) ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.SKU
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM @TBL_SavecartLineitems a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise1 TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise1
	SELECT DISTINCT a.OmsSavedCartLineItemId 
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM (SELECT TOP 1 OmsSavedCartLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SavecartLineitems TRTR ) a 
	CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
	CREATE TABLE #NewSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	int	,AutoAddon	varchar(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @TBL_SavecartLineitems a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	
	--Getting new simple product save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE ISNULL(BundleProductIds,'') =  '' 
	AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity,  CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			
	--Getting new Group,Bundle and Configurable products save cart data if addon is present for any line item
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
		WHEN  GroupProductIds <> '' THEN GroupProductIds 
		WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	CREATE TABLE #OldSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old save cart data if present for same SKU in the new save cart data for simple product	 
	INSERT INTO #OldSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

	--Getting the old save cart Parent data 
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
	DELETE a FROM #OldSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldSavecartLineitemDetails
		
	--Getting the old save cart addon data for old line items if present
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN

		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b with (nolock)
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @TBL_SavecartLineitems a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldSavecartLineitemDetails
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
	    
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		 
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 

			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  

		END
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 

			DELETE FROM #OldSavecartLineitemDetails
		END 
	END 

	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)

	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		      
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 

			DELETE n FROM #OldSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	   
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	  
	END 

	--If already exists cart 
	IF EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*
			FROM @TBL_SavecartLineitems a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			SELECT c.ParentOmsSavedCartLineItemId
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where a.PersonalizeValue <> ''
		)
		,cte2 AS
		(
			SELECT a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
						and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU AS SKU
				,a.PersonalizeCode
				,a.PersonalizeValue
				,a.DesignId
				,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b ON a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewSavecartLineitemDetails  b ON a.SKU = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0 AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
						,d.PersonalizeCode
				,d.PersonalizeValue
				,d.DesignId
				,d.ThumbnailURL
				FROM @TBL_SavecartLineitems a 
				INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
				INNER JOIN @TBL_Personalise d on d.SKU = a.SKU
				INNER JOIN ZnodeOmsPersonalizeCartItem  c  with (nolock)  on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
				WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM cte a1		  
		INNER JOIN #OldSavecartLineitemDetails b1 on a1.sku = b1.SKU
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches 
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewSavecartLineitemDetails ty ON (ty.SKU = b.SKU)

	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
	    --Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewSavecartLineitem   
		FROM  #NewSavecartLineitemDetails  
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id   
       	
		--Removing the line item having Quantity <=0	     
		DELETE FROM #InsertNewSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			FROM #InsertNewSavecartLineitem m  
			INNER JOIN  #InsertNewSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
		)   
		DELETE FROM #InsertNewSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  

		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewSimpleProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null

		--Updating ParentOmsSavedCartLineItemId for newly added save cart line item
		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS NULL  
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1 FROM #NewSimpleProduct TI WHERE TI.SKU = a.SKU)
		)
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     

		;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
	
		----To update saved cart item personalise value FROM given line item	
		IF EXISTS(SELECT * FROM @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
		BEGIN
			DELETE FROM ZnodeOmsPersonalizeCartItem 
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

			MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
			USING @TBL_Personalise1 SOURCE
			ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			WHEN NOT MATCHED THEN 
			INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
			VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
		END		
	
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)-- and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
		ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
		INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
	END 

	Declare @OutputTable Table (CartCount numeric(28,6))

	INSERT INTO @OutputTable
	EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId = @OmsCookieMappingId,@UserId=@UserId,@PortalId=@UserId
	

	SELECT CAST(1 AS bit) AS Status,@OmsSavedCartId AS SavedCartId,@OmsCookieMappingId AS CookieMappingId,CartCount
	FROM @OutputTable

COMMIT TRAN InsertUpdateSaveCartLineItem;
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
	AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@PortalId='+CAST(@PortalId AS varchar(10))+',@OmsCookieMappingId='+CAST(@OmsCookieMappingId AS varchar(10));

	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	ROLLBACK TRAN InsertUpdateSaveCartLineItem;
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItem', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductsAttributeValue_newTesting')
	DROP PROC Znode_GetProductsAttributeValue_newTesting
GO

CREATE PROCEDURE [dbo].[Znode_GetProductsAttributeValue_newTesting]  
(   @PimProductId  transferid readonly ,  
    @AttributeId transferid readonly,  
    @LocaleId      INT = 0,  
 @IsPublish bit = 0, 
 @IsFilesNameRequired Bit =0)  
AS  
/*   
		Summary:- This Procedure is used to get the product attribute values   
		The result is fetched from all locale for ProductId provided  
		Unit Testing   
		EXEC Znode_GetProductsAttributeValue_1 '2146','ProductName,SKU,Price,Quantity,IsActive,ProductType,Image,Assortment,DisplayOrder,Style,Material',0  
		SELECT * FROM ZnodePIMProduct  
		DECLARE @Tyr TransferId   
		,  @Tyr1   TransferId   
		INSERT INTO @Tyr   
		SELECT   
		EXEC Znode_GetProductsAttributeValue '121','ProductName,SKU,Price,Quantity,IsActive,ProductType,Image,Assortment,DisplayOrder,Style,Material',1  
		EXEC Znode_GetProductsAttributeValue '121','ProductName,SKU,Price,Quantity,IsActive,ProductType,Image,Assortment,DisplayOrder,Style,Material',2,@IsPublish =1   
*/   
  BEGIN  
     BEGIN TRY  
     SET NOCOUNT ON;  
        
	 --  DECLARE #TBL_AttributeValue1 TABLE (PimAttributeValueId INT , PimAttributeId INT , PimProductId INT,AttributeCode VARCHAR(200)  )  
     DECLARE @DefaultLocaleId INT = dbo.FN_GetDefaultLocaleID()  
  
	 -- INSERT INTO  (PimAttributeValueId , PimAttributeId , PimProductId,AttributeCode )  
           SELECT PimAttributeValueId , ZPAV.PimAttributeId , PimProductId,AttributeCode   
     INTO #TBL_AttributeValue1  
     FROM ZnodePimAttributeValue ZPAV   
     INNER JOIN  ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)    
     WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId TBLP WHERE TBLP.Id = ZPAV.PimProductId )  
     AND EXISTS (SELECT TOP 1 1 FROM @AttributeId TBLA WHERE TBLA.Id = ZPAV.PimAttributeId  )  
     
   CREATE TABLE #TBL_AttributeValue  (PimAttributeValueId INT  , PimAttributeId  INT , PimProductId INT ,AttributeCode NVARCHAR(600),AttributeValue NVARCHAR(max),TypeOfData INT   
      ,PimAttributeValueLocaleId INT ,LocaleId INT , RowId INT,PimAttributeDefaultValueId INT  )  
          INSERT INTO #TBL_AttributeValue (PimAttributeValueId   , PimAttributeId   , PimProductId  ,AttributeCode ,AttributeValue ,TypeOfData    
      ,PimAttributeValueLocaleId  ,LocaleId  , RowId    )     
    SELECT TBLAV.PimAttributeValueId , TBLAV.PimAttributeId , PimProductId,AttributeCode,ZPAVL.AttributeValue,1 TypeOfData  
      ,ZPAVL.ZnodePimAttributeValueLocaleId PimAttributeValueLocaleId,LocaleId,COUNT(*)Over(Partition By TBLAV.PimProductId,PimAttributeId ORDER BY TBLAV.PimProductId,PimAttributeId  ) RowId  
        FROM ZnodePimAttributeValueLocale  ZPAVL   
    INNER JOIN #TBL_AttributeValue1 TBLAV ON (TBLAV.PimAttributeValueId = ZPAVL.PimAttributeValueId)  
    WHERE LocaleId = @DefaultLocaleId OR LocaleId = @LocaleId   
     
    INSERT INTO #TBL_AttributeValue (PimAttributeValueId   , PimAttributeId   , PimProductId  ,AttributeCode ,AttributeValue ,TypeOfData    
      ,PimAttributeValueLocaleId  ,LocaleId  , RowId )  
    SELECT TBLAV.PimAttributeValueId , TBLAV.PimAttributeId , PimProductId,AttributeCode,ZPAVL.AttributeValue,1 TypeOfData  
      ,ZPAVL.PimProductAttributeTextAreaValueId PimAttributeValueLocaleId,LocaleId,COUNT(*)Over(Partition By TBLAV.PimProductId,PimAttributeId ORDER BY TBLAV.PimProductId,PimAttributeId  ) RowId  
    FROM ZnodePimProductAttributeTextAreaValue  ZPAVL   
    INNER JOIN #TBL_AttributeValue1 TBLAV ON (TBLAV.PimAttributeValueId = ZPAVL.PimAttributeValueId)  
    WHERE LocaleId = @DefaultLocaleId OR LocaleId = @LocaleId   
     
    INSERT INTO #TBL_AttributeValue (PimAttributeValueId   , PimAttributeId   , PimProductId  ,AttributeCode ,AttributeValue ,TypeOfData    
      ,PimAttributeValueLocaleId  ,LocaleId  , RowId ,PimAttributeDefaultValueId   )  
    SELECT TBLAV.PimAttributeValueId , TBLAV.PimAttributeId , PimProductId,AttributeCode,  
           CAST( ZPAVL.PimAttributeDefaultValueId AS VARCHAR(2000)),2 TypeOfData  
      ,ZPAVL.PimProductAttributeDefaultValueId PimAttributeValueLocaleId,LocaleId  
      ,COUNT(*)Over(Partition By TBLAV.PimProductId,PimAttributeId ORDER BY TBLAV.PimProductId,PimAttributeId  ) RowId  
      ,PimAttributeDefaultValueId  
    FROM ZnodePimProductAttributeDefaultValue  ZPAVL   
    INNER JOIN #TBL_AttributeValue1 TBLAV ON (TBLAV.PimAttributeValueId = ZPAVL.PimAttributeValueId)  
    WHERE LocaleId = @DefaultLocaleId OR LocaleId = @LocaleId   
      
    INSERT INTO #TBL_AttributeValue (PimAttributeValueId   , PimAttributeId   , PimProductId  ,AttributeCode ,AttributeValue ,TypeOfData    
      ,PimAttributeValueLocaleId  ,LocaleId  , RowId   )  
    SELECT TBLAV.PimAttributeValueId , TBLAV.PimAttributeId , PimProductId,AttributeCode,CAST( ZPAVL.MediaId AS VARCHAR(2000)) ,3 TypeOfData  
      ,ZPAVL.PimProductAttributeMediaId PimAttributeValueLocaleId,ZPAVL.LocaleId,COUNT(*)Over(Partition By TBLAV.PimProductId,PimAttributeId ORDER BY TBLAV.PimProductId,PimAttributeId  ) RowId  
    FROM ZnodePimProductAttributeMedia  ZPAVL   
    INNER JOIN #TBL_AttributeValue1 TBLAV ON (TBLAV.PimAttributeValueId = ZPAVL.PimAttributeValueId)  
    WHERE LocaleId = @DefaultLocaleId OR LocaleId = @LocaleId   
    
	 DECLARE @url VARCHAR(1000)
	 SELECT @url= CONCAT (FeatureValues,FeatureSubValues) FROM ZnodeGlobalSetting WHERE FeatureName='ProductImagePath'
			 
     SELECT ZPPADV.PimAttributeValueId   
     ,ZPADVL.AttributeDefaultValue AttributeDefaultValue ,ZPADVL.localeID LocaleId ,ZPPADV.PimProductId   
     ,ZPPADV.AttributeCode,ZPPADV.PimAttributeId,TEY.AttributeDefaultValueCode    
     into #Cte_GetDefaultData
	 FROM #TBL_AttributeValue ZPPADV   
     INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPPADV.PimAttributeValueId)  
     INNER JOIN ZnodePimAttributeDefaultValue TEY ON (TEY.PimAttributeDefaultValueId  = ZPPADV.PimAttributeDefaultValueId )  
     INNER JOIN ZnodePimAttributeDefaultValuelocale ZPADVL ON (ZPADVL.PimAttributeDefaultValueId = TEY.PimAttributeDefaultValueId )  
     WHERE ZPPADV.localeID  IN (@LocaleId,@DefaultLocaleId)  
     AND TypeOfData = 2   
     AND ZPPADV.LocaleId  = CASE WHEN RowId >= 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
   
	--insert into Cte_AttributeValueDefault
     SELECT AttributeDefaultValue  ,PimProductId ,AttributeCode,PimAttributeId ,AttributeDefaultValueCode   
     into #Cte_AttributeValueDefault
	 FROM #Cte_GetDefaultData   
     WHERE LocaleId = @LocaleId   
     --UNION 
	 insert into #Cte_AttributeValueDefault   
     SELECT  AttributeDefaultValue  ,PimProductId ,AttributeCode,PimAttributeId,AttributeDefaultValueCode   
     FROM #Cte_GetDefaultData a   
     WHERE LocaleId = @DefaultLocaleId   
     AND NOT EXISTS (SELECT TOP 1 1 FROM #Cte_GetDefaultData b WHERE b.PimAttributeValueId = a.PimAttributeValueId AND b.LocaleId= @LocaleId)  
      --  )  
    
	create table #AttributeValueDefaultData( PimProductId int,	AttributeValue varchar(max),	AttributeCode varchar(300),	PimAttributeId int,	AttributeDefaultValue varchar(2000), PimAttributeValueLocaleId int,FilesName varchar(max) Null)  
    
	SELECT ZM.MediaId,[dbo].[Fn_GetMediaThumbnailMediaPath]( zm.PATH) MediaPath,ZM.FileName
	into #ZnodeMediaFileNameDetails
	FROM ZnodeMedia ZM 
	WHERE Exists (Select 1
	FROM #TBL_AttributeValue TBLAV   
	WHERE  LocaleId  = CASE WHEN RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
	AND TypeOfData = 3 
	and ZM.MediaId = TBLAV.AttributeValue  ) 


	insert into #AttributeValueDefaultData(PimProductId,AttributeValue,AttributeCode,PimAttributeId,AttributeDefaultValue)  
    SELECT  PimProductId, AttributeValue,  AttributeCode,  PimAttributeId, NULL AttributeDefaultValue    
    FROM  #TBL_AttributeValue   
             WHERE LocaleId  = CASE WHEN RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
    AND TypeOfData = 1    

   UNION ALL  
   SELECT DISTINCT PimProductId,
			 SUBSTRING ((SELECT ',' + AttributeDefaultValue 
													FROM #Cte_AttributeValueDefault CTEAI 
													WHERE CTEAI.PimProductId = CTEA.PimProductId 
													AND CTEAI.PimAttributeId = CTEA.PimAttributeId
													FOR XML PATH ('')   ),2,4000) AttributeDefaultValue,AttributeCode ,PimAttributeId
			 ,SUBSTRING ((SELECT ',' + AttributeDefaultValueCode 
													FROM #Cte_AttributeValueDefault CTEAI1 
													WHERE CTEAI1.PimProductId = CTEA.PimProductId 
													AND CTEAI1.PimAttributeId = CTEA.PimAttributeId
													FOR XML PATH ('')   ),2,4000) AttributeDefaultValue
				
			FROM #Cte_AttributeValueDefault  CTEA 
     	--UNION ALL   
		If @IsFilesNameRequired =1
		Begin
			insert into #AttributeValueDefaultData( PimProductId ,	AttributeValue,	AttributeCode ,	PimAttributeId ,	AttributeDefaultValue , PimAttributeValueLocaleId,FilesName )  
			SELECT DISTINCT PimProductId,  
			SUBSTRING ((SELECT ','+MediaPath FROM #ZnodeMediaFileNameDetails ZM 
			WHERE ZM.MediaId = TBLAV.AttributeValue  FOR XML PATH (''), TYPE).value('.', 'varchar(Max)') ,2,4000)  ,
			AttributeCode,PimAttributeId,NULL AttributeDefaultValue , PimAttributeValueLocaleId,
			SUBSTRING ((SELECT ','+ZM.FileName FROM #ZnodeMediaFileNameDetails ZM WHERE ZM.MediaId = TBLAV.AttributeValue   
			FOR XML PATH (''), TYPE).value('.', 'varchar(Max)') ,2,4000)
			FROM #TBL_AttributeValue TBLAV   
			WHERE  LocaleId  = CASE WHEN RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
			AND TypeOfData = 3  
			and AttributeCode <>'ProductImage'
			-- GROUP BY PimAttributeId,PimProductId,AttributeCode  
			--Custom changes issues occured in fornt end code to include new stored procedure. Making change in base sp 
			--for immidiate requirment.
			--PCNA replace ProductImage by PrimaryImage attribute.
			Declare @PimProductImageAttributeId int 
			select @PimProductImageAttributeId  = PimAttributeId from ZnodePimAttribute where AttributeCode ='ProductImage'  and Iscategory =0 

			INSERT INTO #AttributeValueDefaultData(PimProductId,AttributeValue,AttributeCode,PimAttributeId,AttributeDefaultValue,PimAttributeValueLocaleId )  
			SELECT DISTINCT PimProductId,  
			Isnull(@url+'/' + isnull(TBLAV.AttributeValue ,''),'' )
			,'ProductImage' ,@PimProductImageAttributeId   , NULL AttributeDefaultValue , PimAttributeValueLocaleId
			FROM #TBL_AttributeValue TBLAV   
			WHERE  LocaleId  = CASE WHEN RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
			AND TBLAV.AttributeCode = 'PrimaryImage'

		End
		Else
		Begin
			insert into #AttributeValueDefaultData( PimProductId ,	AttributeValue,	AttributeCode ,	PimAttributeId ,	AttributeDefaultValue , PimAttributeValueLocaleId,FilesName )  
			SELECT DISTINCT PimProductId,  
			SUBSTRING ((SELECT ','+MediaPath FROM #ZnodeMediaFileNameDetails ZM 
			WHERE ZM.MediaId = TBLAV.AttributeValue  FOR XML PATH (''), TYPE).value('.', 'varchar(Max)') ,2,4000)  ,
			AttributeCode,PimAttributeId,NULL AttributeDefaultValue , PimAttributeValueLocaleId,
			NULL 
			FROM #TBL_AttributeValue TBLAV   
			WHERE  LocaleId  = CASE WHEN RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
			AND TypeOfData = 3  
			-- GROUP BY PimAttributeId,PimProductId,AttributeCode  
		End


		If @IsFilesNameRequired =1
		Begin
			select PimProductId,AttributeValue,AttributeCode,PimAttributeId,AttributeDefaultValue,FilesName
			from #AttributeValueDefaultData
			order by PimAttributeValueLocaleId  
		End
		Else
		Begin
			select PimProductId,AttributeValue,AttributeCode,PimAttributeId,AttributeDefaultValue
			from #AttributeValueDefaultData
			order by PimAttributeValueLocaleId
		End

   END TRY  
         BEGIN CATCH  
    
		SELECT ERROR_MESSAGE()  
		DECLARE @Status BIT ;  
		SET @Status = 0;  
   
         END CATCH;  
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOmsSavedCartLineItemCount')
	DROP PROC Znode_GetOmsSavedCartLineItemCount
GO

CREATE PROCEDURE [dbo].[Znode_GetOmsSavedCartLineItemCount]
( 
	@OmsCookieMappingId INT ,
	@UserId INT NULL ,
	@PortalId INT NULL
)
AS 
   /*  
    Summary : This procedure is used to get the count of OmsSavedCartLineItem	 	 
Unit Testing:

    EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId=83503
	Create Index IX_ZnodeOmsCookieMapping_UserId_PortalId on ZnodeOmsCookieMapping(UserId,PortalId)
       
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		Declare @QuantityOfOthersType Numeric(28,6) ,@QuantityOfBundles Numeric(28,6) ,@OmsSavedCartId int,
				@AddonRelationshipType int , @BundleRelationshipType int 


	    IF @OmsCookieMappingId = 0
		BEGIN
				IF isnull(@UserId,0) = 0
				BEGIN
					Select CAST(@QuantityOfOthersType AS varchar(10))
					Return
				End
			   Select TOP 1 @OmsCookieMappingId =   OmsCookieMappingId from ZnodeOmsCookieMapping WITH (NOLOCK) WHERE UserId = @UserId and PortalId = @PortalId 
		END

		IF Object_id('tempdb..#BundlesProductsQuantity') <>0 
		DROP TABLE #BundlesProductsQuantity

		IF Object_id('tempdb..#ZnodeOmsSavedCartLineItem') <>0 
		DROP TABLE #ZnodeOmsSavedCartLineItem


		Select @OmsSavedCartId = OmsSavedCartId from ZnodeOmsSavedCart  WITH (NOLOCK) WHERE OmsCookieMappingId =@OmsCookieMappingId
		Select @AddonRelationshipType = OrderLineItemRelationshipTypeId	 From ZnodeOmsOrderLineItemRelationshipType WITH (NOLOCK) Where Name = 'AddOns'
		Select @BundleRelationshipType = OrderLineItemRelationshipTypeId From ZnodeOmsOrderLineItemRelationshipType WITH (NOLOCK) Where Name = 'Bundles'
		Select Quantity, OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeId into #ZnodeOmsSavedCartLineItem
		from ZnodeOmsSavedCartLineItem  WITH (NOLOCK) where  OmsSavedCartId = @OmsSavedCartId  

		--Read quantity of all others type of products except Bundle type
		SELECT @QuantityOfOthersType  = Sum(ISNULL(Quantity,0)) FROM #ZnodeOmsSavedCartLineItem oscl WITH (NOLOCK)
        WHERE (ParentOmsSavedCartLineItemId IS NOT NULL AND OrderLineItemRelationshipTypeId not in  (@AddonRelationshipType ,@BundleRelationshipType) 
		AND OrderLineItemRelationshipTypeId IS NOT NUll)  

		--Read quantity of Bundle type from their parent Quantity only
		Select Distinct ParentOmsSavedCartLineItemId into #BundlesProductsQuantity FROM #ZnodeOmsSavedCartLineItem oscl WITH (NOLOCK) 
		where OrderLineItemRelationshipTypeId = @BundleRelationshipType
		If Exists (Select TOP 1 1 #BundlesProductsQuantity )
			SELECT @QuantityOfBundles = Sum(ISNULL(Quantity,0))   FROM #ZnodeOmsSavedCartLineItem oscl WITH (NOLOCK)
			Where Exists ( Select  TOP 1 1 From #BundlesProductsQuantity BPQ Where BPQ.ParentOmsSavedCartLineItemId = oscl.OmsSavedCartLineItemId ) 
			And (ParentOmsSavedCartLineItemId IS NULL AND OrderLineItemRelationshipTypeId IS NUll)  
		
		SET @QuantityOfOthersType = Isnull(@QuantityOfOthersType,0) + Isnull(@QuantityOfBundles,0)

		Select CAST(@QuantityOfOthersType AS varchar(15))

    END TRY
	BEGIN CATCH
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOmsSavedCartLineItemCount '+ISNULL(CAST(@OmsCookieMappingId AS VARCHAR(50)),'''');
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetOmsSavedCartLineItemCount',
		@ErrorInProcedure = 'Znode_GetOmsSavedCartLineItemCount',
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemBundle]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0
	,@OrderLineItemRelationshipTypeIdBundle INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
    --Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,BundleProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.BundleProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 

	CREATE TABLE #NewBundleSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data(bundle product)
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new bundle product save cart data
	INSERT INTO #NewBundleSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdBundle, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE BundleProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		
	--Getting new Bundle products save cart data if addon is present for any line item
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU

    CREATE TABLE #OldBundleSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old bundle save cart data if present for same SKU in the new save cart data for bundle product		 
	INSERT INTO #OldBundleSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.BundleProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle   

	--Getting the old save cart Parent data
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldBundleSavecartLineitemDetails

	DELETE a FROM #OldBundleSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldBundleSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old bundle product save cart addon data for old line items if present
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											WHERE a.ParentOmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a WHERE a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.BundleProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											WHERE a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldBundleSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldBundleSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldBundleSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 

			 DECLARE @parenTofAddon INT  = 0 
			 SET @parenTofAddon = (SELECT TOP 1 ParentOmsSavedCartLineItemId 
			 FROM #OldBundleSavecartLineitemDetails a
			 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  )

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId <> @parenTofAddon  AND ParentOmsSavedCartLineItemId IS NOT NULL  

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldBundleSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			  END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem   WHERE ParentOmsSavedCartLineItemId =@parenTofAddon AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) >= 1 
		 BEGIN 
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 END 
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldBundleSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldBundleSavecartLineitemDetails
		 END 

	END 
	
	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldBundleSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			   SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE n FROM #OldBundleSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldBundleSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldBundleSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU or a.SKU = b.sku)
			WHERE isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU )
			WHERE isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c WHERE b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)


		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldBundleSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c WHERE (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			LEFT JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldBundleSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
	
		--Delete parent entry if child not present
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldBundleSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldBundleSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c WHERE a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches	
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

		 --UPDATE Ab SET ab.Quantity = a.Quantity   
   --      FROM ZnodeOmsSavedCartLineItem a  
   --      INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
   --      INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		 --WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		 UPDATE Ab 
		 SET Ab.Quantity = Ab.Quantity+ty.Quantity,
		 Ab.Custom1 = ty.Custom1,
		 Ab.Custom2 = ty.Custom2,
		 Ab.Custom3 = ty.Custom3,
		 Ab.Custom4 = ty.Custom4,
		 Ab.Custom5 = ty.Custom5,
		 ab.ModifiedDate = @GetDate  
         FROM ZnodeOmsSavedCartLineItem a  
         INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
         INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  ) 
		 INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)  
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  
		 AND EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails ov WHERE a.OmsSavedCartLineItemId = ov.OmsSavedCartLineItemId)  

	END 
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
			
		UPDATE #NewBundleSavecartLineitemDetails
		SET ParentSKU = (SELECT TOP 1 SKU FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID IS NULL )
		WHERE OrderLineItemRelationshipTypeID  = @OrderLineItemRelationshipTypeIdAddon 
		AND EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) 
		
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewBundleSavecartLineitem   
		 FROM  #NewBundleSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
   
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE Quantity <=0  

		;WITH Add_Dup AS
		(
			SELECT  Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM  #InsertNewBundleSavecartLineitem
			GROUP BY SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID
			HAVING OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	
		)
		DELETE FROM #InsertNewBundleSavecartLineitem
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Add_Dup WHERE Add_Dup.NewRowId = #InsertNewBundleSavecartLineitem.NewRowId)
		AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		--Updating the rowid INTo new save cart line item AS new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewBundleSavecartLineitem m  
			INNER JOIN  #InsertNewBundleSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID IN ( @OrderLineItemRelationshipTypeIdAddon , @OrderLineItemRelationshipTypeIdBundle)   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewBundleSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
      
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID   
			FROM #InsertNewBundleSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewBundleSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData 
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL  
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
  
		--------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WHERE a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		-----------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewBuldleProduct
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = b.id OR b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = ISNULL(a.ParentOmsSavedCartLineItemId,0) OR ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  AND c.ParentOmsSavedCartLineItemId IS NULL

	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewBuldleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewBuldleProduct  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
  
		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewBundleSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE Ab SET ab.Quantity = a.Quantity,
			ab.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
		INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewBundleSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewBundleSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL
		and b.OmsSavedCartLineItemId = (select min(OmsSavedCartLineItemId) FROM @OmsInsertedData d WHERE b.OmsSavedCartLineItemId = d.OmsSavedCartLineItemId)
	 
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 
END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemConfigurable]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdConfigurable INT
	,@OrderLineItemRelationshipTypeIdAddon INT	
)
AS 
BEGIN 
BEGIN TRY 
 SET NOCOUNT ON 
	--Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT, OmsSavedCartId INT,SKU NVARCHAr(max),GroupId  NVARCHAr(max),ParentOmsSavedCartLineItemId INT,OrderLineItemRelationshipTypeId INT  ) 
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,ConfigurableProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.ConfigurableProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	 CREATE TABLE #NewConfigSavecartLineitemDetails 
	 (
		 GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(configurable product)
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new configurable product save cart data
	INSERT INTO #NewConfigSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdConfigurable, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE ConfigurableProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	--Getting new configurable products save cart data if addon is present for any line item
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 
		 SELECT * 
		INTO #ZnodeOmsSavedCartLineItem_NT
		FROM ZnodeOmsSavedCartLineItem a 
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId)

    CREATE TABLE #OldConfigSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old configurable save cart data if present for same SKU in the new save cart data for configurable product	 
	INSERT INTO #OldConfigSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM #ZnodeOmsSavedCartLineItem_NT a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.ConfigurableProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable   

	--Getting the old save cart Parent data
	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldConfigSavecartLineitemDetails
		  
	DELETE a FROM #OldConfigSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldConfigSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		
		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN
		
		
			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM #ZnodeOmsSavedCartLineItem_NT b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId AND OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null AND OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.ConfigurableProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

			

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b ON a.SKU = b.SKU AND a.AddOns = b.AddOns )
		BEGIN
			   
			DELETE FROM #OldConfigSavecartLineitemDetails 
	
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldConfigSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
			 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			 INSERT INTO  @parenTofAddon 
			 SELECT  ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails a  WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  #ZnodeOmsSavedCartLineItem_NT  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  

			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
					AND ParentOmsSavedCartLineItemId IS NOT NULL  
					AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #ZnodeOmsSavedCartLineItem_NT   WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM #ZnodeOmsSavedCartLineItem_NT a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
		    AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewConfigSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldConfigSavecartLineitemDetails 
		  END  
		 ELSE IF  EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItem_NT Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 

		END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present		
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		 DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		    DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
		    SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		    AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		    OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		    AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		 
		   DELETE n FROM #OldConfigSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldConfigSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldConfigSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails )
	BEGIN
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.ConfigurableProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldConfigSavecartLineitemDetails b1 ON a1.SKU = b1.SKU
		INNER JOIN #OldConfigSavecartLineitemDetails c1 ON (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId AND a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldConfigSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldConfigSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldConfigSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	 

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewConfigSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon
		 
		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S ON a.OmsSavedCartId = s.OmsSavedCartId AND a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END 
	
	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails )
	BEGIN

		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewConfigSavecartLineitem   
		 FROM  #NewConfigSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
       	    
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid INTo new save cart line item as new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewConfigSavecartLineitem m  
			INNER JOIN  #InsertNewConfigSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewConfigSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
           
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewConfigSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,	CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
        OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.OmsSavedCartId,inserted.SKU,inserted.GroupId,INSERTED.ParentOmsSavedCartLineItemId,INSERTED.OrderLineItemRelationshipTypeId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewConfigSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO   #Cte_newData
		FROM @OmsInsertedData a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			  
	
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )

	---------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData1 
		FROM @OmsInsertedData a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon     
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId AND 
		 a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null  ) 
 
	---------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId  )RowIdNo
		INTO #NewConfigProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) ON b.sku = c.sku AND b.OmsSavedCartId=c.OmsSavedCartId AND b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) AND c.ParentOmsSavedCartLineItemId is null
  
	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a with (nolock)
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewConfigSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewConfigProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewConfigProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewConfigSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewConfigSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		(  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  

		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b with (nolock) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId  AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
		
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;

	END




END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemGroup]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdGroup INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
	   
	DECLARE @OmsInsertedData TABLE (SKU varchar(600),OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,GroupProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.GroupProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	CREATE TABLE #NewGroupSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT ,OmsSavedCartLineItemId	INT,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	int
		,SKU	NVARCHAR(MAX) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	INT ,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT ,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT ,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(group product)
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new group product save cart data
	INSERT INTO #NewGroupSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdGroup, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE GroupProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		
	--Getting new group products save cart data if addon is present for any line item
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 

	CREATE TABLE #OldGroupSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old group save cart data if present for same SKU in the new save cart data for group product	 	 
	INSERT INTO #OldGroupSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.GroupProductIds,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup   

	--Getting the old save cart Parent data
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldGroupSavecartLineitemDetails

	DELETE a FROM #OldGroupSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldGroupSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old config product save cart addon data for old line items if present
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.GroupProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if not exists(select * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldGroupSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldGroupSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldGroupSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
			 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			 INSERT INTO  @parenTofAddon 
			 SELECT  ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails a
			 WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t with (nolock) WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  
			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
						AND ParentOmsSavedCartLineItemId IS NOT NULL  
						AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 

		  IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 
		 IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem with (nolock)  WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
		     AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		   AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
			BEGIN 
			   DELETE FROM #OldGroupSavecartLineitemDetails
			END  
	END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present	
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldGroupSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
		DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
		SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
			(SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails)  )
		BEGIN 
		 
		DELETE n FROM #OldGroupSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldGroupSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	END 
	
	IF EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
					INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
					where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
			a.PersonalizeCode
			,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
			where isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldGroupSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldGroupSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldGroupSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldGroupSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldGroupSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewGroupSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon


	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
	   
		SELECT RowId, Id ,Row_number()Over(ORDER BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewGroupSavecartLineitem   
		 FROM  #NewGroupSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
 
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewGroupSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewGroupSavecartLineitem m  
			INNER JOIN  #InsertNewGroupSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewGroupSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  

		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU, OrderLineItemRelationshipTypeId 
			FROM #InsertNewGroupSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeId
			HAVING SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewGroupSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.SKU,INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewGroupSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO  #Cte_newData
		FROM ZnodeOmsSavedCartLineItem a  with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
  
  -----------------------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #Cte_newData1
		FROM ZnodeOmsSavedCartLineItem a with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		 UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 


----------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(ORDER BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #Cte_newAddon
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) and c.ParentOmsSavedCartLineItemId is null

	   ;WITH table_update AS 
	   (
			 SELECT * , ROW_NUMBER()Over(ORDER BY OmsSavedCartLineItemId  ) RowIdNo
			 FROM ZnodeOmsSavedCartLineItem a with (nolock)
			 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND a.ParentOmsSavedCartLineItemId IS NULL  
			 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET  
			a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #Cte_newAddon  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId)  FROM #Cte_newAddon  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewGroupSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		  )   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewGroupSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(ORDER BY OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem with (nolock)  
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewGroupSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.GroupProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b WITH (NOLOCK) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL  
	
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 




END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemQuantity')
	DROP PROC Znode_InsertUpdateSaveCartLineItemQuantity
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemQuantity](
	  @CartLineItemXML xml, @UserId int,@Status bit OUT )
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
	BEGIN TRAN InsertUpdateSaveCartLineItem;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		DECLARE @AddOnQuantity numeric(28, 6)= 0;
		DECLARE @IsAddProduct   BIT = 0 
		DECLARE @OmsSavedCartLineItemId INT = 0
		DECLARE @TBL_SavecartLineitems TABLE
		( 
			RowId int , OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
			CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
			AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
			Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
			nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max)
		);

		DECLARE @OrderLineItemRelationshipTypeIdAddon int =
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'AddOns'
		);
		DECLARE @OrderLineItemRelationshipTypeIdSimple int =
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Simple'
		);
		DECLARE @OrderLineItemRelationshipTypeIdGroup int=
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Group'
		);
		DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Configurable'
		);
		 DECLARE @OrderLineItemRelationshipTypeIdBundle int=
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Bundles'
		);
		INSERT INTO @TBL_SavecartLineitems( RowId,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
		Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity )
			   SELECT DENSE_RANK()Over(Order BY Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' )) RowId ,Tbl.Col.value( 'OmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartLineItemId, Tbl.Col.value( 'ParentOmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsSavedCartLineItemId, Tbl.Col.value( 'OmsSavedCartId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
			   , Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ) AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			          Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
					  Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
					  Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
					  Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
					  Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
					  Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
					  Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
					  Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
					  Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
					  Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
					  Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity
			   FROM @CartLineItemXML.nodes( '//ArrayOfSavedCartLineItemModel/SavedCartLineItemModel' ) AS Tbl(Col);
			  

			  IF OBJECT_ID('tempdb..#TBL_SavecartLineitems') is not null
				drop table #TBL_SavecartLineitems

			 IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
				drop table #OldValueForAddon

			  SELECT * INTO #TBL_SavecartLineitems FROM @TBL_SavecartLineitems
			

			UPDATE ZnodeOmsSavedCart
			SET ModifiedDate = GETDATE()
			WHERE OmsSavedCartId = (SELECT TOP 1  OmsSavedCartId FROM @TBL_SavecartLineitems)
				

			  UPDATE  @TBL_SavecartLineitems
			  SET 	Description = ISNUll(Description,'') 

			IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
			 BEGIN 				
				 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 
				    SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
					, ModifiedDate = @GetDate
					WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 
					 
					--UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					AND SCLI.BundleProductIds <> ''

					DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
				 END 
				  DECLARE @TBL_bundleProduct TT_SavecartLineitems 
				  INSERT INTO @TBL_bundleProduct 
				  SELECT *  
				  FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(BundleProductIds,'') <> '' 
				
				  EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
				  DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
				  SET @OmsSavedCartLineItemId = 0 
				END 
			IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
			    BEGIN 				
				 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 

				   SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
				   	UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
					, ModifiedDate = @GetDate
					WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId
					
					--UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE  ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					AND SCLI.ConfigurableProductIds <> ''

					DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
				 END 
				  DECLARE @TBL_Configurable TT_SavecartLineitems 
				  INSERT INTO @TBL_Configurable 
				  SELECT *  
				  FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(ConfigurableProductIds,'') <> '' 

				  
				  EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
				  DELETE FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(ConfigurableProductIds,'') <> ''
				  SET @OmsSavedCartLineItemId = 0  
				END 
				IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
			    BEGIN 				
				 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 
				   SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				   	UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
					WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId
					
					--UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND  OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					AND SCLI.GroupProductIds <> ''

					DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
				 END 
				  DECLARE @TBL_Group TT_SavecartLineitems 
				  INSERT INTO @TBL_Group 
				  SELECT *  
				  FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(GroupProductIds,'') <> '' 

				
				  EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
				  
				  DELETE FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(GroupProductIds,'') <> ''
				  SET @OmsSavedCartLineItemId = 0  
				END 
				 
                IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 
				 
				   SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
				   	UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
					, ModifiedDate = @GetDate
					WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId
				
				 --   UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
					DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
				 END 
			 
			

			  DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
			  DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
			  INSERT INTO @TBL_Personalise
			  SELECT DISTINCT NULL 
							,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		  ,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					  ,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					  ,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			  FROM (SELECT TOP 1 PersonalisedAttribute Valuex FROM  @TBL_SavecartLineitems TRTR  ) a 
			  CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
			   ----To update saved cart item personalise value from given line item
			  DECLARE @TBL_Personalise1 TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
			  INSERT INTO @TBL_Personalise1
			  SELECT DISTINCT a.OmsSavedCartLineItemId 
					  ,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		  ,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					  ,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					  ,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			  FROM (SELECT TOP 1 OmsSavedCartLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SavecartLineitems TRTR ) a 
			  CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
			  CREATE TABLE #tempoi (GenId INT IDENTITY(1,1),RowId	int	,OmsSavedCartLineItemId	int	 ,ParentOmsSavedCartLineItemId	int,OmsSavedCartId	int
									,SKU	nvarchar(max) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	int	,CustomText	nvarchar(max)
									,CartAddOnDetails	nvarchar(max),Sequence	int	,AutoAddon	varchar(max)	,OmsOrderId	int	,ItemDetails	nvarchar(max)
									,Custom1	nvarchar(max)  ,Custom2	nvarchar(max),Custom3	nvarchar(max),Custom4	nvarchar(max),Custom5	nvarchar(max)
									,GroupId	nvarchar(max) ,ProductName	nvarchar(max),Description	nvarchar(max),Id	int,ParentSKU NVARCHAR(max))
				   
			   INSERT INTO #tempoi
			   SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
			   FROM @TBL_SavecartLineitems a 
			   GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			  
			   INSERT INTO #tempoi
			   SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
			   FROM @TBL_SavecartLineitems  a 
			   WHERE ISNULL(BundleProductIds,'') =  '' 
			   AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
			   	   GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity,  CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			  
     		   INSERT INTO #tempoi
			   SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
					,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
					,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
					WHEN  GroupProductIds <> '' THEN GroupProductIds 
					WHEN BundleProductIds <> '' THEN BundleProductIds 
					 ELSE SKU END     ParentSKU 
			   FROM @TBL_SavecartLineitems  a 
			   WHERE AddOnValueIds <> ''
			   	   GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
					,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
           --hack
		
		 CREATE TABLE #OldValue (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
		 
		INSERT INTO #OldValue  
		SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	  	FROM ZnodeOmsSavedCartLineItem a   
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
        AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

			

		INSERT INTO #OldValue 
		SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValue c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
		AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
		DELETE a FROM #OldValue a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldValue b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
		------Merge Addon for same product
		SELECT * INTO #OldValueForAddon from #OldValue
		
		INSERT INTO #OldValue 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValue c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		
		
		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

			SELECT distinct SKU, STUFF(
										( SELECT  ', ' + SKU FROM    
											( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											  where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											  FOR XML PATH('')
										), 1, 2, ''
									 ) AddOns
			INTO #AddOnsExists
			from #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

			SELECT distinct a.SKU, STUFF(
										 ( SELECT  ', ' + x.AddOnValueIds FROM    
											( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
											  where a.SKU=b.SKU ) x
											  FOR XML PATH('')
										 ), 1, 2, ''
									   ) AddOns
			INTO #AddOnAdded
			from @TBL_SavecartLineitems a

			if not exists(select * from #AddOnsExists a inner join #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
			begin
				delete from #OldValue
			end

		END

		IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldValue a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		
		DELETE FROM #OldValue 
		END 
		ELSE 
		BEGIN 
	    
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
		 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
		 INSERT INTO  @parenTofAddon 
		 SELECT  ParentOmsSavedCartLineItemId FROM #OldValue WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

		 DELETE FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
					AND ParentOmsSavedCartLineItemId IS NOT NULL  
					AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

		 DELETE FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldValue m)
		 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 

		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldValue WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldValue WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldValue m)
		 AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldValue ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 

		   DELETE FROM #OldValue
		 END 
		END 
			
	

		DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
		INSERT INTO @TBL_Personaloldvalues
		SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
		FROM ZnodeOmsPersonalizeCartItem  a 
		WHERE EXISTS (SELECT TOP 1 1 FROM #OldValue TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
		

		IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		   AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
		BEGIN 
		 DELETE FROM #OldValue
		END 
		ELSE 
		BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		   
		   DELETE FROM #OldValue WHERE OmsSavedCartLineItemId IN (
		   SELECT OmsSavedCartLineItemId FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		   
		
		   
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		   
		   

		   DELETE n FROM #OldValue n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		   
		  
		   
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldValue YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldValue WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 


		  
		END 

		----delete old value from table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;with cte as
		(
			select distinct b.*
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute as varchar(max)),'') = ''
		)
		,cte2 as
		(
			select c.ParentOmsSavedCartLineItemId
			from #OldValue a
			inner join ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			inner join ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		)
		delete a from #OldValue a
		inner join cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		inner join cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----delete old value from table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;with cte as
		(
			select distinct b.*, 
			Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on ( a.SKU = b.sku)
			CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
			where isnull(cast(a.PersonalisedAttribute as varchar(max)),'') <> ''
		)
		,cte2 as
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			from #OldValue a
			inner join ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			where not exists(select * from cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
			                 and b.PersonalizeValue = c.PersonalizeValue )
		)
		delete a from #OldValue a
		inner join cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		inner join cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;with cte as
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU as SKU
					,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on a.SKU = b.SKU
			CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
			Inner join ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		delete b1
		from #OldValue b1 
		where not exists(select * from cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
	    and exists(select * from cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;with cte as
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
					,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on a.SKU = b.SKU
			CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
			Inner join ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		delete b1
		from cte a1		  
		Inner Join #OldValue b1 on a1.sku = b1.SKU
		where not exists(select * from ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		IF EXISTS (SELECT TOP 1 1 FROM #OldValue )
		BEGIN 

		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldValue b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #tempoi ty ON (ty.SKU = b.SKU)


		END 
		ELSE 
		BEGIN 
		
		
			   
    SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
     INTO #yuuete   
     FROM  #tempoi  
     GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails ,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
     ORDER BY RowId, Id   
       	
			     
    DELETE FROM #yuuete WHERE Quantity <=0  
  
     ;WITH VTTY AS   
    (  
    SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
       FROM #yuuete m  
    INNER JOIN  #yuuete TY1 ON TY1.SKU = m.ParentSKU   
    WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
    )   
	
    UPDATE m1   
    SET m1.RowId = TYU.RowId  
    FROM #yuuete m1   
    INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
    ;WITH VTRET AS   
    (  
    SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
    FROM #yuuete   
    GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
	Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
    )   
    
    DELETE FROM #yuuete WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  
	
	

	
     
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #yuuete  TH  

 
	 --;with Cte_newData AS   
  --  (  
    SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
	, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
	INTO #Cte_newData
    FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
    WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
	--	AND NOT EXISTS (SELECT TOP 1 1 FROM #OldValue TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #yuuete TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
     GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID
				
    --)   
	
  
    UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
    WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
    FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
    WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
    AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
    AND a.ParentOmsSavedCartLineItemId IS nULL   
  

    
    --;with Cte_newAddon AS   
    --(  
    SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
    INTO #Cte_newAddon
	FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
	INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
    WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
    AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null
  --  )   
  


  --  SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
	 --FROM ZnodeOmsSavedCartLineItem a
	 --WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
  --   AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
  --   AND a.ParentOmsSavedCartLineItemId IS NULL  
	 --AND EXISTS (SELECT TOP 1 1  FROM  #yuuete ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
	 --AND EXISTS (SELECT TOP 1 1 FROM #Cte_newAddon TI WHERE TI.SKU = a.SKU)



   ;with table_update AS 
   (
     SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
	 FROM ZnodeOmsSavedCartLineItem a
	 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
     AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
     AND a.ParentOmsSavedCartLineItemId IS NULL  
	 AND EXISTS (SELECT TOP 1 1  FROM  #yuuete ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
	 AND EXISTS (SELECT TOP 1 1 FROM #Cte_newAddon TI WHERE TI.SKU = a.SKU)
   )

    UPDATE a SET  
   --SELECT  a.OmsSavedCartLineItemId,
	a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
	FROM #Cte_newAddon  r  
    WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
    FROM table_update a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
    WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
	  FROM #Cte_newAddon  r  
    WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 

	
	  
    ;with Cte_Th AS   
    (             
      SELECT RowId    
     FROM #yuuete a   
     GROUP BY RowId   
     HAVING COUNT(NewRowId) <= 1   
      )   
    UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
    FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
    WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
     AND a.OrderLineItemRelationshipTypeId IS NULL   
  
    UPDATE  ZnodeOmsSavedCartLineItem   
    SET GROUPID = NULL   
    WHERE  EXISTS (SELECT TOP 1 1  FROM #yuuete RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
    AND OrderLineItemRelationshipTypeId IS NOT NULL     
       ;With Cte_UpdateSequence AS   
     (  
       SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
       FROM ZnodeOmsSavedCartLineItem   
       WHERE EXISTS (SELECT TOP 1 1 FROM #yuuete TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
     )   
    UPDATE Cte_UpdateSequence  
    SET  Sequence = RowId  
	
	----To update saved cart item personalise value from given line item	
	if exists(select * from @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
	Begin
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise1 SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	end		
	
	UPDATE @TBL_Personalise
	SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
	FROM @OmsInsertedData a 
	INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
	WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
	DELETE FROM ZnodeOmsPersonalizeCartItem 
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
    MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
	USING @TBL_Personalise SOURCE
		   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
	WHEN NOT MATCHED THEN 
		    INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
			VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
END 

	
	SET @Status = 1;
	COMMIT TRAN InsertUpdateSaveCartLineItem;
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()	
		SET @Status = 0;
		DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
 AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@Status='+CAST(@Status AS varchar(10));

		SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
		ROLLBACK TRAN InsertUpdateSaveCartLineItem;
		EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItem', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper')
	DROP PROC Znode_InsertUpdateSaveCartLineItemQuantityWrapper
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemQuantityWrapper]
(
	@CartLineItemXML xml, 
	@UserId int,
	@PortalId Int,
	@OmsCookieMappingId INT = 0 
)
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
BEGIN TRAN InsertUpdateSaveCartLineItem;
BEGIN TRY
SET NOCOUNT ON;
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate();
	DECLARE @AddOnQuantity numeric(28, 6)= 0;
	DECLARE @IsAddProduct   BIT = 0 
	DECLARE @OmsSavedCartLineItemId INT = 0
	
	DECLARE @TBL_SavecartLineitems TABLE
	( 
		RowId int IDENTITY(1,1), OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
		CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
		AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
		Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
		nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max)
	);

	--Set the OrderLineItemRelationshipTypeId for Addons product
	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);
	--Set the OrderLineItemRelationshipTypeId for simple product
	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);
	--Set the OrderLineItemRelationshipTypeId for group product
	DECLARE @OrderLineItemRelationshipTypeIdGroup int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);
	--Set the OrderLineItemRelationshipTypeId for Configurable product
	DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);
	--Set the OrderLineItemRelationshipTypeId for Bundles product	
	DECLARE @OrderLineItemRelationshipTypeIdBundle int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	-----Getting OmsSaveCartId FROM @OmsCookieMappingId
	DECLARE @OmsSavedCartId int
	--Getting OmsCookieMappingId on basis of @UserId and portalid if @UserId > 0 (Not a guest User)
	IF isnull(@OmsCookieMappingId,0)=0 and isnull(@UserId,0) <> 0  
	Begin
		SET @OmsCookieMappingId = (SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) where isnull(UserId,0) = @UserID AND isnull(PortalId,0) = @PortalId)
	END

	IF Not Exists(SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) Where OmsCookieMappingId = @OmsCookieMappingId)
	Begin
		INSERT INTO ZnodeOmsCookieMapping (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT case when @UserId = 0 then null else @UserId end ,@PortalId,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsCookieMappingId = @@IDENTITY
	End
	----To get the oms savecartid on basis of @OmsCookieMappingId 
	SET @OmsSavedCartId = (SELECT top 1 OmsSavedCartId FROM ZnodeOmsSavedCart with (nolock) where OmsCookieMappingId = @OmsCookieMappingId)
	
	----If omssavecartid not present in ZnodeOmsSavedCart table then inserting new record to generated omssavecartid 
	IF isnull(@OmsSavedCartId,0) = 0
	BEGIN
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @OmsCookieMappingId,Null,Null,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsSavedCartId = @@IDENTITY
	END

	--Fetching data FROM xml to table format and inserted into table @TBL_SavecartLineitems
	INSERT INTO @TBL_SavecartLineitems( OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
	Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity )
	SELECT Tbl.Col.value( 'OmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartLineItemId, Tbl.Col.value( 'ParentOmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsSavedCartLineItemId, @OmsSavedCartId AS OmsSavedCartId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
	, Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ) AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
			Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
			Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
			Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
			Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
			Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
			Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
			Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
			Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
			Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
			Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity
	FROM @CartLineItemXML.nodes( '//ArrayOfSavedCartLineItemModel/SavedCartLineItemModel' ) AS Tbl(Col);
			  
	IF OBJECT_ID('tempdb..#TBL_SavecartLineitems') is not null
		DROP TABLE #TBL_SavecartLineitems

	IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
		DROP TABLE #OldValueForAddon

	SELECT * INTO #TBL_SavecartLineitems FROM @TBL_SavecartLineitems
			
	UPDATE ZnodeOmsSavedCart
	SET ModifiedDate = GETDATE()
	WHERE OmsSavedCartId = (SELECT TOP 1  OmsSavedCartId FROM @TBL_SavecartLineitems)

	UPDATE  @TBL_SavecartLineitems
	SET 	Description = ISNUll(Description,'') 

	--Save cart execution code for bundle product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
			, ModifiedDate = @GetDate
			WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
			OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.BundleProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 

		--Getting bundle save cart line item entries into table to pass for bundle prodcut sp
		DECLARE @TBL_bundleProduct TT_SavecartLineitems 
		INSERT INTO @TBL_bundleProduct 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(BundleProductIds,'') <> '' 
				
		EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
		DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
		SET @OmsSavedCartLineItemId = 0 
	END 
	--Save cart execution code for configurable product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 

			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			, ModifiedDate = @GetDate
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.ConfigurableProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for configurable prodcut sp
		DECLARE @TBL_Configurable TT_SavecartLineitems 
		INSERT INTO @TBL_Configurable 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> '' 
		  
		EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
		DELETE FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	--Save cart execution code for group product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			--Updating the existing save cart for group product
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.GroupProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for group prodcut sp
		DECLARE @TBL_Group TT_SavecartLineitems 
		INSERT INTO @TBL_Group 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(GroupProductIds,'') <> '' 
		
		EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
		
		--After update the existing cart with new save cart then deleting those records which are updated
		DELETE FROM @TBL_SavecartLineitems WHERE ISNULL(GroupProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	
	--This part is for updating the cart for existing line items for simple product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
	BEGIN 
				 
		SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
		, ModifiedDate = @GetDate
		WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
		INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
		WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
		DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
	END 
	--Save cart execution code for Simple product
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
	--Inserting the personalise data into variable table @TBL_Personalise for inserting the personalise data for new products
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId int,SKU Varchar(600) ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.SKU
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM @TBL_SavecartLineitems a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise1 TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise1
	SELECT DISTINCT a.OmsSavedCartLineItemId 
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM (SELECT TOP 1 OmsSavedCartLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SavecartLineitems TRTR ) a 
	CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
	CREATE TABLE #NewSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	int	,AutoAddon	varchar(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @TBL_SavecartLineitems a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	
	--Getting new simple product save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE ISNULL(BundleProductIds,'') =  '' 
	AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity,  CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			
	--Getting new Group,Bundle and Configurable products save cart data if addon is present for any line item
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
		WHEN  GroupProductIds <> '' THEN GroupProductIds 
		WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	CREATE TABLE #OldSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old save cart data if present for same SKU in the new save cart data for simple product	 
	INSERT INTO #OldSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

	--Getting the old save cart Parent data 
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
	DELETE a FROM #OldSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldSavecartLineitemDetails
		
	--Getting the old save cart addon data for old line items if present
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN

		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b with (nolock)
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @TBL_SavecartLineitems a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldSavecartLineitemDetails
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
	    
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		 
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 

			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  

		END
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 

			DELETE FROM #OldSavecartLineitemDetails
		END 
	END 

	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)

	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		      
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 

			DELETE n FROM #OldSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	   
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	  
	END 

	--If already exists cart 
	IF EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*
			FROM @TBL_SavecartLineitems a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			SELECT c.ParentOmsSavedCartLineItemId
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where a.PersonalizeValue <> ''
		)
		,cte2 AS
		(
			SELECT a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
						and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU AS SKU
				,a.PersonalizeCode
				,a.PersonalizeValue
				,a.DesignId
				,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b ON a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewSavecartLineitemDetails  b ON a.SKU = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0 AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
						,d.PersonalizeCode
				,d.PersonalizeValue
				,d.DesignId
				,d.ThumbnailURL
				FROM @TBL_SavecartLineitems a 
				INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
				INNER JOIN @TBL_Personalise d on d.SKU = a.SKU
				INNER JOIN ZnodeOmsPersonalizeCartItem  c  with (nolock)  on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
				WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM cte a1		  
		INNER JOIN #OldSavecartLineitemDetails b1 on a1.sku = b1.SKU
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches 
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewSavecartLineitemDetails ty ON (ty.SKU = b.SKU)

	END 
	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN 
	    --Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewSavecartLineitem   
		FROM  #NewSavecartLineitemDetails  
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id   
       	
		--Removing the line item having Quantity <=0	     
		DELETE FROM #InsertNewSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			FROM #InsertNewSavecartLineitem m  
			INNER JOIN  #InsertNewSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
		)   
		DELETE FROM #InsertNewSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  

		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewSimpleProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null

		--Updating ParentOmsSavedCartLineItemId for newly added save cart line item
		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS NULL  
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1 FROM #NewSimpleProduct TI WHERE TI.SKU = a.SKU)
		)
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     

		;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
	
		----To update saved cart item personalise value FROM given line item	
		IF EXISTS(SELECT * FROM @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
		BEGIN
			DELETE FROM ZnodeOmsPersonalizeCartItem 
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

			MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
			USING @TBL_Personalise1 SOURCE
			ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			WHEN NOT MATCHED THEN 
			INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
			VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
		END		
	
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
		ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
		INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
	END 

	Declare @OutputTable Table (CartCount numeric(28,6))

	INSERT INTO @OutputTable
	EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId = @OmsCookieMappingId,@UserId=@UserId,@PortalId=@UserId
	

	SELECT CAST(1 AS bit) AS Status,@OmsSavedCartId AS SavedCartId,@OmsCookieMappingId AS CookieMappingId,CartCount
	FROM @OutputTable

COMMIT TRAN InsertUpdateSaveCartLineItem;
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
	AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@PortalId='+CAST(@PortalId AS varchar(10))+',@OmsCookieMappingId='+CAST(@OmsCookieMappingId AS varchar(10));

	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	ROLLBACK TRAN InsertUpdateSaveCartLineItem;
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemBundle]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0
	,@OrderLineItemRelationshipTypeIdBundle INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
    --Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,BundleProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.BundleProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 

	CREATE TABLE #NewBundleSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data(bundle product)
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new bundle product save cart data
	INSERT INTO #NewBundleSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdBundle, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE BundleProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		
	--Getting new Bundle products save cart data if addon is present for any line item
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU

    CREATE TABLE #OldBundleSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old bundle save cart data if present for same SKU in the new save cart data for bundle product		 
	INSERT INTO #OldBundleSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.BundleProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle   

	--Getting the old save cart Parent data
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldBundleSavecartLineitemDetails

	DELETE a FROM #OldBundleSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldBundleSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old bundle product save cart addon data for old line items if present
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											WHERE a.ParentOmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a WHERE a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.BundleProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											WHERE a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldBundleSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldBundleSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldBundleSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 

			 DECLARE @parenTofAddon INT  = 0 
			 SET @parenTofAddon = (SELECT TOP 1 ParentOmsSavedCartLineItemId 
			 FROM #OldBundleSavecartLineitemDetails a
			 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  )

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId <> @parenTofAddon  AND ParentOmsSavedCartLineItemId IS NOT NULL  

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldBundleSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			  END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem   WHERE ParentOmsSavedCartLineItemId =@parenTofAddon AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) >= 1 
		 BEGIN 
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 END 
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldBundleSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldBundleSavecartLineitemDetails
		 END 

	END 
	
	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldBundleSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			   SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE n FROM #OldBundleSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldBundleSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldBundleSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU or a.SKU = b.sku)
			WHERE isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU )
			WHERE isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c WHERE b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)


		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldBundleSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c WHERE (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			LEFT JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldBundleSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
	
		--Delete parent entry if child not present
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldBundleSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldBundleSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c WHERE a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches	
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

		 --UPDATE Ab SET ab.Quantity = a.Quantity   
   --      FROM ZnodeOmsSavedCartLineItem a  
   --      INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
   --      INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		 --WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		 UPDATE Ab 
		 SET Ab.Quantity = Ab.Quantity+ty.Quantity,
		 Ab.Custom1 = ty.Custom1,
		 Ab.Custom2 = ty.Custom2,
		 Ab.Custom3 = ty.Custom3,
		 Ab.Custom4 = ty.Custom4,
		 Ab.Custom5 = ty.Custom5,
		 ab.ModifiedDate = @GetDate  
         FROM ZnodeOmsSavedCartLineItem a  
         INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
         INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  ) 
		 INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)  
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  
		 AND EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails ov WHERE a.OmsSavedCartLineItemId = ov.OmsSavedCartLineItemId)  

	END 
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
			
		UPDATE #NewBundleSavecartLineitemDetails
		SET ParentSKU = (SELECT TOP 1 SKU FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID IS NULL )
		WHERE OrderLineItemRelationshipTypeID  = @OrderLineItemRelationshipTypeIdAddon 
		AND EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) 
		
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewBundleSavecartLineitem   
		 FROM  #NewBundleSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
   
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE Quantity <=0  

		;WITH Add_Dup AS
		(
			SELECT  Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM  #InsertNewBundleSavecartLineitem
			GROUP BY SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID
			HAVING OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	
		)
		DELETE FROM #InsertNewBundleSavecartLineitem
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Add_Dup WHERE Add_Dup.NewRowId = #InsertNewBundleSavecartLineitem.NewRowId)
		AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		--Updating the rowid INTo new save cart line item AS new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewBundleSavecartLineitem m  
			INNER JOIN  #InsertNewBundleSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID IN ( @OrderLineItemRelationshipTypeIdAddon , @OrderLineItemRelationshipTypeIdBundle)   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewBundleSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
      
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID   
			FROM #InsertNewBundleSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewBundleSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData 
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL  
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
  
		--------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WHERE a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		-----------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewBuldleProduct
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = b.id OR b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = ISNULL(a.ParentOmsSavedCartLineItemId,0) OR ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  AND c.ParentOmsSavedCartLineItemId IS NULL
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId)  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewBuldleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewBuldleProduct  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
  
		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewBundleSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE Ab SET ab.Quantity = a.Quantity,
			ab.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
		INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewBundleSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewBundleSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL
		and b.OmsSavedCartLineItemId = (select min(OmsSavedCartLineItemId) FROM @OmsInsertedData d WHERE b.OmsSavedCartLineItemId = d.OmsSavedCartLineItemId)
	 
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 
END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

update ZnodeApplicationSetting 
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>PromotionId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>PromoCode</name><headertext>Promotion Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl>/Promotion/Edit</islinkactionurl><islinkparamfield>promotionId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Name</name><headertext>Promotion Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Promotion/Edit</islinkactionurl><islinkparamfield>promotionId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Discount</name><headertext>Discount</headertext><width>40</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PromotionTypeName</name><headertext>Discount Type</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>StoreName</name><headertext>Store Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>QuantityMinimum</name><headertext>Minimum Quantity</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>OrderMinimum</name><headertext>Minimum Order</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>DisplayOrder</name><headertext>Display Order</headertext><width>40</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>StartDate</name><headertext>Start Date</headertext><width>50</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>EndDate</name><headertext>End Date</headertext><width>50</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Delete|View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>shippingId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete|View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Promotion/Edit|/Promotion/Delete</manageactionurl><manageparamfield>promotionId|promotionId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>grid-action</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>' 
where ItemName='ZnodePromotion'

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeCMSContainerConfiguration')
BEGIN
	CREATE TABLE [dbo].[ZnodeCMSContainerConfiguration] (
    [CMSContainerConfigurationId] INT        IDENTITY (1, 1) NOT NULL,
    [CMSWidgetsId]                  INT            NOT NULL,
    [WidgetKey]                    nvarchar(50)  NOT NULL,
    [CMSMappingId]                 INT            NOT NULL,
    [TypeOFMapping]                NVARCHAR (50)  NOT NULL,
    [ContentContainerId]           int            NULL,
    [ContainerKey]                 nvarchar(100)  NULL,
    [CreatedBy]                   INT            NOT NULL,
    [CreatedDate]                  DATETIME       NOT NULL,
    [ModifiedBy]                   INT            NOT NULL,
    [ModifiedDate]                 DATETIME       NOT NULL,
    CONSTRAINT [PK_ZnodeCMSContainerConfiguration] PRIMARY KEY CLUSTERED ([CMSContainerConfigurationId] ASC),
    CONSTRAINT [FK_ZnodeCMSContainerConfiguration_ZnodeCMSWidgets] FOREIGN KEY ([CMSWidgetsId]) REFERENCES [dbo].[ZnodeCMSWidgets] ([CMSWidgetsId])
	);	
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodePublishContainerWidgetEntity')
BEGIN
	CREATE TABLE [dbo].[ZnodePublishContainerWidgetEntity] (
    [PublishContainerWidgetEntity] INT            IDENTITY (1, 1) NOT NULL,
    [VersionId]                 INT            NOT NULL,
    [PublishStartTime]          DATETIME       NULL,
    [ContainerConfigurationId] INT            NOT NULL,
    [MappingId]                 INT            NOT NULL,
    [PortalId]                  INT            NOT NULL,
    [TypeOFMapping]             VARCHAR (50)   NOT NULL,
    [LocaleId]                  INT            NOT NULL,
    [WidgetsKey]                VARCHAR (50)   NULL,
    [ContainerKey]              NVARCHAR (100) NULL,
    CONSTRAINT [PK_ZnodePublishContainerWidgetEntity] PRIMARY KEY CLUSTERED ([PublishContainerWidgetEntity] ASC) WITH (FILLFACTOR = 90)
	);
END

IF NOT EXISTS(SELECT * FROM sys.indexes WHERE name = 'Ind_ZnodePublishTextWidgetEntityVersionId' AND object_id = OBJECT_ID('ZnodePublishContainerWidgetEntity'))
BEGIN
	CREATE NONCLUSTERED INDEX [Ind_ZnodePublishTextWidgetEntityVersionId]
    ON [dbo].[ZnodePublishContainerWidgetEntity]([VersionId] ASC);
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishContentPageEntity')
	DROP PROC Znode_PublishContentPageEntity
GO


CREATE PROCEDURE [dbo].[Znode_PublishContentPageEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@CMSContentPagesId int = 0
  ,@UserId int = 0
  ,@Status Bit =0 OUTPUT 

)
AS

/*
  To publish all Contenet pages and their mapping into their respective entities 
	ZnodePublishContentPageConfigEntity
	ZnodePublishSEOEntity
	ZnodePublishWidgetProductEntity
	ZnodePublishMediaWidgetEntity
	ZnodePublishSearchWidgetEntity
	ZnodePublishTextWidgetEntity
	ZnodePublishWidgetSliderBannerEntity
	ZnodePublishWidgetTitleEntity

	Unit Testing : 
	Exec [dbo].[Znode_PublishContentPageEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'Preview&Production' 
	,@CMSContentPagesId = 0
	,@UserId = 2
  
	declare @p8 int
	set @p8=NULL
		exec sp_executesql N'ZnodePublishContentPageEntity @PortalId,@LocaleId,@RevisionState,
		@CMSContentPagesId,@UserId,@Status OUT',N'@UserId int,@PortalId int,@LocaleId int,
		@RevisionState nvarchar(10),@CMSContentPagesId int,@Status int output',
		@UserId=2,@PortalId=1,@LocaleId=0,@RevisionState=N'PRODUCTION',@CMSContentPagesId=72,@Status=@p8 output
	select @p8


*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300);
	SET @Status = 1 
	Declare @IsPreviewEnable int,
	@PreviewVersionId INT = 0  ,@ProductionVersionId INT = 0

 	If Exists (SELECT  * from ZnodePublishStateApplicationTypeMapping PSA where PSA.IsEnabled =1 and  
	Exists (select TOP 1 1  from ZnodePublishState PS where PS.PublishStateId = PSA.PublishStateId ) and ApplicationType =  'WebstorePreview')
		SET @IsPreviewEnable = 1 
	else 
		SET @IsPreviewEnable = 0 

   If @PreviewVersionId = 0 
		-- select TOP 1 @PreviewVersionId =   PublishPortalLogId from ZnodePublishPortalLog where 
		--PortalId = @PortalId AND  PublishStateId  = [dbo].[Fn_GetPublishStateIdForPreview]() Order by 1 DESC   
		SELECT TOP 1 @PreviewVersionId =  VersionId  from  ZnodePublishWebStoreEntity where PortalId =  @PortalId and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PREVIEW'
   If @ProductionVersionId = 0 
		--select TOP 1  @ProductionVersionId =   PublishPortalLogId  from ZnodePublishPortalLog where 
		--PortalId = @PortalId AND PublishStateId  = [dbo].[Fn_GetPublishStateIdForPublish] () Order by 1 DESC  
		SELECT TOP 1 @ProductionVersionId =  VersionId  from  ZnodePublishWebStoreEntity where PortalId =  @PortalId and  (LocaleId = 	@LocaleId OR @LocaleId = 0  ) and PublishState ='PRODUCTION'
	
	Truncate table ZnodePublishErrorLogEntity 
	


	IF (@IsPreviewEnable = 1 AND @PreviewVersionId = 0 ) OR @ProductionVersionId =0 
	Begin
		SET @Status =0 
		SELECT 1 AS ID,@Status AS Status;  
		INSERT INTO ZnodePublishErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishWebStoreEntity', @RevisionState, 'Faild : WebStore version not found' , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			Return 0 
	End
	
	Begin Transaction 
	if @Type = 'ZnodePublishContentPageConfigEntity' OR @Type = ''
	Begin
		 EXEC [dbo].[Znode_SetPublishContentPageConfigEntity]
			 @PortalId  = @PortalId 
			,@LocaleId   = @LocaleId 
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@CMSContentPagesId = @CMSContentPagesId
			,@UserId = @UserId	
			,@Status = @Status Output 

			If @Status = 0 
				Rollback Transaction 
				 
			INSERT INTO ZnodePublishErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishContentPageConfigEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			If @Status = 0 
				Begin
					update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
					update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where 
					SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
					Return  0  
				End

	End
	
	if @Type = 'ZnodePublishSEOEntity' OR @Type = ''
	Begin
		
			SELECT @CMSSEOCode  = PageName  from ZnodeCMSContentPages where @CMSContentPagesId = CMSContentPagesId and  
			(PortalId = @PortalId OR @PortalId  =0 ) 
			
			SET @CMSSEOCode  = Isnull( @CMSSEOCode  , '') 
			
			Exec [Znode_SetPublishSEOEntity]
			 @PortalId  = @PortalId
			,@LocaleId  = @LocaleId 
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@CMSSEOTypeId = '3'
			,@CMSSEOCode = @CMSSEOCode  
			,@UserId = @UserId  
			,@Status = @Status Output 
			
			If @Status = 0 
				Rollback Transaction 
				
			INSERT INTO ZnodePublishErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			If @Status = 0 
				Begin
					update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
					update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where 
					SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
					Return  0  
				End


	End 

	if @Type = 'ZnodePublishWidgetProductEntity' OR @Type = ''
	Begin
			EXEC Znode_SetPublishWidgetProductEntity
			 @PortalId  = @PortalId
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@CMSMappingId = @CMSContentPagesId
			,@UserId = @UserId 
			,@Status = @Status  Output
			
			If @Status  = 0 
				Rollback Transaction 
			INSERT INTO ZnodePublishErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishWidgetProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			If @Status = 0 
				Begin
					update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
					update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where 
					SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
					Return  0  
				End
	END 
	
	if @Type = 'ZnodeSetPublishMediaWidgetEntity' OR @Type = ''
	Begin
			EXEC Znode_SetPublishMediaWidgetEntity
			 @PortalId  = @PortalId
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@CMSMappingId = @CMSContentPagesId
			,@UserId = @UserId 
			,@Status = @Status  Output
			
			If @Status = 0 
				Rollback Transaction 
			INSERT INTO ZnodePublishErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishMediaWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			If @Status = 0 
				Begin
					update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
					update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where 
					SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
					Return  0  
				End

	END 

	if @Type = 'ZnodePublishSearchWidgetEntity' OR @Type = ''
	Begin
			EXEC Znode_SetPublishSearchWidgetEntity
			 @PortalId  = @PortalId
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@CMSMappingId = @CMSContentPagesId
			,@UserId = @UserId 
			,@Status = @Status  Output
			
			If @Status = 0 
				Rollback Transaction 
			INSERT INTO ZnodePublishErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishSearchWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			If @Status = 0 
				Begin
					update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
					update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where 
					SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
					Return  0  
				End
	END 
	
	if @Type = 'ZnodePublishTextWidgetEntity' OR @Type = ''
	Begin
			EXEC Znode_SetPublishTextWidgetEntity
			 @PortalId  = @PortalId
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@CMSMappingId = @CMSContentPagesId
			,@UserId = @UserId 
			,@Status = @Status  Output
			
			If @Status = 0 
				Rollback Transaction 
			INSERT INTO ZnodePublishErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishTextWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			If @Status = 0 
				Begin
					update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
					update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where 
					SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
					Return  0  
				End

	END 
	if @Type = 'ZnodeSetPublishWidgetSliderBannerEntity' OR @Type = ''
	Begin
			EXEC Znode_SetPublishWidgetSliderBannerEntity
			 @PortalId  = @PortalId
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@CMSContentPagesId = @CMSContentPagesId
			,@UserId = @UserId 
			,@Status = @Status  Output
			
			If @Status = 0 
				Rollback Transaction 
			INSERT INTO ZnodePublishErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishWidgetSliderBannerEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			If @Status = 0 
				Begin
					update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
					update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where 
					SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
					Return  0  
				End
	END 
	if @Type = 'ZnodeSetPublishWidgetTitleEntity' OR @Type = ''
	Begin
			EXEC Znode_SetPublishWidgetTitleEntity
			 @PortalId  = @PortalId
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@CMSContentPagesId = @CMSContentPagesId
			,@UserId = @UserId 
			,@Status = @Status  Output
			
			If @Status =0 
				Rollback Transaction
			INSERT INTO ZnodePublishErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishWidgetTitleEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			If @Status = 0 
				Begin
					update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
					update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where 
					SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
					Return  0  
				End

	END 

	if (@Type = 'ZnodePublishContainerWidgetEntity' OR @Type = '' ) AND @Status = 1  
			Begin
					EXEC Znode_SetPublishContainerWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = @CMSContentPagesId
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					If @Status =0 
				        Rollback Transaction
				INSERT INTO ZnodePublishErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishWidgetTitleEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			If @Status = 0 
				Begin
					update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
					update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublishFailed() where 
					SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
					Return  0  
				End	

			END

	IF Exists (select TOP 1 1  from ZnodePublishErrorLogEntity where  ProcessStatus <> 'Fail') 
		Begin
			If @RevisionState = 'PREVIEW'
			Begin
				update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPreview() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
				update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPreview() where 
				SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
			End 
			Else 
			Begin
				update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
				update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where 
				SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
			End
	    	SET @Status = 1
		End
		SELECT 1 AS ID,@Status AS Status;   
		Commit Transaction 
END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	
	Rollback Transaction 

	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishContentPageEntity 
		@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
		+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
		+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
		+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
		+''',@CMSContentPagesId= ' + CAST(@CMSContentPagesId  AS varchar(20))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
			
	INSERT INTO ZnodePublishErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'ZnodePublishContentPageEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

		                			 
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishContentPageEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PublishPortalEntity')
	DROP PROC Znode_PublishPortalEntity
GO

CREATE   PROCEDURE [dbo].[Znode_PublishPortalEntity]
(
   @PortalId  INT = 0 
  ,@LocaleId  INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@UserId int = 0
  ,@Status Bit =0 OUTPUT 
  ,@IsContentType Bit= 1
  ,@NewGUID nvarchar(500)  
)
AS
/*
  To publish all Contenet pages and their mapping into their respective entities 
	ZnodePublishContentPageConfigEntity
	ZnodePublishSEOEntity
	ZnodePublishWidgetProductEntity
	ZnodePublishMediaWidgetEntity
	ZnodePublishSearchWidgetEntity
	ZnodePublishTextWidgetEntity
	ZnodePublishWidgetSliderBannerEntity
	ZnodePublishWidgetTitleEntity

	Unit Testing : 
	Declare @Status bit 
	

	Declare @Status bit 
	Exec [dbo].[Znode_PublishPortalEntity]
     @PortalId  = 1 
	,@LocaleId  = 0 
	,@RevisionState = 'PRODUCTION' 
	,@UserId = 2
	,@Status = @Status 
	--Select @Status 


*/
BEGIN
BEGIN TRY 
SET NOCOUNT ON
	Declare @PortalCode Varchar(100)
	Declare @Type varchar(50) = '',	@CMSSEOCode varchar(300),@UserName Varchar(50);
	SET @Status = 1 
	Declare @IsPreviewEnable int,@PreviewVersionId INT = 0  ,@ProductionVersionId INT = 0
	
	Select TOP 1  @UserName = aspNetZnodeUser.UserName from ZnodeUser Inner Join aspNetUsers ON ZnodeUser.aspNetUserId = aspNetUsers.Id 
	Inner Join aspNetZnodeUser on aspNetUsers.UserName = aspNetZnodeUser.AspNetZnodeUserId
	where ZnodeUser.UserId = @userId
            


 		If Exists (SELECT  * from ZnodePublishStateApplicationTypeMapping PSA where PSA.IsEnabled =1 and  
		Exists (select TOP 1 1  from ZnodePublishState PS where PS.PublishStateId = PSA.PublishStateId ) and ApplicationType =  'WebstorePreview')
			SET @IsPreviewEnable = 1 
		else 
			SET @IsPreviewEnable = 0 

		--Genrate preview entry 
		DECLARE @SetLocaleId INT , @DefaultLocaleId INT = dbo.Fn_GetDefaultLocaleId(), @MaxCount INT =0 , @IncrementalId INT = 1  
		DECLARE @TBL_Locale TABLE (LocaleId INT , RowId INT IDENTITY(1,1))
		
		DECLARE @TBL_StoreEntity TABLE 
		(
			 PortalThemeId	int,PortalId	int,ThemeId	int,ThemeName	varchar(200),CSSId	int,CSSName	nvarchar(2000),
			 WebsiteLogo	varchar(300),WebsiteTitle	nvarchar(400),FaviconImage	varchar(300),WebsiteDescription	nvarchar(MAX),
			 PublishState	varchar(100),LocaleId	int	
		)
		
		IF object_id('tempdb..[#Tbl_VersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_VersionEntity
		Create Table #Tbl_VersionEntity(PortalId int , VersionId int , LocaleId int , PublishType varchar(50) )

		IF object_id('tempdb..[#Tbl_OldVersionEntity]') IS NOT NULL
			drop table tempdb..#Tbl_OldVersionEntity
		Create Table #Tbl_OldVersionEntity(PortalId int , NewVersionId int ,OldVersionId int , LocaleId int , PublishType varchar(50) )

	
		DECLARE @WebStoreEntityId int 
		
		select @PortalCode  = StoreName  from ZnodePortal where PortalId = @PortalId 
		
		INSERT INTO @TBL_Locale (LocaleId) SELECT LocaleId FROM ZnodeLocale WHERE IsActive =1 AND (LocaleId  = @LocaleId OR @LocaleId = 0 )
		
		---managed brand seo data
		delete ZCSDL from ZnodeCMSSEODetailLocale ZCSDL
		where exists(select *  from ZnodeCMSSEODetail ZCSD1
		where not exists(select * from ZnodeBrandDetails ZBD
		inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId and ZCSD1.PortalId = ZPB.PortalId
		and ZBD.BrandCode = ZCSD1.SEOCode) and ZCSDL.CMSSEODetailId = ZCSD1.CMSSEODetailId
		and ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand'))


		delete ZCSD1 from ZnodeCMSSEODetail ZCSD1
		where not exists(select * from ZnodeBrandDetails ZBD
		inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId and ZCSD1.PortalId = ZPB.PortalId
		and ZBD.BrandCode = ZCSD1.SEOCode)
		and ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')

		insert into ZnodeCMSSEODetail(CMSSEOTypeId,SEOId,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		,IsPublish,SEOCode,PublishStateId)
		select distinct (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand'),null,null,null,ZPB.PortalId,isnull(ZBDL.SEOFriendlyPageName,ZBD.BrandCode),@userId,
		getdate(),@userId,getdate(),null,ZBD.BrandCode,3
		from ZnodeBrandDetails ZBD
		inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
		inner join ZnodeBrandDetailLocale ZBDL on ZBD.BrandId = ZBDL.BrandId
		where not exists(select * from ZnodeCMSSEODetail ZCSD1 where ZCSD1.CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')
		and ZCSD1.PortalId = ZPB.PortalId
		and ZBD.BrandCode = ZCSD1.SEOCode) and ZPB.PortalId = @PortalId

		insert into ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)
		select distinct ZCSD.CMSSEODetailId,L.LocaleId,ZBDL.BrandName,ZBDL.BrandName,ZBDL.BrandName,@userId,getdate(),@userId,getdate(),null,null
		from ZnodeCMSSEODetail ZCSD
		inner join ZnodeBrandDetails ZBD on ZCSD.SEOCode = ZBD.BrandCode
		inner join ZnodeBrandDetailLocale ZBDL on ZBD.BrandId = ZBDL.BrandId
		inner join ZnodePortalBrand ZPB ON ZBD.BrandId = ZPB.BrandId
		cross apply @TBL_Locale L
		where CMSSEOTypeId = (select top 1 CMSSEOTypeId from ZnodeCMSSEOType where Name = 'Brand')
		and not exists(select * from ZnodeCMSSEODetailLocale ZCSDL where ZCSDL.CMSSEODetailId = ZCSD.CMSSEODetailId)
		 ---managed brand seo data
		
		SET @MaxCount = ISNULL((SELECT MAx(RowId) FROM @TBL_Locale),0)
		WHILE @IncrementalId <= @MaxCount
		BEGIN 
			SET @SetLocaleId = (SELECT Top 1 LocaleId FROM @TBL_locale WHERE RowId = @IncrementalId)
			if (@IsPreviewEnable = 1 AND ( @RevisionState like '%Preview%'  OR @RevisionState like '%Production%' ) ) 
			Begin
				Insert into ZnodePublishPortalLog
				(PortalId,IsPortalPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,PublishStateId)
				Select @PortalId ,1 , @UserId , Getdate(),@UserId ,Getdate() ,@UserId ,Getdate(), NULL, DBO.Fn_GetPublishStateIdForProcessing()
				
				insert into #Tbl_VersionEntity (PortalId,VersionId,LocaleId,PublishType)
				select @PortalId, @@Identity , @SetLocaleId ,'PREVIEW'
				
			End
			If (@RevisionState like '%Production%' OR @RevisionState = 'None')
			Begin
				--Genrate production entry 
				Insert into ZnodePublishPortalLog
				(PortalId,IsPortalPublished,UserId,LogDateTime,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Token,PublishStateId)
				Select @PortalId ,1 , @UserId , Getdate(),@UserId ,Getdate() ,@UserId ,Getdate(), NULL, DBO.Fn_GetPublishStateIdForProcessing()
			
				insert into #Tbl_VersionEntity (PortalId,VersionId,LocaleId,PublishType)
				select @PortalId, @@Identity , @SetLocaleId ,'PRODUCTION'
			End 
	   	SET @IncrementalId = @IncrementalId +1 
		END 

	Truncate table ZnodePublishPortalErrorLogEntity

	Declare @IsFirstTimeContentPublish bit 
	If Exists (Select TOP 1 1  from ZnodePublishWebStoreEntity where PortalId = @PortalId)
		SET @IsFirstTimeContentPublish =1 
	else 
		SET @IsFirstTimeContentPublish =0
    
	Declare @Tbl_PreviewVersionId  TABLE (VersionId int , PortalId int , LocaleId int )
	Declare @Tbl_ProductionVersionId  TABLE (VersionId int , PortalId int , LocaleId int )

	If @IsContentType = 0 AND @IsFirstTimeContentPublish =1 
	Begin 
		Insert into #Tbl_OldVersionEntity (PortalId,NewVersionId,OldVersionId, LocaleId, PublishType)
		Select A.PortalId , A.VersionId, B.VersionId, a.LocaleId,a.PublishType from #Tbl_VersionEntity A Inner join ZnodePublishWebStoreEntity B on 
		A.PortalId = B.PortalId and A.LocaleId = B.LocaleId AND A.PublishType= B.PublishState  
	End
	Delete from ZnodePublishProgressNotifierEntity where JobName  = @PortalCode 
	
	INSERT INTO ZnodePublishProgressNotifierEntity
	(VersionId,JobId,JobName,ProgressMark,IsCompleted,IsFailed,ExceptionMessage,StartedBy,StartedByFriendlyName)
	Values(0,@NewGUID , Isnull(@PortalCode,'') + ' Store' , 0 , 0 , 0 , '' , @UserId, @UserName)

	if @Type = 'ZnodePublishWebStoreEntity' OR @Type = ''
	Begin
		 Declare  @PreviewVersionIdString varchar(1000)= ''  ,@ProductionVersionIdString varchar(1000) = '' 
		 SELECT   @PreviewVersionIdString = STUFF((SELECT ',' + cast (VersionId as varchar(50))  FROM #Tbl_VersionEntity   where PublishType = 'PREVIEW'  FOR XML PATH ('')), 1, 1, '') 
		 SELECT   @ProductionVersionIdString = STUFF((SELECT ',' + cast (VersionId as varchar(50))  FROM #Tbl_VersionEntity   where PublishType = 'PRODUCTION'  FOR XML PATH ('')), 1, 1, '') 
		 
		 EXEC [dbo].[Znode_SetPublishWebStoreEntity]
			 @PortalId  = @PortalId 
			,@LocaleId   = @LocaleId 
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = @PreviewVersionIdString 
			,@ProductionVersionId = @ProductionVersionIdString 
			,@RevisionState = @RevisionState 
			,@UserId = @UserId	
			,@Status = @Status Output 

			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishWebStoreEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark =5 , 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
	End
	
	if (@Type = 'ZnodePublishPortalBrandEntity' OR @Type = '' ) AND @Status = 1 
	Begin
			Exec [Znode_SetPublishPortalBrandEntity]
			 @PortalId  = @PortalId
			,@IsPreviewEnable =@IsPreviewEnable 
			,@PreviewVersionId  = 0 
			,@ProductionVersionId = 0
			,@RevisionState = @RevisionState 
			,@UserId = @UserId  
			,@Status = @Status Output 

			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishPortalBrandEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			
			Update ZnodePublishProgressNotifierEntity SET 
			ProgressMark = CASE When (@IsContentType = 1 OR (@IsFirstTimeContentPublish = 0 AND @IsContentType = 0 ) ) THEN 10 Else 100 End , 
			IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
			IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
			where  JobId = @NewGUID
	End 

	if (@Type = 'ZnodePublishSEOEntity' OR @Type = '') AND @Status = 1 and (@IsContentType = 0 or @PortalId > 0)
			Begin
					Exec [Znode_SetPublishSEOEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@CMSSEOTypeId = '4'
					,@CMSSEOCode = ''
					,@UserId = @UserId  
					,@Status = @Status Output 

			End 
	If (@IsContentType = 1 OR (@IsFirstTimeContentPublish = 0 AND @IsContentType = 0 ) ) AND @Status = 1  
	Begin
			if @Type = 'ZnodePublishBlogNewsEntity' OR @Type = '' 
			Begin
				 EXEC [dbo].[Znode_SetPublishBlogNewsEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishBlogNewsEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 15 , 
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID

			End
			if (@Type = 'ZnodePublishPortalCustomCssEntity' OR @Type = '' ) AND @Status = 1  
			Begin
				 EXEC [dbo].[Znode_SetPublishPortalCustomCssEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishPortalCustomCssEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 20  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID


			End
			if (@Type = 'ZnodePublishWidgetCategoryEntity' OR @Type = '' ) AND @Status = 1 
			Begin
				 EXEC [dbo].[Znode_SetPublishWidgetCategoryEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetCategoryEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 25  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID
			End
	
			if (@Type = 'ZnodePublishWidgetProductEntity' OR @Type = '') AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetProductEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetProductEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 30  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID
			END 

			if (@Type = 'ZnodePublishWidgetTitleEntity' OR @Type = '') AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetTitleEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetTitleEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 35  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID

			END 
			if (@Type = 'ZnodePublishWidgetSliderBannerEntity' OR @Type = '')AND @Status = 1  
			Begin
					EXEC Znode_SetPublishWidgetSliderBannerEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@CMSSliderId = 0 
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetSliderBannerEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 40  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 
			if (@Type = 'ZnodePublishTextWidgetEntity' OR @Type = '' ) AND @Status = 1  
			Begin
					EXEC Znode_SetPublishTextWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishTextWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 45  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			END 
			if (@Type = 'ZnodeSetPublishMediaWidgetEntity' OR @Type = '') AND @Status = 1
			Begin
					EXEC Znode_SetPublishMediaWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishMediaWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
										
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 50  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 
			if (@Type = 'ZnodePublishSearchWidgetEntity' OR @Type = '') AND @Status = 1
			Begin
					EXEC Znode_SetPublishSearchWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishSearchWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 55  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			END 

			if (@Type = 'ZnodePublishContentPageConfigEntity' OR @Type = '') AND @Status = 1
			Begin
				 EXEC [dbo].[Znode_SetPublishContentPageConfigEntity]
					 @PortalId  = @PortalId 
					,@LocaleId   = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSContentPagesId = 0
					,@UserId = @UserId	
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishContentPageConfigEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 60,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			
			End

			if (@Type = 'ZnodePublishSEOEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishSEOEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@CMSSEOTypeId = '3,5'
					,@CMSSEOCode = ''
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishSEOEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 60,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 
			if (@Type = 'ZnodePublishMessageEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishMessageEntity]
					 @PortalId  = @PortalId
					,@LocaleId  = @LocaleId 
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishMessageEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 65,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 

		   if (@Type = 'ZnodePublishPortalGlobalAttributeEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishPortalGlobalAttributeEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishPortalGlobalAttributeEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
					
					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 67,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 
 
		   if (@Type = 'ZnodePublishProductPageEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishProductPageEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishProductPageEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 73,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			


			End 
			
			if (@Type = 'ZnodePublishWidgetBrandEntity' OR @Type = '') AND @Status = 1
			Begin
					Exec [Znode_SetPublishWidgetBrandEntity]
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = 0 
					,@ProductionVersionId = 0
					,@RevisionState = @RevisionState 
					,@UserId = @UserId  
					,@Status = @Status Output 

					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishWidgetBrandEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 80,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			End 

			if (@Type = 'ZnodePublishContainerWidgetEntity' OR @Type = '' ) AND @Status = 1  
			Begin
					EXEC Znode_SetPublishContainerWidgetEntity
					 @PortalId  = @PortalId
					,@IsPreviewEnable =@IsPreviewEnable 
					,@PreviewVersionId  = @PreviewVersionId 
					,@ProductionVersionId = @ProductionVersionId 
					,@RevisionState = @RevisionState 
					,@CMSMappingId = 0
					,@UserId = @UserId 
					,@Status = @Status  Output
			
					INSERT INTO ZnodePublishPortalErrorLogEntity
					(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
					SELECT 'ZnodePublishContainerWidgetEntity', @RevisionState, Case when Isnull(@Status,0) = 0 then 'Fail' Else 'Success' end , Getdate(), 
					@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

					Update ZnodePublishProgressNotifierEntity SET 
					ProgressMark = 90  ,
					IsCompleted  = Case when Isnull(@Status,0) = 0 then 1  Else 0 end,
					IsFailed =Case when Isnull(@Status,0) = 0 then 1  Else 0 end  
					where  JobId = @NewGUID			

			END 

	End
		IF Exists (select TOP 1 1  from ZnodePublishPortalErrorLogEntity where  ProcessStatus = 'Fail') 
		Begin
			SET @Status  =0 
			SELECT 1 AS ID,@Status AS Status;
			INSERT INTO ZnodePublishPortalErrorLogEntity
			(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
			SELECT 'ZnodePublishPortalEntity', @RevisionState , 'Fail' , Getdate(), 
			@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed()  where  PublishPortalLogId in  (Select VersionId from #Tbl_VersionEntity Where PublishType = 'PREVIEW' )
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublishFailed()  where  PublishPortalLogId in (Select VersionId from #Tbl_VersionEntity Where PublishType = 'PRODUCTION' )

			Delete  From ZnodePublishWebStoreEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
			Delete  From ZnodePublishBlogNewsEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetProductEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetTitleEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishTextWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishMediaWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishSearchWidgetEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishContentPageConfigEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishSEOEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId and CMSSEOTypeId in (3,5)
			Delete  From ZnodePublishMessageEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishPortalBrandEntity Where  VersionId  in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishProductPageEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
			Delete  From ZnodePublishWidgetBrandEntity Where  VersionId in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
		End
	Else 
		Begin
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPreview()  where  PublishPortalLogId in 
			(Select VersionId from #Tbl_VersionEntity Where PublishType = 'PREVIEW' )
			Update ZnodePublishPortalLog SET PublishStateId = DBO.Fn_GetPublishStateIdForPublish()  where  PublishPortalLogId in
			(Select VersionId from #Tbl_VersionEntity Where PublishType = 'PRODUCTION' )
			 
			Insert into ZnodePublishPreviewLogEntity
			(VersionId,PublishStartTime,IsDisposed,SourcePublishState,EntityId,EntityType,LogMessage,LogCreatedDate,PreviousVersionId,LocaleId,LocaleDisplayValue)
				Select A.VersionId,NULL,NULL,A.PublishType,@PortalId,'portal','portal has been published successfully' , Getdate(),  
				(select TOP 1 VersionId   from ZnodePublishWebStoreEntity where LocaleId = A.LocaleId AND PublishState = A.PublishType
				 and PortalId = @PortalId),A.LocaleId,B.Name
				from #Tbl_VersionEntity  A  Inner join ZnodeLocale B on A.LocaleId = B.LocaleId

			If @RevisionState = 'PREVIEW'
			Begin
				update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPreview() where (PortalId = @PortalId OR @PortalId  =0 ) 
				update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPreview() where 
				(PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
			End 
			Else 
			Begin
				update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where (PortalId = @PortalId OR @PortalId  =0 ) 
				update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where 
				(PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
			End
			
			if (@IsContentType =1  OR (@IsContentType = 0 AND @IsFirstTimeContentPublish =0))
			Begin
				If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
				Begin
					Delete  From ZnodePublishWebStoreEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishBlogNewsEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetProductEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetTitleEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishTextWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishMediaWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishSearchWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishContentPageConfigEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishSEOEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId) And CMSSEOTypeId in (3,5) 
					Delete  From ZnodePublishMessageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishProductPageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				End
				If (@RevisionState like '%Production%' OR @RevisionState = 'None')
				Begin
					Delete  From ZnodePublishWebStoreEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishBlogNewsEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalCustomCssEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetCategoryEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetProductEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetTitleEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetSliderBannerEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishTextWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishMediaWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishSearchWidgetEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishContentPageConfigEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishSEOEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId) And CMSSEOTypeId in (3,5) 
					Delete  From ZnodePublishMessageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalGlobalAttributeEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishProductPageEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					Delete  From ZnodePublishWidgetBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
				End
			End
			Else 
			Begin
				
				If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%'  ) 
				Begin
					Delete  From ZnodePublishWebStoreEntity           Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishBlogNewsEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalCustomCssEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetCategoryEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetProductEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetTitleEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetSliderBannerEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishTextWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMediaWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSearchWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId =6)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishContentPageConfigEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSEOEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
					And CMSSEOTypeId in (3,5) 

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMessageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalGlobalAttributeEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishProductPageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetBrandEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PRODUCTION' AND PortalId = @PortalId)
				End
				If (@RevisionState like '%Production%' OR @RevisionState = 'None')
				Begin
					Delete  From ZnodePublishWebStoreEntity           Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Delete  From ZnodePublishPortalBrandEntity Where  VersionId not in (Select VersionId from #Tbl_VersionEntity) AND PortalId = @PortalId 
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
				
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishBlogNewsEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalCustomCssEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					
					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetCategoryEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetProductEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetTitleEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetSliderBannerEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishTextWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMediaWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSearchWidgetEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishContentPageConfigEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishSEOEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
					And CMSSEOTypeId in (3,5)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishMessageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishPortalGlobalAttributeEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishProductPageEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)

					Update BA SET BA.VersionId = OV.NewVersionId from 
					ZnodePublishWidgetBrandEntity BA Inner join #Tbl_OldVersionEntity  OV on BA.VersionId = Ov.OldVersionId  AND BA.PortalId =Ov.PortalId  
					AND VersionId NOT IN (select VersionId  from ZnodePublishWebStoreEntity where PublishState = 'PREVIEW' AND PortalId = @PortalId)
				End 
			End

			--update ZnodeCMSContentPages SET  IsPublished = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where @CMSContentPagesId = CMSContentPagesId and  (PortalId = @PortalId OR @PortalId  =0 ) 
			--update ZnodeCMSSEODEtail SET  IsPublish = 1 , PublishStateId  = DBO.Fn_GetPublishStateIdForPublish() where 
			--SEOCode = @CMSSEOCode and  (PortalId = @PortalId OR @PortalId  =0 )  AND CMSSEOTypeId = 3 
		 SET @Status = 1
		End
	SELECT 1 AS ID,@Status AS Status;   

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   

	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PublishPortalEntity 
		@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
		+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
		+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
		+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
	
			
	INSERT INTO ZnodePublishPortalErrorLogEntity
	(EntityName,ErrorDescription,ProcessStatus,CreatedDate,CreatedBy,VersionId)
	SELECT 'ZnodePublishPortalEntity', @RevisionState + isnull(@ErrorMessage,'') , 'Fail' , Getdate(), 
	@UserId , Convert( varchar(100), @PreviewVersionId) + '/' + Convert( varchar(100), @ProductionVersionId) 

		                			 
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_PublishPortalEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_SetPublishContainerWidgetEntity')
	DROP PROC Znode_SetPublishContainerWidgetEntity
GO


CREATE  PROCEDURE [dbo].[Znode_SetPublishContainerWidgetEntity]
(
   @PortalId  INT = 0 
  ,@PreviewVersionId INT = 0 
  ,@IsPreviewEnable int = 0 
  ,@ProductionVersionId INT = 0 
  ,@RevisionState varchar(50) = '' 
  ,@CMSMappingId INT =0
  ,@UserId int = 0 
  ,@Status int = 0 Output
)
AS
BEGIN 
BEGIN TRY 
SET NOCOUNT ON
   Begin 
	    DECLARE @Tbl_PreviewVersionId    TABLE    (PreviewVersionId int , PortalId int , LocaleId int)
		DECLARE @Tbl_ProductionVersionId TABLE    (ProductionVersionId int  , PortalId int , LocaleId int)

		If @PreviewVersionId = 0 
			Begin
   				Insert into @Tbl_PreviewVersionId 
				SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and PublishState ='PREVIEW'
			end
		Else 
			Begin
				Insert into @Tbl_PreviewVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
				where VersionId = @PreviewVersionId
			End
		If @ProductionVersionId = 0 
   			Begin
				Insert into @Tbl_ProductionVersionId 
				SELECT distinct VersionId , PortalId , LocaleId from  ZnodePublishWebStoreEntity where (PortalId = @PortalId or @PortalId=0 ) and PublishState ='PRODUCTION'
			End 
		Else 
			Begin
				Insert into @Tbl_ProductionVersionId SELECT distinct VersionId , PortalId, LocaleId from  ZnodePublishWebStoreEntity 
			    where VersionId = @ProductionVersionId
			End	
 

		DECLARE @CMSWidgetDataFinal TABLE (CMSContainerConfigurationId INT ,CMSWidgetsId INT ,WidgetsKey  NVARCHAR(256) ,CMSMappingId  INT ,TypeOFMapping NVARCHAR(100) , ContentContainerId INT, ContainerKey  NVARCHAR(100));
		if @CMSMappingId > 0 
			Begin
				INSERT INTO @CMSWidgetDataFinal
					(CMSContainerConfigurationId, CMSWidgetsId, WidgetsKey, CMSMappingId, TypeOFMapping, ContentContainerId, ContainerKey)
                     SELECT CMSContainerConfigurationId , CMSWidgetsId , WidgetKey , CMSMappingId , TypeOFMapping , ContentContainerId, a.ContainerKey
				     FROM ZnodeCMSContainerConfiguration AS a
					 inner join ZnodeCMSContentContainer ZCC on a.ContainerKey = ZCC.ContainerKey
                     WHERE (a.TypeOFMapping = 'ContentPageMapping'
                     AND ( EXISTS ( SELECT TOP 1 1 FROM ZnodeCMSContentPages  WHERE IsActive =1 and  a.CMSMappingId = CMSContentPagesId AND PortalId = @PortalId  )))
					 AND (a.CMSMappingId = @CMSMappingId OR @CMSMappingId = 0  )
			End
		Else if @CMSMappingId = 0 
			Begin
				 INSERT INTO @CMSWidgetDataFinal
					(CMSContainerConfigurationId, CMSWidgetsId, WidgetsKey, CMSMappingId, TypeOFMapping, ContentContainerId, ContainerKey)
                     SELECT CMSContainerConfigurationId , CMSWidgetsId , WidgetKey , CMSMappingId , TypeOFMapping , ContentContainerId, a.ContainerKey
				     FROM ZnodeCMSContainerConfiguration AS a
					 inner join ZnodeCMSContentContainer ZCC on a.ContainerKey = ZCC.ContainerKey
                     WHERE (a.TypeOFMapping = 'ContentPageMapping'
                     AND ( EXISTS ( SELECT TOP 1 1 FROM ZnodeCMSContentPages  WHERE IsActive =1 and  a.CMSMappingId = CMSContentPagesId AND PortalId = @PortalId  ))
                     OR (a.TypeOFMapping = 'PortalMapping' AND a.CMSMappingId = @PortalId ))
			End
		End 
    --select * from @TBL_ContentPage 
	If @IsPreviewEnable = 1 AND (@RevisionState like '%Preview%'  OR @RevisionState like '%Production%' )
	Begin
	    --Data inserted into flat table ZnodePublishMediaWidgetEntity (Replica of MongoDB Collection )  
		Delete from ZnodePublishContainerWidgetEntity where PortalId = @PortalId  and VersionId in (Select PreviewVersionId from  @TBL_PreviewVersionId ) and
		(MappingId = @CMSMappingId OR @CMSMappingId = 0 )

		Insert Into ZnodePublishContainerWidgetEntity 
		(VersionId,PublishStartTime,ContainerConfigurationId,MappingId,PortalId,TypeOFMapping,LocaleId,WidgetsKey,ContainerKey)
		SELECT PreviewVersionId , Getdate() ,CMSContainerConfigurationId,CMSMappingId,@PortalId,TypeOFMapping,LocaleId,WidgetsKey,ContainerKey
		FROM @CMSWidgetDataFinal A Inner join @TBL_PreviewVersionId B On B.PortalId = @PortalId
	End
	-------------------------- End Preview 
	If (@RevisionState like '%Production%' OR @RevisionState = 'None')
	Begin
			-- Only production version id will process 
		Delete from ZnodePublishContainerWidgetEntity where PortalId = @PortalId  and VersionId in (Select ProductionVersionId from  @TBL_ProductionVersionId) and 
		(MappingId = @CMSMappingId OR @CMSMappingId = 0 )
		
		Insert Into ZnodePublishContainerWidgetEntity 
		(VersionId,PublishStartTime,ContainerConfigurationId,MappingId,PortalId,TypeOFMapping,LocaleId,WidgetsKey,ContainerKey)
		SELECT ProductionVersionId , Getdate() ,CMSContainerConfigurationId,CMSMappingId,@PortalId,TypeOFMapping,LocaleId,WidgetsKey,ContainerKey
		FROM @CMSWidgetDataFinal Inner join @TBL_ProductionVersionId B On B.PortalId = @PortalId
	End
	SET @Status = 1;

END TRY 
BEGIN CATCH 
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_SetPublishContainerWidgetEntity 
		@PortalId = '+CAST(@PortalId AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
		+',@PreviewVersionId = ' + CAST(@PreviewVersionId  AS varchar(20))
		+',@ProductionVersionId = ' + CAST(@ProductionVersionId  AS varchar(20))
		+',@RevisionState = ''' + CAST(@RevisionState  AS varchar(50))
		+''',@CMSMappingId= ' + CAST(@CMSMappingId  AS varchar(20))
		+',@UserId = ' + CAST(@UserId AS varchar(20));	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		                			 
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_SetPublishContainerWidgetEntity',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

END CATCH
END

GO

insert into ZnodeApplicationSetting (GroupName,	ItemName,	Setting,	ViewOptions,	FrontPageName,	FrontObjectName,	IsCompressed,	OrderByFields,	ItemNameWithoutCurrency,	CreatedByName,	ModifiedByName,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
select 'Table','ZnodeCMSContainerWidget','<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>ContentContainerId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>ContainerKey</name><headertext>Container Key</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Name</name><headertext>Container Name</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Tags</name><headertext>Tags</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>',
'ZnodeCMSContainerWidget','ZnodeCMSContainerWidget','ZnodeCMSContainerWidget',0,null,null,null,null,2,GETDATE(),2,getdate()
where not exists(select * from ZnodeApplicationSetting where GroupName = 'Table' and ItemName = 'ZnodeCMSContainerWidget')

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ContentContainerId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>ContainerKey</name>      <headertext>Container Key</headertext>      <width>60</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Name</name>      <headertext>Container Name</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Tags</name>      <headertext>Tags</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PublishStatus</name>      <headertext>Publish Status</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='ZnodeCMSContainerWidget'

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'WebSite','ManageCMSContentContainerWidget',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'ManageCMSContentContainerWidget')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'ManageCMSContentContainerWidget') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'ManageCMSContentContainerWidget'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'ManageCMSContentContainerWidget')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'ManageCMSContentContainerWidget'))
								
INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'WebSite','SaveContainerDetails',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'SaveContainerDetails')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'SaveContainerDetails') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'SaveContainerDetails'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'SaveContainerDetails')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'SaveContainerDetails'))

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'WebSite','RemoveWidgetDataFromContentPage',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'RemoveWidgetDataFromContentPage')

INSERT INTO ZnodeActionMenu ( MenuId,	ActionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience')	
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'RemoveWidgetDataFromContentPage') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'RemoveWidgetDataFromContentPage'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,	ActionId, AccessPermissionId,	CreatedBy ,CreatedDate,	ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'RemoveWidgetDataFromContentPage')	
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Store Experience' AND ControllerName = 'StoreExperience') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'WebSite' and ActionName = 'RemoveWidgetDataFromContentPage'))

GO

insert into [ZnodeCMSWidgets] ([Code],[DisplayName],[IsConfigurable],[FileName],[CreatedBy],[CreatedDate],[ModifiedBy],[ModifiedDate])
select 'ContentContainer','Content Container',1,'Text_Editor.png',2,GETDATE(),2,GETDATE()
where not exists(select * from [ZnodeCMSWidgets] where [Code] = 'ContentContainer')

GO

UPDATE ZnodeMenu
SET MenuName='Commerce Connector'
WHERE MenuId=(SELECT MenuId FROM ZnodeMenu WHERE MenuName = 'Extension Engine');

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCMSContainerlist')
	DROP PROC Znode_GetCMSContainerlist
GO

CREATE PROCEDURE [dbo].[Znode_GetCMSContainerlist]   
(    
  @WhereClause NVARCHAR(Max)       
 ,@Rows INT = 100       
 ,@PageNo INT = 1       
 ,@Order_BY VARCHAR(1000) = ''    
 ,@RowsCount INT OUT    
)    
AS    
--EXEC Znode_GetCMSContainerlist @WhereClause = '',@RowsCount=0
BEGIN      
BEGIN TRY     
SET NOCOUNT ON        
	DECLARE @SQL NVARCHAR(MAX)    
	DECLARE @TBL_ContentContainer TABLE (ContentContainerId INT,ContainerKey NVARCHAR(max),Name nvarchar(max),Tags NVARCHAR(max),PublishStatus VARCHAR(32),CreatedByName NVARCHAR(600),CreatedDate DATETIME,ModifiedByName NVARCHAR(600),ModifiedDate DATETIME,RowId INT,CountNo INT)  
	
	IF OBJECT_ID('TEMPDB..#User') IS NOT NULL
		DROP TABLE #User

	SELECT ZU.UserId, ZU.UserName
	INTO #User
	FROM ZnodeUser ZU
	WHERE EXISTS(SELECT * FROM ZnodeCMSContentContainer ZCW WHERE ZU.UserId = ZCW.CreatedBy OR ZU.UserId = ZCW.ModifiedBy)

	SET @SQL = '   
	;With Cte_ContentContainer AS   
	(  
		SELECT DISTINCT ZCW.CMSContentContainerId,ZCW.Name, ZCW.ContainerKey as ContainerKey, ZCW.Tags, ZPS.DisplayName As PublishStatus ,U.UserName AS CreatedByName,ZCW.CreatedDate,U1.UserName AS ModifiedByName,ZCW.ModifiedDate
		FROM ZnodeCMSContentContainer ZCW
		LEFT JOIN ZnodePublishState ZPS ON ZCW.PublishStateId=ZPS.PublishStateId
		LEFT JOIN #User U ON U.UserId = ZCW.CreatedBy
		LEFT JOIN #User U1 ON U1.UserId = ZCW.ModifiedBy
	)  
	,Cte_ContentContainerList AS
	(
		SELECT CMSContentContainerId, ContainerKey,Name, Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,
		'+dbo.Fn_GetPagingRowId(@Order_BY,'ContainerKey ASC')+',Count(*)Over() CountNo 
		FROM Cte_ContentContainer    
		WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'    
	)
	SELECT CMSContentContainerId,ContainerKey,Name,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,RowId,CountNo    
	FROM Cte_ContentContainerList   
	'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)  
	  
	INSERT INTO @TBL_ContentContainer (ContentContainerId,ContainerKey,Name,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate,RowId,CountNo)  
	EXEC (@SQL)  
	SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ContentContainer ),0)  

	SELECT ContentContainerId,ContainerKey,Name,Tags,PublishStatus,CreatedByName,CreatedDate,ModifiedByName,ModifiedDate
	FROM @TBL_ContentContainer  
	ORDER BY RowId

END TRY    
BEGIN CATCH    
	DECLARE @Status BIT ;    
	SET @Status = 0;    
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= 
	ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 
	'EXEC Znode_GetCMSContainerlist @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',
	@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',
	@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                       
        
	EXEC Znode_InsertProcedureErrorLog    
	@ProcedureName = 'Znode_GetCMSContainerlist',    
	@ErrorInProcedure = @Error_procedure,    
	@ErrorMessage = @ErrorMessage,    
	@ErrorLine = @ErrorLine,    
	@ErrorCall = @ErrorCall;                                
END CATCH; 
END;

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Order','ReorderCompleteOrder',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Order' and ActionName = 'ReorderCompleteOrder')

INSERT INTO ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'OMS' AND ControllerName = 'Order')
   ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Order' and ActionName = 'ReorderCompleteOrder') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId =
    (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'OMS' AND ControllerName = 'Order') and ActionId =
    (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Order' and ActionName = 'ReorderCompleteOrder'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
SELECT
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'OMS' AND ControllerName = 'Order'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Order' and ActionName = 'ReorderCompleteOrder')
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId =
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'OMS' AND ControllerName = 'Order') and ActionId =
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Order' and ActionName = 'ReorderCompleteOrder'))

GO

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OmsOrderId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>OrderNumber</name>      <headertext>Order No</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/Order/Manage</islinkactionurl>      <islinkparamfield>OmsOrderId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>UserName</name>      <headertext>Customer Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>Email</name>      <headertext>Email</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PhoneNumber</name>      <headertext>Phone Number</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>StoreName</name>      <headertext>Store Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>OrderState</name>      <headertext>Order Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>orderState</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>PaymentStatus</name>      <headertext>Payment Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>paymentStatus</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>PaymentDisplayName</name>      <headertext>Payment Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>paymentType</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>OrderTotalWithCurrency</name>      <headertext>Total</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>11</id>      <name>Total</name>      <headertext>Total</headertext>      <width>30</width>      <datatype>Decimal</datatype>      <columntype>Decimal</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>12</id>      <name>SubTotalAmount</name>      <headertext>SubTotal</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>13</id>      <name>Tax</name>      <headertext>Tax</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>14</id>      <name>Shipping</name>      <headertext>Shipping</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>15</id>      <name>BillingPostalCode</name>      <headertext>Billing Zip Code</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>16</id>      <name>ShippingPostalCode</name>      <headertext>Shipping Zip Code</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>17</id>      <name>OrderDateWithTime</name>      <headertext>Order Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>18</id>      <name>CreatedByName</name>      <headertext>Created By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>19</id>      <name>PublishState</name>      <headertext>Application Type</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>20</id>      <name>ModifiedByName</name>      <headertext>Modified By</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>21</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>View|return|shopping-cart</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>View|Create Return|Reorder</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Order/Manage|/RMAReturn/CheckOrderEligibleForReturn|/Order/ReorderCompleteOrder</manageactionurl>      <manageparamfield>OmsOrderId|orderNumber,userId,portalId,omsOrderId|userId,portalId,omsOrderId,actionName</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='ZnodeOrder'

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OrderNumber</name>      <headertext>Order No</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/Order/Manage</islinkactionurl>      <islinkparamfield>OmsOrderId,accountId,updatePageType</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>StoreName</name>      <headertext>Store Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>OrderState</name>      <headertext>Order Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>PaymentStatus</name>      <headertext>Payment Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PaymentDisplayName</name>      <headertext>Payment Type</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>paymentType</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>OrderTotalWithCurrency</name>      <headertext>Order Amount</headertext>      <width>30</width>      <datatype>Decimal</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>OrderDate</name>      <headertext>Order Date</headertext>      <width>30</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>View|shopping-cart</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>View|Reorder</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Order/Manage|/Order/ReorderCompleteOrder</manageactionurl>      <manageparamfield>OmsOrderId,accountId,updatePageType|userId,portalId,omsOrderId,actionName</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='CustomerOrderHistory'

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OmsOrderId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>OrderNumber</name>      <headertext>Order No</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>/Order/Manage</islinkactionurl>      <islinkparamfield>OmsOrderId,accountId,updatePageType</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>UserName</name>      <headertext>Username</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>OrderState</name>      <headertext>Order Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PaymentStatus</name>      <headertext>Payment Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>paymentStatus</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>PaymentDisplayName</name>      <headertext>Payment Type</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>OrderTotalWithCurrency</name>      <headertext>Order Amount</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>OrderDate</name>      <headertext>Order Date</headertext>      <width>30</width>      <datatype>Date</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>IsInRMA</name>      <headertext>IsInRMA</headertext>      <width>40</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>IsInRMA</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Guest User</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>IsInRMA</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>View|shopping-cart</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>View|Reorder</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Order/Manage|/Order/ReorderCompleteOrder</manageactionurl>      <manageparamfield>OmsOrderId,accountId,updatePageType|userId,portalId,omsOrderId,actionName</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='AccountUserOrderList'

GO

IF EXISTS (SELECT * FROM sysobjects WHERE xtype IN (N'FN', N'IF', N'TF') AND id = object_id(N'Fn_GetImportStatus'))
    DROP FUNCTION Fn_GetImportStatus

GO

CREATE FUNCTION [dbo].[Fn_GetImportStatus](
               @ImportStatus INT = 0)
RETURNS VARCHAR(100)
AS
     BEGIN
         RETURN CASE
                    WHEN @ImportStatus = 0
                    THEN 'Started'
                    WHEN @ImportStatus = 1
                    THEN 'In Process'
                    WHEN @ImportStatus = 2
                    THEN 'Completed Successfully'
                    WHEN @ImportStatus = 3
                    THEN 'Failed'
					WHEN @ImportStatus = 4
                    THEN 'Completed With Errors'
                END;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAccount')
	DROP PROC Znode_ImportAccount
GO

CREATE PROCEDURE [dbo].[Znode_ImportAccount](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200),@PortalId int 
	  ,@CsvColumnString nvarchar(max) )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max),@IsAllowGlobalLevelUserCreation nvarchar(10)

		DECLARE @GetDate datetime= dbo.Fn_GetDate();
	
		-- Three type of import required three table varible for product , category and brand

		CREATE TABLE #InsertAccount 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int,ParentAccountCode nvarchar(max),AccountName nvarchar(max), AccountCode nvarchar(max),ExternalID nvarchar(max),
			CatalogCode nvarchar(max),AddressName nvarchar(max),FirstName varchar(max),LastName varchar(max),CompanyName varchar(max),
			Address1 varchar(max),Address2 varchar(max),CountryName varchar(max),StateName varchar(max),CityName varchar(max),
			PostalCode varchar(max),PhoneNumber varchar(max),IsDefaultBilling varchar(10),IsDefaultShipping varchar(10),GUID VARCHAR(100)
		);
	
		SET @SSQL = ' INSERT INTO #InsertAccount ( RowNumber, ParentAccountCode,AccountName ,AccountCode,ExternalID,CatalogCode,AddressName,FirstName,LastName,CompanyName
						,Address1,Address2,CountryName,StateName,CityName,PostalCode,PhoneNumber,IsDefaultBilling,IsDefaultShipping,GUID )
		SELECT RowNumber, ParentAccountCode,AccountName ,AccountCode,ExternalID,CatalogCode,AddressName,FirstName,LastName,CompanyName
						,Address1,Address2,CountryName,StateName,CityName,PostalCode,PhoneNumber,IsDefaultBilling,IsDefaultShipping,GUID FROM '+ @TableName;

		EXEC sys.sp_sqlexec @SSQL;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.AccountCode, '')) >100 and ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '86', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''
		and not exists(select * from znodePortalAccount ZPA inner join ZnodeAccount ZA ON ZPA.AccountId = ZA.AccountId where ii.ParentAccountCode = ZA.AccountCode and ZPA.PortalId = @PortalId)
		and not exists(select * from #InsertAccount IA where ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') = ISnull(ltrim(rtrim(IA.AccountCode)), '') and ii.RowNumber > IA.RowNumber)
	
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '87', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''
		and exists(select * from ZnodeAccount ZA where ii.ParentAccountCode = ZA.AccountCode and ZA.ParentAccountId is not null)
		--and not exists(select * from #InsertAccount IA where ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') = ISnull(ltrim(rtrim(IA.AccountCode)), '') and ii.RowNumber > IA.RowNumber)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '89', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''
		and exists(select * from ZnodeAccount ZA where ii.AccountCode = ZA.AccountCode and ZA.ParentAccountId is not null)
		and exists(select * from ZnodeAccount ZA 
				inner join ZnodeAccount ZA1 on ZA.ParentAccountId = ZA1.accountId 
				 where ii.ParentAccountCode <> ZA1.AccountCode)
		and not exists(select * from #InsertAccount IA where ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') = ISnull(ltrim(rtrim(IA.AccountCode)), '')
		and ii.RowNumber > IA.RowNumber )
		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.AccountCode)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.AccountCode, '')) >100 and ISnull(ltrim(rtrim(ii.AccountCode)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '79', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ii.AccountCode like '%[^a-zA-Z0-9]%' and ISnull(ltrim(rtrim(ii.AccountCode)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'AccountName', AccountName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.AccountName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'AccountName', AccountName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.AccountName, '')) >100 and ISnull(ltrim(rtrim(ii.AccountName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '52', 'AccountName', AccountName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE isnull(replace(ii.AccountName,' ',''),'') like '%[^a-Z0-9]%' and ISnull(ltrim(rtrim(ii.AccountName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.StateName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ltrim(rtrim(ii.StateName)), '')) >100 and ISnull(ltrim(rtrim(ii.StateName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '83', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE not exists(select * from ZnodeState ZS where ZS.StateName = ISnull(ltrim(rtrim(ii.StateName)), '') ) and ISnull(ltrim(rtrim(ii.StateName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '83', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE not exists(select * from ZnodeCountry ZC where ZC.CountryName = ISnull(ltrim(rtrim(ii.CountryName)), '') ) AND ISnull(ltrim(rtrim(ii.CountryName)), '') <> ''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.CountryName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '90', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.CountryName)), '') <> ''
		and not exists(select * from ZnodePortalCountry ZPC inner join ZnodeCountry ZC ON ZPC.CountryCode = ZC.CountryCode
		    where PortalId = @PortalId and ltrim(rtrim(ii.CountryName)) = ltrim(rtrim(ZC.CountryName)))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'CityName', CityName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.CityName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'CityName', CityName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ltrim(rtrim(ii.CityName)), '')) >100 and ISnull(ltrim(rtrim(ii.CityName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'PostalCode', PostalCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.PostalCode)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'PostalCode', PostalCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ltrim(rtrim(ii.PostalCode)), '')) >100 and ISnull(ltrim(rtrim(ii.PostalCode)), '') <> ''
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'PhoneNumber', PhoneNumber, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.PhoneNumber)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '78', 'PhoneNumber', PhoneNumber, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ltrim(rtrim(ii.PhoneNumber)), '')) >100 and ISnull(ltrim(rtrim(ii.PhoneNumber)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'IsDefaultBilling', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.IsDefaultBilling)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsDefaultBilling', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertAccount AS ii  
		WHERE ISnull(ltrim(rtrim(ii.IsDefaultBilling)),'') not in ('True','1','FALSE','0') and ISnull(ltrim(rtrim(ii.IsDefaultBilling)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '91', 'IsDefaultBilling', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertAccount AS ii  
		WHERE exists(select * from ZnodeAccount ZA where ii.AccountCode = ZA.AccountCode)  
		and ISnull(ltrim(rtrim(ii.IsDefaultBilling)), '') <> '' and ISnull(ltrim(rtrim(ii.IsDefaultBilling)),'') in ('FALSE','0')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'IsDefaultShipping', IsDefaultShipping, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.IsDefaultShipping)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsDefaultShipping', IsDefaultShipping, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertAccount AS ii  
		WHERE ISnull(ltrim(rtrim(ii.IsDefaultShipping)),'') not in ('True','1','FALSE','0') and ISnull(ltrim(rtrim(ii.IsDefaultShipping)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '91', 'IsDefaultShipping', IsDefaultShipping, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertAccount AS ii  
		WHERE exists(select * from ZnodeAccount ZA where ii.AccountCode = ZA.AccountCode)  
		and ISnull(ltrim(rtrim(ii.IsDefaultShipping)), '') <> '' and ISnull(ltrim(rtrim(ii.IsDefaultShipping)),'') in ('FALSE','0')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'AddressName', AddressName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.AddressName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '81', 'AddressName', AddressName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.AddressName, '')) >200 and ISnull(ltrim(rtrim(ii.AddressName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'Address1', Address1, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.Address1)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '81', 'Address1', Address1, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.Address1, '')) >200 and ISnull(ltrim(rtrim(ii.Address1)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '82', 'CompanyName', CompanyName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.CompanyName, '')) >300 and ISnull(ltrim(rtrim(ii.CompanyName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'LastName', LastName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.LastName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '82', 'LastName', LastName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ltrim(rtrim(ii.LastName)), '')) >300 and ISnull(ltrim(rtrim(ii.LastName)), '') <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'FirstName', FirstName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.FirstName)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '82', 'FirstName', FirstName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.FirstName, '')) >300 and ISnull(ltrim(rtrim(ii.FirstName)), '') <> ''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '80', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE not exists(select * from ZnodePimCatalog ZS where ZS.CatalogCode = ISnull(ltrim(rtrim(ii.CatalogCode)), '') )
		and ISnull(ltrim(rtrim(ii.CatalogCode)), '') <> ''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '84', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.CatalogCode)), '') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '82', 'ExternalID', ExternalID, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE len(ISnull(ii.ExternalID, '')) >300 and ISnull(ltrim(rtrim(ii.ExternalID)), '') <> ''


		-- -- error log when atleast db have 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '85', 'IsDefaultBilling/IsDefaultShipping', IsDefaultBilling +'/'+ IsDefaultShipping, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount IC where not exists (
		SELECT TOP 1 1  from ZnodeAccount ZAA where IC.AccountCode = ZAA.AccountCode )
		and (IC.IsDefaultBilling not in ('1', 'true') or (IsDefaultShipping not in ('1', 'true')))  
		
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AccountCode - ' + ISNULL(AccountCode,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertAccount IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		
		DELETE FROM #InsertAccount
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber IS NOT NULL 
		);

		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertAccount
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
		CREATE TABLE #InsertedAccount (AccountId int, Accountcode nvarchar(100)) 
		
		INSERT INTO ZnodeAccount(AccountCode,ParentAccountId,Name,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		OUTPUT INSERTED.AccountId, INSERTED.Accountcode INTO  #InsertedAccount (AccountId, Accountcode) 
		select IC.AccountCode, null as ParentAccountId, AccountName, IC.ExternalID, @UserId, @GetDate, @UserId, @GetDate
		from #InsertAccount IC
		where not exists(select * from ZnodeAccount ZA1 where ZA1.AccountCode = IC.AccountCode)
		and ISnull(ltrim(rtrim(IC.ParentAccountCode)), '') = '' 

		INSERT INTO ZnodePortalAccount(PortalId,AccountId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @PortalId, IA.AccountId,  @UserId, @GetDate, @UserId, @GetDate
		FROM #InsertedAccount IA 
		WHERE not exists(select * from ZnodePortalAccount ZPA where IA.AccountId = ZPA.AccountId )

		----Import Child Account where Parent account details having in same CSV ****Start
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '86', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''
		and not exists(select * from znodePortalAccount ZPA inner join ZnodeAccount ZA ON ZPA.AccountId = ZA.AccountId where ii.ParentAccountCode = ZA.AccountCode and ZPA.PortalId = @PortalId)
		and not exists(select * from #InsertAccount IA where ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') = ISnull(ltrim(rtrim(IA.AccountCode)), '') and ii.RowNumber > IA.RowNumber)
	
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '87', 'ParentAccountCode', ParentAccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertAccount AS ii
		WHERE ISnull(ltrim(rtrim(ii.ParentAccountCode)), '') <> ''
		and exists(select * from ZnodeAccount ZA where ii.ParentAccountCode = ZA.AccountCode and ZA.ParentAccountId is not null)

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AccountCode - ' + ISNULL(AccountCode,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertAccount IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		DELETE FROM #InsertAccount
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber IS NOT NULL 
		);

		INSERT INTO ZnodeAccount(AccountCode,ParentAccountId,Name,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		OUTPUT INSERTED.AccountId, INSERTED.Accountcode INTO  #InsertedAccount (AccountId, Accountcode) 
		select IC.AccountCode, za.AccountId as ParentAccountId, AccountName, IC.ExternalID, @UserId, @GetDate, @UserId, @GetDate
		from #InsertAccount IC
		left join ZnodeAccount za on IC.ParentAccountCode = za.AccountCode
		where not exists(select * from ZnodeAccount ZA1 where ZA1.AccountCode = IC.AccountCode)
		and ISnull(ltrim(rtrim(IC.ParentAccountCode)), '') <> ''

		INSERT INTO ZnodePortalAccount(PortalId,AccountId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @PortalId, IA.AccountId,  @UserId, @GetDate, @UserId, @GetDate
		FROM #InsertedAccount IA 
		WHERE not exists(select * from ZnodePortalAccount ZPA where IA.AccountId = ZPA.AccountId )
		--------
		update ZA set ZA.ParentAccountId =  ZA1.AccountId
		from ZnodeAccount ZA
		inner join #InsertAccount IA ON ZA.AccountCode = IA.AccountCode
		inner join ZnodeAccount ZA1 ON ZA1.AccountCode = IA.ParentAccountCode 
		where exists(select * from #InsertedAccount IC where IA.AccountCode = IC.AccountCode)
		and ZA.ParentAccountId is null

		----updating AccountName for respective account
		update ZA set Name = IC.AccountName, AccountCode = IC.AccountCode
		OUTPUT INSERTED.AccountId, INSERTED.Accountcode INTO  #InsertedAccount (AccountId, Accountcode)
		from ZnodeAccount ZA
		inner join #InsertAccount IC ON ZA.AccountCode = IC.AccountCode

		----updating publishcatalogin to respective account
		update ZA set PublishCatalogId = ZPC1.PublishCatalogId, AccountCode = IC.AccountCode
		OUTPUT INSERTED.AccountId, INSERTED.Accountcode INTO  #InsertedAccount (AccountId, Accountcode) 
		from ZnodeAccount ZA
		inner join #InsertAccount IC ON ZA.AccountCode = IC.AccountCode
		inner join ZnodePimCatalog ZPC ON IC.CatalogCode = ZPC.CatalogCode
		inner join ZnodePublishCatalog ZPC1 ON ZPC.PimCatalogId = ZPC1.PimCatalogId
		where not exists(select * from ZnodePortalCatalog ZPCa where ZPCa.PublishCatalogId = ZPC1.PublishCatalogId and ZPCa.PortalId = @PortalId)

		----------update ZnodeAddress
		DECLARE @AddressColumnString VARCHAR(1000), @WhereConditionString VARCHAR(1000), @UpdateColumnString VARCHAR(1000)

		SELECT @AddressColumnString = COALESCE(@AddressColumnString + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' and ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
		FROM ZnodeImportUpdatableColumns a
		INNER JOIN INFORMATION_SCHEMA.COLUMNS b on a.ColumnName = b.COLUMN_NAME  
		INNER JOIN dbo.Split(@CsvColumnString,',')C on b.COLUMN_NAME = c.Item
		WHERE b.TABLE_NAME = 'ZnodeAddress' 
		AND EXISTS(SELECT * FROM ZnodeImportHead IH where a.ImportHeadId = IH.ImportHeadId and IH.Name= 'Account')

		SELECT @UpdateColumnString = COALESCE(@UpdateColumnString + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
		FROM INFORMATION_SCHEMA.COLUMNS a
		INNER JOIN dbo.Split(@CsvColumnString,',')b on a.COLUMN_NAME = b.Item
		WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString,',') c WHERE a.COLUMN_NAME = c.Item )
		AND a.TABLE_NAME = 'ZnodeAddress'

		SELECT @WhereConditionString = COALESCE(@WhereConditionString + ' AND ', '') +'ZA.'+item+' =  IC.'+item from dbo.split(@AddressColumnString,',')
	
				
		CREATE TABLE #InsertedAccountAddress (AddressId  int, AccountCode varchar(100)) 

		SET @SSQL = '
			UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
			FROM ZnodeAddress ZA
			INNER JOIN #InsertAccount IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END

		EXEC (@SSQL)

		SET @SSQL = '
		Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
								StateName,CityName,PostalCode,PhoneNumber,
								IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT INSERTED.AddressId, INSERTED.Address3 INTO  #InsertedAccountAddress (AddressId, AccountCode) 			 
		SELECT IC.FirstName,IC.LastName,IC.AddressName,IC.Address1,IC.Address2,IC.AccountCode,ZC.CountryCode,
		ZS.StateCode,IC.CityName,IC.PostalCode,IC.PhoneNumber,
		isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),1,IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate()
		FROM  #InsertAccount IC
		inner join ZnodeState ZS on IC.StateName = ZS.StateName
		inner join ZnodeCountry ZC ON IC.CountryName = ZC.CountryName and ZS.CountryCode = ZC.CountryCode
		WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'

		EXEC (@SSQL)

		update ZAA set AddressId = UA.AddressId
		FROM #InsertedAccountAddress UA
		INNER JOIN #InsertedAccount IA ON UA.AccountCode = IA.AccountCode
		inner join ZnodeAccount ZA ON IA.AccountCode = ZA.AccountCode
		inner join ZnodeAccountAddress ZAA ON ZA.AccountId = ZAA.AccountId
		
		INSERT INTO ZnodeAccountAddress ( AccountId, AddressId, CreatedBy, CreatedDate,	ModifiedBy,	ModifiedDate )
		SELECT distinct IA.AccountId, AddressId ,  @UserId , @GetDate, @UserId , @GetDate 
		FROM #InsertedAccountAddress UA
		INNER JOIN #InsertedAccount IA ON UA.AccountCode = IA.AccountCode
		WHERE NOT EXISTS ( SELECT * FROM ZnodeAccountAddress AA WHERE AA.AccountId = IA.AccountId )

		update ZnodeAddress set Address3 = null
		where exists(select * from #InsertedAccountAddress IAA where IAA.AddressId = ZnodeAddress.AddressId )
		and Address3 is null
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAccount @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));

		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;
              			
        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAccount',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAddonAssociation')
	DROP PROC Znode_ImportAddonAssociation
GO


CREATE PROCEDURE [dbo].[Znode_ImportAddonAssociation](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

		IF OBJECT_ID('TEMPDB..#InsertProductAddonAssociation') IS NOT NULL
			DROP TABLE #InsertProductAddonAssociation

		IF OBJECT_ID('TEMPDB..#SKU') IS NOT NULL
			DROP TABLE #SKU

		IF OBJECT_ID('TEMPDB..#InsertZnodePimAddOnProduct') IS NOT NULL
			DROP TABLE #InsertZnodePimAddOnProduct

		CREATE TABLE #InsertZnodePimAddOnProduct ( PimAddOnProductId int,PimAddonGroupId int,PimProductId int)

		CREATE TABLE #InsertProductAddonAssociation
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, SKU varchar(300),AddonGroupName varchar(300),AddOnSKU varchar(300),DisplayOrder int, IsDefault varchar(10), GUID nvarchar(400)
		
		);

		CREATE TABLE #SKU 
		( 
			SKU nvarchar(300), PimProductId int
		);

		----Get All SKU Data From DB
		INSERT INTO #SKU (SKU, PimProductId)
		SELECT ZPAVL.AttributeValue, ZPAV.PimProductId
		FROM ZnodePimAttributeValue AS ZPAV
		INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePimAttribute ZPA ON ZPAV.PimAttributeId = ZPA.PimAttributeId
		WHERE ZPA.AttributeCode = 'SKU';

		SET @SSQL = 'Select RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID FROM '+@TableName;
		INSERT INTO #InsertProductAddonAssociation( RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID )
		EXEC sys.sp_sqlexec @SSQL;

		SELECT SKU,AddonGroupName,AddOnSKU 
		INTO #DuplicateProductAddonAssociation 
		FROM #InsertProductAddonAssociation 
		Group BY SKU,AddonGroupName,AddOnSKU  having count(*) > 1

		----Checking AddonGroupName present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '19', 'AddonGroupName', AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS ( SELECT * FROM ZnodePimAddonGroupLocale i where i.AddonGroupName = ii.AddonGroupName );

		----Checking SKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '19', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.SKU = SKU.SKU)

		----Checking AddOnSKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '19', 'AddOnSKU', AddOnSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.AddOnSKU = SKU.SKU)
		
		----Duplicate Record (SKU \ AddOnSKU \ AddonGroupName)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '53', 'SKU \ AddOnSKU \ AddonGroupName ', SKU+' \ '+AddOnSKU+' \ '+AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE EXISTS ( select * FROM #DuplicateProductAddonAssociation i WHERE i.SKU = ii.SKU and i.AddOnSKU = ii.AddOnSKU and i.AddonGroupName = ii.AddonGroupName );

		----Checking is default value data validation
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '35', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertProductAddonAssociation AS ii  
		WHERE ISNULL(ii.IsDefault,0) not in ('True','1','Yes','FALSE','0','No','')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM #InsertProductAddonAssociation AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM #InsertProductAddonAssociation AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + isnull(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertProductAddonAssociation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- Delete Invalid Data after functional validatin  
		DELETE FROM #InsertProductAddonAssociation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertProductAddonAssociation
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))  
		WHERE ImportProcessLogId = @ImportProcessLogId;


		UPDATE PAPD
		SET PAPD.ModifiedBy =@UserId  ,PAPD.ModifiedDate = GETDATE(),
		PAPD.IsDefault = case when IPAA.IsDefault in ('True','1','Yes') then 1 else 0 end,
		PAPD.DisplayOrder = CASE WHEN IPAA.DisplayOrder IS NOT NULL THEN IPAA.DisplayOrder ELSE PAPD.DisplayOrder END
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct PAP ON (PAP.PimProductId = SKU.PimProductId AND PAP.PimAddonGroupId = ZPAGL.PimAddonGroupId)
		INNER JOIN ZnodePimAddOnProductDetail PAPD ON (PAPD.PimAddOnProductId =PAP.PimAddOnProductId AND SKU1.PimProductId = PAPD.PimChildProductId )

		-----Inserting records in ZnodePimAddOnProduct
		INSERT INTO ZnodePimAddOnProduct(PimAddonGroupId,PimProductId,DisplayOrder,RequiredType,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		OUTPUT inserted.PimAddOnProductId, inserted.PimAddonGroupId,inserted.PimProductId into #InsertZnodePimAddOnProduct (PimAddOnProductId,PimAddonGroupId,PimProductId)
		SELECT DISTINCT ZPAGL.PimAddonGroupId,SKU.PimProductId, 999 as DisplayOrder,
		'Required' RequiredType,@UserId as CreatedBy,@GetDate,@UserId as ModifiedBy,@GetDate
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProduct ZPAP where ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId and ZPAP.PimProductId = SKU.PimProductId )

		-----Inserting records in ZnodePimAddOnProductDetail
		INSERT INTO ZnodePimAddOnProductDetail(PimAddOnProductId,PimChildProductId,IsDefault,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT ZPAP.PimAddOnProductId, SKU.PimProductId as PimChildProductId, CASE WHEN isnull(IPAA.IsDefault,0) IN ('True','1','Yes') THEN 1 ELSE 0 END, ISNULL(IPAA.DisplayOrder,999),@UserId ,@GetDate,@UserId,@GetDate 
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.SKU
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on IPAA.AddonGroupName = ZPAGL.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct ZPAP on SKU1.PimProductId = ZPAP.PimProductId and ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProductDetail ZPAPD WHERE ZPAPD.PimAddOnProductId = ZPAP.PimAddOnProductId and ZPAPD.PimChildProductId = SKU.PimProductId )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;

	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAddonAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAddonAssociation',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAssociateProducts')
	DROP PROC Znode_ImportAssociateProducts
GO


CREATE PROCEDURE [dbo].[Znode_ImportAssociateProducts](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Product Association 
	
	-- Unit Testing : 
	--BEGIN TRANSACTION;
	--update ZnodeGlobalSetting set FeatureValues = '5' WHERE FeatureName = 'InventoryRoundOff' 
	--    DECLARE @status INT;
	--    EXEC [Znode_ImportInventory] @InventoryXML = '<ArrayOfImportInventoryModel>
	-- <ImportInventoryModel>
	--   <SKU>S1002</SKU>
	--   <Quantity>999998.33</Quantity>
	--   <ReOrderLevel>10</ReOrderLevel>
	--   <RowNumber>1</RowNumber>
	--   <ListCode>TestInventory</ListCode>
	--   <ListName>TestInventory</ListName>
	-- </ImportInventoryModel>
	--</ArrayOfImportInventoryModel>' , @status = @status OUT , @UserId = 2;
	--    SELECT @status;
	--    ROLLBACK TRANSACTION;
	--------------------------------------------------------------------------------------

BEGIN
	
	BEGIN TRY
	BEGIN TRAN A;
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();

		IF OBJECT_ID('TEMPDB..#InsertProductAssociation') IS NOT NULL 
			DROP TABLE #InsertProductAssociation

		IF OBJECT_ID('TEMPDB..#InsertProduct') IS NOT NULL 
			DROP TABLE #InsertProduct

		IF OBJECT_ID('TEMPDB..#SKU') IS NOT NULL 
			DROP TABLE #SKU

		IF OBJECT_ID('TEMPDB..#InsertProductAssociation_Parent_type') IS NOT NULL 
			DROP TABLE #InsertProductAssociation_Parent_type
		-- Retrive RoundOff Value from global setting 

		CREATE TABLE #InsertProductAssociation 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, ParentSKU varchar(300), ChildSKU varchar(200), DisplayOrder int,IsDefault varchar(10), GUID nvarchar(400),BundleQuantity varchar(10) null
		);

		CREATE TABLE #InsertProductAssociation_Parent_type
		( 
			RowId int  PRIMARY KEY, RowNumber int, ParentSKU varchar(300), ChildSKU varchar(200), DisplayOrder int,IsDefault varchar(10), GUID nvarchar(400),BundleQuantity varchar(10) null
			,PT_ParentProductId varchar(300), PT_ProductType nvarchar(100)
		);
		
		CREATE TABLE #InsertProduct 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, ParentProductId varchar(300), ChildProductId varchar(200), DisplayOrder int,IsDefault varchar(10), GUID nvarchar(400), ProductType nvarchar(100),BundleQuantity varchar(10) null
		);


		DECLARE @CategoryAttributId int;

		DECLARE @InventoryListId int;

		SET @SSQL = 'Select RowNumber,ParentSKU,ChildSKU,DisplayOrder,IsDefault,GUID,Quantity FROM '+@TableName;
		INSERT INTO #InsertProductAssociation( RowNumber, ParentSKU,ChildSKU,DisplayOrder,IsDefault, GUID, BundleQuantity )
		EXEC sys.sp_sqlexec @SSQL;

		--@MessageDisplay will use to display validate message for input inventory value  
		CREATE TABLE #SKU 
		( 
						   SKU nvarchar(300), PimProductId int
		);
		INSERT INTO #SKU
			   SELECT b.AttributeValue, a.PimProductId
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;

		DECLARE @ProductType TABLE
		( 
			ProductType nvarchar(100) ,PimProductId int
		);
		INSERT INTO @ProductType
			   SELECT  ZPADV.AttributeDefaultValueCode, a.PimProductId
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimProductAttributeDefaultValue AS b
					ON a.PimAttributeId = dbo.Fn_GetProductTypeAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId
					   Inner join ZnodePimAttributeDefaultValue ZPADV On b.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId
					   where  ZPADV.AttributeDefaultValueCode in ('GroupedProduct','BundleProduct','ConfigurableProduct');

		INSERT INTO #InsertProductAssociation_Parent_type
			SELECT IPAC.*,SKUParent.PimProductId, PT.ProductType
					FROM #InsertProductAssociation AS IPAC INNER JOIN #SKU AS SKUParent ON IPAC.ParentSKU = SKUParent.SKU 
					inner join @ProductType PT on PT.PimProductId = SKUParent.PimProductId


		-- start Functional Validation 
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '84', 'IsDefault', IsDefault, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE isnull(ii.IsDefault,'') = '' and ii.PT_ProductType ='ConfigurableProduct'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE isnull(ii.IsDefault,'') not in ('true','1','false','0') and isnull(ii.IsDefault,'') <> '' and ii.PT_ProductType ='ConfigurableProduct'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE isnull(ii.IsDefault,'') not in ('true','1','false','0') and isnull(ii.IsDefault,'') <> '' and ii.PT_ProductType ='BundleProduct'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '19', 'ChildSKU', ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE NOT EXISTS( SELECT SKU FROM #SKU SKU WHERE ii.ChildSKU = SKU.SKU)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'ParentSKU / ChildSKU', ParentSKU+' / '+ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE ii.ParentSKU IN
			   (
				   select ParentSKU from #InsertProductAssociation_Parent_type
					group by ParentSKU,ChildSKU
					having count(1)>1
			   );

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '49', 'ParentSKU',   ParentSKU , @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE not exists
			   ( SELECT SKU  FROM #SKU SKU inner join @ProductType  PT ON SKU.PimProductId = PT.PimProductId Where  ii.ParentSKU = SKU.SKU )
			   AND  EXISTS (SELECT SKU  FROM #SKU SKU where ii.ParentSKU = SKU.SKU);

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '94', 'ParentSKU',   ParentSKU , @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE NOT  EXISTS (SELECT SKU  FROM #SKU SKU where ii.ParentSKU = SKU.SKU) ;


			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '51', 'ChildSKU',   ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE exists 
			   (SELECT SKU  FROM #SKU SKU inner join @ProductType  PT ON SKU.PimProductId = PT.PimProductId and ii.ChildSKU = SKU.SKU)
			    AND  EXISTS (SELECT SKU  FROM #SKU SKU where ii.ChildSKU = SKU.SKU);
			
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '94', 'ChildSKU',   ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE NOT EXISTS (SELECT SKU  FROM #SKU SKU where ii.ChildSKU = SKU.SKU);

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '35', 'ParentSKU',  'Configure Attribute Missing: '+ Convert(nvarchar(400),isnull(ParentSKU,'')), @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii Inner join #SKU PS ON 
			   ii.ParentSKU = PS.SKU 
			   Inner join @ProductType  PT ON PS.PimProductId = PT.PimProductId  AND PT.ProductType  in ('ConfigurableProduct')
			   where  NOT exists 
			   (select PimProductId  from ZnodePimConfigureProductAttribute d where PS.PimProductId = d.PimProductId)
			   -- End Function Validation 	

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM #InsertProductAssociation_Parent_type AS ii
			WHERE ((isnull(ii.DisplayOrder,'') = '' ) and ii.PT_ProductType !='ConfigurableProduct' ) --or  ii.DisplayOrder = 0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '26', 'BundleQuantity', BundleQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM #InsertProductAssociation_Parent_type AS ii
			WHERE ((isnull(ii.BundleQuantity,0) < 1 ) and ii.PT_ProductType ='BundleProduct' ) --or  ii.DisplayOrder = 0

			
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '2', 'BundleQuantity', BundleQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM #InsertProductAssociation_Parent_type AS ii
			WHERE (ii.BundleQuantity ='' and ii.PT_ProductType ='BundleProduct'  ) --or  ii.DisplayOrder = 0


		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	FROM #InsertProductAssociation_Parent_type AS ii
		--	WHERE ((isnull(ii.DisplayOrder,'') = '' ) and ii.PT_ProductType !='ConfigurableProduct' ) --or  ii.DisplayOrder > 999

			   UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + isnull(ParentSKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertProductAssociation_Parent_type IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--- Delete Invalid Data after functional validation  
		DELETE FROM #InsertProductAssociation_Parent_type
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  GUID = @NewGUID
		);

		SELECT RowNumber , SKUParent.PimProductId SKUParentId  ,
				   ( Select TOP 1 SKUChild.PimProductId from #SKU AS SKUChild where  SKUChild.SKU = IPAC.ChildSKU ) SKUChildId,
				    case when isnull(DisplayOrder,'')= '' and IPAC.PT_ProductType ='ConfigurableProduct'  then 99 else DisplayOrder end DisplayOrder ,
					 case when (isnull(IsDefault,'')= '' or IsDefault =0 or IsDefault > 999) and IPAC.PT_ProductType !='ConfigurableProduct'  then '0' else IsDefault end IsDefault, IPAC.PT_ProductType
					, BundleQuantity
					FROM #InsertProductAssociation_Parent_type AS IPAC INNER JOIN #SKU AS SKUParent ON IPAC.ParentSKU = SKUParent.SKU 

		insert into #InsertProduct (RowNumber,  ParentProductId , ChildProductId , DisplayOrder, IsDefault, ProductType, BundleQuantity)
			SELECT RowNumber , SKUParent.PimProductId SKUParentId  ,
				   ( Select TOP 1 SKUChild.PimProductId from #SKU AS SKUChild where  SKUChild.SKU = IPAC.ChildSKU ) SKUChildId,
				    case when isnull(DisplayOrder,'')= '' and IPAC.PT_ProductType ='ConfigurableProduct'  then 99 else DisplayOrder end DisplayOrder ,
					 case when (isnull(IsDefault,'')= '' or IsDefault =0 or IsDefault > 999) and IPAC.PT_ProductType !='ConfigurableProduct'  then '0' else IsDefault end IsDefault, IPAC.PT_ProductType
					, BundleQuantity
					FROM #InsertProductAssociation_Parent_type AS IPAC INNER JOIN #SKU AS SKUParent ON IPAC.ParentSKU = SKUParent.SKU 

	-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertProduct
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

		update #InsertProduct
		set IsDefault =0
		where RowNumber < (select max(RowNumber) from #InsertProduct where IsDefault = '1' or  IsDefault = 'True' and ProductType ='ConfigurableProduct')
		and  ProductType ='ConfigurableProduct';


		update ZnodePimProductTypeAssociation
		set  IsDefault =0
		where  exists (select top 1 1  from #InsertProduct IP where IsDefault = '1' or  IsDefault = 'true' and PimParentProductId = IP.ParentProductId and ProductType ='ConfigurableProduct')
		

		UPDATE B set b.ModifiedDate = @GetDate, b.ModifiedBy = @UserId, b.DisplayOrder = case when a.DisplayOrder is not null then a.DisplayOrder else b.DisplayOrder end
				,b.IsDefault = A.IsDefault,b.BundleQuantity= case when A.Producttype = 'BundleProduct' then  case when isnull(a.BundleQuantity,'') ='' then case when b.BundleQuantity >=1 then b.BundleQuantity else 1 end else cast (a.BundleQuantity as int) end else null end
		from #InsertProduct A
		INNER JOIN ZnodePimProductTypeAssociation B ON a.ParentProductId = b.PimParentProductId and a.ChildProductId = b.PimProductId

	
		INSERT INTO ZnodePimProductTypeAssociation (PimParentProductId, PimProductId, DisplayOrder, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, IsDefault,BundleQuantity) 
		select  ParentProductId , ChildProductId , DisplayOrder, @UserId, @GetDate, @UserId, @GetDate, IsDefault ,case when Producttype = 'BundleProduct' then case when  isnull(BundleQuantity,'') ='' then 1 else cast (BundleQuantity as int) end else null end
		from #InsertProduct  
		where  NOT Exists (Select TOP 1 1 from ZnodePimProductTypeAssociation where PimParentProductId =  #InsertProduct.ParentProductId
		AND PimProductId = #InsertProduct.ChildProductId )

								 
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						  WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						  WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					 END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
END TRY
	BEGIN CATCH
		ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAssociateProducts @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAssociateProducts',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributeDefaultValue')
	DROP PROC Znode_ImportAttributeDefaultValue
GO


CREATE PROCEDURE [dbo].[Znode_ImportAttributeDefaultValue](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			-- RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
			RowNumber int, AttributeCode varchar(300),AttributeDefaultValueCode varchar(300),AttributeDefaultValue varchar(1000),IsEditable varchar(10),DisplayOrder int, IsDefault varchar(10), SwatchText varchar(1000),SwatchImage varchar(500), SwatchImagePath varchar(500), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '9', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode not in 
			   (
				   SELECT AttributeCode FROM @AttributeCode
			   );

		WITH CTE_AttributeDefaultValueCode AS(
		SELECT AttributeDefaultValueCode , AttributeCode, RowNumber ,ROW_NUMBER ()OVER (PARTITION BY AttributeDefaultValueCode , AttributeCode ORDER BY AttributeDefaultValueCode , AttributeCode )  Row_Id
		FROM @InsertPimAtrribute Z
		
		
		)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE EXISTS
			  ( SELECT TOP 1 1 FROM CTE_AttributeDefaultValueCode Z WHERE Z.RowNumber=ii.RowNumber AND Z.Row_Id >1
			   )
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '%[^0-9A-Za-z]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '35', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '% %' -----space not allowed

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '35', 'IsEditable', IsEditable, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsEditable not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '35', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsDefault not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999

		UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AttributeDefaultValueCode - ' + ISNULL(AttributeDefaultValueCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName and IPA.SwatchImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName)

        update ZPADV set ZPADV.IsEditable = case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end,ZPADV.DisplayOrder = Case when Isnull(IPA.DisplayOrder,0) <> 0 then  IPA.DisplayOrder else ZPADV.DisplayOrder end ,
		                 ZPADV.IsDefault = case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end ,ZPADV.SwatchText = IPA.SwatchText ,
		                 ZPADV.MediaId = case when isnull(@MediaId,0)= 0 then ZPADV.MediaId else @MediaId end, ZPADV.ModifiedBy = @UserId, ZPADV.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode

		update ZPADVL set ZPADVL.AttributeDefaultValue = IPA.AttributeDefaultValue, ZPADVL.ModifiedBy = @UserId, ZPADVL.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode
		inner join ZnodePimAttributeDefaultValueLocale ZPADVL ON ( ZPADVL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)

		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttributeDefaultValue (PimAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,IsDefault,SwatchText,MediaId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT Inserted.PimAttributeId,Inserted.PimAttributeDefaultValueId,Inserted.AttributeDefaultValueCode INTO @InsertedPimAttributeIds  		
		SELECT ZPA.PimAttributeId,IPA.AttributeDefaultValueCode, case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end , Case when Isnull(IPA.DisplayOrder,0) = 0 then  99999 else IPA.DisplayOrder end  , 
		       case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end , IPA.SwatchText, @MediaId,@UserId , @GetDate ,@UserId , @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode  
		where not exists(select * from ZnodePimAttributeDefaultValue ZPADV where ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode)
		
		INSERT INTO ZnodePimAttributeDefaultValueLocale(LocaleId,PimAttributeDefaultValueId,AttributeDefaultValue,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeDefaultValueId, IPA.AttributeDefaultValue, '', @UserId , @GetDate ,@UserId , @GetDate   
		FROM @InsertedPimAttributeIds IPAS 
		INNER JOIN ZnodePimAttribute ZPA ON IPAS.PimAttributeId = ZPA.PimAttributeId  
		INNER JOIN @InsertPimAtrribute IPA ON ZPA.AttributeCode= IPA.AttributeCode and IPAS.AttributeDefaultValueCode = IPA.AttributeDefaultValueCode

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
	
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributeDefaultValue @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributeDefaultValue',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributes')
	DROP PROC Znode_ImportAttributes
GO


CREATE PROCEDURE [dbo].[Znode_ImportAttributes](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,AttributeTypeId int,AttributeCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeName,AttributeCode,AttributeType,DisplayOrder ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeName,AttributeCode,AttributeType,DisplayOrder ,GUID)
		EXEC sys.sp_sqlexec @SSQL;


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '10', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode in 
			   (
				   SELECT AttributeCode FROM @AttributeCode  where AttributeCode is not null 
			   );
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode in 
			   (
				   select AttributeCode  FROM @InsertPimAtrribute  Group BY AttributeCode  having count(*) > 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '19', 'AttributeType', AttributeType, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeType NOT in 
			   (
				   SELECT AttributeTypeName  FROM ZnodeAttributeType  where IsPimAttributeType = 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) like '%[^0-9A-Za-z]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE Isnumeric(ltrim(rtrim(isnull(ii.AttributeCode,'')))) =1

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '35', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) like '% %' -----space not allowed

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Attribute - ' + ISNULL(AttributeCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End


		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttribute (AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined
			,IsConfigurable,IsPersonalizable,IsShowOnGrid,DisplayOrder,HelpDescription,IsCategory,IsHidden,IsSwatch,
			CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		
		OUTPUT Inserted.PimAttributeId,Inserted.AttributeTypeId,Inserted.AttributeCode INTO @InsertedPimAttributeIds  
		
		SELECT ZAT.AttributeTypeId,AttributeCode, 0 IsRequired , 1 IsLocalizable,1 IsFilterable, 0 IsSystemDefined, 0 IsConfigurable,
		0 IsPersonalizable,  0 IsShowOnGrid , Case when Isnull(DisplayOrder,0) = 0 then  999 else DisplayOrder end  , '' HelpDescription ,0  IsCategory , 0 IsHidden , 0 IsSwatch,
		@UserId , @GetDate ,@UserId , @GetDate from @InsertPimAtrribute IPA INNER JOIN ZnodeAttributeType ZAT 
		ON IPA.AttributeType = ZAT.AttributeTypeName  
		
		
		INSERT INTO ZnodePimAttributeLocale (LocaleId,PimAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeId, IPA.AttributeName, '', @UserId , @GetDate ,@UserId , @GetDate   
		 FROM @InsertedPimAttributeIds IPAS INNER JOIN @InsertPimAtrribute IPA ON IPAS.AttributeCode= IPA.AttributeCode 
		
		INSERT INTO ZnodePimAttributeValidation
		(PimAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT IPA.PimAttributeId,ZAIV.InputValidationId,NULL,null , @UserId , @GetDate ,@UserId , @GetDate  
		FROM @InsertedPimAttributeIds IPA INNER JOIN ZnodeAttributeInputValidation ZAIV ON IPA.AttributeTypeId = ZAIV.AttributeTypeId


		insert into ZnodePimFrontendProperties (PimAttributeId,IsComparable,IsUseInSearch,IsHtmlTags,IsFacets,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select PimAttributeId, 0 IsComparable, 0 IsUseInSearch,0 IsHtmlTags,0 IsFacets, @UserId CreatedBy,@GetDate CreatedDate, @UserId ModifiedBy, @GetDate ModifiedDate
		from  @InsertedPimAttributeIds
		--      SET @Status = 1;

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributes',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportB2BCustomer')
	DROP PROC Znode_ImportB2BCustomer
GO




CREATE PROCEDURE [dbo].[Znode_ImportB2BCustomer](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @LocaleId int= 0,@PortalId int ,@CsvColumnString nvarchar(max))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max),@AspNetZnodeUserId nvarchar(256),@ASPNetUsersId nvarchar(256),
		@PasswordHash nvarchar(max),@SecurityStamp nvarchar(max),@RoleId nvarchar(256),@IsAllowGlobalLevelUserCreation nvarchar(10),
		@AccountId int

		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';
		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'User'  
		
		SELECT @AccountId = AccountId FROM ZnodeUser ZU WHERE UserId = @UserId
		--set @TableName = replace(@TableName,'tempdb..','')

		Select @IsAllowGlobalLevelUserCreation = FeatureValues from ZnodeGlobalsetting where FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		-- Retrive RoundOff Value from global setting 

		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, UserName nvarchar(512) ,FirstName	nvarchar(200),
			LastName nvarchar(200), BudgetAmount	numeric,Email	nvarchar(100),PhoneNumber	nvarchar(100),
		    EmailOptIn	bit	,ReferralStatus	nvarchar(40),IsActive	bit	,ExternalId	nvarchar(max), GUID NVARCHAR(400)
		);
		
		--	--SET @SSQL = 'SELECT RowNumber,UserName,FirstName,LastName,BudgetAmount,Email,PhoneNumber,EmailOptIn,IsActive,ExternalId,GUID FROM '+ @TableName;
		--SET @SSQL = 'SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		--INSERT INTO @InsertCustomer( RowNumber,UserName,FirstName,LastName,Email,PhoneNumber,       EmailOptIn,IsActive,ExternalId,GUID )
		--EXEC sys.sp_sqlexec @SSQL;

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,'+@CsvColumnString+',GUID ) 
					 SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+@TableName+'';
		--select @CsvColumnString
		--select * from #InsertCustomer
		--print @SSQL
		EXEC sys.sp_sqlexec @SSQL	

		--UserName,FirstName,LastName,Email,PhoneNumber,EmailOptIn,IsActive,ExternalId
	
	    -- start Functional Validation 

		-----------------------------------------------
		--If @IsAllowGlobalLevelUserCreation = 'true'
		--		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--			   SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--			   FROM @InsertCustomer AS ii
		--			   WHERE ii.UserName in 
		--			   (
		--				   SELECT UserName FROM AspNetZnodeUser   where PortalId = @PortalId
		--			   );
		--Else 
		--		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--			   SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--			   FROM @InsertCustomer AS ii
		--			   WHERE ii.UserName in 
		--			   (
		--				   SELECT UserName FROM AspNetZnodeUser   
		--			   );
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
					   SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
					   FROM #InsertCustomer AS ii
					   WHERE ii.UserName not like '%_@_%_.__%' 
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
					   SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
					   FROM #InsertCustomer AS ii
					   WHERE ii.UserName in 
					   (SELECT UserName  FROM #InsertCustomer group by UserName  having count(*) > 1 )

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
					   SELECT '35', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
					   FROM #InsertCustomer AS ii
					   WHERE ii.Email not like '%_@_%_.__%'

		--Note : Content page import is not required 
		
		-- End Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount,
			TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId nvarchar(256) ,UserName nvarchar(512),PortalId int )
				DECLARE @InsertedASPNetUsers TABLE (Id nvarchar(256) ,UserName nvarchar(512))
				DECLARE @InsertZnodeUser TABLE (UserId int,AspNetUserId nvarchar(256) )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber
				from AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				where Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= Isnull(IC.EmailOptIn,0),
				ZU.IsActive		= 1,--IC.IsActive,
				ZU.AccountId    = @AccountId
				--ZU.ExternalId = ExternalId
				from AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				where Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				Insert into AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				Select NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				where Not Exists (Select TOP 1 1  from AspNetZnodeUser ANZ where Isnull(ANZ.PortalId,0) = Isnull(@PortalId,0) AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				output inserted.Id, inserted.UserName into @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,NULL LockoutEndDateUtc,A.IsActive As LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId from #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
				
				INSERT INTO  ZnodeUser(AccountId, AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId into @InsertZnodeUser
				SELECT @AccountId, IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,Isnull(IC.EmailOptIn,0), 1 as IsActive,--IC.IsActive,
				IC.ExternalId, @UserId,@Getdate,@UserId,@Getdate
				FROM #InsertCustomer IC Inner join 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
				  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  Select AspNetUserId, @RoleID from @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId,@Getdate,@UserId,@Getdate from @InsertZnodeUser
				
				Declare @ProfileId  int 
				select TOP 1 @ProfileId   =  ProfileId from ZnodePortalprofile where Portalid = @PortalId and IsDefaultRegistedProfile=1

				insert into ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT @ProfileId  , UserId, 1 , @UserId,@Getdate,@UserId,@Getdate from @InsertZnodeUser

				 DECLARE @GlobalAttributeDetail TABLE
				 ( 
					GlobalAttributeId int, AttributeTypeName varchar(300), AttributeCode varchar(300), SourceColumnName nvarchar(600), IsRequired bit 
				 );

				INSERT INTO @GlobalAttributeDetail ( GlobalAttributeId, AttributeTypeName, AttributeCode, SourceColumnName, IsRequired )
				SELECT ZGA.GlobalAttributeId, ZAT.AttributeTypeName, ZGA.AttributeCode, ZGA.AttributeCode SourceColumnName, ZGA.IsRequired
				from tempdb.sys.columns a
				INNER JOIN ZnodeGlobalAttribute ZGA ON a.Name = ZGA.AttributeCode
				INNER JOIN ZnodeAttributeType ZAT ON ZGA.AttributeTypeId = ZAT.AttributeTypeId
				WHERE  object_id = object_id(@TableName)

				--SELECT ZGA.GlobalAttributeId, ZAT.AttributeTypeName, ZGA.AttributeCode, ZGA.AttributeCode SourceColumnName, ZGA.IsRequired
				--FROM tempdb.INFORMATION_SCHEMA.Columns a
				--INNER JOIN ZnodeGlobalAttribute ZGA ON a.Column_Name = ZGA.AttributeCode
				--INNER JOIN ZnodeAttributeType ZAT ON ZGA.AttributeTypeId = ZAT.AttributeTypeId
				--WHERE TABLE_NAME = @TableName

				 DECLARE @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @GlobalAttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @NewProductId INT, @PimAttributeValueId INT, @SQLQuery varchar(max); 

				 DECLARE  @UserDetail TABLE (  UserId int, GlobalAttributeId int , AttributeValue varchar(max), LocaleId int, RowNumber int)
			
	
				DECLARE Cr_AttributeDetails CURSOR LOCAL FAST_FORWARD
				FOR SELECT GlobalAttributeId, AttributeTypeName, AttributeCode, SourceColumnName, IsRequired FROM @GlobalAttributeDetail  WHERE ISNULL(SourceColumnName, '') <> '';
				OPEN Cr_AttributeDetails;
				FETCH NEXT FROM Cr_AttributeDetails INTO @GlobalAttributeId, @AttributeTypeName, @AttributeCode, @SourceColumnName, @IsRequired;
				WHILE @@FETCH_STATUS = 0
				BEGIN

					SET @NewProductId = 0;
					SET @SQLQuery = 'SELECT ZU.UserId ,'''+CONVERT(VARCHAR(100), @GlobalAttributeId)+''' GlobalAttributeId , TN.'+@SourceColumnName+' as AttributeValue, '+CONVERT(VARCHAR(100), @LocaleId)+' LocaleId
									, RowNumber FROM '+@TableName+' TN
									INNER JOIN AspNetZnodeUser ANZU ON TN.UserName = ANZU.UserName
									INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
									INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId ';
						--print @SQLQuery	

					INSERT INTO @UserDetail(  UserId, GlobalAttributeId, AttributeValue, LocaleId, RowNumber )
					EXEC sys.sp_sqlexec @SQLQuery;
					FETCH NEXT FROM Cr_AttributeDetails INTO @GlobalAttributeId, @AttributeTypeName, @AttributeCode, @SourceColumnName, @IsRequired;
				END;
				CLOSE Cr_AttributeDetails;
				DEALLOCATE Cr_AttributeDetails;
			
				-----GLOBAL ATTRIBUTE USER INSERT
				INSERT INTO ZnodeUserGlobalAttributeValue ( UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate )
				SELECT UserId, GlobalAttributeId ,NULL, NULL, @UserId, GETDATE(), @UserId , GETDATE()
				FROM @UserDetail UD
				where isnull(AttributeValue,'') <> ''
				AND NOT EXISTS (select * from ZnodeUserGlobalAttributeValue GAV where UD.UserId = GAV.UserId and UD.GlobalAttributeId = GAV.GlobalAttributeId )
				
				UPDATE ZnodeUserGlobalAttributeValueLocale set AttributeValue = UD.AttributeValue, ModifiedBy = @UserId,	ModifiedDate = GETDATE(), GlobalAttributeDefaultValueId = GADV.GlobalAttributeDefaultValueId
				FROM ZnodeUserGlobalAttributeValueLocale UGAVL
				INNER JOIN ZnodeUserGlobalAttributeValue UGAV on UGAV.UserGlobalAttributeValueId = UGAVL.UserGlobalAttributeValueId 
				INNER JOIN @UserDetail UD ON  UGAV.UserId = UD.UserId and UGAV.GlobalAttributeId = UD.GlobalAttributeId
				LEFT JOIN ZnodeGlobalAttributeDefaultValue GADV ON GADV.GlobalAttributeId = UD.GlobalAttributeId AND UD.AttributeValue = GADV.AttributeDefaultValueCode
				
				INSERT INTO ZnodeUserGlobalAttributeValueLocale( UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate, GlobalAttributeDefaultValueId )
				SELECT UGAV.UserGlobalAttributeValueId, UD.LocaleId , UD.AttributeValue, @UserId, GETDATE(), @UserId , GETDATE(), GADV.GlobalAttributeDefaultValueId
				from ZnodeUserGlobalAttributeValue UGAV 
				INNER JOIN @UserDetail UD ON  UGAV.UserId = UD.UserId and UGAV.GlobalAttributeId = UD.GlobalAttributeId
				LEFT JOIN ZnodeGlobalAttributeDefaultValue GADV ON GADV.GlobalAttributeId = UD.GlobalAttributeId AND UD.AttributeValue = GADV.AttributeDefaultValueCode
				WHERE isnull(UD.AttributeValue,'') <> ''
				AND NOT EXISTS ( select * from ZnodeUserGlobalAttributeValueLocale UGAVL where UGAV.UserGlobalAttributeValueId = UGAVL.UserGlobalAttributeValueId)

				--Updating the import process status
				UPDATE ZnodeImportProcessLog
				SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
									WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
									WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
								END, 
					ProcessCompletedDate = getdate()
				WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportB2BCustomer @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportB2BCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategory')
	DROP PROC Znode_ImportCatalogCategory
GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategory](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Catalog Category Product association
	
	-- Unit Testing : 
	--BEGIN TRANSACTION;
	--update ZnodeGlobalSetting set FeatureValues = '5' WHERE FeatureName = 'InventoryRoundOff' 
	--    DECLARE @status INT;
	--    EXEC [Znode_ImportInventory] @InventoryXML = '<ArrayOfImportInventoryModel>
	-- <ImportInventoryModel>
	--   <SKU>S1002</SKU>
	--   <Quantity>999998.33</Quantity>
	--   <ReOrderLevel>10</ReOrderLevel>
	--   <RowNumber>1</RowNumber>
	--   <ListCode>TestInventory</ListCode>
	--   <ListName>TestInventory</ListName>
	-- </ImportInventoryModel>
	--</ArrayOfImportInventoryModel>' , @status = @status OUT , @UserId = 2;
	--    SELECT @status;
	--    ROLLBACK TRANSACTION;
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertCatalogCategory TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, SKU varchar(300), CategoryCode varchar(200), DisplayOrder int, IsActive varchar(10), GUID nvarchar(400)
			--,Index Ind_SKU1 (SKU),Index Ind_CategoryName (CategoryName)
		);

		DECLARE @CategoryAttributId int;

		SET @CategoryAttributId =
		(
			SELECT TOP 1 PimAttributeId
			FROM ZnodePimAttribute AS ZPA
			WHERE ZPA.AttributeCode = 'CategoryCode' AND 
				  ZPA.IsCategory = 1
		);

		DECLARE @InventoryListId int;

		SET @SSQL = 'Select RowNumber,trim(SKU),CategoryCode,DisplayOrder ,IsActive,GUID FROM '+@TableName;
		INSERT INTO @InsertCatalogCategory( RowNumber, SKU, CategoryCode, DisplayOrder, IsActive, GUID )
		EXEC sys.sp_sqlexec @SSQL;

		----Removing Duplicate data
		;with cte as
		(
			select SKU, CategoryCode,max(RowNumber) as RowNumber from @InsertCatalogCategory
			group by SKU, CategoryCode
		)
		delete a from @InsertCatalogCategory a
		where  not exists (select * from CTE b where a.RowNumber = b.RowNumber )

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @SKU TABLE
		( 
		   SKU nvarchar(300), PimProductId INT--, Index Ins_SKU (SKU)
		);
		INSERT INTO @SKU
			   SELECT b.AttributeValue, a.PimProductId
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;

		Declare @PimCategoryAttributeId int 
		set @PimCategoryAttributeId = (select top 1 PimAttributeId from ZnodePimAttribute where AttributeCode = 'CategoryCode')

		DECLARE @CategoryCode TABLE
		( 
			CategoryCode nvarchar(300), PimCategoryId int --index ind_101 (CategoryName)
		);
		INSERT INTO @CategoryCode
			   SELECT ZPCAL.CategoryValue, ZPCA.PimCategoryId
			   FROM ZnodePimCategoryAttributeValue AS ZPCA
					INNER JOIN
					ZnodePimCategoryAttributeValueLocale AS ZPCAL
					ON ZPCA.PimAttributeId = @PimCategoryAttributeId AND 
					ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId;
					
		-- start Functional Validation 
		
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '19', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertCatalogCategory AS ii
			   WHERE ii.SKU NOT in 
			   (
				   SELECT SKU FROM @SKU  where SKU IS NOT NULL 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '19', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertCatalogCategory AS ii
			   WHERE ii.CategoryCode NOT IN 
			   (
				   SELECT CategoryCode FROM @CategoryCode  where CategoryCode IS NOT NULL 
			   );
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertCatalogCategory AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertCatalogCategory AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		  SELECT '35', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		  FROM @InsertCatalogCategory AS ii  
		  WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No')

		  
		
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ CategoryCode - ' + ISNULL(CategoryCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertCatalogCategory IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertCatalogCategory
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber IS NOT NULL 
			--AND GUID = @NewGUID
		);

	
		
			  Declare @ZnodePimCategoryProduct TABLE (PimProductId int , PimCategoryId int , Status bit , DisplayOrder int) 
			  	
			  insert into @ZnodePimCategoryProduct (PimProductId , PimCategoryId , Status , DisplayOrder )
			  SELECT SKU.PimProductId, (Select top 1 PimCategoryId from @CategoryCode where ICC.CategoryCode = CategoryCode )  PimCategoryId
				 , CASE WHEN IsActive in ('True','1','Yes') Then 1 ELSE 0 END , DisplayOrder FROM @InsertCatalogCategory AS ICC INNER JOIN	 @SKU AS SKU ON ICC.SKU = SKU.SKU 
			
			  INSERT into ZnodePimCategoryProduct ( PimProductId, PimCategoryId, Status, DisplayOrder, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate) 
			  Select TABL.PimProductId, TABL.PimCategoryId, TABL.Status, TABL.DisplayOrder,@UserId, @GetDate, @UserId, @GetDate   from @ZnodePimCategoryProduct TABL    
			  Where NOT EXISTS (Select top 1 1 from ZnodePimCategoryProduct ZPCP where ZPCP.PimProductId = TABL.PimProductId and  ZPCP.PimCategoryId = TABL.PimCategoryId)

		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertCatalogCategory
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
 
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategory @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCatalogCategory',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO


CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';
		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'Customer'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 

		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	BIT	,ReferralStatus	NVARCHAR(40),IsActive	BIT	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;
				
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '88', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' and  exists
		(
			SELECT top 1 1 FROM  AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN ZnodeAccount ZA on  ZU.AccountId = ZA.AccountId
		WHERE ANZU.UserName = ii.UserName and  ZA.AccountCode != ii.AccountCode
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '92', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> '' and  ISNULL(LTRIM(RTRIM(ii.RoleName)),'') IN ('User','Manager','Administrator')
		AND EXISTS(SELECT * FROM ZnodeUser a INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				--INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)						
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				INNER JOIN AspNetRoles ZD on u.RoleId = zd.Id
				WHERE (ii.UserName = c.UserName) and ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> ZD.Name )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))
				

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, ANU.LockoutEndDateUtc = case when IC.IsActive = 0 then @GetDate when IC.IsActive = 1 then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= Isnull(IC.EmailOptIn,0),
				ZU.IsActive		= IC.IsActive,
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive = 0 then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
				
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,Isnull(IC.EmailOptIn,0),IC.IsActive,IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
				  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> ''
				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''

				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> ''
				
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, ZD.Id as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)
				AND isnull(IC.RoleName,'') <> ''


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomerAddress')
	DROP PROC Znode_ImportCustomerAddress
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomerAddress](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @LocaleId int= 0,@PortalId int ,@CsvColumnString nvarchar(max), @IsAccountAddress bit = 0 )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@IsAllowGlobalLevelUserCreation NVARCHAR(10)

		DECLARE @GETDATE DATETIME= dbo.Fn_GETDATE();
		-- Retrive Value FROM global setting 
		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'
		-- Three type of import required three table varible for product , category AND brand

		CREATE TABLE #InsertCustomerAddress 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT,UserName NVARCHAR(512),FirstName VARCHAR(300),
			LastName VARCHAR(300),DisplayName NVARCHAR(1200),Address1 VARCHAR(300),Address2 VARCHAR(300),
			CountryName VARCHAR(3000),StateName VARCHAR(3000),CityName VARCHAR(3000),PostalCode VARCHAR(50),
			PhoneNumber VARCHAR(50),IsDefaultBilling BIT,IsDefaultShipping BIT	,IsActive BIT,ExternalId NVARCHAR(2000),
			CompanyName NVARCHAR(2000), GUID NVARCHAR(400)
		);
	
		SET @SSQL = ' INSERT INTO #InsertCustomerAddress ( RowNumber, ' + @CsvColumnString + ' ,GUID )
		SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		EXEC sys.sp_sqlexec @SSQL;

		-- start Functional Validation 
		----------------------------------------------
		IF (@IsAccountAddress = 0)
		BEGIN
			IF @IsAllowGlobalLevelUserCreation = 'true'
					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
						   SELECT '19', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
						   FROM #InsertCustomerAddress AS ii
						   WHERE ii.UserName NOT IN 
						   (
							   SELECT UserName FROM AspNetZnodeUser   WHERE PortalId = @PortalId
						   );
			ELSE 
					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
						   SELECT '19', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
						   FROM #InsertCustomerAddress AS ii
						   WHERE ii.UserName NOT IN 
						   (
							   SELECT UserName FROM AspNetZnodeUser   
						   );

					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
							SELECT '8', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
							FROM #InsertCustomerAddress AS ii
							WHERE ISNULL(ltrim(rtrim(ii.UserName)), '') = ''

		 END

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeState ZS INNER JOIN ZnodeCountry ZC ON ZS.CountryCode = ZC.CountryCode
			where ii.CountryName = ZC.CountryName AND ZS.StateName = ISNULL(ltrim(rtrim(ii.StateName)), ''))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeCountry ZC WHERE ZC.CountryName = ISNULL(ltrim(rtrim(ii.CountryName)), '') )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '90', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE ISNULL(ltrim(rtrim(ii.CountryName)), '') <> ''
		AND NOT EXISTS(SELECT * FROM ZnodePortalCountry ZPC INNER JOIN ZnodeCountry ZC ON ZPC.CountryCode = ZC.CountryCode
		    WHERE PortalId = @PortalId AND ltrim(rtrim(ii.CountryName)) = ltrim(rtrim(ZC.CountryName)))

		 -- error log when atleast db have 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '63', 'IsDefaultBilling/IsDefaultShipping', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress IC WHERE  exists (
		SELECT TOP 1 1  FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		where ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
		AND ZA.IsDefaultShipping =IC.IsDefaultShipping )

		--Note : Content page import is not required 
		
		-- End Function Validation 	
		-----------------------------------------------
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomerAddress IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		DELETE FROM #InsertCustomerAddress
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber IS NOT NULL 
			--AND GUID = @NewGUID
		);

		UPDATE ZA SET ZA.IsDefaultBilling = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName --and IC.IsDefaultBilling <> ZA.IsDefaultBilling 
		where IC.IsDefaultBilling = 1 

		UPDATE ZA SET ZA.IsDefaultShipping = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName
		where IC.IsDefaultShipping = 1 

		DELETE FROM ZnodeImportLog  WHERE ImportProcessLogId = @ImportProcessLogId AND  ErrorDescription = '63'
		-- UPDATE Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomerAddress
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
		
		DELETE FROM #InsertCustomerAddress 
		WHERE NOT EXISTS
			(SELECT TOP 1 1 FROM 
				(
					SELECT ROW_NUMBER() OVER(PARTITION BY UserName	
					,FirstName	,LastName	,DisplayName	,Address1	,Address2	
					,CountryName	,StateName	,CityName	,PostalCode	
					,PhoneNumber	,IsDefaultBilling,IsDefaultShipping,ExternalId	,CompanyName ORDER BY RowId desc) 
					AS rw_nmbr,RowId  FROM #InsertCustomerAddress 
				) abc WHERE rw_nmbr =1 AND abc.RowId = #InsertCustomerAddress.RowId
			)

		----------UPDATE ZnodeAddress
		DECLARE @AddressColumnString VARCHAR(1000), @WhereConditionString VARCHAR(1000), @UpdateColumnString VARCHAR(1000)

		SELECT @AddressColumnString = COALESCE(@AddressColumnString + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' AND ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
		FROM ZnodeImportUpdatableColumns a
		INNER JOIN INFORMATION_SCHEMA.COLUMNS b ON a.ColumnName = b.COLUMN_NAME  
		INNER JOIN dbo.Split(@CsvColumnString,',')C ON b.COLUMN_NAME = c.Item
		WHERE b.TABLE_NAME = 'ZnodeAddress' 
		AND EXISTS(SELECT * FROM ZnodeImportHead IH WHERE a.ImportHeadId = IH.ImportHeadId AND IH.Name in ('CustomerAddress','ShippingAddress'))

		SELECT @UpdateColumnString = COALESCE(@UpdateColumnString + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
		FROM INFORMATION_SCHEMA.COLUMNS a
		INNER JOIN dbo.Split(@CsvColumnString,',')b ON a.COLUMN_NAME = b.Item
		WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString,',') c WHERE a.COLUMN_NAME = c.Item )
		AND a.TABLE_NAME = 'ZnodeAddress'

		SELECT @WhereConditionString = COALESCE(@WhereConditionString + ' AND ', '') +'ZA.'+item+' =  IC.'+item FROM dbo.split(@AddressColumnString,',')
		SET @WhereConditionString = Replace(@WhereConditionString , 'ZA.Address2 =  IC.Address2', 'ISNULL(ZA.Address2 ,'''')=  ISNULL(IC.Address2 ,'''')') 
		
		UPDATE a SET a.StateName =c.StateCode  
		FROM #InsertCustomerAddress a 
		INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		INNER JOIN ZnodeState c ON b.CountryCode = c.CountryCode AND C.StateName = a.StateName
		
		UPDATE a SET a.CountryName= b.CountryCode FROM  #InsertCustomerAddress a INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		
		CREATE TABLE #InsertedUserAddress (AddressId  NVARCHAR(256), UserId NVARCHAR(max)) 

		IF ( @IsAccountAddress = 1 )
		BEGIN
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU 
			INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
													AND ZA.IsDefaultShipping =IC.IsDefaultShipping

					SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END

			EXEC (@SSQL)

					SET @SSQL = '
					Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
											StateName,CityName,PostalCode,PhoneNumber,
											IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
					OUTPUT INSERTED.AddressId INTO  #InsertedUserAddress (AddressId) 			 
					SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,null,IC.CountryName ,
					IC.StateName,
					,IC.CityName,IC.PostalCode,IC.PhoneNumber,
					isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(), 1, 1
					FROM  #InsertCustomerAddress IC
					WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'

			EXEC (@SSQL)

			DECLARE @AccountId INT
			SELECT @AccountId = AccountId FROM ZnodeUser WHERE UserId = @UserId
			INSERT INTO ZnodeAccountAddress ( AccountId, AddressId, CreatedBy, CreatedDate,	ModifiedBy,	ModifiedDate )
			SELECT @AccountId, Addressid ,  @UserId , @GETDATE, @UserId , @GETDATE FROM #InsertedUserAddress UA
			WHERE NOT EXISTS ( SELECT * FROM ZnodeAccountAddress AA WHERE AccountId = @AccountId AND AA.Addressid = UA.Addressid )
		END
		ELSE
		BEGIN
		
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
			AND ZA.IsDefaultShipping =IC.IsDefaultShipping
					
					SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA 
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END
						
					Print @SSQL
					EXEC (@SSQL)
									
					SET @SSQL = '
					Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
												StateName,CityName,PostalCode,PhoneNumber,
												IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
					OUTPUT INSERTED.AddressId, INSERTED.Address3 INTO  #InsertedUserAddress (AddressId, UserId ) 			 
					SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,convert(nvarchar(100),ZU.UserId),IC.CountryName ,
					IC.StateName 
					,IC.CityName,IC.PostalCode,IC.PhoneNumber,
					isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(),1,1
					FROM AspNetZnodeUser ANZU 
					INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
					INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
					INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName 
					WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'
					print @SSQL
					EXEC (@SSQL)

			INSERT INTO ZnodeUserAddress(UserId,AddressId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT CAST( UserId AS INT ) , Addressid , @UserId , @GETDATE, @UserId , @GETDATE FROM  #InsertedUserAddress
		END
				
		UPDATE ZA SET ZA.CountryName = ZC.CountryCode
		FROM ZnodeAddress ZA
		INNER JOIN ZnodeCountry ZC ON ltrim(rtrim(ZA.CountryName)) = ltrim(rtrim(ZC.CountryName))

		UPDATE ZA SET ZA.Address3 = null 
		FROM ZnodeAddress ZA INNER JOIN #InsertedUserAddress IUA ON ZA.AddressId = IUA.AddressId 

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomerAddress @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) +',@IsAccountAddress='+CAST(@IsAccountAddress AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GETDATE
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId

		--Updating total AND fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomerAddress',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportHighlight')
	DROP PROC Znode_ImportHighlight
GO


CREATE PROCEDURE [dbo].[Znode_ImportHighlight](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			RowNumber int, HighlightCode varchar(300), HighlightName varchar(1000),DisplayPopup varchar(300),Hyperlink varchar(1000),HighlightType varchar(300),IsActive varchar(100),DisplayOrder int,HighlightImage varchar(500),HighlightImagePath varchar(500), Description varchar(max), ShortDescription varchar(max), ImageAltTag varchar(400), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID)
		EXEC sys.sp_sqlexec @SSQL;


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @HighlightAttributeDefaultCode TABLE
		( 
		   AttributeDefaultCode nvarchar(300)
		);
		INSERT INTO @HighlightAttributeDefaultCode
			   SELECT AttributeDefaultValueCode
			   FROM ZnodePimAttributeDefaultValue ZPADV
			   inner join ZnodePimAttribute ZPA on ZPADV.PimAttributeId = ZPA.PimAttributeId
			   where ZPA.AttributeCode = 'Highlights' 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '9', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode not in 
			   (
				   SELECT AttributeDefaultCode FROM @HighlightAttributeDefaultCode 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '35', 'DisplayPopup', DisplayPopup, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.DisplayPopup not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '35', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '19', 'HighlightType', HighlightType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightType NOT in 
			   (
				   SELECT HT.Name  FROM ZnodeHighlightType  HT
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '35', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.HighlightCode,''))) like '% %' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode in 
			   (
				   select HighlightCode  FROM @InsertPimAtrribute  Group BY HighlightCode  having count(*) > 1 
			   );

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Highlight - ' + ISNULL(HighlightCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName and IPA.HighlightImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName)

		DECLARE @InsertedZnodeHighlight TABLE(HighlightId INT,HighlightCode VARCHAR(600)) 

			UPDATE ZH SET ZH.DisplayPopup = IPA.DisplayPopup, ZH.Hyperlink = IPA.Hyperlink, ZH.IsActive = case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end,
			       ZH.DisplayOrder = IPA.DisplayOrder , ZH.ModifiedBy = @UserId, ZH.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId

			UPDATE ZHL SET ZHL.Name = IPA.HighlightName, ZHL.Description = IPA.Description, ZHL.ShortDescription = IPA.ShortDescription, ZHL.ImageAltTag = IPA.ImageAltTag
			       , ZHL.ModifiedBy = @UserId, ZHL.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId
			INNER JOIN ZnodeHighlightLocale ZHL  ON ZH.HighlightId = ZHL.HighlightId 

			INSERT INTO ZnodeHighlight (MediaId,HighlightCode,DisplayPopup,Hyperlink,HighlightTypeId,IsActive,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			OUTPUT Inserted.HighlightId,Inserted.HighlightCode INTO @InsertedZnodeHighlight
			SELECT DISTINCT @MediaId,IPA.HighlightCode, IPA.DisplayPopup , IPA.Hyperlink, ZHT.HighlightTypeId,
				   case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end, Case when Isnull(IPA.DisplayOrder,0) = 0 then  999 else IPA.DisplayOrder end  , @UserId , @GetDate ,@UserId , @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			WHERE NOT EXISTS(select * from ZnodeHighlight ZH where ZH.HighlightCode = IPA.HighlightCode and ZH.HighlightTypeId = ZHT.HighlightTypeId)

			INSERT INTO ZnodeHighlightLocale(LocaleId,HighlightId,ImageAltTag,Name,Description,ShortDescription,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT @LocaleId, IZH.HighlightId, IPA.ImageAltTag, IPA.HighlightName, IPA.Description, IPA.ShortDescription, @UserId , @GetDate ,@UserId , @GetDate
			FROM @InsertPimAtrribute IPA 
			INNER JOIN @InsertedZnodeHighlight IZH on IPA.HighlightCode = IZH.HighlightCode 


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportHighlight @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportHighlight',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportInventory_Ver1')
	DROP PROC Znode_ImportInventory_Ver1
GO



CREATE PROCEDURE [dbo].[Znode_ImportInventory_Ver1](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Inventory data 
	--		   Input data in XML format Validate data with all scenario 
	-- Unit Testing : 
	--BEGIN TRANSACTION;
	--update ZnodeGlobalSetting set FeatureValues = '5' WHERE FeatureName = 'InventoryRoundOff' 
	--    DECLARE @status INT;
	--    EXEC [Znode_ImportInventory] @InventoryXML = '<ArrayOfImportInventoryModel>
	-- <ImportInventoryModel>
	--   <SKU>S1002</SKU>
	--   <Quantity>999998.33</Quantity>
	--   <ReOrderLevel>10</ReOrderLevel>
	--   <RowNumber>1</RowNumber>
	--   <ListCode>TestInventory</ListCode>
	--   <ListName>TestInventory</ListName>
	-- </ImportInventoryModel>
	--</ArrayOfImportInventoryModel>' , @status = @status OUT , @UserId = 2;
	--    SELECT @status;
	--    ROLLBACK TRANSACTION;
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @RoundOffValue int, @MessageDisplay nvarchar(100), @MessageDisplayForFloat nvarchar(100);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		-- Retrive RoundOff Value from global setting 
		SELECT @RoundOffValue = FeatureValues
		FROM ZnodeGlobalSetting
		WHERE FeatureName = 'InventoryRoundOff';
		
		IF OBJECT_ID('tempdb.dbo.#InserInventoryForValidation', 'U') IS NOT NULL 
		DROP TABLE tempdb.dbo.#InserInventoryForValidation
		
		IF OBJECT_ID('tempdb.dbo.#InsertInventory ', 'U') IS NOT NULL 
		DROP TABLE tempdb.dbo.#InsertInventory 

		--@MessageDisplay will use to display validate message for input inventory value  

		DECLARE @sSql nvarchar(max);
		SET @sSql = ' Select @MessageDisplay_new = Convert(Numeric(28, '+CONVERT(nvarchar(200), @RoundOffValue)+'), 123.12345699 ) ';
		EXEC SP_EXecutesql @sSql, N'@MessageDisplay_new NVARCHAR(100) OUT', @MessageDisplay_new = @MessageDisplay OUT;
		SET @sSql = ' Select @MessageDisplay_new = Convert(Numeric(28, '+CONVERT(nvarchar(200), @RoundOffValue)+'), 0.999999 ) ';
		EXEC SP_EXecutesql @sSql, N'@MessageDisplay_new NVARCHAR(100) OUT', @MessageDisplay_new = @MessageDisplayForFloat OUT;
		Create TABLE tempdb..#InserInventoryForValidation 
		( 
				RowNumber int, SKU varchar(600), Quantity varchar(100), ReOrderLevel varchar(100), WarehouseCode varchar(300), GUID nvarchar(200)
		);

		CREATE INDEX IDX_#InserInventoryForValidation_SKU ON #InserInventoryForValidation(SKU)
		
		DECLARE @InventoryListId int;
		SET @SSQL = 'Select RowNumber,SKU,Quantity,ReOrderLevel,WarehouseCode ,GUID FROM '+@TableName;
		INSERT INTO tempdb..#InserInventoryForValidation( RowNumber, SKU, Quantity, ReOrderLevel, WarehouseCode, GUID )
		EXEC sys.sp_sqlexec @SSQL;
		

		UPDATE tempdb..#InserInventoryForValidation
		  SET ReOrderLevel = 0
		WHERE ISNULL(ReOrderLevel,'') = '';

		-- start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '19', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM tempdb..#InserInventoryForValidation  AS ii
		WHERE NOT EXISTS( SELECT * FROM ZnodePimAttributeValue  AS a with(nolock)
			INNER JOIN ZnodePimAttributeValueLocale AS b with(nolock) ON a.PimAttributeValueId = b.PimAttributeValueId
			WHERE exists(Select top 1 PimAttributeId from ZnodePimAttribute zpa Where zpa.AttributeCode = 'SKU' and a.PimAttributeId = zpa.PimAttributeId)
			AND b.AttributeValue = ii.SKU);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '19', 'WarehouseCode', WarehouseCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM tempdb..#InserInventoryForValidation  AS ii
		WHERE NOT EXISTS ( SELECT TOP 1 1 FROM ZnodeWarehouse AS zw WHERE zw.WarehouseCode = ii.WarehouseCode );

		UPDATE ZIL SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InserInventoryForValidation IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  
		DELETE FROM tempdb..#InserInventoryForValidation 
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  GUID = @NewGUID
		);
		
		DECLARE @TBL_ReadyToInsertInventory TABLE
		( 
			RowNumber int, SKU varchar(300), Quantity numeric(28, 6), ReOrderLevel numeric(28, 6), WarehouseId int
		);

		--deleting duplicate rows
		delete  ii
		FROM tempdb..#InserInventoryForValidation  ii
		where ii.RowNumber not IN
			   (
				   SELECT MAX(ii1.RowNumber)
				   FROM tempdb..#InserInventoryForValidation  AS ii1
				   WHERE ii1.WarehouseCode = ii.WarehouseCode AND 
						 ii1.SKU = ii.SKU
			   );

		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InserInventoryForValidation
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
		   	
		
		--select 'update started'  
		UPDATE zi SET Quantity = rtii.Quantity, ReOrderLevel = ISNULL(rtii.ReOrderLevel, 0), ModifiedBy = @UserId, ModifiedDate = @GetDate
		FROM ZNodeInventory zi
		INNER JOIN #InserInventoryForValidation rtii ON( zi.SKU = rtii.SKU )
		INNER JOIN ZnodeWarehouse AS zw ON rtii.WarehouseCode = zw.WarehouseCode and zi.WarehouseId = zw.WarehouseId;
			   
		--select 'update End'                
		INSERT INTO ZnodeInventory( WarehouseId, SKU, Quantity, ReOrderLevel, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
		SELECT zw.WarehouseId, SKU, Quantity, ISNULL(ReOrderLevel, 0), @UserId, @GetDate, @UserId, @GetDate
		FROM #InserInventoryForValidation AS rtii
		INNER JOIN ZnodeWarehouse AS zw on rtii.WarehouseCode = zw.WarehouseCode
		WHERE NOT EXISTS ( SELECT TOP 1 1 FROM ZnodeInventory AS zi WHERE zi.WarehouseId = zw.WarehouseId AND zi.SKU = rtii.SKU );
		 
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH

		ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportInventory_Ver1 @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportInventory_Ver1',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPartialPimProductData')
	DROP PROC Znode_ImportPartialPimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportPartialPimProductData]
(   @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         NVARCHAR(200),
    @ImportProcessLogId INT,
    @UserId             INT,
    @LocaleId           INT,
    @DefaultFamilyId    INT)
AS
    
	/*
      Summary : Finally Import data into ZnodePimProduct, ZnodePimAttributeValue and ZnodePimAttributeValueLocale Table 
      Process : Flat global temporary table will split into cloumn wise and associted with Znode Attributecodes,
    		      Create group of product with their attribute code and values and inserted one by one products. 	   
    
      SourceColumnName : CSV file column headers
      TargetColumnName : Attributecode from ZnodePimAttribute Table 

	 ***  Need to log error if transaction failed during insertion of records into table.
    */

     BEGIN
		 SET NOCOUNT ON
         BEGIN TRY
             --BEGIN TRAN ImportProducts;
             DECLARE @SQLQuery NVARCHAR(MAX);
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @PimAttributeFamilyId INT, @NewProductId INT, @PimAttributeValueId INT, @status BIT= 0; 
             --Declare error Log Table 


			 DECLARE @FamilyAttributeDetail TABLE
			 ( 
				PimAttributeId int, AttributeTypeName varchar(300), AttributeCode varchar(300), SourceColumnName nvarchar(600), IsRequired bit, PimAttributeFamilyId int
			 );
			 SET @DefaultFamilyId = 0 
             IF @DefaultFamilyId = 0
                 BEGIN
					INSERT INTO @FamilyAttributeDetail( PimAttributeId, AttributeTypeName, AttributeCode, SourceColumnName, IsRequired, PimAttributeFamilyId )
					--Call Process to insert data of defeult family with cource column name and target column name 
					--EXEC Znode_ImportGetTemplateDetails @TemplateId = @TemplateId, @IsValidationRules = 0, @IsIncludeRespectiveFamily = 1,@DefaultFamilyId = @DefaultFamilyId;
                    --UPDATE @FamilyAttributeDetail SET PimAttributeFamilyId = DBO.Fn_GetCategoryDefaultFamilyId();
					SELECT distinct zpa.PimAttributeId, zat.AttributeTypeName, zpa.AttributeCode, zitm.SourceColumnName, zpa.IsRequired ,0
					FROM dbo.ZnodePimAttribute AS zpa INNER JOIN dbo.ZnodeAttributeType AS zat ON zat.AttributeTypeId = zpa.AttributeTypeId 
					LEFT OUTER JOIN dbo.ZnodeImportTemplateMapping AS zitm
					ON zpa.AttributeCode = zitm.SourceColumnName AND zitm.ImportTemplateId = @TemplateId
					WHERE zpa.IsCategory = 0 

                 END;
             --Read all attribute details with their datatype 
			 IF NOT EXISTS(SELECT TOP 1 1 FROM INFORMATION_SCHEMA.TABLES WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeValue')
				BEGIN
					   CREATE TABLE #DefaultAttributeValue (AttributeTypeName  VARCHAR(300),PimAttributeDefaultValueId INT,PimAttributeId INT,
					   AttributeDefaultValueCode  VARCHAR(100));
					   -- ELSE 
					   -- CREATE TABLE #DefaultAttributeValue (AttributeTypeName  VARCHAR(300),PimAttributeDefaultValueId INT,PimAttributeId INT,
					   -- AttributeDefaultValueCode  VARCHAR(100)
					   -- Index Ix_Default (PimAttributeId, AttributeDefaultValueCode));
					   --IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
					   --Begin
						  --Select 'Without Index'
					   --END
					   --Else
						  --Alter TABLE #DefaultAttributeValue ADD Index Ix_Default (PimAttributeId, AttributeDefaultValueCode);
					


					INSERT INTO #DefaultAttributeValue(AttributeTypeName,PimAttributeDefaultValueId,PimAttributeId,AttributeDefaultValueCode)
					--Call Process to insert default data value 
					EXEC Znode_ImportGetPimAttributeDefaultValue;
				END;
             ELSE
                BEGIN
                    DROP TABLE #DefaultAttributeValue;
                END;
             EXEC sys.sp_sqlexec
                  @SQLQuery;
          
             -- Split horizontal table into verticle table by column name and attribute Value with their 
             -- corresponding AttributeId, Default family , Default AttributeValue Id  
    --         DECLARE @PimProductDetail TABLE 
			 --(
			      
				-- PimAttributeId INT, PimAttributeFamilyId INT,ProductAttributeCode VARCHAR(300) NULL,
				--  ProductAttributeDefaultValueId INT NULL,PimAttributeValueId  INT NULL,LocaleId INT,
				--  PimProductId INT NULL,AttributeValue NVARCHAR(MAX) NULL,AssociatedProducts NVARCHAR(4000) NULL,ConfigureAttributeIds VARCHAR(2000) NULL,
				--  ConfigureFamilyIds VARCHAR(2000) NULL,RowNumber INT  INDEX Ix CLUSTERED (RowNumber) 
    --            );

			DECLARE @PimProductDetail TABLE 
			 (
			      
				  PimAttributeId INT, PimAttributeFamilyId INT,ProductAttributeCode VARCHAR(300) NULL,
				  ProductAttributeDefaultValueId INT NULL,PimAttributeValueId  INT NULL,LocaleId INT,
				  PimProductId INT NULL,AttributeValue NVARCHAR(MAX) NULL,AssociatedProducts NVARCHAR(4000) NULL,ConfigureAttributeIds VARCHAR(2000) NULL,
				  ConfigureFamilyIds VARCHAR(2000) NULL,RowNumber INT  
                );

		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				
		SET @SQLQuery = ' insert into ZnodeImportSuccessLog (ImportedSku,ImportedProductId,ImportedGuId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
		Select SKU, PimProductId , ''' + @NewGUID  + ''', '+ Convert(nvarchar(100),@UserId) +',''' + 
		Convert(nvarchar(100),@GetDate) + ''', '+ Convert(nvarchar(100),@UserId) +',''' + 
		Convert(nvarchar(100),@GetDate) + ''' from ' + @TableName ;
		EXEC	sp_executesql @SQLQuery

		SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
		EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount
		
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
			TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

			
             -- Column wise split data from source table ( global temporary table ) and inserted into temporary table variable @PimProductDetail
             -- Add PimAttributeDefaultValue 
             DECLARE Cr_AttributeDetails CURSOR LOCAL FAST_FORWARD
             FOR SELECT PimAttributeId,AttributeTypeName,AttributeCode,IsRequired,SourceColumnName,PimAttributeFamilyId FROM @FamilyAttributeDetail  WHERE ISNULL(SourceColumnName, '') <> '';
             OPEN Cr_AttributeDetails;
             FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
             WHILE @@FETCH_STATUS = 0
                 BEGIN
                    SET @NewProductId = 0;
                    SET @SQLQuery = ' SELECT '''+CONVERT(VARCHAR(100), @PimAttributeFamilyId)+''' PimAttributeFamilyId , PimProductId PimProductId ,'''+CONVERT(VARCHAR(100), @AttributeId)+''' AttributeId ,
									(SELECT TOP 1  PimAttributeDefaultValueId FROM #DefaultAttributeValue Where PimAttributeId =  '
									+ CONVERT(VARCHAR(100), @AttributeId)+'AND  AttributeDefaultValueCode = TN.['+@SourceColumnName+'] ) PimAttributeDefaultValueId ,['
									+ @SourceColumnName+'],'+CONVERT(VARCHAR(100), @LocaleId)+'LocaleId
									
									, RowNumber FROM '+@TableName+' TN';
                    INSERT INTO @PimProductDetail( PimAttributeFamilyId, PimProductId, PimAttributeId, ProductAttributeDefaultValueId, AttributeValue, LocaleId, RowNumber )
					EXEC sys.sp_sqlexec @SQLQuery;
                    FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
                 END;
             CLOSE Cr_AttributeDetails;
             DEALLOCATE Cr_AttributeDetails;
			 Select * into #PimProductDetail from @PimProductDetail
			 UPDATE a 
			 SET ConfigureAttributeIds =  SUBSTRING((SELECT ','+CAST(c.PimAttributeId As VARCHAR(100)) 
			 FROM #PimProductDetail c 
			 INNER JOIN ZnodePimAttribute b ON (b.PimAttributeId = c.PimAttributeId)
			 WHERE IsConfigurable =1  AND c.RowNumber = a.RowNumber  FOR XML PATH('')),2,4000) 
			 FROM #PimProductDetail a 
			 WHERE EXISTS (SELECT TOP 1 1 FROM #PimProductDetail ab  WHERE ab.RowNumber = a.RowNumber AND	ab.ProductAttributeCode = 'ProductType' 
			 AND ab.AttributeValue = 'ConfigurableProduct' )

             -- In case of Yes/No : If value is not TRUE OR  1 then it will be  False else True
			 --If default Value set not need of hard code for IsActive
			 UPDATE ppdti SET ppdti.AttributeValue = CASE WHEN Upper(ISNULL(ppdti.AttributeValue, '')) in ( 'Yes','TRUE','1')  THEN 'true'  ELSE 'false' END FROM #PimProductDetail ppdti
                INNER JOIN #DefaultAttributeValue dav ON ppdti.PimAttributeId = dav.PimAttributeId WHERE   dav.AttributeTypeName = 'Yes/No';
             -- Pass product records one by one 
             DECLARE @IncrementalId INT= 1;
             DECLARE @SequenceId INT=
             (
                 SELECT MAX(RowNumber) FROM #PimProductDetail
             );
             DECLARE @PimProductDetailToInsert PIMPRODUCTDETAIL;  --User define table type to pass multiple records of product in single step
		

             WHILE @IncrementalId <= @SequenceId
                 BEGIN
					   	INSERT INTO @PimProductDetailToInsert(PimAttributeId,PimAttributeFamilyId,ProductAttributeCode,ProductAttributeDefaultValueId,
						PimAttributeValueId,LocaleId,PimProductId,AttributeValue,AssociatedProducts,ConfigureAttributeIds,ConfigureFamilyIds)
						SELECT PimAttributeId,PimAttributeFamilyId,ProductAttributeCode,ProductAttributeDefaultValueId,PimAttributeValueId,LocaleId,
						PimProductId,AttributeValue,AssociatedProducts,ConfigureAttributeIds,ConfigureFamilyIds FROM #PimProductDetail
						WHERE [#PimProductDetail].RowNumber = @IncrementalId; --AND RTRIM(LTRIM(AttributeValue)) <> '';

						Delete from @PimProductDetailToInsert where RTRIM(LTRIM(AttributeValue)) = '';
	                    --ORDER BY [@PimProductDetail].RowNumber;
                        ----Call process to finally insert data into 
                        ----------------------------------------------------------
						--1. [dbo].[ZnodePimProduct]
						--2. [dbo].[ZnodePimAttributeValue]
						--3. [dbo].[ZnodePimAttributeValueLocale]
						if Exists (select TOP 1 1 from @PimProductDetailToInsert)
							EXEC [Znode_ImportPartialInsertUpdatePimProduct] @PimProductDetail = @PimProductDetailToInsert,@UserID = @UserID,@status = @status OUT,@IsNotReturnOutput = 1;
				
						DELETE FROM @PimProductDetailToInsert;
						SET @IncrementalId = @IncrementalId + 1;
					
                 END;
        --Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;
            -- COMMIT TRAN ImportProducts;
         END TRY
         BEGIN CATCH

		 SELECT ERROR_MESSAGE(),ERROR_LINE(),ERROR_PROCEDURE();

			 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPartialPimProductData @TableName = '+CAST(@TableName AS VARCHAR(max))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200)) +',@TemplateId='+CAST(@TemplateId AS VARCHAR(200)) +',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(10))+',@DefaultFamilyId='+CAST(@DefaultFamilyId AS VARCHAR(200));
            ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportPartialPimProductData',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
             
            
            
			-- ROLLBACK TRAN ImportProducts;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPartialValidatePimProductData')
	DROP PROC Znode_ImportPartialValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportPartialValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0  
)
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct ( for partial attribute import ) 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max), @FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
              --To get the total record count for update purpose in catch block
             SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			 INSERT INTO Znode_ImportCsvRowCount
			 EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;
		  -- If Exists ( Select  count(1)  from #GlobalTempTableColumns GROUP BY ColumnName  Having count(1) > 1 )
		  -- Begin
			 --   INSERT INTO ZnodeImportLog(ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
    --               Select  46,ColumnName,'',@newGUID,@UserId,@GetDate,@UserId,@GetDate, @ImportProcessLogId  from #GlobalTempTableColumns GROUP BY ColumnName  Having count(1) > 1 
				
				----'Multiple occurance of column are not allow for'
		  -- END

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();
             --Remove old error log 
             --DELETE FROM ZnodeImportLog WHERE ImportProcessLogId in (select ImportProcessLogId  FROM ZnodeImportProcessLog  WHERE ImportTemplateId  = @TemplateId )
             --GUID = @NewGUID;
             --Delete FROM ZnodeImportProcessLog  WHERE ImportTemplateId  = @TemplateId 
		
             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'ProductUpdate'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END



			--Retrive PimProductId on the basis of SKU for update product 
			SET @SQLQuery = 'UPDATE tlb SET tlb.PimProductId = ZPAV.PimProductId 
							FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
							(ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId) 
							INNER JOIN [dbo].[ZnodePimAttribute] ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId AND ZPA.AttributeCode= ''SKU'' 
							INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = ltrim(rtrim(tlb.SKU)) ';
			EXEC sys.sp_sqlexec	@SQLQuery	 	
	
			SET @SQLQuery = 'Select 19 ,''SKU'', SKU, '''+ @newGUID + ''',' + Convert(nvarchar(100),@UserId) + ',''' +  Convert(nvarchar(100),@GetDate) + ''',' + Convert(nvarchar(100),@UserId) + ',''' + Convert(nvarchar(100),@GetDate) + ''',' +  Convert(nvarchar(100),@ImportProcessLogId)  + ',RowNumber   from  '+ @TableName + ' where PimProductId Is null ';
			INSERT INTO ZnodeImportLog
                     (ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId,RowNumber )
        	EXEC sys.sp_sqlexec	@SQLQuery	 	


			--SET @SQLQuery = '
			--INSERT INTO ZnodeImportLog
			--		(ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId,RowNumber )
			--Select 19 ,''Attribute '', a.Name , '''+ @NewGUID + ''',' + Convert(nvarchar(100),@UserId) + ',''' +  Convert(nvarchar(100),@GetDate) + ''',' + Convert(nvarchar(100),@UserId) + ',''' + Convert(nvarchar(100),@GetDate) + ''',' +  Convert(nvarchar(100),@ImportProcessLogId)  + ',' +
			--' NULL  from tempdb.sys.columns a
			--inner join tempdb.sys.tables b on a.object_id = b.object_id 
			--where b.name in (''##ProductUpdate_' + @NewGUID +''') 
			--and NOT EXISTS (Select TOP 1 1 FROM ZnodePimAttribute PA WHERE a.name = PA.AttributeCode) AND a.Name <> ''guid''' 

   --     	EXEC sys.sp_sqlexec	@SQLQuery	 	

			SET @SQLQuery = 'Delete from  '+@TableName+ ' where PimProductId Is null ';
			EXEC sys.sp_sqlexec	@SQLQuery	 	
			
			DECLARE @RecordCount Bigint 
			SET @SQLQuery = ' Select @RecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
			EXEC sp_executesql @SQLQuery, N'@RecordCount BIGINT out' , @RecordCount=@RecordCount out


			--Generate new process for current import 
            --INSERT INTO ZnodeImportProcessLog(ImportTemplateId,Status,ProcessStartedDate,ProcessCompletedDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
            --SELECT @TemplateId,dbo.Fn_GetImportStatus(0),@GetDate,NULL,@UserId,@GetDate,@UserId,@GetDate;
            --SET @ImportProcessLogId = @@IDENTITY;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @ImportHeadName IN('ProductUpdate') AND @RecordCount > 0  
                 BEGIN 
					SET @IsCategory = 0 
				    --Get all default attribute values in attribute 
                    INSERT INTO @FamilyAttributeDetail
                    (PimAttributeId,AttributeTypeName,AttributeCode,SourceColumnName,IsRequired,PimAttributeFamilyId)
                    --Call Process to insert data of defeult family with source column name and target column name 
					SELECT distinct zpa.PimAttributeId, zat.AttributeTypeName, zpa.AttributeCode, zitm.SourceColumnName, zpa.IsRequired ,0
					FROM dbo.ZnodePimAttribute AS zpa INNER JOIN dbo.ZnodeAttributeType AS zat ON zat.AttributeTypeId = zpa.AttributeTypeId 
					LEFT OUTER JOIN dbo.ZnodeImportTemplateMapping AS zitm
					ON zpa.AttributeCode = zitm.SourceColumnName AND zitm.ImportTemplateId = @TemplateId
					WHERE zpa.IsCategory = 0 
	             END;
            -- Check attributes are manditory and not provided with source table
		   	if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
		 
     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId )
            EXEC sys.sp_sqlexec  @SQLQuery;
            IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )  AND @RecordCount > 0  
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('ProductUpdate', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             --INSERT INTO ZnodeImportLog
                             --(ErrorDescription,
                             -- ColumnName,
                             -- Data,
                             -- GUID,
                             -- CreatedBy,
                             -- CreatedDate,
                             -- ModifiedBy,
                             -- ModifiedDate,
                             -- ImportProcessLogId
                             --)
                             --       SELECT '14' AS ErrorDescription,
                             --              AttributeCode,
                             --              '',
                             --              @NewGUID,
                             --              @UserId,
                             --              @GetDate,
                             --              @UserId,
                             --              @GetDate,
                             --              @ImportProcessLogId
                             --       FROM @FamilyAttributeDetail
                             --       WHERE ISNULL(SourceColumnName, '') = ''
                             --             AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							 ---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							 Delete FAD from @AttributeDetail FAD
							 where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							 and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
                             IF NOT EXISTS
                             (
                                 SELECT TOP 1 1
                                 FROM INFORMATION_SCHEMA.TABLES
                                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeCode'
                             )
                                 BEGIN
                                     CREATE TABLE #DefaultAttributeCode
                                     (AttributeTypeName          VARCHAR(300),
                                      PimAttributeDefaultValueId INT,
                                      PimAttributeId             INT,
                                      AttributeDefaultValueCode  VARCHAR(100)
                                     );
                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;
                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';
                                 END;
                             ELSE
                                 BEGIN
                                     DROP TABLE #DefaultAttributeCode;
                                 END;
                         END;

                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
						
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
									--For link product
									DECLARE @IsIgnoreProcess BIT = CASE WHEN EXISTS (SELECT TOP 1 1 FROM ZnodePimAttribute WHERE AttributeCode = (SELECT TOP 1 TargetColumnName
								    FROM ZnodeImportTemplateMapping a 
									INNER JOIN ZnodeImportTemplate b ON (b.ImportTemplateId = a.ImportTemplateId )
									WHERE TemplateName = 'ProductUpdate'
									AND a.TargetColumnName <> 'SKU'
								   )
								    AND AttributeTypeId = (SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE  AttributeTypeName = 'link' )
								   ) THEN 1 ELSE 0 END 
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId,
										  @IsIgnoreProcess = @IsIgnoreProcess;
                                 END;
                             IF @AttributeTypeName = 'Image'
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

								 --For link product
								 IF @AttributeTypeName = 'Link'
                                 BEGIN
										--To get the product SKU in temp table
										SELECT ZPAV.PimProductId, ZPAVL.AttributeValue as SKU
										INTO #ProductSKU
										FROM ZnodePimAttributeValue ZPAV
										INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId 
										WHERE EXISTS(SELECT * FROM ZnodePimAttribute ZPA WHERE ZPAV.PimAttributeId = zpa.PimAttributeId AND ZPA.AttributeCode = 'SKU')

                                     	SET @SQLQuery = 'SELECT ''19'' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,RowNumber ,GUID,  '+@CreateDateString+' 
											FROM '+@TableName+' a 
											CROSS APPLY DBO.SPLIT('+@SourceColumnName+','','')S WHERE RowNumber in (SELECT RowNumber FROM '+@TableName+' WHERE  NOT EXISTS  (Select TOP 1 1  FROM #ProductSKU WHERE SKU = S.Item ) 
											)
											';
                     
											INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
											EXEC sys.sp_sqlexec @SQLQuery;
				
                                 END;

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('ProductUpdate', 'Category')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                                   ---Verify Image file is exists in media table or not 
                                             SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
                                             SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
                                             (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
                                              DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
                                             ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
                                             )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
                                             + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''

						
                                             EXEC sys.sp_sqlexec @SQLQuery;
                                             -- Check Invalid Image 
                                             
											 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
                                             Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
                                             INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
                                             EXEC sys.sp_sqlexec @SQLQuery;

											 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
            --COMMIT TRAN TRN_ImportValidProductData;
			 

		IF @ImportHeadName IN('ProductUpdate')
		 BEGIN
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000)   	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId

		
  	--	 SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName = ''SKU  '' + ' + '  ' +@SourceColumnNameProduct + ' ' + ' + ' + ' '  + ' ZIL.ColumnName + ''  Attribute''
		 --FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			--  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber is not null';
            
			--SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  ' +@SourceColumnNameProduct+ '+' + ''' ]'' 
		 --   FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			--WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
   --         PRINT @SQLQueryNew

            SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  ' +@SourceColumnNameProduct+ '+' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew

			EXEC sys.sp_sqlexec  @SQLQueryNew;
			
		END 

					 	 		 
  			 SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber in (Select Rownumber from ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber is not null)';
             EXEC sys.sp_sqlexec  @SQLQuery;

			 ---------------------------------------------------------------------------

		--	 Declare @SourceColumnNameProduct nvarchar(4000)  
		--	 Declare @SQLQueryNew NVARCHAR(4000) 	 
		-- SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		-- AND ImportTemplateId = @TemplateId


		--INSERT INTO ZnodeImportLog  (ErrorDescription,ColumnName, Data, GUID,CreatedBy,
  --          CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
		--	EXEC sys.sp_sqlexec  @SQLQueryNew;

		--	SET @SQLQueryNew = 'SELECT ''Successfully Imported '' ErrorDescription,''SKU'',
		--	'''+@SourceColumnNameProduct+''' AS [Data], 
  --          RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM '+@TableName+' WHERE Rownumber IS NOT NULL'

------------------------------------------------------------------------------------------------

		 --SET @SQLQuery = 'Select *  FROM  '+@TableName
   --          EXEC sys.sp_sqlexec  @SQLQuery;

             IF @ImportHeadName IN('ProductUpdate')
                 BEGIN
                     IF NOT EXISTS
                
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN (43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 ) AND @RecordCount > 0 
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN
                                     EXEC Znode_ImportPartialPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
	
                                 END;
                            
                         END;

					ELSE 
					BEGIN
					-- Update Record count in log 					
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					
					SELECT @SuccessRecordCount = 0
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
					WHERE ImportProcessLogId = @ImportProcessLogId;
					END

                 END
				
			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
			SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
			
			EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out

			UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
			WHERE ImportProcessLogId = @ImportProcessLogId;

		   EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
		
				--SET @SQLQuery = 'select TOP 1 * from  ' + @TableName
				--EXEC sys.sp_sqlexec @SQLQuery;
        END TRY
      
		BEGIN CATCH 
		DECLARE @TempCount TABLE (Id INT)

		Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
		INSERT INTO @TempCount
		EXEC (@SQL)

			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPartialValidatePimProductData @ImportHeadName = '''+ISNULL(@ImportHeadName,'''''')+''',@TableName='''+ISNULL(CAST(@TableName AS
			VARCHAR(50)),'''''')+''',@TemplateId='+ISNULL(CAST(@TemplateId AS VARCHAR(50)),'''')+',@NewGUID='''+ISNULL(@NewGUID,'''''')+''',@UserId='+ISNULL(CAST(@UserId AS VARCHAR(50)),'''')+',@LocaleId='+ISNULL(CAST(@LocaleId AS VARCHAR(50)),'''')+',
			@IsCategory='+ISNULL(CAST(@IsCategory AS VARCHAR(50)),'''')+',@DefaultFamilyId='+ISNULL(CAST(@DefaultFamilyId AS VARCHAR(50)),'''')+',@ImportProcessLogId='+ISNULL(CAST(@ImportProcessLogId AS VARCHAR(50)),'''')+',
			@PriceListId='+ISNULL(CAST(@PriceListId AS VARCHAR(50)),'''')+',@CountryCode='''+ISNULL(CAST(@CountryCode AS VARCHAR(50)),'''''')+''',@PimCatalogId='+ISNULL(CAST(@PimCatalogId AS VARCHAR(50)),'''')+',
			@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(50)),'''')+',@IsAccountAddress='+ISNULL(CAST(@IsAccountAddress AS VARCHAR(50)),'''')

			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;       
			
			---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportPartialValidatePimProductData',
			@ErrorInProcedure = 'Znode_ImportPartialValidatePimProductData',
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
		END CATCH 

     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPimCategoryData')
	DROP PROC Znode_ImportPimCategoryData
GO

CREATE PROCEDURE [dbo].[Znode_ImportPimCategoryData]
(   @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         NVARCHAR(200),
    @ImportProcessLogId INT,
    @UserId             INT,
    @LocaleId           INT,
    @DefaultFamilyId    INT)
AS

    /*
      Summary : Finally Import data into ZnodePimProduct, ZnodePimAttributeValue and ZnodePimAttributeValueLocale Table 
      Process : Flat global temporary table will split into cloumn wise and associted with Znode Attributecodes,
    		    Create group of product with their attribute code and values and inseerted one by one products. 	   
    
      SourceColumnName : CSV file column headers
      TargetColumnName : Attributecode from ZnodePimAttribute Table 

	 ***  Need to log error if transaction failed during insertion of records into table.

	EXEC Znode_ImportPimCategoryData 
    */

     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
             
             DECLARE @SQLQuery NVARCHAR(MAX);
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @PimAttributeFamilyId INT, @NewProductId INT, @PimAttributeValueId INT, @status BIT= 0; 
             --Declare error Log Table 

			 IF OBJECT_ID('tempdb.dbo.#DuplicateCategory', 'U') IS NOT NULL 
		     DROP TABLE tempdb.dbo.#DuplicateCategory

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             IF @DefaultFamilyId = 0
                 BEGIN
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with cource column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = 1,
						  @DefaultFamilyId=@DefaultFamilyId;
                     UPDATE @FamilyAttributeDetail
                       SET
                           PimAttributeFamilyId = DBO.Fn_GetCategoryDefaultFamilyId();

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
                 BEGIN
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with cource column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @DefaultFamilyId = @DefaultFamilyId,
                          @IsCategory = 1;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;  
			 --Read all matched CategoryId with respect to their CategoryCode 
			 --SET @SQLQuery = 
			 --SELECT * FROM ZnodePimCategoryAttributeValue zpca INNER JOIN ZnodePimCategoryAttributeValueLocale zpcal 
			 --ON zpca.PimCategoryAttributeValueId = zpcal.PimCategoryAttributeValueId Inner join ZnodePimAttribute ZPA on zpca.PimAttributeId = zpa.PimAttributeId 
			 --AND ZPA.IsCategory =1 AND ZPA.AttributeCode = 'CategoryCode' 
			 --Inner join ' + @TableName +' tlb ON zpcal.CategoryValue = tlb.CategoryCode

		
             --Read all attribute details with their datatype 

             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeValue'
             )
                 BEGIN
                     CREATE TABLE #DefaultAttributeValue
                     (AttributeTypeName          VARCHAR(300),
                      PimAttributeDefaultValueId INT,
                      PimAttributeId             INT,
                      AttributeDefaultValueCode  VARCHAR(100)
                     );
                     INSERT INTO #DefaultAttributeValue
                     (AttributeTypeName,
                      PimAttributeDefaultValueId,
                      PimAttributeId,
                      AttributeDefaultValueCode
                     )
                     --Call Process to insert default data value 
                     EXEC Znode_ImportGetPimAttributeDefaultValue;
                 END;
             ELSE
                 BEGIN
                     DROP TABLE #DefaultAttributeValue;
                 END;  
         
             -- Split horizontal table into verticle table by column name and attribute Value with their 
             -- corresponding AttributeId, Default family , Default AttributeValue Id  
             DECLARE @PimCategoryDetail TABLE
             ([PimCategoryId]              [INT] NULL,
              [PimAttributeId]             [INT] NULL,
              [PimAttributeValueId]        [INT] NULL,
              [PimAttributeDefaultValueId] [INT] NULL,
              [PimAttributeFamilyId]       [INT] NULL,
              [LocaleId]                   [INT] NULL,
              [AttributeCode]              [VARCHAR](500) NULL,
              [AttributeValue]             [NVARCHAR](MAX) NULL,
              [RowNumber]                  INT 
             );
             -- Column wise split data from source table ( global temporary table ) and inserted into temporary table variable @PimCategoryDetail
             -- Add PimAttributeDefaultValue 

             DECLARE Cr_AttributeDetails CURSOR LOCAL FAST_FORWARD
             FOR SELECT PimAttributeId,
                        AttributeTypeName,
                        AttributeCode,
                        IsRequired,
                        SourceColumnName,
                        PimAttributeFamilyId
                 FROM @FamilyAttributeDetail
                 WHERE ISNULL(SourceColumnName, '') <> '';
             OPEN Cr_AttributeDetails;
             FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
             WHILE @@FETCH_STATUS = 0
                 BEGIN
                     SET @NewProductId = 0;
                     SET @SQLQuery = 'SELECT '''+CONVERT(VARCHAR(100), @PimAttributeFamilyId)+''' PimAttributeFamilyId, 0 PimCategoryId,'''+CONVERT(VARCHAR(100), @AttributeId)+''' AttributeId ,
						   (SELECT TOP 1 PimAttributeDefaultValueId FROM #DefaultAttributeValue Where PimAttributeId =  '+CONVERT(VARCHAR(100), @AttributeId)+'AND  AttributeDefaultValueCode = TN.'+@SourceColumnName+' ) PimAttributeDefaultValueId,'+@SourceColumnName+','+CONVERT(VARCHAR(100), @LocaleId)+'LocaleId,RowNumber FROM '+@TableName+' TN';
                     INSERT INTO @PimCategoryDetail
                     ([PimAttributeFamilyId],
                      [PimCategoryId],
                      [PimAttributeId],
                      [PimAttributeDefaultValueId],
                      AttributeValue,
                      LocaleId,
                      RowNumber
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                     FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
                 END;
             CLOSE Cr_AttributeDetails;
             DEALLOCATE Cr_AttributeDetails;
             UPDATE ppdti
               SET
                   ppdti.AttributeValue = CASE
                                              WHEN ppdti.AttributeValue = 'Yes/No'
                                              THEN 'False'
                                          END
             FROM @PimCategoryDetail ppdti
                  INNER JOIN #DefaultAttributeValue dav ON dav.PimAttributeDefaultValueId = ppdti.PimAttributeDefaultValueId
             WHERE ISNULL(ppdti.AttributeValue, '') = '';

			 SELECT PCD.AttributeValue
			 INTO #DuplicateCategory
			 FROM @PimCategoryDetail PCD
			 INNER JOIN ZnodePimAttribute PA ON (PCD.PimAttributeId = PA.PimAttributeId)
			 where PA.AttributeCode = 'CategoryCode' 
			 GROUP BY PCD.AttributeValue
			 Having Count(*) > 1


			INSERT INTO ZnodeImportLog
			(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
			 SELECT '53' ,'CategoryCode',PCD.AttributeValue,PCD.RowNumber,@NewGUID,2,GETDATE(),2,GETDATE(),@ImportProcessLogId
			 FROM @PimCategoryDetail PCD
			 WHERE RowNumber IN (SELECT RowNumber frOM #DuplicateCategory DC 
								 INNER JOIN ZnodePimAttribute PA ON (PCD.PimAttributeId = PA.PimAttributeId)
								 WHERE PA.AttributeCode = 'CategoryCode' 
								 AND PCD.AttributeValue = DC.AttributeValue )

			
			 ----update mediaid for CategoryImage
			 select zm.FileName,max(MediaId) as MediaId, PCD.RowNumber
			 into #CategoryImage
			 from ZnodeMedia ZM
			 inner join @PimCategoryDetail PCD on ZM.FileName = PCD.AttributeValue
			 where exists(select * from ZnodePimAttribute c where PCD.PimAttributeId = c.PimAttributeId and c.AttributeCode = 'CategoryImage')
			 group by zm.FileName, PCD.RowNumber 
			 
			update a set a.AttributeValue = b.MediaId
			from @PimCategoryDetail a
			inner join #CategoryImage b on a.AttributeValue = b.FileName and a.RowNumber = b.RowNumber
				
			 ----update PimCategoryId present in znode on basis of CategoryCode
			 update d set  d.PimCategoryId = a.PimCategoryId
			 from ZnodePimCategoryAttributeValue a
			 inner join ZnodePimCategoryAttributeValueLocale b on a.PimCategoryAttributeValueId = b.PimCategoryAttributeValueId
			 inner join ZnodePimAttribute c on a.PimAttributeId = c.PimAttributeId
			 inner join @PimCategoryDetail d on d.AttributeValue = b.CategoryValue and c.PimAttributeId = d.PimAttributeId
			 where c.AttributeCode = 'CategoryCode' 

			 ----update PimCategoryId for other attributes if category is present
			 ;WITH CTE_UpdateCategoryId AS
			(
				select PimCategoryId, RowNumber from @PimCategoryDetail where isnull(PimCategoryId,0) <> 0
			)
			UPDATE PCD set PCD.PimCategoryId = UC.PimCategoryId
			FROM @PimCategoryDetail PCD
			INNER JOIN CTE_UpdateCategoryId UC on PCD.RowNumber = UC.RowNumber
			 ---------------------------

             -- Pass product records one by one 
             DECLARE @IncrementalId INT= 1;
             DECLARE @SequenceId INT=
             (
                 SELECT MAX(RowNumber)
                 FROM @PimCategoryDetail
             );
             DECLARE @PimCategoryDetailToInsert PIMCATEGORYDETAIL;  --User define table type to pass multiple records of product in single step

             WHILE @IncrementalId <= @SequenceId
                 BEGIN
                     INSERT INTO @PimCategoryDetailToInsert
                     ([PimCategoryId],
                      [PimAttributeId],
                      [PimAttributeValueId],
                      [PimAttributeDefaultValueId],
                      [PimAttributeFamilyId],
                      [LocaleId],
                      [AttributeCode],
                      [AttributeValue]
                     )
                            SELECT [PimCategoryId],
                                   [PimAttributeId],
                                   [PimAttributeValueId],
                                   [PimAttributeDefaultValueId],
                                   [PimAttributeFamilyId],
                                   [LocaleId],
                                   [AttributeCode],
                                   [AttributeValue]
                            FROM @PimCategoryDetail
                            WHERE [@PimCategoryDetail].RowNumber = @IncrementalId AND LTRIM(RTRIM([AttributeValue])) <> '';
                     --ORDER BY [@PimCategoryDetail].RowNumber;
                     ----Call process to finally insert data into 
                     ----------------------------------------------------------
                     --1. [dbo].[ZnodePimProduct]
                     --2. [dbo].[ZnodePimAttributeValue]
                     --3. [dbo].[ZnodePimAttributeValueLocale]

                     EXEC [Znode_ImportInsertUpdatePimCategory]
                          @InsertCategory = @PimCategoryDetailToInsert,
                          @UserID = @UserID,
                          @status = @status OUT,
						  @IsImport=1;--,@IsNotReturnOutput=1;
                     DELETE FROM @PimCategoryDetailToInsert;
                     SET @IncrementalId = @IncrementalId + 1;
                 END;

			
				-- Update Record count in log 
				DECLARE @FailedRecordCount BIGINT
				DECLARE @SuccessRecordCount BIGINT
				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
				EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount OUTPUT
				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;
				

             --Updating the import process status
			UPDATE ZnodeImportProcessLog
			SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
								WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
								WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
							END, 
				ProcessCompletedDate = getdate()
			WHERE ImportProcessLogId = @ImportProcessLogId;	   	  
            
			IF OBJECT_ID('tempdb.dbo.#DuplicateCategory', 'U') IS NOT NULL 
		     DROP TABLE tempdb.dbo.#DuplicateCategory

         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE(),ERROR_LINE(),ERROR_PROCEDURE();
 
			 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPimCategoryData @TableName = '+CAST(@TableName AS VARCHAR(max))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200)) +',@TemplateId='+CAST(@TemplateId AS VARCHAR(200)) +',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(10))+',@DefaultFamilyId='+CAST(@DefaultFamilyId AS VARCHAR(200));
            ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportPimCategoryData',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
            
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPimProductData')
	DROP PROC Znode_ImportPimProductData
GO



Create PROCEDURE [dbo].[Znode_ImportPimProductData]
(   @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         NVARCHAR(200),
    @ImportProcessLogId INT,
    @UserId             INT,
    @LocaleId           INT,
    @DefaultFamilyId    INT)
AS
    
	/*
      Summary : Finally Import data into ZnodePimProduct, ZnodePimAttributeValue and ZnodePimAttributeValueLocale Table 
      Process : Flat global temporary table will split into cloumn wise and associted with Znode Attributecodes,
    		      Create group of product with their attribute code and values and inserted one by one products. 	   
    
      SourceColumnName : CSV file column headers
      TargetColumnName : Attributecode from ZnodePimAttribute Table 

	 ***  Need to log error if transaction failed during insertion of records into table.
    */

     BEGIN
		 SET NOCOUNT ON
         BEGIN TRY
             BEGIN TRAN ImportProducts;
             DECLARE @SQLQuery NVARCHAR(MAX);
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @PimAttributeFamilyId INT, @NewProductId INT, @PimAttributeValueId INT, @status BIT= 0; 
             --Declare error Log Table 

			
			 DECLARE @FamilyAttributeDetail TABLE
			 ( 
				PimAttributeId int, AttributeTypeName varchar(300), AttributeCode varchar(300), SourceColumnName nvarchar(600), IsRequired bit, PimAttributeFamilyId int
			 );
             IF @DefaultFamilyId = 0
                 BEGIN
					INSERT INTO @FamilyAttributeDetail( PimAttributeId, AttributeTypeName, AttributeCode, SourceColumnName, IsRequired, PimAttributeFamilyId )
					--Call Process to insert data of defeult family with cource column name and target column name 
					EXEC Znode_ImportGetTemplateDetails @TemplateId = @TemplateId, @IsValidationRules = 0, @IsIncludeRespectiveFamily = 1,@DefaultFamilyId = @DefaultFamilyId;
                    UPDATE @FamilyAttributeDetail SET PimAttributeFamilyId = DBO.Fn_GetCategoryDefaultFamilyId();

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
                 BEGIN
                     INSERT INTO @FamilyAttributeDetail(PimAttributeId,AttributeTypeName,AttributeCode,SourceColumnName,IsRequired,PimAttributeFamilyId)
                     --Call Process to insert data of defeult family with cource column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails @TemplateId = @TemplateId,@IsValidationRules = 0,@IsIncludeRespectiveFamily = 1,@DefaultFamilyId = @DefaultFamilyId;

					 ---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;  
				
            -- Retrive PimProductId on the basis of SKU for update product 
			SET @SQLQuery = 'UPDATE tlb SET tlb.PimProductId = ZPAV.PimProductId 
							FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
							(ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId) 
							INNER JOIN [dbo].[ZnodePimAttribute] ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId AND ZPA.AttributeCode= ''SKU'' 
							INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = ltrim(rtrim(tlb.SKU)) ';
			EXEC sys.sp_sqlexec	@SQLQuery	 	
				 	
					
             --Read all attribute details with their datatype 
			 IF NOT EXISTS(SELECT TOP 1 1 FROM INFORMATION_SCHEMA.TABLES WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeValue')
				BEGIN
					   CREATE TABLE #DefaultAttributeValue (AttributeTypeName  VARCHAR(300),PimAttributeDefaultValueId INT,PimAttributeId INT,
					   AttributeDefaultValueCode  VARCHAR(100));
					 
					INSERT INTO #DefaultAttributeValue(AttributeTypeName,PimAttributeDefaultValueId,PimAttributeId,AttributeDefaultValueCode)
					--Call Process to insert default data value 
					EXEC Znode_ImportGetPimAttributeDefaultValue;
				END;
             ELSE
                BEGIN
                    DROP TABLE #DefaultAttributeValue;
                END;
             EXEC sys.sp_sqlexec
                  @SQLQuery;
       
			DECLARE @PimProductDetail TABLE 
			 (
			      
				  PimAttributeId INT, PimAttributeFamilyId INT,ProductAttributeCode VARCHAR(300) NULL,
				  ProductAttributeDefaultValueId INT NULL,PimAttributeValueId  INT NULL,LocaleId INT,
				  PimProductId INT NULL,AttributeValue NVARCHAR(MAX) NULL,AssociatedProducts NVARCHAR(4000) NULL,ConfigureAttributeIds VARCHAR(2000) NULL,
				  ConfigureFamilyIds VARCHAR(2000) NULL,RowNumber INT  
                );

		-- Update Record count in log 
       DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
		EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount OUTPUT
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

			
             -- Column wise split data from source table ( global temporary table ) and inserted into temporary table variable @PimProductDetail
             -- Add PimAttributeDefaultValue 
             DECLARE Cr_AttributeDetails CURSOR LOCAL FAST_FORWARD
             FOR SELECT PimAttributeId,AttributeTypeName,AttributeCode,IsRequired,SourceColumnName,PimAttributeFamilyId FROM @FamilyAttributeDetail  WHERE ISNULL(SourceColumnName, '') <> '';
             OPEN Cr_AttributeDetails;
             FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
             WHILE @@FETCH_STATUS = 0
                 BEGIN
                    SET @NewProductId = 0;
                    SET @SQLQuery = ' SELECT '''+CONVERT(VARCHAR(100), @PimAttributeFamilyId)+''' PimAttributeFamilyId , PimProductId PimProductId,'''+'['+@AttributeCode+']'+''' ProductAttributeCode ,'''+CONVERT(VARCHAR(100), @AttributeId)+''' AttributeId ,
									(SELECT TOP 1  PimAttributeDefaultValueId FROM #DefaultAttributeValue Where PimAttributeId =  '
									+ CONVERT(VARCHAR(100), @AttributeId)+'AND  AttributeDefaultValueCode = TN.['+@SourceColumnName+'] ) PimAttributeDefaultValueId ,['
									+ @SourceColumnName+'],'+CONVERT(VARCHAR(100), @LocaleId)+'LocaleId
								, RowNumber FROM '+@TableName+' TN';
								print @SQLQuery
                    INSERT INTO @PimProductDetail( PimAttributeFamilyId, PimProductId,ProductAttributeCode, PimAttributeId, ProductAttributeDefaultValueId, AttributeValue, LocaleId, RowNumber )
					
					EXEC sys.sp_sqlexec @SQLQuery;
                    FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
                 END;
             CLOSE Cr_AttributeDetails;
             DEALLOCATE Cr_AttributeDetails;
			 
			
			 if object_id('tempdb..#PimProductDetail1') is not null
				drop table #PimProductDetail1

			 Select * into #PimProductDetail1 from @PimProductDetail

			 UPDATE a 
			 SET ConfigureAttributeIds =  SUBSTRING((SELECT ','+CAST(c.PimAttributeId As VARCHAR(100)) 
			 FROM #PimProductDetail1 c 
			 INNER JOIN ZnodePimAttribute b ON (b.PimAttributeId = c.PimAttributeId)
			 WHERE IsConfigurable =1  AND c.RowNumber = a.RowNumber  FOR XML PATH('')),2,4000) 
			 FROM #PimProductDetail1 a 
			WHERE EXISTS (SELECT TOP 1 1 FROM #PimProductDetail1 ab  WHERE ab.RowNumber = a.RowNumber AND	ab.ProductAttributeCode = '[ProductType]' 
			 AND ab.AttributeValue = 'ConfigurableProduct' )
				
             -- In case of Yes/No : If value is not TRUE OR  1 then it will be  False else True
			 --If default Value set not need of hard code for IsActive
			 UPDATE ppdti SET ppdti.AttributeValue = CASE WHEN Upper(ISNULL(ppdti.AttributeValue, '')) in ( 'TRUE','1')  THEN 'true'  ELSE 'false' END FROM #PimProductDetail1 ppdti
                INNER JOIN #DefaultAttributeValue dav ON ppdti.PimAttributeId = dav.PimAttributeId WHERE   dav.AttributeTypeName = 'Yes/No';
            
		
		-----------Added Performance patch 
		DECLARE @PublishStateIdForDraft INT= [dbo].[Fn_GetPublishStateIdForDraftState]();
		DECLARE @PimDefaultFamily INT= dbo.Fn_GetDefaultPimProductFamilyId();
        DECLARE @pimSkuAttributeId VARCHAR(50)= [dbo].[Fn_GetProductSKUAttributeId]();
        DECLARE @PimIsDownlodableAttributeId VARCHAR(50)= [dbo].[Fn_GetIsDownloadableAttributeId]();
        DECLARE @PublishStateIdForNotPublished INT= [dbo].[Fn_GetPublishStateIdForForNotPublishedState]();

		DELETE FROM #PimProductDetail1 WHERE RTRIM(LTRIM(ISNULL(AttributeValue, ''))) = '';
        
		CREATE INDEX Inx_PimProductDetail_Bulk1 ON #PimProductDetail1(RowNumber);

        ------------------------------------Bulk Row Process
        DECLARE @MaxCount INT, @MinRow INT, @MaxRow INT, @Rows numeric(10,2);
        ---- Count of total rows for import
		SELECT @MaxCount = COUNT(*) FROM #PimProductDetail1;
		
		---- Count of rows in loop for import
		SELECT @Rows = (select top 1 FeatureValues from ZnodeGlobalSetting where FeatureName = 'ProductImportBulk')  --ceiling(@MaxCount/100.0)
        
		SELECT @MaxCount = CEILING(@MaxCount / @Rows);

        IF OBJECT_ID('tempdb..#Temp_ImportLoop') IS NOT NULL
            DROP TABLE #Temp_ImportLoop;
        
		---- To get the min and max rows for import in loop
		;WITH cte AS 
		(
			SELECT RowId = 1, 
				   MinRow = 1, 
                   MaxRow = cast(@Rows as int)
            UNION ALL
            SELECT RowId + 1, 
                   MinRow + cast(@Rows as int), 
                   MaxRow + cast(@Rows as int)
            FROM cte
            WHERE RowId + 1 <= @MaxCount
		)
        SELECT RowId, MinRow, MaxRow
        INTO #Temp_ImportLoop
        FROM cte
		option (maxrecursion 0);

        --while @MaxCount <= @minRow
        DECLARE cur_BulkData CURSOR LOCAL FAST_FORWARD
        FOR SELECT MinRow, MaxRow FROM #Temp_ImportLoop;

        OPEN cur_BulkData;
        FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;

        WHILE @@FETCH_STATUS = 0
        BEGIN
		
		BEGIN TRAN ImportProducts;

			if object_id ('tempdb..#PimProductDetail_Bulk_Process')is not null
					drop table tempdb..#PimProductDetail_Bulk_Process

			CREATE TABLE #PimProductDetail_Bulk_Process
			([PimAttributeId]                 [INT] NULL, 
				[PimAttributeFamilyId]           [INT] NULL, 
				[ProductAttributeCode]           [VARCHAR](300) NULL, 
				[ProductAttributeDefaultValueId] [INT] NULL, 
				[PimAttributeValueId]            [INT] NULL, 
				[LocaleId]                       [INT] NULL, 
				[PimProductId]                   [INT] NULL, 
				[AttributeValue]                 [NVARCHAR](MAX) NULL, 
				[AssociatedProducts]             [NVARCHAR](4000) NULL, 
				[ConfigureAttributeIds]          [VARCHAR](2000) NULL, 
				[ConfigureFamilyIds]             [VARCHAR](2000) NULL, 
				[RowNumber]                      [INT] NULL, 
				SKU1                             VARCHAR(600),
				Id Int Identity(1,1)Primary Key
			);

			CREATE INDEX Inx_PimProductDetail_Bulk_Process ON #PimProductDetail_Bulk_Process(ProductAttributeCode, PimProductId);
			CREATE INDEX Inx_PimProductDetail_Bulk_Process1 ON #PimProductDetail_Bulk_Process(RowNumber);
			CREATE INDEX Inx_PimProductDetail_Bulk_Process2 ON #PimProductDetail_Bulk_Process(ProductAttributeCode)
			CREATE INDEX Inx_PimProductDetail_Bulk_Process3 ON #PimProductDetail_Bulk_Process(PimAttributeId, PimProductId);

			---- Insert rows for import in bulk
            INSERT INTO #PimProductDetail_Bulk_Process
            ([PimAttributeId], 
                [PimAttributeFamilyId], 
                [ProductAttributeCode], 
                [ProductAttributeDefaultValueId], 
                [PimAttributeValueId], 
                [LocaleId], 
                [PimProductId], 
                [AttributeValue], 
                [AssociatedProducts], 
                [ConfigureAttributeIds], 
                [ConfigureFamilyIds], 
                [RowNumber]
            )
            SELECT [PimAttributeId], 
                    [PimAttributeFamilyId], 
                    [ProductAttributeCode], 
                    [ProductAttributeDefaultValueId], 
                    [PimAttributeValueId], 
                    [LocaleId], 
                    [PimProductId], 
                    ltrim(rtrim([AttributeValue])), 
                    [AssociatedProducts], 
                    [ConfigureAttributeIds], 
                    [ConfigureFamilyIds], 
                    [RowNumber]
            FROM #PimProductDetail1 a
            WHERE a.[RowNumber] BETWEEN @MinRow AND @MaxRow;

			--select * from @PimProductDetail

			--select * from #PimProductDetail1



            ---------------------------Start Importing 
			if object_id ('tempdb..#TBL_DefaultAttributeId')is not null
				drop table #TBL_DefaultAttributeId

			if object_id ('tempdb..#TBL_MediaAttributeId')is not null
				drop table #TBL_MediaAttributeId

			if object_id ('tempdb..#TBL_TextAreaAttributeId')is not null
				drop table #TBL_TextAreaAttributeId

			if object_id ('tempdb..#TBL_MediaAttributeValue')is not null
				drop table #TBL_MediaAttributeValue

			if object_id ('tempdb..#TBL_DefaultAttributeValue')is not null
				drop table #TBL_DefaultAttributeValue

			if object_id ('tempdb..#ZnodePimAttributeValue')is not null
				drop table #ZnodePimAttributeValue

				
            CREATE TABLE #TBL_DefaultAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );

            CREATE TABLE #TBL_MediaAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );

            CREATE TABLE #TBL_TextAreaAttributeId ( PimAttributeId INT PRIMARY KEY, AttributeCode  VARCHAR(600) );
           
		    CREATE TABLE #TBL_MediaAttributeValue ( PimAttributeValueId INT, LocaleId INT, AttributeValue VARCHAR(300), MediaId INT );

            CREATE TABLE #TBL_DefaultAttributeValue ( PimAttributeValueId INT, LocaleId INT, AttributeValue INT );

            CREATE TABLE #ZnodePimAttributeValue (PimAttributeValueId  INT, PimAttributeFamilyId INT, PimAttributeId INT, PimProductId INT );

            DECLARE @ConfigureFamilyId VARCHAR(4000);

            INSERT INTO #TBL_DefaultAttributeId ( PimAttributeId, AttributeCode )
            SELECT PimAttributeId, AttributeCode
            FROM [dbo].[Fn_GetDefaultAttributeId]();

			INSERT INTO #TBL_MediaAttributeId (PimAttributeId, AttributeCode )
			SELECT PimAttributeId, AttributeCode
			FROM [dbo].[Fn_GetProductMediaAttributeId]();

            INSERT INTO #TBL_TextAreaAttributeId ( PimAttributeId, AttributeCode )
            SELECT PimAttributeId, AttributeCode
            FROM [dbo].[Fn_GetTextAreaAttributeId]();

            SELECT TOP 1 @PimAttributeFamilyId = PimAttributeFamilyId FROM #PimProductDetail_Bulk_Process;

			if object_id ('tempdb..#cte')is not null
				drop table #cte

            SELECT AttributeValue AS SKU, RowNumber
            INTO #cte
            FROM #PimProductDetail_Bulk_Process
            WHERE ProductAttributeCode = '[SKU]';
              
			

            CREATE INDEX Inx_cte_RowNumber ON #cte(RowNumber);
            UPDATE a SET a.SKU1 = B.SKU
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #cte b ON a.RowNumber = b.RowNumber;

		
			
            SELECT TOP 1 @LocaleId = LocaleId FROM #PimProductDetail_Bulk_Process;

            ----Update ZNodePimProduct 
            UPDATE ZNodePimProduct
            SET PimAttributeFamilyId = DP.PimAttributeFamilyId, 
                PublishStateId = @PublishStateIdForDraft, 
                ModifiedBy = @UserId, 
                ModifiedDate = @GetDate
            FROM ZNodePimProduct ZPP
            INNER JOIN #PimProductDetail_Bulk_Process DP ON ZPP.PimProductId = DP.PimProductId;
      
			if object_id ('tempdb..#ZnodePimProduct')is not null
				drop table #ZnodePimProduct

			CREATE TABLE #ZnodePimProduct(PimProductId INT,ExternalId INT  Primary key)

			--create index Idx_ZnodePimProduct_ExternalId on #ZnodePimProduct(ExternalId)


			 

			----Insert into ZNodePimProduct 
            INSERT INTO ZnodePimProduct
            (PimAttributeFamilyId, 
                ExternalId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate, 
                PublishStateId
            )
			output inserted.PimProductId, inserted.ExternalId into #ZnodePimProduct(PimProductId,ExternalId)
            SELECT PimAttributeFamilyId, 
                    RowNumber, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate, 
                    @PublishStateIdForNotPublished
            FROM #PimProductDetail_Bulk_Process
            WHERE ProductAttributeCode = '[SKU]'
            AND PimProductId IS NULL;
            
			----Update newly created productIds
            UPDATE a SET a.PimProductId = b.PimProductId
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #ZnodePimProduct b ON a.RowNumber = b.ExternalId;

            ----Insert Downloadable products into ZnodePimDownloadableProduct
            INSERT INTO ZnodePimDownloadableProduct (SKU, ProductName, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
            SELECT PDSKU.AttributeValue, PDProdName.AttributeValue, @UserId, @GetDate, @UserId, @GetDate
            FROM #PimProductDetail_Bulk_Process PDSKU
            INNER JOIN #PimProductDetail_Bulk_Process PDProdName ON PDProdName.RowNumber = PDSKU.RowNumber
            INNER JOIN #PimProductDetail_Bulk_Process PDDownload ON PDDownload.RowNumber = PDSKU.RowNumber
            WHERE PDSKU.ProductAttributeCode = @pimSkuAttributeId
            AND PDProdName.ProductAttributeCode = '[SKU]'
            AND PDDownload.PimAttributeId = @PimIsDownlodableAttributeId
            AND PDDownload.AttributeValue = 'true'
            AND NOT EXISTS ( SELECT TOP 1 1 FROM ZnodePimDownloadableProduct WHERE ZnodePimDownloadableProduct.SKU = PDSKU.AttributeValue );

            ---- update ZnodePimAttributeValue : attribute data for Product
            UPDATE TARGET
            SET TARGET.PimAttributeFamilyId = CASE
                                                    WHEN Source.PimAttributeFamilyId = 0
                                                    THEN NULL
                                                    ELSE Source.PimAttributeFamilyId
                                                END, 
                    TARGET.ModifiedBy = @UserId, 
                    TARGET.ModifiedDate = @GetDate, 
                    TARGET.PimProductId = SOURCE.PimProductId
            OUTPUT INSERTED.PimAttributeValueId, 
                    INSERTED.PimAttributeFamilyId, 
                    INSERTED.PimAttributeId, 
                    INSERTED.PimProductId
                    INTO #ZnodePimAttributeValue
            FROM ZnodePimAttributeValue TARGET
            INNER JOIN #PimProductDetail_Bulk_Process SOURCE ON TARGET.PimProductId = SOURCE.PimProductId AND TARGET.PimAttributeId = SOURCE.PimAttributeId;
             
			---- Inserting attribute data for Product 
			INSERT INTO ZnodePimAttributeValue 
			( 
				PimAttributeFamilyId, 
				PimProductId, PimAttributeId, 
				PimAttributeDefaultValueId, 
				CreatedBy, 
				CreatedDate, 
				ModifiedBy, 
				ModifiedDate 
			)
            OUTPUT INSERTED.PimAttributeValueId, 
                    INSERTED.PimAttributeFamilyId, 
                    INSERTED.PimAttributeId, 
                    INSERTED.PimProductId
                    INTO #ZnodePimAttributeValue
            SELECT 
				CASE
                    WHEN Source.PimAttributeFamilyId = 0
                    THEN @PimDefaultFamily
                    ELSE Source.PimAttributeFamilyId
                END, 
                SOURCE.PimProductId, 
                ISNULL(SOURCE.PimAttributeId, 0),
                CASE
                    WHEN SOURCE.ProductAttributeDefaultValueId = 0
                    THEN NULL
                    ELSE SOURCE.ProductAttributeDefaultValueId
                END, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #PimProductDetail_Bulk_Process SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimAttributeValue TARGET
                WHERE TARGET.PimProductId = SOURCE.PimProductId
                        AND TARGET.PimAttributeId = SOURCE.PimAttributeId
            );

            -------------------------
			if object_id ('tempdb..#MediaData')is not null
				drop table #MediaData

            CREATE TABLE #MediaData (MediaId INT, PimProductId INT, PimAttributeId INT, PimAttributeFamilyId INT, LocaleId INT );

			---- Get Product Media Data
            INSERT INTO #MediaData ( MediaId , PimProductId , PimAttributeId , PimAttributeFamilyId , LocaleId )
            SELECT SP.Item, a.PimProductId, a.PimAttributeId, PimAttributeFamilyId, a.LocaleId
            FROM #PimProductDetail_Bulk_Process a
            INNER JOIN #TBL_MediaAttributeId c ON(c.PimAttributeId = a.PimAttributeId)
            CROSS APPLY dbo.split(a.AttributeValue, ',') SP;

			---- Get product media attribute data
            INSERT INTO #TBL_MediaAttributeValue ( PimAttributeValueId, LocaleId, AttributeValue, MediaId )
            SELECT a.PimAttributeValueId, b.LocaleId, zm.Path AttributeValue, ZM.MediaId
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #MediaData AS b ON(a.PimAttributeId = b.PimAttributeId
                                            AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                            AND a.PimProductId = b.PimProductId)
            INNER JOIN ZnodeMedia ZM ON(b.MediaId = ZM.MediaId);
     
			---- Deleting product media attribute
            DELETE FROM ZnodePimProductAttributeMedia
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM #TBL_MediaAttributeValue TBLM
                WHERE ZnodePimProductAttributeMedia.PimAttributeValueId = TBLM.PimAttributeValueId
                        AND TBLM.MediaId <> ZnodePimProductAttributeMedia.MediaId
                        AND ZnodePimProductAttributeMedia.Localeid = @LocaleId
            );

            ---- update ZnodePimProductAttributeMedia : attribute data for Product
            UPDATE TARGET
                SET 
                    TARGET.MediaPath = SOURCE.AttributeValue, 
                    TARGET.MediaId = SOURCE.MediaId, 
                    TARGET.ModifiedBy = @UserId, 
                    TARGET.ModifiedDate = @GetDate
            FROM ZnodePimProductAttributeMedia TARGET
            INNER JOIN #TBL_MediaAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                        AND TARGET.MediaPAth = SOURCE.AttributeValue
                                                        AND TARGET.LocaleId = SOURCE.LocaleId;
    
            ---- inserting Media attribute data for Product
            INSERT INTO ZnodePimProductAttributeMedia 
			( 
				PimAttributeValueId, 
				LocaleId, MediaPath, 
				MediaId, 
				CreatedBy, 
				CreatedDate, 
				ModifiedBy, 
                ModifiedDate
            )
            SELECT SOURCE.PimAttributeValueId, 
                    SOURCE.LocaleId, 
                    SOURCE.AttributeValue, 
                    SOURCE.MediaId, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #TBL_MediaAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeMedia TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.MediaPAth = SOURCE.AttributeValue
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );

            --------------------------
			if object_id ('tempdb..#Cte_TextAreaAttributeValue')is not null
				drop table #Cte_TextAreaAttributeValue

			---- Getting text area data in temp #Cte_TextAreaAttributeValue
            SELECT a.PimAttributeValueId, 
                    b.LocaleId, 
                    AttributeValue
            INTO #Cte_TextAreaAttributeValue
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                            AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                            AND a.PimProductId = b.PimProductId)
            INNER JOIN #TBL_TextAreaAttributeId c ON(c.PimAttributeId = b.PimAttributeId);

            ---- update ZnodePimProductAttributeTextAreaValue : attribute data for Product
            UPDATE TARGET
            SET TARGET.AttributeValue = SOURCE.AttributeValue, 
                TARGET.CreatedBy = @UserId, 
                TARGET.ModifiedBy = @UserId, 
                TARGET.ModifiedDate = @GetDate
            FROM ZnodePimProductAttributeTextAreaValue TARGET
            INNER JOIN #Cte_TextAreaAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                                      AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- inserting TextAreaValue attribute data for Product
            INSERT INTO ZnodePimProductAttributeTextAreaValue
            (
				PimAttributeValueId, 
                LocaleId, 
                AttributeValue, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT SOURCE.PimAttributeValueId, 
                    SOURCE.LocaleId, 
                    SOURCE.AttributeValue, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #Cte_TextAreaAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeTextAreaValue TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );
           
		    ---- Getting attribute default values for product
            INSERT INTO #TBL_DefaultAttributeValue ( PimAttributeValueId, LocaleId, AttributeValue )
            SELECT a.PimAttributeValueId, b.LocaleId, d.PimAttributeDefaultValueId AttributeValue
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                                AND a.PimProductId = b.PimProductId)
            INNER JOIN #TBL_DefaultAttributeId c ON(c.PimAttributeId = b.PimAttributeId)
            CROSS APPLY dbo.split(b.AttributeValue, ',') SP
            INNER JOIN ZnodePimAttributeDefaultValue d ON d.PimAttributeId = b.PimAttributeId
                                                            AND SP.Item = d.AttributeDefaultValueCode;
			---- Deleting prodyuct attribute default value
            DELETE FROM ZnodePimProductAttributeDefaultValue
            WHERE EXISTS
            (
                SELECT TOP 1 1
                FROM #TBL_DefaultAttributeValue TBLAV
                WHERE TBLAV.PimAttributeValueId = ZnodePimProductAttributeDefaultValue.PimAttributeValueId
                        AND TBLAV.AttributeValue <> ZnodePimProductAttributeDefaultValue.PimAttributeDefaultValueId
                        AND ZnodePimProductAttributeDefaultValue.LocaleId = @LocaleId
            );

			---- update ZnodePimProductAttributeDefaultValue : attribute data for Product
			UPDATE TARGET
			SET TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue, 
				TARGET.ModifiedBy = @UserId, 
				TARGET.ModifiedDate = @GetDate
			FROM ZnodePimProductAttributeDefaultValue TARGET
					INNER JOIN #TBL_DefaultAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
																	AND TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue
																	AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- insert ZnodePimProductAttributeDefaultValue : attribute data for Product
            INSERT INTO ZnodePimProductAttributeDefaultValue
            (
				PimAttributeValueId, 
                LocaleId, 
                PimAttributeDefaultValueId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT 
				SOURCE.PimAttributeValueId, 
                SOURCE.LocaleId, 
                SOURCE.AttributeValue, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #TBL_DefaultAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimProductAttributeDefaultValue TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.PimAttributeDefaultValueId = SOURCE.AttributeValue
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );
               

            IF OBJECT_ID('tempdb..#cte_ZnodePimAttributeValue') IS NOT NULL
                DROP TABLE #cte_ZnodePimAttributeValue;

			CREATE TABLE #cte_ZnodePimAttributeValue(PimAttributeValueId int, LocaleId int, AttributeValue nvarchar(max))

			CREATE INDEX Idx_cte_ZnodePimAttributeValue on #cte_ZnodePimAttributeValue(PimAttributeValueId, LocaleId)

			INSERT INTO #cte_ZnodePimAttributeValue (PimAttributeValueId, LocaleId, AttributeValue)
            SELECT a.PimAttributeValueId, b.LocaleId,AttributeValue                
            FROM #ZnodePimAttributeValue AS a
            INNER JOIN #PimProductDetail_Bulk_Process AS b ON(a.PimAttributeId = b.PimAttributeId
                                                                AND ISNULL(a.PimAttributeFamilyId, 0) = ISNULL(b.PimAttributeFamilyId, 0)
                                                                AND a.PimProductId = b.PimProductId)
            WHERE NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_DefaultAttributeId TBLDA WHERE TBLDA.PimAttributeId = b.PimAttributeId )
            AND NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_MediaAttributeId TBLMA WHERE TBLMA.PimAttributeId = b.PimAttributeId )
            AND NOT EXISTS ( SELECT TOP 1 1 FROM #TBL_TextAreaAttributeId TBLTA WHERE TBLTA.PimAttributeId = b.PimAttributeId );

            ---- update ZnodePimAttributeValueLocale : attribute data for Product
            UPDATE TARGET
            SET TARGET.AttributeValue = SOURCE.AttributeValue, 
                TARGET.ModifiedBy = @UserId, 
                TARGET.ModifiedDate = @GetDate
            FROM ZnodePimAttributeValueLocale TARGET
            INNER JOIN #cte_ZnodePimAttributeValue SOURCE ON TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                                                           AND TARGET.LocaleId = SOURCE.LocaleId;

            ---- inserting AttributeDefaultValue : attribute data for Product
            INSERT INTO ZnodePimAttributeValueLocale
            (
				PimAttributeValueId, 
                LocaleId, 
                AttributeValue, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT 
				SOURCE.PimAttributeValueId, 
                SOURCE.LocaleId, 
                SOURCE.AttributeValue, 
                @UserId, 
                @GetDate, 
                @UserId, 
                @GetDate
            FROM #cte_ZnodePimAttributeValue SOURCE
            WHERE NOT EXISTS
            (
                SELECT *
                FROM ZnodePimAttributeValueLocale TARGET
                WHERE TARGET.PimAttributeValueId = SOURCE.PimAttributeValueId
                        AND TARGET.LocaleId = SOURCE.LocaleId
            );

			---- Inserting configurable products into ZnodePimConfigureProductAttribute
            INSERT INTO [ZnodePimConfigureProductAttribute]
            (PimProductId, 
                PimFamilyId, 
                PimAttributeId, 
                CreatedBy, 
                CreatedDate, 
                ModifiedBy, 
                ModifiedDate
            )
            SELECT DISTINCT PD.PimProductId, 
                    NULL, 
                    q.PimAttributeId, 
                    @UserId, 
                    @GetDate, 
                    @UserId, 
                    @GetDate
            FROM #PimProductDetail_Bulk_Process PD
                CROSS APPLY dbo.Split([ConfigureAttributeIds], ',') AS b
                INNER JOIN ZnodePimAttribute AS q ON(q.PimAttributeId = b.Item)
            WHERE NOT EXISTS
            (
                SELECT TOP 1 1
                FROM ZnodePimConfigureProductAttribute RTR
                WHERE RTR.PimProductId = PD.PimProductId
                        AND RTR.PimAttributeId = q.PimAttributeId
            );


			COMMIT TRAN ImportProducts;

            FETCH NEXT FROM cur_BulkData INTO  @MinRow, @MaxRow;
        END;
    CLOSE cur_BulkData;
    DEALLOCATE cur_BulkData;
	-----------Added Performance patch end

		DELETE FROM ZnodePimConfigureProductAttribute  
			WHERE NOT EXISTS (SELECT TOP 1 1  FROM ZnodePimAttributeValue  a WHERE a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId AND a.PimAttributeID = ZnodePimConfigureProductAttribute.PimAttributeID )
			AND EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeValue a 
			INNER JOIN ZnodePimAttribute ty ON (ty.PimAttributeId = a.PimAttributeId)
			INNER JOIN ZnodePimProductAttributeDefaultValue t ON (t.PimAttributeValueId = a.PimAttributeValueId )
			INNER JOIN ZnodePimAttributeDefaultValue y ON (y.PimAttributeDefaultValueId = t.PimAttributeDefaultValueId)
			INNER JOIN View_loadmanageProductInternal  TU ON (TU.AttributeCode = 'SKU' AND TU.PimProductId = a.PimProductId  )
			WHERE ty.AttributeCode = 'ProductType' AND y.AttributeDefaultValueCode = 'ConfigurableProduct'
			AND a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
			AND EXISTS (SELECT TOP 1 1 FROM #PimProductDetail1 TM WHERE TM.PimAttributeID = (SELECT TOP 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'SKU') AND TM.AttributeValue = TU.AttributeValue )) 
					   
						
		----Delete simple products if inserted in table ZnodePimConfigureProductAttribute 
		DELETE FROM ZnodePimConfigureProductAttribute
		WHERE EXISTS
		(
			SELECT TOP 1 1
			FROM ZnodePimAttributeValue a
					INNER JOIN ZnodePimAttribute ty ON(ty.PimAttributeId = a.PimAttributeId)
					INNER JOIN ZnodePimProductAttributeDefaultValue t ON(t.PimAttributeValueId = a.PimAttributeValueId)
					INNER JOIN ZnodePimAttributeDefaultValue y ON(y.PimAttributeDefaultValueId = t.PimAttributeDefaultValueId)
			WHERE ty.AttributeCode = 'ProductType'
					AND y.AttributeDefaultValueCode = 'SimpleProduct'
					AND a.PimProductId = ZnodePimConfigureProductAttribute.PimProductId
		);

		---- Update family of Product in table ZnodePimConfigureProductAttribute 
		UPDATE ZnodePimConfigureProductAttribute
		SET PimFamilyId = b.PimAttributeFamilyId
		FROM ZnodePimConfigureProductAttribute a
				INNER JOIN ZnodePimProduct b ON a.PimProductId = b.PimProductId;

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

             COMMIT TRAN ImportProducts;
         END TRY
         BEGIN CATCH
		 ROLLBACK TRAN ImportProducts;
		  INSERT INTO ZnodeImportLog(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
                 Select  46,ERROR_PROCEDURE(),ERROR_MESSAGE(),ERROR_LINE(),@newGUID,@UserId,@GetDate,@UserId,@GetDate, @ImportProcessLogId  
		
		SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					--SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS  NULL AND  ImportProcessLogId = @ImportProcessLogId;
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

		 UPDATE ZnodeImportProcessLog
			SET 
				STATUS = dbo.Fn_GetImportStatus(3), 
				ProcessCompletedDate = GETDATE()
		WHERE ImportProcessLogId = @ImportProcessLogId;
             SELECT ERROR_MESSAGE(),ERROR_LINE(),ERROR_PROCEDURE();
            -- UPDATE ZnodeImportProcessLog SET Status = dbo.Fn_GetImportStatus(3), ProcessCompletedDate = @GetDate WHERE ImportProcessLogId = @ImportProcessLogId;
            -- ROLLBACK TRAN ImportProducts;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPriceList')
	DROP PROC Znode_ImportPriceList
GO

CREATE PROCEDURE [dbo].[Znode_ImportPriceList]
(
	@TableName nvarchar(100),
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int,
	@NewGUId nvarchar(200),
	@PriceListId int )
AS 
	/*
	----Summary:  Import RetailPrice List 
	----		  Input XML data extracted in table format (table variable name:  #InsertPriceForValidation) by using  @xml.nodes 
	----		  Validate data column wise and store error log into @ErrorLogForInsertPrice table 
	----          Remove wrong data from table #InsertPriceForValidation and inserted correct data into @InsertPrice table for 
	----		  further processing (Importing to target database )
	---- Version 1 : Required Validation 
	---- UomName should not be null 
	---- Data for this RetailPrice list is already available  
	---- Version 2 : Required Validation 
	---- If UomName will be null then insert first record from UomTable and If UomName is wrong then raise error
	---- SKU with retailprice data is available with price list id will insert 
	---- multiple SKU with retail price is available then updated last sku details to price table and price tier table for respective price list
	----1. Import functionality should be provided only for single price list (Validate - Pending) 
	----  Tier price : TierStartQuantity should not between TierStartQuantity and TierEndQuantity for already existing SKU 
	----  In case of update details for SKU if any kind of price value will null then avoid it to update on existing value. 
	----2. From XML only SKU and RetailPrice is mandatory
	----3. SKUActivation date sholud be less than SKUExpriration date
	----4. Activation date sholud be less than Expiration date
	----5. If Tier RetailPrice has values and TierSartQuantity /TierEndQuantity or both has null value then it should not get updated/created.
	----6. ActivationDate and ExpirationDate value for tier price will be SKUActivationDate SKUExprirationDate 
	--- Change History : 
	--Remove column which is used to store range of qunatity by single column Quantity from table ZnodeTierProduct 
	--Manditory Retail price in Znodepricetable 
	-- SKUActivationfrom date and to date will used for tier price will store in single table ZnodePrice
	--Unit Testing   
	
*/
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
	    DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		
		IF OBJECT_ID('#InsertPriceForValidation', 'U') IS NOT NULL 
			DROP TABLE #InsertPriceForValidation
		ELSE 
			CREATE TABLE #InsertPriceForValidation 
			(SKU varchar(300) NULL, TierStartQuantity varchar(300) NULL, RetailPrice varchar(300) NULL, SalesPrice varchar(300) NULL, TierPrice varchar(300) NULL, SKUActivationDate varchar(300) NULL, SKUExpirationDate varchar(300) NULL,
			Custom1 varchar(300) NULL, Custom2 varchar(300) NULL, Custom3 varchar(300) NULL,CostPrice varchar(100), RowNumber varchar(300) NULL)

		IF OBJECT_ID('#InsertPrice', 'U') IS NOT NULL 
			DROP TABLE #InsertPrice
		ELSE 
			CREATE TABLE #InsertPrice 
			( 
				SKU varchar(300), TierStartQuantity numeric(28, 6) NULL, RetailPrice numeric(28, 6) NULL, SalesPrice numeric(28, 6) NULL, TierPrice numeric(28, 6) NULL, SKUActivationDate varchar(300) NULL, SKUExpirationDate varchar(300) NULL,
				Custom1 varchar(300) NULL, Custom2 varchar(300) NULL, Custom3 varchar(300) NULL,CostPrice numeric(28, 6), RowNumber varchar(300)
			);
	
	
		DECLARE @SKU TABLE
		( 
				SKU nvarchar(300)
		);
		INSERT INTO @SKU
			   SELECT b.AttributeValue
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;


		DECLARE @RoundOffValue int, @MessageDisplay nvarchar(100); 
		-- Retrive RoundOff Value from global setting 

		SELECT @RoundOffValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'PriceRoundOff';
	
		--@MessageDisplay will use to display validate message for input inventory value  

		DECLARE @sSql nvarchar(max);
		SET @sSql = ' Select @MessageDisplay_new = Convert(Numeric(28, '+CONVERT(nvarchar(200), @RoundOffValue)+'), 999999.000000000 ) ';
		EXEC SP_EXecutesql @sSql, N'@MessageDisplay_new NVARCHAR(100) OUT', @MessageDisplay_new = @MessageDisplay OUT;
		

		SET @SSQL = 'Select SKU,TierStartQuantity ,RetailPrice,SalesPrice,TierPrice,SKUActivationDate ,SKUExpirationDate ,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber FROM '+@TableName;
		INSERT INTO #InsertPriceForValidation( SKU, TierStartQuantity, RetailPrice, SalesPrice, TierPrice, SKUActivationDate, SKUExpirationDate,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber )
		EXEC sys.sp_sqlexec @SSQL;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'TierPrice', TierPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(TierPrice)=0  
				or exists(select * from ZnodeCulture where Symbol is not null and TierPrice like '%'+Symbol+'%')) and ISNULL(TierPrice,'')<>''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'SalesPrice', SalesPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(SalesPrice)=0	or exists(select * from ZnodeCulture where Symbol is not null and SalesPrice like '%'+Symbol+'%'))
				and ISNULL(SalesPrice,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'RetailPrice', RetailPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(RetailPrice)=0 or exists(select * from ZnodeCulture where Symbol is not null and RetailPrice like '%'+Symbol+'%')) and ISNULL(RetailPrice,'')<>''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'CostPrice', CostPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(CostPrice)=0	or exists(select * from ZnodeCulture where Symbol is not null and CostPrice like '%'+Symbol+'%'))
				and ISNULL(CostPrice,'')<>''
		
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertPriceForValidation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL
			   			  	
	    --- Delete Invalid Data after functional validation 
		DELETE FROM #InsertPriceForValidation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  Guid = @NewGUId
		);
		-- 1)  Validation for SKU is pending Proper data not found and 
		--Discussion still open for Publish version where we create SKU and use the SKU code for validation 
		--Select * from ZnodePimAttributeValue  where PimAttributeId =248
		--select * from View_ZnodePimAttributeValue Vzpa Inner join ZnodePimAttribute Zpa on Vzpa.PimAttributeId=Zpa.PimAttributeId where Zpa.AttributeCode = 'SKU'
		--Select * from ZnodePimAttribute where AttributeCode = 'SKU'
		--------------------------------------------------------------------------------------
		--2)  Start Data Type Validation for XML Data  
		--------------------------------------------------------------------------------------			
		---------------------------------------------------------------------------------------
		---------If UOM will blank then retrive top -- Finctionality pending 
		---Validate 
		
		INSERT INTO #InsertPrice( SKU, TierStartQuantity, RetailPrice, SalesPrice, TierPrice, SKUActivationDate, SKUExpirationDate,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber )
			   SELECT SKU,
					  CASE
					  WHEN CONVERT(Varchar(100),TierStartQuantity) = '' THEN 0
					  ELSE CONVERT(numeric(28, 6), TierStartQuantity)
					  END, CONVERT(numeric(28, 6), RetailPrice),
															  CASE
															  WHEN SalesPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), SalesPrice)
															  END,
															  CASE
															  WHEN TierPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), TierPrice)
															  END, SKUActivationDate, SKUExpirationDate,
															   Custom1, Custom2, Custom3,
															   CASE
															  WHEN CostPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), CostPrice)
															  END, RowNumber
			   FROM #InsertPriceForValidation;
			 
		--------------------------------------------------------------------------------------
		--- start Functional Validation 
		--------------------------------------------------------------------------------------
		--- Verify SKU is present or not 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '19', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertPrice AS ii
		WHERE ii.SKU NOT IN
		(
			SELECT SKU
			FROM @SKU
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '39', 'SKUActivationDate', SKUActivationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPrice AS IP
			   WHERE SKUActivationDate < SKUExpirationDate AND 
					 ISNULL(SKUExpirationDate, '') <> '';
					 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '35', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation
			   WHERE( TierPrice IS NULL OR TierPrice = '0') AND  TierStartQuantity  = '';
			  
			  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '35', 'TierPrice', TierPrice, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation WHERE( TierPrice IS NULL OR  TierPrice = '') AND TierStartQuantity  <> 0;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '26', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation IPV
			   WHERE TierStartQuantity = ''  
				AND	( TierPrice <> ''  OR TierPrice IS NULL ) 

			  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '26', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation IPV
			   WHERE TierStartQuantity <> '' AND 
			    ISNULL(CAST(TierStartQuantity AS numeric(28, 6)), 0) <= 0 
				AND	( TierPrice <> ''  OR TierPrice IS NULL ) 
		
		
				  
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertPrice IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

			 
 	
		-- End Function Validation 	
		---------------------------
		--- Delete Invalid Data after functional validation 
		DELETE FROM #InsertPrice
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  Guid = @NewGUId
		);
	
		-- Remove duplicate records 
		--insert into @RemoveDuplicateInsertPrice
		--(SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber )
		--Select SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber FROM @InsertPrice 
		
		--Delete from @InsertPrice 

		--insert into @InsertPrice (SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber)
		--Select SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber from @RemoveDuplicateInsertPrice rdip WHERE rdip.RowNumber IN
		--(
		--	SELECT MAX(ipi.RowNumber) FROM @InsertPrice ipi WHERE rdip.PriceListCode = ipi.PriceListCode AND rdip.SKU = ipi.SKU
		--);

		--Validate StartQuantity and EndQuantity from PriceTier : This validation only for existing data 
		--INSERT INTO @ErrorLogForInsertPrice (RowNumber,SKU,TierStartQuantity ,RetailPrice ,SalesPrice,TierPrice,Uom ,UnitSize,PriceListCode,PriceListName,CurrencyId ,ActivationDate,ExpirationDate,SKUActivationDate,SKUExpirationDate,SequenceNumber,ErrorDescription) 
		--Select IP.RowNumber,IP.SKU,IP.TierStartQuantity ,IP.RetailPrice ,IP.SalesPrice,IP.TierPrice,IP.Uom ,IP.UnitSize,IP.PriceListCode,IP.PriceListName,IP.CurrencyId ,IP.ActivationDate,IP.ExpirationDate,IP.SKUActivationDate,IP.SKUExpirationDate,IP.SequenceNumber,
		--'TierStartQuantity already exists in PriceTier table for SKU '
		--From @InsertPrice IP  Inner join
		--ZnodePriceList Zpl ON Zpl.Listcode = IP.PriceListcode and Zpl.ListName = IP.PriceListName
		--INNER JOIN ZnodeUOM Zu ON ltrim(rtrim(IP.Uom)) = ltrim(rtrim(Zu.Uom)) 
		--INNER JOIN ZnodePriceTier ZPT  ON ZPT.PriceListId = Zpl.PriceListId 
		--AND ZPT.SKU = IP.SKU
		--Where IP.TierStartQuantity  = ZPT.Quantity  
		--- Delete Invalid Data after  Validate StartQuantity and EndQuantity from PriceTier
		
		--INSERT INTO ZnodeUOM (Uom,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--Select distinct ltrim(rtrim(Uom)) , @UserId,@GetDate,@UserId,@GetDate  from @InsertPrice 
		--where ltrim(rtrim(Uom)) not in (Select ltrim(rtrim(UOM)) From ZnodeUOM where UOM  is not null )
		
		DECLARE @FailedRecordCount BIGINT, @SuccessRecordCount BIGINT 
	
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;

		SELECT @SuccessRecordCount = COUNT(DISTINCT ROWNUMBER) FROM #InsertPrice WHERE 	ROWNUMBER IS NOT NULL ;

		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		UPDATE ZP
				SET ZP.SalesPrice = IP.SalesPrice, ZP.RetailPrice = CASE
				WHEN CONVERT(varchar(100), ISNULL(IP.RetailPrice, '')) <> '' THEN IP.RetailPrice
				END, ZP.ActivationDate = CASE
				WHEN ISNULL(IP.SKUActivationDate, '') <> '' THEN IP.SKUActivationDate
				ELSE NULL
				END, ZP.ExpirationDate = CASE
				WHEN ISNULL(IP.SKUExpirationDate, '') <> '' THEN IP.SKUExpirationDate
				ELSE NULL
				END, ZP.ModifiedBy = @UserId, ZP.ModifiedDate = @GetDate,
				ZP.CostPrice =IP.CostPrice
		FROM #InsertPrice IP INNER JOIN ZnodePrice ZP ON ZP.PriceListId = @PriceListId AND  ZP.SKU = IP.SKU  
			 --Retrive last record from price list of specific SKU ListCode and Name 									
		WHERE IP.RowNumber IN
		(
			SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU 
		);
		INSERT INTO ZnodePrice( PriceListId, SKU, SalesPrice, RetailPrice, ActivationDate, ExpirationDate, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate,CostPrice )
			   SELECT @PriceListId, IP.SKU, IP.SalesPrice, IP.RetailPrice,
																						   CASE
																						   WHEN ISNULL(IP.SKUActivationDate, '') = '' THEN NULL
																						   ELSE IP.SKUActivationDate
																						   END,
																						   CASE
																						   WHEN ISNULL(IP.SKUExpirationDate, '') = '' THEN NULL
																						   ELSE IP.SKUExpirationDate
																						   END, @UserId, @GetDate, @UserId, @GetDate,IP.CostPrice
			   FROM #InsertPrice AS IP
			   WHERE NOT EXISTS
			   (
				   SELECT TOP 1 1
				   FROM ZnodePrice
				   WHERE ZnodePrice.PriceListId = @PriceListId AND 
						 ZnodePrice.SKU = IP.SKU 
			   ) AND 
					 IP.RowNumber IN
			   (
					SELECT MAX(IPI.RowNumber)
					FROM #InsertPrice AS IPI
					WHERE IPI.SKU = IP.SKU 
			   );

			 

		IF EXISTS
		(
			SELECT TOP 1 1
			FROM #InsertPrice
			WHERE CONVERT(varchar(100), TierStartQuantity) <> '' AND 
				  (CONVERT(varchar(100), TierPrice) <> '' OR CONVERT (varchar(100), TierPrice) IS NOT NULL)
		)
		BEGIN
		
			UPDATE ZPT
			  SET ZPT.Price = IP.TierPrice, ZPT.ModifiedBy = @UserId, ZPT.ModifiedDate = @GetDate,
			  ZPT.Custom1 = IP.Custom1,ZPT.Custom2 = IP.Custom2, ZPT.Custom3 = IP.Custom3 
			FROM #InsertPrice IP INNER JOIN ZnodePriceTier ZPT ON ZPT.PriceListId = @PriceListId AND  ZPT.SKU = IP.SKU AND ZPT.Quantity = IP.TierStartQuantity 
		    --Retrive last record from price list of specific SKU ListCode and Name 
			WHERE IP.RowNumber IN
			(
				SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU AND IPI.TierStartQuantity = IP.TierStartQuantity 
			);

			INSERT INTO ZnodePriceTier( PriceListId, SKU, Price, Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, Custom1, Custom2, Custom3 )
				   SELECT @PriceListId, IP.SKU, IP.TierPrice, IP.TierStartQuantity,  @UserId, @GetDate, @UserId, @GetDate, Custom1, Custom2, Custom3
				   FROM #InsertPrice AS IP 
				   WHERE NOT EXISTS
				   (
					   SELECT TOP 1 1 FROM ZnodePriceTier WHERE ZnodePriceTier.PriceListId = @PriceListId AND  ZnodePriceTier.SKU = IP.SKU AND 
							 ZnodePriceTier.Quantity = IP.TierStartQuantity
				   ) AND  IP.RowNumber IN
				   (
					   SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU AND  IPI.TierStartQuantity = IP.TierStartQuantity
				   );
		END;  

		SET @Status = 1;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		-- COMMIT TRAN ImportProducts;
		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPriceList @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PriceListId='+CAST(@PriceListId AS VARCHAR(max));
		
		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportPriceList',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSEODetails')
	DROP PROC Znode_ImportSEODetails
GO


CREATE PROCEDURE [dbo].[Znode_ImportSEODetails]
(  
   @TableName NVARCHAR(100), 
   @Status BIT OUT, 
   @UserId INT, 
   @ImportProcessLogId INT, 
   @NewGUId NVARCHAR(200), 
   @LocaleId INT= 1,
   @PortalId INT ,
   @CsvColumnString NVARCHAR(max)
)  
AS  
 --------------------------------------------------------------------------------------  
 -- Summary :  Import SEO Details  
   
 -- Unit Testing :   
 --------------------------------------------------------------------------------------  
  
BEGIN  
BEGIN TRAN A;  
BEGIN TRY  
   
	DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max);  
	DECLARE @GetDate DATETIME= dbo.Fn_GetDate();  
    
    
	DECLARE @CMSSEOTypeProduct INT ,@CMSSEOTypeCategory INT  
  
	SELECT @CMSSEOTypeProduct = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product'  
	SELECT @CMSSEOTypeCategory = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Category'  
  
  
	-- Three type of import required three table varible for product , category AND brAND  
	DECLARE @InsertSEODetails TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),   
		RobotTag VARCHAR(50), GUID NVARCHAR(400)  
	);  
  
	DECLARE @InsertSEODetailsOFProducts TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
	DECLARE @InsertSEODetailsOFCategory TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200), 
		RobotTag VARCHAR(50),GUID NVARCHAR(400)
	);  
  
	DECLARE @InsertSEODetailsOFBrAND TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
    
	DECLARE @InsertedZnodeCMSSEODetail TABLE  
	(   
		CMSSEODetailId INT , SEOCode Varchar(4000), CMSSEOTypeId INT  
	);  
    
	--SET @SSQL = 'SELECT RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,GUID  FROM '+@TableName;  
	SET @SSQL = 'SELECT RowNumber,'+@CsvColumnString+',GUID  FROM '+@TableName;  
  
	INSERT INTO @InsertSEODetails(RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,RedirectFrom,RedirectTo,EnableRedirection,CanonicalURL,RobotTag,GUID )  
	EXEC sys.sp_sqlexec @SSQL;  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '30', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.SEOURL IN (SELECT ISD.SEOURL FROM @InsertSEODetails ISD Group by ISD.SEOUrl having count(*) > 1 ) 
	    
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '10', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.SEOUrl = ii.SEOUrl AND ZCSD.PortalId = @PortalId
	AND ZCSD.SEOCode <> ii.Code  AND EXISTS  
	(SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale dl WHERE dl.CMSSEODetailId = ZCSD.CMSSEODetailId AND dl.LocaleId = @LocaleId  
	AND dl.SEODescription = ii.SEODescription AND dl.SEOTitle = ii.SEOTitle AND dl.SEOKeywords = ii.SEOKeywords))   
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '53', 'RedirectFrom', RedirectFrom, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM IN (SELECT ISD.RedirectFROM FROM @InsertSEODetails ISD Group by ISD.RedirectFROM having count(*) > 1 )   
	AND (ii.RedirectFROM <> '' )

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '35', 'RedirectFrom\RedirectTo', RedirectFROM + '  ' + RedirectTo  , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM = ii.RedirectTo  
	AND (ii.RedirectFROM <> '' AND ii.RedirectTo <> '' )
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '35', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE LTRIM(RTRIM(ISNULL(ii.SEOUrl,''))) like '% %' -----space not allowed  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '19', 'ImportType', ImportType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.ImportType NOT IN   
	(  
		SELECT NAME FROM ZnodeCMSSEOType WHERE NAME NOT IN ('Content Page','BlogNews','Brand')  
	);  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '35', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.IsActive not IN ('True','1','Yes','FALSE','0','No')
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '9', 'RobotTag', RobotTag, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.RobotTag not IN ( 'INDEX_FOLLOW','NOINDEX_NOFOLLOW','NOINDEX_FOLLOW','INDEX_NOFOLLOW','1','2','3','4') 
	AND ISNULL(ii.RobotTag,'')<>''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SEOCode - ' + ISNULL(Code,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSEODetails IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	DELETE FROM @InsertSEODetails  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  

	-------------------------------------------------------------------------------------------------------------------------------  
  
	INSERT INTO @InsertSEODetailsOFProducts(  RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
	CASE WHEN IsActive IN ('True','1','Yes') 
	Then 1 
	ELSE 0
	END as IsActive, SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Product'  
  
  
	INSERT INTO @InsertSEODetailsOFCategory( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Category'  
  
	INSERT INTO @InsertSEODetailsOFBrand( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl ,
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Brand'  
  
  
	-- start Functional Validation   
	--1. Product  
	--2. Category  
	--3. Content Page  
	--4. BrAND  
	-----------------------------------------------  
  
    
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '19', 'SKU', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFProducts AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPAVL.AttributeValue  
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'SKU' AND ZPAVL.AttributeValue IS NOT NULL   
	)  AND ImportType = 'Product';  
  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '19', 'Category', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFCategory AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPCAVL.CategoryValue  
		FROM ZnodePimCategoryAttributeValue ZPCAV   
		INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAVL on ZPCAV.PimCategoryAttributeValueId = ZPCAVL.PimCategoryAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPCAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPCAVL.CategoryValue IS NOT NULL  
	)  AND ImportType = 'Category';  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '19', 'Brand', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFBrAND AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT BrandCode FROM ZnodeBrandDetails WHERE BrandCode IS NOT NULL  
	)  AND ImportType = 'Brand';  
    
	-- UPDATE Record count IN log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSEODetails
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;
	

	--Note : Content page import is not required   
    
	-- End Function Validation    
	-----------------------------------------------  
	--- Delete Invalid Data after functional validatin    
 
	DELETE FROM @InsertSEODetailsOFProducts  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFCategory  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFBrAND  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
 
	-- Insert Product Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFProducts)  
	BEGIN  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords
			,ZCSDL.CanonicalURL = ISD.CanonicalURL
			,ZCSDL.RobotTag = ISD.RobotTag  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId = @PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		----Making product as draft if SEOUrl is changed for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertSEODetailsOFProducts ISD    
			INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code
			WHERE ZPAVL.AttributeValue = ZCSD.SEOCode)
     
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate, CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeProduct   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
     
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeProduct,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate FROM   
		@InsertSEODetailsOFProducts ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code AND  ZCSD.PortalId =@PortalId   );  
    
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFProducts ISD ON IZCSD.SEOCode = ISD.Code   

		----Making product as draft if SEOUrl is inserted for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertedZnodeCMSSEODetail IZCSD WHERE ZPAVL.AttributeValue = IZCSD.SEOCode)
  
		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFProducts SDP  
		WHERE IsRedirect = 1
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
  
	END  
  
	-- Insert Category Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFCategory)  
	BEGIN  
  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords 
			,CanonicalURL = ISD.CanonicalURL
			,RobotTag = ISD.RobotTag
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeCategory   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
  
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeCategory,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate   
		FROM @InsertSEODetailsOFCategory ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode  = ISD.Code AND ZCSD.PortalId = @PortalId );  
  
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFCategory ISD ON IZCSD.SEOCode = ISD.Code   
		WHERE IZCSD.CMSSEOTypeId =@CMSSEOTypeCategory    

		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFCategory SDP  
		WHERE IsRedirect = 1 
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
	END  

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId; 
  
COMMIT TRAN A;  
END TRY  
BEGIN CATCH  
ROLLBACK TRAN A;

	SET @Status = 0;  
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE(); 

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportSEODetails @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) ;

	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total AND fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSEODetails',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
    
END CATCH;  
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportStoreLocatorAddress')
	DROP PROC Znode_ImportStoreLocatorAddress
GO



CREATE PROCEDURE [dbo].[Znode_ImportStoreLocatorAddress](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @CsvColumnString nvarchar(max))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max),@IsAllowGlobalLevelUserCreation nvarchar(10)

		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		-- Retrive Value from global setting 
		Select @IsAllowGlobalLevelUserCreation = FeatureValues from ZnodeGlobalsetting where FeatureName = 'AllowGlobalLevelUserCreation'
		-- Three type of import required three table varible for product , category and brand

		CREATE TABLE #InsertCustomerAddress 
		( 
			 RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int,PortalCode	nvarchar(600),StoreLocatorName	nvarchar(600)
			,FirstName	varchar	(300),LastName	varchar	(300),DisplayName	nvarchar(1200),Address1	varchar	(300),Address2	varchar	(300)
			,CountryName	varchar	(3000),StateName	varchar	(3000),CityName	varchar	(3000),PostalCode	varchar	(50)
			,PhoneNumber	varchar	(50),
			IsDefaultBilling	bit 
			,IsDefaultShipping	bit	,IsActive	bit	,ExternalId	nvarchar(2000),CompanyName nvarchar(2000), GUID NVARCHAR(400),
			DisplayOrder int ,Latitude decimal, Longitude decimal
		);
		
		SET @SSQL = 'INSERT INTO #InsertCustomerAddress( RowNumber,' + @CsvColumnString + ' ,GUID )
		SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		--INSERT INTO @InsertCustomerAddress( RowNumber,PortalCode,StoreLocatorName,FirstName,LastName,DisplayName,Address1,Address2,CountryName,
		--									StateName,CityName,PostalCode,PhoneNumber,
		--									IsDefaultBilling,IsActive,IsDefaultShipping,ExternalId,CompanyName,DisplayOrder,Latitude,Longitude,GUID )
		--print @SSQL
		EXEC sys.sp_sqlexec @SSQL;

		-- start Functional Validation 
		-----------------------------------------------
		--,PortalCode	,StoreName,IsStoreActive

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '19', 'PortalCode', PortalCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertCustomerAddress AS ii
				WHERE ii.PortalCode NOT IN 
				(
					SELECT StoreCode FROM ZnodePortal 
				);
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '8', 'StoreLocatorName', StoreLocatorName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertCustomerAddress AS ii
				WHERE ISnull(ltrim(rtrim(ii.StoreLocatorName)), '') = ''


		DELETE FROM #InsertCustomerAddress
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);

		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomerAddress
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

				--DECLARE #InsertedUserAddress TABLE (AddressId  nvarchar(256), PortalId nvarchar(max), PortalCode nvarchar(max)) 
				CREATE TABLE #InsertedUserAddress (AddressId  nvarchar(256), PortalId nvarchar(max), PortalCode nvarchar(max)) 
				
				----------update ZnodeAddress				
				DECLARE @AddressColumnString VARCHAR(1000), @WhereConditionString VARCHAR(1000), @UpdateColumnString VARCHAR(1000)

				SELECT @AddressColumnString = COALESCE(@AddressColumnString + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' and ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
				FROM ZnodeImportUpdatableColumns a
				INNER JOIN INFORMATION_SCHEMA.COLUMNS b on a.ColumnName = b.COLUMN_NAME  
				INNER JOIN dbo.Split(@CsvColumnString,',')C on b.COLUMN_NAME = c.Item
				WHERE b.TABLE_NAME = 'ZnodeAddress' 
				AND EXISTS(SELECT * FROM ZnodeImportHead IH where a.ImportHeadId = IH.ImportHeadId and IH.Name = 'StoreLocator')
				
				SELECT @UpdateColumnString = COALESCE(@UpdateColumnString + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
				FROM INFORMATION_SCHEMA.COLUMNS a
				INNER JOIN dbo.Split(@CsvColumnString,',')b on a.COLUMN_NAME = b.Item
				WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString,',') c WHERE a.COLUMN_NAME = c.Item )
				AND a.TABLE_NAME = 'ZnodeAddress'

				SELECT @WhereConditionString = COALESCE(@WhereConditionString + ' AND ', '') +'ZA.'+item+' =  IC.'+item from dbo.split(@AddressColumnString,',')

				SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END

				EXEC (@SSQL)
								
				SET @SSQL = '		
				Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
										StateName,CityName,PostalCode,PhoneNumber,
										IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
				OUTPUT INSERTED.AddressId , inserted.Address3 INTO  #InsertedUserAddress (AddressId,PortalCode) 			 
				SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2, IC.PortalCode +  ''~'' + IC.StoreLocatorName,IC.CountryName,
				IC.StateName,IC.CityName,IC.PostalCode,IC.PhoneNumber,
				isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate()  
				FROM  #InsertCustomerAddress IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'
				--print @SSQL
				EXEC (@SSQL)
				
				DECLARE @AddressColumnString1 VARCHAR(1000), @WhereConditionString1 VARCHAR(1000), @UpdateColumnString1 VARCHAR(1000)

				SELECT @AddressColumnString1 = COALESCE(@AddressColumnString1 + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' and ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
				FROM ZnodeImportUpdatableColumns a
				INNER JOIN INFORMATION_SCHEMA.COLUMNS b on a.ColumnName = b.COLUMN_NAME  
				INNER JOIN dbo.Split(@CsvColumnString,',')C on b.COLUMN_NAME = c.Item
				WHERE b.TABLE_NAME = 'ZnodePortalAddress' 
				AND EXISTS(SELECT * FROM ZnodeImportHead IH where a.ImportHeadId = IH.ImportHeadId and IH.Name = 'StoreLocator')

				--print @AddressColumnString

				SELECT @UpdateColumnString1 = COALESCE(@UpdateColumnString1 + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
				FROM INFORMATION_SCHEMA.COLUMNS a
				INNER JOIN dbo.Split(@CsvColumnString,',')b on a.COLUMN_NAME = b.Item
				WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString1,',') c WHERE a.COLUMN_NAME = c.Item )
				AND a.TABLE_NAME = 'ZnodePortalAddress'

				SELECT @WhereConditionString1 = COALESCE(@WhereConditionString1 + ' AND ', '') +'ZA.'+item+' =  IC.'+item from dbo.split(@AddressColumnString1,',')

				DECLARE @AccountId INT
				SELECT @AccountId = AccountId FROM ZnodeUser where UserId = @UserId

				SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+' ,ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString1,'') = '' THEN '' ELSE ','+@UpdateColumnString1 END+' 
						FROM ZnodePortalAddress ZA
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString1,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString1 END
				--print @SSQL		
				EXEC (@SSQL)

				SET @SSQL = '
				INSERT INTO ZnodePortalAddress ( PortalId,AddressId,MediaId,StoreName,DisplayOrder,Latitude,Longitude
				,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
				Select ZP.PortalId ,IUA.AddressId,NULL,IC.StoreLocatorName, IC.DisplayOrder,IC.Latitude,IC.Longitude 
				,'+CONVERT(VARCHAR(10), @UserId)+' , getdate() '+' , '+CONVERT(VARCHAR(10), @UserId)+' , getdate()    
				from #InsertCustomerAddress IC INNER JOIN #InsertedUserAddress IUA ON 
				IC.PortalCode + ''~'' + IC.StoreLocatorName  = IUA.PortalCode
				INNER JOIN ZnodePortal ZP on IC.PortalCode = ZP.Code
				WHERE NOT EXISTS ( SELECT * FROM ZnodePortalAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString1,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString1 END +')'
				--print @SSQL
				EXEC (@SSQL)
				
				UPDATE ZA SET ZA.Address3 = null 
				From ZnodeAddress ZA INNER JOIN #InsertedUserAddress IUA ON ZA.AddressId = IUA.AddressId 

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportStoreLocatorAddress @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportStoreLocatorAddress',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportUserApproval')
	DROP PROC Znode_ImportUserApproval
GO



CREATE PROCEDURE [dbo].[Znode_ImportUserApproval]
(
	  @TableName nvarchar(100), 
	  @Status bit OUT, 
	  @UserId int, 
	  @ImportProcessLogId int, 
	  @NewGUId nvarchar(200), 
	  @LocaleId int= 0,
	  @PortalId int ,
	  @CsvColumnString nvarchar(max)
	  )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max),@AspNetZnodeUserId nvarchar(256),@ASPNetUsersId nvarchar(256),
		@PasswordHash nvarchar(max),@SecurityStamp nvarchar(max),@RoleId nvarchar(256),@IsAllowGlobalLevelUserCreation nvarchar(10)
		Declare @ProfileId  int 
	
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		-- Retrive RoundOff Value from global setting 

		-- Three type of import required three table varible for product , category and brand
		DECLARE @InsertZnodeUserApprovers TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int,UserName nvarchar(512),LevelCode VARCHAR(200) ,ApproverUserName nvarchar(512),ApproverOrder int ,
			IsNotifyEmail  bit ,IsMandatory bit,Custom1 nvarchar(max) ,Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4 nvarchar(max),Custom5 nvarchar(max),
			FromBudgetAmount Numeric(28,6),ToBudgetAmount Numeric(28,6) ,IsNoLimit bit 			, GUID NVARCHAR(400)
		);


		SET @SSQL = 'SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		INSERT INTO @InsertZnodeUserApprovers( RowNumber ,UserName ,LevelCode  ,ApproverUserName ,ApproverOrder  ,
			IsNotifyEmail   ,IsMandatory ,Custom1  ,Custom2 ,Custom3 ,Custom4 ,Custom5 ,
			FromBudgetAmount ,ToBudgetAmount ,IsNoLimit  			, GUID )
		EXEC sys.sp_sqlexec @SSQL;
		
		-- start Functional Validation 

		-----------------------------------------------
		If @IsAllowGlobalLevelUserCreation = 'true'
			BEGIN 
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
					   SELECT '14', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
					   FROM @InsertZnodeUserApprovers AS ii
					   WHERE ii.UserName not in 
					   (
						   SELECT UserName FROM AspNetZnodeUser   where PortalId = @PortalId
					   );
		 END 
		Else 
		BEGIN 
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
					   SELECT '14', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
					   FROM @InsertZnodeUserApprovers AS ii
					   WHERE ii.UserName not in 
					   (
						   SELECT UserName FROM AspNetZnodeUser   
					   );
         END 
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
					   SELECT '14', 'ApproverUserName', ApproverUserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
					   FROM @InsertZnodeUserApprovers AS ii
					   WHERE ii.ApproverUserName not in 
					   (
						   SELECT UserName FROM AspNetZnodeUser   
					   );
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
					   SELECT '14', 'LevelCode', LevelCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
					   FROM @InsertZnodeUserApprovers AS ii
					   WHERE ii.LevelCode not in 
					   (
						   SELECT LevelCode FROM ZnodeApproverLevel   
					   );

			SELECT * FROM ZnodeMessage

		
		--Note : Content page import is not required 
		
		-- End Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  
		
		DELETE FROM @InsertZnodeUserApprovers
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);

		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertZnodeUserApprovers
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
			TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
		SELECT DISTINCT UserId , m.UserName 
		INTO #ZnodeUser
		FROM AspNetZnodeUser m 
		INNER JOIN AspNetUsers a ON (a.UserName = m.AspNetZnodeUserId) 
		INNER JOIN ZnodeUser b ON (b.AspNetUserId  = a.id)	
		WHERE EXISTS (SELECT TOP 1 1 FROM @InsertZnodeUserApprovers Y WHERE Y.UserName = M.UserName )
			 OR EXISTS (SELECT TOP 1 1 FROM @InsertZnodeUserApprovers Y WHERE Y.ApproverUserName = M.UserName )

		UPDATE a 
		SET a.UserName = (SELECT TOP 1 UserId FROM  #ZnodeUser m WHERE m.UserName = a.UserName )
		, a.ApproverUserName = (SELECT TOP 1 UserId FROM  #ZnodeUser m WHERE m.UserName = a.ApproverUserName )
		, a.LevelCode = (SELECT TOP 1 ApproverLevelId FROM ZnodeApproverLevel m WHERE m.LevelCode = a.LevelCode)
		FROM @InsertZnodeUserApprovers a 
	  
	    UPDATE  ZUA
		SET  ApproverOrder = IZUA.ApproverOrder
		,IsNotifyEmail = IZUA.IsNotifyEmail
		,IsMandatory = IZUA.IsMandatory
		,Custom1 = IZUA.Custom1
		,Custom2 = IZUA.Custom2
		,Custom3 = IZUA.Custom3
		,Custom4 = IZUA.Custom4
		,Custom5 = IZUA.Custom5 
		,ModifiedBy= @UserId
		,ModifiedDate = @GetDate
		,FromBudgetAmount = IZUA.FromBudgetAmount
		,ToBudgetAmount = IZUA.ToBudgetAmount
		,IsNoLimit = IZUA.IsNoLimit
		FROM ZnodeUserApprovers ZUA
		INNER JOIN @InsertZnodeUserApprovers IZUA ON (IZUA.Username = ZUA.UserId AND IZUA.ApproverUsername = ZUA.ApproverUserId AND IZUA.LevelCode = ZUA.ApproverLevelId)
		-- Insert Product Data 
		INSERT INTO ZnodeUserApprovers
				(UserId,ApproverLevelId,ApproverUserId,ApproverOrder,IsNotifyEmail,IsMandatory,Custom1,Custom2,Custom3,Custom4,Custom5
					,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,FromBudgetAmount,ToBudgetAmount,IsNoLimit)
		SELECT Username,LevelCode,ApproverUsername,ApproverOrder,IsNotifyEmail,IsMandatory,Custom1,Custom2,Custom3,Custom4,Custom5
					,@UserId,@GetDate,@UserId,@GetDate,FromBudgetAmount,ToBudgetAmount,IsNoLimit
		FROM @InsertZnodeUserApprovers
				
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportUserApproval @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) ;


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportUserApproval',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData
GO


CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0 )
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max),
				@FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
            --To get the total record count for update purpose in catch block
            SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			INSERT INTO Znode_ImportCsvRowCount
			EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

			CREATE TABLE #DefaultAttributeCode
			(AttributeTypeName          VARCHAR(300),
			PimAttributeDefaultValueId INT,
			PimAttributeId             INT,
			AttributeDefaultValueCode  VARCHAR(100)
			);

			IF( @ImportHeadName = 'B2BCustomer' )
			BEGIN
				EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
			END
		
             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'Product'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @DefaultFamilyId = 0
                AND @ImportHeadName IN('Product', 'Category')
                 BEGIN 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
				 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;      
             -- Check attributes are manditory and not provided with source table
		   	 
			if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
			Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )

			INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
			SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
			FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
			ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
			LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
			and ZIAV.AttributeCode = ZITM.TargetColumnName
			AND ZITM.ImportTemplateId  = @TemplateId
			WHERE ZIAV.ImportHeadId = @ImportHeadId --ORDER BY ZIAV.SequenceNumber


		    SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
             )
             EXEC sys.sp_sqlexec  @SQLQuery;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('Product', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @FamilyAttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''
                                          AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							Delete FAD from @AttributeDetail FAD
							where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
							DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'File'
                                   AND ValidationName <> 'IsAllowMultiUpload';

                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;

                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';

                         END;
                     ELSE
                         BEGIN
					
					
                             --Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC [Znode_ImportGetOtherTemplateDetails]
                                  @TemplateId = @TemplateId,
                                  @ImportHeadId = @ImportHeadId;

							IF @ImportHeadName IN('B2BCustomer')
							BEGIN

								INSERT INTO @AttributeDetail
								 (PimAttributeId,
								 AttributeTypeName,
								  AttributeCode,
								  SourceColumnName,
								  IsRequired,
								  ControlName,
								  ValidationName,
								  SubValidationName,
								  ValidationValue,
								  RegExp
								 )
								 EXEC [Znode_ImportGetGlobalTemplateDetails]
									  @TemplateId = @TemplateId,
									  @ImportHeadId = @ImportHeadId;

								
								INSERT INTO #DefaultAttributeCode
								(AttributeTypeName,
								PimAttributeDefaultValueId,
								PimAttributeId,
								AttributeDefaultValueCode
								)
								--Call Process to insert default data value 
								EXEC Znode_ImportGetGlobalAttributeDefaultValue;

								DELETE FROM #DefaultAttributeCode
								WHERE AttributeTypeName = 'Yes/No';

							END
						
                             --Check attributes are not mapped with any family of Pim Product
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT DISTINCT
                                           '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @AttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                         END;
						
                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
					
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;
                             IF @AttributeTypeName in ( 'Image','File')
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

					

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                            IF  @AttributeTypeName = 'Multi Select'
											 BEGIN
										 		 ---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
												 (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
												 )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
												EXEC sys.sp_sqlexec @SQLQuery;
											  END
											  ELSE IF @AttributeTypeName = 'Simple Select'
											  BEGIN
						
												---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
												  NOT EXISTS 
												 (Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
												EXEC sys.sp_sqlexec @SQLQuery;
											  END   
												-- Check Invalid Image 
												 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
												 Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
												 INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
												 EXEC sys.sp_sqlexec @SQLQuery;
												 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
             
			 
			  
------------------------------------------------------------------------------------------
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000) 
         IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
		 BEGIN
		 	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId


			SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;			
		END
		ELSE IF @ImportHeadName IN('ProductAttribute')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'ZipCode'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Category'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'CategoryAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;

		END
		ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'SEODetails'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Highlight'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AddonAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AttributeDefaultValue'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
	-------------------------------------------------------------------------------------------------------------
	
	--------------------------------------------------------------------------------------------------------------------
			 
  		SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
        EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
                     IF NOT EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @FamilyAttributeDetail
                         WHERE ISNULL(SourceColumnName, '') = ''
                               AND IsRequired = 1
                     ) AND NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN

                                     EXEC Znode_ImportPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;

                                 END;
                             ELSE
                                 BEGIN
                                     EXEC Znode_ImportPimCategoryData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
                                 END;
                         END
						 ELSE
							BEGIN
								-- Update Record count in log 
								
							
								--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								--WHERE ImportProcessLogId = @ImportProcessLogId;

								SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
								SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								WHERE ImportProcessLogId = @ImportProcessLogId;
							END

                 END;
				IF NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
             BEGIN
                 IF @ImportHeadName = 'Pricing'
                     BEGIN
                         EXEC [Znode_ImportPriceList]
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
                              @PriceListId = @PriceListId;
                     END;

                 IF @ImportHeadName = 'Inventory'
                     BEGIN
				
                         EXEC Znode_ImportInventory_Ver1
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID;
                     END;
                 IF @ImportHeadName = 'ZipCode'
                     BEGIN
						 EXEC Znode_ImportZipCode
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CountryCode = @CountryCode;
                     END;
					 IF @ImportHeadName = 'CategoryAssociation'
                     BEGIN
						 EXEC Znode_ImportCatalogCategory
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @PimCatalogId = @PimCatalogId;
                     END;
					 IF @ImportHeadName = 'ProductAssociation'
                     BEGIN
						 EXEC Znode_ImportAssociateProducts
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
                     END;
			
					 IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportSEODetails
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @LocaleId = @LocaleId,
							  @PortalId =@PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CsvColumnString = @CsvColumnString 

				
                     END;
				
					 IF @ImportHeadName = 'ProductAttribute' 
                     BEGIN
						 EXEC Znode_ImportAttributes
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
				
                     END;

					 IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                     BEGIN
					
					
						 EXEC Znode_ImportCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;
					 
					 IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportUserApproval
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                     BEGIN

							 EXEC Znode_ImportB2BCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                     BEGIN
					 	 EXEC Znode_ImportStoreLocatorAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
                     END;

					IF @ImportHeadName = 'Highlight'
					BEGIN
					EXEC Znode_ImportHighlight 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID 
					END;

					IF @ImportHeadName = 'AddonAssociation'
					BEGIN
					EXEC Znode_ImportAddonAssociation 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID,
					@PimCatalogId = @PimCatalogId
					END;

					IF @ImportHeadName = 'AttributeDefaultValue'
					BEGIN
					EXEC Znode_ImportAttributeDefaultValue 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Voucher'
					BEGIN
						EXEC Znode_ImportVoucher 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Account'
					BEGIN
						
						EXEC Znode_ImportAccount 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString,
						@PortalId = @PortalId
					
					END;
				 
             END
			 ELSE 
				 BEGIN
					-- Update Record count in log 	
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

				 END

             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
				 SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
                 EXEC sys.sp_sqlexec @SQLQuery;

				 print 'end';
         END TRY
         BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
			DECLARE @TempCount TABLE (Id INT)

			Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
			INSERT INTO @TempCount
			EXEC (@SQL)

             SELECT ERROR_MESSAGE(),
                    ERROR_LINE(),
                    ERROR_PROCEDURE();
             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID; 
             
			 ---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			SET @SQLQuery = 'Drop Table ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;
             --ROLLBACK TRAN TRN_ImportValidProductData;
         END CATCH;
     END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportVoucher')
	DROP PROC Znode_ImportVoucher
GO

CREATE PROCEDURE [dbo].[Znode_ImportVoucher](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN Voucher;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 

		DECLARE @InsertVoucherData TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,RowNumber int, StoreCode varchar(400),VoucherName varchar(600), VoucherNumber varchar(600),
			VoucherAmount varchar(600),UserName varchar(600), ExpirationDate Datetime,IsActive varchar(100),RemainingAmount varchar(600),
			RestrictVoucherToACustomer varchar(100), StartDate datetime, GUID nvarchar(400)
		);
		
		SET @SSQL = 'Select RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
						IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID FROM '+@TableName;
		INSERT INTO @InsertVoucherData( RowNumber,StoreCode, VoucherName,VoucherNumber,VoucherAmount,UserName,ExpirationDate,
										IsActive,RemainingAmount,RestrictVoucherToACustomer,StartDate,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		select ANZU.UserName, ANU.Id, ZU.UserId
		into #TempUserData
		from AspNetZnodeUser ANZU 
		inner join AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		inner join ZnodeUser ZU ON ANU.Id = ZU.AspNetUserId

		update @InsertVoucherData set VoucherNumber = [dbo].[Fn_RandomString](10)
		where isnull(ltrim(rtrim(VoucherNumber)),'') = ''

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '70', 'StoreCode', StoreCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE ii.StoreCode not in 
			   (
				   SELECT StoreCode FROM ZnodePortal 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE ii.ExpirationDate < ii.StartDate

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '65', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE ii.ExpirationDate < @GetDate

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'StartDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.StartDate,'') = ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '8', 'ExpirationDate', StartDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.ExpirationDate,'') = ''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '67', 'UserName', UserName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE isnull(ii.UserName,'') <> '' and not exists ( SELECT VoucherNumber FROM #TempUserData U where ii.UserName = U.UserName);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '71', 'VoucherNumber', VoucherNumber, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertVoucherData AS ii
			   WHERE len(ltrim(rtrim(ii.VoucherNumber))) <> 10 
	
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'ExpirationDate', ExpirationDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.ExpirationDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '5', 'StartDate', StartDate, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE isdate(ii.StartDate) = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '69', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.VoucherAmount <> ii.RemainingAmount

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'RestrictVoucherToACustomer', RestrictVoucherToACustomer, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			WHERE ii.RestrictVoucherToACustomer not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'VoucherAmount', VoucherAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii  
			CROSS APPLY ZnodeCulture b
			WHERE  VoucherAmount like '%[a-z]%' or VoucherAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT distinct '2', 'RemainingAmount', RemainingAmount, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertVoucherData AS ii
			CROSS APPLY ZnodeCulture b
			WHERE  RemainingAmount like '%[a-z]%' or RemainingAmount like '%'+b.Symbol+'%'
			and b.Symbol is not null 


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ VoucherName - ' + ISNULL(VoucherName,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertVoucherData IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertVoucherData
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertVoucherData
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
	
		UPDATE ZGC set ExpirationDate = ICD.ExpirationDate, UserId = @UserId, ModifiedBy = @UserId, ModifiedDate = @GetDate, IsActive = ICD.IsActive,
				RemainingAmount = ICD.RemainingAmount, RestrictToCustomerAccount = ICD.RestrictVoucherToACustomer, Name = ICD.VoucherName, StartDate = ICD.StartDate
		from ZnodeGiftCard ZGC
		inner join @InsertVoucherData ICD ON ICD.VoucherNumber = ZGC.CardNumber
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode and ZGC.PortalId = ZP.PortalId
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName

		insert into ZnodeGiftCard(PortalId,Name,CardNumber,Amount,UserId,ExpirationDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsActive,RemainingAmount,RestrictToCustomerAccount,StartDate)
		select ZP.PortalId, ICD.VoucherName, ICD.VoucherNumber, ICD.VoucherAmount, ZU.UserId, ICD.ExpirationDate, @UserId, @Getdate, @UserId, @Getdate, ICD.IsActive, ICD.RemainingAmount, ICD.RestrictVoucherToACustomer, ICD.StartDate
		From @InsertVoucherData ICD 
		inner join ZnodePortal ZP ON ICD.StoreCode = ZP.StoreCode 
		left join #TempUserData ZU ON ICD.UserName = ZU.UserName
		where not exists(select * from ZnodeGiftCard ZGC where ICD.VoucherNumber = ZGC.CardNumber )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN Voucher;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN Voucher

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportVoucher @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportVoucher',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportZipCode')
	DROP PROC Znode_ImportZipCode
GO

CREATE PROCEDURE [dbo].[Znode_ImportZipCode](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @CountryCode nvarchar(100))
AS 
	
/*
	----Summary:  Import Zip Code data List 
    */

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		DECLARE @sSql nvarchar(max);

		DECLARE @ZipCode TABLE
		( 
		   ZIPCode nvarchar(300)
		);
		INSERT INTO @ZipCode(ZIPCode)
			   SELECT ZIP
			   FROM ZnodeCity 


		DECLARE @Tlb_ZnodeCity TABLE
		( 
			[RowNumber] [int] NOT NULL, [CityName] [nvarchar](255) NULL, [CityType] [nvarchar](50) NULL, [ZIP] [nvarchar](50) NULL, [ZIPType] [nvarchar](50) NULL, [CountyCode] [varchar](255) NULL,  [StateCode] [nvarchar](255) NULL, [Latitude] [decimal](9, 6) NULL, [Longitude] [decimal](9, 6) NULL, [CountyFIPS] [varchar](50) NULL, [StateFIPS] [varchar](50) NULL, [MSACode] [varchar](50) NULL, [TimeZone] [varchar](50) NULL, [UTC] [decimal](3, 1) NULL, [DST] [char](1) NULL PRIMARY KEY([RowNumber])
		);
		SET @SSQL = 'Select CityName,CityType,ZIP,ZIPType,CountyCode,StateCode,Latitude,Longitude,CountyFIPS,StateFIPS,MSACode,TimeZone,UTC ,RowNumber FROM '+@TableName;
		INSERT INTO @Tlb_ZnodeCity( CityName, CityType, ZIP, ZIPType, CountyCode, StateCode, Latitude, Longitude, CountyFIPS, StateFIPS, MSACode, TimeZone, UTC, RowNumber )
		EXEC sys.sp_sqlexec @SSQL;
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '19', 'StateCode', StateCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @Tlb_ZnodeCity
			   WHERE StateCode NOT IN
			   (
				   SELECT StateCode
				   FROM ZnodeState
				   WHERE CountryCode = @CountryCode
			   );

	   INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'ZIPCode', ZIP, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			  FROM @Tlb_ZnodeCity AS ii
			   WHERE ii.ZIP IN 
			   (
				   SELECT ZIP  FROM @Tlb_ZnodeCity  Group BY ZIP  HAVING COUNT(*) > 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '10', 'ZIPCode', ZIP, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			  FROM @Tlb_ZnodeCity AS ii
			   WHERE ii.ZIP in 
			   (
				   SELECT ZIPCode FROM @ZipCode  where ZIPCode IS NOT NULL 
			   );

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ ZIPCode - ' + ISNULL(ZIP,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @Tlb_ZnodeCity IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		DELETE FROM @Tlb_ZnodeCity
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber IS NOT NULL 
		);

		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @Tlb_ZnodeCity
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;


		INSERT INTO ZnodeCity( CityName, CityType, ZIP, ZIPType, CountyCode, CountryCode, StateCode, Latitude, Longitude, CountyFIPS, StateFIPS, MSACode, TimeZone, UTC, DST, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
			   SELECT CityName, CityType, ZIP, ZIPType, [CountyCode], @CountryCode, StateCode, Latitude, Longitude, CountyFIPS, StateFIPS, MSACode, TimeZone, UTC, DST, 2, @GetDate, 2, @GetDate
			   FROM @Tlb_ZnodeCity AS tzc
			   WHERE NOT EXISTS
			   (
				   SELECT TOP 1 1
				   FROM ZnodeCity
				   WHERE  CountryCode = @CountryCode AND 
						  StateCode = tzc.StateCode AND 
						  CityName = TZC.CityName AND 
						  ZIP = TZC.ZIP
			   ) --AND 
					 --tzc.RowNumber =
			   --(
				  -- SELECT MAX(ii1.RowNumber)
				  -- FROM @Tlb_ZnodeCity AS ii1
				  -- WHERE ii1.StateCode = tzc.StateCode
			   --);
		UPDATE ZC
		  SET ZC.CityType = TZC.CityType, ZC.CountyCode = TZC.CountyCode, ZC.Latitude = TZC.Latitude, ZC.Longitude = TZC.Longitude, ZC.CountyFIPS = TZC.CountyFIPS, ZC.StateFIPS = TZC.StateFIPS, ZC.MSACode = TZC.MSACode, ZC.TimeZone = TZC.TimeZone, ZC.UTC = TZC.UTC, ZC.DST = TZC.DST, ZC.ModifiedBy = @UserId, ZC.ModifiedDate = @GetDate
		FROM ZnodeCity ZC
			 INNER JOIN
			 @Tlb_ZnodeCity TZC
			 ON ZC.CountryCode = @CountryCode AND 
				ZC.StateCode = TZC.StateCode AND 
				ZC.CityName = TZC.CityName AND 
				ZC.ZIP = TZC.ZIP;
		SET @Status = 1;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		-- COMMIT TRAN ImportProducts;
		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportZipCode @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@CountryCode='+CAST(@CountryCode AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportZipCode',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

update ZnodeApplicationSetting
set Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>UserAddressId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>UserAddressId</name><headertext>User Address Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>AddressId</name><headertext>Checkbox</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>IsDefaultBilling</name><headertext>Is Default Billing</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>IsDefaultShipping</name><headertext>Is Default Shipping</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>DisplayAddress</name><headertext>Address</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>AccountId</name><headertext>AccountId</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Customer/EditAddress|/Customer/DeleteAddress</manageactionurl><manageparamfield>UserAddressId,UserId|UserAddressId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where itemName='ZnodeUserAddress'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemGroup]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdGroup INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
	
	DECLARE @OmsInsertedData TABLE (SKU varchar(600),OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,GroupProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.GroupProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	CREATE TABLE #NewGroupSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT ,OmsSavedCartLineItemId	INT,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	int
		,SKU	NVARCHAR(MAX) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	INT ,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT ,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT ,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(group product)
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new group product save cart data
	INSERT INTO #NewGroupSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdGroup, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE GroupProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		
	--Getting new group products save cart data if addon is present for any line item
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 

	CREATE TABLE #OldGroupSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old group save cart data if present for same SKU in the new save cart data for group product	 	 
	INSERT INTO #OldGroupSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.GroupProductIds,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup   

	--Getting the old save cart Parent data
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldGroupSavecartLineitemDetails

	DELETE a FROM #OldGroupSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldGroupSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old config product save cart addon data for old line items if present
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.GroupProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if not exists(select * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldGroupSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldGroupSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldGroupSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
			 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			 INSERT INTO  @parenTofAddon 
			 SELECT  ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails a
			 WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t with (nolock) WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  
			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
						AND ParentOmsSavedCartLineItemId IS NOT NULL  
						AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 

		  IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 
		 IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem with (nolock)  WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
		     AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldGroupSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		   AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
			BEGIN 
			   DELETE FROM #OldGroupSavecartLineitemDetails
			END  
	END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present	
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldGroupSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
		DELETE FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
		SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
			(SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails)  )
		BEGIN 
		 
		DELETE n FROM #OldGroupSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldGroupSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	END 
	
	IF EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
					INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
					where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
			a.PersonalizeCode
			,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU)
			where isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.GroupProductIds
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldGroupSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.GroupProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldGroupSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldGroupSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldGroupSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldGroupSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewGroupSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon


	END 
	--Inserting the new save cart data if old and new cart data not match
	ELSE 
	BEGIN 
	   
		SELECT RowId, Id ,Row_number()Over(ORDER BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		 INTO #InsertNewGroupSavecartLineitem   
		 FROM  #NewGroupSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		 ORDER BY RowId, Id   
 
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewGroupSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewGroupSavecartLineitem m  
			INNER JOIN  #InsertNewGroupSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewGroupSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  

		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU, OrderLineItemRelationshipTypeId 
			FROM #InsertNewGroupSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeId
			HAVING SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewGroupSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.SKU,INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #InsertNewGroupSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO  #Cte_newData
		FROM ZnodeOmsSavedCartLineItem a  with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
  
  -----------------------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #Cte_newData1
		FROM ZnodeOmsSavedCartLineItem a with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		 UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 


----------------------------------------------------------------------------------------------------------------------------

		SELECT DISTINCT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  --,Row_number()Over(ORDER BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #Cte_newAddon1
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) and c.ParentOmsSavedCartLineItemId is null

		-- Added to get distinct records.
		SELECT *,ROW_NUMBER()OVER(ORDER BY OmsSavedCartLineItemId) RowIdNo 
		INTO #Cte_newAddon 
		FROM #Cte_newAddon1

	   ;WITH table_update AS 
	   (
			 SELECT * , ROW_NUMBER()Over(ORDER BY OmsSavedCartLineItemId  ) RowIdNo
			 FROM ZnodeOmsSavedCartLineItem a with (nolock)
			 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			 AND a.ParentOmsSavedCartLineItemId IS NULL  
			 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET  
			a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #Cte_newAddon  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId)  FROM #Cte_newAddon  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewGroupSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		  )   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewGroupSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(ORDER BY OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem with (nolock)  
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewGroupSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.GroupProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b WITH (NOLOCK) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL  
	
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 




END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

DECLARE @LocaleId INT=(SELECT TOP 1 LocaleId FROM ZnodeLocale WHERE Code='en-US')

DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId INT ,AttributeTypeId INT,AttributeCode NVARCHAR(300))

INSERT INTO ZnodePimAttribute
	(AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined,IsConfigurable,IsPersonalizable,
		IsShowOnGrid,DisplayOrder,HelpDescription,IsCategory,IsHidden,IsSwatch,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
OUTPUT Inserted.PimAttributeId,Inserted.AttributeTypeId,Inserted.AttributeCode
INTO @InsertedPimAttributeIds
SELECT (SELECT AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName = 'Yes/No')
,'HideCategoryonMenu',0,1,1,0,0,0,0,500,'Hide Category on Menu',1,0,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttribute ZPA WHERE ZPA.AttributeCode = 'HideCategoryonMenu')

INSERT INTO ZnodePimAttributeLocale 
	(LocaleId,PimAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT @LocaleId,IPAS.PimAttributeId,'Hide Category on Menu', NULL, 2,GETDATE(),2,GETDATE()   
FROM @InsertedPimAttributeIds IPAS

INSERT INTO ZnodePimFrontendProperties 
	(PimAttributeId,IsComparable,IsUseInSearch,IsHtmlTags,IsFacets,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT IPA.PimAttributeId,1 IsComparable, 1 IsUseInSearch, 0 IsHtmlTags,0 IsFacets,2,GETDATE(),2,GETDATE()
FROM @InsertedPimAttributeIds IPA

INSERT INTO ZnodePimAttributeGroupMapper
	(PimAttributeGroupId,PimAttributeId,AttributeDisplayOrder,IsSystemDefined,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
	(SELECT PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'GeneralInfo'),
	(SELECT PimAttributeId FROM znodePimattribute WHERE AttributeCode = 'HideCategoryonMenu'),NULL,1,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodePimAttributeGroupMapper
	WHERE PimAttributeGroupId =(SELECT PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'GeneralInfo')
		AND PimAttributeId = (SELECT PimAttributeId FROM znodePimattribute WHERE AttributeCode = 'HideCategoryonMenu'))

INSERT INTO ZnodePimFamilyGroupMapper
	(PimAttributeFamilyId,PimAttributeGroupId,PimAttributeId,GroupDisplayOrder,IsSystemDefined,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT PimAttributeFamilyId, 
	(SELECT TOP 1 PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'GeneralInfo'),
	(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu'),
	500,1,2,GETDATE(),2,GETDATE()
FROM ZnodePimAttributeFamily PAF
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimFamilyGroupMapper PFG
	WHERE PimAttributeId = (SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu')
		AND PimAttributeGroupId = (SELECT TOP 1 PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'GeneralInfo') 
		AND PFG.PimAttributeFamilyId = PAF.PimAttributeFamilyId)
	AND PAF.IsCategory = 1

INSERT INTO ZnodePimAttributeDefaultValue
	(PimAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,IsDefault,SwatchText,MediaId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu'),
'false',NULL,NULL,NULL,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeDefaultValue
	WHERE PimAttributeId=(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu')
		AND AttributeDefaultValueCode='false')

INSERT INTO ZnodePimAttributeDefaultValueLocale
	(LocaleId,PimAttributeDefaultValueId,AttributeDefaultValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT @LocaleId,
(SELECT TOP 1 PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue
		WHERE PimAttributeId=(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu') AND AttributeDefaultValueCode='false'),
'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimAttributeDefaultValueLocale
	WHERE PimAttributeDefaultValueId=(SELECT TOP 1 PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue
		WHERE PimAttributeId=(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu') AND AttributeDefaultValueCode='false'))

DECLARE @PimCategoryAttributeValueId TABLE (PimCategoryAttributeValueId INT,PimCategoryId INT,PimAttributeId INT,PimAttributeFamilyId INT);
INSERT INTO ZnodePimCategoryAttributeValue
	(PimCategoryId,PimAttributeFamilyId,PimAttributeId,PimAttributeDefaultValueId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
OUTPUT INSERTED.PimCategoryAttributeValueId,INSERTED.PimCategoryId,INSERTED.PimAttributeId,INSERTED.PimAttributeFamilyId
INTO @PimCategoryAttributeValueId
SELECT PimCategoryId,
(SELECT TOP 1 PimAttributeFamilyId FROM  ZnodePimAttributeFamily WHERE FamilyCode='DefaultCategory'),
(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu'),
(SELECT TOP 1 PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue
		WHERE PimAttributeId=(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu') AND AttributeDefaultValueCode='false'),
2,GETDATE(),2,GETDATE()
FROM ZnodePimCategory ZPC
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimCategoryAttributeValue PCAV 
	WHERE PCAV.PimCategoryId=ZPC.PimCategoryId
	AND PimAttributeFamilyId=(SELECT TOP 1 PimAttributeFamilyId FROM  ZnodePimAttributeFamily WHERE FamilyCode='DefaultCategory')
	AND PimAttributeId=(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu')
	AND PimAttributeDefaultValueId=(SELECT TOP 1 PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue
		WHERE PimAttributeId=(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu') AND AttributeDefaultValueCode='false')
	)

INSERT INTO ZnodePimCategoryAttributeValueLocale
	(LocaleId,PimCategoryAttributeValueId,CategoryValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT DISTINCT
	@LocaleId,
	PimCategoryAttributeValueId,
	'false',2,GETDATE(),2,GETDATE()
FROM @PimCategoryAttributeValueId A
WHERE NOT EXISTS
(
	SELECT TOP 1 1
	FROM ZnodePimCategoryAttributeValueLocale B
	WHERE B.PimCategoryAttributeValueId = A.PimCategoryAttributeValueId
	AND B.LocaleId = @LocaleId
)

GO

INSERT ZnodeImportTemplateMapping
	(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'CategoryTemplate'),
'HideCategoryonMenu','HideCategoryonMenu',0,0,0,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT TOP 1 1 FROM ZnodeImportTemplateMapping 
	WHERE ImportTemplateId=(SELECT TOP 1 ImportTemplateId FROM ZnodeImportTemplate WHERE TemplateName = 'CategoryTemplate') 
		AND SourceColumnName ='HideCategoryonMenu')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,RegExp,DisplayOrder,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','HideCategoryonMenu',
(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Category'),
0,'Number','MaxNumber',NULL,'2','',NULL,2,GETDATE(),2,GETDATE(),NULL
WHERE NOT EXISTS(SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'HideCategoryonMenu' 
      AND ControlName = 'Number' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Category')
	  AND ValidationName = 'MaxNumber')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,RegExp,DisplayOrder,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','HideCategoryonMenu',
(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Category'),
0,'Number','MinNumber',NULL,'0','',NULL,2,GETDATE(),2,GETDATE(),NULL
WHERE NOT EXISTS(SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'HideCategoryonMenu' 
      AND ControlName = 'Number' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Category')
	  AND ValidationName = 'MinNumber')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,RegExp,DisplayOrder,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','HideCategoryonMenu',
(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Category'),
0,'Yes/No','AllowDecimals',NULL,'false','',NULL,2,GETDATE(),2,GETDATE(),NULL
WHERE NOT EXISTS(SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'HideCategoryonMenu' 
      AND ControlName = 'Yes/No' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Category')
	  AND ValidationName = 'AllowDecimals')

INSERT INTO ZnodeImportAttributeValidation
	(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName,ValidationValue,RegExp,DisplayOrder,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
SELECT 'Number','HideCategoryonMenu',
(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Category'),
0,'Yes/No','AllowNegative',NULL,'false','',NULL,2,GETDATE(),2,GETDATE(),NULL
WHERE NOT EXISTS(SELECT TOP 1 1 FROM ZnodeImportAttributeValidation WHERE AttributeTypeName ='Number' AND AttributeCode = 'HideCategoryonMenu' 
      AND ControlName = 'Yes/No' AND ImportHeadId=(SELECT TOP 1 ImportHeadId FROM ZnodeImportHead WHERE Name = 'Category')
	  AND ValidationName = 'AllowNegative')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertSaveCartLineItemsForReOrder')
	DROP PROC Znode_InsertSaveCartLineItemsForReOrder
GO


CREATE PROCEDURE [dbo].[Znode_InsertSaveCartLineItemsForReOrder] 
(
	@OmsOrderId INT, 
	@OmsSavedCartId INT ,
	@UserId INT ,
	@OmsOrderLineItemsId INT = 0,
	@Status BIT = 0 OUT
)
AS 
BEGIN 
BEGIN TRY 
  SET NOCOUNT ON 
  DECLARE @TBL_ZnodeOmsSavedCartLineItem TABLE (OmsSavedCartLineItemId INT , RowId INT  )
  DECLARE @GetDate DATETIME = dbo.FN_getDate() 
  DECLARE @AddOnOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Addons')

   DECLARE @BundleOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Bundles')

   DECLARE @OmsOrderStateId_RETURNED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'RETURNED')
   DECLARE @OmsOrderStateId_CANCELED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'CANCELED')

   CREATE TABLE #ZnodeOmsOrderLineItems_temp (OmsOrderLineItemsId INT ,ParentOmsOrderLineItemsId INT,OmsOrderDetailsId INT , SKU  NVARCHAr(2000),
   OrderLineItemRelationshipTypeID INT ,AutoAddonSKU NVARCHAR(400),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),Custom4 NVARCHAR(MAX)
   ,Custom5 NVARCHAR(MAX), GroupId nvarchar(MAX),ProductName NVARCHAr(2000), Description nvarchar(MAX),Quantity NUMERIC(28,6), ROWID INT, ParentRowID INT)

  IF EXISTS (SELECT TOP 1 OmsOrderDetailsId  FROM ZnodeOmsOrderDetails WHERE  OmsOrderId =  @OmsOrderId AND IsActive =1 )
  BEGIN 

	  ;WITH CTE_OrderData AS
	  (
		  SELECT MIN(ZOOLI.OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ZOOLI.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			  ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4,
			  ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description,SUM(ZOOLI.Quantity) AS Quantity
		  FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		  INNER JOIN ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) ON ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId
		  WHERE  ZOOD.OmsOrderId =  @OmsOrderId AND ZOOD.IsActive =1 
		  AND CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 0 ELSE  ZOOLI.OrderLineItemStateId END  <> CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 1 ELSE  @OmsOrderStateId_RETURNED END 
		  GROUP BY ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4, ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description
	  )
	  INSERT INTO #ZnodeOmsOrderLineItems_temp
	  SELECT *
		,Row_number()Over(Order By OmsOrderLineItemsId )  RowId, NULL ParentRowId
	  FROM CTE_OrderData
	  ORDER BY OmsOrderLineItemsId 
  END

  ELSE 
  BEGIN
		;WITH CTE_OrderData AS
		  (
			  SELECT MIN(OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
				  ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				  ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
				  ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
			  FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
			  WHERE ( ZOO.OmsOrderLineItemsId = @OmsOrderLineItemsId OR ZOO.ParentOmsOrderLineItemsId = @OmsOrderLineItemsId ) 
			  AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE ZOO.OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
			  GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4, ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description
		 )
		 INSERT INTO #ZnodeOmsOrderLineItems_temp
		 SELECT *,Row_number()Over(Order By OmsOrderLineItemsId )   RowId, NULL ParentRowId
		 FROM CTE_OrderData

		INSERT INTO #ZnodeOmsOrderLineItems_temp 
		SELECT MIN(ZOO.OmsOrderLineItemsId) AS OmsOrderLineItemsId,MIN(ZOO.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
		ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
		ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
		ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
		,0 RowId, NULL ParentRowId
		FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
		WHERE ZOO.OmsOrderLineItemsId = (SELECT TOP 1 ParentOmsOrderLineItemsId FROM #ZnodeOmsOrderLineItems_temp TY WHERE TY.ParentOmsOrderLineItemsId IS NOT NULL 
		AND TY.OrderLineItemRelationshipTypeID <> @AddOnOrderLineItemRelationshipTypeId )
		AND ZOO.ParentOmsOrderLineItemsId  IS NULL
		AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
		AND NOT EXISTS(SELECT * FROM #ZnodeOmsOrderLineItems_temp tem WHERE tem.OmsOrderLineItemsId = ZOO.OmsOrderLineItemsId )
		GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
			ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description;

  END

     DECLARE @TBL_OmsSavedCartOld TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 DECLARE @TBL_OmsSavedCartNew TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 
	 SELECT SKU , OmsOrderLineItemsId, ParentOmsOrderLineItemsId, OrderLineItemRelationshipTypeID,Quantity 
	 INTO #ZnodeOmsSavedCartLineItemOld
	 FROM #ZnodeOmsOrderLineItems_temp a 

	 SELECT OmsOrderLineItemsId, PersonalizeCode, PersonalizeValue  
	 INTO #ZnodeOmsPersonalizeCartItemOld
	 FROM ZnodeOmsPersonalizeItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp t WHERE t.OmsOrderLineItemsId = a.OmsOrderLineItemsId)

	 SELECT SKU , OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeID, Quantity
	 INTO #ZnodeOmsSavedCartLineItemNew
	 FROM ZnodeOmsSavedCartLineItem a WITH (NOLOCK)
	 WHERE OmsSavedCartId = @OmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue   
	 INTO #ZnodeOmsPersonalizeCartItemNew
	 FROM ZnodeOmsPersonalizeCartItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 INSERT INTO @TBL_OmsSavedCartOld (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	 SELECT SKU , OmsOrderLineItemsId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemOld TBL_B WHERE TBL_B.OmsOrderLineItemsId = ISNULL(TBL_A.ParentOmsOrderLineItemsId,0)  ) ParentSKU
				, ParentOmsOrderLineItemsId
	 FROM #ZnodeOmsSavedCartLineItemOld TBL_A
	 WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId

	 ;With Cte_UpdateOld AS 
	 (
		SELECT ParentOmsOrderLineItemsId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsOrderLineItemsId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemOld a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN Cte_UpdateOld TBL_ON ON (TBL_ON.ParentOmsOrderLineItemsId  = TBL_O.OmsSavedCartLineItemId )

	  INSERT INTO @TBL_OmsSavedCartNew (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	  SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemNew TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL( TBL_A.ParentOmsSavedCartLineItemId,0)   ) ParentSKU
				, ParentOmsSavedCartLineItemId
	  FROM #ZnodeOmsSavedCartLineItemNew TBL_A
	  WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	 ;With Cte_UpdateNew AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )	 
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN Cte_UpdateNew TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000) 
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000)  
	  FROM @TBL_OmsSavedCartNew TBL_O 
	

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000)
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000) 
	  FROM @TBL_OmsSavedCartOld TBL_O 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartOld a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartNew a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	 UPDATE a 
	 SET  a.Quantity =  a.Quantity+d.Quantity 
	 FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId)

	 ;WITH CTE_UpdateOrder 
	 AS 
	 (
	   SELECT Sequence,  ROW_NUMBER()Over(order BY OmsSavedCartLineItemId ASC) RowId
	   FROM ZnodeOmsSavedCartLineItem WITH (NOLOCK)
	   WHERE  OmsSavedCartId = @OmsSavedCartId
	 
	 ) 
	 UPDATE CTE_UpdateOrder 
	 SET Sequence =RowId



	 DECLARE @DeletedId TABLE (OmsSavedCartLineItemId INT )

	
	 DELETE  FROM #ZnodeOmsOrderLineItems_temp OUTPUT DELETED.OmsOrderLineItemsId INTO @DeletedId WHERE OmsOrderLineItemsId IN (SELECT c.OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId))


	 DELETE FROM #ZnodeOmsOrderLineItems_temp WHERE ParentOmsOrderLineItemsId IN (SELECT OmsSavedCartLineItemId FROM @DeletedId)

	 DELETE TR FROM #ZnodeOmsOrderLineItems_temp TR 
	 WHERE NOT EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp YU WHERE TR.OmsOrderLineItemsId = YU.ParentOmsOrderLineItemsId  ) 
	 AND TR.ParentOmsOrderLineItemsId IS NULL 

   UPDATE #ZnodeOmsOrderLineItems_temp 
   SET ParentRowId = (SELECT TOP 1 RowId FROM #ZnodeOmsOrderLineItems_temp a WHERE a.OmsOrderLineItemsId = #ZnodeOmsOrderLineItems_temp.ParentOmsOrderLineItemsId ) 
	BEGIN TRANSACTION ReorderSaveCart
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails
											,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description)
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.Sequence  INTO @TBL_ZnodeOmsSavedCartLineItem
		SELECT NULL,@OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,NULL CustomText, NULL CartAddOnDetails
											,RowId,@UserId,@GetDate,@UserId,@GetDate,AutoAddonSKU,NULL OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description
		FROM #ZnodeOmsOrderLineItems_temp 
		ORDER BY OmsOrderLineItemsId 

            
		  UPDATE ab 
		  SET ab.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_ZnodeOmsSavedCartLineItem av WHERE av.RowId = b.ParentRowId   )
		  FROM ZnodeOmsSavedCartLineItem ab 
		  INNER JOIN @TBL_ZnodeOmsSavedCartLineItem a ON (a.OmsSavedCartLineItemId = ab.OmsSavedCartLineItemId ) 
		  INNER JOIN #ZnodeOmsOrderLineItems_temp b ON  (b.RowId = a.RowId  ) 

		  INSERT INTO ZnodeOmsPersonalizeCartItem (OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
		  SELECT c.OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,@UserId,@GetDate,@UserId,@GetDate,DesignId,ThumbnailURL
		  FROM ZnodeOmsPersonalizeItem  a 
		  INNER JOIN #ZnodeOmsOrderLineItems_temp b ON (a.OmsOrderLineItemsId = b.OmsOrderLineItemsId)
		  INNER JOIN @TBL_ZnodeOmsSavedCartLineItem c ON (c.RowId = b.RowId )

		  UPDATE ZOSCLI1 set Quantity = null
		  from ZnodeOmsSavedCartLineItem ZOSCLI1
		  where ParentOmsSavedCartLineItemId is null and OmsSavedCartId = @OmsSavedCartId
		  and Quantity is not null
		  and not exists(select * from ZnodeOmsSavedCartLineItem ZOSCLI where OrderLineItemRelationshipTypeId = @BundleOrderLineItemRelationshipTypeId and ZOSCLI1.OmsSavedCartLineItemId = ZOSCLI.ParentOmsSavedCartLineItemId )

		  UPDATE ZnodeOmsSavedCart
		  SET ModifiedDate = GETDATE()
		  WHERE OmsSavedCartId = @OmsSavedCartId
	COMMIT TRANSACTION ReorderSaveCart
   SET @status = 1 
   
END TRY 
BEGIN CATCH 
	ROLLBACK TRANSACTION ReorderSaveCart
	SELECT ERROR_MESSAGE()
	SET @status = 0 

	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertSaveCartLineItemsForReOrder @OmsOrderId = '+CAST(@OmsOrderId AS VARCHAR(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@OmsSavedCartId='+CAST(@OmsSavedCartId AS VARCHAR(50))+',@OmsOrderLineItemsId='+CAST(@OmsOrderLineItemsId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
    SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
    EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_InsertSaveCartLineItemsForReOrder',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH 
END

GO

Update ZnodeApplicationSetting 
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>AttributeCode</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>AttributeName</name><headertext>Attribute Name</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>IsFacets</name><headertext>Is Facets</headertext><width>30</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>IsUseInSearch</name><headertext>Is Use In Search</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>BoostValue</name><headertext>Boost Value</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>y</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>SearchProfileId</name><headertext>Search Profile Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>y</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Delete</format><isvisible>n</isvisible><mustshow>y</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Search/Search/UnAssociatedSearchAttribute</manageactionurl><manageparamfield>SerachProfilesAttributeMappingId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>' 
where ItemName = 'ZnodeUnAssociatedSearchAttributes'

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'TemplateType' AND Object_ID = Object_ID(N'dbo.ZnodeOmsTemplate'))
BEGIN
	ALTER TABLE ZnodeOmsTemplate ADD TemplateType VARCHAR(20) NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetQuoteOrderTemplateDetail')
	DROP PROC Znode_GetQuoteOrderTemplateDetail
GO

CREATE PROCEDURE [dbo].[Znode_GetQuoteOrderTemplateDetail]
(   
	@WhereClause NVARCHAR(MAX),
	@Rows        INT           = 100,
	@PageNo      INT           = 1,
	@Order_BY    VARCHAR(100)  = '',
	@UserId		 INT,										 
	@RowsCount   INT OUT
)
AS 
/*
		Summary :- this procedure is used to find QuoteOrderTemplate details 
	    SELECT * FROM ZnodeUser  WHERE AspNeTUSerId = 'ae464cfc-95d3-40de-bf71-47993fabb41f'
		SELECT * FROM AspNetUserRoles WHERE RoleID = 'A529A670-F446-45EC-BBCB-C00D64D7C964' Userid = '50fe1032-e810-4606-b522-ebf1559e81cf'
		SELECT * FROM AspNetRoles WHERE ID = '8622E90D-7652-41E7-8563-5DED4CC671DE'

		Unit Testing 
		EXEC Znode_GetQuoteOrderTemplateDetail '',@RowsCount = 0, @Order_BY = '', @UserId = 85
*/
BEGIN
    BEGIN TRY
        SET NOCOUNT ON;
		DECLARE @SQL NVARCHAR(MAX);
		DECLARE @TBL_QuoteOrderTemplate TABLE (OmsTemplateId INT,PortalId INT,UserId INT,TemplateName NVARCHAR(1000),CreatedBy INT,CreatedDate DATETIME
		,ModifiedBy INT,ModifiedDate DATETIME,Items INT,RowId INT,CountNo INT )
		DECLARE @AccountId VARCHAR(2000) ,@UsersId VARCHAR(2000), @ProcessType  varchar(50)='Template'
		-- SELECT * FROM aspnetRoles
			
		--SET @UsersId = SUBSTRING (( SELECT ','+CAST(userId AS VARCHAr(50))  FROM Fn_GetRecurciveUserId(@UserId,@ProcessType) FOR XML PATH ('')),2,4000)
			
		SELECT distinct ZPAVL.AttributeValue as SKU, ZPADV.AttributeDefaultValueCode  
		INTO #SKU_ProductType
		FROM ZnodePimAttributeValue ZPAV
		Inner Join ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		Inner Join ZnodePimAttribute ZPA ON ZPAV.PimAttributeId = ZPA.PimAttributeId
		Inner Join ZnodePimAttributeValue ZPAV1 ON ZPAV.PimProductId = ZPAV1.PimProductId
		Inner Join ZnodePimProductAttributeDefaultValue ZPPADV ON ZPAV1.PimAttributeValueId = ZPPADV.PimAttributeValueId
		Inner Join ZnodePimAttribute ZPA1 ON ZPAV1.PimAttributeId = ZPA1.PimAttributeId
		Inner Join ZnodePimAttributeDefaultValue ZPADV ON ZPPADV.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId
		WHERE ZPA.AttributeCode = 'SKU' AND ZPA1.AttributeCode = 'ProductType'
		AND EXISTS (select * from ZnodeOmsTemplate ZOT
                        INNER JOIN ZnodeOmsTemplateLineItem ZOTL ON(ZOTL.OmsTemplateId = ZOT.OmsTemplateId)
						where ZOT.userid = @UserId AND ZPAVL.AttributeValue = ZOTL.SKU )

			SET @SQL = '
					; WITH CTE_GetOrderTemplate
						AS (
						    SELECT ZOT.OmsTemplateId,ZOT.PortalId,ZOT.UserId,ZOT.TemplateName,ZOT.CreatedBy,ZOT.CreatedDate,ZOT.ModifiedBy,ZOT.ModifiedDate,
							        SUM(case when AttributeDefaultValueCode in ( ''GroupedProduct'') AND ParentOmsTemplateLineItemId IS nULL 
									        then 0
											when ZOOLIRT.Name  = ''Group'' And AttributeDefaultValueCode in ( ''SimpleProduct'') 
											then ZOTL.Quantity
											when SP.AttributeDefaultValueCode in ( ''BundleProduct'',''ConfigurableProduct'',''SimpleProduct'') AND ParentOmsTemplateLineItemId IS nULL
											then ZOTL.Quantity 
											else 0
									end ) Items, ZOT.TemplateType 
							FROM ZnodeOmsTemplate ZOT
                            LEFT JOIN ZnodeOmsTemplateLineItem ZOTL ON(ZOTL.OmsTemplateId = ZOT.OmsTemplateId)
							Left Join #SKU_ProductType SP ON  ZOTL.SKU = SP.SKU
							left join ZnodeOmsOrderLineItemRelationshipType ZOOLIRT ON ZOTL.OrderLineItemRelationshipTypeId = ZOOLIRT.OrderLineItemRelationshipTypeId
							WHERE ZOT.userid = '+cast(@UserId as varchar(10))+' 
							--AND OrderLineItemRelationshipTypeId IS  NULL AND  ParentOmsTemplateLineItemId IS nULL
							GROUP BY ZOT.OmsTemplateId,ZOT.PortalId,ZOT.UserId,ZOT.TemplateName,ZOT.CreatedBy,ZOT.CreatedDate,ZOT.ModifiedBy,ZOT.ModifiedDate,ZOT.TemplateType 						  
						  
						    )
					, CTE_GetQuoteOrderDetails AS
					(
						SELECT DISTINCT  OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items
						,'+dbo.Fn_GetPagingRowId(@Order_BY,'OmsTemplateId DESC,UserId')+',Count(*)Over() CountNo
						FROM CTE_GetOrderTemplate
						WHERE 1=1 
				        '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'					  
						
					)

					SELECT OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items,RowId,CountNo
					FROM CTE_GetQuoteOrderDetails
					'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)

					Print @sql
					INSERT INTO @TBL_QuoteOrderTemplate (OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items,RowId,CountNo)
					EXEC(@SQL)

					SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_QuoteOrderTemplate),0)
   
					SELECT OmsTemplateId,PortalId,UserId,TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Items
					FROM @TBL_QuoteOrderTemplate 
	END TRY
	BEGIN CATCH
		 
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetQuoteOrderTemplateDetail @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@UserId= '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetQuoteOrderTemplateDetail',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertCartLineItemsForLater')
	DROP PROC Znode_InsertCartLineItemsForLater
GO

CREATE PROCEDURE [dbo].[Znode_InsertCartLineItemsForLater]
(
	@TemplateLineItemXML XML,
    @UserId              INT,
    @Status              BIT = 0 OUT
)
AS 
/* -- Summary :- This Pocedure is USed to create the Quote Template 
    Unit Testing 
    EXEC 
    SELECT * FROM ZnodeOmsTemplate
    SELECT * FROM ZnodeOmsTemplateLineItem
*/
    BEGIN
        BEGIN TRAN InsertUpdateSaveCartLineItem;
        BEGIN TRY
            SET NOCOUNT ON;
			DECLARE @OldQty INT;
			DECLARE @SKU NVARCHAR(600);
			DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
            DECLARE @TBL_SavecartLineitems TABLE
            (RowId                           INT IDENTITY(1, 1),
            OmsTemplateLineItemId           INT,
            ParentOmsTemplateLineItemId     INT,
            OmsTemplateId                   INT,
            SKU                             NVARCHAR(600),
            Quantity                        NUMERIC(28, 6),
            OrderLineItemRelationshipTypeID INT,
            CustomText                      NVARCHAR(MAX),
            CartAddOnDetails                NVARCHAR(MAX),
            Sequence                        INT,
            AddOnValueIds                   VARCHAR(MAX),
            BundleProductIds                VARCHAR(MAX),
            ConfigurableProductIds          VARCHAR(MAX),
            GroupProductIds                 VARCHAR(MAX)
            );
            DECLARE @OrderLineItemRelationshipTypeIdAddon INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'AddOns'
            );
            DECLARE @OrderLineItemRelationshipTypeIdBundle INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Bundles'
            );
            DECLARE @OrderLineItemRelationshipTypeIdConfigurable INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Configurable'
            );
            DECLARE @OrderLineItemRelationshipTypeIdGroup INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Group'
            );
            INSERT INTO @TBL_SavecartLineitems
            (OmsTemplateLineItemId,
            ParentOmsTemplateLineItemId,
            OmsTemplateId,
            SKU,
            Quantity,
            OrderLineItemRelationshipTypeID,
            CustomText,
            CartAddOnDetails,
            Sequence,
            AddOnValueIds,
            BundleProductIds,
            ConfigurableProductIds,
            GroupProductIds
            )
                SELECT Tbl.Col.value('OmsTemplateLineItemId[1]', 'NVARCHAR(2000)') AS OmsSavedCartLineItemId,
                        Tbl.Col.value('ParentOmsTemplateLineItemId[1]', 'NVARCHAR(2000)') AS ParentOmsSavedCartLineItemId,
                        Tbl.Col.value('OmsTemplateId[1]', 'NVARCHAR(2000)') AS OmsSavedCartId,
                        Tbl.Col.value('SKU[1]', 'NVARCHAR(2000)') AS SKU,
                        Tbl.Col.value('Quantity[1]', 'NVARCHAR(2000)') AS Quantity,
                        Tbl.Col.value('OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)') AS OrderLineItemRelationshipTypeID,
                        Tbl.Col.value('CustomText[1]', 'NVARCHAR(2000)') AS CustomText,
                        Tbl.Col.value('CartAddOnDetails[1]', 'NVARCHAR(2000)') AS CartAddOnDetails,
                        Tbl.Col.value('Sequence[1]', 'NVARCHAR(2000)') AS Sequence,
                        Tbl.Col.value('AddonProducts[1]', 'NVARCHAR(2000)') AS AddOnValueIds,
                        Tbl.Col.value('BundleProducts[1]', 'NVARCHAR(2000)') AS BundleProductIds,
                        Tbl.Col.value('ConfigurableProducts[1]', 'NVARCHAR(2000)') AS ConfigurableProductIds,
                        Tbl.Col.value('GroupProducts[1]', 'NVARCHAR(Max)') AS GroupProductIds
                FROM @TemplateLineItemXML.nodes('//ArrayOfAccountTemplateLineItemModel/AccountTemplateLineItemModel') AS Tbl(Col);

             
            DECLARE @OmsTemplateId INT, @OmsTemplateLineItemId INT;
            DECLARE @TBL_bundleAddonRows TABLE
            (RowId                           INT,
            SequenceId                      INT IDENTITY(1, 1),
            ParentOmsTemplateLineItemId     INT,
            SKU                             NVARCHAR(1000),
            Quantity                        NUMERIC(28, 6),
            OrderLineItemRelationshipTypeID INT,
            CustomText                      NVARCHAR(MAX),
            CartAddOnDetails                NVARCHAR(MAX)
            );

            DECLARE @AddonProductSKU NVARCHAR(MAX)=
            (
                SELECT TOP 1 AddOnValueIds
                FROM @TBL_SavecartLineitems
            ), @BundleProductSKU NVARCHAR(MAX)=
            (
                SELECT TOP 1 BundleProductIds
                FROM @TBL_SavecartLineitems
            );
            SET @OmsTemplateId =
            (
                SELECT TOP 1 OmsTemplateId
                FROM @TBL_SavecartLineitems
            );

            SET @SKU =
            (
                SELECT TOP 1 SKU
                FROM @TBL_SavecartLineitems
            );
            IF EXISTS
            (
                SELECT TOP 1 1
                FROM ZnodeOmsSavedCartLineItem AS qa
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_SavecartLineitems AS ssds
                    WHERE ssds.sku = qa.SKU
                )
            )
                BEGIN

				    SELECT @OldQty = Quantity FROM ZnodeOmsTemplateLineItem
                    WHERE OmsTemplateId = @OmsTemplateId AND SKU =@SKU;

                    DELETE FROM ZnodeOmsTemplateLineItem
                    WHERE OmsTemplateId = @OmsTemplateId AND SKU =@SKU;
                END; 
			
       

            INSERT INTO @TBL_bundleAddonRows
            (RowId,
            ParentOmsTemplateLineItemId,
            SKU,
            Quantity,
            OrderLineItemRelationshipTypeID,
            CustomText,
            CartAddOnDetails
            )
                SELECT a.RowID,
                        NULL,
                        q.Item AS SKU,
                        a.Quantity,
                        @OrderLineItemRelationshipTypeIdAddon,
                        CustomText,
                        CartAddOnDetails
                FROM @TBL_SavecartLineitems AS a
                        CROSS APPLY dbo.Split(a.AddOnValueIds, ',') AS q
                WHERE a.AddOnValueIds IS NOT NULL  AND a.AddOnValueIds <> ''; 

             

            INSERT INTO @TBL_bundleAddonRows
            (RowId,
            ParentOmsTemplateLineItemId,
            SKU,
            Quantity,
            OrderLineItemRelationshipTypeID,
            CustomText,
            CartAddOnDetails
            )
                SELECT RowID,
                        NULL,
                        q.Item AS SKU,
                        a.Quantity,
                        @OrderLineItemRelationshipTypeIdBundle,
                        CustomText,
                        CartAddOnDetails
                FROM @TBL_SavecartLineitems AS a
                        CROSS APPLY dbo.Split(a.BundleProductIds, ',') AS q
                WHERE a.BundleProductIds IS NOT NULL AND a.BundleProductIds <>'';
            INSERT INTO @TBL_bundleAddonRows
            (RowId,
            ParentOmsTemplateLineItemId,
            SKU,
            Quantity,
            OrderLineItemRelationshipTypeID,
            CustomText,
            CartAddOnDetails
            )
                SELECT RowID,
                        NULL,
                        q.Item AS SKU,
                        a.Quantity,
                        @OrderLineItemRelationshipTypeIdConfigurable,
                        CustomText,
                        CartAddOnDetails
                FROM @TBL_SavecartLineitems AS a
                        CROSS APPLY dbo.Split(a.ConfigurableProductIds, ',') AS q
                WHERE a.ConfigurableProductIds IS NOT NULL AND a.ConfigurableProductIds <>'';
            INSERT INTO @TBL_bundleAddonRows
            (RowId,
            ParentOmsTemplateLineItemId,
            SKU,
            Quantity,
            OrderLineItemRelationshipTypeID,
            CustomText,
            CartAddOnDetails
            )
                SELECT RowID,
                        NULL,
                        SUBSTRING(q.Item, 1, CHARINDEX('~', q.Item)-1) AS SKU,
                        SUBSTRING(q.Item, CHARINDEX('~', q.Item)+1, 4000) AS Quantity,
                        @OrderLineItemRelationshipTypeIdGroup,
                        CustomText,
                        CartAddOnDetails
                FROM @TBL_SavecartLineitems AS a
                        CROSS APPLY dbo.Split(a.GroupProductIds, ',') AS q
                WHERE a.GroupProductIds IS NOT NULL AND GroupProductIds <>''
				AND isnull(q.Item,'') <> ''; 


            DECLARE @Tbl_SAvecartIds TABLE
            (OmsTemplateLineItemId INT,
            RowId                 INT
            );
			 

			---Parent Product Update
			UPDATE TARGET
			SET TARGET.Quantity = SOURCE.Quantity,
				TARGET.ModifiedDate = @GetDate,
				TARGET.CreatedBy = @UserId 
			FROM ZnodeOmsTemplateLineItem TARGET
			INNER JOIN @TBL_SavecartLineitems SOURCE ON (TARGET.OmsTemplateId = SOURCE.OmsTemplateId
			AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)
			and TARGET.SKU = SOURCE.SKU

		---Child Product Update
		UPDATE TARGET
			SET TARGET.Quantity = SCLI.Quantity,
				TARGET.ModifiedDate = @GetDate,
				TARGET.CreatedBy = @UserId 
			FROM ZnodeOmsTemplateLineItem TARGET
			INNER JOIN @TBL_SavecartLineitems SOURCE ON (TARGET.OmsTemplateId = SOURCE.OmsTemplateId
			    AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)
			INNER JOIN @TBL_bundleAddonRows SCLI ON Source.RowId = SCLI.RowId and TARGET.SKU = SCLI.SKU
			     
			
				
		INSERT INTO ZnodeOmsTemplateLineItem(ParentOmsTemplateLineItemId,OmsTemplateId,SKU,Quantity
		,OrderLineItemRelationshipTypeID,
				CustomText,CartAddOnDetails,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		SELECT NULL,@OmsTemplateId,Source.SKU,Source.Quantity + ISNULL(@OldQty, 0),
				CASE
				WHEN Source.OrderLineItemRelationshipTypeID = 0
				THEN NULL
				ELSE Source.OrderLineItemRelationshipTypeID
				END,
		Source.CustomText,
		Source.CartAddOnDetails,
		1 --Source.Sequence
		,@UserId,@GetDate,@UserId,@GetDate
		FROM @TBL_SavecartLineitems Source
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem TARGET 
		WHERE TARGET.OmsTemplateId = Source.OmsTemplateId 
		AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)
			
		INSERT INTO ZnodeOmsTemplateLineItem(ParentOmsTemplateLineItemId,OmsTemplateId,SKU,Quantity
		,OrderLineItemRelationshipTypeID, CustomText,CartAddOnDetails,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
		SELECT ZOTLI.OmsTemplateLineItemId,@OmsTemplateId,Source.SKU,Source.Quantity,
				CASE
				WHEN Source.OrderLineItemRelationshipTypeID = 0
				THEN NULL
				ELSE Source.OrderLineItemRelationshipTypeID
				END,
		Source.CustomText,
		Source.CartAddOnDetails,
		Source.SequenceId+1
		,@UserId,@GetDate,@UserId,@GetDate
		FROM @TBL_bundleAddonRows Source
		inner join @TBL_SavecartLineitems SCLI ON Source.RowId = SCLI.RowId
		inner join ZnodeOmsTemplateLineItem ZOTLI ON ZOTLI.OmsTemplateId = @OmsTemplateId AND ZOTLI.ParentOmsTemplateLineItemId IS NULL AND ZOTLI.OrderLineItemRelationshipTypeID is null
		AND SCLI.SKU = ZOTLI.SKU
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem TARGET 
		WHERE TARGET.OmsTemplateId = SCLI.OmsTemplateId 
		AND TARGET.OmsTemplateLineItemId = SCLI.OmsTemplateLineItemId)
	
             

--         MERGE INTO ZnodeOmsTemplateLineItem TARGET
--         USING @TBL_SavecartLineitems SOURCE
--         ON  TARGET.OmsTemplateId = SOURCE.OmsTemplateId
			--   --AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId
			----AND Target.sku = Source.sku
			--WHEN MATCHED  THEN
			--UPDATE 
			--SET   TARGET.Quantity = SOURCE.Quantity

--             WHEN NOT MATCHED
--             THEN INSERT(ParentOmsTemplateLineItemId,
--                         OmsTemplateId,
--                         SKU,
--                         Quantity,
--                         OrderLineItemRelationshipTypeID,
--                         CustomText,
--                         CartAddOnDetails,
--                         Sequence,
--                         CreatedBy,
--                         CreatedDate,
--                         ModifiedBy,
--                         ModifiedDate) VALUES
--         (NULL,
--          @OmsTemplateId,
--          Source.SKU,
--          Source.Quantity,
--          CASE
--              WHEN Source.OrderLineItemRelationshipTypeID = 0
--              THEN NULL
--              ELSE OrderLineItemRelationshipTypeID
--          END,
--          Source.CustomText,
--          Source.CartAddOnDetails,
--          Source.Sequence,
--          @UserId,
--          @GetDate,
--          @UserId,
--          @GetDate
--         )
--         OUTPUT Inserted.OmsTemplateLineItemId,
--                SOURCE.RowID
--                INTO @Tbl_SAvecartIds; 
             
			--select * from @TBL_bundleAddonRows
			--SELECT * FROM @Tbl_SAvecartIds
			 

            --INSERT INTO ZnodeOmsTemplateLineItem
            --(ParentOmsTemplateLineItemId,
            -- OmsTemplateId,
            -- SKU,
            -- Quantity,
            -- OrderLineItemRelationshipTypeID,
            -- CustomText,
            -- CartAddOnDetails,
            -- Sequence,
            -- CreatedBy,
            -- CreatedDate,
            -- ModifiedBy,
            -- ModifiedDate
            --)
            --       SELECT b.OmsTemplateLineItemId,
            --              @OmsTemplateId,
            --              SKU,
            --              Quantity,
            --              CASE
            --                  WHEN OrderLineItemRelationshipTypeID = 0
            --                  THEN NULL
            --                  ELSE OrderLineItemRelationshipTypeID
            --              END,
            --              CustomText,
            --              CartAddOnDetails,
            --              SequenceId,
            --              @UserId,
            --              @GetDate,
            --              @UserId,
            --              @GetDate
            --       FROM @TBL_bundleAddonRows AS a
            --            INNER JOIN @Tbl_SAvecartIds AS b ON(a.RowId = b.RowId)
            --       WHERE a.SKU IS NOT NULL AND a.SKU <> '';
					
            SET @Status = 1;
            COMMIT TRAN InsertUpdateSaveCartLineItem;
        END TRY
        BEGIN CATCH
        
		    SET @Status = 0;
		    DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsQuoteTemplate @TemplateLineItemXML = '+CAST(@TemplateLineItemXML AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
            SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
			ROLLBACK TRAN InsertUpdateSaveCartLineItem;
            EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_InsertUpdateOmsQuoteTemplate',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
        END CATCH;
    END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertCartLineItemsForLater')
	DROP PROC Znode_InsertCartLineItemsForLater
GO

CREATE PROCEDURE [dbo].[Znode_InsertCartLineItemsForLater]
(
	@TemplateLineItemXML XML,
    @UserId              INT,
    @Status              BIT = 0 OUT
)
AS 
/* 
	Summary :- This Procedure is Used to create the Quote Template 
    Unit Testing 
    EXEC 
    SELECT * FROM ZnodeOmsTemplate
    SELECT * FROM ZnodeOmsTemplateLineItem
*/
    BEGIN
        BEGIN TRAN InsertUpdateSaveCartLineItem;
        BEGIN TRY
            SET NOCOUNT ON;
			DECLARE @OldQty INT, @SKU NVARCHAR(600), @GetDate DATETIME = dbo.Fn_GetDate();

            DECLARE @TBL_SavecartLineitems TABLE
            (
				RowId							INT IDENTITY(1, 1),
				OmsTemplateLineItemId           INT,
				ParentOmsTemplateLineItemId     INT,
				OmsTemplateId                   INT,
				SKU                             NVARCHAR(600),
				Quantity                        NUMERIC(28, 6),
				OrderLineItemRelationshipTypeID INT,
				CustomText                      NVARCHAR(MAX),
				CartAddOnDetails                NVARCHAR(MAX),
				[Sequence]                      INT,
				AddOnValueIds                   VARCHAR(MAX),
				BundleProductIds                VARCHAR(MAX),
				ConfigurableProductIds          VARCHAR(MAX),
				GroupProductIds                 VARCHAR(MAX)
            );

            DECLARE @OrderLineItemRelationshipTypeIdAddon INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'AddOns'
            );

            DECLARE @OrderLineItemRelationshipTypeIdBundle INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Bundles'
            );

            DECLARE @OrderLineItemRelationshipTypeIdConfigurable INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Configurable'
            );

            DECLARE @OrderLineItemRelationshipTypeIdGroup INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Group'
            );

            INSERT INTO @TBL_SavecartLineitems
            (
				OmsTemplateLineItemId,
				ParentOmsTemplateLineItemId,
				OmsTemplateId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails,
				[Sequence],
				AddOnValueIds,
				BundleProductIds,
				ConfigurableProductIds,
				GroupProductIds
            )
            SELECT Tbl.Col.value('OmsTemplateLineItemId[1]', 'NVARCHAR(2000)') AS OmsSavedCartLineItemId,
				Tbl.Col.value('ParentOmsTemplateLineItemId[1]', 'NVARCHAR(2000)') AS ParentOmsSavedCartLineItemId,
				Tbl.Col.value('OmsTemplateId[1]', 'NVARCHAR(2000)') AS OmsSavedCartId,
				Tbl.Col.value('SKU[1]', 'NVARCHAR(2000)') AS SKU,
				Tbl.Col.value('Quantity[1]', 'NVARCHAR(2000)') AS Quantity,
				Tbl.Col.value('OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)') AS OrderLineItemRelationshipTypeID,
				Tbl.Col.value('CustomText[1]', 'NVARCHAR(2000)') AS CustomText,
				Tbl.Col.value('CartAddOnDetails[1]', 'NVARCHAR(2000)') AS CartAddOnDetails,
				Tbl.Col.value('Sequence[1]', 'NVARCHAR(2000)') AS Sequence,
				Tbl.Col.value('AddonProducts[1]', 'NVARCHAR(2000)') AS AddOnValueIds,
				Tbl.Col.value('BundleProducts[1]', 'NVARCHAR(2000)') AS BundleProductIds,
				Tbl.Col.value('ConfigurableProducts[1]', 'NVARCHAR(2000)') AS ConfigurableProductIds,
				Tbl.Col.value('GroupProducts[1]', 'NVARCHAR(Max)') AS GroupProductIds
            FROM @TemplateLineItemXML.nodes('//ArrayOfAccountTemplateLineItemModel/AccountTemplateLineItemModel') AS Tbl(Col);
             
            DECLARE @OmsTemplateId INT, @OmsTemplateLineItemId INT;

            DECLARE @TBL_bundleAddonRows TABLE
            (
				RowId                           INT,
				SequenceId                      INT IDENTITY(1, 1),
				ParentOmsTemplateLineItemId     INT,
				SKU                             NVARCHAR(1000),
				Quantity                        NUMERIC(28, 6),
				OrderLineItemRelationshipTypeID INT,
				CustomText                      NVARCHAR(MAX),
				CartAddOnDetails                NVARCHAR(MAX)
            );

            DECLARE @AddonProductSKU NVARCHAR(MAX)=
            (
                SELECT TOP 1 AddOnValueIds
                FROM @TBL_SavecartLineitems
            ), @BundleProductSKU NVARCHAR(MAX)=
            (
                SELECT TOP 1 BundleProductIds
                FROM @TBL_SavecartLineitems
            );
            SET @OmsTemplateId =
            (
                SELECT TOP 1 OmsTemplateId
                FROM @TBL_SavecartLineitems
            );

            SET @SKU =
            (
                SELECT TOP 1 SKU
                FROM @TBL_SavecartLineitems
            );
            IF EXISTS
            (
                SELECT TOP 1 1
                FROM ZnodeOmsSavedCartLineItem AS qa
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_SavecartLineitems AS ssds
                    WHERE ssds.sku = qa.SKU
                )
            )
            BEGIN
				SELECT @OldQty = Quantity FROM ZnodeOmsTemplateLineItem
                WHERE OmsTemplateId = @OmsTemplateId AND SKU =@SKU;

                DELETE FROM ZnodeOmsTemplateLineItem
                WHERE OmsTemplateId = @OmsTemplateId AND SKU =@SKU;
            END; 
			
            INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
            SELECT a.RowID,
                    NULL,
                    q.Item AS SKU,
                    a.Quantity,
                    @OrderLineItemRelationshipTypeIdAddon,
                    CustomText,
                    CartAddOnDetails
            FROM @TBL_SavecartLineitems AS a
            CROSS APPLY dbo.Split(a.AddOnValueIds, ',') AS q
            WHERE a.AddOnValueIds IS NOT NULL  AND a.AddOnValueIds <> '';  

            INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
			SELECT RowID,
				NULL,
				q.Item AS SKU,
				a.Quantity,
				@OrderLineItemRelationshipTypeIdBundle,
				CustomText,
				CartAddOnDetails
			FROM @TBL_SavecartLineitems AS a
			CROSS APPLY dbo.Split(a.BundleProductIds, ',') AS q
			WHERE a.BundleProductIds IS NOT NULL AND a.BundleProductIds <>'';
            
			INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
            SELECT RowID,
                NULL,
                q.Item AS SKU,
                a.Quantity,
                @OrderLineItemRelationshipTypeIdConfigurable,
                CustomText,
                CartAddOnDetails
            FROM @TBL_SavecartLineitems AS a
            CROSS APPLY dbo.Split(a.ConfigurableProductIds, ',') AS q
            WHERE a.ConfigurableProductIds IS NOT NULL AND a.ConfigurableProductIds <>'';
            
			INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
            SELECT RowID,
                NULL,
                SUBSTRING(q.Item, 1, CHARINDEX('~', q.Item)-1) AS SKU,
                SUBSTRING(q.Item, CHARINDEX('~', q.Item)+1, 4000) AS Quantity,
                @OrderLineItemRelationshipTypeIdGroup,
                CustomText,
                CartAddOnDetails
            FROM @TBL_SavecartLineitems AS a
            CROSS APPLY dbo.Split(a.GroupProductIds, ',') AS q
            WHERE a.GroupProductIds IS NOT NULL AND GroupProductIds <>''
			AND isnull(q.Item,'') <> ''; 

            DECLARE @Tbl_SAvecartIds TABLE
            (
				OmsTemplateLineItemId INT,
				RowId                 INT
            );
			 
			---Parent Product Update
			UPDATE TARGET
			SET TARGET.Quantity = SOURCE.Quantity,
				TARGET.ModifiedDate = @GetDate,
				TARGET.CreatedBy = @UserId 
			FROM ZnodeOmsTemplateLineItem TARGET
			INNER JOIN @TBL_SavecartLineitems SOURCE ON (TARGET.OmsTemplateId = SOURCE.OmsTemplateId
			AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)
			AND TARGET.SKU = SOURCE.SKU

			---Child Product Update
			UPDATE TARGET
			SET TARGET.Quantity = SCLI.Quantity,
				TARGET.ModifiedDate = @GetDate,
				TARGET.CreatedBy = @UserId 
			FROM ZnodeOmsTemplateLineItem TARGET
			INNER JOIN @TBL_SavecartLineitems SOURCE ON (TARGET.OmsTemplateId = SOURCE.OmsTemplateId
			    AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)
			INNER JOIN @TBL_bundleAddonRows SCLI ON Source.RowId = SCLI.RowId and TARGET.SKU = SCLI.SKU	
				
			INSERT INTO ZnodeOmsTemplateLineItem(ParentOmsTemplateLineItemId,OmsTemplateId,SKU,Quantity
				,OrderLineItemRelationshipTypeID,CustomText,CartAddOnDetails,[Sequence],CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
			SELECT NULL,@OmsTemplateId,Source.SKU,Source.Quantity + ISNULL(@OldQty, 0),
				CASE
				WHEN Source.OrderLineItemRelationshipTypeID = 0
				THEN NULL
				ELSE Source.OrderLineItemRelationshipTypeID
				END,
				Source.CustomText,
				Source.CartAddOnDetails,
				1 --Source.Sequence
				,@UserId,@GetDate,@UserId,@GetDate
			FROM @TBL_SavecartLineitems Source
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem TARGET 
			WHERE TARGET.OmsTemplateId = Source.OmsTemplateId 
			AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)
			
			INSERT INTO ZnodeOmsTemplateLineItem(ParentOmsTemplateLineItemId,OmsTemplateId,SKU,Quantity
				,OrderLineItemRelationshipTypeID, CustomText,CartAddOnDetails,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
			SELECT ZOTLI.OmsTemplateLineItemId,@OmsTemplateId,Source.SKU,Source.Quantity,
				CASE
				WHEN Source.OrderLineItemRelationshipTypeID = 0
				THEN NULL
				ELSE Source.OrderLineItemRelationshipTypeID
				END,
				Source.CustomText,
				Source.CartAddOnDetails,
				Source.SequenceId+1
				,@UserId,@GetDate,@UserId,@GetDate
			FROM @TBL_bundleAddonRows Source
			inner join @TBL_SavecartLineitems SCLI ON Source.RowId = SCLI.RowId
			inner join ZnodeOmsTemplateLineItem ZOTLI ON ZOTLI.OmsTemplateId = @OmsTemplateId AND ZOTLI.ParentOmsTemplateLineItemId IS NULL AND ZOTLI.OrderLineItemRelationshipTypeID is null
			AND SCLI.SKU = ZOTLI.SKU
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem TARGET 
			WHERE TARGET.OmsTemplateId = SCLI.OmsTemplateId 
			AND TARGET.OmsTemplateLineItemId = SCLI.OmsTemplateLineItemId)
  			
            SET @Status = 1;
            COMMIT TRAN InsertUpdateSaveCartLineItem;
        END TRY
    BEGIN CATCH
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertCartLineItemsForLater @TemplateLineItemXML = '+CAST(@TemplateLineItemXML AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;
			
		ROLLBACK TRAN InsertUpdateSaveCartLineItem;

        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_InsertCartLineItemsForLater',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

INSERT INTO ZnodeCMSContainerConfiguration (CMSWidgetsId,WidgetKey,CMSMappingId,TypeOFMapping,ContentContainerId,ContainerKey,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 CMSWidgetsId from ZnodeCMSWidgets where Code = 'ContentContainer') ,1786,PortalId,'PortalMapping',0,'HomePageTicker',2,Getdate(),2,Getdate() 
From ZnodePortal ZP
WHERE NOT EXISTS
	(SELECT * FROM ZnodeCMSContainerConfiguration Z WHERE ContainerKey = 'HomePageTicker'
	and Z.CMSMappingId = ZP.PortalId
	and CMSWidgetsId = (select top 1 CMSWidgetsId from ZnodeCMSWidgets where Code = 'ContentContainer')
	and TypeOFMapping = 'PortalMapping')

INSERT INTO ZnodeCMSContainerConfiguration (CMSWidgetsId,WidgetKey,CMSMappingId,TypeOFMapping,ContentContainerId,ContainerKey,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 CMSWidgetsId from ZnodeCMSWidgets where Code = 'ContentContainer') ,1787,PortalId,'PortalMapping',0,'AdSpace',2,Getdate(),2,Getdate() 
From ZnodePortal ZP
WHERE NOT EXISTS
	(SELECT * FROM ZnodeCMSContainerConfiguration Z WHERE ContainerKey = 'AdSpace'
	and Z.CMSMappingId = ZP.PortalId
	and CMSWidgetsId = (select top 1 CMSWidgetsId from ZnodeCMSWidgets where Code = 'ContentContainer')
	and TypeOFMapping = 'PortalMapping')

INSERT INTO ZnodeCMSContainerConfiguration (CMSWidgetsId,WidgetKey,CMSMappingId,TypeOFMapping,ContentContainerId,ContainerKey,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 CMSWidgetsId from ZnodeCMSWidgets where Code = 'ContentContainer') ,1788,PortalId,'PortalMapping',0,'HomePagePromo',2,Getdate(),2,Getdate() 
From ZnodePortal ZP
WHERE NOT EXISTS
	(SELECT * FROM ZnodeCMSContainerConfiguration Z WHERE ContainerKey = 'HomePagePromo'
	and Z.CMSMappingId = ZP.PortalId
	and CMSWidgetsId = (select top 1 CMSWidgetsId from ZnodeCMSWidgets where Code = 'ContentContainer')
	and TypeOFMapping = 'PortalMapping')

INSERT INTO ZnodeCMSContainerConfiguration (CMSWidgetsId,WidgetKey,CMSMappingId,TypeOFMapping,ContentContainerId,ContainerKey,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 CMSWidgetsId from ZnodeCMSWidgets where Code = 'ContentContainer') ,1789,PortalId,'PortalMapping',0,'CartPageAdSpace',2,Getdate(),2,Getdate() 
From ZnodePortal ZP
WHERE NOT EXISTS
	(SELECT * FROM ZnodeCMSContainerConfiguration Z WHERE ContainerKey = 'CartPageAdSpace'
	and Z.CMSMappingId = ZP.PortalId
	and CMSWidgetsId = (select top 1 CMSWidgetsId from ZnodeCMSWidgets where Code = 'ContentContainer')
	and TypeOFMapping = 'PortalMapping')
	
INSERT INTO ZnodeCMSContainerConfiguration (CMSWidgetsId,WidgetKey,CMSMappingId,TypeOFMapping,ContentContainerId,ContainerKey,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select top 1 CMSWidgetsId from ZnodeCMSWidgets where Code = 'ContentContainer') ,67878898,CMSContentPagesId,
'ContentPageMapping',0,'HomePageTicker',2,Getdate(),2,Getdate() 
From ZnodeCMSContentPages CCPP
WHERE 
NOT EXISTS
	(SELECT * FROM ZnodeCMSContainerConfiguration Z WHERE ContainerKey = 'HomePageTicker'
	and Z.CMSMappingId = CCPP.CMSContentPagesId
	and CMSWidgetsId = (select top 1 CMSWidgetsId from ZnodeCMSWidgets where Code = 'ContentContainer')
	and TypeOFMapping = 'ContentPageMapping')
and 
CMSTemplateId= 
(select top 1 CMSTemplateId from ZnodeCMSTemplate where Name='Landing Page With Banner Slider Multiple Content And Image Sections and Product List Slider'
)
	 
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishContentContainerAttributeValue')
	DROP PROC Znode_GetPublishContentContainerAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishContentContainerAttributeValue]
(
	@EntityName	NVARCHAR(200) = 0,
	@ContainerKey	NVARCHAR(200),
	@LocalId	INT = 0,
	@PortalId	INT = 0,
	@ProfileId	INT = 0
)
AS
/*
	 Summary :- This procedure is used to get the Content and Container attribute value as per filter pass
	 Unit Testing
	 BEGIN TRAN
	 EXEC [Znode_GetPublishContentContainerAttributeValue] @EntityName='Content Containers',@ContainerKey='',@LocalId=0,@PortalId=0,@ProfileId=0
	 ROLLBACK TRAN
*/
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
		-- Variable Declaration as per the code requirement
		DECLARE @LocaleCode NVARCHAR(50),
				@LocalIdInput INT,
				@LocaleCodeInput NVARCHAR(50),
				@CMSContainerProfileVariantId INT,
				@GroupCode NVARCHAR(200) = NULL,
				@SelectedValue BIT = 0,
				@FamilyCode VARCHAR(200);

		SET @LocalIdInput = @LocalId

		SELECT @LocaleCode=Code FROM ZnodeLocale WITH (NOLOCK) WHERE LocaleId=@LocalId;
		SET @LocaleCodeInput = @LocaleCode

		--1. Specific Store, Specific User Profile, Selected Locale
		-- Based on input if count will 1 then this will take CMSContainerProfileVariantId from 1st loop else this will go for next loop.
		IF (SELECT COUNT(1) FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK) WHERE ISNULL(WPV.PortalId,0)=@PortalId AND ISNULL(WPV.ProfileId,0)=@ProfileId  AND WPV.LocaleId=@LocalId)=1
		BEGIN
			SELECT @CMSContainerProfileVariantId=WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE ISNULL(WPV.ProfileId,0)=@ProfileId AND WPV.ContainerKey=@ContainerKey
			AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END
		ELSE
		BEGIN
			SELECT @CMSContainerProfileVariantId=WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END

		--2. Specific Store, Specific User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = @ProfileId ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		
		END

		--3. Specific Store, Any User Profile, Selected Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END

		--4. Specific Store, Any User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = @PortalId )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END
		
		--5. Any Store, Any User Profile, Selected Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1
		END

		--6. Any Store, Any User Profile, Default Locale
		IF ISNULL(@CMSContainerProfileVariantId,0) = 0
		BEGIN
			SELECT @LocalId = LocaleId FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;
			SELECT @LocaleCode = Code FROM ZnodeLocale WITH (NOLOCK) WHERE IsDefault = 1;

			SELECT @CMSContainerProfileVariantId= WPV.CMSContainerProfileVariantId 
			FROM ZnodePublishContentContainerVariantEntity WPV WITH (NOLOCK)
			WHERE (ISNULL(WPV.ProfileId,0) = 0 ) AND (ISNULL(WPV.PortalId,0) = 0 )
			AND WPV.ContainerKey=@ContainerKey AND WPV.LocaleId=@LocalId
			AND WPV.IsActive=1

			IF ISNULL(@CMSContainerProfileVariantId,0) = 0
			BEGIN
				SET @LocalId = @LocalIdInput
				SET @LocaleCode = @LocaleCodeInput
			END
		END	
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK) WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		-- Based on input @EntityName='Content Containers' as fixed value this will execute nested SP.
		-- Nested SP will give 2 Output (1 Result set & 1 Msg.

		-- Declared table variable to combined nested sp data with the output of this sp.
		DECLARE	@PublishContainerGlobalAttributeValue As TABLE
		(CMSContainerProfileVariantId INT, ContentContainerName NVARCHAR(100), ContainerKey NVARCHAR(50), GlobalAttributes NVARCHAR(MAX), ContainerTemplateName NVARCHAR(100))

		IF @EntityName='Content Containers'
		begin
			INSERT INTO @PublishContainerGlobalAttributeValue
				(CMSContainerProfileVariantId,ContentContainerName, ContainerKey, GlobalAttributes, ContainerTemplateName)
			EXEC [dbo].[Znode_GetPublishContainerGlobalAttributeValue]
				@CMSContainerProfileVariantId=@CMSContainerProfileVariantId, @LocaleCode= @LocaleCode
		end
		
		-- This will take FamilyCode based on the inputs.
		SELECT @FamilyCode=GAF.FamilyCode
		FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
		INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
		WHERE CCW.ContainerKey=@ContainerKey 
		AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId));

		IF ISNULL(@FamilyCode,'') = ''
		BEGIN
			-- This will take FamilyCode based on the inputs.
			SELECT @FamilyCode=GAF.FamilyCode
			FROM ZnodeCMSContentContainer CCW WITH (NOLOCK)
			INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON CCW.FamilyId=GAF.GlobalAttributeFamilyId
			WHERE CCW.ContainerKey=@ContainerKey 
			AND EXISTS(SELECT * FROM ZnodeCMSContainerProfileVariant CWPV WHERE CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=0));
		END

		-- This will give 3rd result set of Attribute Groups Data.
		--SELECT GE.GlobalEntityId, GE.EntityName, GE.IsActive, GE.TableName, GE.IsFamilyUnique
		--	, GAF.GlobalAttributeFamilyId, GAF.FamilyCode, GAF.IsSystemDefined, GAF.GlobalEntityId
		--	, GFGM.GlobalFamilyGroupMapperId, GFGM.GlobalAttributeFamilyId, GFGM.GlobalAttributeGroupId
		--	, GFGM.AttributeGroupDisplayOrder
		--	, GAG.GlobalAttributeGroupId, GAG.GroupCode, GAG.DisplayOrder, GAG.IsSystemDefined, GAG.GlobalEntityId
		--	, GAGL.GlobalAttributeGroupLocaleId, GAGL.LocaleId, GAGL.GlobalAttributeGroupId, GAGL.AttributeGroupName
		--	, GAGL.[Description]
		--FROM ZnodeGlobalEntity GE WITH (NOLOCK)
		--INNER JOIN ZnodeGlobalAttributeFamily GAF WITH (NOLOCK) ON GE.GlobalEntityId=GAF.GlobalEntityId
		--INNER JOIN ZnodeGlobalFamilyGroupMapper GFGM WITH (NOLOCK) ON GAF.GlobalAttributeFamilyId=GFGM.GlobalAttributeFamilyId
		--INNER JOIN ZnodeGlobalAttributeGroup GAG WITH (NOLOCK) ON GFGM.GlobalAttributeGroupId=GAG.GlobalAttributeGroupId
		--INNER JOIN ZnodeGlobalAttributeGroupLocale GAGL WITH (NOLOCK) ON GAG.GlobalAttributeGroupId=GAGL.GlobalAttributeGroupId
		--WHERE GE.EntityName=@EntityName AND GAGL.LocaleId=@LocalId AND GAF.FamilyCode=@FamilyCode
		--ORDER BY GFGM.AttributeGroupDisplayOrder;

		-- This will give 4th result set of ContainerProfile & ContentContainer Data.

		;WITH Cte_CMSContainerProfileVariant AS
		(
		SELECT DISTINCT CWPV.PublishContentContainerVariantEntityId,CWPV.CMSContainerProfileVariantId, CWPV.CMSContentContainerId, CGAV.ContentContainerName, CWPV.ProfileId
			, CWPV.LocaleId, CWPV.CMSContainerTemplateId, CGAV.ContainerTemplateName
			, CCW.[Name], CCW.ContainerKey, CWPV.PortalId, CCW.FamilyId, CCW.Tags
			, CGAV.GlobalAttributes
		FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK)
		INNER JOIN ZnodeCMSContentContainer CCW WITH (NOLOCK) ON CWPV.CMSContentContainerId=CCW.CMSContentContainerId
		INNER JOIN @PublishContainerGlobalAttributeValue CGAV ON CCW.ContainerKey=CGAV.ContainerKey
			AND CWPV.CMSContainerProfileVariantId=CGAV.CMSContainerProfileVariantId
		WHERE CWPV.IsActive=1 AND ( (ISNULL(CWPV.ProfileId,0) = @ProfileId OR ISNULL(CWPV.ProfileId,0) = 0) AND CWPV.LocaleId=@LocalId AND CCW.ContainerKey=@ContainerKey
			AND ((ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0)))
		)
		,Cte_GetFirstFilterData AS
		(
		SELECT DISTINCT CWPV.PublishContentContainerVariantEntityId,CWPV.CMSContainerProfileVariantId, CWPV.CMSContentContainerId, CGAV.ContentContainerName, CWPV.ProfileId
			, CWPV.LocaleId, CWPV.CMSContainerTemplateId, CGAV.ContainerTemplateName
			, CCW.[Name], CCW.ContainerKey, CWPV.PortalId, CCW.FamilyId, CCW.Tags
			, CGAV.GlobalAttributes
		FROM ZnodePublishContentContainerVariantEntity CWPV WITH (NOLOCK)
		INNER JOIN ZnodeCMSContentContainer CCW WITH (NOLOCK) ON CWPV.CMSContentContainerId=CCW.CMSContentContainerId
		INNER JOIN @PublishContainerGlobalAttributeValue CGAV ON CCW.ContainerKey=CGAV.ContainerKey
		WHERE CWPV.ProfileId IS NULL AND CCW.ContainerKey=@ContainerKey AND CWPV.PortalId IS NULL AND CWPV.LocaleId=@LocalId
		)

		SELECT DISTINCT CMSContainerProfileVariantId, CMSContentContainerId, ContentContainerName, ProfileId
			, LocaleId, CMSContainerTemplateId, ContainerTemplateName
			, [Name], ContainerKey, PortalId, FamilyId, Tags
			, GlobalAttributes
		FROM Cte_CMSContainerProfileVariant
		UNION
		SELECT DISTINCT CMSContainerProfileVariantId, CMSContentContainerId, ContentContainerName, ProfileId
			, LocaleId, CMSContainerTemplateId, ContainerTemplateName
			, [Name], ContainerKey, PortalId, FamilyId, Tags
			, GlobalAttributes
		FROM Cte_GetFirstFilterData CWPV
		WHERE NOT EXISTS (SELECT * FROM Cte_CMSContainerProfileVariant WHERE PublishContentContainerVariantEntityId=CWPV.PublishContentContainerVariantEntityId)
			AND NOT EXISTS (SELECT * FROM Cte_CMSContainerProfileVariant)

		-- This will give 5th result set of ContainerTemplate & ContentContainer Data.
		--SELECT CWT.CMSContainerTemplateId, CWT.[FileName], CWT.MediaId, CCW.[Name], CCW.FamilyId, CCW.Tags
		--FROM ZnodeCMSContentContainer CCW WITH (NOLOCK) 
		--INNER JOIN ZnodeCMSContainerProfileVariant CWPV ON CCW.CMSContentContainerId = CWPV.CMSContentContainerId AND (ISNULL(CWPV.PortalId,0)=@PortalId OR ISNULL(CWPV.PortalId,0) = 0)
		--INNER JOIN ZnodeCMSContainerProfileVariantLocale CWPVL ON CWPV.CMSContainerProfileVariantId = CWPVL.CMSContainerProfileVariantId
		--INNER JOIN  ZnodeCMSContainerTemplate CWT WITH (NOLOCK) ON (CWPVL.CMSContainerTemplateId = CWT.CMSContainerTemplateId OR ISNULL(CWPVL.CMSContainerTemplateId,0) = 0)
		--WHERE CCW.ContainerKey=@ContainerKey
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()
		DECLARE @Status BIT;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPublishContentContainerAttributeValue
					@EntityName = '''+ISNULL(@EntityName,'''''')+
					''',@ContainerKey='+ISNULL(@ContainerKey,'''')+
					''',@LocalId='+ISNULL(CAST(@LocalId AS VARCHAR(20)),'''')+
					''',@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(20)),'''')+
					''',@ProfileId='+ISNULL(CAST(@ProfileId AS VARCHAR(20)),'''')
					
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetPublishContentContainerAttributeValue',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

DECLARE @PublishStateId INT;
SELECT @PublishStateId=PublishStateId FROM ZnodePublishState WHERE PublishStateCode='DRAFT'

--ZnodeGlobalEntity
INSERT INTO ZnodeGlobalEntity (EntityName,IsActive,TableName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsFamilyUnique)
SELECT 'Content Containers',1,'ZnodeWidgetGlobalAttributeValue',2, GETDATE(), 2, GETDATE(), 0
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntity WHERE GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers'))

--ZnodeGlobalAttributeFamily
INSERT [dbo].[ZnodeGlobalAttributeFamily] ([FamilyCode], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'HomepageMarketingContentBlock', 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock')

INSERT [dbo].[ZnodeGlobalAttributeFamily] ([FamilyCode], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'HomePageTicker', 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker')

INSERT [dbo].[ZnodeGlobalAttributeFamily] ([FamilyCode], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'HomePageAdSpace', 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace')

INSERT [dbo].[ZnodeGlobalAttributeFamily] ([FamilyCode], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'CartPageAdSpace', 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace')


--ZnodeGlobalAttributeFamilyLocale
INSERT [dbo].[ZnodeGlobalAttributeFamilyLocale] ([LocaleId], [GlobalAttributeFamilyId], [AttributeFamilyName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'),
N'HomePage Promo', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamilyLocale WHERE GlobalAttributeFamilyId=(SELECT GlobalAttributeFamilyId 
	FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'))

INSERT [dbo].[ZnodeGlobalAttributeFamilyLocale] ([LocaleId], [GlobalAttributeFamilyId], [AttributeFamilyName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker'),
N'Home Page Ticker', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamilyLocale WHERE GlobalAttributeFamilyId=(SELECT GlobalAttributeFamilyId 
	FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker'))

INSERT [dbo].[ZnodeGlobalAttributeFamilyLocale] ([LocaleId], [GlobalAttributeFamilyId], [AttributeFamilyName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'),
N'Home Page Ad Space', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamilyLocale WHERE GlobalAttributeFamilyId=(SELECT GlobalAttributeFamilyId 
	FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'))

INSERT [dbo].[ZnodeGlobalAttributeFamilyLocale] ([LocaleId], [GlobalAttributeFamilyId], [AttributeFamilyName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate])  
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'),
N'Cart Page Ad Space', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeFamilyLocale WHERE GlobalAttributeFamilyId=(SELECT GlobalAttributeFamilyId 
	FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'))


-- ZnodeCMSContentContainer
INSERT [dbo].[ZnodeCMSContentContainer] ([Name], [ContainerKey], [FamilyId], [Tags], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT N'Home Page Promo', N'HomePagePromo', 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'), 
N'', 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')

INSERT [dbo].[ZnodeCMSContentContainer] ([Name], [ContainerKey], [FamilyId], [Tags], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT N'Home Page Ticker', N'HomePageTicker', 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker'), 
N'', 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')

INSERT [dbo].[ZnodeCMSContentContainer] ([Name], [ContainerKey], [FamilyId], [Tags], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT N'Home Page Ad Space', N'AdSpace', 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'), 
NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')

INSERT [dbo].[ZnodeCMSContentContainer] ([Name], [ContainerKey], [FamilyId], [Tags], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT N'Cart Page Ad Spaces', N'CartPageAdSpace', 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'), 
NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')


--ZnodeCMSContainerProfileVariant
INSERT [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContentContainerId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT (SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'), 
NULL, NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)

INSERT [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContentContainerId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT (SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker'), 
NULL, NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer 
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)

INSERT [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContentContainerId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT (SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey IN ('AdSpace')), 
NULL, NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey IN ('AdSpace') )
AND NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer 
	WHERE ContainerKey IN ('AdSpace')) AND ProfileId IS NULL AND PortalId IS NULL)

INSERT [dbo].[ZnodeCMSContainerProfileVariant] ([CMSContentContainerId], [ProfileId], [PortalId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [PublishStateId]) 
SELECT (SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey IN ('CartPageAdSpace')), 
NULL, NULL, 2, GETDATE(), 2, GETDATE(), @PublishStateId
WHERE EXISTS (SELECT * FROM ZnodeCMSContentContainer WHERE ContainerKey IN ('CartPageAdSpace') )
AND NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer 
	WHERE ContainerKey IN ('CartPageAdSpace')) AND ProfileId IS NULL AND PortalId IS NULL)


-- Update Publish Status
UPDATE ZnodeCMSContentContainer
SET PublishStateId=@PublishStateId
WHERE ContainerKey IN ('HomePagePromo','HomePageTicker','AdSpace','CartPageAdSpace')
	AND PublishStateId<>@PublishStateId

UPDATE CPV
SET CPV.PublishStateId=@PublishStateId
FROM ZnodeCMSContainerProfileVariant CPV
INNER JOIN ZnodeCMSContentContainer CC ON CPV.CMSContentContainerId=CC.CMSContentContainerId
WHERE CC.ContainerKey IN ('HomePagePromo','HomePageTicker','AdSpace','CartPageAdSpace')
	AND CPV.PublishStateId<>@PublishStateId


--ZnodeCMSContainerProfileVariantLocale
INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT 
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
NULL, 
1, 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL))

INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT 
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
NULL, 
1, 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL))

INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT 
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL),
NULL, 
1, 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL))

INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT 
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
NULL, 
1, 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL))

INSERT [dbo].[ZnodeCMSContainerProfileVariantLocale] ([CMSContainerProfileVariantId], [CMSContainerTemplateId], [LocaleId], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsActive]) 
SELECT 
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
NULL, 
1, 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeCMSContainerProfileVariantLocale WHERE CMSContainerProfileVariantId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL))



--ZnodeGlobalEntityFamilyMapper

INSERT INTO ZnodeGlobalEntityFamilyMapper (GlobalAttributeFamilyId,GlobalEntityId,GlobalEntityValueId)
SELECT 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntityFamilyMapper
	WHERE GlobalAttributeFamilyId=(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock')
	AND GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
	AND GlobalEntityValueId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
)

INSERT INTO ZnodeGlobalEntityFamilyMapper (GlobalAttributeFamilyId,GlobalEntityId,GlobalEntityValueId)
SELECT 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntityFamilyMapper
	WHERE GlobalAttributeFamilyId=(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker')
	AND GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
	AND GlobalEntityValueId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)
)

INSERT INTO ZnodeGlobalEntityFamilyMapper (GlobalAttributeFamilyId,GlobalEntityId,GlobalEntityValueId)
SELECT 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntityFamilyMapper
	WHERE GlobalAttributeFamilyId=(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace')
	AND GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
	AND GlobalEntityValueId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
)





INSERT INTO ZnodeGlobalEntityFamilyMapper (GlobalAttributeFamilyId,GlobalEntityId,GlobalEntityValueId)
SELECT 
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalEntityFamilyMapper
	WHERE GlobalAttributeFamilyId=(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace')
	AND GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
	AND GlobalEntityValueId=(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
)


--ZnodeMediaServerMaster
INSERT INTO ZnodeMediaServerMaster (ServerName,PartialViewName,IsOtherServer,ThumbnailFolderName,ClassName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'Local','Local',0,'Thumbnail','LocalAgent',2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeMediaServerMaster WHERE MediaServerMasterId=(SELECT TOP 1 MediaServerMasterId FROM ZnodeMediaServerMaster WHERE PartialViewName='Local'))


-- ZnodeMedia
INSERT [dbo].[ZnodeMedia] ([MediaConfigurationId], [Path], [FileName], [Size], [Height], [Width], [Length], [Type], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [Version]) 
SELECT (SELECT TOP 1 MediaConfigurationId FROM ZnodeMediaConfiguration 
	WHERE MediaServerMasterId=(SELECT TOP 1 MediaServerMasterId FROM ZnodeMediaServerMaster WHERE PartialViewName='Local') AND IsActive=1),
N'42bff3d2-0dbf-4b6d-b1be-321537912ad03945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg', N'3945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg', N'239347', N'500       ', N'750       ', N'239347    ', N'.jpg', 2, GETDATE(), 2, GETDATE(), 0
WHERE NOT EXISTS (SELECT * FROM ZnodeMedia WHERE [FileName]='3945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg')

INSERT [dbo].[ZnodeMedia] ([MediaConfigurationId], [Path], [FileName], [Size], [Height], [Width], [Length], [Type], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [Version]) 
SELECT (SELECT TOP 1 MediaConfigurationId FROM ZnodeMediaConfiguration
	WHERE MediaServerMasterId=(SELECT TOP 1 MediaServerMasterId FROM ZnodeMediaServerMaster WHERE PartialViewName='Local') AND IsActive=1),
N'847cd3a7-bcbd-4c94-b881-e67872a7fad93225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg', N'3225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg', N'107304', N'500       ', N'750       ', N'107304    ', N'.jpg', 2, GETDATE(), 2, GETDATE(), 0
WHERE NOT EXISTS (SELECT * FROM ZnodeMedia WHERE [FileName]='3225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg')

INSERT [dbo].[ZnodeMedia] ([MediaConfigurationId], [Path], [FileName], [Size], [Height], [Width], [Length], [Type], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [Version]) 
SELECT(SELECT TOP 1 MediaConfigurationId FROM ZnodeMediaConfiguration 
	WHERE MediaServerMasterId=(SELECT TOP 1 MediaServerMasterId FROM ZnodeMediaServerMaster WHERE PartialViewName='Local') AND IsActive=1),
N'fd3a3779-19c9-47a7-82db-5ec81554abc3d4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg', N'd4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg', N'81401', N'449       ', N'1400      ', N'81401     ', N'.jpg', 2, GETDATE(), 2, GETDATE(), 0
WHERE NOT EXISTS (SELECT * FROM ZnodeMedia WHERE [FileName]='d4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg')

INSERT [dbo].[ZnodeMedia] ([MediaConfigurationId], [Path], [FileName], [Size], [Height], [Width], [Length], [Type], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [Version]) 
SELECT (SELECT TOP 1 MediaConfigurationId FROM ZnodeMediaConfiguration 
	WHERE MediaServerMasterId=(SELECT TOP 1 MediaServerMasterId FROM ZnodeMediaServerMaster WHERE PartialViewName='Local') AND IsActive=1),
N'846b4bc5-a7db-4489-8305-7b07d4f6c45a9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg', N'9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg', N'52407', N'449       ', N'800       ', N'52407     ', N'.jpg', 2, GETDATE(), 2, GETDATE(), 1
WHERE NOT EXISTS (SELECT * FROM ZnodeMedia WHERE [FileName]='9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg')


--ZnodeGlobalAttributeGroup

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'HomepageMarketingContentBlock', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'DisplayOptions', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'HomePageTicker', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'AdSpace', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'AdSpace2', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'CartPageAdSpace1', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'CartPageAdSpace2', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2')

INSERT [dbo].[ZnodeGlobalAttributeGroup] ([GroupCode], [DisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT N'CartPageAdSpace', NULL, 2, GETDATE(), 2, GETDATE(), 0,
	(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace')









-- ZnodeGlobalAttributeGroupLocale

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
N'Marketing Content Block', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate])
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions'),
N'Display Options', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker'),
N'Home Page Ticker', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
N'Ad Space', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
N'Ad Space2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'),
N'Cart Page Ad Space1', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'),
N'Cart Page Ad Space2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupLocale] ([LocaleId], [GlobalAttributeGroupId], [AttributeGroupName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT
1, 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'),
N'Cart Page Ad Space', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupLocale WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'))


--ZnodeGlobalFamilyGroupMapper
INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomepageMarketingContentBlock')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageTicker')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='HomePageAdSpace')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2')
)

INSERT INTO ZnodeGlobalFamilyGroupMapper (GlobalAttributeFamilyId,GlobalAttributeGroupId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT
(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'),
999, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalFamilyGroupMapper WHERE GlobalAttributeFamilyId=
	(SELECT TOP 1 GlobalAttributeFamilyId FROM ZnodeGlobalAttributeFamily WHERE FamilyCode='CartPageAdSpace')
	AND GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace')
)





--ZnodeGlobalAttribute

INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId]) 
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'PromoTitle1', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1')

INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'),
N'PromoLargeImage', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'),
N'PromoSmallImage', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'PromoCTAText', 0,
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'PromoCTALinkURL', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'HomePageTicker', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'), 
N'AdSpaceImage1', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'),
N'TitleForImage1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'),  
N'TextForImage1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'CTALinkURL1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'), 
N'AdSpaceImage2', 0, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'TitleForImage2', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'TextorImage2', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'CTALinkURL2', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageTitle1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageText1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'C2', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='C2')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageTitle2', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2')
																																																					  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageText3', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageTitle3', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'), 
N'CartPageText03', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'C3', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='C3')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'BackgroundColor', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'ContentAlignment', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment')
																																																													  
INSERT [dbo].[ZnodeGlobalAttribute] ([AttributeTypeId], [AttributeCode], [IsRequired], [IsLocalizable], [IsActive], [DisplayOrder], [HelpDescription], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [IsSystemDefined], [GlobalEntityId])  
SELECT 
(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'),
N'C1', 1, 
1, 0, 500, NULL, 2, GETDATE(), 2, GETDATE(), 0,
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttribute WHERE AttributeCode='C1')



--ZnodeGlobalAttributeLocale


INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'),
N'BackgroundColor', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'),
N'ContentAlignment', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'),
N'Title', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'),
N'Title', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'),
N'Title', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'),
N'Description', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'),
N'Description', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'),
N'Description', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'),
N'CTA Link URL', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'),
N'CTA Link URL', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'),
N'CTA Link URL', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'),
N'Ad Space Image 1', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'),
N'Ad Space Image 2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'),
N'Title For Image 1', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'),
N'Title For Image 2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'),
N'Text For Image 1', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'),
N'Text For Image 2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'),
N'CTA Link URL 1', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'),
N'CTA Link URL 2', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'),
N'Promo Small Image', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'),
N'Promo Large Image', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'),
N'Promo CTA Text', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'),
N'Prom CTA Link URL', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'),
N'Home Page Ticker', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'))

INSERT [dbo].[ZnodeGlobalAttributeLocale] ([LocaleId], [GlobalAttributeId], [AttributeName], [Description], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
1, 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'),
N'Promo Title', NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeLocale WHERE GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'))






--ZnodeGlobalAttributeGroupMapper

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomepageMarketingContentBlock')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='HomePageTicker')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='AdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace2')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='DisplayOptions')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'))

INSERT [dbo].[ZnodeGlobalAttributeGroupMapper] ([GlobalAttributeGroupId], [GlobalAttributeId], [AttributeDisplayOrder], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1'),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'),
NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeGlobalAttributeGroupMapper 
	WHERE GlobalAttributeGroupId=(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode='CartPageAdSpace1')
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'))


--ZnodeWidgetGlobalAttributeValue

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3'))

INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3'))





INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor'))


INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment'))





INSERT [dbo].[ZnodeWidgetGlobalAttributeValue] ([CMSContentContainerId], [CMSContainerProfileVariantId], [GlobalAttributeId], [GlobalAttributeDefaultValueId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate]) 
SELECT 
(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace'),
(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL),
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'),
NULL, NULL, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
AND CMSContainerProfileVariantId=
	(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
WHERE CMSContentContainerId=(SELECT TOP 1 [CMSContentContainerId] FROM ZnodeCMSContentContainer
	WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
AND GlobalAttributeId=
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1'))


--ZnodeWidgetGlobalAttributeValueLocale

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1')
),
1, N'Getting the fine edges with <br />The Cordless Dewalt Router ZX-3000', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoTitle1')
	) AND LocaleId=1
)


INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText')
),
1, N'View Product', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTAText')
	) AND LocaleId=1
)



INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL')
),
1, N'/mountain-plumbing-10-inch-traditional-round-rain-head', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoCTALinkURL')
	) AND LocaleId=1
)




INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage')
),
1, NULL, 2, GETDATE(), 2, GETDATE(), NULL, 
(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='fd3a3779-19c9-47a7-82db-5ec81554abc3d4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg'),
N'fd3a3779-19c9-47a7-82db-5ec81554abc3d4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg'
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoLargeImage')
	AND MediaId=(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='fd3a3779-19c9-47a7-82db-5ec81554abc3d4e1e90e-b63b-421b-a4b1-607bfb644f0brouter-short.jpg')
	) AND LocaleId=1
)


INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage')
),
1, NULL, 2, GETDATE(), 2, GETDATE(), NULL, 
(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='846b4bc5-a7db-4489-8305-7b07d4f6c45a9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg'),
N'846b4bc5-a7db-4489-8305-7b07d4f6c45a9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg'
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='PromoSmallImage')
	AND MediaId=(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='846b4bc5-a7db-4489-8305-7b07d4f6c45a9d640c1a-53d0-479a-b614-487ac5ca9d13router-small.jpg')
	) AND LocaleId=1
)


INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker')
),
1, N'Save 20% during the holidays! Enter Holidays2021 at checkout.', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePageTicker')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePageTicker') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='HomePageTicker')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1')
),
1, N'DeWalt Guaranteed Tough one', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage1')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1')
),
1, N'Outdoor Power Equipment Designed to Handle the Most Demanding Yards', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextForImage1')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1')
),
1, N'#', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL1')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2')
),
1, N'Up To $100 OFF', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TitleForImage2')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2')
),
1, N'Select Tools + Free Delivery', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='TextorImage2')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2')
),
1, N'/cordless-woodworking', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CTALinkURL2')
	) AND LocaleId=1
)




INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1')
),
1, NULL, 2, GETDATE(), 2, GETDATE(), NULL, 
(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]=N'42bff3d2-0dbf-4b6d-b1be-321537912ad03945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg'),
N'42bff3d2-0dbf-4b6d-b1be-321537912ad03945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg'
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage1')
	AND MediaId=(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='42bff3d2-0dbf-4b6d-b1be-321537912ad03945ac03-7e20-488b-a690-028e7bea2325ad-dewalt-lawncare.jpg')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2')
),
1, NULL, 2, GETDATE(), 2, GETDATE(), NULL, 
(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]=N'847cd3a7-bcbd-4c94-b881-e67872a7fad93225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg'),
N'847cd3a7-bcbd-4c94-b881-e67872a7fad93225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg'
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='AdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='AdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='AdSpaceImage2')
	AND MediaId=(SELECT TOP 1 MediaId FROM ZnodeMedia WHERE [Path]='847cd3a7-bcbd-4c94-b881-e67872a7fad93225d329-4e61-4158-bd65-5402a20dfc5bad-100off-tools.jpg')
	) AND LocaleId=1
)



INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1')
),
1, N'Buy Online. Pick-up in store.', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle1')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1')
),
1, N'Pick-up in store in under 2 hours', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText1')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2')
),
1, N'Get up to $100 off!', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C2')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath])
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2')
),
1, N'Get a Maxwell''s Credit Card and receive $25 off your purchase of $25+', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle2')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03')
),
1, N'#', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText03')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3')
),
1, N'Parts Service Repair', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageText3')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3')
),
1, N'Find a service pro near you', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='CartPageTitle3')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3')
),
1, N'#', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C3')
	) AND LocaleId=1
)



INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor')
),
1, N'grey', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='BackgroundColor')
	) AND LocaleId=1
)

INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment')
),
1, N'Vertical', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='HomePagePromo')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='HomePagePromo') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='ContentAlignment')
	) AND LocaleId=1
)



INSERT [dbo].[ZnodeWidgetGlobalAttributeValueLocale] ([WidgetGlobalAttributeValueId], [LocaleId], [AttributeValue], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate], [GlobalAttributeDefaultValueId], [MediaId], [MediaPath]) 
SELECT 
(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1')
),
1, N'#', 2, GETDATE(), 2, GETDATE(), NULL, NULL, NULL
WHERE NOT EXISTS (SELECT * FROM ZnodeWidgetGlobalAttributeValueLocale WHERE WidgetGlobalAttributeValueId=
	(SELECT TOP 1 WidgetGlobalAttributeValueId FROM ZnodeWidgetGlobalAttributeValue WHERE CMSContentContainerId=
	(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer WHERE ContainerKey='CartPageAdSpace')
	AND CMSContainerProfileVariantId=
		(SELECT TOP 1 CMSContainerProfileVariantId FROM ZnodeCMSContainerProfileVariant
	WHERE CMSContentContainerId=(SELECT TOP 1 CMSContentContainerId FROM ZnodeCMSContentContainer
		WHERE ContainerKey='CartPageAdSpace') AND ProfileId IS NULL AND PortalId IS NULL)
	AND GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='C1')
	) AND LocaleId=1
)



--ZnodeGlobalAttributeValidation

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'BackgroundColor')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))


INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'ContentAlignment')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageTitle3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText03'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText03')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText03'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CartPageText03')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))


INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C3')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'C1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))



INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxFileSize' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'20',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxFileSize'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxFileSize' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'20',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxFileSize'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))


INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TitleForImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextForImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextForImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextForImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextForImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextorImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextorImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextorImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'TextorImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))



INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'CTALinkURL2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))



INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxFileSize' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'20',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxFileSize'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxFileSize' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'20',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxFileSize'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'IsAllowMultiUpload'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')))



INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTAText')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'ValidationRule'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'RegularExpression'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoCTALinkURL')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'UniqueValue'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text')))




INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'HomePageTicker'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'HomePageTicker')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'HomePageTicker'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'HomePageTicker')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoTitle1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'MaxCharacters' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoTitle1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'MaxCharacters'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoTitle1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'WYSIWYGEnabledProperty' 
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area'))
,NULL,'false',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoTitle1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'WYSIWYGEnabledProperty'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Text Area')))

--Start For all extensions for Image Data Type
IF EXISTS (	SELECT TOP 1 1 FROM ZnodeGlobalAttributeValidation GAV
			INNER JOIN ZnodeGlobalAttribute GA ON GAV.GlobalAttributeId=GA.GlobalAttributeId
			INNER JOIN ZnodeAttributeInputValidation AV ON GAV.InputValidationId=AV.InputValidationId
			WHERE GA.GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
				AND AV.AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')
				AND GAV.InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name='Extensions'
					AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
				AND InputValidationRuleId IS NULL)
BEGIN
	DELETE GAV
	FROM ZnodeGlobalAttributeValidation GAV
	INNER JOIN ZnodeGlobalAttribute GA ON GAV.GlobalAttributeId=GA.GlobalAttributeId
	INNER JOIN ZnodeAttributeInputValidation AV ON GAV.InputValidationId=AV.InputValidationId
	WHERE GA.GlobalEntityId=(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName='Content Containers')
		AND AV.AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')
		AND GAV.InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name='Extensions'
			AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
		AND InputValidationRuleId IS NULL
END

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpg'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.png')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.png'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.gif')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.gif'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpeg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpeg'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.ico')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.ico'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.svg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage1')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.svg'))



INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpg'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.png')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.png'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.gif')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.gif'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpeg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpeg'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.ico')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.ico'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.svg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'AdSpaceImage2')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.svg'))




INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpg'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.png')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.png'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.gif')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.gif'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpeg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpeg'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.ico')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.ico'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.svg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoSmallImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.svg'))



INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpg'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.png')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.png'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.gif')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.gif'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpeg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.jpeg'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.ico')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.ico'))

INSERT INTO ZnodeGlobalAttributeValidation (GlobalAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage'),
(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
,(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.svg')
,NULL,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalAttributeValidation WHERE GlobalAttributeId = 
	(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode = 'PromoLargeImage')
AND InputValidationId = (SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image'))
AND InputValidationRuleId=(SELECT TOP 1 InputValidationRuleId FROM ZnodeAttributeInputValidationRule WHERE InputValidationId=(SELECT TOP 1 InputValidationId FROM ZnodeAttributeInputValidation  WHERE Name = 'Extensions'
	AND AttributeTypeId=(SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE AttributeTypeName='Image')) AND ValidationName='.svg'))

--End For all extensions for Image Data Type

--ZnodeGlobalGroupEntityMapper
INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'HomepageMarketingContentBlock'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'HomepageMarketingContentBlock')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'DisplayOptions'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'DisplayOptions')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'HomePageTicker'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'HomePageTicker')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'AdSpace'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'AdSpace')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'AdSpace2'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'AdSpace2')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace1'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace1')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace2'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace2')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

INSERT INTO ZnodeGlobalGroupEntityMapper(GlobalAttributeGroupId,GlobalEntityId,AttributeGroupDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 
(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace'),
(SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'),999, 2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeGlobalGroupEntityMapper WHERE GlobalAttributeGroupId=
	(SELECT TOP 1 GlobalAttributeGroupId FROM ZnodeGlobalAttributeGroup WHERE GroupCode = 'CartPageAdSpace')
      AND GlobalEntityId = (SELECT TOP 1 GlobalEntityId FROM ZnodeGlobalEntity WHERE EntityName = 'Content Containers'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSearchTriggerItemRuleDetails')
	DROP PROC Znode_GetSearchTriggerItemRuleDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetSearchTriggerItemRuleDetails]
(
	@Keyword nvarchar(100) = '',
	@PublishCatalogId int
)
AS
BEGIN

	SET NOCOUNT ON;
	BEGIN TRY

	DECLARE @GetDate DATETIME= dbo.Fn_GetDate()

	IF OBJECT_ID('tempdb..#KeyWord') IS NOT NULL
		DROP TABLE #KeyWord

	SELECT *
	INTO #KeyWord
	FROM dbo.Split(@KeyWord,' ')

	DELETE FROM #KeyWord WHERE LEN(Item)<1

	IF OBJECT_ID('tempdb..#Temp') IS NOT NULL
		DROP TABLE #Temp

	SELECT DISTINCT ZSCR.SearchCatalogRuleId, ZSTR.SearchTriggerRuleId, ZSTR.SearchTriggerValue, ZSTR.SearchTriggerCondition,ZSCR.IsItemForAll, ZSCR.IsTriggerForAll
	INTO #Temp
	FROM ZnodeSearchCatalogRule ZSCR 
	INNER JOIN ZnodeSearchTriggerRule ZSTR ON ZSCR.SearchCatalogRuleId = ZSTR.SearchCatalogRuleId
	INNER JOIN #KeyWord K ON ((ZSTR.SearchTriggerCondition='Is' AND ZSTR.SearchTriggerValue=K.Item)
								OR (ZSTR.SearchTriggerCondition='Contains' AND K.Item LIKE '%'+ZSTR.SearchTriggerValue+'%')
							)
	WHERE ZSCR.PublishCatalogId = @PublishCatalogId AND ZSCR.IsGlobalRule = 0 AND IsPause <> 1
		AND CAST(@GetDate AS DATE) BETWEEN CAST(ZSCR.StartDate AS DATE) AND ISNULL(ZSCR.EndDate,'9999-01-01')

	SELECT A.*,ZSCR.IsItemForAll
	FROM
	(
		SELECT SearchCatalogRuleId,SearchItemKeyword,SearchItemCondition,SearchItemValue,SearchItemBoostValue
		FROM ZnodeSearchItemRule A
		WHERE EXISTS (SELECT TOP 1 1 FROM #Temp WHERE IsTriggerForAll=0 AND SearchCatalogRuleId=A.SearchCatalogRuleId)

		UNION ALL
		SELECT SearchCatalogRuleId,SearchItemKeyword,SearchItemCondition,SearchItemValue,SearchItemBoostValue
		FROM ZnodeSearchItemRule B
		WHERE EXISTS (SELECT TOP 1 1 FROM #Temp WHERE IsTriggerForAll=1 AND SearchCatalogRuleId=B.SearchCatalogRuleId)
			AND NOT EXISTS
				(SELECT TOP 1 1 FROM ZnodeSearchTriggerRule ZSTR
				LEFT JOIN #Temp T ON ZSTR.SearchCatalogRuleId=T.SearchCatalogRuleId AND ZSTR.SearchTriggerValue=T.SearchTriggerValue
				LEFT JOIN #KeyWord K ON K.Item LIKE '%'+ZSTR.SearchTriggerValue+'%'
				WHERE (T.IsTriggerForAll<>0 OR T.IsTriggerForAll IS NULL) AND K.Id IS NULL
				AND EXISTS(SELECT TOP 1 1 FROM #Temp WHERE SearchCatalogRuleId=ZSTR.SearchCatalogRuleId))
	) A
	INNER JOIN ZnodeSearchCatalogRule ZSCR ON A.SearchCatalogRuleId=ZSCR.SearchCatalogRuleId

	UNION ALL
	SELECT DISTINCT ZSCR.SearchCatalogRuleId,ZSIR.SearchItemKeyword, ZSIR.SearchItemCondition, ZSIR.SearchItemValue, ZSIR.SearchItemBoostValue, ZSCR.IsItemForAll
	FROM ZnodeSearchCatalogRule ZSCR 
	LEFT JOIN ZnodeSearchTriggerRule ZSTR ON ZSCR.SearchCatalogRuleId = ZSTR.SearchCatalogRuleId 
	INNER JOIN ZnodeSearchItemRule ZSIR ON ZSCR.SearchCatalogRuleId = ZSIR.SearchCatalogRuleId 
	WHERE ZSCR.PublishCatalogId = @PublishCatalogId AND ZSCR.IsGlobalRule = 1
		AND CAST(@GetDate AS DATE) BETWEEN CAST(ZSCR.StartDate AS DATE) AND ISNULL( ZSCR.EndDate,'9999-01-01') AND IsPause <> 1

	END TRY
	BEGIN CATCH
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetSearchTriggerItemRuleDetails @Keyword = '+@Keyword+' @PublishCatalogId = '+CAST(@PublishCatalogId AS VARCHAR(50));
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		   
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetSearchTriggerItemRuleDetails',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetWebStoreSearchProfileTrigger')
	DROP PROC Znode_GetWebStoreSearchProfileTrigger
GO

CREATE PROCEDURE [dbo].[Znode_GetWebStoreSearchProfileTrigger]
(
	@Keyword nvarchar(100) = '',
    @ProfileId int = '',
	@PublishCatalogId int,
	@PortalId int 
)
AS 
/*
	 Summary :- This Procedure is used to get the publish status of the catalog 
	 Unit Testig 
	 EXEC  [Znode_GetWebStoreSearchProfileTrigger] 'Apple','1',3,1
*/
BEGIN 
	BEGIN TRY 
	SET NOCOUNT ON 
		Declare @SearchProfileId int 

		--Select @SearchProfileId=d.SearchProfileId 
		--from [ZnodeSearchProfileTrigger] d
		--inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=d.SearchProfileId
		--Where d.Keyword=@Keyword
		--and d.ProfileId=@ProfileId
		--and c.PublishCatalogId=@PublishCatalogId

		--If isnull(@SearchProfileId,0)=0
		--Begin
		--Select @SearchProfileId=d.SearchProfileId 
		--from [ZnodeSearchProfileTrigger] d
		--inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=d.SearchProfileId
		--Where d.Keyword=@Keyword
		--and c.PublishCatalogId=@PublishCatalogId
		--and d.ProfileId is null
		--eND

		--If isnull(@SearchProfileId,0)=0
		--Begin
		--Select @SearchProfileId=d.SearchProfileId 
		--from [ZnodeSearchProfileTrigger] d
		--inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=d.SearchProfileId
		--Where d.ProfileId=@ProfileId
		--and c.PublishCatalogId=@PublishCatalogId
		--and d.Keyword is null
		--eND

		If isnull(@SearchProfileId,0)=0
		Begin
			Select @SearchProfileId=a.SearchProfileId 
			from ZnodePortalSearchProfile a
			inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=a.SearchProfileId
			Where a.PortalId =@PortalId 
				and a.IsDefault=1
				and c.PublishCatalogId=@PublishCatalogId
		End 

		--If isnull(@SearchProfileId,0)=0
		-- Begin
		--	Select @SearchProfileId=min(a.SearchProfileId)
		--	from ZnodePortalSearchProfile a
		--	inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=a.SearchProfileId
		--	Where a.PortalId =@PortalId 
		--	and a.IsDefault=0
		--	and c.PublishCatalogId=@PublishCatalogId
		--End 

		If isnull(@SearchProfileId,0)=0
			Begin
			Select @SearchProfileId=a.SearchProfileId
			from ZnodeSearchProfile a
			----inner join ZnodePublishCatalogSearchProfile c on c.SearchProfileId=a.SearchProfileId
			Where a.IsDefault=1
			--and c.PublishCatalogId=@PublishCatalogId
		End 

		If Isnull(@SearchProfileId,0)>0
		exec [dbo].[Znode_GetSearchProfileDetails] @SearchProfileId=@SearchProfileId

		----To get SearchRule Item Details
		exec [Znode_GetSearchTriggerItemRuleDetails] @Keyword = @Keyword, @PublishCatalogId = @PublishCatalogId

		END TRY 
		BEGIN CATCH 
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(), 
		@ErrorCall NVARCHAR(MAX)
		--= 'EXEC Znode_GetCatalogList @WhereClause = '+@WhereClause+',@Rows='+CAST(@Rows AS
		--VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;
		  
	EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetZnodeSearchProfileList',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.types WHERE is_table_type = 1 AND name = 'AssociatedSkus')
BEGIN
	CREATE TYPE [AssociatedSkus] AS TABLE
	(
		[Sku] [nvarchar](max) NULL
	)
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPimDownloadableProduct')
	DROP PROC Znode_GetPimDownloadableProduct
GO

CREATE PROCEDURE [dbo].[Znode_GetPimDownloadableProduct]
(
	@SKU [AssociatedSkus] READONLY
)
AS
BEGIN
	BEGIN TRY
		SELECT sku.Sku
		FROM ZnodePimDownloadableProduct As dwlproduct
		INNER JOIN @SKU AS sku ON dwlproduct.sku=sku.Sku
	END TRY
	BEGIN CATCH
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
		@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPimDownloadableProduct'
        
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetPimDownloadableProduct',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
 END

GO

update ZnodeGlobalAttribute set AttributeCode='LoginToSeePricingAndInventory',
HelpDescription='Enabling this will make it mandatory for customers to log in to their account, in order to see the Price and Stock information of products on the web-store.' 
where AttributeCode='LoginToSeePricing'

update ZnodeGlobalAttributeLocale set AttributeName='Login To See Pricing And Inventory'
where AttributeName='Login To See Pricing'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY

	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku VARCHAR(600), GroupIdentifier INT)
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT, GroupIdentifier INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);

	DECLARE @OrderLineItemRelationshipTypeIdConfig int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber NVARCHAR(max),TrackingNumber NVARCHAR(1000),CouponCode NVARCHAR(1000),
		PromoDescription NVARCHAR(max),ReferralUserId int,PurchaseOrderNumber NVARCHAR(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken NVARCHAR(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument NVARCHAR(600),IsActive bit,ExternalId NVARCHAR(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber VARCHAR(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId NVARCHAR(800),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),Custom5 NVARCHAR(MAX),FirstName NVARCHAR(200),LastName NVARCHAR(200),CardType VARCHAR(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost NUMERIC(28,6),PaymentDisplayName NVARCHAR(2000),PaymentExternalId NVARCHAR(2000),
		CultureCode VARCHAR(200),DisplayName NVARCHAR(2000),InHandDate datetime,IpAddress VARCHAR(100),JobName NVARCHAR(200),
		ShippingConstraintCode NVARCHAR(100),ShippingDiscount NUMERIC(28,6),ShippingHandlingCharges NUMERIC(28,6),ReturnCharges NUMERIC(28,6),
		IsCalculateTaxAfterDiscount bit,Email VARCHAR(50),PhoneNumber VARCHAR(50),OrderTotalWithoutVoucher NUMERIC(28,6),ImportDuty NUMERIC(28,6),
		TaxCost NUMERIC(28,6),ShippingCost NUMERIC(28,6), SubTotal NUMERIC(28,6),CurrencyCode VARCHAR(100),OverDueAmount NUMERIC(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int
	)

	CREATE TABLE #TempOrderBillingAddress
	(
		AddressId INT,BillingFirstName VARCHAR(300),BillingLastName VARCHAR(300),BillingCountry VARCHAR(3000),BillingStateCode VARCHAR(300),
		BillingPostalCode VARCHAR(50),BillingPhoneNumber VARCHAR(50),BillingEmailId VARCHAR(50),BillingStreet1 VARCHAR(300),BillingStreet2 VARCHAR(300),
		BillingCity VARCHAR(3000),BillingCompanyName NVARCHAR(1200)
	)
	
	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), GroupIdentifier INT
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku NVARCHAR(600), GroupIdentifier INT
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId NVARCHAR(max), GroupIdentifier INT
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId NVARCHAR(max),
		GroupIdentifier INT
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId NVARCHAR(max)
	)

	--------Getting Order details
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
		CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
		CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
		CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
		CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
		CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
		CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
		CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
		CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
		Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
		Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
		CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
		Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
		CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
		Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
		Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
		CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
		CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
		Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
		CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
		Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
		Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
		Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
		CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
		Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
		Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
		Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
		Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
		Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
		Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
		Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
		Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
		Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
		CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
		CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
		Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
		Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
		CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
		CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
		Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
		Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
		Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);


	--Getting billing address info
	INSERT INTO #TempOrderBillingAddress
	(
		AddressId,BillingFirstName,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,
		BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber,BillingEmailId
	)
	SELECT
		Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) AS AddressId,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CompanyName[1]', 'NVARCHAR(Max)' ) AS CompanyName,
		Tbl.Col.value( 'Street1[1]', 'NVARCHAR(Max)' ) AS Street1 ,
		Tbl.Col.value( 'Street2[1]', 'NVARCHAR(Max)' ) AS Street2,
		Tbl.Col.value( 'City[1]', 'NVARCHAR(Max)' ) AS City,
		Tbl.Col.value( 'StateCode[1]', 'NVARCHAR(Max)' ) AS StateCode,
		Tbl.Col.value( 'PostalCode[1]', 'NVARCHAR(Max)' ) AS PostalCode,
		Tbl.Col.value( 'Country[1]', 'NVARCHAR(Max)' ) AS Country,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		Tbl.Col.value( 'EmailId[1]', 'NVARCHAR(Max)' ) AS EmailId
	FROM @OrderXML.nodes( '//PlaceOrderModel/BillingAddressModel' ) AS Tbl(Col);
	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	--Updating parent for simple products
	UPDATE #TempChildLineItemDetails SET ParentSku = Sku WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

BEGIN TRAN OrderInsert

	--Inserting order number which are unique and getting in xml from code side
	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, CAST(0 AS BIT)
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	--If order is new then creating new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,OBA.BillingCompanyName,
			OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry,OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,
			OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
			,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
			,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId

	END
	--If order managed then creating new order details and disable old order details
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM  #TempOrderData OD WHERE OOD.OmsOrderId = OD.OmsOrderId) AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName --1
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry --2
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total --3
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId --4
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive --5
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited --6
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName --7
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName, --8
			PaymentExternalId,CultureCode, --9
			DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges --10
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty --11 
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,--1
			OBA.BillingCompanyName,OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry, --2
			OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total, --3
			OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId, --4
			OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive --5
			,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited, --6
			OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName, --7
			OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName, --8
			CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode, --9 
			OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges, --10
			OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty --11
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId
	
		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'CANCELED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	----Geting new OmsOrderDetailsId always
	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order notes only for new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
			@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId,INSERTED.GroupIdentifier INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description--1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, --5
		ParentSku, GroupIdentifier --6
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku, INSERTED.GroupIdentifier INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,PLID.ProductName,PLID.Description, --1
		PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber, --2
		PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,--3
		PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy, --4
		PLID.ModifiedDate,PLID.AutoAddonSKU,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,PLID.GroupId,PLID.BundleQuantity, --5
		case when PLID.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple then PLID.Sku else PLID.ParentSku end AS ParentSku, GroupIdentifier --6
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items for simple, group and configurable products
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.GroupIdentifier = a.GroupIdentifier AND A.ParentSku = D.Sku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	FROM @OmsOrderLineItems a
	WHERE a.OrderLineItemRelationshipTypeId NOT IN ( @OrderLineItemRelationshipTypeIdAddon, @OrderLineItemRelationshipTypeIdGroup)  
	AND a.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for child line items for group products
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup)
	BEGIN
		---Getting child lineitems for group product
		;WITH Cte_GroupProductChild AS
		(
			SELECT GroupIdentifier,Sku, ParentSku, OmsOrderLineItemsId, ParentOmsOrderLineItemsId,Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsOrderLineItems
			WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup
		)
		---Getting parent lineitems for group product
		,Cte_GroupProductParent AS 
		(
			SELECT GroupIdentifier,Sku, OmsOrderLineItemsId, Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsParentOrderLineItems a
			WHERE OrderLineItemRelationshipTypeId IS NULL
			AND EXISTS(SELECT * FROM @OmsOrderLineItems b WHERE a.GroupIdentifier = b.GroupIdentifier AND a.Sku = b.ParentSku)
		)
		--Updating ParentOmsOrderLineItemsId on child for group products
		UPDATE a SET a.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM Cte_GroupProductChild a
		INNER JOIN Cte_GroupProductParent B ON A.GroupIdentifier = B.GroupIdentifier AND a.RowId1 = b.RowId1 AND b.Sku = a.ParentSku 
	END

	---Updating ParentOmsOrderLineItemsId for addons if present
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	BEGIN
		--Updating ParentOmsOrderLineItemsId for addon with Simple products , group products and configurable products
		UPDATE b SET b.ParentOmsOrderLineItemsId = c.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsOrderLineItems b on b.ParentSku = c.Sku AND c.GroupIdentifier = b.GroupIdentifier
		WHERE c.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon and c.OrderLineItemRelationshipTypeId is not null
		and b.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND b.ParentOmsOrderLineItemsId IS NULL
		
		--Updating ParentOmsOrderLineItemsId for addon with bundle products
		UPDATE c SET c.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsParentOrderLineItems b on B.sku = C.parentsku AND c.GroupIdentifier= b.GroupIdentifier
		WHERE B.OrderLineItemRelationshipTypeId is null 
		AND c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND C.ParentOmsOrderLineItemsId IS NULL
	 END
	 ---Updating ParentOmsOrderLineItemsId in main table
	 UPDATE a SET a.ParentOmsOrderLineItemsId = b.ParentOmsOrderLineItemsId
	 FROM  ZnodeOmsOrderLineItems a
	 INNER JOIN @OmsOrderLineItems b on a.OmsOrderLineItemsId = b.OmsOrderLineItemsId

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	IF (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
		SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
		FROM #TempOrderData OD
	END

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsParentOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes FROM xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId, GroupIdentifier )
	SELECT
		Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
		Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/OrderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'') AND OA.GroupIdentifier = POLI.GroupIdentifier
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId, GroupIdentifier)
	SELECT
		Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
		Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
		Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsParentOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'') AND OPI.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId 
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
		Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		@UserId,@GetDate,@UserId,@GetDate,
		CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
		CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
		CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
		Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
		CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
		Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
		Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	--Inserting product level discount for simple and group products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
		OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
		OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'') 
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdSimple , @OrderLineItemRelationshipTypeIdGroup)
	
	--Inserting product level discount for config and bundle products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.ParentOmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.ParentSku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdBundles , @OrderLineItemRelationshipTypeIdConfig)
	
	--Inserting order level discount 
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,NULL,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	WHERE isnull(OD.Sku,'') = ''
	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
		CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'') 
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end
	
	DECLARE @OmsOrderId INT
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM @OMSOrder)
	END
	ELSE
	BEGIN 
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
	END
	----RMA details start
	IF (SELECT TOP 1 OmsOrderId FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId AS NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	
		UPDATE ZnodeOmsOrder set IsOldOrder = 0
		where OmsOrderId = @OmsOrderID
	END
	----RMA details end
	
	---Inserting OrderTaxDetails
	IF(NOT EXISTS(SELECT 1 from ZnodeOmsTaxRule where OmsOrderId= @OmsOrderId)) AND (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		DECLARE @TaxRate Numeric(28,6), @TaxRuleId INT
		SET @TaxRate = (SELECT TOP 1 TaxRate FROM #TempOrderData)
		SET @TaxRuleId = (SELECT TOP 1 TaxRuleId FROM #TempChildLineItemDetails)

		 EXEC [Znode_InsertOrderTaxDetails] @OmsOrderId = @OmsOrderId, @TaxRuleId = @TaxRuleId, @TaxRate = @TaxRate, @Status = 0
	END

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 AS bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 AS OmsOrderId,0 AS OmsOrderDetailsId, cast(0 AS bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, isnull(PaymentTransactionToken,''),Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records FROM order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO

Update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>ShippingId</name>      <headertext>Checkbox</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>ShippingTypeName</name>      <headertext>Shipping Type</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>ShippingCode</name>      <headertext>Shipping Code</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>ShippingName</name>      <headertext>Shipping Name</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>Description</name>      <headertext>Display Name</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>DisplayOrder</name>      <headertext>Display Order</headertext>      <width>30</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>3</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>y</iscontrol>      <controltype>Text</controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>DestinationCountryCode</name>      <headertext>Country Code</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>HandlingCharge</name>      <headertext>Handling Charge</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>IsActive</name>      <headertext>Enable</headertext>      <width>40</width>      <datatype>Boolean</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>10</id>      <name>ZipCode</name>      <headertext>Zip Code</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>11</id>      <name>PublishState</name>      <headertext>Application Type</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>y</iscontrol>      <controltype>DropDown</controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>12</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>PortalId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Profiles/UpdateProfileShipping|/Profiles/UnAssociateAssociatedShipping</manageactionurl>      <manageparamfield>shippingId,profileId|shippingId,profileId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>13</id>      <name>ProfileName</name>      <headertext>Profile Name</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>14</id>      <name>ShippingId</name>      <headertext>ShippingId</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeAssociatedShippingListToProfile'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsers')
	DROP PROC Znode_AdminUsers
GO

CREATE PROCEDURE [dbo].[Znode_AdminUsers]
(	@RoleName		VARCHAR(200),
    @UserName		VARCHAR(200),
    @WhereClause	XML,
    @Rows			INT           = 100,
    @PageNo			INT           = 1,
    @Order_By		VARCHAR(1000) = '',
    @RowCount		INT        = 0 OUT,
	@IsCallOnSite   BIT = 0 ,
	@PortalId		VARCHAR(1000) = 0,
	@IsGuestUser    BIT = 0,
	@ColumnName     dbo.SelectColumnList ReadOnly,
	@SalesRepUserId int = 0
)
AS
/* 
    Summary: List of users with details and shows link with ASPNet tables 
    This procedure is used for finding both users and admin users 
    here use three view "View_RoleUsers" for check  @UserName is present or not 
    "View_AdminUserDetail"  this view use for admin users 
    "View_CustomerUserDetail" Use for customer users 
    Unit Testing   
	SELECT * FROM ZnodeUser 
    DECLARE @EDE INT=0  EXEC Znode_AdminUsers '','admin@znode.com',@WhereClause='',@Order_By='',@PageNo= 1 ,@Rows= 214,@IsCallOnSite='false',@PortalId=0,@RowCount=@EDE OUT  SELECT @EDE
*/
BEGIN
    BEGIN TRY
    SET NOCOUNT ON;
			
    DECLARE @SQL NVARCHAR(MAX)= '', @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId');
           
	----Verifying that the @SalesRepUserId is having 'Sales Rep' role
	IF NOT EXISTS
	(
		SELECT * FROM ZnodeUser ZU
		INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
		INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
		INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
		Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
		AND ZU.UserId = @SalesRepUserId
	)   
	Begin
		SET @SalesRepUserId = 0
	End

	if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
		drop table ##CustomerUserAddDetail

	if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
		drop table ##View_CustomerUserAddDetail

	IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
		DROP TABLE #TBL_RowCount
	Create table #TBL_RowCount(RowsCount int )
	-----Split where clause XMl 
	CREATE TABLE #WhereColumnList(RowId Int identity, filterName varchar(max), WhereCondition varchar(max))
	insert into #WhereColumnList(filterName,WhereCondition)
	SELECT 
			Tbl.Col.value('key[1]', 'varchar(max)') as filterName,
			Tbl.Col.value('condition[1]', 'varchar(max)') WhereCondition
	FROM   @WhereClause.nodes('//filter') Tbl(Col) 
	----Address column in global search
	declare @AddressGlobalSearch varchar(1000) =''
	declare @GlobalSearch varchar(100) = ''
			
	select @GlobalSearch = substring(WhereCondition,charindex(' like ',WhereCondition), charindex(' OR ',WhereCondition)-charindex(' like ',WhereCondition)) 
	from #WhereColumnList
	where filtername like '%|%'
	and filtername <> ''
	and filterName in ('CityName','CountryName','PostalCode','StateName','CompanyName') 

			

	if isnull(@GlobalSearch,'') <> ''
	begin
		select @AddressGlobalSearch = '('+'CityName '+ @GlobalSearch+' OR '+'CountryName '+ @GlobalSearch+' OR '+'PostalCode '+ @GlobalSearch+' OR '+'StateName '+ @GlobalSearch+' OR '+'CompanyName '+ @GlobalSearch+')'
	end
	else
	begin
		SET @AddressGlobalSearch = ''
	end
	----Global search where clause
	declare @WhereClauseGlobal varchar(1000)=''
	select @WhereClauseGlobal = ISNULL(WhereCondition,'')
	from #WhereColumnList
	where filtername like '%|%'
	and filtername <> ''
			
	----Where clause columns except Address columns
	declare @WhereClause1 varchar(max) = ''
	select @WhereClause1 = COALESCE(@WhereClause1 + '', '') + WhereCondition+' And '
	--case when @WhereClause1 <> ''  then ' And ' else '' end
	from #WhereColumnList a
	where filterName not like '%|%' and
	filterName not in ('CountryName','CityName','StateName','PostalCode','CompanyName')
	and filtername <> ''

	if @WhereClause1 <> ''
	begin
		set @WhereClause1=isnull(substring(@WhereClause1,1,len(@WhereClause1)-3),'')
	end
	else
	begin
		set @WhereClause1 = ''
	end

	----Where clause columns
	declare @AddressColumnWhereClause varchar(max) 
	select @AddressColumnWhereClause = COALESCE(@AddressColumnWhereClause + '', '') + WhereCondition+' And '
	from #WhereColumnList a
	where filterName not like '%|%' and
	filterName in ('CountryName','CityName','StateName','PostalCode','CompanyName')
	and filtername <> ''
			
	if isnull(@AddressColumnWhereClause,'') <> ''
	begin
		set @AddressColumnWhereClause=isnull(substring(@AddressColumnWhereClause,1,len(@AddressColumnWhereClause)-3),'')
    end
	else
	begin
		set @AddressColumnWhereClause = ''
	end

	declare @WhereClauseAll varchar(max) = ''
	select @WhereClauseAll = COALESCE(@WhereClauseAll + '', '') + WhereCondition+' And '
	from #WhereColumnList a
			

	set @WhereClauseAll=isnull(CASE WHEN @WhereClauseAll = '' THEN '' ELSE substring(@WhereClauseAll,1,len(@WhereClauseAll)-3) END ,'')
	-------------- 
			
	IF @PortalId  <> '0' 
	BEGIN 
		SET @WhereClauseAll = CASE WHEN  @WhereClauseAll = '' THEN ' (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClauseAll+' AND (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' END 

		SET @WhereClause1 = CASE WHEN  @WhereClause1 = '' THEN ' (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClause1+' AND (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' END 
			
	END 

	IF EXISTS ( SELECT TOP 1 1 FROM View_RoleUsers  WHERE Username = @UserName   )  AND @RoleName <> ''  
	-- this check for admin user
    BEGIN
		SET @SQL = ' SELECT  A.UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,A.CreatedBy,A.CreatedDate,A.ModifiedBy,A.ModifiedDate
		,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
		,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
		INTO #Cte_AdminUserDetail
		FROM View_AdminUserDetail A
		'+CASE WHEN @PortalId  <> '0' THEN ' INNER JOIN ZnodeUserPortal ZUP ON (ZUP.UserId = A.UserId) 'ELSE '' END  +'	 
		'+dbo.Fn_GetWhereClause(@WhereClauseAll, ' WHERE ')+'
				
		;with Cte_AdminUserDetailRowId AS 
		(
		SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
		,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RANK()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowId
		FROM  #Cte_AdminUserDetail a
		where (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
		)
					 
		SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
		,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RowId 
		INTO #AccountDetails
		FROM Cte_AdminUserDetailRowId 
					 
		SET @Count= ISNULL((SELECT  Count(1) FROM #AccountDetails ),0)
					 
		SELECT DISTINCT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
		,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
		FROM #AccountDetails '+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC' );
		EXEC SP_executesql
		@SQL,
		N'@Count INT OUT',
		@Count = @RowCount OUT;

				
	END;
	-- For Customer user
    ELSE   
	BEGIN
		IF @roleName = ''
		BEGIN
			if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
			drop table ##CustomerUserAddDetail

			if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
			drop table ##View_CustomerUserAddDetail
				
			if OBJECT_ID('tempdb..##UserList') is not null
			drop table ##UserList

			CREATE TABLE ##UserList(UserId int,AddressID int)

			declare @UserList varchar(1000)=''

			------To get the list of user having adress column in global search
			if (@AddressGlobalSearch <> '')
			begin
				
			set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressGlobalSearch
			--print @UserList
			insert into ##UserList(UserId, b.AddressID)
			exec (@UserList)
			
			end
			----To get the list of user having adress column in where clause 
			if (@AddressColumnWhereClause <> '')
			begin
					
			set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressColumnWhereClause
			--print @UserList
			insert into ##UserList(UserId,AddressID)
			exec (@UserList)
					
			end

			If @IsGuestUser= 0 
			AND
			NOT Exists (Select filterName from #WhereColumnList where filterName in ('accountid','isaccountcustomer','UserId') and filtername <> '')
			-- Customer List with GuestUsers
			Begin
				SET @SQL = 
					'SELECT a.userId,a.AspNetuserId,a.UserName,a.FirstName,a.MiddleName,a.LastName
					,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATE, a.ModifiedDate) ModifiedDate, 0 RoleId,''''  RoleName,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = ''''	THEN ''''
						ELSE '' ''	END+ISNULL(RTRIM(LTRIM(a.LastName)), ''''))  FullName
						,a.AccountId, '''' TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser
						into ##View_CustomerUserAddDetail
						FROM ZnodeUser a
						Where a.AspNetUserId IS NOT NULL
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
					' 
				EXEC (@SQL)
			End	
			Else If @IsGuestUser= 1 
			Begin
					SET @SQL='SELECT a.userId,a.AspNetuserId,a.UserName,a.FirstName,a.MiddleName,a.LastName
					,a.PhoneNumber,
					a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
					CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
					(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
					WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
					a.AccountId,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser
					into ##View_CustomerUserAddDetail
					FROM ZnodeUser a
					LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
					LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
					LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
					AND a.AspNetuserId is null
					AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)'
				EXEC (@SQL)
			End
			Else IF Exists (Select filterName from #WhereColumnList where filterName in ('UserId') and filtername <> '')
			and  @IsGuestUser= 0   
			-- Customer List for user edit single user 
			Begin
			SET @SQL='SELECT a.userId,a.AspNetuserId,a.UserName,a.FirstName,a.MiddleName,a.LastName
			,a.PhoneNumber, a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
					CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
					(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
					WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
					a.AccountId, r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser
					into ##View_CustomerUserAddDetail
					FROM ZnodeUser a
					LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
					LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
					LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
					LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
					AND a.AspNetuserId is not null
					and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)'
				print @SQL
						
				EXEC (@SQL)
			End	
			Else -- Account user List 
			Begin
					SELECT a.userId,a.AspNetuserId,a.UserName,a.PhoneNumber,a.FirstName,a.MiddleName,a.LastName
					,a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
					CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
					(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')+CASE
					WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = '' THEN '' ELSE ' ' END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName,
					a.AccountId, r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser
					into ##View_CustomerUserAddDetail
					FROM ZnodeUser a
					LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
					LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
					LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
					LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
					WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
					and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and a.UserId = SalRep.CustomerUserid ) or @SalesRepUserId = 0)
			End
					
			alter table ##View_CustomerUserAddDetail 
			add StoreName varchar(1000), CountryName varchar(1000),CityName varchar(1000),StateName varchar(1000),
			PostalCode varchar(1000), CompanyName varchar(1000), SalesRepUserName varchar(600),SalesRepFullName varchar(1000), PortalId INT 

			IF @PortalId <> '' 
			BEGIN 
				UPDATE a SET a.PortalId = b.PortalId
				FROM ##View_CustomerUserAddDetail a 
				INNER JOIN ZnodeUserPortal b ON (b.Userid = a.Userid )
			END 

			IF (@WhereClauseAll like '%StoreName%' or @Order_By like '%StoreName%' )
			BEGIN
				CREATE NONCLUSTERED INDEX ##View_CustomerUserAddDetail_UserId
				ON [dbo].[##View_CustomerUserAddDetail] ([userId])

				update  a set StoreName = CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END 
						        -- , PortalId = up.PortalId
				from ##View_CustomerUserAddDetail a
				Left join  ZnodeUserPortal up ON(up.UserId = a.UserId)  
				Left JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							
			END
					
			IF (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%')
			BEGIN
			 
				update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
				PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
				from ##View_CustomerUserAddDetail a
				inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
				inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
				where isnull(a.AccountId,0)<> 0-- is not null
	 
				update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
				PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
				from ##View_CustomerUserAddDetail a
				inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
				inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
			END

			set @Rows = @PageNo * @Rows

			SET @SQL = '			
						
				create table #AccountDetail
				(
					UserId int,AspNetuserId nvarchar(200),UserName nvarchar(200),FirstName varchar(200),MiddleName varchar(200),LastName varchar(200),
					PhoneNumber nvarchar(100),Email nvarchar(100),EmailOptIn bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,
					RoleId varchar(200),RoleName varchar(200), FullName  varchar(1000),
					StoreName varchar(200),CountryName varchar(200), CityName varchar(200), StateName varchar(200), PostalCode varchar(200), CompanyName varchar(200)
					,AccountId int,SalesRepUserName varchar(200),SalesRepFullName varchar(200) ,RowId int identity 
				) 
				'+
				+' insert into #AccountDetail(UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,FullName,
				StoreName, CountryName, CityName, StateName, PostalCode, CompanyName,AccountId)
				SELECT top '+cast(@Rows as varchar(10))+'UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,FullName,
				StoreName, CountryName, CityName, StateName, PostalCode, CompanyName,AccountId
				FROM ##View_CustomerUserAddDetail where 1=1'+
				dbo.Fn_GetWhereClause(case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then @WhereClauseGlobal+' And '+@WhereClause1 else @WhereClauseAll end, ' AND ')+
				dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC') + '
			
				Insert Into #TBL_RowCount 
				SELECT count(*)
				FROM ##View_CustomerUserAddDetail where 1=1'+
				dbo.Fn_GetWhereClause(case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then @WhereClauseGlobal+' And '+@WhereClause1 else @WhereClauseAll end, ' AND ')
				+'
						
				SELECT  UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,FullName,
				StoreName,AccountId,
				CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName
				,Row_Number()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+')  RowNumber
				into ##CustomerUserAddDetail
				FROM #AccountDetail '+@PaginationWhereClause  +' '+ dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC');

				print @SQL
			EXEC (@SQL)

			Select @RowCount= isnull(RowsCount,0) from #TBL_RowCount

			ALTER TABLE ##CustomerUserAddDetail ADD AddressId Int

			------To get data for StoreName
			update  a 
			set StoreName = CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END 
			from ##CustomerUserAddDetail a
			Left join  ZnodeUserPortal up ON(up.UserId = a.UserId)  
			Left JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
	
			----To get data for CountryName, CityName, StateName, PostalCode, CompanyName
			IF (EXISTS(SELECT * FROM @ColumnName where ([StringColumn] LIKE '%CountryName%' OR [StringColumn] LIKE '%CityName%' OR [StringColumn] LIKE '%StateName%' OR [StringColumn] LIKE '%PostalCode%' OR [StringColumn] LIKE '%CompanyName%'))
			OR (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%'))
			BEGIN
				update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
				PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
				from ##CustomerUserAddDetail a
				inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
				inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
				where isnull(a.AccountId,0)<> 0-- is not null
	 
				update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
				PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
				from ##CustomerUserAddDetail a
				inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
				inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
			END
	
			----Updating SalesRep for user if any 
			update CUAD
			set CUAD.SalesRepUserName = ZU.UserName, 
			CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
			+CASE
			WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
			THEN ''
			ELSE ' '
			END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
			from ##CustomerUserAddDetail CUAD
			inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
			inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId

			if ( exists(select * from ##UserList) OR @AddressColumnWhereClause <> '')
			begin
				SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,
				FullName,
				StoreName,
				CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName
				from ##CustomerUserAddDetail CUAD
				where exists(select * from ##UserList UL where CUAD.UserId = UL.UserId and CUAD.AddressId = UL.AddressID )
				Order by RowNumber
			end
			else
			begin
				SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
				EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,
				FullName,
				StoreName,
				CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName
				from ##CustomerUserAddDetail
				Order by RowNumber
			end
	
			if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
			drop table ##CustomerUserAddDetail

			if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
			drop table ##View_CustomerUserAddDetail
				
		END;
		ELSE
		BEGIN
			SELECT * FROM View_CustomerUserDetail AS VICUD WHERE 1 = 0;
			SET @RowCount = 0;
		END;
    END;			
    END TRY
    BEGIN CATCH
		--SELECT ERROR_MESSAGE()
		DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsers @RoleName = '+@RoleName+' ,@UserName='+@UserName+',@WhereClause='+cast(@WhereClause as varchar(max))+' ,@Rows= '+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_By='+@Order_By+',@RowCount='+CAST(@RowCount AS VARCHAR(50));
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName    = 'Znode_AdminUsers',
		@ErrorInProcedure = @ERROR_PROCEDURE,
		@ErrorMessage     = @ErrorMessage,
		@ErrorLine        = @ErrorLine,
		@ErrorCall        = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_AdminUsersByUserId')
	DROP PROC Znode_AdminUsersByUserId
GO

CREATE PROCEDURE [dbo].[Znode_AdminUsersByUserId]
(	
	@RoleName		VARCHAR(200),
    @UserName		VARCHAR(200),
    @WhereClause	XML,
    @Rows			INT           = 100,
    @PageNo			INT           = 1,
    @Order_By		VARCHAR(1000) = '',
    @RowCount		INT        = 0 OUT,
	@IsCallOnSite   BIT = 0 ,
	@PortalId		VARCHAR(1000) = 0,
	@IsGuestUser    BIT = 0,
	@ColumnName     dbo.SelectColumnList ReadOnly,
	@SalesRepUserId Int = 0,
	@IsSalesRepList Bit = 0
)
AS
/* 
    Summary: List of users with details and shows link with ASPNet tables 
    This procedure is used for finding both users and admin users 
    here use three view "View_RoleUsers" for check  @UserName is present or not 
    "View_AdminUserDetail"  this view use for admin users 
    "View_CustomerUserDetail" Use for customer users 
    Unit Testing   
	SELECT * FROM ZnodeUser 
    DECLARE @EDE INT=0  EXEC Znode_AdminUsersByUserId '','admin@znode.com',@WhereClause='',@Order_By='',@PageNo= 1 ,@Rows= 214,@IsCallOnSite='false',@PortalId=0,@RowCount=@EDE OUT  SELECT @EDE
*/
BEGIN
    BEGIN TRY
    SET NOCOUNT ON;
			
		DECLARE @SQL NVARCHAR(MAX)= '', @PaginationWhereClause VARCHAR(300)= dbo.Fn_GetRowsForPagination(@PageNo, @Rows, ' WHERE RowId');
             
		----Verifying that the @SalesRepUserId is having 'Sales Rep' role
		IF NOT EXISTS
		(
			SELECT * FROM ZnodeUser ZU
			INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
			INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
			INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
			Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
			AND ZU.UserId = @SalesRepUserId
		)   
		Begin
			SET @SalesRepUserId = 0
		End

		IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
			DROP TABLE #TBL_RowCount
		Create table #TBL_RowCount(RowsCount int )
		-----Split where clause XMl 
		CREATE TABLE #WhereColumnList(RowId Int identity, filterName varchar(max), WhereCondition varchar(max))
		insert into #WhereColumnList(filterName,WhereCondition)
		SELECT 
				Tbl.Col.value('key[1]', 'varchar(max)') as filterName,
				Tbl.Col.value('condition[1]', 'varchar(max)') WhereCondition
		FROM   @WhereClause.nodes('//filter') Tbl(Col) 
		----Address column in global search
		declare @AddressGlobalSearch varchar(1000)
		declare @GlobalSearch varchar(100)
		select @GlobalSearch = substring(WhereCondition,charindex(' like ',WhereCondition), charindex(' OR ',WhereCondition)-charindex(' like ',WhereCondition)) 
		from #WhereColumnList
		where filtername like '%|%'
		and filtername <> ''
		and filterName in ('CityName','CountryName','PostalCode','StateName','CompanyName') 

		if isnull(@GlobalSearch,'') <> ''
		begin
			select @AddressGlobalSearch = '('+'CityName '+ @GlobalSearch+' OR '+'CountryName '+ @GlobalSearch+' OR '+'PostalCode '+ @GlobalSearch+' OR '+'StateName '+ @GlobalSearch+' OR '+'CompanyName '+ @GlobalSearch+')'
		end
		else
		begin
			SET @AddressGlobalSearch = ''
		end
		----Global search where clause
		declare @WhereClauseGlobal varchar(1000)=''
		select @WhereClauseGlobal = ISNULL(WhereCondition,'')
		from #WhereColumnList
		where filtername like '%|%'
		and filtername <> ''
			
		----Where clause columns except Address columns
		declare @WhereClause1 varchar(max) 
		select @WhereClause1 = COALESCE(@WhereClause1 + '', '') + WhereCondition+' And '
		--case when @WhereClause1 <> ''  then ' And ' else '' end
		from #WhereColumnList a
		where filterName not like '%|%' and
		filterName not in ('CountryName','CityName','StateName','PostalCode','CompanyName')
		and filtername <> ''

		if @WhereClause1 <> ''
		begin
			set @WhereClause1=isnull(substring(@WhereClause1,1,len(@WhereClause1)-3),'')
		end
		else
		begin
			set @WhereClause1 = ''
		end

		----Where clause columns
		declare @AddressColumnWhereClause varchar(max) 
		select @AddressColumnWhereClause = COALESCE(@AddressColumnWhereClause + '', '') + WhereCondition+' And '
		from #WhereColumnList a
		where filterName not like '%|%' and
		filterName in ('CountryName','CityName','StateName','PostalCode','CompanyName')
		and filtername <> ''
			
		if isnull(@AddressColumnWhereClause,'') <> ''
		begin
			set @AddressColumnWhereClause=isnull(substring(@AddressColumnWhereClause,1,len(@AddressColumnWhereClause)-3),'')
		end
		else
		begin
			set @AddressColumnWhereClause = ''
		end

		declare @WhereClauseAll varchar(max)
		select @WhereClauseAll = COALESCE(@WhereClauseAll + '', '') + WhereCondition+' And '
		from #WhereColumnList a

		set @WhereClauseAll=isnull(substring(@WhereClauseAll,1,len(@WhereClauseAll)-3),'')
		-------------- 

		IF @PortalId  <> '0' 
		BEGIN 
			IF @IsSalesRepList IN (1, 'True')
			BEGIN
				SELECT @PortalId = STUFF((SELECT CONCAT(', ', ISNULL(ZUP2.PortalId,@PortalId))
					FROM dbo.ZnodeUserPortal ZUP2 WITH (NOLOCK)
					WHERE ZUP1.UserId = ZUP2.UserId
					FOR XML PATH ('')), 1, 2, '')
				FROM dbo.ZnodeUserPortal ZUP1 WITH (NOLOCK)
				WHERE ZUP1.UserId=(SELECT TOP 1 UserId FROM ZnodeUser WITH (NOLOCK) WHERE UserName=@UserName)
				GROUP BY ZUP1.UserId;
			END

			SET @WhereClauseAll = CASE WHEN  @WhereClauseAll = '' THEN ' (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClauseAll+' AND (PortalId IN ('+@PortalId+') OR PortalId IS NULL) ' END 

			SET @WhereClause1 = CASE WHEN  @WhereClause1 = '' THEN ' (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' ELSE @WhereClause1+' AND (isnull(PortalId,0) IN ('+@PortalId+') OR PortalId IS NULL) ' END 
			
		END 
		IF EXISTS ( SELECT TOP 1 1 FROM View_RoleUsers  WHERE Username = @UserName   )  AND @RoleName <> ''  
		-- this check for admin user
		BEGIN
			SET @SQL = ' SELECT  A.UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,A.CreatedBy,A.CreatedDate,A.ModifiedBy,A.ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
			INTO #Cte_AdminUserDetail
			FROM View_AdminUserDetail A
			'+CASE WHEN @PortalId  <> '0' THEN ' INNER JOIN ZnodeUserPortal ZUP ON (ZUP.UserId = A.UserId) 'ELSE '' END  +'	 
			'+dbo.Fn_GetWhereClause(@WhereClauseAll, ' WHERE ')+'
				
			;with Cte_AdminUserDetailRowId AS 
			(
			SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RANK()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+',UserId DESC) RowId
			FROM  #Cte_AdminUserDetail a
			where (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
			)
					 
			SELECT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId,CustomerPaymentGUID ,RowId 
			INTO #AccountDetails
			FROM Cte_AdminUserDetailRowId 
					 
			SET @Count= ISNULL((SELECT  Count(1) FROM #AccountDetails ),0)
					 
			SELECT DISTINCT UserId,AspNetUserId,UserName,FirstName,MiddleName,LastName,Email,EmailOptIn,BudgetAmount,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
			,RoleId,RoleName,IsActive,IsLock,FullName,AccountName,PermissionsName,PermissionCode,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId,PhoneNumber
			,ExternalId,ApprovalName,ApprovalUserId,AccountUserOrderApprovalId ,CustomerPaymentGUID
			FROM #AccountDetails '+@PaginationWhereClause+' '+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC' );
			EXEC SP_executesql
			@SQL,
			N'@Count INT OUT',
			@Count = @RowCount OUT;
		END;
		-- For Customer user
		ELSE   
		BEGIN
			IF @roleName = ''
			BEGIN
				if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
				drop table ##CustomerUserAddDetail

				if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
				drop table ##View_CustomerUserAddDetail
				
				if OBJECT_ID('tempdb..##UserList') is not null
				drop table ##UserList

				CREATE TABLE ##UserList(UserId int,AddressID int)

				declare @UserList varchar(1000)=''

				------To get the list of user having adress column in global search
				if (@AddressGlobalSearch <> '')
				begin
				
				set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressGlobalSearch
				--print @UserList
				insert into ##UserList(UserId, b.AddressID)
				exec (@UserList)
			
				end
				----To get the list of user having adress column in where clause 
				if (@AddressColumnWhereClause <> '')
				begin
					
				set @UserList = 'select a.UserId, b.AddressID	from ZnodeUserAddress a	inner join ZnodeAddress b on a.AddressId = b.AddressId	where '+@AddressColumnWhereClause
				--print @UserList
				insert into ##UserList(UserId,AddressID)
				exec (@UserList)
					
				end

				If @IsGuestUser= 0 
				AND
				NOT Exists (Select filterName from #WhereColumnList where filterName in ('accountid','isaccountcustomer','UserId') and filtername <> '')
				-- Customer List with GuestUsers
				Begin
					SET @SQL = 
						'SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
							a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
							CONVERT( DATE, a.ModifiedDate) ModifiedDate, 0 RoleId,
							CASE WHEN A.AccountId IS NULL THEN '''' ELSE r.name END as RoleName,
							CASE	WHEN B.LockoutEndDateUtc IS NULL
							THEN CAST(1 AS    BIT)	ELSE CAST(0 AS BIT)
							END IsActive,	CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
				
							(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
							WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = ''''	THEN ''''
							ELSE '' ''	END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) 
				
							FullName,
							e.Name AccountName
							,a.AccountId,a.ExternalId,	CASE	WHEN a.AccountId IS NULL THEN 0	ELSE 1	END IsAccountCustomer,
							a.BudgetAmount,
							'''' TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
							--,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
							,ISnull(zp.StoreName , ''ALL'')StoreName,
							up.PortalId as PortalId, e.AccountCode
							into ##View_CustomerUserAddDetail
							FROM ZnodeUser a
							INNER JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
							INNER JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
							LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
							LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
							LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
							LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
							LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)
							WHERE (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						' 
					EXEC (@SQL)
				End	
				Else If @IsGuestUser= 1 
				Begin
						SET @SQL='SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
						into ##View_CustomerUserAddDetail
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND a.AspNetuserId is null
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						'
					EXEC (@SQL)
				End
				Else IF Exists (Select filterName from #WhereColumnList where filterName in ('UserId') and filtername <> '')
				and  @IsGuestUser= 0   
				-- Customer List for user edit single user 
				Begin
				SET @SQL='SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '''')+'' ''+ISNULL(RTRIM(LTRIM(a.MiddleName)), '''')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '''') = '''' THEN '''' ELSE '' '' END+ISNULL(RTRIM(LTRIM(a.LastName)), '''')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN ''ALL'' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId,e.AccountCode
						into ##View_CustomerUserAddDetail
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and a.UserId = SalRep.CustomerUserid ) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
						'
					EXEC (@SQL)
				End	
				Else -- Account user List 
				Begin
						SELECT a.userId,a.AspNetuserId,azu.UserName,a.FirstName,a.MiddleName,a.LastName,a.PhoneNumber,
						a.Email,a.EmailOptIn,a.CreatedBy,CONVERT( DATE, a.CreatedDate) CreatedDate,A.ModifiedBy,
						CONVERT( DATE, a.ModifiedDate) ModifiedDate,ur.RoleId,r.Name RoleName,
						CASE WHEN B.LockoutEndDateUtc IS NULL THEN CAST(1 AS    BIT) ELSE CAST(0 AS BIT) END IsActive,
						CAST(CASE WHEN ISNULL(LockoutEndDateUtc, 0) = 0 THEN  0 ELSE  1 END  AS    BIT) AS IsLock,
						(ISNULL(RTRIM(LTRIM(a.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(a.MiddleName)), '')+CASE
						WHEN ISNULL(RTRIM(LTRIM(a.MiddleName)), '') = '' THEN '' ELSE ' ' END+ISNULL(RTRIM(LTRIM(a.LastName)), '')) FullName,
						e.Name AccountName,a.AccountId,a.ExternalId,
						CASE WHEN a.AccountId IS NULL THEN 0 ELSE 1	END IsAccountCustomer,
						a.BudgetAmount,r.TypeOfRole,CASE WHEN a.AspNetuserId IS NULL THEN 1 ELSE 0 END IsGuestUser,a.CustomerPaymentGUID
						,CASE WHEN zp.StoreName IS NULL THEN 'ALL' ELSE zp.StoreName END StoreName,
						CASE WHEN a.AccountId IS NULL THEN up.PortalId ELSE ZPA.PortalId END as PortalId, e.AccountCode
						into ##View_CustomerUserAddDetail
						FROM ZnodeUser a
						LEFT JOIN ASPNetUsers B ON(a.AspNetuserId = b.Id)
						LEFT JOIN ZnodeAccount e ON(e.AccountId = a.AccountId)
						LEFT JOIN AspNetUserRoles ur ON(ur.UserId = a.AspNetUserId)
						LEFT JOIN AspNetRoles r ON(r.Id = ur.RoleId)                       
						LEFT JOIN AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = b.UserName)
						LEFT JOIN ZnodeUserPortal up ON(up.UserId = a.UserId)  
						LEFT JOIN ZnodePortal zp ON (up.PortalId = zp.PortalId)
						LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = a.AccountId) 
						WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeUSer ZUQ WHERE ZUQ.UserId = a.UserId AND ZUQ.EmailOptIn = 1 AND ZUQ.AspNetUserId IS NULL )
						AND (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = @SalesRepUserId and a.UserId = SalRep.CustomerUserid ) or @SalesRepUserId = 0)
				End


				alter table ##View_CustomerUserAddDetail 
				add DepartmentId int, PermissionsName varchar(200), PermissionCode varchar(200), DepartmentName varchar(300), AccountPermissionAccessId int,
				AccountUserOrderApprovalId int, ApprovalName varchar(1000) , ApprovalUserId int
				--, PortalId int , StoreName varchar(1000)
				,CountryName varchar(1000),CityName varchar(1000),StateName varchar(1000),PostalCode varchar(1000), CompanyName varchar(1000),
				SalesRepUserName varchar(600),SalesRepFullName varchar(1000)

	
				IF ((@AddressGlobalSearch like '%CountryName%' OR @AddressGlobalSearch like '%CityName%' OR @AddressGlobalSearch like '%StateName%' OR @AddressGlobalSearch like '%PostalCode%' OR @AddressGlobalSearch like '%CompanyName%')
				and exists(select * from ##UserList))
				BEGIN
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
					from ##View_CustomerUserAddDetail a
					inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
					where exists(select * from ##UserList UL where a.UserId = UL.UserId and UL.AddressId = ZA.AddressId )

					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName
					from ##View_CustomerUserAddDetail a
					inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
					where isnull(a.AccountId,0)<> 0-- is not null
					and exists(select * from ##UserList UL where a.UserId = UL.UserId and UL.AddressID = ZA.AddressId)
					and (a.CountryName is null OR a.CityName is null OR a.StateName is null or a.PostalCode is null or a.CompanyName is null)
		
				END

				--CREATE NONCLUSTERED INDEX IND_101
				--ON [dbo].[##View_CustomerUserAddDetail] ([userId],[AspNetuserId])

				SET @SQL = '			
						
					create table #AccountDetail
					(
						UserId int,AspNetuserId nvarchar(200),UserName nvarchar(200),FirstName nvarchar(200),MiddleName nvarchar(200),LastName nvarchar(200),
						PhoneNumber nvarchar(100),Email nvarchar(100),EmailOptIn bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,
						RoleId varchar(200),RoleName varchar(200),IsActive bit,IsLock bit,FullName  varchar(1000),AccountName  varchar(200),PermissionsName  varchar(200),
						DepartmentName  varchar(200),DepartmentId int,AccountId int,AccountPermissionAccessId int, ExternalId  varchar(200),BudgetAmount numeric(10,6),
						AccountUserOrderApprovalId int,ApprovalName varchar(200),ApprovalUserId int,PermissionCode varchar(500),CustomerPaymentGUID varchar(500),
						StoreName varchar(200),PortalId int,CountryName varchar(200), CityName varchar(200), StateName varchar(200), PostalCode varchar(200), CompanyName varchar(200)
						,SalesRepUserName varchar(200),SalesRepFullName varchar(200) ,RowId int identity , AccountCode nvarchar(100)
					) 
					'+
					+' insert into #AccountDetail(UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID
					,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode)
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode,CustomerPaymentGUID 
					,StoreName,PortalId, CountryName, CityName, StateName, PostalCode, CompanyName, AccountCode
					FROM ##View_CustomerUserAddDetail where 1=1'+
					dbo.Fn_GetWhereClause(@WhereClauseGlobal+case when @WhereClauseGlobal<>'' and @WhereClause1 <> '' then ' And '+@WhereClause1 else @WhereClause1 end, ' AND ')+
					dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC') + '
			
					Insert Into #TBL_RowCount Values(@@RowCount)
							
					SELECT  UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					,Row_Number()Over('+dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC')+')  RowNumber
					into ##CustomerUserAddDetail
					FROM #AccountDetail '+@PaginationWhereClause  +' '+ dbo.Fn_GetOrderByClause(@Order_By, 'UserId DESC');

				EXEC (@SQL)
				
				Select @RowCount= isnull(RowsCount  ,0) from #TBL_RowCount

				ALTER TABLE ##CustomerUserAddDetail ADD AddressId Int
				--To get data for DepartmentId
				update CUD SET DepartmentId = i.DepartmentId
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)

				--To get data for PermissionsName
				update CUD SET PermissionsName = h.PermissionsName, PermissionCode = h.PermissionCode
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
				INNER JOIN ZnodeAccountPermissionAccess g ON(g.AccountPermissionAccessId = f.AccountPermissionAccessId)
				INNER JOIN ZnodeAccessPermission h ON(h.AccessPermissionId = g.AccessPermissionId)

				------To get data for DepartmentName
				update CUD SET DepartmentName = j.DepartmentName
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeDepartmentUser i ON(i.UserId = cud.UserId)
				INNER JOIN ZnodeDepartment j ON(j.DepartmentId = i.DepartmentId)

				--To get data for AccountPermissionAccessId
				update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)

				--To get data for AccountPermissionAccessId
				update CUD SET AccountPermissionAccessId = f.AccountPermissionAccessId
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserPermission f ON(f.UserId = cud.UserId)
	
				--To get data for AccountUserOrderApprovalId
				update CUD SET AccountUserOrderApprovalId = ZAUOA.AccountUserOrderApprovalId
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
	
				--To get data for ApprovalName,ApprovalUserId
				update CUD SET ApprovalName = ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
				+CASE
				WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
				THEN ''
				ELSE ' '
				END,
				ApprovalUserId = ZAUOA.ApprovalUserId
				from ##CustomerUserAddDetail cud
				INNER JOIN ZnodeAccountUserOrderApproval ZAUOA ON cud.UserId = ZAUOA.UserID
				INNER JOIN ZnodeUser ZU ON(ZU.UserId = ZAUOA.ApprovalUserId)
	
				----To get data for PortalId
				--update CUD SET PortalId = CASE
				--								WHEN cud.AccountId IS NULL
				--								THEN up.PortalId
				--								ELSE ZPA.PortalId
				--							END 
				--from ##CustomerUserAddDetail cud
				--   LEFT JOIN ZnodeUserPortal up ON(up.UserId = cud.UserId) 
				--LEFT JOIN ZnodePortalAccount ZPA ON(ZPA.AccountId = cud.AccountId) 
	
				----To get data for CountryName, CityName, StateName, PostalCode, CompanyName
				IF (EXISTS(SELECT * FROM @ColumnName where ([StringColumn] LIKE '%CountryName%' OR [StringColumn] LIKE '%CityName%' OR [StringColumn] LIKE '%StateName%' OR [StringColumn] LIKE '%PostalCode%' OR [StringColumn] LIKE '%CompanyName%'))
				OR (@WhereClauseAll like '%CountryName%' OR @WhereClauseAll like '%CityName%' OR @WhereClauseAll like '%StateName%' OR @WhereClauseAll like '%PostalCode%' OR @WhereClauseAll like '%CompanyName%'))
				BEGIN
			 
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
					from ##CustomerUserAddDetail a
					inner join ZnodeAccountAddress ZAA on a.AccountId = ZAA.AccountId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = ZAA.AddressId
					where isnull(a.AccountId,0)<> 0-- is not null
	 
					update  a set CountryName = ZA.CountryName, CityName = za.CityName, StateName = ZA.StateName, 
					PostalCode = ZA.PostalCode, CompanyName = ZA.CompanyName, a.AddressId = ZA.AddressId
					from ##CustomerUserAddDetail a
					inner join ZnodeUserAddress ZUA on a.UserId = ZUA.UserId
					inner  JOIN ZnodeAddress ZA on ZA.AddressId = zua.AddressId
				END

				----Updating SalesRep for user if any 
				update CUAD
				set CUAD.SalesRepUserName = azu.UserName, 
				CUAD.SalesRepFullName = (ISNULL(RTRIM(LTRIM(ZU.FirstName)), '')+' '+ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '')
				+CASE
				WHEN ISNULL(RTRIM(LTRIM(ZU.MiddleName)), '') = ''
				THEN ''
				ELSE ' '
				END+ISNULL(RTRIM(LTRIM(ZU.LastName)), '')) 
				from ##CustomerUserAddDetail CUAD
				inner join ZnodeSalesRepCustomerUserPortal SRCUP ON CUAD.UserId = SRCUP.CustomerUserid 
				inner join ZnodeUser ZU ON SRCUP.SalesRepUserId = ZU.UserId
				inner join ASPNetUsers ANU ON(ZU.AspNetuserId = ANU.Id)
				inner join AspNetZnodeUser azu ON(azu.AspNetZnodeUserId = ANU.UserName)

				if ( exists(select * from ##UserList) OR @AddressColumnWhereClause <> '')
				begin
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
					Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					from ##CustomerUserAddDetail CUAD
					where exists(select * from ##UserList UL where CUAD.UserId = UL.UserId and CUAD.AddressId = UL.AddressID )
					Order by RowNumber
				end
				else
				begin
					SELECT UserId,AspNetuserId,UserName,FirstName,MiddleName,LastName,PhoneNumber,Email,
					EmailOptIn,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,RoleId,RoleName,IsActive,IsLock,
					Isnull(FirstName,'') +  ' ' + ISnull(LastName,'')  FullName,
					AccountName,PermissionsName,DepartmentName,DepartmentId,AccountId,AccountPermissionAccessId , ExternalId,
					BudgetAmount,AccountUserOrderApprovalId,ApprovalName,ApprovalUserId,PermissionCode ,CustomerPaymentGUID,StoreName,PortalId,
					CountryName, CityName, StateName, PostalCode, CompanyName, SalesRepUserName, SalesRepFullName, AccountCode
					from ##CustomerUserAddDetail
					Order by RowNumber
				end
	
				if OBJECT_ID('tempdb..##CustomerUserAddDetail') is not null
				drop table ##CustomerUserAddDetail

				if OBJECT_ID('tempdb..##View_CustomerUserAddDetail') is not null
				drop table ##View_CustomerUserAddDetail
				
			END;
			ELSE
			BEGIN
				SELECT * FROM View_CustomerUserDetail AS VICUD WHERE 1 = 0;
				SET @RowCount = 0;
			END;
		END;			
    END TRY
    BEGIN CATCH
		DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_AdminUsersByUserId @RoleName = '+@RoleName+' ,@UserName='+@UserName+',@WhereClause='+cast(@WhereClause as varchar(max))+' ,@Rows= '+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_By='+@Order_By+',@RowCount='+CAST(@RowCount AS VARCHAR(50));
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName    = 'Znode_AdminUsersByUserId',
		@ErrorInProcedure = @ERROR_PROCEDURE,
		@ErrorMessage     = @ErrorMessage,
		@ErrorLine        = @ErrorLine,
		@ErrorCall        = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetDynamicReportData')
	DROP PROC Znode_GetDynamicReportData
GO


CREATE PROCEDURE [dbo].[Znode_GetDynamicReportData]
( 
	@ReportType NVARCHAR(100)
)
AS 
/*
Summary : - this procedure is used to get the Report on default family attribute 
Unit Testing 
EXEC Znode_GetDynamicReportData 'pricing'
*/ 
BEGIN
BEGIN TRY
	IF @ReportType IN('Product')
	BEGIN
			                        
		Declare @Tlb_Product TABLE (AttributeCode  varchar(300), GroupDisplayOrder int, DisplayOrder int)
		Declare @Tlb_FilterrableColumn TABLE (PimAttributeId  int , AttributeCode varchar(300),DataType Nvarchar(300),GroupDisplayOrder int, DisplayOrder int )
				  
		Insert into @Tlb_Product (AttributeCode  ,GroupDisplayOrder ,DisplayOrder )
		SELECT DISTINCT AttributeCode ,ZPAG.DisplayOrder ,ZPA.DisplayOrder 
		FROM ZnodePimAttribute ZPA
		INNER JOIN ZnodeAttributeType ZAT ON(ZAT.AttributeTypeId = ZPA.AttributeTypeId)
		INNER JOIN ZnodePimFamilyGroupMapper ZPFM ON(ZPFM.PimAttributeId = ZPA.PimAttributeId)
		INNER JOIN ZnodePimAttributeGroup ZPAG ON ZPFM.PimAttributeGroupId = ZPAG.PimAttributeGroupId
		WHERE ZPA.IsCategory = 0 ;

		Select AttributeCode as ColumnList from @Tlb_Product  ORDER BY 
		CASE when GroupDisplayOrder IS null then 1 else 0 end , GroupDisplayOrder ,
		CASE when DisplayOrder IS null then 1 else 0 end , DisplayOrder		

		insert into @Tlb_FilterrableColumn (PimAttributeId , AttributeCode ,DataType ,GroupDisplayOrder,DisplayOrder )
		SELECT DISTINCT ZPA.PimAttributeId AS Id, ZPA.AttributeCode Name,                                             
		CASE
		WHEN ZAT.AttributeTypeName IN('Multi Select', 'Simple Select', 'Text', 'Text Area')
		THEN 'String'
		WHEN ZAT.AttributeTypeName IN('Number')
		THEN 'Int32'
		WHEN ZAT.AttributeTypeName IN('Yes/No')
		THEN 'Boolean'
		ELSE ZAT.AttributeTypeName
		END DataType,ZPAG.DisplayOrder,ZPA.DisplayOrder
		FROM ZnodePimAttribute ZPA
		INNER JOIN ZnodeAttributeType ZAT ON(ZAT.AttributeTypeId = ZPA.AttributeTypeId)
		INNER JOIN ZnodePimFamilyGroupMapper ZPFM ON(ZPFM.PimAttributeId = ZPA.PimAttributeId)
		INNER JOIN ZnodePimAttributeGroup ZPAG ON ZPFM.PimAttributeGroupId = ZPAG.PimAttributeGroupId
		WHERE ZPA.IsFilterable = 1  AND ZPA.IsCategory = 0 
		AND ZAT.AttributeTypeName NOT IN('Image') ;

		SELECT PimAttributeId Id, AttributeCode Name ,DataType FROM @Tlb_FilterrableColumn  ORDER BY 
		CASE when GroupDisplayOrder IS null then 1 else 0 end , GroupDisplayOrder ,
		CASE when DisplayOrder IS null then 1 else 0 end , DisplayOrder		 
	END

	ELSE IF @ReportType IN('Category')
	BEGIN 
		Declare @Tlb_Category TABLE (AttributeCode  varchar(300), GroupDisplayOrder int)
				 
		insert into @Tlb_Category (AttributeCode, GroupDisplayOrder)
		SELECT DISTINCT AttributeCode ,ZPA.DisplayOrder               
		FROM ZnodePimAttribute ZPA
		INNER JOIN ZnodeAttributeType ZAT ON(ZAT.AttributeTypeId = ZPA.AttributeTypeId)
		-- INNER JOIN ZnodePimFamilyGroupMapper ZPFM ON(ZPFM.PimAttributeId = ZPA.PimAttributeId)
		WHERE ZPA.IsCategory = 1;

		SELECT AttributeCode as ColumnList from @Tlb_Category  Order by GroupDisplayOrder

		insert into @Tlb_FilterrableColumn (PimAttributeId , AttributeCode ,DataType ,GroupDisplayOrder )
		SELECT DISTINCT ZPA.PimAttributeId AS Id,ZPA.AttributeCode Name,                                            
		CASE
		WHEN ZAT.AttributeTypeName IN('Multi Select', 'Simple Select', 'Text', 'Text Area')
		THEN 'String'
		WHEN ZAT.AttributeTypeName IN('Number')
		THEN 'Int32'
		WHEN ZAT.AttributeTypeName IN('Yes/No')
		THEN 'Boolean'
		ELSE ZAT.AttributeTypeName
		END DataType,
		ZPA.DisplayOrder
		FROM ZnodePimAttribute ZPA
		INNER JOIN ZnodeAttributeType ZAT ON(ZAT.AttributeTypeId = ZPA.AttributeTypeId)
		-- INNER JOIN ZnodePimFamilyGroupMapper ZPFM ON(ZPFM.PimAttributeId = ZPA.PimAttributeId)
		WHERE ZPA.IsFilterable = 1 AND ZPA.IsCategory = 1 
		AND ZAT.AttributeTypeName NOT IN('Image');
		SELECT PimAttributeId Id, AttributeCode Name ,DataType FROM @Tlb_FilterrableColumn  ORDER BY GroupDisplayOrder 

	END 

	ELSE IF @ReportType IN('Inventory')
	BEGIN 
		SELECT  Replace(COLUMN_NAME, 'WarehouseId','WarehouseCode') ColumnList
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodeInventory' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate');
				
		SELECT ORDINAL_POSITION AS Id,Replace(COLUMN_NAME, 'WarehouseId','WarehouseCode')  Name,                                              
		CASE
		WHEN DATA_TYPE IN('varchar', 'Nvarchar', 'Text', 'Text Area','nchar','char') OR COLUMN_NAME =  'WarehouseId'
		THEN 'String'
		WHEN DATA_TYPE IN('int','numeric')
		THEN 'Int32'
		WHEN DATA_TYPE IN('BIT')
		THEN 'Boolean'
		ELSE DATA_TYPE
		END DataType				
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodeInventory' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate');
	END 

	ELSE IF @ReportType IN('Orders')
	BEGIN 
		SELECT  COLUMN_NAME ColumnList
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodeOmsOrderDetails' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate');
		SELECT  ORDINAL_POSITION AS Id, COLUMN_NAME Name,                                           
		CASE
		WHEN DATA_TYPE IN('varchar', 'Nvarchar', 'Text', 'Text Area','nchar','char')
		THEN 'String'
		WHEN DATA_TYPE IN('int','numeric')
		THEN 'Int32'
		WHEN DATA_TYPE IN('BIT')
		THEN 'Boolean'
		ELSE DATA_TYPE
		END DataType                				
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodeOmsOrderDetails' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate');
	END 

	ELSE IF @ReportType IN('Pricing')
	BEGIN 
		SELECT  Replace(COLUMN_NAME ,'PriceListId','PriceListCode') ColumnList
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodePrice' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate','UomId','UnitSize');
				 
		SELECT ORDINAL_POSITION AS Id, Replace(COLUMN_NAME ,'PriceListId','PriceListCode') Name,   
		CASE when COLUMN_NAME = 'PriceListId' then 'String'  ELSE                                           
		CASE
		WHEN DATA_TYPE IN('varchar', 'Nvarchar', 'Text', 'Text Area','nchar','char')
		THEN 'String'
		WHEN DATA_TYPE IN('int','numeric')
		THEN 'Int32'
		WHEN DATA_TYPE IN('BIT')
		THEN 'Boolean'
		ELSE DATA_TYPE
		END END DataType                 				
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodePrice' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate','UomId','UnitSize');
	END 

	ELSE IF @ReportType IN('User')
	BEGIN 
		SELECT  COLUMN_NAME ColumnList
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodeUser' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate');

		SELECT ORDINAL_POSITION AS Id,COLUMN_NAME Name,                                             
		CASE
		WHEN DATA_TYPE IN('varchar', 'Nvarchar', 'Text', 'Text Area','nchar','char')
		THEN 'String'
		WHEN DATA_TYPE IN('int','numeric')
		THEN 'Int32'
		WHEN DATA_TYPE IN('BIT')
		THEN 'Boolean'
		ELSE DATA_TYPE
		END DataType                				
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodeUser' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate');
	END 

	ELSE IF @ReportType IN('Account')
	BEGIN 
		SELECT  COLUMN_NAME ColumnList
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodeAccount' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate');

		SELECT ORDINAL_POSITION AS Id,COLUMN_NAME Name,                                             
		CASE
		WHEN DATA_TYPE IN('varchar', 'Nvarchar', 'Text', 'Text Area','nchar','char')
		THEN 'String'
		WHEN DATA_TYPE IN('int','numeric')
		THEN 'Int32'
		WHEN DATA_TYPE IN('BIT')
		THEN 'Boolean'
		ELSE DATA_TYPE
		END DataType				
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodeAccount' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate');
	END 

	ELSE IF @ReportType IN('Voucher')
	BEGIN 
		SELECT  COLUMN_NAME ColumnList
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodeGiftCard' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate');

		SELECT ORDINAL_POSITION AS Id,COLUMN_NAME Name,                                             
		CASE
		WHEN DATA_TYPE IN('varchar', 'Nvarchar', 'Text', 'Text Area','nchar','char')
		THEN 'String'
		WHEN DATA_TYPE IN('int','numeric')
		THEN 'Int32'
		WHEN DATA_TYPE IN('BIT')
		THEN 'Boolean'
		ELSE DATA_TYPE
		END DataType				
		FROM INFORMATION_SCHEMA.COLUMNS 
		WHERE TABLE_NAME = 'ZnodeGiftCard' 
		AND COLUMN_NAME not IN ('CreatedBy','CreatedDate','ModifiedBy','ModifiedDate');
	END 

END TRY
BEGIN CATCH
	DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetDynamicReportData @ReportType = '+@ReportType+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		     
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetDynamicReportData',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH
END;

GO

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>CMSContentPagesId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>PageTitle</name><headertext>Page Title</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Content/EditContentPage</islinkactionurl><islinkparamfield>cmsContentPagesId,PublishStatus</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>PageName</name><headertext>Page Name</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>Image</name><headertext>Template Image</headertext><width>20</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield>MediaPath,PageTemplateName</imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class>imageicon</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PageTemplateName</name><headertext>Template Name</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>CMSContentPageGroupName</name><headertext>Folder</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>PortalName</name><headertext>Store Name</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>SEOTitle</name><headertext>SEO Title</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>SEOKeywords</name><headertext>SEO Keywords</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>11</id><name>SEOUrl</name><headertext>SEO Friendly Url </headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>12</id><name>MetaInformation</name><headertext>Meta Information</headertext><width>60</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>13</id><name>ActivationDate</name><headertext>Activation Date </headertext><width>60</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>14</id><name>ExpirationDate</name><headertext>Expiration Date </headertext><width>60</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>15</id><name>IsActive</name><headertext>Is Active</headertext><width>60</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>16</id><name>PublishStatus</name><headertext>Publish Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>17</id><name>IsPublished</name><headertext>Status</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>y</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>18</id><name>Manage</name><headertext>Action</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Edit|Delete|Publish</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete|Publish</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Content/EditContentPage|/Content/DeleteContentPage|/Content/PublishContentPage</manageactionurl><manageparamfield>cmsContentPagesId|cmsContentPagesId|cmsContentPagesId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'StaticPageList'

GO

update ZnodeApplicationSetting
set setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>SearchSynonymsId</name><headertext>Checkbox</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>SearchSynonymsId</name><headertext>ID</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl>/SearchConfiguration/EditSearchSynonyms</islinkactionurl><islinkparamfield>searchSynonymsId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OriginalTerm</name><headertext>Original Term</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>ReplacedBy</name><headertext>Replaced By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>IsBidirectional</name><headertext>Is Bidirectional</headertext><width>60</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SearchConfiguration/EditSearchSynonyms|/SearchConfiguration/DeleteSearchSynonyms</manageactionurl><manageparamfield>searchSynonymsId|searchSynonymsId,PublishCatalogId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeSearchSynonymsList'

GO

UPDATE ZnodeEmailTemplateLocale
SET Content = REPLACE(Content,'2021','2022')
WHERE Content  LIKE '%2021%' AND Content  LIKE '%copyright%'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateQuoteLineItem')
	DROP PROC Znode_InsertUpdateQuoteLineItem
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateQuoteLineItem]
(
	@OmsQuoteId			INT ,
	@UserId				INT = 0,
	@OmsSavedCartId		INT = 0,
	@Status				BIT OUT ,
	@SKUPriceForQuote [dbo].[SKUPriceForQuote] ReadOnly
)
AS
/* 
	Summary: This Procedure is used to save and edit the quote line item
	Unit Testing 
	Exec Znode_InsertUpdateQuoteLineItem 2000,1527,0
*/
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		DECLARE @OmsQuoteLineItemId INT;
		DECLARE @TempOmsQuoteLineItem TABLE (OmsQuoteLineItemId INT , OmsSavedCartLineItemId INT , ParentOmsSavedCartLineItemId INT, Custom1 nvarchar(MAX), Custom2 nvarchar(MAX),
			Custom3	nvarchar(MAX),Custom4	nvarchar(MAX),Custom5	nvarchar(MAX))
		DECLARE @OrderLineItemRelationshipTypeIdBundle INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType WHERE Name = 'Bundles')

		CREATE TABLE #ZnodeOmsSavedCartLineItem
		(
			OmsSavedCartLineItemId	int,
			ParentOmsSavedCartLineItemId	int,
			OmsSavedCartId	int,
			SKU	nvarchar(200),
			Quantity	numeric(28,	13) ,
			OrderLineItemRelationshipTypeId	int,
			CustomText	nvarchar(MAX),
			CartAddOnDetails	nvarchar(MAX),
			Sequence	int,
			CreatedBy	int,
			CreatedDate	datetime,
			ModifiedBy	int,
			ModifiedDate	datetime,
			AutoAddon	nvarchar(MAX),
			OmsOrderId	int,
			Custom1	nvarchar(MAX),
			Custom2	nvarchar(MAX),
			Custom3	nvarchar(MAX),
			Custom4	nvarchar(MAX),
			Custom5	nvarchar(MAX),
			GroupId	nvarchar(MAX),
			ProductName	nvarchar(2000),
			Description	nvarchar(MAX),
			Price numeric(28,6),
			ShippingCost numeric(28,6),
			InitialPrice numeric(28,6),
			InitialShippingCost numeric(28,6),
			IsPriceEdit bit
		)
			 
		IF (ISNULL(@OmsSavedCartId,0) <> 0)
		BEGIN
			INSERT INTO #ZnodeOmsSavedCartLineItem
				(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,
					CartAddOnDetails,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,
					Custom5,GroupId,ProductName,Description)
			SELECT a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId,a.OmsSavedCartId,a.SKU,a.Quantity,a.OrderLineItemRelationshipTypeId,
				a.CustomText,a.CartAddOnDetails,a.Sequence,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate,a.AutoAddon,a.OmsOrderId,
				a.Custom1,a.Custom2,a.Custom3,a.Custom4,a.Custom5,a.GroupId,a.ProductName,a.Description 				
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsQuoteLineItem ty WHERE ty.OmsQuoteId = @OmsQuoteId) and a.OmsSavedCartId=@OmsSavedCartId
		END
		ELSE
		BEGIN
			INSERT INTO #ZnodeOmsSavedCartLineItem
				(OmsSavedCartLineItemId,ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,
					CartAddOnDetails,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,
					Custom4,Custom5,GroupId,ProductName,Description)
			SELECT a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId,a.OmsSavedCartId,a.SKU,a.Quantity,a.OrderLineItemRelationshipTypeId,
				a.CustomText,a.CartAddOnDetails,a.Sequence,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate,a.AutoAddon,a.OmsOrderId,
				a.Custom1,a.Custom2,a.Custom3,a.Custom4,a.Custom5,a.GroupId,a.ProductName,a.Description 
			FROM ZnodeOmsSavedCartLineItem a 
			INNER JOIN ZnodeOmsSavedCart b ON (b.OmsSavedCartId = a.OmsSavedCartId)
			INNER JOIN ZnodeOmsCookieMapping c ON (c.OmsCookieMappingId = b.OmsCookieMappingId)
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsQuoteLineItem ty WHERE ty.OmsQuoteId = @OmsQuoteId) 
			AND c.UserId = @UserId
		END
			
		UPDATE ZOSLI set ZOSLI.Price = SPQ.Price, ZOSLI.ShippingCost = SPQ.ShippingCost, ZOSLI.InitialPrice = SPQ.InitialPrice,
		ZOSLI.InitialShippingCost = SPQ.InitialShippingCost, ZOSLI.IsPriceEdit = SPQ.IsPriceEdit,
		ZOSLI.Custom1= SPQ.Custom1, ZOSLI.Custom2 = SPQ.Custom2, ZOSLI.Custom3 = SPQ.Custom3 , ZOSLI.Custom4 = SPQ.Custom4 , ZOSLI.Custom5 = SPQ.Custom5
		FROM #ZnodeOmsSavedCartLineItem ZOSLI
		INNER JOIN @SKUPriceForQuote SPQ ON ZOSLI.OmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId

		--To update price and ShippingCost for child entries of bundle product
		UPDATE ZOSLI set ZOSLI.Price = SPQ.Price, ZOSLI.ShippingCost = SPQ.ShippingCost, ZOSLI.InitialPrice = SPQ.InitialPrice,
		ZOSLI.InitialShippingCost = SPQ.InitialShippingCost, ZOSLI.IsPriceEdit= SPQ.IsPriceEdit,
		ZOSLI.Custom1= SPQ.Custom1, ZOSLI.Custom2 = SPQ.Custom2, ZOSLI.Custom3 = SPQ.Custom3 , ZOSLI.Custom4 = SPQ.Custom4 , ZOSLI.Custom5 = SPQ.Custom5
		FROM #ZnodeOmsSavedCartLineItem ZOSLI
		INNER JOIN @SKUPriceForQuote SPQ ON ZOSLI.ParentOmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId
		WHERE ZOSLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle


		IF OBJECT_ID('Tempdb..#desupdate1') IS NOT NULL
		DROP TABLE Tempdb..#desupdate1 
		SELECT ZnodeProductId,des
		INTO #desupdate1 
		FROM 
		(
			SELECT ZnodeProductId, CONCAT( 'Qty: ',cast(cast(AssociatedProductBundleQuantity as int) as varchar(5)),'| ',sku,' - ', 
				productname, CHAR(10) ) des
			FROM ZnodePublishBundleProductEntity ZPBPE1
			inner join ZnodePublishProductDetail ZPP on ZPBPE1.AssociatedZnodeProductId = ZPP.PublishProductId
		) asd GROUP BY ZnodeProductId, des


		IF OBJECT_ID('Tempdb..#desupdate') IS NOT NULL
		DROP TABLE Tempdb..#desupdate 

		SELECT ZPBPE.des, asd.* 
		INTO #desupdate 
		FROM
		(
			SELECT VLMP.PimProductId PPI , ZOSCL.* 
			FROM #ZnodeOmsSavedCartLineItem ZOSCL 
			INNER JOIN [dbo].[View_LoadManageProduct] VLMP ON VLMP.AttributeCode ='SKU' AND VLMP.AttributeValue= ZOSCL.sku
			INNER JOIN (SELECT * FROM ZnodepimAttributevalue WHERE PimAttributeId = 10 AND PimAttributeValueId IN (
							SELECT PimAttributeValueId FROM ZnodePimProductAttributeDefaultValue WHERE PimAttributeDefaultValueId in (
							SELECT PimAttributeDefaultValueId FROM ZnodePimAttributeDefaultValue WHERE AttributeDefaultValueCode = 'BundleProduct' ))) BP
										ON BP.PimProductId = VLMP.PimProductId 
		) asd
		CROSS APPLY
		(
			SELECT *
			FROM (SELECT ZnodeProductId, '<p><span style="font-family: Arial, Helvetica, sans-serif; font-size: 10px;">' +
				(SELECT des +' </br> '
								FROM #desupdate1 AS p 
								WHERE p.ZnodeProductId = a.ZnodeProductId
								FOR XML PATH(''))
							
			+ '</span></p>' AS des
						FROM #desupdate1 a
						GROUP BY ZnodeProductId) ZPBPE1
			INNER JOIN ZnodePublishProduct ZPP on ZPBPE1.ZnodeProductId = ZPP.PublishProductId
			WHERE Zpp.PimProductId = asd.PPI
		) 
			ZPBPE

		UPDATE ZOSLI set ZOSLI.Description = SPQ.des
		FROM #ZnodeOmsSavedCartLineItem ZOSLI
		INNER JOIN #desupdate SPQ ON ZOSLI.OmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId or ZOSLI.ParentOmsSavedCartLineItemId = SPQ.OmsSavedCartLineItemId

		
		MERGE INTO ZnodeOmsQuoteLineItem TARGET 
		USING #ZnodeOmsSavedCartLineItem SOURCE 
		ON (1=0 )
		WHEN NOT MATCHED THEN 
		INSERT 
			(ParentOmsQuoteLineItemId,OmsQuoteId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails,Sequence,
				CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,GroupId,ProductName,Description, Price, ShippingCost,InitialPrice, 
				InitialShippingCost, IsPriceEdit, Custom1, Custom2, Custom3, Custom4, Custom5)
			 
		VALUES (NULL,@OmsQuoteId,SOURCE.SKU,SOURCE.Quantity,SOURCE.OrderLineItemRelationshipTypeId
					,SOURCE.CustomText,SOURCE.CartAddOnDetails,SOURCE.Sequence,SOURCE.CreatedBy,SOURCE.CreatedDate,SOURCE.ModifiedBy,
					SOURCE.ModifiedDate,SOURCE.GroupId,SOURCE.ProductName,SOURCE.Description, SOURCE.Price, SOURCE.ShippingCost,
					SOURCE.InitialPrice, SOURCE.InitialShippingCost, SOURCE.IsPriceEdit, SOURCE.Custom1, SOURCE.Custom2, SOURCE.Custom3, 
					SOURCE.Custom4, SOURCE.Custom5) 
			
		OUTPUT Inserted.OmsQuoteLineItemId , SOURCE.OmsSavedCartLineItemId,Source.ParentOmsSavedCartLineItemId, Source.Custom1, Source.Custom2, Source.Custom3, Source.Custom4, Source.Custom5
		INTO @TempOmsQuoteLineItem ;

		UPDATE a
		SET a.ParentOmsQuoteLineItemId =( SELECT TOP 1 b1.OmsQuoteLineItemId FROM @TempOmsQuoteLineItem b1 WHERE b.ParentOmsSavedCartLineItemId = b1.OmsSavedCartLineItemId)  
		FROM ZnodeOmsQuoteLineItem a
		INNER JOIN @TempOmsQuoteLineItem b ON (b.OmsQuoteLineItemId = a.OmsQuoteLineItemId)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL

		INSERT INTO ZnodeOmsQuotePersonalizeItem 
			(OmsQuoteLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
		SELECT b.OmsQuoteLineItemId,PersonalizeCode,PersonalizeValue,a.CreatedBy,a.CreatedDate,a.ModifiedBy,a.ModifiedDate
			,DesignId,ThumbnailURL
		FROM ZnodeOmsPersonalizeCartItem a
		INNER JOIN @TempOmsQuoteLineItem b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
			
		SET @Status = 1;
		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateQuoteLineItem @CartLineItemXML = '+CAST('' AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
		 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;
		ROLLBACK TRAN A;
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_InsertUpdateQuoteLineItem',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>FormBuilderSubmitId</name><headertext>Form Builder Submit ID</headertext><width>40</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>FormBuilderId</name><headertext>ID</headertext><width>40</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>FormCode</name><headertext>Form Code</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/FormSubmission/View</islinkactionurl><islinkparamfield>FormBuilderSubmitId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>StoreName</name><headertext>Store Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>UserName</name><headertext>Username</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>FullName</name><headertext>Full Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>CreatedDate</name><headertext>Created Date </headertext><width>60</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/FormSubmission/View</manageactionurl><manageparamfield>FormBuilderSubmitId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeFormSubmissionList'

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'SynonymCode' AND Object_ID = Object_ID(N'dbo.ZnodeSearchSynonyms'))
BEGIN
	ALTER TABLE ZnodeSearchSynonyms ADD SynonymCode NVARCHAR(100) NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = c.CatalogCode) AND ISNULL(ii.CatalogCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''
		

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False') AND ii.IsBidirectional <> ''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, A.IsBidirectional, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode)
		
	--Update existing search synonym
	UPDATE ZSS 
	SET ZSS.SynonymCode = IPS.RenameSynonymCode, ZSS.OriginalTerm = IPS.OriginalTerm,
	ZSS.ReplacedBy = IPS.ReplacedBy,ZSS.IsBidirectional=IPS.IsBidirectional,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
	WHERE ISNULL(IPS.RenameSynonymCode,'') <> ''

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidatePimProductData')
	DROP PROC Znode_ImportValidatePimProductData
GO


CREATE PROCEDURE [dbo].[Znode_ImportValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0 )
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct / Price / Inventory / Category / Category Associated Data 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(100), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max),
				@FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
            --To get the total record count for update purpose in catch block
            SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			INSERT INTO Znode_ImportCsvRowCount
			EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

			CREATE TABLE #DefaultAttributeCode
			(AttributeTypeName          VARCHAR(300),
			PimAttributeDefaultValueId INT,
			PimAttributeId             INT,
			AttributeDefaultValueCode  VARCHAR(100)
			);

			IF( @ImportHeadName = 'B2BCustomer' )
			BEGIN
				EXEC ZnodeB2BCustomerMapping @ImportHeadName = @ImportHeadName, @TableName = @TableName
			END
		
             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();

             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'Product'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @DefaultFamilyId = 0
                AND @ImportHeadName IN('Product', 'Category')
                 BEGIN 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
				 
                     --Get all default attribute values in attribute 
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with source column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = @IsCategory,
                          @DefaultFamilyId = @DefaultFamilyId;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;      
             -- Check attributes are manditory and not provided with source table
		   	 
			if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
			Declare @Tbl_CsvDynamicColulmns TABLE (ColumnName nvarchar(300), SequenceNumber int, DataType nvarchar(50),IsRequired bit )

			INSERT INTO @Tbl_CsvDynamicColulmns(ColumnName , SequenceNumber , DataType ,IsRequired)
			SELECT DISTINCT ZITM.SourceColumnName ,ZIAV.SequenceNumber, ZIAV.AttributeTypeName, ZIAV.IsRequired
			FROM ZnodeImportAttributeValidation ZIAV LEFT OUTER JOIN 
			ZnodeImportTemplate  ZIT ON ZIT.ImportHeadId =  ZIAV.ImportHeadId AND ZIT.ImportTemplateId  = @TemplateId
			LEFT OUTER JOIN ZnodeImportTemplateMapping  ZITM ON ZITM.ImportTemplateId = ZIT.ImportTemplateId  
			and ZIAV.AttributeCode = ZITM.TargetColumnName
			AND ZITM.ImportTemplateId  = @TemplateId
			WHERE ZIAV.ImportHeadId = @ImportHeadId --ORDER BY ZIAV.SequenceNumber


		    SELECT @CsvColumnString = SUBSTRING ((Select ',' +  ISNULL(ColumnName ,'NULL') from @Tbl_CsvDynamicColulmns ORDER BY SequenceNumber FOR XML PATH ('')),2,4000) 


     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId
             )
             EXEC sys.sp_sqlexec  @SQLQuery;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('Product', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @FamilyAttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''
                                          AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							Delete FAD from @AttributeDetail FAD
							where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode) 

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
							DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'File'
                                   AND ValidationName <> 'IsAllowMultiUpload';

                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;

                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';

                         END;
                     ELSE
                         BEGIN
					
					
                             --Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC [Znode_ImportGetOtherTemplateDetails]
                                  @TemplateId = @TemplateId,
                                  @ImportHeadId = @ImportHeadId;

							IF @ImportHeadName IN('B2BCustomer')
							BEGIN

								INSERT INTO @AttributeDetail
								 (PimAttributeId,
								 AttributeTypeName,
								  AttributeCode,
								  SourceColumnName,
								  IsRequired,
								  ControlName,
								  ValidationName,
								  SubValidationName,
								  ValidationValue,
								  RegExp
								 )
								 EXEC [Znode_ImportGetGlobalTemplateDetails]
									  @TemplateId = @TemplateId,
									  @ImportHeadId = @ImportHeadId;

								
								INSERT INTO #DefaultAttributeCode
								(AttributeTypeName,
								PimAttributeDefaultValueId,
								PimAttributeId,
								AttributeDefaultValueCode
								)
								--Call Process to insert default data value 
								EXEC Znode_ImportGetGlobalAttributeDefaultValue;

								DELETE FROM #DefaultAttributeCode
								WHERE AttributeTypeName = 'Yes/No';

							END
						
                             --Check attributes are not mapped with any family of Pim Product
                             INSERT INTO ZnodeImportLog
                             (ErrorDescription,
                              ColumnName,
                              Data,
                              GUID,
                              CreatedBy,
                              CreatedDate,
                              ModifiedBy,
                              ModifiedDate,
                              ImportProcessLogId
                             )
                                    SELECT DISTINCT
                                           '14' AS ErrorDescription,
                                           AttributeCode,
                                           '',
                                           @NewGUID,
                                           @UserId,
                                           @GetDate,
                                           @UserId,
                                           @GetDate,
                                           @ImportProcessLogId
                                    FROM @AttributeDetail
                                    WHERE ISNULL(SourceColumnName, '') = ''   AND IsRequired = 1;  ;

                         END;
						
                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
					
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;
                             IF @AttributeTypeName in ( 'Image','File')
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

					

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('Product', 'Category','B2BCustomer')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                            IF  @AttributeTypeName = 'Multi Select'
											 BEGIN
										 		 ---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
												 (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
												 )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''
												EXEC sys.sp_sqlexec @SQLQuery;
											  END
											  ELSE IF @AttributeTypeName = 'Simple Select'
											  BEGIN
						
												---Verify Image file is exists in media table or not 
												 SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
												 SELECT ROWNUMBER , ' + @SourceColumnName + ' , ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
												 + ' SP Where ISnull(' + @SourceColumnName +  ','''') <> '''' AND 
												  NOT EXISTS 
												 (Select TOP 1 1 FROM #DefaultAttributeCode DAC WHERE 
												  DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
												 ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.' + @SourceColumnName + ') ) = DAC.AttributeDefaultValueCode ) '
							
												EXEC sys.sp_sqlexec @SQLQuery;
											  END   
												-- Check Invalid Image 
												 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
												 Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
												 INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
												 EXEC sys.sp_sqlexec @SQLQuery;
												 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
             
			 
			  
------------------------------------------------------------------------------------------
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000) 
         IF @ImportHeadName IN('Product','Pricing','ProductAssociation','Inventory')
		 BEGIN
		 	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId


			SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;			
		END
		ELSE IF @ImportHeadName IN('ProductAttribute')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Attribute - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'ZipCode'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'ZIP'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  ZIPCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Category'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'CategoryAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'CategoryName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  CategoryName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;

		END
		ELSE IF @ImportHeadName IN ('Customer','CustomerAddress')
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'UserName'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  UserName - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'SEODetails'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'Code'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  Code - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'Highlight'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'HighlightCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  HighlightCode - '' + ' + ' cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AddonAssociation'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]''  
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
		ELSE IF @ImportHeadName = 'AttributeDefaultValue'
		BEGIN
		SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'AttributeDefaultValueCode'
		AND ImportTemplateId = @TemplateId

		    SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  AttributeDefaultValueCode - '' + ' + '  cast( ' + @SourceColumnNameProduct + ' as varchar(50)) +' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew
			EXEC sys.sp_sqlexec  @SQLQueryNew;
		END
	-------------------------------------------------------------------------------------------------------------
	
	--------------------------------------------------------------------------------------------------------------------
			 
  		SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber IN (Select Rownumber FROM ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber IS NOT NULL)';
        EXEC sys.sp_sqlexec  @SQLQuery;
			 			
   
             IF @ImportHeadName IN('Product', 'Category')
                 BEGIN
                     IF NOT EXISTS
                     (
                         SELECT TOP 1 1
                         FROM @FamilyAttributeDetail
                         WHERE ISNULL(SourceColumnName, '') = ''
                               AND IsRequired = 1
                     ) AND NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN

                                     EXEC Znode_ImportPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;

                                 END;
                             ELSE
                                 BEGIN
                                     EXEC Znode_ImportPimCategoryData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
                                 END;
                         END
						 ELSE
							BEGIN
								-- Update Record count in log 
								
							
								--SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								--EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								--UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								--WHERE ImportProcessLogId = @ImportProcessLogId;

								SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
								SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
								EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out
								UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
								WHERE ImportProcessLogId = @ImportProcessLogId;
							END

                 END;
				IF NOT EXISTS
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN(43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 )
             BEGIN
                 IF @ImportHeadName = 'Pricing'
                     BEGIN
                         EXEC [Znode_ImportPriceList]
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
                              @PriceListId = @PriceListId;
                     END;

                 IF @ImportHeadName = 'Inventory'
                     BEGIN
				
                         EXEC Znode_ImportInventory_Ver1
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID;
                     END;
                 IF @ImportHeadName = 'ZipCode'
                     BEGIN
						 EXEC Znode_ImportZipCode
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CountryCode = @CountryCode;
                     END;
					 IF @ImportHeadName = 'CategoryAssociation'
                     BEGIN
						 EXEC Znode_ImportCatalogCategory
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @PimCatalogId = @PimCatalogId;
                     END;
					 IF @ImportHeadName = 'ProductAssociation'
                     BEGIN
						 EXEC Znode_ImportAssociateProducts
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
                     END;
			
					 IF @ImportHeadName = 'SEODetails' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportSEODetails
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @LocaleId = @LocaleId,
							  @PortalId =@PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID,
							  @CsvColumnString = @CsvColumnString 

				
                     END;
				
					 IF @ImportHeadName = 'ProductAttribute' 
                     BEGIN
						 EXEC Znode_ImportAttributes
                              @TableName = @TableName,
                              @Status = @Status,
                              @UserId = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID = @NewGUID
				
                     END;

					 IF @ImportHeadName = 'Customer' AND @PortalId > 0 
                     BEGIN
					
					
						 EXEC Znode_ImportCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;
					 
					 IF @ImportHeadName = 'UserApprovers' AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportUserApproval
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'B2BCustomer' AND @PortalId > 0 
                     BEGIN

							 EXEC Znode_ImportB2BCustomer
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = @PortalId,
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
				
                     END;

					 IF @ImportHeadName = 'CustomerAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'ShippingAddress' --AND @PortalId > 0 
                     BEGIN
						 EXEC Znode_ImportCustomerAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @LocaleId	 = @LocaleId,
							  @PortalId  = 7, -- not implemented from forntend 
                              @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString,
							  @IsAccountAddress = @IsAccountAddress
				
                     END;
					 IF @ImportHeadName = 'StoreLocator' --AND @PortalId > 0 
                     BEGIN
					 	 EXEC Znode_ImportStoreLocatorAddress
                              @TableName = @TableName,
                              @Status	 = @Status,
                              @UserId	 = @UserId,
							  @ImportProcessLogId = @ImportProcessLogId,
                              @NewGUID	 = @NewGUID,
							  @CsvColumnString =@CsvColumnString
                     END;

					IF @ImportHeadName = 'Highlight'
					BEGIN
					EXEC Znode_ImportHighlight 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID 
					END;

					IF @ImportHeadName = 'AddonAssociation'
					BEGIN
					EXEC Znode_ImportAddonAssociation 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID,
					@PimCatalogId = @PimCatalogId
					END;

					IF @ImportHeadName = 'AttributeDefaultValue'
					BEGIN
					EXEC Znode_ImportAttributeDefaultValue 
					@TableName = @TableName, 
					@Status = @Status, 
					@UserId = @UserId, 
					@ImportProcessLogId = @ImportProcessLogId, 
					@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Voucher'
					BEGIN
						EXEC Znode_ImportVoucher 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					
					END;

					IF @ImportHeadName = 'Account'
					BEGIN
						
						EXEC Znode_ImportAccount 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID,
						@CsvColumnString = @CsvColumnString,
						@PortalId = @PortalId
					
					END;

					IF @ImportHeadName = 'Synonyms'
					BEGIN
						EXEC Znode_ImportSynonyms 
						@TableName = @TableName, 
						@Status = @Status, 
						@UserId = @UserId, 
						@ImportProcessLogId = @ImportProcessLogId, 
						@NewGUID = @NewGUID
					END
				 
             END
			 ELSE 
				 BEGIN
					-- Update Record count in log 	
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					SELECT @SuccessRecordCount = 0
									
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
					WHERE ImportProcessLogId = @ImportProcessLogId;

				 END

             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
				 SET @SQLQuery = 'IF Object_id(''+@TableName+'') IS NOT NULL  DROP TABLE ' + @TableName
                 EXEC sys.sp_sqlexec @SQLQuery;

				 print 'end';
         END TRY
         BEGIN CATCH
			DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE()
			DECLARE @TempCount TABLE (Id INT)

			Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
			INSERT INTO @TempCount
			EXEC (@SQL)

             SELECT ERROR_MESSAGE(),
                    ERROR_LINE(),
                    ERROR_PROCEDURE();
             EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID; 
             
			 ---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			SET @SQLQuery = 'Drop Table ' + @TableName
            EXEC sys.sp_sqlexec @SQLQuery;
             --ROLLBACK TRAN TRN_ImportValidProductData;
         END CATCH;
     END;

GO

insert into ZnodeImportHead(Name,	IsUsedInImport,	IsUsedInDynamicReport,	IsActive,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	IsCsvUploader)
select 'Synonyms',1,1,1,2,getdate(),2,getdate(),null
where not exists(select * from ZnodeImportHead where Name = 'Synonyms')

insert into ZnodeImportTemplate(ImportHeadId,TemplateName,TemplateVersion,PimAttributeFamilyId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select top 1 ImportHeadId from ZnodeImportHead where name = 'Synonyms'),'Synonym Template',null,null,1,2,getdate(),2,getdate()
where not exists(select * from ZnodeImportTemplate where ImportHeadId = (select top 1 ImportHeadId from ZnodeImportHead where name = 'Synonyms')
	and TemplateName = 'Synonym Template' )

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template'),
'CatalogCode' SourceColumnName,'CatalogCode' TargetColumnName,0 DisplayOrder,1 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template') 
	AND SourceColumnName ='CatalogCode')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template'),
'SynonymCode' SourceColumnName,'SynonymCode' TargetColumnName,0 DisplayOrder,1 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template') 
	AND SourceColumnName ='SynonymCode')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template'),
'RenameSynonymCode' SourceColumnName,'RenameSynonymCode' TargetColumnName,0 DisplayOrder,1 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template') 
	AND SourceColumnName ='RenameSynonymCode')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template'),
'OriginalTerm' SourceColumnName,'OriginalTerm' TargetColumnName,0 DisplayOrder,1 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template') 
	AND SourceColumnName ='OriginalTerm')

INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template'),
'ReplacedBy' SourceColumnName,'ReplacedBy' TargetColumnName,0 DisplayOrder,1 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template') 
	AND SourceColumnName ='ReplacedBy')
	
INSERT ZnodeImportTemplateMapping(ImportTemplateId,SourceColumnName,TargetColumnName,DisplayOrder,IsActive,IsAllowNull,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT (select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template'),
'IsBidirectional' SourceColumnName,'IsBidirectional' TargetColumnName,0 DisplayOrder,1 IsActive, 0 IsAllowNull,2 CreatedBy,GETDATE() CreatedDate,2 ModifiedBy,GETDATE() ModifiedDate
WHERE NOT EXISTS(SELECT * FROM ZnodeImportTemplateMapping WHERE ImportTemplateId=(select Top 1 ImportTemplateId from ZnodeImportTemplate where TemplateName = 'Synonym Template') 
	AND SourceColumnName ='IsBidirectional')


insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','CatalogCode',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),1
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'CatalogCode' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms')
	  and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','SynonymCode',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms'),1,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),2
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'SynonymCode' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms')
	  and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','RenameSynonymCode',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),3
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'RenameSynonymCode' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms')
	  and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','OriginalTerm',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms'),1,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),4
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'OriginalTerm' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms')
	  and ValidationName = 'RegularExpression')

insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','ReplacedBy',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),5
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'ReplacedBy' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms')
	  and ValidationName = 'RegularExpression')


insert into ZnodeImportAttributeValidation(AttributeTypeName,AttributeCode,ImportHeadId,IsRequired,ControlName,ValidationName,SubValidationName
,ValidationValue,RegExp,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SequenceNumber)
select 'Text','IsBidirectional',(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms'),0,'Text','RegularExpression',
null,'','',null,2,getdate(),2,getdate(),6
where not exists(select * from ZnodeImportAttributeValidation where AttributeTypeName ='Text' and AttributeCode = 'IsBidirectional' 
      and ControlName = 'Text' and ImportHeadId=(select Top 1 ImportHeadId from ZnodeImportHead where Name = 'Synonyms')
	  and ValidationName = 'RegularExpression')

GO

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 95,'Text','Input must include any existing Catalog Code as the value.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 95)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 96,'Text','Input must not include any existing Synonym Code as the value.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 96)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 97,'Text','Input must not exceed the maximum value limit of 20.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 97)

GO

IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'SynonymCode' AND TABLE_NAME = 'ZnodeSearchSynonyms')
BEGIN
	UPDATE ZnodeSearchSynonyms SET SynonymCode = SearchSynonymsId WHERE SynonymCode IS NULL
END
GO
IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'SynonymCode' AND TABLE_NAME = 'ZnodeSearchSynonyms')
BEGIN
	ALTER TABLE ZnodeSearchSynonyms ALTER COLUMN SynonymCode NVARCHAR(100) NOT NULL
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = isnull(c.CatalogCode,'')) AND ISNULL(ii.RenameSynonymCode,'') = '' 

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	--SELECT '79', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	--FROM @InsertSearchSynonyms AS ii
	--WHERE (isnull(ii.SynonymCode,'') NOT LIKE '%[^a-zA-Z0-9]%')
	--AND NOT EXISTS (SELECT 1 FROM ZnodeImportLog WHERE ColumnName = 'SynonymCode')

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''

	--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	--SELECT '79', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	--FROM @InsertSearchSynonyms AS ii
	--WHERE (isnull(ii.RenameSynonymCode,'') NOT LIKE '%[^a-zA-Z0-9]%') and isnull(ii.RenameSynonymCode,'') <> ''
		
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False','Yes','No') AND ii.IsBidirectional <> ''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, A.IsBidirectional, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode)
		
	--Update existing search synonym
	UPDATE ZSS 
	SET ZSS.SynonymCode = IPS.RenameSynonymCode, ZSS.OriginalTerm = CASE WHEN ISNULL(IPS.OriginalTerm,'') = '' THEN ZSS.OriginalTerm ELSE IPS.OriginalTerm END,
	ZSS.ReplacedBy =CASE WHEN ISNULL(IPS.ReplacedBy,'') = '' THEN ZSS.ReplacedBy ELSE IPS.ReplacedBy END,
	ZSS.IsBidirectional= CASE WHEN ISNULL (IPS.IsBidirectional,'') = '' THEN ZSS.IsBidirectional ELSE IPS.IsBidirectional END,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
	WHERE ISNULL(IPS.RenameSynonymCode,'') <> ''

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO

update ZnodeImportAttributeValidation 
set IsRequired = 0 where ImportHeadId = (select ImportHeadId from ZnodeImportHead where Name = 'Synonyms') 
and AttributeCode = 'OriginalTerm'

GO

insert into ZnodeApplicationSetting(GroupName,ItemName,Setting,ViewOptions,FrontPageName,FrontObjectName,IsCompressed,OrderByFields,
ItemNameWithoutCurrency,CreatedByName,ModifiedByName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 'Table', 'ZnodeAccountUserForWebstore','<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>FullName</name>      <headertext>Full Name</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>AccountId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>AccountId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Full Name</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>UserName</name>      <headertext>Username</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>AccountId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>AccountId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>Email</name>      <headertext>Email Address</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>AccountId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>AccountId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Email Address</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>RoleName</name>      <headertext>Role</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>AccountId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>AccountId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Role</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>Manage</name>      <headertext>Order History</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>View</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/User/AccountOrders</manageactionurl>      <manageparamfield>userId,accountId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>false</allowpaging>      <format>Disable|Reset</format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>AccountId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>AccountId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Disable|Reset</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/User/EnableDisableAccountUsers|/User/AccountResetPassword</manageactionurl>      <manageparamfield>AccountId,UserId,IsLock|UserId</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>grid-action</Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>',
'ZnodeAccountUserForWebstore','ZnodeAccountUserForWebstore','ZnodeAccountUserForWebstore',0,null,null,null,null,2,getdate(),2,getdate()
where not exists(select * from ZnodeApplicationSetting where ItemName = 'ZnodeAccountUserForWebstore')

insert into ZnodeApplicationSetting(GroupName,ItemName,Setting,ViewOptions,FrontPageName,FrontObjectName,IsCompressed,OrderByFields,
ItemNameWithoutCurrency,CreatedByName,ModifiedByName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 'Table', 'ZnodeAccountOrderForWebstore','<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OrderNumber</name><headertext>Order Number</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/OrderReceipt</islinkactionurl><islinkparamfield>OmsOrderId,portalId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>UserName</name><headertext>Username</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OrderState</name><headertext>Order Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>PaymentStatus</name><headertext>Payment Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>paymentStatus</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PaymentDisplayName</name><headertext>Payment Type</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>OrderTotalWithCurrency</name><headertext>Order Amount</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>OrderDate</name><headertext>Order Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/OrderReceipt</manageactionurl><manageparamfield>OmsOrderId,portalId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>',
'ZnodeAccountOrderForWebstore','ZnodeAccountOrderForWebstore','ZnodeAccountOrderForWebstore',0,null,null,null,null,2,getdate(),2,getdate()
where not exists(select * from ZnodeApplicationSetting where ItemName = 'ZnodeAccountOrderForWebstore')

GO

Update ZnodeApplicationSetting
set Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>SearchSynonymsId</name><headertext>Checkbox</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>SearchSynonymsId</name><headertext>ID</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl>/SearchConfiguration/EditSearchSynonyms</islinkactionurl><islinkparamfield>searchSynonymsId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>SynonymCode</name><headertext>Synonym Code</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>OriginalTerm</name><headertext>Original Term</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ReplacedBy</name><headertext>Replaced By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>IsBidirectional</name><headertext>Is Bidirectional</headertext><width>60</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SearchConfiguration/EditSearchSynonyms|/SearchConfiguration/DeleteSearchSynonyms</manageactionurl><manageparamfield>searchSynonymsId|searchSynonymsId,PublishCatalogId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeSearchSynonymsList'

GO

update ZnodeApplicationSetting 
set Setting= '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OrderNumber</name><headertext>Order/InvoiceNumber</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>FailedOrderTotalWithCurrency</name><headertext>OrderTotal</headertext><width>30</width><datatype>String</datatype><columntype>Decimal</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OrderDate</name><headertext>Order/TransactionDate</headertext><width>0</width><datatype>DateTime</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>PaymentDisplayName</name><headertext>PaymentName</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PaymentStatus</name><headertext>PaymentStatus</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>TransactionToken</name><headertext>TransactionID</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>UserName</name><headertext>CustomerName</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Email</name><headertext>EmailAddress</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
  where ItemName='ZnodeOmsFailedOrderPayments';

GO

Update ZnodeApplicationSetting
set Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>SearchSynonymsId</name><headertext>Checkbox</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>SearchSynonymsId</name><headertext>ID</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl>/SearchConfiguration/EditSearchSynonyms</islinkactionurl><islinkparamfield>searchSynonymsId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>SynonymCode</name><headertext>Synonym Code</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>OriginalTerm</name><headertext>Original Term</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>ReplacedBy</name><headertext>Replaced By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>IsBidirectional</name><headertext>Is Bidirectional</headertext><width>60</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SearchConfiguration/EditSearchSynonyms|/SearchConfiguration/DeleteSearchSynonyms</manageactionurl><manageparamfield>searchSynonymsId|searchSynonymsId,PublishCatalogId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeSearchSynonymsList'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetConfigurableVariantData')
	DROP PROC Znode_GetConfigurableVariantData
GO

CREATE PROCEDURE [dbo].[Znode_GetConfigurableVariantData]
(   
	@PortalId         INT,
	@UserId			  INT = 2,
	@catalogVersionId int, 
	@currentUtcDate    VARCHAR(200) = '',
	@publishProductId   int

)

AS 
     BEGIN
         BEGIN TRY
		  DECLARE @PublishProductIds  NVARCHAR(max) ,@SKU NVARCHAR(max) 
	
		       CREATE TABLE #Tlb_ProductData 
				(
				  ZnodeProductId INT,
				  SKU              NVARCHAR(100),
				  Name NVARCHAR(100),
				  Attributes nvarchar(max),
				  IsActive bit,
				  AssociatedProductDisplayOrder int,
				  ConfigurableAttributeCodes nvarchar(max)
			     );
				Create TABLE #Tbl_PriceList
                (
				  SKU            VARCHAR(300),
				  RetailPrice    NUMERIC(28, 6),
				  SalesPrice     NUMERIC(28, 6),
				  TierPrice      NUMERIC(28, 6),
				  TierQuantity   NUMERIC(28, 6),
				  CurrencyCode   Varchar(100),
				  CurrencySuffix Varchar(1000),
				  CultureCode      VARCHAr(1000),
				  ExternalId NVARCHAR(2000),
				  Custom1        NVARCHAR(MAX),
				  Custom2        NVARCHAR(MAX),
				  Custom3        NVARCHAR(MAX)
                );

				Create TABLE #Tbl_Inventory
				(
				  SKU            VARCHAR(300),
				  Quantity    NUMERIC(28, 6),
				  ReOrderLevel     NUMERIC(28, 6),
				  PortalId      int,
				  WarehouseName	varchar(100),
			      WarehouseCode	varchar(100),
			      DefaultInventoryCount varchar(1000),
				
			    );

				 insert into #Tlb_ProductData (ZnodeProductId, SKU, Name, Attributes, IsActive, AssociatedProductDisplayOrder,ConfigurableAttributeCodes)
				 select DISTINCT ZPE.ZnodeProductId, ZPE.SKU, ZPE.Name,zpe.Attributes, zpe.IsActive, ZPCE.AssociatedProductDisplayOrder, ZPCE.ConfigurableAttributeCodes from ZnodePublishProductEntity as ZPE
				 inner join ZnodePublishConfigurableProductEntity as ZPCE on ZPCE.AssociatedZnodeProductId = ZPE.ZnodeProductId
				 where ZPCE.ZnodeProductId = @publishProductId and ZPCE.VersionId = @catalogVersionId and ZPE.VersionId = @catalogVersionId and ZPE.IsActive = 1

				SELECT @SKU = Substring((SELECT ',' + SKU FROM #Tlb_ProductData FOR XML PAth('')), 2, 4000)

				INSERT INTO #Tbl_PriceList( SKU, RetailPrice,SalesPrice,TierPrice,TierQuantity,CurrencyCode,CurrencySuffix,CultureCode,ExternalId,Custom1,Custom2,Custom3)
				EXEC Znode_GetPublishProductPricingBySku @SKU = @SKU ,@PortalId = @PortalId ,@currentUtcDate = @currentUtcDate,@UserId = @UserId
		
				insert into #Tbl_Inventory (SKU,	Quantity,	ReOrderLevel,	PortalId, WarehouseName, WarehouseCode, DefaultInventoryCount)
				EXEC Znode_GetInventoryBySkus @SKUs=@SKU,@PortalId=@PortalId

				select DISTINCT PD.ZnodeProductId AS PublishProductId, PD.SKU, PD.Name,PD.Attributes, PD.IsActive, PD.AssociatedProductDisplayOrder,PD.ConfigurableAttributeCodes,
				pl.RetailPrice, pl.SalesPrice, pl.CultureCode, pl.CurrencySuffix, tl.Quantity, tl.ReOrderLevel, tl.DefaultInventoryCount, tl.WarehouseName
				from #Tlb_ProductData as PD 
				left join #Tbl_PriceList as PL on pd.SKU = pl.SKU
				left join #Tbl_Inventory as TL on pd.SKU = tl.sku
		END TRY 
			

		 BEGIN CATCH

		 	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
			@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetConfigurableVariantData
			@PortalId = '+CAST(@PortalId AS int)+',
			@UserId='+CAST(@UserId AS int)+',
			@catalogVersionId='+CAST(@catalogVersionId AS int)+',
			@currentUtcDate='+CAST(@currentUtcDate AS VARCHAR(200))+',
			@publishProductId='+CAST(@publishProductId AS int);

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetConfigurableVariantData',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
		  END CATCH
	End

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = isnull(c.CatalogCode,'')) AND ISNULL(ii.RenameSynonymCode,'') = '' 

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	--SELECT '79', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	--FROM @InsertSearchSynonyms AS ii
	--WHERE (isnull(ii.SynonymCode,'') NOT LIKE '%[^a-zA-Z0-9]%')
	--AND NOT EXISTS (SELECT 1 FROM ZnodeImportLog WHERE ColumnName = 'SynonymCode')

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''

	--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	--SELECT '79', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	--FROM @InsertSearchSynonyms AS ii
	--WHERE (isnull(ii.RenameSynonymCode,'') NOT LIKE '%[^a-zA-Z0-9]%') and isnull(ii.RenameSynonymCode,'') <> ''
		
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False','Yes','No') AND ii.IsBidirectional <> ''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, CASE WHEN A.IsBidirectional = 'YES' THEN '1' WHEN A.IsBidirectional = 'NO' THEN '0' END, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode)
		
	--Update existing search synonym
	UPDATE ZSS 
	SET ZSS.SynonymCode = IPS.RenameSynonymCode, ZSS.OriginalTerm = CASE WHEN ISNULL(IPS.OriginalTerm,'') = '' THEN ZSS.OriginalTerm ELSE IPS.OriginalTerm END,
	ZSS.ReplacedBy =CASE WHEN ISNULL(IPS.ReplacedBy,'') = '' THEN ZSS.ReplacedBy ELSE IPS.ReplacedBy END,
	ZSS.IsBidirectional= CASE WHEN ISNULL (IPS.IsBidirectional,'') = '' THEN ZSS.IsBidirectional ELSE CASE WHEN IPS.IsBidirectional = 'YES' THEN '1' WHEN IPS.IsBidirectional = 'NO' THEN '0' END END,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
	WHERE ISNULL(IPS.RenameSynonymCode,'') <> ''

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO

Update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>FullName</name><headertext>Full Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Full Name</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>UserName</name><headertext>Username</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Email</name><headertext>Email Address</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Email Address</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>RoleName</name><headertext>Role</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Role</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>Manage</name><headertext>Order History</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/AccountOrders</manageactionurl><manageparamfield>userId,accountId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Disable|Reset</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>y</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Disable|Reset</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/EnableDisableAccountUsers|/User/AccountResetPassword</manageactionurl><manageparamfield>AccountId,UserId,IsLock|UserId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>grid-action</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeAccountUserForWebstore'

Update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OrderNumber</name><headertext>Order Number</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/OrderReceiptForWebstore</islinkactionurl><islinkparamfield>OmsOrderId,portalId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>UserName</name><headertext>Username</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OrderState</name><headertext>Order Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>PaymentStatus</name><headertext>Payment Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>paymentStatus</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PaymentDisplayName</name><headertext>Payment Type</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>OrderTotalWithCurrency</name><headertext>Order Amount</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>OrderDate</name><headertext>Order Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/OrderReceiptForWebstore</manageactionurl><manageparamfield>OmsOrderId,portalId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeAccountOrderForWebstore'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemConfigurable]
(
	 @SaveCartLineItemType TT_SavecartLineitems READONLY
	,@Userid INT = 0 
	,@OrderLineItemRelationshipTypeIdConfigurable INT
	,@OrderLineItemRelationshipTypeIdAddon INT	
)
AS 
BEGIN 
	BEGIN TRY
	SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 

	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT, OmsSavedCartId INT,SKU NVARCHAr(max),GroupId NVARCHAr(max),ParentOmsSavedCartLineItemId INT,OrderLineItemRelationshipTypeId INT ) 
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,ConfigurableProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.ConfigurableProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)

	 CREATE TABLE #NewConfigSavecartLineitemDetails 
	 (
		 GenId INT IDENTITY(1,1), RowId	INT, OmsSavedCartLineItemId	INT, ParentOmsSavedCartLineItemId INT,OmsSavedCartId INT
		,SKU NVARCHAR(MAX) ,Quantity	NUMERIC(28,6), OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX), Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(configurable product)
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5, GroupId ,ProductName,MIN(Description) Description, 0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new configurable product save cart data
	INSERT INTO #NewConfigSavecartLineitemDetails 
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
		,Quantity, @OrderLineItemRelationshipTypeIdConfigurable, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU
	FROM @SaveCartLineItemType a 
	WHERE ConfigurableProductIds <> ''
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
		,Quantity, CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	--Getting new configurable products save cart data if addon is present for any line item
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> '' THEN ConfigurableProductIds
			WHEN GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END ParentSKU 
	FROM @SaveCartLineItemType a 
	WHERE AddOnValueIds <> ''
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 
	SELECT * 
	INTO #ZnodeOmsSavedCartLineItem_NT
	FROM ZnodeOmsSavedCartLineItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId)

	CREATE TABLE #OldConfigSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU NVARCHAr(2000),OrderLineItemRelationshipTypeID INT )
	--Getting the old configurable save cart data if present for same SKU in the new save cart data for configurable product	 
	INSERT INTO #OldConfigSavecartLineitemDetails
	SELECT a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU ,a.OrderLineItemRelationshipTypeID 
	FROM #ZnodeOmsSavedCartLineItem_NT a
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.ConfigurableProductIds,''))
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable

	--Getting the old save cart Parent data
	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-') )
		AND b.OrderLineItemRelationshipTypeID IS NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldConfigSavecartLineitemDetails

	DELETE a 
	FROM #OldConfigSavecartLineitemDetails a 
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		
	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN		
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
		FROM #ZnodeOmsSavedCartLineItem_NT b 
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT DISTINCT SKU, STUFF(
									( SELECT ', ' + SKU FROM
										( SELECT DISTINCT SKU FROM #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId AND OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a
		WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL AND OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.ConfigurableProductIds SKU, STUFF(
										( SELECT ', ' + x.AddOnValueIds FROM
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b ON a.SKU = b.SKU AND a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldConfigSavecartLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldConfigSavecartLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		DELETE FROM #OldConfigSavecartLineitemDetails 
	END
	ELSE 
	BEGIN
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		 BEGIN 
			 DECLARE @parenTofAddon TABLE( ParentOmsSavedCartLineItemId INT)
			 INSERT INTO @parenTofAddon 
			 SELECT ParentOmsSavedCartLineItemId 
			 FROM #OldConfigSavecartLineitemDetails a 
			 WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
				AND (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsSavedCartLineItem_NT t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon)

			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)
				AND ParentOmsSavedCartLineItemId IS NOT NULL 
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL 
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsSavedCartLineItem_NT WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
			-- SELECT 3
			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )

			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM #ZnodeOmsSavedCartLineItem_NT a
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

			DELETE 
			FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 
			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL
		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
		 BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 
		 ELSE IF EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItem_NT Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') = '' )
		 BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 
	END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present		
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		 DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			 SELECT OmsSavedCartLineItemId 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
				 OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
			 DELETE n
			 FROM #OldConfigSavecartLineitemDetails n 
			 WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem )
	
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
			 AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldConfigSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
		END 
	END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails )
	BEGIN
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.ConfigurableProductIds AS SKU
					,a.PersonalizeCode
			 		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		 
		INNER JOIN #OldConfigSavecartLineitemDetails b1 ON a1.SKU = b1.SKU
		INNER JOIN #OldConfigSavecartLineitemDetails c1 ON (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId AND a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		FROM CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldConfigSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldConfigSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldConfigSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate 
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewConfigSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon
		 
		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S ON a.OmsSavedCartId = s.OmsSavedCartId AND a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewConfigSavecartLineitemDetails N
	LEFT JOIN #OldConfigSavecartLineitemDetails O ON N.OmsSavedCartId=O.OmsSavedCartId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			 ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon 
			 ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description ,ParentSKU 
		INTO #InsertNewConfigSavecartLineitem 
		FROM #NewConfigSavecartLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId)
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails ,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU 
		ORDER BY RowId, Id 
 	 
		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewConfigSavecartLineitem 
		WHERE Quantity <=0 
 
		--Updating the rowid INTo new save cart line item as new line item is merged INTo existing save cart item
		 ;WITH VTTY AS 
		( 
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU 
			FROM #InsertNewConfigSavecartLineitem m 
			INNER JOIN #InsertNewConfigSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU 
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
		) 
		UPDATE m1 
		SET m1.RowId = TYU.RowId 
		FROM #InsertNewConfigSavecartLineitem m1 
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId) 
 
		;WITH VTRET AS 
		( 
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM #InsertNewConfigSavecartLineitem 
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			Having SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		) 
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET) 
 
	 --Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,Sequence,	CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description) 
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.OmsSavedCartId,inserted.SKU,inserted.GroupId,INSERTED.ParentOmsSavedCartLineItemId,INSERTED.OrderLineItemRelationshipTypeId INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId) sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description 
		FROM #InsertNewConfigSavecartLineitem TH 

		SELECT MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			 
	
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM #Cte_newData r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND a.ParentOmsSavedCartLineItemId IS nULL 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )

	---------------------------------------------------------------------------------------------------------------------

		SELECT MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData1 
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM #Cte_newData1 r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND a.sequence in (SELECT MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId AND 
			a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null ) 
 
	---------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId ,b.SKU ,b.ParentSKU ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewConfigProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1 )) 
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) ON b.sku = c.sku AND b.OmsSavedCartId=c.OmsSavedCartId AND b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0 )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) AND c.ParentOmsSavedCartLineItemId is null
 
		 ;WITH table_update AS 
		 (
			 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId ) RowIdNo
			 FROM ZnodeOmsSavedCartLineItem a with (nolock)
			 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND a.ParentOmsSavedCartLineItemId IS NULL 
			 AND EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			 AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		 )
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) 
		FROM table_update a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND b.id =1 ) 
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) IS nOT NULL 

		;WITH Cte_Th AS 
		( 
			 SELECT RowId 
			 FROM #InsertNewConfigSavecartLineitem a 
			 GROUP BY RowId 
			 HAVING COUNT(NewRowId) <= 1 
		) 
		UPDATE a 
		SET a.Quantity = NULL,a.ModifiedDate = @GetDate 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0) 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_Th TY WHERE TY.RowId = b.RowId ) 
			AND a.OrderLineItemRelationshipTypeId IS NULL 
 
		UPDATE ZnodeOmsSavedCartLineItem 
		SET GROUPID = NULL 
		WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId ) 
		AND OrderLineItemRelationshipTypeId IS NOT NULL 
 
		;WITH Cte_UpdateSequence AS 
		( 
			 SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence 
			 FROM ZnodeOmsSavedCartLineItem 
			 WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId ) 
		) 
		UPDATE Cte_UpdateSequence 
		SET Sequence = RowId 

		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b with (nolock) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL 
	
		DELETE 
		FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
		
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			 ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			 WHEN NOT MATCHED THEN 
				INSERT ( OmsSavedCartLineItemId, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES ( SOURCE.OmsSavedCartLineItemId, @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	END
	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemGroup]
(
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdGroup INT
	,@OrderLineItemRelationshipTypeIdAddon INT
)
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
	
	DECLARE @OmsInsertedData TABLE (SKU varchar(600),OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,GroupProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.GroupProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	CREATE TABLE #NewGroupSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT ,OmsSavedCartLineItemId	INT,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	int
		,SKU	NVARCHAR(MAX) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	INT ,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT ,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT ,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(group product)
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new group product save cart data
	INSERT INTO #NewGroupSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdGroup, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU  
	FROM @SaveCartLineItemType  a 
	WHERE GroupProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
		,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		
	--Getting new group products save cart data if addon is present for any line item
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 

	CREATE TABLE #OldGroupSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old group save cart data if present for same SKU in the new save cart data for group product	 	 
	INSERT INTO #OldGroupSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.GroupProductIds,'')   )   
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup   

	--Getting the old save cart Parent data
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
		AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldGroupSavecartLineitemDetails

	DELETE a FROM #OldGroupSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldGroupSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old config product save cart addon data for old line items if present
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.GroupProductIds SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldGroupSavecartLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldGroupSavecartLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN
		DELETE FROM #OldGroupSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails a
			WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t with (nolock) WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldGroupSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS  NULL  

			IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSavecartLineitemDetails
			END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem with (nolock)  WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSavecartLineitemDetails
			END
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 
			-- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup  )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL
		END
		ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails
		END 
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails
		END  
	END

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present	
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN
		DELETE FROM #OldGroupSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId IN (
				SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues)) 
				OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
				(SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails)  )
		BEGIN
			DELETE n 
			FROM #OldGroupSavecartLineitemDetails n 
			WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldGroupSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	END
	
	IF EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails)
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
					INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
					where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
			a.PersonalizeCode
			,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU)
			where isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.GroupProductIds
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldGroupSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.GroupProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldGroupSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldGroupSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
				--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			WHERE ISNULL(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldGroupSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldGroupSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
			a.Custom1 = ty.Custom1,
			a.Custom2 = ty.Custom2,
			a.Custom3 = ty.Custom3,
			a.Custom4 = ty.Custom4,
			a.Custom5 = ty.Custom5,
			a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewGroupSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		UPDATE a
		SET a.Quantity = a.Quantity+s.AddOnQuantity,
			a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewGroupSavecartLineitemDetails N
	LEFT JOIN #OldGroupSavecartLineitemDetails O ON N.OmsSavedCartId=O.OmsSavedCartId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		SELECT RowId, Id ,Row_number()Over(ORDER BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewId() ) Sequence ,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewGroupSavecartLineitem   
		FROM #NewGroupSavecartLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId) OR ParentSKU IS NULL
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id

		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewGroupSavecartLineitem
		WHERE Quantity <=0
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS
		(
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU
			FROM #InsertNewGroupSavecartLineitem m
			INNER JOIN  #InsertNewGroupSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		)
		UPDATE m1   
		SET m1.RowId = TYU.RowId
		FROM #InsertNewGroupSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  

		;WITH VTRET AS   
		(
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU, OrderLineItemRelationshipTypeId 
			FROM #InsertNewGroupSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeId
			HAVING SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)
		DELETE 
		FROM #InsertNewGroupSavecartLineitem 
		WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.SKU,INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewGroupSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO  #Cte_newData
		FROM ZnodeOmsSavedCartLineItem a  with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS nULL   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
  
		-----------------------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData1
		FROM ZnodeOmsSavedCartLineItem a with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId and 
				a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		----------------------------------------------------------------------------------------------------------------------------

		SELECT DISTINCT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  --,Row_number()Over(ORDER BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #Cte_newAddon1
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) and c.ParentOmsSavedCartLineItemId is null

		-- Added to get distinct records.
		SELECT *,ROW_NUMBER()OVER(ORDER BY OmsSavedCartLineItemId) RowIdNo 
		INTO #Cte_newAddon 
		FROM #Cte_newAddon1

		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(ORDER BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
				AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
				AND a.ParentOmsSavedCartLineItemId IS NULL  
				AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
				AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		)
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #Cte_newAddon  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId)  FROM #Cte_newAddon  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewGroupSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		 )
		UPDATE a 
		SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewGroupSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
			AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(ORDER BY OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewGroupSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.GroupProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b WITH (NOLOCK) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL  

		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	END 

	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetGiftCardList')
	DROP PROC Znode_GetGiftCardList
GO

CREATE PROCEDURE [dbo].[Znode_GetGiftCardList]
(
	@WhereClause	NVARCHAR(MAX),
	@Rows			INT            = 100,
	@PageNo			INT            = 1,
	@Order_BY		VARCHAR(1000)  = '',
	@RowsCount		INT  OUT,
	@PortalId		NVARCHAR(MAX),
	@ExpirationDate VARCHAR(100) = '',
	@SalesRepUserId INT = 0 
)
AS
/*
	Summary: This procedure is used to find the GiftCardList of user for portal
	Unit Testing:
	declare @aa int
	EXEC Znode_GetGiftCardList @WhereClause='Userid = 5 ' ,@PortalId ='1,2,3,4,6,7,9,10,1010,1011,1012,1013,1014,1015,1016,1020,1021,1023,1024,1025,1028,1029,1030',  @RowsCount= 0,@ExpirationDate = '2017-04-06'  

	EXEC Znode_GetGiftCardList @WhereClause='' ,@PortalId ='1', @RowsCount= 0,@ExpirationDate = '' ,@SalesRepUserId=2
*/
BEGIN
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @SQL NVARCHAR(MAX);
		DECLARE @TBL_GiftCardList TABLE 
		(StoreName NVARCHAR(MAX),Name NVARCHAR(600), CardNumber NVARCHAR(600),CreatedDate DATETIME,StartDate DATETIME,
			ExpirationDate DATETIME,Amount NUMERIC(28,6),RemainingAmount NUMERIC(28,6),CustomerId INT,
			CustomerName NVARCHAR(512),AccountName NVARCHAR(512),IsActive BIT ,GiftCardId INT,UserId INT,CultureCode VARCHAR(100), 
			RowId INT, CountNo INT, AccountCode nvarchar(100)
		)
	
		----Verifying that the @SalesRepUserId is having 'Sales Rep' role
		IF NOT EXISTS
		(
			SELECT * FROM ZnodeUser ZU
			INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
			INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
			INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
			Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
			AND ZU.UserId = @SalesRepUserId
		)
		Begin
			SET @SalesRepUserId = 0
		End

		SET @SQL ='  
		  DECLARE @TBL_PortalId TABLE (PortalId INT)  
					  INSERT INTO @TBL_PortalId    
		  SELECT  ITEM  FROM dbo.split( '''+@PortalId+''','','') AS a;   

		  ;WITH CTE_GetGiftCard AS  
		  (  
		  SELECT ZP.StoreName,ZGC.Name,CardNumber,ZGC.CreatedDate,StartDate, ExpirationDate,Amount,RemainingAmount,ZGC.UserId AS CustomerId,  
		  CASE WHEN ZU.FirstName IS NULL THEN '''' ELSE ZU.FirstName END + CASE WHEN ZU.LastName IS NULL  THEN '''' ELSE '' ''+ZU.LastName END as CustomerName,ZA.Name As AccountName,ZGC.IsActive  
		  ,GiftCardId, ZU.UserId,IsReferralCommission,zc.CultureCode AS CurrencyCode, ZA.AccountCode
		  FROM ZnodeGiftCard ZGC   
		  INNER JOIN ZnodePortal ZP ON (ZGC.PortalId = ZP.PortalId)  
		  INNER JOIN ZnodePortalUnit zpu on (zp.PortalId = zpu.PortalId)  
		  LEFT JOIN ZnodeCulture zc on (zc.CultureId = zpu.CultureId)  
		  LEFT JOIN ZnodeUser ZU ON (ZU.UserId = ZGC.UserId)  
		  LEFT JOIN ZnodeAccount ZA ON (ZA.AccountId= ZU.AccountId)
		  LEFT JOIN @TBL_PortalId TP ON (TP.PortalId = ZGC.PortalId)  
		  WHERE ((CONVERT(date,''' +@ExpirationDate+''' ) <= CONVERT(DATE,ZGC.ExpirationDate) OR ZGC.ExpirationDate IS  NULL)  OR '''+@ExpirationDate+''' = '''') AND ZGC.PortalId in ('+@PortalId+') 
		  and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where (SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZGC.UserId = SalRep.CustomerUserid)) or ZGC.createdby= ' + cast(@SalesRepUserId as varchar(10)) + ' or '+cast(@SalesRepUserId as varchar(10))+' = 0)
		  )  
		  , CTE_GetGiftCardList AS  
		  (  
		  SELECT StoreName,Name,CardNumber,CreatedDate,StartDate,ExpirationDate,Amount,RemainingAmount,CustomerId,CustomerName,AccountName,IsActive,GiftCardId,UserId,CurrencyCode, AccountCode, 
		  '+dbo.Fn_GetPagingRowId(@Order_BY,'GiftCardId DESC')+',Count(*)Over() CountNo   
		  FROM CTE_GetGiftCard  
		  WHERE 1=1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+'       
		  )  

		  SELECT StoreName,Name,CardNumber,CreatedDate,StartDate,ExpirationDate,Amount,RemainingAmount,CustomerId,CustomerName,AccountName,IsActive,GiftCardId,UserId,CurrencyCode,RowId,CountNo, AccountCode  
		  FROM CTE_GetGiftCardList
		  '+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)

		INSERT INTO @TBL_GiftCardList
		EXEC(@SQL)

		SET @RowsCount =ISNULL((SELECT TOP 1 CountNo FROM @TBL_GiftCardList ),0)

		SELECT StoreName,Name,CardNumber,CreatedDate,StartDate,ExpirationDate,Amount,RemainingAmount,CustomerId,CustomerName,AccountName,IsActive,GiftCardId,UserId,CultureCode, AccountCode 
		FROM @TBL_GiftCardList
	END TRY
	BEGIN CATCH
		DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),  
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetGiftCardList @WhereClause = '+CAST(@WhereClause AS VARCHAR(MAX))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@PortalId='+@PortalId+',@ExpirationDate='+CAST(@ExpirationDate AS VARCHAR(50))+'@Status='+CAST(@Status AS VARCHAR(10));  

		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetGiftCardList',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH
END

GO

Update ZnodeApplicationSetting
set Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OrderNumber</name><headertext>Order Number</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/OrderReceipt</islinkactionurl><islinkparamfield>OmsOrderId,portalId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>UserName</name><headertext>Username</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OrderState</name><headertext>Order Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>PaymentStatus</name><headertext>Payment Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>paymentStatus</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PaymentDisplayName</name><headertext>Payment Type</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>OrderTotalWithCurrency</name><headertext>Order Amount</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>OrderDate</name><headertext>Order Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/OrderReceipt</manageactionurl><manageparamfield>OmsOrderId,portalId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeAccountOrderForWebstore'

GO

Update ZnodeApplicationSetting
set Setting ='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>SearchSynonymsId</name><headertext>Checkbox</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>SynonymCode</name><headertext>Synonym Code</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OriginalTerm</name><headertext>Original Term</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>ReplacedBy</name><headertext>Replaced By</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>IsBidirectional</name><headertext>Is Bidirectional</headertext><width>60</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/SearchConfiguration/EditSearchSynonyms|/SearchConfiguration/DeleteSearchSynonyms</manageactionurl><manageparamfield>searchSynonymsId|searchSynonymsId,PublishCatalogId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeSearchSynonymsList'

GO

UPDATE ZnodeApplicationSetting 
SET Setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsOrderId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OrderNumber</name><headertext>Order No</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Order/Manage</islinkactionurl><islinkparamfield>OmsOrderId,accountId,updatePageType</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>UserName</name><headertext>Username</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>OrderState</name><headertext>Order Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PaymentStatus</name><headertext>Payment Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>paymentStatus</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>PaymentDisplayName</name><headertext>Payment Type</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>OrderTotalWithCurrency</name><headertext>Order Amount</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>OrderDate</name><headertext>Order Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>IsInRMA</name><headertext>IsInRMA</headertext><width>40</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>y</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>IsInRMA</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Guest User</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>IsInRMA</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View|shopping-cart</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View|Reorder</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Order/Manage|/Order/ReorderCompleteOrder</manageactionurl><manageparamfield>OmsOrderId,accountId,updatePageType|userId,portalId,omsOrderId,actionName,accountId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='AccountUserOrderList'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetHighlightDetail')
	DROP PROC Znode_GetHighlightDetail
GO

CREATE PROCEDURE [dbo].[Znode_GetHighlightDetail]
( 
	@WhereClause NVARCHAR(MAX),
	@Rows INT= 10,
	@PageNo INT= 1,
	@Order_BY VARCHAR(1000)= '',
	@RowsCount INT= 0 OUT,
	@LocaleId INT= 1,
	@IsFromAdmin BIT = 0,
    @IsAssociated BIT= 0,
    @Isdebug BIT= 0
)
AS
/*
	Summary :- This Procedure is used to get the highlights details
	Unit Testing
	begin tran
	EXEC Znode_GetHighlightDetail '',10,1,'',0,1,0
	rollback tran
*/
BEGIN
BEGIN TRY
SET NOCOUNT ON;

	DECLARE @DefaultLocaleId INT= dbo.Fn_GetDefaultLocaleId();
	DECLARE @SeoId VARCHAR(MAX)= '', @SQL NVARCHAR(MAX);

	DECLARE @TBL_HighlightsDetails TABLE
	(
		Description NVARCHAR(max),
		HighlightId INT,
		HighlightCode VARCHAR(600),
		HighlightType NVARCHAR(400),
		DisplayOrder INT,
		IsActive BIT,
		HighlightLocaleId INT,
		MediaPath NVARCHAR(MAX),
		MediaId INT,
		Hyperlink NVARCHAR(MAX),
		ImageAltTag NVARCHAR(4000),DisplayPopup BIT
	);
	--Get default attributeid for ProductHighlights
	DECLARE @AttributeId INT= [dbo].[Fn_GetProductHighlightsAttributeId]();
	DECLARE @TBL_AttributeDefault TABLE
	(
		PimAttributeId INT,
		AttributeDefaultValueCode varchar(600),
		IsEditable BIT,
		AttributeDefaultValue NVARCHAR(max),
		DisplayOrder INT
	);
   DECLARE @TBL_HighlightsDetail TABLE
	(
		Description NVARCHAR(max),
		HighlightId INT,
		HighlightCode varchar(600),
		HighlightType NVARCHAR(400),
		DisplayOrder INT,
		IsActive BIT,
		HighlightLocaleId INT,
		MediaPath NVARCHAR(max),
		MediaId INT,
		Hyperlink NVARCHAR(max),
		ImageAltTag NVARCHAR(4000),DisplayPopup BIT,
		HighlightName NVARCHAR(max),
		RowId INT,
		CountId INT
	);

	INSERT INTO @TBL_AttributeDefault
	EXEC Znode_GetAttributeDefaultValueLocale @AttributeId, @LocaleId;

	SET @WhereClause = ' '+@WhereClause+
		CASE WHEN @IsAssociated = 1 THEN 
			CASE WHEN @WhereClause = '' THEN ' ' ELSE ' AND 'END
			+' EXISTS ( SELECT TOP 1 1
				FROM ZnodePimAttributeValue ZAV
				INNER JOIN ZnodePimAttribute ZA ON (ZA.PimAttributeId = ZAV.PimAttributeId AND ZA.AttributeCode = ''Highlights'')
				INNER JOIN ZnodePimProductAttributeDefaultValue ZAVL ON (ZAV.PimAttributeValueId= ZAVL.PimAttributeValueId )
				INNER JOIN ZnodePimAttributeDefaultValue ZADVL ON (ZAVL.PimAttributeDefaultValueId = ZADVL.PimAttributeDefaultValueId)
				WHERE ( ZADVL.AttributeDefaultValueCode = TMADV.AttributeDefaultValueCode))'
			ELSE CASE WHEN @WhereClause = '' THEN ' 1 = 1  ' ELSE '' END
		END;

	CREATE TABLE #Cte_GetHighlightsBothLocale (RowId INT, Description NVARCHAR(MAX), HighlightId INT, LocaleId INT,HighlightCode VARCHAR(600),HighlightType NVARCHAR(400), DisplayOrder INT, IsActive BIT, HighlightLocaleId INT, MediaPath VARCHAR(1000),MediaId INT, Hyperlink NVARCHAR(MAX),ImageAltTag NVARCHAR(400),DisplayPopup BIT)
	
	--For @IsFromAdmin = 1 getting media from highlight table
	IF @IsFromAdmin = 1
	BEGIN
		INSERT INTO #Cte_GetHighlightsBothLocale(RowId , Description , HighlightId , LocaleId ,HighlightCode ,HighlightType , DisplayOrder , IsActive , HighlightLocaleId , MediaPath ,MediaId , Hyperlink ,ImageAltTag ,DisplayPopup)
		SELECT Row_Number()Over( PARTITION BY   ZH.HighlightCode ORDER BY ZH.MediaId desc) RowId, ZHL.Description, ZH.HighlightId, LocaleId, ZH.HighlightCode,ZPHT.Name HighlightType , ZADV.DisplayOrder, ZH.IsActive, ZHL.HighlightLocaleId, [dbo].[Fn_GetMediaThumbnailMediaPath]( Zm.path ) AS MediaPath
			, ZH.MediaId, Hyperlink,ImageAltTag,DisplayPopup
		FROM ZnodeHighlight AS ZH
		LEFT JOIN ZnodePimAttributeDefaultValue ZADV on ZADV.AttributeDefaultValueCode =ZH.HighlightCode
		LEFT JOIN  ZnodeHighlightLocale AS ZHL ON(ZHL.HighlightId = ZH.HighlightId)  
		LEFT JOIN ZnodeMedia AS ZM ON(ZM.MediaId = ZH.MediaId)
		LEFT JOIN ZnodeHighLightType ZPHT ON (ZPHT.HighlightTypeId = ZH.HighlightTypeId)  
		WHERE LocaleId IN ( @LocaleId, @DefaultLocaleId )
	END
	ELSE
	BEGIN
		INSERT INTO #Cte_GetHighlightsBothLocale(RowId , Description , HighlightId , LocaleId ,HighlightCode ,HighlightType , DisplayOrder , IsActive , HighlightLocaleId , MediaPath ,MediaId , Hyperlink ,ImageAltTag ,DisplayPopup)
		SELECT Row_Number()Over( PARTITION BY   ZH.HighlightCode ORDER BY ZM.MediaId desc) RowId, ZHL.Description, ZH.HighlightId, LocaleId, ZH.HighlightCode,ZPHT.Name HighlightType , ZADV.DisplayOrder, ZH.IsActive, ZHL.HighlightLocaleId, [dbo].[Fn_GetMediaThumbnailMediaPath]( Zm.path ) AS MediaPath
			, ZH.MediaId, Hyperlink,ImageAltTag,DisplayPopup
		FROM ZnodeHighlight AS ZH
		LEFT JOIN ZnodePimAttributeDefaultValue ZADV on ZADV.AttributeDefaultValueCode =ZH.HighlightCode
		LEFT JOIN  ZnodeHighlightLocale AS ZHL ON(ZHL.HighlightId = ZH.HighlightId)  
		LEFT JOIN ZnodeMedia AS ZM ON(ZM.MediaId = ZADV.MediaId)
		LEFT JOIN ZnodeHighLightType ZPHT ON (ZPHT.HighlightTypeId = ZH.HighlightTypeId)  
		WHERE LocaleId IN ( @LocaleId, @DefaultLocaleId )
	END

	;WITH Cte_HighlightsFirstLocale AS 
	(
		SELECT Description, HighlightId, LocaleId, HighlightCode,HighlightType, DisplayOrder, IsActive, HighlightLocaleId, MediaPath
				  , MediaId, Hyperlink,ImageAltTag,DisplayPopup
		FROM #Cte_GetHighlightsBothLocale AS CTGBBL
		WHERE LocaleId = @LocaleId and RowId = 1
	),
	Cte_HighlightsDefaultLocale	AS 
	(
		SELECT Description, HighlightId, HighlightCode,HighlightType, DisplayOrder, IsActive, HighlightLocaleId, MediaPath
				   , MediaId, Hyperlink,ImageAltTag,DisplayPopup
		FROM Cte_HighlightsFirstLocale
		UNION ALL
		SELECT Description, HighlightId, HighlightCode,HighlightType, DisplayOrder, IsActive, HighlightLocaleId, MediaPath
					, MediaId, Hyperlink,ImageAltTag,DisplayPopup
		FROM #Cte_GetHighlightsBothLocale AS CTBBL
		WHERE LocaleId = @DefaultLocaleId and RowId = 1 AND
		  NOT EXISTS
		(
			SELECT TOP 1 1
			FROM Cte_HighlightsFirstLocale AS CTBFL
			WHERE CTBBL.HighlightId = CTBFL.HighlightId
		)
	)
	INSERT INTO @TBL_HighlightsDetails( Description, HighlightId, HighlightCode,HighlightType, DisplayOrder, IsActive, HighlightLocaleId, MediaPath, MediaId, Hyperlink,ImageAltTag,DisplayPopup)
	SELECT Description, HighlightId, HighlightCode,HighlightType, DisplayOrder, IsActive, HighlightLocaleId, MediaPath, MediaId, Hyperlink,ImageAltTag,DisplayPopup
	FROM Cte_HighlightsDefaultLocale AS CTEBD;

	SELECT TBBD.*, TBAD.AttributeDefaultValue AS HighlightName, TBAD.AttributeDefaultValueCode
	INTO #TM_HighlightsLocale
	FROM @TBL_HighlightsDetails AS TBBD
	INNER JOIN @TBL_AttributeDefault AS TBAD  ON(TBAD.AttributeDefaultValueCode = TBBD.HighlightCode);

	SET @SQL = '
	 ;With Cte_HighlightsDetails AS
	(
		SELECT Description ,HighlightId , HighlightCode,HighlightType , DisplayOrder  ,IsActive   ,HighlightLocaleId
	   ,MediaPath ,MediaId ,Hyperlink,ImageAltTag,DisplayPopup
	   ,HighlightName ,'+[dbo].[Fn_GetPagingRowId]( @Order_BY, 'HighlightId DESC' )+',Count(*)Over() CountId
	    FROM #TM_HighlightsLocale TMADV
	    WHERE 1=1
		'+[dbo].[Fn_GetFilterWhereClause]( @WhereClause )+'
	)
	,Cte_Highlights AS
	(
	SELECT Description ,HighlightId , HighlightCode,HighlightType , DisplayOrder  ,IsActive   ,HighlightLocaleId
	,MediaPath ,MediaId ,Hyperlink,ImageAltTag,DisplayPopup
	   ,HighlightName ,RowId  ,CountId
	FROM Cte_HighlightsDetails
	'+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+'
	) 
	SELECT Description ,HighlightId , HighlightCode,HighlightType , DisplayOrder  ,IsActive   ,HighlightLocaleId
	,MediaPath ,MediaId ,Hyperlink,ImageAltTag,DisplayPopup
	   ,HighlightName ,RowId  ,CountId
	FROM Cte_Highlights
	' +[dbo].[Fn_GetOrderByClause]( @Order_BY, 'HighlightId DESC')

	INSERT INTO @TBL_HighlightsDetail( Description, HighlightId, HighlightCode,HighlightType, DisplayOrder, IsActive, HighlightLocaleId, MediaPath, MediaId, Hyperlink,ImageAltTag,DisplayPopup, HighlightName, RowId, CountId )
	EXEC (@SQL);

	SET @RowsCount = ISNULL(( SELECT TOP 1 CountId FROM @TBL_HighlightsDetail),0);

	SELECT DISTINCT HighlightId, Description, HighlightCode,HighlightType, DisplayOrder, IsActive, HighlightLocaleId, MediaPath, MediaId, Hyperlink,ImageAltTag,DisplayPopup, HighlightName
	FROM @TBL_HighlightsDetail
	ORDER BY DisplayOrder;

	END TRY
	BEGIN CATCH
	DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetHighlightDetail @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@LocaleId = '+CAST(@LocaleId AS VARCHAR(50))+'@IsFromAdmin ='+CAST(@IsFromAdmin AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
             
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
 
		EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_GetHighlightDetail',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeImportAttributeDefaultValue')
BEGIN
	CREATE TABLE [dbo].[ZnodeImportAttributeDefaultValue](
	[ImportdefaultAttributeValueId] [int] IDENTITY(1,1) NOT NULL,
	[ImportAttributeType] [nvarchar](300) NULL,
	[TargetAttributeCode] [nvarchar](300) NULL,
	[AllowAttributeValue] [nvarchar](500) NULL,
	[ReplacedAttributeValue] [nvarchar](300) NULL,
	[IsActive] [bit] NOT NULL,
	[CreatedBy] int NULL,
	[CreatedDate] [datetime] NULL,
	[ModifiedBy] int NULL,
	[ModifiedDate] [datetime] NULL,
	 CONSTRAINT [PK_ZnodeImportAttributeDefaultValue] PRIMARY KEY CLUSTERED 
	(
		[ImportdefaultAttributeValueId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]
END

GO

INSERT [dbo].[ZnodeImportAttributeDefaultValue] ([ImportAttributeType], [TargetAttributeCode], [AllowAttributeValue],
[ReplacedAttributeValue], [IsActive], [CreatedBy], [CreatedDate], [ModifiedBy], [ModifiedDate])
SELECT N'Category', N'HideCategoryonMenu', N'1,true,yes', N'true', 1, 2, GETDATE(), 
	2, GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeDefaultValue WHERE [ImportAttributeType] ='Category' and [TargetAttributeCode] = 'HideCategoryonMenu' and [AllowAttributeValue] = '1,true,yes')
GO
INSERT [dbo].[ZnodeImportAttributeDefaultValue] ([ImportAttributeType], [TargetAttributeCode], [AllowAttributeValue], [ReplacedAttributeValue], [IsActive], [CreatedBy], 
[CreatedDate], [ModifiedBy], [ModifiedDate]) 
select  N'Category', N'HideCategoryonMenu', N'0,false,no', N'false', 1, 2, GETDATE(), 2, GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeImportAttributeDefaultValue WHERE [ImportAttributeType] ='Category' and [TargetAttributeCode] = 'HideCategoryonMenu' and [AllowAttributeValue] = '0,false,no')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetImportReplacedAttributeValue')
	DROP PROC Znode_GetImportReplacedAttributeValue
GO

CREATE PROCEDURE [dbo].[Znode_GetImportReplacedAttributeValue]
	@ImportAttributeType Nvarchar(300)
AS
BEGIN
	BEGIN TRY
		SELECT  TargetAttributeCode,AllowAttributeValue,ReplacedAttributeValue 
		FROM ZnodeImportAttributeDefaultValue 
		WHERE ImportAttributeType = @ImportAttributeType And IsActive=1
	END TRY
	BEGIN CATCH
		DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetImportReplacedAttributeValue @ImportAttributeType = '+@ImportAttributeType ;
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName    = 'Znode_GetImportReplacedAttributeValue',
		@ErrorInProcedure = @ERROR_PROCEDURE,
		@ErrorMessage     = @ErrorMessage,
		@ErrorLine        = @ErrorLine,
		@ErrorCall        = @ErrorCall;
    END CATCH;
END

GO

update ZnodeApplicationSetting 
set ItemName='AssociateCategoryToSpecialOffer' 
where ItemName='AssociateCategorytToSpecialOffer'

GO

UPDATE ZnodePimAttribute 
SET IsSystemDefined = 1 
WHERE AttributeCode='HideCategoryonMenu'
	AND ISNULL(IsSystemDefined,0) = 0

UPDATE ZnodePimAttributeGroupMapper 
SET IsSystemDefined = 1
WHERE PimAttributeId = (SELECT TOP 1 PimAttributeId FROM znodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu' AND IsSystemDefined = 1)
	AND ISNULL(IsSystemDefined,0) = 0

UPDATE ZnodePimFamilyGroupMapper 
SET IsSystemDefined = 1
WHERE PimAttributeId = (SELECT TOP 1 PimAttributeId FROM znodePimAttribute WHERE AttributeCode = 'HideCategoryonMenu' AND IsSystemDefined = 1)
	AND ISNULL(IsSystemDefined,0) = 0

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetImportProcessLog')
	DROP PROC Znode_GetImportProcessLog
GO

CREATE PROCEDURE [dbo].[Znode_GetImportProcessLog]
( @WhereClause VARCHAR(max),
  @Rows        INT           = 100,
  @PageNo      INT           = 1,
  @Order_BY    VARCHAR(1000)  = '',
  @RowsCount   INT OUT)
AS
  /*
    Summary : Get import process log details include rowwise errors in details.    	
	Unit Testing   
	begin tran 
	DECLARE @RowsCount INT;
    EXEC Znode_GetImportProcessLog @WhereClause = 'ImportProcessLogId = 1151',@Rows = 1000,@PageNo = 0,@Order_BY = '',@RowsCount = @RowsCount OUT;
	rollback tran
    SELECT @RowsCount;
    
  */
     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
             DECLARE @SQL NVARCHAR(MAX);
             DECLARE @TBL_ImportLog TABLE(ImportLogId INT,ImportProcessLogId INT,RowNumber BIgInt,ColumnName NVARCHAR(1000),ColumnValue NVARCHAR(max),ErrorDescription NVARCHAR(max)
										,RowId INt , CountNo Int )  ;
             SET @SQL = ' 
							;with Cte_ErrorLog AS 
							(
								SELECT zil.ImportLogId, zil.ImportProcessLogId, ISNULL(zil.RowNumber, 0) [RowNumber], ISNULL(zil.ColumnName, '''') [ColumnName],
								ISNULL(zil.Data, '''') [ColumnValue], zm.MessageName + 
								CASE 
								WHEN zm.MessageCode IN (17)	AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') NOT like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultPriceRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1)
								WHEN zm.MessageCode IN (17)	AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') like ''%Quantity%''  THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'') -1) 
								WHEN zm.MessageCode IN (17)	AND Name in (''Inventory'')  THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'') - 1) 
								WHEN zm.MessageCode IN (41) AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''') NOT like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultPriceRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (41) AND Name in (''Pricing'') AND ISNULL(zil.ColumnName, '''')  like ''%Quantity%'' THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (41) AND Name in (''Inventory'') THEN +''  ''+ dbo.Fn_GetDefaultInventoryRoundOff(isnull(DefaultErrorValue,''0000000.00'' ))
								WHEN zm.MessageCode IN (44) AND Name in (''Pricing'') THEN +''  ''+ isnull(DefaultErrorValue,''0000000.00'' )
								ELSE ''''END ''ErrorDescription'' ,zil.ModifiedDate,zil.GUID
								FROM ZnodeImportLog AS zil WITH (NOLOCK) INNER JOIN ZnodeMessage AS zm WITH (NOLOCK) ON zil.ErrorDescription = CONVERT(VARCHAR(50) , zm.MessageCode)
								INNER JOIN ZnodeImportProcessLog zipl WITH (NOLOCK) ON zil.ImportProcessLogId = zipl.ImportProcessLogId
								LEFT Outer JOIN ZnodeImportTemplate zit WITH (NOLOCK) ON zipl.ImportTemplateId = zit.ImportTemplateId
								LEFT Outer JOIN ZnodeImportHead zih WITH (NOLOCK) ON zit.ImportHeadId =zih.ImportHeadId 
								)
								,Cte_ErrorLogFilter As ( SELECT ImportLogId,ImportProcessLogId,[RowNumber],[ColumnName],[ColumnValue],[ErrorDescription],[ModifiedDate],GUID
												,'+dbo.Fn_GetPagingRowId(@Order_BY , 'RowNumber,ImportLogId')+',Count(*)Over() CountNo 
								 FROM Cte_ErrorLog
								 WHERE 1 = 1 '+dbo.Fn_GetFilterWhereClause(@WhereClause)+' 
							 )

							SELECT ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription,RowId, CountNo 
							FROM Cte_ErrorLogFilter '+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows)

			 INSERT INTO @TBL_ImportLog (ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription,RowId, CountNo)
			 EXEC (@SQL)
				 SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_ImportLog), 0);
             SELECT ImportLogId,ImportProcessLogId,RowNumber,ColumnName,ColumnValue,ErrorDescription
			 FROM @TBL_ImportLog
			

		 END TRY
         BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetImportProcessLog @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetImportProcessLog',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;                                    
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAddonAssociation')
	DROP PROC Znode_ImportAddonAssociation
GO

CREATE PROCEDURE [dbo].[Znode_ImportAddonAssociation](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

		IF OBJECT_ID('TEMPDB..#InsertProductAddonAssociation') IS NOT NULL
			DROP TABLE #InsertProductAddonAssociation

		IF OBJECT_ID('TEMPDB..#SKU') IS NOT NULL
			DROP TABLE #SKU

		IF OBJECT_ID('TEMPDB..#InsertZnodePimAddOnProduct') IS NOT NULL
			DROP TABLE #InsertZnodePimAddOnProduct

		CREATE TABLE #InsertZnodePimAddOnProduct ( PimAddOnProductId int,PimAddonGroupId int,PimProductId int)

		CREATE TABLE #InsertProductAddonAssociation
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, SKU varchar(300),AddonGroupName varchar(300),AddOnSKU varchar(300),DisplayOrder int, IsDefault varchar(10), GUID nvarchar(400)
		
		);

		CREATE TABLE #SKU 
		( 
			SKU nvarchar(300), PimProductId int
		);

		----Get All SKU Data From DB
		INSERT INTO #SKU (SKU, PimProductId)
		SELECT ZPAVL.AttributeValue, ZPAV.PimProductId
		FROM ZnodePimAttributeValue AS ZPAV
		INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		INNER JOIN ZnodePimAttribute ZPA ON ZPAV.PimAttributeId = ZPA.PimAttributeId
		WHERE ZPA.AttributeCode = 'SKU';

		SET @SSQL = 'Select RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID FROM '+@TableName;
		INSERT INTO #InsertProductAddonAssociation( RowNumber,SKU,AddonGroupName,AddOnSKU,DisplayOrder,IsDefault,GUID )
		EXEC sys.sp_sqlexec @SSQL;

		SELECT SKU,AddonGroupName,AddOnSKU 
		INTO #DuplicateProductAddonAssociation 
		FROM #InsertProductAddonAssociation 
		Group BY SKU,AddonGroupName,AddOnSKU  having count(*) > 1

		----Checking AddonGroupName present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '99', 'AddonGroupName', AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS ( SELECT * FROM ZnodePimAddonGroupLocale i where i.AddonGroupName = ii.AddonGroupName );

		----Checking SKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.SKU = SKU.SKU)

		----Checking AddOnSKU present in DB
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'AddOnSKU', AddOnSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE NOT EXISTS( SELECT * FROM #SKU SKU WHERE ii.AddOnSKU = SKU.SKU)
		
		----Duplicate Record (SKU \ AddOnSKU \ AddonGroupName)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '53', 'SKU \ AddOnSKU \ AddonGroupName ', SKU+' \ '+AddOnSKU+' \ '+AddonGroupName, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertProductAddonAssociation AS ii
		WHERE EXISTS ( select * FROM #DuplicateProductAddonAssociation i WHERE i.SKU = ii.SKU and i.AddOnSKU = ii.AddOnSKU and i.AddonGroupName = ii.AddonGroupName );

		----Checking is default value data validation
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertProductAddonAssociation AS ii  
		WHERE ISNULL(ii.IsDefault,0) not in ('True','1','Yes','FALSE','0','No','')
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM #InsertProductAddonAssociation AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM #InsertProductAddonAssociation AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + isnull(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertProductAddonAssociation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- Delete Invalid Data after functional validatin  
		DELETE FROM #InsertProductAddonAssociation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertProductAddonAssociation
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))  
		WHERE ImportProcessLogId = @ImportProcessLogId;


		UPDATE PAPD
		SET PAPD.ModifiedBy =@UserId  ,PAPD.ModifiedDate = GETDATE(),
		PAPD.IsDefault = case when IPAA.IsDefault in ('True','1','Yes') then 1 else 0 end,
		PAPD.DisplayOrder = CASE WHEN IPAA.DisplayOrder IS NOT NULL THEN IPAA.DisplayOrder ELSE PAPD.DisplayOrder END
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct PAP ON (PAP.PimProductId = SKU.PimProductId AND PAP.PimAddonGroupId = ZPAGL.PimAddonGroupId)
		INNER JOIN ZnodePimAddOnProductDetail PAPD ON (PAPD.PimAddOnProductId =PAP.PimAddOnProductId AND SKU1.PimProductId = PAPD.PimChildProductId )

		-----Inserting records in ZnodePimAddOnProduct
		INSERT INTO ZnodePimAddOnProduct(PimAddonGroupId,PimProductId,DisplayOrder,RequiredType,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		OUTPUT inserted.PimAddOnProductId, inserted.PimAddonGroupId,inserted.PimProductId into #InsertZnodePimAddOnProduct (PimAddOnProductId,PimAddonGroupId,PimProductId)
		SELECT DISTINCT ZPAGL.PimAddonGroupId,SKU.PimProductId, 999 as DisplayOrder,
		'Required' RequiredType,@UserId as CreatedBy,@GetDate,@UserId as ModifiedBy,@GetDate
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.SKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on ZPAGL.AddonGroupName = IPAA.AddonGroupName
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProduct ZPAP where ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId and ZPAP.PimProductId = SKU.PimProductId )

		-----Inserting records in ZnodePimAddOnProductDetail
		INSERT INTO ZnodePimAddOnProductDetail(PimAddOnProductId,PimChildProductId,IsDefault,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT DISTINCT ZPAP.PimAddOnProductId, SKU.PimProductId as PimChildProductId, CASE WHEN isnull(IPAA.IsDefault,0) IN ('True','1','Yes') THEN 1 ELSE 0 END, ISNULL(IPAA.DisplayOrder,999),@UserId ,@GetDate,@UserId,@GetDate 
		FROM #InsertProductAddonAssociation IPAA
		INNER JOIN #SKU SKU1 ON SKU1.SKU = IPAA.SKU
		INNER JOIN #SKU SKU ON SKU.SKU = IPAA.AddOnSKU
		INNER JOIN ZnodePimAddonGroupLocale ZPAGL on IPAA.AddonGroupName = ZPAGL.AddonGroupName
		INNER JOIN ZnodePimAddOnProduct ZPAP on SKU1.PimProductId = ZPAP.PimProductId and ZPAP.PimAddonGroupId = ZPAGL.PimAddonGroupId
		WHERE NOT EXISTS(SELECT * FROM ZnodePimAddOnProductDetail ZPAPD WHERE ZPAPD.PimAddOnProductId = ZPAP.PimAddOnProductId and ZPAPD.PimChildProductId = SKU.PimProductId )

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;

	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAddonAssociation @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAddonAssociation',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAssociateProducts')
	DROP PROC Znode_ImportAssociateProducts
GO

CREATE PROCEDURE [dbo].[Znode_ImportAssociateProducts](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Product Association 
	
	-- Unit Testing : 
	--BEGIN TRANSACTION;
	--update ZnodeGlobalSetting set FeatureValues = '5' WHERE FeatureName = 'InventoryRoundOff' 
	--    DECLARE @status INT;
	--    EXEC [Znode_ImportInventory] @InventoryXML = '<ArrayOfImportInventoryModel>
	-- <ImportInventoryModel>
	--   <SKU>S1002</SKU>
	--   <Quantity>999998.33</Quantity>
	--   <ReOrderLevel>10</ReOrderLevel>
	--   <RowNumber>1</RowNumber>
	--   <ListCode>TestInventory</ListCode>
	--   <ListName>TestInventory</ListName>
	-- </ImportInventoryModel>
	--</ArrayOfImportInventoryModel>' , @status = @status OUT , @UserId = 2;
	--    SELECT @status;
	--    ROLLBACK TRANSACTION;
	--------------------------------------------------------------------------------------

BEGIN
	
	BEGIN TRY
	BEGIN TRAN A;
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();

		IF OBJECT_ID('TEMPDB..#InsertProductAssociation') IS NOT NULL 
			DROP TABLE #InsertProductAssociation

		IF OBJECT_ID('TEMPDB..#InsertProduct') IS NOT NULL 
			DROP TABLE #InsertProduct

		IF OBJECT_ID('TEMPDB..#SKU') IS NOT NULL 
			DROP TABLE #SKU

		IF OBJECT_ID('TEMPDB..#InsertProductAssociation_Parent_type') IS NOT NULL 
			DROP TABLE #InsertProductAssociation_Parent_type
		-- Retrive RoundOff Value from global setting 

		CREATE TABLE #InsertProductAssociation 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, ParentSKU varchar(300), ChildSKU varchar(200), DisplayOrder int,IsDefault varchar(10), GUID nvarchar(400),BundleQuantity varchar(10) null
		);

		CREATE TABLE #InsertProductAssociation_Parent_type
		( 
			RowId int  PRIMARY KEY, RowNumber int, ParentSKU varchar(300), ChildSKU varchar(200), DisplayOrder int,IsDefault varchar(10), GUID nvarchar(400),BundleQuantity varchar(10) null
			,PT_ParentProductId varchar(300), PT_ProductType nvarchar(100)
		);
		
		CREATE TABLE #InsertProduct 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, ParentProductId varchar(300), ChildProductId varchar(200), DisplayOrder int,IsDefault varchar(10), GUID nvarchar(400), ProductType nvarchar(100),BundleQuantity varchar(10) null
		);


		DECLARE @CategoryAttributId int;

		DECLARE @InventoryListId int;

		SET @SSQL = 'Select RowNumber,ParentSKU,ChildSKU,DisplayOrder,IsDefault,GUID,Quantity FROM '+@TableName;
		INSERT INTO #InsertProductAssociation( RowNumber, ParentSKU,ChildSKU,DisplayOrder,IsDefault, GUID, BundleQuantity )
		EXEC sys.sp_sqlexec @SSQL;

		--@MessageDisplay will use to display validate message for input inventory value  
		CREATE TABLE #SKU 
		( 
						   SKU nvarchar(300), PimProductId int
		);
		INSERT INTO #SKU
			   SELECT b.AttributeValue, a.PimProductId
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;

		DECLARE @ProductType TABLE
		( 
			ProductType nvarchar(100) ,PimProductId int
		);
		INSERT INTO @ProductType
			   SELECT  ZPADV.AttributeDefaultValueCode, a.PimProductId
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimProductAttributeDefaultValue AS b
					ON a.PimAttributeId = dbo.Fn_GetProductTypeAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId
					   Inner join ZnodePimAttributeDefaultValue ZPADV On b.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId
					   where  ZPADV.AttributeDefaultValueCode in ('GroupedProduct','BundleProduct','ConfigurableProduct');

		INSERT INTO #InsertProductAssociation_Parent_type
			SELECT IPAC.*,SKUParent.PimProductId, PT.ProductType
					FROM #InsertProductAssociation AS IPAC INNER JOIN #SKU AS SKUParent ON IPAC.ParentSKU = SKUParent.SKU 
					inner join @ProductType PT on PT.PimProductId = SKUParent.PimProductId


		-- start Functional Validation 
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '84', 'IsDefault', IsDefault, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE isnull(ii.IsDefault,'') = '' and ii.PT_ProductType ='ConfigurableProduct'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE isnull(ii.IsDefault,'') not in ('true','1','false','0') and isnull(ii.IsDefault,'') <> '' and ii.PT_ProductType ='ConfigurableProduct'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE isnull(ii.IsDefault,'') not in ('true','1','false','0') and isnull(ii.IsDefault,'') <> '' and ii.PT_ProductType ='BundleProduct'

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '98', 'ChildSKU', ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii
			   WHERE NOT EXISTS( SELECT SKU FROM #SKU SKU WHERE ii.ChildSKU = SKU.SKU)

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'ParentSKU / ChildSKU', ParentSKU+' / '+ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE ii.ParentSKU IN
			   (
				   select ParentSKU from #InsertProductAssociation_Parent_type
					group by ParentSKU,ChildSKU
					having count(1)>1
			   );

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '49', 'ParentSKU',   ParentSKU , @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE not exists
			   ( SELECT SKU  FROM #SKU SKU inner join @ProductType  PT ON SKU.PimProductId = PT.PimProductId Where  ii.ParentSKU = SKU.SKU )
			   AND  EXISTS (SELECT SKU  FROM #SKU SKU where ii.ParentSKU = SKU.SKU);

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '94', 'ParentSKU',   ParentSKU , @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE NOT  EXISTS (SELECT SKU  FROM #SKU SKU where ii.ParentSKU = SKU.SKU) ;


			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '51', 'ChildSKU',   ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE exists 
			   (SELECT SKU  FROM #SKU SKU inner join @ProductType  PT ON SKU.PimProductId = PT.PimProductId and ii.ChildSKU = SKU.SKU)
			    AND  EXISTS (SELECT SKU  FROM #SKU SKU where ii.ChildSKU = SKU.SKU);
			
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '94', 'ChildSKU',   ChildSKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation AS ii
			   WHERE NOT EXISTS (SELECT SKU  FROM #SKU SKU where ii.ChildSKU = SKU.SKU);

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '101', 'ParentSKU',  'Configure Attribute Missing: '+ Convert(nvarchar(400),isnull(ParentSKU,'')), @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertProductAssociation_Parent_type AS ii Inner join #SKU PS ON 
			   ii.ParentSKU = PS.SKU 
			   Inner join @ProductType  PT ON PS.PimProductId = PT.PimProductId  AND PT.ProductType  in ('ConfigurableProduct')
			   where  NOT exists 
			   (select PimProductId  from ZnodePimConfigureProductAttribute d where PS.PimProductId = d.PimProductId)
			   -- End Function Validation 	

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM #InsertProductAssociation_Parent_type AS ii
			WHERE ((isnull(ii.DisplayOrder,'') = '' ) and ii.PT_ProductType !='ConfigurableProduct' ) --or  ii.DisplayOrder = 0

			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '26', 'BundleQuantity', BundleQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM #InsertProductAssociation_Parent_type AS ii
			WHERE ((isnull(ii.BundleQuantity,0) < 1 ) and ii.PT_ProductType ='BundleProduct' ) --or  ii.DisplayOrder = 0

			
			INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '2', 'BundleQuantity', BundleQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM #InsertProductAssociation_Parent_type AS ii
			WHERE (ii.BundleQuantity ='' and ii.PT_ProductType ='BundleProduct'  ) --or  ii.DisplayOrder = 0


		--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--	SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		--	FROM #InsertProductAssociation_Parent_type AS ii
		--	WHERE ((isnull(ii.DisplayOrder,'') = '' ) and ii.PT_ProductType !='ConfigurableProduct' ) --or  ii.DisplayOrder > 999

			   UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + isnull(ParentSKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertProductAssociation_Parent_type IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--- Delete Invalid Data after functional validation  
		DELETE FROM #InsertProductAssociation_Parent_type
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  GUID = @NewGUID
		);

		SELECT RowNumber , SKUParent.PimProductId SKUParentId  ,
				   ( Select TOP 1 SKUChild.PimProductId from #SKU AS SKUChild where  SKUChild.SKU = IPAC.ChildSKU ) SKUChildId,
				    case when isnull(DisplayOrder,'')= '' and IPAC.PT_ProductType ='ConfigurableProduct'  then 99 else DisplayOrder end DisplayOrder ,
					 case when (isnull(IsDefault,'')= '' or IsDefault =0 or IsDefault > 999) and IPAC.PT_ProductType !='ConfigurableProduct'  then '0' else IsDefault end IsDefault, IPAC.PT_ProductType
					, BundleQuantity
					FROM #InsertProductAssociation_Parent_type AS IPAC INNER JOIN #SKU AS SKUParent ON IPAC.ParentSKU = SKUParent.SKU 

		insert into #InsertProduct (RowNumber,  ParentProductId , ChildProductId , DisplayOrder, IsDefault, ProductType, BundleQuantity)
			SELECT RowNumber , SKUParent.PimProductId SKUParentId  ,
				   ( Select TOP 1 SKUChild.PimProductId from #SKU AS SKUChild where  SKUChild.SKU = IPAC.ChildSKU ) SKUChildId,
				    case when isnull(DisplayOrder,'')= '' and IPAC.PT_ProductType ='ConfigurableProduct'  then 99 else DisplayOrder end DisplayOrder ,
					 case when (isnull(IsDefault,'')= '' or IsDefault =0 or IsDefault > 999) and IPAC.PT_ProductType !='ConfigurableProduct'  then '0' else IsDefault end IsDefault, IPAC.PT_ProductType
					, BundleQuantity
					FROM #InsertProductAssociation_Parent_type AS IPAC INNER JOIN #SKU AS SKUParent ON IPAC.ParentSKU = SKUParent.SKU 

	-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertProduct
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

		update #InsertProduct
		set IsDefault =0
		where RowNumber < (select max(RowNumber) from #InsertProduct where IsDefault = '1' or  IsDefault = 'True' and ProductType ='ConfigurableProduct')
		and  ProductType ='ConfigurableProduct';


		update ZnodePimProductTypeAssociation
		set  IsDefault =0
		where  exists (select top 1 1  from #InsertProduct IP where IsDefault = '1' or  IsDefault = 'true' and PimParentProductId = IP.ParentProductId and ProductType ='ConfigurableProduct')
		

		UPDATE B set b.ModifiedDate = @GetDate, b.ModifiedBy = @UserId, b.DisplayOrder = case when a.DisplayOrder is not null then a.DisplayOrder else b.DisplayOrder end
				,b.IsDefault = A.IsDefault,b.BundleQuantity= case when A.Producttype = 'BundleProduct' then  case when isnull(a.BundleQuantity,'') ='' then case when b.BundleQuantity >=1 then b.BundleQuantity else 1 end else cast (a.BundleQuantity as int) end else null end
		from #InsertProduct A
		INNER JOIN ZnodePimProductTypeAssociation B ON a.ParentProductId = b.PimParentProductId and a.ChildProductId = b.PimProductId

	
		INSERT INTO ZnodePimProductTypeAssociation (PimParentProductId, PimProductId, DisplayOrder, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, IsDefault,BundleQuantity) 
		select  ParentProductId , ChildProductId , DisplayOrder, @UserId, @GetDate, @UserId, @GetDate, IsDefault ,case when Producttype = 'BundleProduct' then case when  isnull(BundleQuantity,'') ='' then 1 else cast (BundleQuantity as int) end else null end
		from #InsertProduct  
		where  NOT Exists (Select TOP 1 1 from ZnodePimProductTypeAssociation where PimParentProductId =  #InsertProduct.ParentProductId
		AND PimProductId = #InsertProduct.ChildProductId )

								 
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						  WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						  WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					 END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
END TRY
	BEGIN CATCH
		ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAssociateProducts @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAssociateProducts',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributeDefaultValue')
	DROP PROC Znode_ImportAttributeDefaultValue
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributeDefaultValue](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			-- RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
			RowNumber int, AttributeCode varchar(300),AttributeDefaultValueCode varchar(300),AttributeDefaultValue varchar(1000),IsEditable varchar(10),DisplayOrder int, IsDefault varchar(10), SwatchText varchar(1000),SwatchImage varchar(500), SwatchImagePath varchar(500), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeCode,AttributeDefaultValueCode,AttributeDefaultValue,IsEditable,DisplayOrder,IsDefault,SwatchText,SwatchImage, SwatchImagePath ,GUID)
		EXEC sys.sp_sqlexec @SSQL;

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '9', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode not in 
			   (
				   SELECT AttributeCode FROM @AttributeCode
			   );

		WITH CTE_AttributeDefaultValueCode AS(
		SELECT AttributeDefaultValueCode , AttributeCode, RowNumber ,ROW_NUMBER ()OVER (PARTITION BY AttributeDefaultValueCode , AttributeCode ORDER BY AttributeDefaultValueCode , AttributeCode )  Row_Id
		FROM @InsertPimAtrribute Z
		
		
		)
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE EXISTS
			  ( SELECT TOP 1 1 FROM CTE_AttributeDefaultValueCode Z WHERE Z.RowNumber=ii.RowNumber AND Z.Row_Id >1
			   )
			  

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '%[^0-9A-Za-z]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeDefaultValueCode', AttributeDefaultValueCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeDefaultValueCode,''))) like '% %' -----space not allowed

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsEditable', IsEditable, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsEditable not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsDefault', IsDefault, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsDefault not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 99999

		UPDATE ZIL
			SET ZIL.ColumnName =   ZIL.ColumnName + ' [ AttributeDefaultValueCode - ' + ISNULL(AttributeDefaultValueCode,'') + ' ] '
			FROM ZnodeImportLog ZIL 
			INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount
		,	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName and IPA.SwatchImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.SwatchImage = ZM.FileName)

        update ZPADV set ZPADV.IsEditable = case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end,ZPADV.DisplayOrder = Case when Isnull(IPA.DisplayOrder,0) <> 0 then  IPA.DisplayOrder else ZPADV.DisplayOrder end ,
		                 ZPADV.IsDefault = case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end ,ZPADV.SwatchText = IPA.SwatchText ,
		                 ZPADV.MediaId = case when isnull(@MediaId,0)= 0 then ZPADV.MediaId else @MediaId end, ZPADV.ModifiedBy = @UserId, ZPADV.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode

		update ZPADVL set ZPADVL.AttributeDefaultValue = IPA.AttributeDefaultValue, ZPADVL.ModifiedBy = @UserId, ZPADVL.ModifiedDate = @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode 
		inner join ZnodePimAttributeDefaultValue ZPADV on ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode
		inner join ZnodePimAttributeDefaultValueLocale ZPADVL ON ( ZPADVL.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)

		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttributeDefaultValue (PimAttributeId,AttributeDefaultValueCode,IsEditable,DisplayOrder,IsDefault,SwatchText,MediaId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
		OUTPUT Inserted.PimAttributeId,Inserted.PimAttributeDefaultValueId,Inserted.AttributeDefaultValueCode INTO @InsertedPimAttributeIds  		
		SELECT ZPA.PimAttributeId,IPA.AttributeDefaultValueCode, case when IPA.IsEditable in ('True','1','Yes') then 1 else 0 end , Case when Isnull(IPA.DisplayOrder,0) = 0 then  99999 else IPA.DisplayOrder end  , 
		       case when IPA.IsDefault in ('True','1','Yes') then 1 else 0 end , IPA.SwatchText, @MediaId,@UserId , @GetDate ,@UserId , @GetDate 
		from @InsertPimAtrribute IPA 
		INNER JOIN ZnodePimAttribute ZPA ON IPA.AttributeCode = ZPA.AttributeCode  
		where not exists(select * from ZnodePimAttributeDefaultValue ZPADV where ZPA.PimAttributeId = ZPADV.PimAttributeId and IPA.AttributeDefaultValueCode = ZPADV.AttributeDefaultValueCode)
		
		INSERT INTO ZnodePimAttributeDefaultValueLocale(LocaleId,PimAttributeDefaultValueId,AttributeDefaultValue,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeDefaultValueId, IPA.AttributeDefaultValue, '', @UserId , @GetDate ,@UserId , @GetDate   
		FROM @InsertedPimAttributeIds IPAS 
		INNER JOIN ZnodePimAttribute ZPA ON IPAS.PimAttributeId = ZPA.PimAttributeId  
		INNER JOIN @InsertPimAtrribute IPA ON ZPA.AttributeCode= IPA.AttributeCode and IPAS.AttributeDefaultValueCode = IPA.AttributeDefaultValueCode

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
	
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributeDefaultValue @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributeDefaultValue',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportAttributes')
	DROP PROC Znode_ImportAttributes
GO

CREATE PROCEDURE [dbo].[Znode_ImportAttributes](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, AttributeName varchar(300), AttributeCode varchar(300), AttributeType varchar(300), DisplayOrder int, GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,AttributeTypeId int,AttributeCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,AttributeName,AttributeCode,AttributeType,DisplayOrder ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,AttributeName,AttributeCode,AttributeType,DisplayOrder ,GUID)
		EXEC sys.sp_sqlexec @SSQL;


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @AttributeCode TABLE
		( 
		   AttributeCode nvarchar(300)
		);
		INSERT INTO @AttributeCode
			   SELECT AttributeCode
			   FROM ZnodePimAttribute 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '10', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode in 
			   (
				   SELECT AttributeCode FROM @AttributeCode  where AttributeCode is not null 
			   );
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeCode in 
			   (
				   select AttributeCode  FROM @InsertPimAtrribute  Group BY AttributeCode  having count(*) > 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '103', 'AttributeType', AttributeType, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.AttributeType NOT in 
			   (
				   SELECT AttributeTypeName  FROM ZnodeAttributeType  where IsPimAttributeType = 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) like '%[^0-9A-Za-z]%'

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '50', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE Isnumeric(ltrim(rtrim(isnull(ii.AttributeCode,'')))) =1

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'AttributeCode', AttributeCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.AttributeCode,''))) like '% %' -----space not allowed

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999


		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Attribute - ' + ISNULL(AttributeCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End


		--- Insert data into base table ZnodePimatrribute with their validation 

		INSERT INTO ZnodePimAttribute (AttributeTypeId,AttributeCode,IsRequired,IsLocalizable,IsFilterable,IsSystemDefined
			,IsConfigurable,IsPersonalizable,IsShowOnGrid,DisplayOrder,HelpDescription,IsCategory,IsHidden,IsSwatch,
			CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		
		OUTPUT Inserted.PimAttributeId,Inserted.AttributeTypeId,Inserted.AttributeCode INTO @InsertedPimAttributeIds  
		
		SELECT ZAT.AttributeTypeId,AttributeCode, 0 IsRequired , 1 IsLocalizable,1 IsFilterable, 0 IsSystemDefined, 0 IsConfigurable,
		0 IsPersonalizable,  0 IsShowOnGrid , Case when Isnull(DisplayOrder,0) = 0 then  999 else DisplayOrder end  , '' HelpDescription ,0  IsCategory , 0 IsHidden , 0 IsSwatch,
		@UserId , @GetDate ,@UserId , @GetDate from @InsertPimAtrribute IPA INNER JOIN ZnodeAttributeType ZAT 
		ON IPA.AttributeType = ZAT.AttributeTypeName  
		
		
		INSERT INTO ZnodePimAttributeLocale (LocaleId,PimAttributeId,AttributeName,Description,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select @LocaleId ,IPAS.PimAttributeId, IPA.AttributeName, '', @UserId , @GetDate ,@UserId , @GetDate   
		 FROM @InsertedPimAttributeIds IPAS INNER JOIN @InsertPimAtrribute IPA ON IPAS.AttributeCode= IPA.AttributeCode 
		
		INSERT INTO ZnodePimAttributeValidation
		(PimAttributeId,InputValidationId,InputValidationRuleId,Name,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT IPA.PimAttributeId,ZAIV.InputValidationId,NULL,null , @UserId , @GetDate ,@UserId , @GetDate  
		FROM @InsertedPimAttributeIds IPA INNER JOIN ZnodeAttributeInputValidation ZAIV ON IPA.AttributeTypeId = ZAIV.AttributeTypeId


		insert into ZnodePimFrontendProperties (PimAttributeId,IsComparable,IsUseInSearch,IsHtmlTags,IsFacets,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		Select PimAttributeId, 0 IsComparable, 0 IsUseInSearch,0 IsHtmlTags,0 IsFacets, @UserId CreatedBy,@GetDate CreatedDate, @UserId ModifiedBy, @GetDate ModifiedDate
		from  @InsertedPimAttributeIds
		--      SET @Status = 1;

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportAttributes',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportB2BCustomer')
	DROP PROC Znode_ImportB2BCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportB2BCustomer](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @LocaleId int= 0,@PortalId int ,@CsvColumnString nvarchar(max))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max),@AspNetZnodeUserId nvarchar(256),@ASPNetUsersId nvarchar(256),
		@PasswordHash nvarchar(max),@SecurityStamp nvarchar(max),@RoleId nvarchar(256),@IsAllowGlobalLevelUserCreation nvarchar(10),
		@AccountId int

		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';
		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'User'  
		
		SELECT @AccountId = AccountId FROM ZnodeUser ZU WHERE UserId = @UserId
		--set @TableName = replace(@TableName,'tempdb..','')

		Select @IsAllowGlobalLevelUserCreation = FeatureValues from ZnodeGlobalsetting where FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		-- Retrive RoundOff Value from global setting 

		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, UserName nvarchar(512) ,FirstName	nvarchar(200),
			LastName nvarchar(200), BudgetAmount	numeric,Email	nvarchar(100),PhoneNumber	nvarchar(100),
		    EmailOptIn	bit	,ReferralStatus	nvarchar(40),IsActive	bit	,ExternalId	nvarchar(max), GUID NVARCHAR(400)
		);
		
		--	--SET @SSQL = 'SELECT RowNumber,UserName,FirstName,LastName,BudgetAmount,Email,PhoneNumber,EmailOptIn,IsActive,ExternalId,GUID FROM '+ @TableName;
		--SET @SSQL = 'SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		--INSERT INTO @InsertCustomer( RowNumber,UserName,FirstName,LastName,Email,PhoneNumber,       EmailOptIn,IsActive,ExternalId,GUID )
		--EXEC sys.sp_sqlexec @SSQL;

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,'+@CsvColumnString+',GUID ) 
					 SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+@TableName+'';
		--select @CsvColumnString
		--select * from #InsertCustomer
		--print @SSQL
		EXEC sys.sp_sqlexec @SSQL	

		--UserName,FirstName,LastName,Email,PhoneNumber,EmailOptIn,IsActive,ExternalId
	
	    -- start Functional Validation 

		-----------------------------------------------
		--If @IsAllowGlobalLevelUserCreation = 'true'
		--		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--			   SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--			   FROM @InsertCustomer AS ii
		--			   WHERE ii.UserName in 
		--			   (
		--				   SELECT UserName FROM AspNetZnodeUser   where PortalId = @PortalId
		--			   );
		--Else 
		--		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		--			   SELECT '10', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		--			   FROM @InsertCustomer AS ii
		--			   WHERE ii.UserName in 
		--			   (
		--				   SELECT UserName FROM AspNetZnodeUser   
		--			   );
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
					   SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
					   FROM #InsertCustomer AS ii
					   WHERE ii.UserName not like '%_@_%_.__%' 
				
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
					   SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
					   FROM #InsertCustomer AS ii
					   WHERE ii.UserName in 
					   (SELECT UserName  FROM #InsertCustomer group by UserName  having count(*) > 1 )

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
					   SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
					   FROM #InsertCustomer AS ii
					   WHERE ii.Email not like '%_@_%_.__%'

		--Note : Content page import is not required 
		
		-- End Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount,
			TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId nvarchar(256) ,UserName nvarchar(512),PortalId int )
				DECLARE @InsertedASPNetUsers TABLE (Id nvarchar(256) ,UserName nvarchar(512))
				DECLARE @InsertZnodeUser TABLE (UserId int,AspNetUserId nvarchar(256) )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber
				from AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				where Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= Isnull(IC.EmailOptIn,0),
				ZU.IsActive		= 1,--IC.IsActive,
				ZU.AccountId    = @AccountId
				--ZU.ExternalId = ExternalId
				from AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				where Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				Insert into AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				Select NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				where Not Exists (Select TOP 1 1  from AspNetZnodeUser ANZ where Isnull(ANZ.PortalId,0) = Isnull(@PortalId,0) AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				output inserted.Id, inserted.UserName into @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,NULL LockoutEndDateUtc,A.IsActive As LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId from #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
				
				INSERT INTO  ZnodeUser(AccountId, AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId into @InsertZnodeUser
				SELECT @AccountId, IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,Isnull(IC.EmailOptIn,0), 1 as IsActive,--IC.IsActive,
				IC.ExternalId, @UserId,@Getdate,@UserId,@Getdate
				FROM #InsertCustomer IC Inner join 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
				  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  Select AspNetUserId, @RoleID from @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId,@Getdate,@UserId,@Getdate from @InsertZnodeUser
				
				Declare @ProfileId  int 
				select TOP 1 @ProfileId   =  ProfileId from ZnodePortalprofile where Portalid = @PortalId and IsDefaultRegistedProfile=1

				insert into ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT @ProfileId  , UserId, 1 , @UserId,@Getdate,@UserId,@Getdate from @InsertZnodeUser

				 DECLARE @GlobalAttributeDetail TABLE
				 ( 
					GlobalAttributeId int, AttributeTypeName varchar(300), AttributeCode varchar(300), SourceColumnName nvarchar(600), IsRequired bit 
				 );

				INSERT INTO @GlobalAttributeDetail ( GlobalAttributeId, AttributeTypeName, AttributeCode, SourceColumnName, IsRequired )
				SELECT ZGA.GlobalAttributeId, ZAT.AttributeTypeName, ZGA.AttributeCode, ZGA.AttributeCode SourceColumnName, ZGA.IsRequired
				from tempdb.sys.columns a
				INNER JOIN ZnodeGlobalAttribute ZGA ON a.Name = ZGA.AttributeCode
				INNER JOIN ZnodeAttributeType ZAT ON ZGA.AttributeTypeId = ZAT.AttributeTypeId
				WHERE  object_id = object_id(@TableName)

				--SELECT ZGA.GlobalAttributeId, ZAT.AttributeTypeName, ZGA.AttributeCode, ZGA.AttributeCode SourceColumnName, ZGA.IsRequired
				--FROM tempdb.INFORMATION_SCHEMA.Columns a
				--INNER JOIN ZnodeGlobalAttribute ZGA ON a.Column_Name = ZGA.AttributeCode
				--INNER JOIN ZnodeAttributeType ZAT ON ZGA.AttributeTypeId = ZAT.AttributeTypeId
				--WHERE TABLE_NAME = @TableName

				 DECLARE @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @GlobalAttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @NewProductId INT, @PimAttributeValueId INT, @SQLQuery varchar(max); 

				 DECLARE  @UserDetail TABLE (  UserId int, GlobalAttributeId int , AttributeValue varchar(max), LocaleId int, RowNumber int)
			
	
				DECLARE Cr_AttributeDetails CURSOR LOCAL FAST_FORWARD
				FOR SELECT GlobalAttributeId, AttributeTypeName, AttributeCode, SourceColumnName, IsRequired FROM @GlobalAttributeDetail  WHERE ISNULL(SourceColumnName, '') <> '';
				OPEN Cr_AttributeDetails;
				FETCH NEXT FROM Cr_AttributeDetails INTO @GlobalAttributeId, @AttributeTypeName, @AttributeCode, @SourceColumnName, @IsRequired;
				WHILE @@FETCH_STATUS = 0
				BEGIN

					SET @NewProductId = 0;
					SET @SQLQuery = 'SELECT ZU.UserId ,'''+CONVERT(VARCHAR(100), @GlobalAttributeId)+''' GlobalAttributeId , TN.'+@SourceColumnName+' as AttributeValue, '+CONVERT(VARCHAR(100), @LocaleId)+' LocaleId
									, RowNumber FROM '+@TableName+' TN
									INNER JOIN AspNetZnodeUser ANZU ON TN.UserName = ANZU.UserName
									INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
									INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId ';
						--print @SQLQuery	

					INSERT INTO @UserDetail(  UserId, GlobalAttributeId, AttributeValue, LocaleId, RowNumber )
					EXEC sys.sp_sqlexec @SQLQuery;
					FETCH NEXT FROM Cr_AttributeDetails INTO @GlobalAttributeId, @AttributeTypeName, @AttributeCode, @SourceColumnName, @IsRequired;
				END;
				CLOSE Cr_AttributeDetails;
				DEALLOCATE Cr_AttributeDetails;
			
				-----GLOBAL ATTRIBUTE USER INSERT
				INSERT INTO ZnodeUserGlobalAttributeValue ( UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate )
				SELECT UserId, GlobalAttributeId ,NULL, NULL, @UserId, GETDATE(), @UserId , GETDATE()
				FROM @UserDetail UD
				where isnull(AttributeValue,'') <> ''
				AND NOT EXISTS (select * from ZnodeUserGlobalAttributeValue GAV where UD.UserId = GAV.UserId and UD.GlobalAttributeId = GAV.GlobalAttributeId )
				
				UPDATE ZnodeUserGlobalAttributeValueLocale set AttributeValue = UD.AttributeValue, ModifiedBy = @UserId,	ModifiedDate = GETDATE(), GlobalAttributeDefaultValueId = GADV.GlobalAttributeDefaultValueId
				FROM ZnodeUserGlobalAttributeValueLocale UGAVL
				INNER JOIN ZnodeUserGlobalAttributeValue UGAV on UGAV.UserGlobalAttributeValueId = UGAVL.UserGlobalAttributeValueId 
				INNER JOIN @UserDetail UD ON  UGAV.UserId = UD.UserId and UGAV.GlobalAttributeId = UD.GlobalAttributeId
				LEFT JOIN ZnodeGlobalAttributeDefaultValue GADV ON GADV.GlobalAttributeId = UD.GlobalAttributeId AND UD.AttributeValue = GADV.AttributeDefaultValueCode
				
				INSERT INTO ZnodeUserGlobalAttributeValueLocale( UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate, GlobalAttributeDefaultValueId )
				SELECT UGAV.UserGlobalAttributeValueId, UD.LocaleId , UD.AttributeValue, @UserId, GETDATE(), @UserId , GETDATE(), GADV.GlobalAttributeDefaultValueId
				from ZnodeUserGlobalAttributeValue UGAV 
				INNER JOIN @UserDetail UD ON  UGAV.UserId = UD.UserId and UGAV.GlobalAttributeId = UD.GlobalAttributeId
				LEFT JOIN ZnodeGlobalAttributeDefaultValue GADV ON GADV.GlobalAttributeId = UD.GlobalAttributeId AND UD.AttributeValue = GADV.AttributeDefaultValueCode
				WHERE isnull(UD.AttributeValue,'') <> ''
				AND NOT EXISTS ( select * from ZnodeUserGlobalAttributeValueLocale UGAVL where UGAV.UserGlobalAttributeValueId = UGAVL.UserGlobalAttributeValueId)

				--Updating the import process status
				UPDATE ZnodeImportProcessLog
				SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
									WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
									WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
								END, 
					ProcessCompletedDate = getdate()
				WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportB2BCustomer @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportB2BCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCatalogCategory')
	DROP PROC Znode_ImportCatalogCategory
GO

CREATE PROCEDURE [dbo].[Znode_ImportCatalogCategory](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Catalog Category Product association
	
	-- Unit Testing : 
	--BEGIN TRANSACTION;
	--update ZnodeGlobalSetting set FeatureValues = '5' WHERE FeatureName = 'InventoryRoundOff' 
	--    DECLARE @status INT;
	--    EXEC [Znode_ImportInventory] @InventoryXML = '<ArrayOfImportInventoryModel>
	-- <ImportInventoryModel>
	--   <SKU>S1002</SKU>
	--   <Quantity>999998.33</Quantity>
	--   <ReOrderLevel>10</ReOrderLevel>
	--   <RowNumber>1</RowNumber>
	--   <ListCode>TestInventory</ListCode>
	--   <ListName>TestInventory</ListName>
	-- </ImportInventoryModel>
	--</ArrayOfImportInventoryModel>' , @status = @status OUT , @UserId = 2;
	--    SELECT @status;
	--    ROLLBACK TRANSACTION;
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertCatalogCategory TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, SKU varchar(300), CategoryCode varchar(200), DisplayOrder int, IsActive varchar(10), GUID nvarchar(400)
			--,Index Ind_SKU1 (SKU),Index Ind_CategoryName (CategoryName)
		);

		DECLARE @CategoryAttributId int;

		SET @CategoryAttributId =
		(
			SELECT TOP 1 PimAttributeId
			FROM ZnodePimAttribute AS ZPA
			WHERE ZPA.AttributeCode = 'CategoryCode' AND 
				  ZPA.IsCategory = 1
		);

		DECLARE @InventoryListId int;

		SET @SSQL = 'Select RowNumber,trim(SKU),CategoryCode,DisplayOrder ,IsActive,GUID FROM '+@TableName;
		INSERT INTO @InsertCatalogCategory( RowNumber, SKU, CategoryCode, DisplayOrder, IsActive, GUID )
		EXEC sys.sp_sqlexec @SSQL;

		----Removing Duplicate data
		;with cte as
		(
			select SKU, CategoryCode,max(RowNumber) as RowNumber from @InsertCatalogCategory
			group by SKU, CategoryCode
		)
		delete a from @InsertCatalogCategory a
		where  not exists (select * from CTE b where a.RowNumber = b.RowNumber )

		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @SKU TABLE
		( 
		   SKU nvarchar(300), PimProductId INT--, Index Ins_SKU (SKU)
		);
		INSERT INTO @SKU
			   SELECT b.AttributeValue, a.PimProductId
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;

		Declare @PimCategoryAttributeId int 
		set @PimCategoryAttributeId = (select top 1 PimAttributeId from ZnodePimAttribute where AttributeCode = 'CategoryCode')

		DECLARE @CategoryCode TABLE
		( 
			CategoryCode nvarchar(300), PimCategoryId int --index ind_101 (CategoryName)
		);
		INSERT INTO @CategoryCode
			   SELECT ZPCAL.CategoryValue, ZPCA.PimCategoryId
			   FROM ZnodePimCategoryAttributeValue AS ZPCA
					INNER JOIN
					ZnodePimCategoryAttributeValueLocale AS ZPCAL
					ON ZPCA.PimAttributeId = @PimCategoryAttributeId AND 
					ZPCA.PimCategoryAttributeValueId = ZPCAL.PimCategoryAttributeValueId;
					
		-- start Functional Validation 
		
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertCatalogCategory AS ii
			   WHERE ii.SKU NOT in 
			   (
				   SELECT SKU FROM @SKU  where SKU IS NOT NULL 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '105', 'CategoryCode', CategoryCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertCatalogCategory AS ii
			   WHERE ii.CategoryCode NOT IN 
			   (
				   SELECT CategoryCode FROM @CategoryCode  where CategoryCode IS NOT NULL 
			   );
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertCatalogCategory AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			FROM @InsertCatalogCategory AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		  SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		  FROM @InsertCatalogCategory AS ii  
		  WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No')

		  
		
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ CategoryCode - ' + ISNULL(CategoryCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertCatalogCategory IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertCatalogCategory
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber IS NOT NULL 
			--AND GUID = @NewGUID
		);

	
		
			  Declare @ZnodePimCategoryProduct TABLE (PimProductId int , PimCategoryId int , Status bit , DisplayOrder int) 
			  	
			  insert into @ZnodePimCategoryProduct (PimProductId , PimCategoryId , Status , DisplayOrder )
			  SELECT SKU.PimProductId, (Select top 1 PimCategoryId from @CategoryCode where ICC.CategoryCode = CategoryCode )  PimCategoryId
				 , CASE WHEN IsActive in ('True','1','Yes') Then 1 ELSE 0 END , DisplayOrder FROM @InsertCatalogCategory AS ICC INNER JOIN	 @SKU AS SKU ON ICC.SKU = SKU.SKU 
			
			  INSERT into ZnodePimCategoryProduct ( PimProductId, PimCategoryId, Status, DisplayOrder, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate) 
			  Select TABL.PimProductId, TABL.PimCategoryId, TABL.Status, TABL.DisplayOrder,@UserId, @GetDate, @UserId, @GetDate   from @ZnodePimCategoryProduct TABL    
			  Where NOT EXISTS (Select top 1 1 from ZnodePimCategoryProduct ZPCP where ZPCP.PimProductId = TABL.PimProductId and  ZPCP.PimCategoryId = TABL.PimCategoryId)

		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertCatalogCategory
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
 
		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCatalogCategory @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCatalogCategory',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomerAddress')
	DROP PROC Znode_ImportCustomerAddress
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomerAddress](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @LocaleId int= 0,@PortalId int ,@CsvColumnString nvarchar(max), @IsAccountAddress bit = 0 )
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@IsAllowGlobalLevelUserCreation NVARCHAR(10)

		DECLARE @GETDATE DATETIME= dbo.Fn_GETDATE();
		-- Retrive Value FROM global setting 
		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'
		-- Three type of import required three table varible for product , category AND brand

		CREATE TABLE #InsertCustomerAddress 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT,UserName NVARCHAR(512),FirstName VARCHAR(300),
			LastName VARCHAR(300),DisplayName NVARCHAR(1200),Address1 VARCHAR(300),Address2 VARCHAR(300),
			CountryName VARCHAR(3000),StateName VARCHAR(3000),CityName VARCHAR(3000),PostalCode VARCHAR(50),
			PhoneNumber VARCHAR(50),IsDefaultBilling BIT,IsDefaultShipping BIT	,IsActive BIT,ExternalId NVARCHAR(2000),
			CompanyName NVARCHAR(2000), GUID NVARCHAR(400)
		);
	
		SET @SSQL = ' INSERT INTO #InsertCustomerAddress ( RowNumber, ' + @CsvColumnString + ' ,GUID )
		SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		EXEC sys.sp_sqlexec @SSQL;

		-- start Functional Validation 
		----------------------------------------------
		IF (@IsAccountAddress = 0)
		BEGIN
			IF @IsAllowGlobalLevelUserCreation = 'true'
					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
						   SELECT '106', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
						   FROM #InsertCustomerAddress AS ii
						   WHERE ii.UserName NOT IN 
						   (
							   SELECT UserName FROM AspNetZnodeUser   WHERE PortalId = @PortalId
						   );
			ELSE 
					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
						   SELECT '106', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
						   FROM #InsertCustomerAddress AS ii
						   WHERE ii.UserName NOT IN 
						   (
							   SELECT UserName FROM AspNetZnodeUser   
						   );

					INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
							SELECT '8', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
							FROM #InsertCustomerAddress AS ii
							WHERE ISNULL(ltrim(rtrim(ii.UserName)), '') = ''

		 END

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'StateName', StateName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeState ZS INNER JOIN ZnodeCountry ZC ON ZS.CountryCode = ZC.CountryCode
			where ii.CountryName = ZC.CountryName AND ZS.StateName = ISNULL(ltrim(rtrim(ii.StateName)), ''))

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '8', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE NOT EXISTS(SELECT * FROM ZnodeCountry ZC WHERE ZC.CountryName = ISNULL(ltrim(rtrim(ii.CountryName)), '') )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '90', 'CountryName', CountryName, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress AS ii
		WHERE ISNULL(ltrim(rtrim(ii.CountryName)), '') <> ''
		AND NOT EXISTS(SELECT * FROM ZnodePortalCountry ZPC INNER JOIN ZnodeCountry ZC ON ZPC.CountryCode = ZC.CountryCode
		    WHERE PortalId = @PortalId AND ltrim(rtrim(ii.CountryName)) = ltrim(rtrim(ZC.CountryName)))

		 -- error log when atleast db have 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '63', 'IsDefaultBilling/IsDefaultShipping', IsDefaultBilling, @NewGUId, RowNumber, @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId
		FROM #InsertCustomerAddress IC WHERE  exists (
		SELECT TOP 1 1  FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		where ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
		AND ZA.IsDefaultShipping =IC.IsDefaultShipping )

		--Note : Content page import is not required 
		
		-- End Function Validation 	
		-----------------------------------------------
		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomerAddress IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		DELETE FROM #InsertCustomerAddress
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber IS NOT NULL 
			--AND GUID = @NewGUID
		);

		UPDATE ZA SET ZA.IsDefaultBilling = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName --and IC.IsDefaultBilling <> ZA.IsDefaultBilling 
		where IC.IsDefaultBilling = 1 

		UPDATE ZA SET ZA.IsDefaultShipping = 0
		FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
		INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
		INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
		INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName
		where IC.IsDefaultShipping = 1 

		DELETE FROM ZnodeImportLog  WHERE ImportProcessLogId = @ImportProcessLogId AND  ErrorDescription = '63'
		-- UPDATE Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomerAddress
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
		
		DELETE FROM #InsertCustomerAddress 
		WHERE NOT EXISTS
			(SELECT TOP 1 1 FROM 
				(
					SELECT ROW_NUMBER() OVER(PARTITION BY UserName	
					,FirstName	,LastName	,DisplayName	,Address1	,Address2	
					,CountryName	,StateName	,CityName	,PostalCode	
					,PhoneNumber	,IsDefaultBilling,IsDefaultShipping,ExternalId	,CompanyName ORDER BY RowId desc) 
					AS rw_nmbr,RowId  FROM #InsertCustomerAddress 
				) abc WHERE rw_nmbr =1 AND abc.RowId = #InsertCustomerAddress.RowId
			)

		----------UPDATE ZnodeAddress
		DECLARE @AddressColumnString VARCHAR(1000), @WhereConditionString VARCHAR(1000), @UpdateColumnString VARCHAR(1000)

		SELECT @AddressColumnString = COALESCE(@AddressColumnString + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' AND ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
		FROM ZnodeImportUpdatableColumns a
		INNER JOIN INFORMATION_SCHEMA.COLUMNS b ON a.ColumnName = b.COLUMN_NAME  
		INNER JOIN dbo.Split(@CsvColumnString,',')C ON b.COLUMN_NAME = c.Item
		WHERE b.TABLE_NAME = 'ZnodeAddress' 
		AND EXISTS(SELECT * FROM ZnodeImportHead IH WHERE a.ImportHeadId = IH.ImportHeadId AND IH.Name in ('CustomerAddress','ShippingAddress'))

		SELECT @UpdateColumnString = COALESCE(@UpdateColumnString + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
		FROM INFORMATION_SCHEMA.COLUMNS a
		INNER JOIN dbo.Split(@CsvColumnString,',')b ON a.COLUMN_NAME = b.Item
		WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString,',') c WHERE a.COLUMN_NAME = c.Item )
		AND a.TABLE_NAME = 'ZnodeAddress'

		SELECT @WhereConditionString = COALESCE(@WhereConditionString + ' AND ', '') +'ZA.'+item+' =  IC.'+item FROM dbo.split(@AddressColumnString,',')
		SET @WhereConditionString = Replace(@WhereConditionString , 'ZA.Address2 =  IC.Address2', 'ISNULL(ZA.Address2 ,'''')=  ISNULL(IC.Address2 ,'''')') 
		
		UPDATE a SET a.StateName =c.StateCode  
		FROM #InsertCustomerAddress a 
		INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		INNER JOIN ZnodeState c ON b.CountryCode = c.CountryCode AND C.StateName = a.StateName
		
		UPDATE a SET a.CountryName= b.CountryCode FROM  #InsertCustomerAddress a INNER JOIN ZnodeCountry b ON a.CountryName = b.CountryName 
		
		CREATE TABLE #InsertedUserAddress (AddressId  NVARCHAR(256), UserId NVARCHAR(max)) 

		IF ( @IsAccountAddress = 1 )
		BEGIN
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU 
			INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
													AND ZA.IsDefaultShipping =IC.IsDefaultShipping

					SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END

			EXEC (@SSQL)

					SET @SSQL = '
					Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
											StateName,CityName,PostalCode,PhoneNumber,
											IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
					OUTPUT INSERTED.AddressId INTO  #InsertedUserAddress (AddressId) 			 
					SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,null,IC.CountryName ,
					IC.StateName,
					,IC.CityName,IC.PostalCode,IC.PhoneNumber,
					isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(), 1, 1
					FROM  #InsertCustomerAddress IC
					WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'

			EXEC (@SSQL)

			DECLARE @AccountId INT
			SELECT @AccountId = AccountId FROM ZnodeUser WHERE UserId = @UserId
			INSERT INTO ZnodeAccountAddress ( AccountId, AddressId, CreatedBy, CreatedDate,	ModifiedBy,	ModifiedDate )
			SELECT @AccountId, Addressid ,  @UserId , @GETDATE, @UserId , @GETDATE FROM #InsertedUserAddress UA
			WHERE NOT EXISTS ( SELECT * FROM ZnodeAccountAddress AA WHERE AccountId = @AccountId AND AA.Addressid = UA.Addressid )
		END
		ELSE
		BEGIN
		
			UPDATE ZnodeAddress SET IsDefaultBilling = 0,  IsDefaultShipping = 0
			FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
			INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
			INNER JOIN ZnodeUserAddress ZUA ON ZUA.UserId = ZU.UserId
			INNER JOIN ZnodeAddress ZA ON ZUA.AddressId = ZA.AddressId
			INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName AND ZA.IsDefaultBilling =IC.IsDefaultBilling 
			AND ZA.IsDefaultShipping =IC.IsDefaultShipping
					
					SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA 
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END
						
					Print @SSQL
					EXEC (@SSQL)
									
					SET @SSQL = '
					Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
												StateName,CityName,PostalCode,PhoneNumber,
												IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsShipping,IsBilling)		
					OUTPUT INSERTED.AddressId, INSERTED.Address3 INTO  #InsertedUserAddress (AddressId, UserId ) 			 
					SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2,convert(nvarchar(100),ZU.UserId),IC.CountryName ,
					IC.StateName 
					,IC.CityName,IC.PostalCode,IC.PhoneNumber,
					isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate(),1,1
					FROM AspNetZnodeUser ANZU 
					INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
					INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
					INNER JOIN #InsertCustomerAddress IC ON ANZU.UserName = IC.UserName 
					WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'
					print @SSQL
					EXEC (@SSQL)

			INSERT INTO ZnodeUserAddress(UserId,AddressId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT CAST( UserId AS INT ) , Addressid , @UserId , @GETDATE, @UserId , @GETDATE FROM  #InsertedUserAddress
		END
				
		UPDATE ZA SET ZA.CountryName = ZC.CountryCode
		FROM ZnodeAddress ZA
		INNER JOIN ZnodeCountry ZC ON ltrim(rtrim(ZA.CountryName)) = ltrim(rtrim(ZC.CountryName))

		UPDATE ZA SET ZA.Address3 = null 
		FROM ZnodeAddress ZA INNER JOIN #InsertedUserAddress IUA ON ZA.AddressId = IUA.AddressId 

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomerAddress @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) +',@IsAccountAddress='+CAST(@IsAccountAddress AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GETDATE
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GETDATE, @UserId, @GETDATE, @ImportProcessLogId

		--Updating total AND fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomerAddress',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportHighlight')
	DROP PROC Znode_ImportHighlight
GO

CREATE PROCEDURE [dbo].[Znode_ImportHighlight](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @PimCatalogId int= 0)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Attribute Code Name and their default input validation rule other 
	--			  flag will be inserted as default we need to modify front end
	
	-- Unit Testing: 

	--------------------------------------------------------------------------------------
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max);
		DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
		SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();
		-- Retrive RoundOff Value from global setting 
		DECLARE @InsertPimAtrribute TABLE
		( 
			RowId int IDENTITY(1, 1) PRIMARY KEY,
			RowNumber int, HighlightCode varchar(300), HighlightName varchar(1000),DisplayPopup varchar(300),Hyperlink varchar(1000),HighlightType varchar(300),IsActive varchar(100),DisplayOrder int,HighlightImage varchar(500),HighlightImagePath varchar(500), Description varchar(max), ShortDescription varchar(max), ImageAltTag varchar(400), GUID nvarchar(400)
		
		);
		DECLARE @InsertedPimAttributeIds TABLE (PimAttributeId int ,PimAttributeDefaultValueId int,AttributeDefaultValueCode nvarchar(300))
		
		SET @SSQL = 'Select RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID FROM '+@TableName;
		INSERT INTO @InsertPimAtrribute( RowNumber,HighlightCode, HighlightName,DisplayPopup,Hyperlink,HighlightType,IsActive,DisplayOrder,HighlightImage,HighlightImagePath,Description,ShortDescription,ImageAltTag ,GUID)
		EXEC sys.sp_sqlexec @SSQL;


		--@MessageDisplay will use to display validate message for input inventory value  
		DECLARE @HighlightAttributeDefaultCode TABLE
		( 
		   AttributeDefaultCode nvarchar(300)
		);
		INSERT INTO @HighlightAttributeDefaultCode
			   SELECT AttributeDefaultValueCode
			   FROM ZnodePimAttributeDefaultValue ZPADV
			   inner join ZnodePimAttribute ZPA on ZPADV.PimAttributeId = ZPA.PimAttributeId
			   where ZPA.AttributeCode = 'Highlights' 

		-- Start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '9', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode not in 
			   (
				   SELECT AttributeDefaultCode FROM @HighlightAttributeDefaultCode 
			   );
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'DisplayPopup', DisplayPopup, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.DisplayPopup not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
			SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
			FROM @InsertPimAtrribute AS ii  
			WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '103', 'HighlightType', HighlightType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightType NOT in 
			   (
				   SELECT HT.Name  FROM ZnodeHighlightType  HT
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '17', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL ) AND  ii.DisplayOrder = 0

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			SELECT '64', 'DisplayOrder', DisplayOrder, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			FROM @InsertPimAtrribute AS ii
			WHERE (ii.DisplayOrder <> '' OR ii.DisplayOrder IS NOT NULL )AND  ii.DisplayOrder > 999

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '102', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ltrim(rtrim(isnull(ii.HighlightCode,''))) like '% %' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'HighlightCode', HighlightCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
			   FROM @InsertPimAtrribute AS ii
			   WHERE ii.HighlightCode in 
			   (
				   select HighlightCode  FROM @InsertPimAtrribute  Group BY HighlightCode  having count(*) > 1 
			   );

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Highlight - ' + ISNULL(HighlightCode,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @InsertPimAtrribute IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL


		-- End Function Validation 	
		-----------------------------------------------
		-- Delete Invalid Data after functional validatin  
		DELETE FROM @InsertPimAtrribute
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
		);
		
		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertPimAtrribute
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		

		DECLARE @MediaId INT
		SET @MediaId = (SELECT TOP 1 MediaId from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName and IPA.HighlightImagePath = ZM.Path)

		if (isnull(@MediaId,0)=0)
			SET @MediaId = (SELECT max(MediaId) from @InsertPimAtrribute IPA INNER JOIN ZnodeMedia ZM ON IPA.HighlightImage = ZM.FileName)

		DECLARE @InsertedZnodeHighlight TABLE(HighlightId INT,HighlightCode VARCHAR(600)) 

			UPDATE ZH SET ZH.DisplayPopup = IPA.DisplayPopup, ZH.Hyperlink = IPA.Hyperlink, ZH.IsActive = case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end,
			       ZH.DisplayOrder = IPA.DisplayOrder , ZH.ModifiedBy = @UserId, ZH.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId

			UPDATE ZHL SET ZHL.Name = IPA.HighlightName, ZHL.Description = IPA.Description, ZHL.ShortDescription = IPA.ShortDescription, ZHL.ImageAltTag = IPA.ImageAltTag
			       , ZHL.ModifiedBy = @UserId, ZHL.ModifiedDate = @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			INNER JOIN ZnodeHighlight ZH ON IPA.HighlightCode = ZH.HighlightCode and ZHT.HighlightTypeId = ZH.HighlightTypeId
			INNER JOIN ZnodeHighlightLocale ZHL  ON ZH.HighlightId = ZHL.HighlightId 

			INSERT INTO ZnodeHighlight (MediaId,HighlightCode,DisplayPopup,Hyperlink,HighlightTypeId,IsActive,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			OUTPUT Inserted.HighlightId,Inserted.HighlightCode INTO @InsertedZnodeHighlight
			SELECT DISTINCT @MediaId,IPA.HighlightCode, IPA.DisplayPopup , IPA.Hyperlink, ZHT.HighlightTypeId,
				   case when IPA.IsActive in ('True','1','Yes') then 1 else 0 end, Case when Isnull(IPA.DisplayOrder,0) = 0 then  999 else IPA.DisplayOrder end  , @UserId , @GetDate ,@UserId , @GetDate 
			FROM @InsertPimAtrribute IPA 
			INNER JOIN ZnodeHighlightType ZHT on IPA.HighlightType = ZHT.Name
			WHERE NOT EXISTS(select * from ZnodeHighlight ZH where ZH.HighlightCode = IPA.HighlightCode and ZH.HighlightTypeId = ZHT.HighlightTypeId)

			INSERT INTO ZnodeHighlightLocale(LocaleId,HighlightId,ImageAltTag,Name,Description,ShortDescription,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			SELECT DISTINCT @LocaleId, IZH.HighlightId, IPA.ImageAltTag, IPA.HighlightName, IPA.Description, IPA.ShortDescription, @UserId , @GetDate ,@UserId , @GetDate
			FROM @InsertPimAtrribute IPA 
			INNER JOIN @InsertedZnodeHighlight IZH on IPA.HighlightCode = IZH.HighlightCode 


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportHighlight @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PimCatalogId='+CAST(@PimCatalogId AS VARCHAR(max));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportHighlight',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportInventory_Ver1')
	DROP PROC Znode_ImportInventory_Ver1
GO

CREATE PROCEDURE [dbo].[Znode_ImportInventory_Ver1](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import Inventory data 
	--		   Input data in XML format Validate data with all scenario 
	-- Unit Testing : 
	--BEGIN TRANSACTION;
	--update ZnodeGlobalSetting set FeatureValues = '5' WHERE FeatureName = 'InventoryRoundOff' 
	--    DECLARE @status INT;
	--    EXEC [Znode_ImportInventory] @InventoryXML = '<ArrayOfImportInventoryModel>
	-- <ImportInventoryModel>
	--   <SKU>S1002</SKU>
	--   <Quantity>999998.33</Quantity>
	--   <ReOrderLevel>10</ReOrderLevel>
	--   <RowNumber>1</RowNumber>
	--   <ListCode>TestInventory</ListCode>
	--   <ListName>TestInventory</ListName>
	-- </ImportInventoryModel>
	--</ArrayOfImportInventoryModel>' , @status = @status OUT , @UserId = 2;
	--    SELECT @status;
	--    ROLLBACK TRANSACTION;
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @RoundOffValue int, @MessageDisplay nvarchar(100), @MessageDisplayForFloat nvarchar(100);
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		-- Retrive RoundOff Value from global setting 
		SELECT @RoundOffValue = FeatureValues
		FROM ZnodeGlobalSetting
		WHERE FeatureName = 'InventoryRoundOff';
		
		IF OBJECT_ID('tempdb.dbo.#InserInventoryForValidation', 'U') IS NOT NULL 
		DROP TABLE tempdb.dbo.#InserInventoryForValidation
		
		IF OBJECT_ID('tempdb.dbo.#InsertInventory ', 'U') IS NOT NULL 
		DROP TABLE tempdb.dbo.#InsertInventory 

		--@MessageDisplay will use to display validate message for input inventory value  

		DECLARE @sSql nvarchar(max);
		SET @sSql = ' Select @MessageDisplay_new = Convert(Numeric(28, '+CONVERT(nvarchar(200), @RoundOffValue)+'), 123.12345699 ) ';
		EXEC SP_EXecutesql @sSql, N'@MessageDisplay_new NVARCHAR(100) OUT', @MessageDisplay_new = @MessageDisplay OUT;
		SET @sSql = ' Select @MessageDisplay_new = Convert(Numeric(28, '+CONVERT(nvarchar(200), @RoundOffValue)+'), 0.999999 ) ';
		EXEC SP_EXecutesql @sSql, N'@MessageDisplay_new NVARCHAR(100) OUT', @MessageDisplay_new = @MessageDisplayForFloat OUT;
		Create TABLE tempdb..#InserInventoryForValidation 
		( 
				RowNumber int, SKU varchar(600), Quantity varchar(100), ReOrderLevel varchar(100), WarehouseCode varchar(300), GUID nvarchar(200)
		);

		CREATE INDEX IDX_#InserInventoryForValidation_SKU ON #InserInventoryForValidation(SKU)
		
		DECLARE @InventoryListId int;
		SET @SSQL = 'Select RowNumber,SKU,Quantity,ReOrderLevel,WarehouseCode ,GUID FROM '+@TableName;
		INSERT INTO tempdb..#InserInventoryForValidation( RowNumber, SKU, Quantity, ReOrderLevel, WarehouseCode, GUID )
		EXEC sys.sp_sqlexec @SSQL;
		

		UPDATE tempdb..#InserInventoryForValidation
		  SET ReOrderLevel = 0
		WHERE ISNULL(ReOrderLevel,'') = '';

		-- start Functional Validation 
		-----------------------------------------------
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM tempdb..#InserInventoryForValidation  AS ii
		WHERE NOT EXISTS( SELECT * FROM ZnodePimAttributeValue  AS a with(nolock)
			INNER JOIN ZnodePimAttributeValueLocale AS b with(nolock) ON a.PimAttributeValueId = b.PimAttributeValueId
			WHERE exists(Select top 1 PimAttributeId from ZnodePimAttribute zpa Where zpa.AttributeCode = 'SKU' and a.PimAttributeId = zpa.PimAttributeId)
			AND b.AttributeValue = ii.SKU);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '107', 'WarehouseCode', WarehouseCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM tempdb..#InserInventoryForValidation  AS ii
		WHERE NOT EXISTS ( SELECT TOP 1 1 FROM ZnodeWarehouse AS zw WHERE zw.WarehouseCode = ii.WarehouseCode );

		UPDATE ZIL SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InserInventoryForValidation IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  
		DELETE FROM tempdb..#InserInventoryForValidation 
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  GUID = @NewGUID
		);
		
		DECLARE @TBL_ReadyToInsertInventory TABLE
		( 
			RowNumber int, SKU varchar(300), Quantity numeric(28, 6), ReOrderLevel numeric(28, 6), WarehouseId int
		);

		--deleting duplicate rows
		delete  ii
		FROM tempdb..#InserInventoryForValidation  ii
		where ii.RowNumber not IN
			   (
				   SELECT MAX(ii1.RowNumber)
				   FROM tempdb..#InserInventoryForValidation  AS ii1
				   WHERE ii1.WarehouseCode = ii.WarehouseCode AND 
						 ii1.SKU = ii.SKU
			   );

		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InserInventoryForValidation
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End
		   	
		
		--select 'update started'  
		UPDATE zi SET Quantity = rtii.Quantity, ReOrderLevel = ISNULL(rtii.ReOrderLevel, 0), ModifiedBy = @UserId, ModifiedDate = @GetDate
		FROM ZNodeInventory zi
		INNER JOIN #InserInventoryForValidation rtii ON( zi.SKU = rtii.SKU )
		INNER JOIN ZnodeWarehouse AS zw ON rtii.WarehouseCode = zw.WarehouseCode and zi.WarehouseId = zw.WarehouseId;
			   
		--select 'update End'                
		INSERT INTO ZnodeInventory( WarehouseId, SKU, Quantity, ReOrderLevel, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
		SELECT zw.WarehouseId, SKU, Quantity, ISNULL(ReOrderLevel, 0), @UserId, @GetDate, @UserId, @GetDate
		FROM #InserInventoryForValidation AS rtii
		INNER JOIN ZnodeWarehouse AS zw on rtii.WarehouseCode = zw.WarehouseCode
		WHERE NOT EXISTS ( SELECT TOP 1 1 FROM ZnodeInventory AS zi WHERE zi.WarehouseId = zw.WarehouseId AND zi.SKU = rtii.SKU );
		 
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH

		ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportInventory_Ver1 @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportInventory_Ver1',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPartialValidatePimProductData')
	DROP PROC Znode_ImportPartialValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportPartialValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0  
)
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct ( for partial attribute import ) 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max), @FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
              --To get the total record count for update purpose in catch block
             SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			 INSERT INTO Znode_ImportCsvRowCount
			 EXEC (@SQLQuery) 

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;
		  -- If Exists ( Select  count(1)  from #GlobalTempTableColumns GROUP BY ColumnName  Having count(1) > 1 )
		  -- Begin
			 --   INSERT INTO ZnodeImportLog(ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
    --               Select  46,ColumnName,'',@newGUID,@UserId,@GetDate,@UserId,@GetDate, @ImportProcessLogId  from #GlobalTempTableColumns GROUP BY ColumnName  Having count(1) > 1 
				
				----'Multiple occurance of column are not allow for'
		  -- END

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();
             --Remove old error log 
             --DELETE FROM ZnodeImportLog WHERE ImportProcessLogId in (select ImportProcessLogId  FROM ZnodeImportProcessLog  WHERE ImportTemplateId  = @TemplateId )
             --GUID = @NewGUID;
             --Delete FROM ZnodeImportProcessLog  WHERE ImportTemplateId  = @TemplateId 
		
             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'ProductUpdate'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END



			--Retrive PimProductId on the basis of SKU for update product 
			SET @SQLQuery = 'UPDATE tlb SET tlb.PimProductId = ZPAV.PimProductId 
							FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
							(ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId) 
							INNER JOIN [dbo].[ZnodePimAttribute] ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId AND ZPA.AttributeCode= ''SKU'' 
							INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = ltrim(rtrim(tlb.SKU)) ';
			EXEC sys.sp_sqlexec	@SQLQuery	 	
	
			SET @SQLQuery = 'Select 98 ,''SKU'', SKU, '''+ @newGUID + ''',' + Convert(nvarchar(100),@UserId) + ',''' +  Convert(nvarchar(100),@GetDate) + ''',' + Convert(nvarchar(100),@UserId) + ',''' + Convert(nvarchar(100),@GetDate) + ''',' +  Convert(nvarchar(100),@ImportProcessLogId)  + ',RowNumber   from  '+ @TableName + ' where PimProductId Is null ';
			INSERT INTO ZnodeImportLog
                     (ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId,RowNumber )
        	EXEC sys.sp_sqlexec	@SQLQuery	 	


			--SET @SQLQuery = '
			--INSERT INTO ZnodeImportLog
			--		(ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId,RowNumber )
			--Select 98 ,''Attribute '', a.Name , '''+ @NewGUID + ''',' + Convert(nvarchar(100),@UserId) + ',''' +  Convert(nvarchar(100),@GetDate) + ''',' + Convert(nvarchar(100),@UserId) + ',''' + Convert(nvarchar(100),@GetDate) + ''',' +  Convert(nvarchar(100),@ImportProcessLogId)  + ',' +
			--' NULL  from tempdb.sys.columns a
			--inner join tempdb.sys.tables b on a.object_id = b.object_id 
			--where b.name in (''##ProductUpdate_' + @NewGUID +''') 
			--and NOT EXISTS (Select TOP 1 1 FROM ZnodePimAttribute PA WHERE a.name = PA.AttributeCode) AND a.Name <> ''guid''' 

   --     	EXEC sys.sp_sqlexec	@SQLQuery	 	

			SET @SQLQuery = 'Delete from  '+@TableName+ ' where PimProductId Is null ';
			EXEC sys.sp_sqlexec	@SQLQuery	 	
			
			DECLARE @RecordCount Bigint 
			SET @SQLQuery = ' Select @RecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
			EXEC sp_executesql @SQLQuery, N'@RecordCount BIGINT out' , @RecordCount=@RecordCount out


			--Generate new process for current import 
            --INSERT INTO ZnodeImportProcessLog(ImportTemplateId,Status,ProcessStartedDate,ProcessCompletedDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
            --SELECT @TemplateId,dbo.Fn_GetImportStatus(0),@GetDate,NULL,@UserId,@GetDate,@UserId,@GetDate;
            --SET @ImportProcessLogId = @@IDENTITY;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @ImportHeadName IN('ProductUpdate') AND @RecordCount > 0  
                 BEGIN 
					SET @IsCategory = 0 
				    --Get all default attribute values in attribute 
                    INSERT INTO @FamilyAttributeDetail
                    (PimAttributeId,AttributeTypeName,AttributeCode,SourceColumnName,IsRequired,PimAttributeFamilyId)
                    --Call Process to insert data of defeult family with source column name and target column name 
					SELECT distinct zpa.PimAttributeId, zat.AttributeTypeName, zpa.AttributeCode, zitm.SourceColumnName, zpa.IsRequired ,0
					FROM dbo.ZnodePimAttribute AS zpa INNER JOIN dbo.ZnodeAttributeType AS zat ON zat.AttributeTypeId = zpa.AttributeTypeId 
					LEFT OUTER JOIN dbo.ZnodeImportTemplateMapping AS zitm
					ON zpa.AttributeCode = zitm.SourceColumnName AND zitm.ImportTemplateId = @TemplateId
					WHERE zpa.IsCategory = 0 
	             END;
            -- Check attributes are manditory and not provided with source table
		   	if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
		 
     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId )
            EXEC sys.sp_sqlexec  @SQLQuery;
            IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )  AND @RecordCount > 0  
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('ProductUpdate', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             --INSERT INTO ZnodeImportLog
                             --(ErrorDescription,
                             -- ColumnName,
                             -- Data,
                             -- GUID,
                             -- CreatedBy,
                             -- CreatedDate,
                             -- ModifiedBy,
                             -- ModifiedDate,
                             -- ImportProcessLogId
                             --)
                             --       SELECT '14' AS ErrorDescription,
                             --              AttributeCode,
                             --              '',
                             --              @NewGUID,
                             --              @UserId,
                             --              @GetDate,
                             --              @UserId,
                             --              @GetDate,
                             --              @ImportProcessLogId
                             --       FROM @FamilyAttributeDetail
                             --       WHERE ISNULL(SourceColumnName, '') = ''
                             --             AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							 ---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							 Delete FAD from @AttributeDetail FAD
							 where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							 and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
                             IF NOT EXISTS
                             (
                                 SELECT TOP 1 1
                                 FROM INFORMATION_SCHEMA.TABLES
                                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeCode'
                             )
                                 BEGIN
                                     CREATE TABLE #DefaultAttributeCode
                                     (AttributeTypeName          VARCHAR(300),
                                      PimAttributeDefaultValueId INT,
                                      PimAttributeId             INT,
                                      AttributeDefaultValueCode  VARCHAR(100)
                                     );
                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;
                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';
                                 END;
                             ELSE
                                 BEGIN
                                     DROP TABLE #DefaultAttributeCode;
                                 END;
                         END;

                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
						
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
									--For link product
									DECLARE @IsIgnoreProcess BIT = CASE WHEN EXISTS (SELECT TOP 1 1 FROM ZnodePimAttribute WHERE AttributeCode = (SELECT TOP 1 TargetColumnName
								    FROM ZnodeImportTemplateMapping a 
									INNER JOIN ZnodeImportTemplate b ON (b.ImportTemplateId = a.ImportTemplateId )
									WHERE TemplateName = 'ProductUpdate'
									AND a.TargetColumnName <> 'SKU'
								   )
								    AND AttributeTypeId = (SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE  AttributeTypeName = 'link' )
								   ) THEN 1 ELSE 0 END 
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId,
										  @IsIgnoreProcess = @IsIgnoreProcess;
                                 END;
                             IF @AttributeTypeName = 'Image'
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

								 --For link product
								 IF @AttributeTypeName = 'Link'
                                 BEGIN
										--To get the product SKU in temp table
										SELECT ZPAV.PimProductId, ZPAVL.AttributeValue as SKU
										INTO #ProductSKU
										FROM ZnodePimAttributeValue ZPAV
										INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId 
										WHERE EXISTS(SELECT * FROM ZnodePimAttribute ZPA WHERE ZPAV.PimAttributeId = zpa.PimAttributeId AND ZPA.AttributeCode = 'SKU')

                                     	SET @SQLQuery = 'SELECT ''98'' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,RowNumber ,GUID,  '+@CreateDateString+' 
											FROM '+@TableName+' a 
											CROSS APPLY DBO.SPLIT('+@SourceColumnName+','','')S WHERE RowNumber in (SELECT RowNumber FROM '+@TableName+' WHERE  NOT EXISTS  (Select TOP 1 1  FROM #ProductSKU WHERE SKU = S.Item ) 
											)
											';
                     
											INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
											EXEC sys.sp_sqlexec @SQLQuery;
				
                                 END;

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('ProductUpdate', 'Category')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                                   ---Verify Image file is exists in media table or not 
                                             SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
                                             SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
                                             (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
                                              DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
                                             ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
                                             )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
                                             + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''

						
                                             EXEC sys.sp_sqlexec @SQLQuery;
                                             -- Check Invalid Image 
                                             
											 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
                                             Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
                                             INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
                                             EXEC sys.sp_sqlexec @SQLQuery;

											 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
            --COMMIT TRAN TRN_ImportValidProductData;
			 

		IF @ImportHeadName IN('ProductUpdate')
		 BEGIN
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000)   	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId

		
  	--	 SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName = ''SKU  '' + ' + '  ' +@SourceColumnNameProduct + ' ' + ' + ' + ' '  + ' ZIL.ColumnName + ''  Attribute''
		 --FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			--  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber is not null';
            
			--SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  ' +@SourceColumnNameProduct+ '+' + ''' ]'' 
		 --   FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			--WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
   --         PRINT @SQLQueryNew

            SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  ' +@SourceColumnNameProduct+ '+' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew

			EXEC sys.sp_sqlexec  @SQLQueryNew;
			
		END 

					 	 		 
  			 SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber in (Select Rownumber from ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber is not null)';
             EXEC sys.sp_sqlexec  @SQLQuery;

			 ---------------------------------------------------------------------------

		--	 Declare @SourceColumnNameProduct nvarchar(4000)  
		--	 Declare @SQLQueryNew NVARCHAR(4000) 	 
		-- SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		-- AND ImportTemplateId = @TemplateId


		--INSERT INTO ZnodeImportLog  (ErrorDescription,ColumnName, Data, GUID,CreatedBy,
  --          CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
		--	EXEC sys.sp_sqlexec  @SQLQueryNew;

		--	SET @SQLQueryNew = 'SELECT ''Successfully Imported '' ErrorDescription,''SKU'',
		--	'''+@SourceColumnNameProduct+''' AS [Data], 
  --          RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM '+@TableName+' WHERE Rownumber IS NOT NULL'

------------------------------------------------------------------------------------------------

		 --SET @SQLQuery = 'Select *  FROM  '+@TableName
   --          EXEC sys.sp_sqlexec  @SQLQuery;

             IF @ImportHeadName IN('ProductUpdate')
                 BEGIN
                     IF NOT EXISTS
                
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN (43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 ) AND @RecordCount > 0 
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN
                                     EXEC Znode_ImportPartialPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
	
                                 END;
                            
                         END;

					ELSE 
					BEGIN
					-- Update Record count in log 					
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					
					SELECT @SuccessRecordCount = 0
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
					WHERE ImportProcessLogId = @ImportProcessLogId;
					END

                 END
				
			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
			SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
			
			EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out

			UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
			WHERE ImportProcessLogId = @ImportProcessLogId;

		   EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             -- Finally call product insert process if error not found in error log table 
             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE ImportProcessLogId = @ImportProcessLogId
                       AND Guid = @NewGUID
             )
                 BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 END;
		
				--SET @SQLQuery = 'select TOP 1 * from  ' + @TableName
				--EXEC sys.sp_sqlexec @SQLQuery;
        END TRY
      
		BEGIN CATCH 
		DECLARE @TempCount TABLE (Id INT)

		Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
		INSERT INTO @TempCount
		EXEC (@SQL)

			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPartialValidatePimProductData @ImportHeadName = '''+ISNULL(@ImportHeadName,'''''')+''',@TableName='''+ISNULL(CAST(@TableName AS
			VARCHAR(50)),'''''')+''',@TemplateId='+ISNULL(CAST(@TemplateId AS VARCHAR(50)),'''')+',@NewGUID='''+ISNULL(@NewGUID,'''''')+''',@UserId='+ISNULL(CAST(@UserId AS VARCHAR(50)),'''')+',@LocaleId='+ISNULL(CAST(@LocaleId AS VARCHAR(50)),'''')+',
			@IsCategory='+ISNULL(CAST(@IsCategory AS VARCHAR(50)),'''')+',@DefaultFamilyId='+ISNULL(CAST(@DefaultFamilyId AS VARCHAR(50)),'''')+',@ImportProcessLogId='+ISNULL(CAST(@ImportProcessLogId AS VARCHAR(50)),'''')+',
			@PriceListId='+ISNULL(CAST(@PriceListId AS VARCHAR(50)),'''')+',@CountryCode='''+ISNULL(CAST(@CountryCode AS VARCHAR(50)),'''''')+''',@PimCatalogId='+ISNULL(CAST(@PimCatalogId AS VARCHAR(50)),'''')+',
			@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(50)),'''')+',@IsAccountAddress='+ISNULL(CAST(@IsAccountAddress AS VARCHAR(50)),'''')

			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;       
			
			---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportPartialValidatePimProductData',
			@ErrorInProcedure = 'Znode_ImportPartialValidatePimProductData',
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
		END CATCH 

     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPriceList')
	DROP PROC Znode_ImportPriceList
GO

CREATE PROCEDURE [dbo].[Znode_ImportPriceList]
(
	@TableName nvarchar(100),
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int,
	@NewGUId nvarchar(200),
	@PriceListId int )
AS 
	/*
	----Summary:  Import RetailPrice List 
	----		  Input XML data extracted in table format (table variable name:  #InsertPriceForValidation) by using  @xml.nodes 
	----		  Validate data column wise and store error log into @ErrorLogForInsertPrice table 
	----          Remove wrong data from table #InsertPriceForValidation and inserted correct data into @InsertPrice table for 
	----		  further processing (Importing to target database )
	---- Version 1 : Required Validation 
	---- UomName should not be null 
	---- Data for this RetailPrice list is already available  
	---- Version 2 : Required Validation 
	---- If UomName will be null then insert first record from UomTable and If UomName is wrong then raise error
	---- SKU with retailprice data is available with price list id will insert 
	---- multiple SKU with retail price is available then updated last sku details to price table and price tier table for respective price list
	----1. Import functionality should be provided only for single price list (Validate - Pending) 
	----  Tier price : TierStartQuantity should not between TierStartQuantity and TierEndQuantity for already existing SKU 
	----  In case of update details for SKU if any kind of price value will null then avoid it to update on existing value. 
	----2. From XML only SKU and RetailPrice is mandatory
	----3. SKUActivation date sholud be less than SKUExpriration date
	----4. Activation date sholud be less than Expiration date
	----5. If Tier RetailPrice has values and TierSartQuantity /TierEndQuantity or both has null value then it should not get updated/created.
	----6. ActivationDate and ExpirationDate value for tier price will be SKUActivationDate SKUExprirationDate 
	--- Change History : 
	--Remove column which is used to store range of qunatity by single column Quantity from table ZnodeTierProduct 
	--Manditory Retail price in Znodepricetable 
	-- SKUActivationfrom date and to date will used for tier price will store in single table ZnodePrice
	--Unit Testing   
	
*/
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
	    DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		
		IF OBJECT_ID('#InsertPriceForValidation', 'U') IS NOT NULL 
			DROP TABLE #InsertPriceForValidation
		ELSE 
			CREATE TABLE #InsertPriceForValidation 
			(SKU varchar(300) NULL, TierStartQuantity varchar(300) NULL, RetailPrice varchar(300) NULL, SalesPrice varchar(300) NULL, TierPrice varchar(300) NULL, SKUActivationDate varchar(300) NULL, SKUExpirationDate varchar(300) NULL,
			Custom1 varchar(300) NULL, Custom2 varchar(300) NULL, Custom3 varchar(300) NULL,CostPrice varchar(100), RowNumber varchar(300) NULL)

		IF OBJECT_ID('#InsertPrice', 'U') IS NOT NULL 
			DROP TABLE #InsertPrice
		ELSE 
			CREATE TABLE #InsertPrice 
			( 
				SKU varchar(300), TierStartQuantity numeric(28, 6) NULL, RetailPrice numeric(28, 6) NULL, SalesPrice numeric(28, 6) NULL, TierPrice numeric(28, 6) NULL, SKUActivationDate varchar(300) NULL, SKUExpirationDate varchar(300) NULL,
				Custom1 varchar(300) NULL, Custom2 varchar(300) NULL, Custom3 varchar(300) NULL,CostPrice numeric(28, 6), RowNumber varchar(300)
			);
	
	
		DECLARE @SKU TABLE
		( 
				SKU nvarchar(300)
		);
		INSERT INTO @SKU
			   SELECT b.AttributeValue
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;


		DECLARE @RoundOffValue int, @MessageDisplay nvarchar(100); 
		-- Retrive RoundOff Value from global setting 

		SELECT @RoundOffValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'PriceRoundOff';
	
		--@MessageDisplay will use to display validate message for input inventory value  

		DECLARE @sSql nvarchar(max);
		SET @sSql = ' Select @MessageDisplay_new = Convert(Numeric(28, '+CONVERT(nvarchar(200), @RoundOffValue)+'), 999999.000000000 ) ';
		EXEC SP_EXecutesql @sSql, N'@MessageDisplay_new NVARCHAR(100) OUT', @MessageDisplay_new = @MessageDisplay OUT;
		

		SET @SSQL = 'Select SKU,TierStartQuantity ,RetailPrice,SalesPrice,TierPrice,SKUActivationDate ,SKUExpirationDate ,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber FROM '+@TableName;
		INSERT INTO #InsertPriceForValidation( SKU, TierStartQuantity, RetailPrice, SalesPrice, TierPrice, SKUActivationDate, SKUExpirationDate,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber )
		EXEC sys.sp_sqlexec @SSQL;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'TierPrice', TierPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(TierPrice)=0  
				or exists(select * from ZnodeCulture where Symbol is not null and TierPrice like '%'+Symbol+'%')) and ISNULL(TierPrice,'')<>''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'SalesPrice', SalesPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(SalesPrice)=0	or exists(select * from ZnodeCulture where Symbol is not null and SalesPrice like '%'+Symbol+'%'))
				and ISNULL(SalesPrice,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'RetailPrice', RetailPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(RetailPrice)=0 or exists(select * from ZnodeCulture where Symbol is not null and RetailPrice like '%'+Symbol+'%')) and ISNULL(RetailPrice,'')<>''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'CostPrice', CostPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(CostPrice)=0	or exists(select * from ZnodeCulture where Symbol is not null and CostPrice like '%'+Symbol+'%'))
				and ISNULL(CostPrice,'')<>''
		
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertPriceForValidation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL
			   			  	
	    --- Delete Invalid Data after functional validation 
		DELETE FROM #InsertPriceForValidation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  Guid = @NewGUId
		);
		-- 1)  Validation for SKU is pending Proper data not found and 
		--Discussion still open for Publish version where we create SKU and use the SKU code for validation 
		--Select * from ZnodePimAttributeValue  where PimAttributeId =248
		--select * from View_ZnodePimAttributeValue Vzpa Inner join ZnodePimAttribute Zpa on Vzpa.PimAttributeId=Zpa.PimAttributeId where Zpa.AttributeCode = 'SKU'
		--Select * from ZnodePimAttribute where AttributeCode = 'SKU'
		--------------------------------------------------------------------------------------
		--2)  Start Data Type Validation for XML Data  
		--------------------------------------------------------------------------------------			
		---------------------------------------------------------------------------------------
		---------If UOM will blank then retrive top -- Finctionality pending 
		---Validate 
		
		INSERT INTO #InsertPrice( SKU, TierStartQuantity, RetailPrice, SalesPrice, TierPrice, SKUActivationDate, SKUExpirationDate,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber )
			   SELECT SKU,
					  CASE
					  WHEN CONVERT(Varchar(100),TierStartQuantity) = '' THEN 0
					  ELSE CONVERT(numeric(28, 6), TierStartQuantity)
					  END, CONVERT(numeric(28, 6), RetailPrice),
															  CASE
															  WHEN SalesPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), SalesPrice)
															  END,
															  CASE
															  WHEN TierPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), TierPrice)
															  END, SKUActivationDate, SKUExpirationDate,
															   Custom1, Custom2, Custom3,
															   CASE
															  WHEN CostPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), CostPrice)
															  END, RowNumber
			   FROM #InsertPriceForValidation;
			 
		--------------------------------------------------------------------------------------
		--- start Functional Validation 
		--------------------------------------------------------------------------------------
		--- Verify SKU is present or not 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertPrice AS ii
		WHERE ii.SKU NOT IN
		(
			SELECT SKU
			FROM @SKU
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '39', 'SKUActivationDate', SKUActivationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPrice AS IP
			   WHERE SKUActivationDate < SKUExpirationDate AND 
					 ISNULL(SKUExpirationDate, '') <> '';
					 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '108', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation
			   WHERE( TierPrice IS NULL OR TierPrice = '0') AND  TierStartQuantity  = '';
			  
			  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '109', 'TierPrice', TierPrice, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation WHERE( TierPrice IS NULL OR  TierPrice = '') AND TierStartQuantity  <> 0;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '26', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation IPV
			   WHERE TierStartQuantity = ''  
				AND	( TierPrice <> ''  OR TierPrice IS NULL ) 

			  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '26', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation IPV
			   WHERE TierStartQuantity <> '' AND 
			    ISNULL(CAST(TierStartQuantity AS numeric(28, 6)), 0) <= 0 
				AND	( TierPrice <> ''  OR TierPrice IS NULL ) 
		
		
				  
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertPrice IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

			 
 	
		-- End Function Validation 	
		---------------------------
		--- Delete Invalid Data after functional validation 
		DELETE FROM #InsertPrice
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  Guid = @NewGUId
		);
	
		-- Remove duplicate records 
		--insert into @RemoveDuplicateInsertPrice
		--(SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber )
		--Select SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber FROM @InsertPrice 
		
		--Delete from @InsertPrice 

		--insert into @InsertPrice (SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber)
		--Select SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber from @RemoveDuplicateInsertPrice rdip WHERE rdip.RowNumber IN
		--(
		--	SELECT MAX(ipi.RowNumber) FROM @InsertPrice ipi WHERE rdip.PriceListCode = ipi.PriceListCode AND rdip.SKU = ipi.SKU
		--);

		--Validate StartQuantity and EndQuantity from PriceTier : This validation only for existing data 
		--INSERT INTO @ErrorLogForInsertPrice (RowNumber,SKU,TierStartQuantity ,RetailPrice ,SalesPrice,TierPrice,Uom ,UnitSize,PriceListCode,PriceListName,CurrencyId ,ActivationDate,ExpirationDate,SKUActivationDate,SKUExpirationDate,SequenceNumber,ErrorDescription) 
		--Select IP.RowNumber,IP.SKU,IP.TierStartQuantity ,IP.RetailPrice ,IP.SalesPrice,IP.TierPrice,IP.Uom ,IP.UnitSize,IP.PriceListCode,IP.PriceListName,IP.CurrencyId ,IP.ActivationDate,IP.ExpirationDate,IP.SKUActivationDate,IP.SKUExpirationDate,IP.SequenceNumber,
		--'TierStartQuantity already exists in PriceTier table for SKU '
		--From @InsertPrice IP  Inner join
		--ZnodePriceList Zpl ON Zpl.Listcode = IP.PriceListcode and Zpl.ListName = IP.PriceListName
		--INNER JOIN ZnodeUOM Zu ON ltrim(rtrim(IP.Uom)) = ltrim(rtrim(Zu.Uom)) 
		--INNER JOIN ZnodePriceTier ZPT  ON ZPT.PriceListId = Zpl.PriceListId 
		--AND ZPT.SKU = IP.SKU
		--Where IP.TierStartQuantity  = ZPT.Quantity  
		--- Delete Invalid Data after  Validate StartQuantity and EndQuantity from PriceTier
		
		--INSERT INTO ZnodeUOM (Uom,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--Select distinct ltrim(rtrim(Uom)) , @UserId,@GetDate,@UserId,@GetDate  from @InsertPrice 
		--where ltrim(rtrim(Uom)) not in (Select ltrim(rtrim(UOM)) From ZnodeUOM where UOM  is not null )
		
		DECLARE @FailedRecordCount BIGINT, @SuccessRecordCount BIGINT 
	
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;

		SELECT @SuccessRecordCount = COUNT(DISTINCT ROWNUMBER) FROM #InsertPrice WHERE 	ROWNUMBER IS NOT NULL ;

		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		UPDATE ZP
				SET ZP.SalesPrice = IP.SalesPrice, ZP.RetailPrice = CASE
				WHEN CONVERT(varchar(100), ISNULL(IP.RetailPrice, '')) <> '' THEN IP.RetailPrice
				END, ZP.ActivationDate = CASE
				WHEN ISNULL(IP.SKUActivationDate, '') <> '' THEN IP.SKUActivationDate
				ELSE NULL
				END, ZP.ExpirationDate = CASE
				WHEN ISNULL(IP.SKUExpirationDate, '') <> '' THEN IP.SKUExpirationDate
				ELSE NULL
				END, ZP.ModifiedBy = @UserId, ZP.ModifiedDate = @GetDate,
				ZP.CostPrice =IP.CostPrice
		FROM #InsertPrice IP INNER JOIN ZnodePrice ZP ON ZP.PriceListId = @PriceListId AND  ZP.SKU = IP.SKU  
			 --Retrive last record from price list of specific SKU ListCode and Name 									
		WHERE IP.RowNumber IN
		(
			SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU 
		);
		INSERT INTO ZnodePrice( PriceListId, SKU, SalesPrice, RetailPrice, ActivationDate, ExpirationDate, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate,CostPrice )
			   SELECT @PriceListId, IP.SKU, IP.SalesPrice, IP.RetailPrice,
																						   CASE
																						   WHEN ISNULL(IP.SKUActivationDate, '') = '' THEN NULL
																						   ELSE IP.SKUActivationDate
																						   END,
																						   CASE
																						   WHEN ISNULL(IP.SKUExpirationDate, '') = '' THEN NULL
																						   ELSE IP.SKUExpirationDate
																						   END, @UserId, @GetDate, @UserId, @GetDate,IP.CostPrice
			   FROM #InsertPrice AS IP
			   WHERE NOT EXISTS
			   (
				   SELECT TOP 1 1
				   FROM ZnodePrice
				   WHERE ZnodePrice.PriceListId = @PriceListId AND 
						 ZnodePrice.SKU = IP.SKU 
			   ) AND 
					 IP.RowNumber IN
			   (
					SELECT MAX(IPI.RowNumber)
					FROM #InsertPrice AS IPI
					WHERE IPI.SKU = IP.SKU 
			   );

			 

		IF EXISTS
		(
			SELECT TOP 1 1
			FROM #InsertPrice
			WHERE CONVERT(varchar(100), TierStartQuantity) <> '' AND 
				  (CONVERT(varchar(100), TierPrice) <> '' OR CONVERT (varchar(100), TierPrice) IS NOT NULL)
		)
		BEGIN
		
			UPDATE ZPT
			  SET ZPT.Price = IP.TierPrice, ZPT.ModifiedBy = @UserId, ZPT.ModifiedDate = @GetDate,
			  ZPT.Custom1 = IP.Custom1,ZPT.Custom2 = IP.Custom2, ZPT.Custom3 = IP.Custom3 
			FROM #InsertPrice IP INNER JOIN ZnodePriceTier ZPT ON ZPT.PriceListId = @PriceListId AND  ZPT.SKU = IP.SKU AND ZPT.Quantity = IP.TierStartQuantity 
		    --Retrive last record from price list of specific SKU ListCode and Name 
			WHERE IP.RowNumber IN
			(
				SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU AND IPI.TierStartQuantity = IP.TierStartQuantity 
			);

			INSERT INTO ZnodePriceTier( PriceListId, SKU, Price, Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, Custom1, Custom2, Custom3 )
				   SELECT @PriceListId, IP.SKU, IP.TierPrice, IP.TierStartQuantity,  @UserId, @GetDate, @UserId, @GetDate, Custom1, Custom2, Custom3
				   FROM #InsertPrice AS IP 
				   WHERE NOT EXISTS
				   (
					   SELECT TOP 1 1 FROM ZnodePriceTier WHERE ZnodePriceTier.PriceListId = @PriceListId AND  ZnodePriceTier.SKU = IP.SKU AND 
							 ZnodePriceTier.Quantity = IP.TierStartQuantity
				   ) AND  IP.RowNumber IN
				   (
					   SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU AND  IPI.TierStartQuantity = IP.TierStartQuantity
				   );
		END;  

		SET @Status = 1;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		-- COMMIT TRAN ImportProducts;
		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPriceList @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PriceListId='+CAST(@PriceListId AS VARCHAR(max));
		
		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportPriceList',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSEODetails')
	DROP PROC Znode_ImportSEODetails
GO

CREATE PROCEDURE [dbo].[Znode_ImportSEODetails]
(  
   @TableName NVARCHAR(100), 
   @Status BIT OUT, 
   @UserId INT, 
   @ImportProcessLogId INT, 
   @NewGUId NVARCHAR(200), 
   @LocaleId INT= 1,
   @PortalId INT ,
   @CsvColumnString NVARCHAR(max)
)  
AS  
 --------------------------------------------------------------------------------------  
 -- Summary :  Import SEO Details  
   
 -- Unit Testing :   
 --------------------------------------------------------------------------------------  
  
BEGIN  
BEGIN TRAN A;  
BEGIN TRY  
   
	DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max);  
	DECLARE @GetDate DATETIME= dbo.Fn_GetDate();  
    
    
	DECLARE @CMSSEOTypeProduct INT ,@CMSSEOTypeCategory INT  
  
	SELECT @CMSSEOTypeProduct = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product'  
	SELECT @CMSSEOTypeCategory = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Category'  
  
  
	-- Three type of import required three table varible for product , category AND brAND  
	DECLARE @InsertSEODetails TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),   
		RobotTag VARCHAR(50), GUID NVARCHAR(400)  
	);  
  
	DECLARE @InsertSEODetailsOFProducts TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
	DECLARE @InsertSEODetailsOFCategory TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200), 
		RobotTag VARCHAR(50),GUID NVARCHAR(400)
	);  
  
	DECLARE @InsertSEODetailsOFBrAND TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
    
	DECLARE @InsertedZnodeCMSSEODetail TABLE  
	(   
		CMSSEODetailId INT , SEOCode Varchar(4000), CMSSEOTypeId INT  
	);  
    
	--SET @SSQL = 'SELECT RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,GUID  FROM '+@TableName;  
	SET @SSQL = 'SELECT RowNumber,'+@CsvColumnString+',GUID  FROM '+@TableName;  
  
	INSERT INTO @InsertSEODetails(RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,RedirectFrom,RedirectTo,EnableRedirection,CanonicalURL,RobotTag,GUID )  
	EXEC sys.sp_sqlexec @SSQL;  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '30', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.SEOURL IN (SELECT ISD.SEOURL FROM @InsertSEODetails ISD Group by ISD.SEOUrl having count(*) > 1 ) 
	    
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '10', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.SEOUrl = ii.SEOUrl AND ZCSD.PortalId = @PortalId
	AND ZCSD.SEOCode <> ii.Code  AND EXISTS  
	(SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale dl WHERE dl.CMSSEODetailId = ZCSD.CMSSEODetailId AND dl.LocaleId = @LocaleId  
	AND dl.SEODescription = ii.SEODescription AND dl.SEOTitle = ii.SEOTitle AND dl.SEOKeywords = ii.SEOKeywords))   
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '53', 'RedirectFrom', RedirectFrom, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM IN (SELECT ISD.RedirectFROM FROM @InsertSEODetails ISD Group by ISD.RedirectFROM having count(*) > 1 )   
	AND (ii.RedirectFROM <> '' )

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '35', 'RedirectFrom\RedirectTo', RedirectFROM + '  ' + RedirectTo  , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM = ii.RedirectTo  
	AND (ii.RedirectFROM <> '' AND ii.RedirectTo <> '' )
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '102', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE LTRIM(RTRIM(ISNULL(ii.SEOUrl,''))) like '% %' -----space not allowed  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'ImportType', ImportType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.ImportType NOT IN   
	(  
		SELECT NAME FROM ZnodeCMSSEOType WHERE NAME NOT IN ('Content Page','BlogNews','Brand')  
	);  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.IsActive not IN ('True','1','Yes','FALSE','0','No')
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '9', 'RobotTag', RobotTag, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.RobotTag not IN ( 'INDEX_FOLLOW','NOINDEX_NOFOLLOW','NOINDEX_FOLLOW','INDEX_NOFOLLOW','1','2','3','4') 
	AND ISNULL(ii.RobotTag,'')<>''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SEOCode - ' + ISNULL(Code,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSEODetails IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	DELETE FROM @InsertSEODetails  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  

	-------------------------------------------------------------------------------------------------------------------------------  
  
	INSERT INTO @InsertSEODetailsOFProducts(  RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
	CASE WHEN IsActive IN ('True','1','Yes') 
	Then 1 
	ELSE 0
	END as IsActive, SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Product'  
  
  
	INSERT INTO @InsertSEODetailsOFCategory( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Category'  
  
	INSERT INTO @InsertSEODetailsOFBrand( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl ,
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Brand'  
  
  
	-- start Functional Validation   
	--1. Product  
	--2. Category  
	--3. Content Page  
	--4. BrAND  
	-----------------------------------------------  
  
    
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'SKU', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFProducts AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPAVL.AttributeValue  
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'SKU' AND ZPAVL.AttributeValue IS NOT NULL   
	)  AND ImportType = 'Product';  
  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'Category', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFCategory AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPCAVL.CategoryValue  
		FROM ZnodePimCategoryAttributeValue ZPCAV   
		INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAVL on ZPCAV.PimCategoryAttributeValueId = ZPCAVL.PimCategoryAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPCAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPCAVL.CategoryValue IS NOT NULL  
	)  AND ImportType = 'Category';  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'Brand', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFBrAND AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT BrandCode FROM ZnodeBrandDetails WHERE BrandCode IS NOT NULL  
	)  AND ImportType = 'Brand';  
    
	-- UPDATE Record count IN log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSEODetails
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;
	

	--Note : Content page import is not required   
    
	-- End Function Validation    
	-----------------------------------------------  
	--- Delete Invalid Data after functional validatin    
 
	DELETE FROM @InsertSEODetailsOFProducts  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFCategory  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFBrAND  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
 
	-- Insert Product Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFProducts)  
	BEGIN  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords
			,ZCSDL.CanonicalURL = ISD.CanonicalURL
			,ZCSDL.RobotTag = ISD.RobotTag  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId = @PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		----Making product as draft if SEOUrl is changed for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertSEODetailsOFProducts ISD    
			INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code
			WHERE ZPAVL.AttributeValue = ZCSD.SEOCode)
     
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate, CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeProduct   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
     
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeProduct,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate FROM   
		@InsertSEODetailsOFProducts ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code AND  ZCSD.PortalId =@PortalId   );  
    
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFProducts ISD ON IZCSD.SEOCode = ISD.Code   

		----Making product as draft if SEOUrl is inserted for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertedZnodeCMSSEODetail IZCSD WHERE ZPAVL.AttributeValue = IZCSD.SEOCode)
  
		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFProducts SDP  
		WHERE IsRedirect = 1
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
  
	END  
  
	-- Insert Category Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFCategory)  
	BEGIN  
  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords 
			,CanonicalURL = ISD.CanonicalURL
			,RobotTag = ISD.RobotTag
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeCategory   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
  
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeCategory,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate   
		FROM @InsertSEODetailsOFCategory ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode  = ISD.Code AND ZCSD.PortalId = @PortalId );  
  
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFCategory ISD ON IZCSD.SEOCode = ISD.Code   
		WHERE IZCSD.CMSSEOTypeId =@CMSSEOTypeCategory    

		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFCategory SDP  
		WHERE IsRedirect = 1 
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
	END  

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId; 
  
COMMIT TRAN A;  
END TRY  
BEGIN CATCH  
ROLLBACK TRAN A;

	SET @Status = 0;  
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE(); 

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportSEODetails @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) ;

	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total AND fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSEODetails',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
    
END CATCH;  
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportStoreLocatorAddress')
	DROP PROC Znode_ImportStoreLocatorAddress
GO

CREATE PROCEDURE [dbo].[Znode_ImportStoreLocatorAddress](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @CsvColumnString nvarchar(max))
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay nvarchar(100), @SSQL nvarchar(max),@IsAllowGlobalLevelUserCreation nvarchar(10)

		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		-- Retrive Value from global setting 
		Select @IsAllowGlobalLevelUserCreation = FeatureValues from ZnodeGlobalsetting where FeatureName = 'AllowGlobalLevelUserCreation'
		-- Three type of import required three table varible for product , category and brand

		CREATE TABLE #InsertCustomerAddress 
		( 
			 RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int,PortalCode	nvarchar(600),StoreLocatorName	nvarchar(600)
			,FirstName	varchar	(300),LastName	varchar	(300),DisplayName	nvarchar(1200),Address1	varchar	(300),Address2	varchar	(300)
			,CountryName	varchar	(3000),StateName	varchar	(3000),CityName	varchar	(3000),PostalCode	varchar	(50)
			,PhoneNumber	varchar	(50),
			IsDefaultBilling	bit 
			,IsDefaultShipping	bit	,IsActive	bit	,ExternalId	nvarchar(2000),CompanyName nvarchar(2000), GUID NVARCHAR(400),
			DisplayOrder int ,Latitude decimal, Longitude decimal
		);
		
		SET @SSQL = 'INSERT INTO #InsertCustomerAddress( RowNumber,' + @CsvColumnString + ' ,GUID )
		SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		--INSERT INTO @InsertCustomerAddress( RowNumber,PortalCode,StoreLocatorName,FirstName,LastName,DisplayName,Address1,Address2,CountryName,
		--									StateName,CityName,PostalCode,PhoneNumber,
		--									IsDefaultBilling,IsActive,IsDefaultShipping,ExternalId,CompanyName,DisplayOrder,Latitude,Longitude,GUID )
		--print @SSQL
		EXEC sys.sp_sqlexec @SSQL;

		-- start Functional Validation 
		-----------------------------------------------
		--,PortalCode	,StoreName,IsStoreActive

				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '110', 'PortalCode', PortalCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertCustomerAddress AS ii
				WHERE ii.PortalCode NOT IN 
				(
					SELECT StoreCode FROM ZnodePortal 
				);
			
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '8', 'StoreLocatorName', StoreLocatorName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertCustomerAddress AS ii
				WHERE ISnull(ltrim(rtrim(ii.StoreLocatorName)), '') = ''


		DELETE FROM #InsertCustomerAddress
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);

		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomerAddress
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount 
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- End

				--DECLARE #InsertedUserAddress TABLE (AddressId  nvarchar(256), PortalId nvarchar(max), PortalCode nvarchar(max)) 
				CREATE TABLE #InsertedUserAddress (AddressId  nvarchar(256), PortalId nvarchar(max), PortalCode nvarchar(max)) 
				
				----------update ZnodeAddress				
				DECLARE @AddressColumnString VARCHAR(1000), @WhereConditionString VARCHAR(1000), @UpdateColumnString VARCHAR(1000)

				SELECT @AddressColumnString = COALESCE(@AddressColumnString + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' and ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
				FROM ZnodeImportUpdatableColumns a
				INNER JOIN INFORMATION_SCHEMA.COLUMNS b on a.ColumnName = b.COLUMN_NAME  
				INNER JOIN dbo.Split(@CsvColumnString,',')C on b.COLUMN_NAME = c.Item
				WHERE b.TABLE_NAME = 'ZnodeAddress' 
				AND EXISTS(SELECT * FROM ZnodeImportHead IH where a.ImportHeadId = IH.ImportHeadId and IH.Name = 'StoreLocator')
				
				SELECT @UpdateColumnString = COALESCE(@UpdateColumnString + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
				FROM INFORMATION_SCHEMA.COLUMNS a
				INNER JOIN dbo.Split(@CsvColumnString,',')b on a.COLUMN_NAME = b.Item
				WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString,',') c WHERE a.COLUMN_NAME = c.Item )
				AND a.TABLE_NAME = 'ZnodeAddress'

				SELECT @WhereConditionString = COALESCE(@WhereConditionString + ' AND ', '') +'ZA.'+item+' =  IC.'+item from dbo.split(@AddressColumnString,',')

				SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+', ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString,'') = '' THEN '' ELSE ','+@UpdateColumnString END+' 
						FROM ZnodeAddress ZA
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END

				EXEC (@SSQL)
								
				SET @SSQL = '		
				Insert into ZnodeAddress (FirstName,LastName,DisplayName,Address1,Address2,Address3,CountryName,
										StateName,CityName,PostalCode,PhoneNumber,
										IsDefaultBilling,IsDefaultShipping,IsActive,ExternalId,CompanyName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)		
				OUTPUT INSERTED.AddressId , inserted.Address3 INTO  #InsertedUserAddress (AddressId,PortalCode) 			 
				SELECT IC.FirstName,IC.LastName,IC.DisplayName,IC.Address1,IC.Address2, IC.PortalCode +  ''~'' + IC.StoreLocatorName,IC.CountryName,
				IC.StateName,IC.CityName,IC.PostalCode,IC.PhoneNumber,
				isnull(IC.IsDefaultBilling,0),isnull(IC.IsDefaultShipping,0),isnull(IC.IsActive,0),IC.ExternalId,IC.CompanyName, '+CONVERT(VARCHAR(10), @UserId)+' , getdate() , '+CONVERT(VARCHAR(10), @UserId)+' ,getdate()  
				FROM  #InsertCustomerAddress IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString END +')'
				--print @SSQL
				EXEC (@SSQL)
				
				DECLARE @AddressColumnString1 VARCHAR(1000), @WhereConditionString1 VARCHAR(1000), @UpdateColumnString1 VARCHAR(1000)

				SELECT @AddressColumnString1 = COALESCE(@AddressColumnString1 + ',', '')+a.ColumnName --COALESCE(@CsvColumnString + ' and ', '') +'ZA.'+ColumnName+' =  IC.'+ColumnName
				FROM ZnodeImportUpdatableColumns a
				INNER JOIN INFORMATION_SCHEMA.COLUMNS b on a.ColumnName = b.COLUMN_NAME  
				INNER JOIN dbo.Split(@CsvColumnString,',')C on b.COLUMN_NAME = c.Item
				WHERE b.TABLE_NAME = 'ZnodePortalAddress' 
				AND EXISTS(SELECT * FROM ZnodeImportHead IH where a.ImportHeadId = IH.ImportHeadId and IH.Name = 'StoreLocator')

				--print @AddressColumnString

				SELECT @UpdateColumnString1 = COALESCE(@UpdateColumnString1 + ' , ', '') +'ZA.'+a.COLUMN_NAME+' =  IC.'+a.COLUMN_NAME  
				FROM INFORMATION_SCHEMA.COLUMNS a
				INNER JOIN dbo.Split(@CsvColumnString,',')b on a.COLUMN_NAME = b.Item
				WHERE NOT EXISTS (SELECT * FROM dbo.Split(@AddressColumnString1,',') c WHERE a.COLUMN_NAME = c.Item )
				AND a.TABLE_NAME = 'ZnodePortalAddress'

				SELECT @WhereConditionString1 = COALESCE(@WhereConditionString1 + ' AND ', '') +'ZA.'+item+' =  IC.'+item from dbo.split(@AddressColumnString1,',')

				DECLARE @AccountId INT
				SELECT @AccountId = AccountId FROM ZnodeUser where UserId = @UserId

				SET @SSQL = '
						UPDATE ZA set ModifiedBy = '+CONVERT(VARCHAR(10), @UserId)+' ,ModifiedDate = getdate() '+CASE WHEN ISNULL(@UpdateColumnString1,'') = '' THEN '' ELSE ','+@UpdateColumnString1 END+' 
						FROM ZnodePortalAddress ZA
						INNER JOIN #InsertCustomerAddress IC ON '+CASE WHEN ISNULL(@WhereConditionString1,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString1 END
				--print @SSQL		
				EXEC (@SSQL)

				SET @SSQL = '
				INSERT INTO ZnodePortalAddress ( PortalId,AddressId,MediaId,StoreName,DisplayOrder,Latitude,Longitude
				,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
				Select ZP.PortalId ,IUA.AddressId,NULL,IC.StoreLocatorName, IC.DisplayOrder,IC.Latitude,IC.Longitude 
				,'+CONVERT(VARCHAR(10), @UserId)+' , getdate() '+' , '+CONVERT(VARCHAR(10), @UserId)+' , getdate()    
				from #InsertCustomerAddress IC INNER JOIN #InsertedUserAddress IUA ON 
				IC.PortalCode + ''~'' + IC.StoreLocatorName  = IUA.PortalCode
				INNER JOIN ZnodePortal ZP on IC.PortalCode = ZP.Code
				WHERE NOT EXISTS ( SELECT * FROM ZnodePortalAddress ZA WHERE '+CASE WHEN ISNULL(@WhereConditionString1,'') = '' THEN ' 1 = 0 ' ELSE @WhereConditionString1 END +')'
				--print @SSQL
				EXEC (@SSQL)
				
				UPDATE ZA SET ZA.Address3 = null 
				From ZnodeAddress ZA INNER JOIN #InsertedUserAddress IUA ON ZA.AddressId = IUA.AddressId 

		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportStoreLocatorAddress @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportStoreLocatorAddress',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidateManditoryText')
	DROP PROC Znode_ImportValidateManditoryText
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidateManditoryText]
(
	@TableName          VARCHAR(200),
	@SourceColumnName   NVARCHAR(600),
	@CreateDateString   NVARCHAR(300),
	@ValidationName     VARCHAR(100),
	@ControlName        VARCHAR(300),
	@ValidationValue    VARCHAR(300),
	@NewGUID            NVARCHAR(200),
	@LocaleId           INT = 1 ,
	@DefaultLocaleId    INT,
	@AttributeId        INT,
	@ImportProcessLogId INT,
	@ImportHeadId     INT           = 0,
	@IsIgnoreProcess   BIT = 0 
)
AS
     
 /*
	Summary:  Text 
             --------------------------
              Control   Validation Rule
             --------------------------
             1 Select	ValidationRule
             2 Text	RegularExpression
             3 Number	MaxCharacters
             4 Yes/No	UniqueValue

	Unit Testing:
	EXEC Znode_ImportValidateManditoryText
	 */
	 
	 BEGIN
        BEGIN TRY 
            SET NOCOUNT ON


             DECLARE @SQLQuery NVARCHAR(MAX), @ImportHeadName NVARCHAR(100);
             SET @ImportHeadName = DBO.Fn_GetDefaultImportHead(@ImportHeadId);
			 
			 IF @ControlName = 'Number' AND @ValidationName IN('MaxCharacters')  AND ISNULL(@ValidationValue, '') <> ''
                 BEGIN
                     SET @SQLQuery = @TableName+'  WHERE LEN('+@SourceColumnName+') > ' +   @ValidationValue + ' AND Isnull('+@SourceColumnName+','''') <> ''''';
                    

					IF @ValidationName = 'MaxCharacters'
                         EXEC Znode_ImportGenerateErrorLog
                              @ImportHeadName = @ImportHeadName,
                              @QueryCriteria = @SQLQuery,
                              @SourceColumnName = @SourceColumnName,
                              @CreateDateString = @CreateDateString,
                              @ErrorCode = '44',
                              @ValidationValue = @ValidationValue;
                  END;
             IF @ControlName = 'Yes/No' AND @ValidationName IN('UniqueValue') AND @ValidationValue = 'true'
                 BEGIN
					-- Check duplicate value exist in global temporary table 
					SET @SQLQuery = 'SELECT ''53'' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,RowNumber ,GUID,  '+@CreateDateString+' 
					FROM '+@TableName+'   WHERE RowNumber in (Select RowNumber from '+@TableName+' where '+@SourceColumnName+' in (Select '+@SourceColumnName+' from '+@TableName+' GROUP BY '+@SourceColumnName+' having COUNT(*) > 1) 
					)
					AND '+CAST(@IsIgnoreProcess AS varchar(100))+' = 0  
					';
                     
					INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
					EXEC sys.sp_sqlexec @SQLQuery;

					---- Check duplicate value exist in znode database
					--If (@ImportHeadName in  ('Product'))
					--BEGIN
					-- SET @SQLQuery = 'SELECT ''10 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
					--				  FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
					--				  (ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId AND ZPAVL.LocaleId IN ('+CONVERT(VARCHAR(100), @LocaleId)+','+CONVERT(VARCHAR(100), @DefaultLocaleId)+')) 
					--				  INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = tlb.'+@SourceColumnName+' 
					--				  WHERE ZPAV.PimAttributeId = '+CONVERT(VARCHAR(100), @AttributeId)+' AND ZPAVL.AttributeValue <> ''''';

					-- INSERT INTO ZnodeImportLog
					-- (ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
					-- EXEC sys.sp_sqlexec @SQLQuery;

					-- --Remove wrong data from table 
					-- --SET @SQLQuery = 'DELETE FROM '+@TableName+' WHERE RowNumber in (Select Isnull(RowNumber,0) FROM ZnodeImportLog 
					--	--			  WHERE ErrorDescription =10 AND ImportProcessLogId  = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+');';
					-- --EXEC sys.sp_sqlexec @SQLQuery;
					--END

					--If (@ImportHeadName in  ('Category'))
					--BEGIN
				
					--	SET @SQLQuery = 'SELECT ''10 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
					--	FROM ZnodePimCategoryAttributeValue AS ZPAV INNER JOIN ZnodePimCategoryAttributeValueLocale AS ZPAVL ON 
					--	(ZPAVL.PimCategoryAttributeValueId = ZPAV.PimCategoryAttributeValueId AND ZPAVL.LocaleId IN ('+CONVERT(VARCHAR(100), @LocaleId)+','+CONVERT(VARCHAR(100), @DefaultLocaleId)+')) 
					--	INNER JOIN '+@TableName+' tlb ON ZPAVL.CategoryValue = tlb.'+@SourceColumnName+' 
					--	WHERE ZPAV.PimAttributeId = '+CONVERT(VARCHAR(100), @AttributeId)+' AND ZPAVL.CategoryValue <> ''''';
					
					--	INSERT INTO ZnodeImportLog
					--	(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
					--	EXEC sys.sp_sqlexec @SQLQuery;
					
					-- END
					---- Check duplicate value exist in znode database
				
				     If (@ImportHeadName in  ('Category'))
					BEGIN
						SET @SQLQuery = 'SELECT ''102 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
						FROM '+@TableName+' tlb
						WHERE ltrim(rtrim(isnull(tlb.CategoryCode,''''))) like ''% %'''
						;

						INSERT INTO ZnodeImportLog
						(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
						EXEC sys.sp_sqlexec @SQLQuery;

						SET @SQLQuery = 'SELECT ''102 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
						FROM '+@TableName+' tlb
						WHERE ltrim(rtrim(isnull(tlb.CategoryCode,''''))) like ''%[^0-9A-Za-z]%'''
						;

						INSERT INTO ZnodeImportLog
						(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
						EXEC sys.sp_sqlexec @SQLQuery;

						SET @SQLQuery = 'SELECT ''102 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,tlb.RowNumber ,GUID,  '+@CreateDateString+' 
						FROM '+@TableName+' tlb
						WHERE ltrim(rtrim(isnull(tlb.CategoryCode,''''))) NOT LIKE ''%[^0-9]%'''
						;

						INSERT INTO ZnodeImportLog
						(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
						EXEC sys.sp_sqlexec @SQLQuery;

						
					END

                 END;
         END TRY
         BEGIN CATCH
               DECLARE @Status BIT ;
		     SET @Status = 0;
			 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportValidateManditoryText @TableName = '+@TableName+',@SourceColumnName='+@SourceColumnName+',@CreateDateString='+@CreateDateString+',@ValidationName='+@ValidationName+',@ControlName = '+@ControlName+',@ValidationValue='+@ValidationValue+',@NewGUID='+@NewGUID+',@LocaleId='+CAST(@LocaleId AS VARCHAR(50))+',@DefaultLocaleId='+CAST(@DefaultLocaleId AS VARCHAR(50))+',@AttributeId='+CAST(@AttributeId AS VARCHAR(50))+',@ImportHeadId='+CAST(@ImportHeadId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportValidateManditoryText',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportValidateNumber')
	DROP PROC Znode_ImportValidateNumber
GO

CREATE PROCEDURE [dbo].[Znode_ImportValidateNumber]
(   @TableName        VARCHAR(200),
    @SourceColumnName NVARCHAR(600),
    @CreateDateString NVARCHAR(300),
    @ValidationName   VARCHAR(100),
    @ControlName      VARCHAR(300),
    @ValidationValue  VARCHAR(300),
    @NewGUID          NVARCHAR(200),
    @ImportHeadId     INT      = 0,
    @ImportProcessLogId int )
AS
/*
Summary: --First Validate numeric datatype then it check its functional validation such as Number ( MaxNo/ MinNo )  and Yes/No (-ve / Decimal Value )
             Number
             --------------------------------
              Control  Validation Rule
             --------------------------------
             1 Yes/No	AllowNegative
             2 Yes/No	AllowDecimals
             3 Number	MinNumber
             4 Number	MaxNumber

Unit Testing:
EXEC Znode_ImportValidateNumber
*/
     BEGIN
         BEGIN TRY 
            SET NOCOUNT ON
             DECLARE @SQLQuery NVARCHAR(MAX), @ImportHeadName NVARCHAR(100);
             SET @ImportHeadName = DBO.Fn_GetDefaultImportHead(@ImportHeadId);
             DECLARE @RoundOffValue INT,@IsNumeric bit = 0 ; 

             -- Retrive RoundOff Value from global setting 

			 IF @SourceColumnName in ('Quantity', 'ReOrderLevel','TierStartQuantity')
                 SELECT @RoundOffValue = dbo.[Fn_GetInventoryRoundOffValue]();
             ELSE
				 SELECT @RoundOffValue = dbo.[Fn_GetPriceRoundOffValue]();
             
		  -- IF Exists (Select TOP 1 1 from ZnodeImportLog where ImportProcessLogId= @ImportProcessLogId AND ErrorDescription = '2' AND ColumnName = @SourceColumnName)
		  -- BEGIN
			 --SET @IsNumeric  =1 
		  -- END

		   IF @IsNumeric  =0  
		   BEGIN
			  SET @SQLQuery = @TableName+' WHERE  Isnumeric('+@SourceColumnName+') = 0 and Isnull('+@SourceColumnName+','''') <> ''''
			  AND NOT EXISTS (Select TOP 1 1 from ZnodeImportLog where ImportProcessLogId= ' +  Convert(Varchar(100), @ImportProcessLogId  ) + ' AND ErrorDescription = ''2'' 
			  AND ColumnName = ''' + @SourceColumnName + ''') ';
             
			  EXEC Znode_ImportGenerateErrorLog
				  @ImportHeadName = @ImportHeadName,
				  @QueryCriteria = @SQLQuery,
				  @SourceColumnName = @SourceColumnName,
				  @CreateDateString = @CreateDateString,
				  @ErrorCode = '2'
		   END

		   IF @IsNumeric  = 0   
		   BEGIN
			  IF Exists (Select TOP 1 1 from ZnodeImportLog where ImportProcessLogId= @ImportProcessLogId AND ErrorDescription = '2' AND ColumnName = @SourceColumnName )
			  BEGIN
				SET @IsNumeric  =1 
			  END
		   END
             
		   IF @ControlName = 'Number'  AND @ValidationName IN('MaxNumber', 'MinNumber') AND ISNULL(@ValidationValue, '') <> '' AND @IsNumeric  = 0  
                 BEGIN
                     SET @SQLQuery = @TableName+'  WHERE Convert(money, '+@SourceColumnName+')'+CASE
                                                                                                    WHEN @ValidationName = 'MaxNumber'
                                                                                                    THEN '>'+@ValidationValue
                                                                                                    ELSE '<'+@ValidationValue
                                                                                                END+' AND Isnull('+@SourceColumnName+','''') <> ''''';
                     IF @ValidationName = 'MaxNumber'
                         EXEC Znode_ImportGenerateErrorLog
                              @ImportHeadName = @ImportHeadName,
                              @QueryCriteria = @SQLQuery,
                              @SourceColumnName = @SourceColumnName,
                              @CreateDateString = @CreateDateString,
                              @ErrorCode = '16',
                              @ValidationValue = @ValidationValue;
                     ELSE
					EXEC Znode_ImportGenerateErrorLog
						@ImportHeadName = @ImportHeadName,
						@QueryCriteria = @SQLQuery,
						@SourceColumnName = @SourceColumnName,
						@CreateDateString = @CreateDateString,
						@ErrorCode = '16',
						@ValidationValue = @ValidationValue;
		 
                     --Remove wrong data from table 
                     --SET @SQLQuery = 'DELETE FROM '+@TableName+'    WHERE Convert(money,'+@SourceColumnName+')'+CASE
                     --                                                                                               WHEN @ValidationName = 'MaxNumber'
                     --                                                                                               THEN '>'+@ValidationValue
                     --                                                                                               ELSE '<'+@ValidationValue
                     --                                                                                           END+' AND Isnull('+@SourceColumnName+','''') <> ''''';
                     --EXEC sys.sp_sqlexec
                     --     @SQLQuery;
                     -- END
                 END;
             -- 1
             IF @ControlName = 'Yes/No' AND @ValidationName IN('AllowNegative') AND @ValidationValue = 'false' AND @IsNumeric  = 0 
                 BEGIN
                     BEGIN
                         SET @SQLQuery = @TableName+' WHERE  Convert( Money,'+@SourceColumnName+' ) < 0  AND Isnull('+@SourceColumnName+', '''') <> ''''';
                         EXEC Znode_ImportGenerateErrorLog
                              @ImportHeadName = @ImportHeadName,
                              @QueryCriteria = @SQLQuery,
                              @SourceColumnName = @SourceColumnName,
                              @CreateDateString = @CreateDateString,
                              @ErrorCode = '4',
                              @ValidationValue = '' ;
			
                         --Remove wrong data from table 
                         --SET @SQLQuery = 'DELETE FROM '+@TableName+'    WHERE Convert( Money,'+@SourceColumnName+' ) < 0  AND Isnull('+@SourceColumnName+', '''') <> ''''';
                         --EXEC sys.sp_sqlexec  @SQLQuery;
                     END;
                 END;
             IF @ControlName = 'Number' AND @SourceColumnName <> 'RowNumber' AND @ImportHeadName in ( 'Inventory' ,'Pricing') AND @IsNumeric  = 0 
                 BEGIN
                     ---Validate roundoff value after decimal place should be between value which is define in global settings
                     SET @SQLQuery = @TableName+'  WHERE ( CASE WHEN '+@SourceColumnName+' LIKE ''%.%'' THEN LEN(SUBSTRING('+@SourceColumnName+' , CHARINDEX(''.'' , '+@SourceColumnName+')+1 , 4000)) ELSE 0 END > ( '+CONVERT(VARCHAR(100), @RoundOffValue)+') )'+'  AND Isnull('+@SourceColumnName+', '''') <> ''''';
                     EXEC Znode_ImportGenerateErrorLog
                          @ImportHeadName = @ImportHeadName,
                          @QueryCriteria = @SQLQuery,
                          @SourceColumnName = @SourceColumnName,
                          @CreateDateString = @CreateDateString,
                          @ErrorCode = '111',
                          @ValidationValue = '0.999999';
			
                     --Remove wrong data from table 
                     --SET @SQLQuery = 'DELETE FROM '+@TableName+'  WHERE ( CASE WHEN '+@SourceColumnName+' LIKE ''%.%'' THEN LEN(SUBSTRING('+@SourceColumnName+' , CHARINDEX(''.'' , '+@SourceColumnName+')+1 , 4000)) ELSE 0 END > ( '+CONVERT(VARCHAR(100), @RoundOffValue)+') )'+'  AND Isnull('+@SourceColumnName+', '''') <> ''''';
                     --EXEC sys.sp_sqlexec  @SQLQuery;
                 END;
         END TRY
         BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			 @ErrorCall NVARCHAR(MAX)= 'EXECZnode_ImportValidateNumber @TableName = '+@TableName+',@SourceColumnName='+@SourceColumnName+',@CreateDateString='+@CreateDateString+',@ValidationName='+@ValidationName+',@ControlName = '+@ControlName+',@ValidationValue='+@ValidationValue+',@NewGUID='+@NewGUID+',@ImportHeadId='+CAST(@ImportHeadId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_ImportValidateNumber',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportZipCode')
	DROP PROC Znode_ImportZipCode
GO

CREATE PROCEDURE [dbo].[Znode_ImportZipCode](
	  @TableName nvarchar(100), @Status bit OUT, @UserId int, @ImportProcessLogId int, @NewGUId nvarchar(200), @CountryCode nvarchar(100))
AS 
	
/*
	----Summary:  Import Zip Code data List 
    */

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		DECLARE @sSql nvarchar(max);

		DECLARE @ZipCode TABLE
		( 
		   ZIPCode nvarchar(300)
		);
		INSERT INTO @ZipCode(ZIPCode)
			   SELECT ZIP
			   FROM ZnodeCity 


		DECLARE @Tlb_ZnodeCity TABLE
		( 
			[RowNumber] [int] NOT NULL, [CityName] [nvarchar](255) NULL, [CityType] [nvarchar](50) NULL, [ZIP] [nvarchar](50) NULL, [ZIPType] [nvarchar](50) NULL, [CountyCode] [varchar](255) NULL,  [StateCode] [nvarchar](255) NULL, [Latitude] [decimal](9, 6) NULL, [Longitude] [decimal](9, 6) NULL, [CountyFIPS] [varchar](50) NULL, [StateFIPS] [varchar](50) NULL, [MSACode] [varchar](50) NULL, [TimeZone] [varchar](50) NULL, [UTC] [decimal](3, 1) NULL, [DST] [char](1) NULL PRIMARY KEY([RowNumber])
		);
		SET @SSQL = 'Select CityName,CityType,ZIP,ZIPType,CountyCode,StateCode,Latitude,Longitude,CountyFIPS,StateFIPS,MSACode,TimeZone,UTC ,RowNumber FROM '+@TableName;
		INSERT INTO @Tlb_ZnodeCity( CityName, CityType, ZIP, ZIPType, CountyCode, StateCode, Latitude, Longitude, CountyFIPS, StateFIPS, MSACode, TimeZone, UTC, RowNumber )
		EXEC sys.sp_sqlexec @SSQL;
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '112', 'StateCode', StateCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM @Tlb_ZnodeCity
			   WHERE StateCode NOT IN
			   (
				   SELECT StateCode
				   FROM ZnodeState
				   WHERE CountryCode = @CountryCode
			   );

	   INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '53', 'ZIPCode', ZIP, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			  FROM @Tlb_ZnodeCity AS ii
			   WHERE ii.ZIP IN 
			   (
				   SELECT ZIP  FROM @Tlb_ZnodeCity  Group BY ZIP  HAVING COUNT(*) > 1 
			   );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '10', 'ZIPCode', ZIP, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			  FROM @Tlb_ZnodeCity AS ii
			   WHERE ii.ZIP in 
			   (
				   SELECT ZIPCode FROM @ZipCode  where ZIPCode IS NOT NULL 
			   );

		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ ZIPCode - ' + ISNULL(ZIP,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN @Tlb_ZnodeCity IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		DELETE FROM @Tlb_ZnodeCity
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber IS NOT NULL 
		);

		-- Update Record count in log 
        DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @Tlb_ZnodeCity
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;


		INSERT INTO ZnodeCity( CityName, CityType, ZIP, ZIPType, CountyCode, CountryCode, StateCode, Latitude, Longitude, CountyFIPS, StateFIPS, MSACode, TimeZone, UTC, DST, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
			   SELECT CityName, CityType, ZIP, ZIPType, [CountyCode], @CountryCode, StateCode, Latitude, Longitude, CountyFIPS, StateFIPS, MSACode, TimeZone, UTC, DST, 2, @GetDate, 2, @GetDate
			   FROM @Tlb_ZnodeCity AS tzc
			   WHERE NOT EXISTS
			   (
				   SELECT TOP 1 1
				   FROM ZnodeCity
				   WHERE  CountryCode = @CountryCode AND 
						  StateCode = tzc.StateCode AND 
						  CityName = TZC.CityName AND 
						  ZIP = TZC.ZIP
			   ) --AND 
					 --tzc.RowNumber =
			   --(
				  -- SELECT MAX(ii1.RowNumber)
				  -- FROM @Tlb_ZnodeCity AS ii1
				  -- WHERE ii1.StateCode = tzc.StateCode
			   --);
		UPDATE ZC
		  SET ZC.CityType = TZC.CityType, ZC.CountyCode = TZC.CountyCode, ZC.Latitude = TZC.Latitude, ZC.Longitude = TZC.Longitude, ZC.CountyFIPS = TZC.CountyFIPS, ZC.StateFIPS = TZC.StateFIPS, ZC.MSACode = TZC.MSACode, ZC.TimeZone = TZC.TimeZone, ZC.UTC = TZC.UTC, ZC.DST = TZC.DST, ZC.ModifiedBy = @UserId, ZC.ModifiedDate = @GetDate
		FROM ZnodeCity ZC
			 INNER JOIN
			 @Tlb_ZnodeCity TZC
			 ON ZC.CountryCode = @CountryCode AND 
				ZC.StateCode = TZC.StateCode AND 
				ZC.CityName = TZC.CityName AND 
				ZC.ZIP = TZC.ZIP;
		SET @Status = 1;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		-- COMMIT TRAN ImportProducts;
		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportZipCode @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@CountryCode='+CAST(@CountryCode AS VARCHAR(max));

		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportZipCode',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
		
	END CATCH;
END;

GO

update ZnodeMessage set MessageName = 'Input must be a positive numeric value' where MessageCode = 4

update ZnodeMessage set MessageName = 'Input must be a positive numeric value greater than 0' where MessageCode = 17

update ZnodeMessage set MessageName = 'Input must be in alphanumeric format and must start with an alphabet.' where MessageCode = 52

update ZnodeMessage set MessageName = 'Input value must either be True or False.' where MessageCode = 68

update ZnodeMessage set MessageName = 'Default input cannot be marked as non-default.' where MessageCode = 91

update ZnodeMessage set MessageName = 'Input value must not exceed the maximum character limit of 100.' where MessageCode = 78

update ZnodeMessage set MessageName = 'Input must include a value in alphanumeric format.' where MessageCode = 79

update ZnodeMessage set MessageName = 'Input must be associated with any existing Catalog.' where MessageCode = 80

update ZnodeMessage set MessageName = 'Input must not exceed the maximum character limit of 200.' where MessageCode = 81

update ZnodeMessage set MessageName = 'Input must not exceed the maximum character limit of 300.' where MessageCode = 82

update ZnodeMessage set MessageName = 'Input is required.' where MessageCode = 84

update ZnodeMessage set MessageName = 'Input value must be 1 for new Account.' where MessageCode = 85

update ZnodeMessage set MessageName = 'Parent Account must be associated with the specified Store.' where MessageCode = 86

update ZnodeMessage set MessageName = 'Input must be available as a Code saved against any existing Parent Account.' where MessageCode = 87

update ZnodeMessage set MessageName = 'Input cannot be updated because of its unavailability in database.' where MessageCode = 19

update ZnodeMessage set MessageName = 'Duplicate records must be excluded from the import/update file.' where MessageCode = 53

update ZnodeMessage set MessageName = 'Input must include be a positive integer value of maximum 3 digits and must be greater than 0.' where MessageCode = 64

update ZnodeMessage set MessageName = 'Input must include SKU of a product that is not a simple product.' where MessageCode = 49

update ZnodeMessage set MessageName = 'Input must include SKU of a simple product as a value.' where MessageCode = 51

update ZnodeMessage set MessageName = 'Input must include a value from the defined values.' where MessageCode = 9

update ZnodeMessage set MessageName = 'Input must include a value in alphanumeric format.' where MessageCode = 50

update ZnodeMessage set MessageName = 'Input must be unique.' where MessageCode = 30

update ZnodeMessage set MessageName = 'Input must be available as a value in the specified store.' where MessageCode = 62

update ZnodeMessage set MessageName = 'Input is required.' where MessageCode = 8

update ZnodeMessage set MessageName = 'Data column must be mapped with the template.' where MessageCode = 42

update ZnodeMessage set MessageName = 'Input must include numeric value greater than 0' where MessageCode = 26

update ZnodeMessage set MessageName = 'Input date added for SKUActivationDate must come prior to the input date added for SKUExpirationDate.' where MessageCode = 39

update ZnodeMessage set MessageName = 'Input must be unique.' where MessageCode = 10

update ZnodeMessage set MessageName = 'Mandatory column must be included in the import/update file.' where MessageCode = 14

update ZnodeMessage set MessageName = 'Input is invalid.' where MessageCode = 45

update ZnodeMessage set MessageName = 'Input must be available as a Username saved against any existing User who belongs to the same Store as that of the Voucher.' where MessageCode = 67

update ZnodeMessage set MessageName = 'Input must include a value same as Voucher Amount.' where MessageCode = 69

update ZnodeMessage set MessageName = 'Input must be associated with any existing Store.' where MessageCode = 70

update ZnodeMessage set MessageName = 'Input value must be of 10 characters and should include a combination of upper case, alphabets and numeric values.' where MessageCode = 71

update ZnodeMessage set MessageName = 'Input must be available as a Code saved against any existing Parent Account.' where MessageCode = 89

update ZnodeMessage set MessageName = 'RowNumber, ProductId and CatalogId are reserved columns and must be excluded from the import file.' where MessageCode = 43

update ZnodeMessage set MessageName = 'Input must be a numeric value.' where MessageCode = 2

update ZnodeMessage set MessageName = 'Input must be an integer value between 1 and 99999' where MessageCode = 16

update ZnodeMessage set MessageName = 'Input must include a valid date.' where MessageCode = 5

update ZnodeMessage set MessageName = 'Input must include a value in Date format and must be a value post Start Date.' where MessageCode = 65

update ZnodeMessage set MessageName = 'The attribute is not associated with the selected Attribute Family' where MessageCode = 1

update ZnodeMessage set MessageName = 'Input must include the same value associated with the User since the associated account cannot be changed.' where MessageCode = 88

update ZnodeMessage set MessageName = 'Input should be available as Account Code with any existing Account.' where MessageCode = 73

update ZnodeMessage set MessageName = 'Input must include either User or Administrator or Manager as a value.' where MessageCode = 74

update ZnodeMessage set MessageName = 'Include Account Code first to add a Role Name.' where MessageCode = 75

update ZnodeMessage set MessageName = 'Input should be available as Department Name with any existing Account.' where MessageCode = 76

update ZnodeMessage set MessageName = 'Account and Customer should belong to the same Store therefore input should be available as Account Code with any existing Account of the respective Store.' where MessageCode = 77
go
insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 98,'Text','Input must be available as a SKU saved against any existing product.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 98)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 99,'Text','Input must be available as a Group Name saved against any existing Add-on Group.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 99)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 101,'Text','Input must match one of the values of the Configurable Attribute which is used to create a Configurable product.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 101)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 102,'Text','Input value must be in alphanumeric format without spaces.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 102)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 103,'Text','Input must be available as any predefined value.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 103)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 104,'Text','Input value must be in email format i.e. _@__.__',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 104)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 105,'Text','Input must be available as a Code saved against any existing Catalog.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 105)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 106,'Text','Input must be available as a Username saved against any existing User.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 106)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 107,'Text','Input must be available as a Code saved against any existing Warehouse.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 107)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 108,'Text','Input must include a positive integer value greater than 0.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 108)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 109,'Text','Input must include a positive numeric value greater than 0.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 109)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 110,'Text','Input must be available as a Code saved against any existing Store.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 110)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 111,'Text','Input must include a positive numeric value between 0 and 6 which can further be used to identify the rounding digit.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 111)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 112,'Text','Input must be available as a State Code value in the database.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 112)


GO

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>SearchProfileAttributeMappingId</name><headertext>Checkbox</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>AttributeCode</name><headertext>Attribute Code</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>AttributeName</name><headertext>Attribute Name</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>IsFacets</name><headertext>IsFacets</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>IsUseInSearch</name><headertext>Is Use In Search</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>BoostValue</name><headertext>Boost Value</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>SearchProfileId</name><headertext>Search Profile Id</headertext><width>30</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Delete</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Search/Search/UnAssociateAttributesFromProfile</manageactionurl><manageparamfield>searchProfileAttributeMappingId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName ='ZnodeSearchAttributes'

GO

insert into ZnodePaymentType (Code,Name,Description,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsCallToPaymentAPI,BehaviorType)
select 'AUTOMATEDCLEARINGHOUSE','ACH','Automated Clearing House',1,2,getdate(),2,getdate(),1,'ACH'
where not exists(select * from ZnodePaymentType where Code = 'AUTOMATEDCLEARINGHOUSE')

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'SmsContent' AND Object_ID = Object_ID(N'dbo.ZnodeEmailTemplateLocale'))
BEGIN
	ALTER TABLE ZnodeEmailTemplateLocale ADD SmsContent NVARCHAR  (MAX) NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'IsSmsNotificationActive' AND Object_ID = Object_ID(N'dbo.ZnodeEmailTemplateMapper'))
BEGIN
	ALTER TABLE ZnodeEmailTemplateMapper ADD IsSmsNotificationActive BIT DEFAULT ((0)) NOT NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'IsSmsNotificationActive' AND Object_ID = Object_ID(N'dbo.ZnodeEmailTemplateMapper'))
BEGIN
	ALTER TABLE ZnodeEmailTemplateMapper ADD IsSmsNotificationActive BIT DEFAULT ((0)) NOT NULL;
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeSmsProvider')
BEGIN
	CREATE TABLE [dbo].[ZnodeSmsProvider] (
    [SmsProviderId] INT             IDENTITY (1, 1) NOT NULL,
    [ProviderCode]              NVARCHAR (300)   NULL,
    [ProviderName]              NVARCHAR (300)   NULL,
	[ClassName]              NVARCHAR (300)   NULL,
    [CreatedBy]            INT             NOT NULL,
    [CreatedDate]          DATETIME        NOT NULL,
    [ModifiedBy]           INT             NOT NULL,
    [ModifiedDate]         DATETIME        NOT NULL,
	[Description]          NVARCHAR (MAX)  NULL,
    CONSTRAINT [PK_ZnodeSmsProvider] PRIMARY KEY CLUSTERED ([SmsProviderId] ASC) WITH (FILLFACTOR = 90));
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodePortalSmsSetting')
BEGIN
	CREATE TABLE [dbo].[ZnodePortalSmsSetting] (
    [PortalSmsSettingId]        INT             IDENTITY (1, 1) NOT NULL,
    [PortalId]         INT             NULL,
    [SmsProviderId]        INT             NULL,
    [SmsPortalAccountId]        NVARCHAR (300)   NULL,
    [AuthToken]              NVARCHAR (300)   NULL,
    [FromMobileNumber]            NVARCHAR (50)   NULL,
    CONSTRAINT [PK_ZnodePortalSmsSetting] PRIMARY KEY CLUSTERED ([PortalSmsSettingId] ASC) WITH (FILLFACTOR = 90),
    CONSTRAINT [FK_ZnodePortalSmsSetting_ZnodeSmsProvider] FOREIGN KEY ([SmsProviderId]) REFERENCES [dbo].[ZnodeSmsProvider] ([SmsProviderId])
	);
END


GO

update ZnodeMenu 
set MenuName = 'Email & SMS Templates' 
where MenuName = 'Email Templates'

GO

update ZnodeApplicationSetting 
set setting = '<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsOrderId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OrderNumber</name><headertext>OrderNumber</headertext><width>15</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/OrderReceipt</islinkactionurl><islinkparamfield>OmsOrderId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>OmsOrderId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OrderState</name><headertext>OrderStatus</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>PaymentStatus</name><headertext>PaymentStatus</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PaymentDisplayName</name><headertext>PaymentType</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>z-paymenttype</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>OrderDate</name><headertext>CreatedDate</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>TotalWithCurrencyCode</name><headertext>OrderAmount</headertext><width>30</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View|Manage|Return|Track-Order</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View|Manage|Return|AchPayment</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/OrderReceipt|/User/ReorderProducts|/RMAReturn/CheckOrderEligibilityForReturn|/Checkout/PaymentOption</manageactionurl><manageparamfield>OmsOrderId,portalId|OmsOrderId|OrderNumber|OmsOrderId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>PODocumentPath</name><headertext>PODocumentPath</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class>z-podocument</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodeWebStoreOrder'

GO

update ZnodeApplicationSetting 
set setting = '<?xml version="1.0"encoding="utf-16"?><columns><column><id>1</id><name>OmsOrderId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OrderNumber</name><headertext>OrderNumber</headertext><width>15</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/OrderReceipt</islinkactionurl><islinkparamfield>OmsOrderId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>OmsOrderId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OrderState</name><headertext>OrderStatus</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>PaymentStatus</name><headertext>PaymentStatus</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PaymentDisplayName</name><headertext>PaymentType</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>z-paymenttype</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>OrderDate</name><headertext>CreatedDate</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>TotalWithCurrencyCode</name><headertext>OrderAmount</headertext><width>30</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View|Manage|Return|dollar</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View|Manage|Return|Pay Invoice</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/OrderReceipt|/User/ReorderProducts|/RMAReturn/CheckOrderEligibilityForReturn|/Checkout/PaymentOption</manageactionurl><manageparamfield>OmsOrderId,portalId|OmsOrderId|OrderNumber|OmsOrderId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>PODocumentPath</name><headertext>PODocumentPath</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class>z-podocument</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>' 
where ItemName='ZnodeWebStoreOrder'

GO

IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'RemainingOrderAmount' AND TABLE_NAME = 'ZnodeOmsOrderDetails')
BEGIN
        ALTER TABLE ZnodeOmsOrderDetails ADD RemainingOrderAmount NUMERIC(28, 6) NULL DEFAULT NULL
END

GO

IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'IsUsedForOfflinePayment' AND TABLE_NAME = 'ZnodePortalPaymentSetting')
BEGIN
        ALTER TABLE ZnodePortalPaymentSetting ADD IsUsedForOfflinePayment BIT NOT NULL DEFAULT ((0))
END
GO
IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'IsUsedForWebStorePayment' AND TABLE_NAME = 'ZnodePortalPaymentSetting')
BEGIN
        ALTER TABLE ZnodePortalPaymentSetting ADD IsUsedForWebStorePayment BIT NOT NULL DEFAULT ((0))
END

GO

IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'IsUsedForOfflinePayment' AND TABLE_NAME = 'ZnodePaymentType')
BEGIN
        ALTER TABLE ZnodePaymentType ADD IsUsedForOfflinePayment BIT NOT NULL DEFAULT ((0))
END

UPDATE ZnodePaymentType 
SET IsActive=1 
WHERE Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')

GO

IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'PortalId' AND TABLE_NAME = 'ZnodePortalSmsSetting')
BEGIN
        ALTER TABLE ZnodePortalSmsSetting ALTER COLUMN PortalId INT NOT NULL
END

GO

IF EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'SmsProviderId' AND TABLE_NAME = 'ZnodePortalSmsSetting')
BEGIN
        ALTER TABLE ZnodePortalSmsSetting ALTER COLUMN SmsProviderId INT NOT NULL
END

GO

IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE COLUMN_NAME = 'IsSMSSettingEnabled' AND TABLE_NAME = 'ZnodePortalSmsSetting')
BEGIN
        ALTER TABLE ZnodePortalSmsSetting ADD IsSMSSettingEnabled BIT NOT NULL DEFAULT ((0))
END





GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodePaymentGateway')
BEGIN
	CREATE TABLE [dbo].[ZnodePaymentGateway] (
    [PaymentGatewayId] INT           IDENTITY (1, 1) NOT NULL,
    [GatewayName]      VARCHAR (300) NOT NULL,
    [WebsiteURL]       VARCHAR (300) NULL,
    [CreatedBy]        INT           NOT NULL,
    [CreatedDate]      DATETIME      NOT NULL,
    [ModifiedBy]       INT           NOT NULL,
    [ModifiedDate]     DATETIME      NOT NULL,
    [GatewayCode]      VARCHAR (100) NULL,
    CONSTRAINT [PK_ZnodePaymentGateway] PRIMARY KEY CLUSTERED ([PaymentGatewayId] ASC)
	);
END

GO

INSERT INTO ZnodePaymentGateway (GatewayName,	WebsiteURL	,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, GatewayCode )
SELECT 'Card Connect','https://cardpointe.com/',2,GETDATE(),2,GETDATE(), 'cardconnect'
WHERE NOT EXISTS(SELECT * FROM ZnodePaymentGateway WHERE GatewayCode = 'cardconnect')

DELETE FROM ZnodeProfilePaymentSetting
WHERE PaymentSettingId IN (SELECT PaymentSettingId FROM ZnodePaymentSetting
		WHERE PaymentGatewayId IN (SELECT PaymentGatewayId FROM ZnodePaymentGateway WHERE GatewayName = 'Paypal'))
UPDATE ZnodeOmsOrderDetails SET PaymentSettingId = NULL
WHERE PaymentSettingId IN (SELECT PaymentSettingId FROM ZnodePaymentSetting
		WHERE PaymentGatewayId IN (SELECT PaymentGatewayId FROM ZnodePaymentGateway WHERE GatewayName = 'Paypal'))
UPDATE ZnodeOmsQuote SET PaymentSettingId = NULL
WHERE PaymentSettingId IN (SELECT PaymentSettingId FROM ZnodePaymentSetting
		WHERE PaymentGatewayId IN (SELECT PaymentGatewayId FROM ZnodePaymentGateway WHERE GatewayName = 'Paypal'))
DELETE FROM ZnodeRmaReturnPaymentDetails
WHERE PaymentSettingId IN (SELECT PaymentSettingId FROM ZnodePaymentSetting
		WHERE PaymentGatewayId IN (SELECT PaymentGatewayId FROM ZnodePaymentGateway WHERE GatewayName = 'Paypal'))
DELETE FROM ZnodePortalPaymentApprovers
WHERE PaymentSettingId IN (SELECT PaymentSettingId FROM ZnodePaymentSetting
		WHERE PaymentGatewayId IN (SELECT PaymentGatewayId FROM ZnodePaymentGateway WHERE GatewayName = 'Paypal'))
DELETE FROM ZnodePortalPaymentSetting
WHERE PaymentSettingId IN (SELECT PaymentSettingId FROM ZnodePaymentSetting
		WHERE PaymentGatewayId IN (SELECT PaymentGatewayId FROM ZnodePaymentGateway WHERE GatewayName = 'Paypal'))
DELETE FROM ZnodePaymentSetting
WHERE PaymentGatewayId IN (SELECT PaymentGatewayId FROM ZnodePaymentGateway WHERE GatewayName = 'Paypal')
DELETE FROM ZnodePaymentGateway WHERE GatewayName = 'Paypal'

GO





update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsOrderId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OrderNumber</name><headertext>Order Number</headertext><width>15</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/OrderReceipt</islinkactionurl><islinkparamfield>OmsOrderId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>OmsOrderId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OrderState</name><headertext>Order Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>PaymentStatus</name><headertext>Payment Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PaymentDisplayName</name><headertext>Payment Type</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>z-paymenttype</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>OrderDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>TotalWithCurrencyCode</name><headertext>Order Amount</headertext><width>30</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View|Manage|Return|dollar</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View|Manage|Return|Pay Invoice</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/OrderReceipt|/User/ReorderProducts|/RMAReturn/CheckOrderEligibilityForReturn|/Checkout/PaymentOption</manageactionurl><manageparamfield>OmsOrderId,portalId|OmsOrderId|OrderNumber|OmsOrderId,PaymentType</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>PODocumentPath</name><headertext>PODocumentPath</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class>z-podocument</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>RemainingOrderAmount</name><headertext>Remaining Amount</headertext><width>30</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeWebStoreOrder'

GO

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OmsOrderId</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>OrderNumber</name><headertext>Order Number</headertext><width>15</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/OrderReceipt</islinkactionurl><islinkparamfield>OmsOrderId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield>OmsOrderId</controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OrderState</name><headertext>Order Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>PaymentStatus</name><headertext>Payment Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PaymentDisplayName</name><headertext>Payment Type</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>z-paymenttype</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>OrderDate</name><headertext>Created Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>TotalWithCurrencyCode</name><headertext>Order Amount</headertext><width>30</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View|Manage|Return|dollar</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View|Manage|Return|Pay Invoice</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/OrderReceipt|/User/ReorderProducts|/RMAReturn/CheckOrderEligibilityForReturn|/Checkout/PaymentOption</manageactionurl><manageparamfield>OmsOrderId,portalId|OmsOrderId|OrderNumber|OmsOrderId,PaymentType,RemainingOrderAmount</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>9</id><name>PODocumentPath</name><headertext>PODocumentPath</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class>z-podocument</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>10</id><name>RemainingOrderAmount</name><headertext>Remaining Amount</headertext><width>30</width><datatype>Decimal</datatype><columntype>Decimal</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeWebStoreOrder'

GO

INSERT INTO ZnodeSMSProvider (ProviderCode,ProviderName,ClassName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Description)
SELECT 'TWILIO_SMS','Twilio','TwilioProvider',2,GETDATE(),2,GETDATE(),'TWILIO_SMS'
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeSMSProvider WHERE ProviderCode='TWILIO_SMS')

UPDATE ZnodeEmailTemplateMapper
SET IsSmsNotificationActive=1
WHERE IsSmsNotificationActive<>1
	AND EmailTemplateId IN (SELECT EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName IN ('AccountVerificationSuccessful','ResetPasswordLink','NewCustomerAccountFromWebstore','NewCustomerAccountFromAdmin','OrderPlacedNotification','ShippingReceipt'))

UPDATE ZnodeEmailTemplateLocale
SET SmsContent='Dear #FirstName#, Your account has been successfully verified. You can now login and place orders.'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='AccountVerificationSuccessful')
	AND LocaleId=1

UPDATE ZnodeEmailTemplateLocale
SET SmsContent='Dear #FirstName#, Your request for password reset is accepted. Please create your new password using the link shared in your registered email address'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='ResetPasswordLink')
	AND LocaleId=1

UPDATE ZnodeEmailTemplateLocale
SET SmsContent='Dear #FirstName#, a new account has been created for you. Please use the link: #webstoreloginurl# to login'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='NewCustomerAccountFromWebstore')
	AND LocaleId=1

UPDATE ZnodeEmailTemplateLocale
SET SmsContent='Dear #FirstName#, a new account has been created for you. Please use the link: #webstoreloginurl# to login'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='NewCustomerAccountFromAdmin')
	AND LocaleId=1

UPDATE ZnodeEmailTemplateLocale
SET SmsContent='Dear #FirstName#, your Order Number:#OrderId# is placed successfully. You can view the Order Receipt on your Dashboard as well as email'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='OrderPlacedNotification')
	AND LocaleId=1

UPDATE ZnodeEmailTemplateLocale
SET SmsContent='Dear #BillingFirstName#, the Item:#Name# is dispatched via #ShippingName#. You can view the Shipping Receipt on your email'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='ShippingReceipt')
	AND LocaleId=1

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertSaveCartLineItemsForReOrder')
	DROP PROC Znode_InsertSaveCartLineItemsForReOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertSaveCartLineItemsForReOrder] 
(
	@OmsOrderId INT, 
	@OmsSavedCartId INT ,
	@UserId INT ,
	@OmsOrderLineItemsId INT = 0,
	@Status BIT = 0 OUT
)
AS 
BEGIN 
BEGIN TRY 
  SET NOCOUNT ON 
  DECLARE @TBL_ZnodeOmsSavedCartLineItem TABLE (OmsSavedCartLineItemId INT , RowId INT  )
  DECLARE @GetDate DATETIME = dbo.FN_getDate() 
  DECLARE @AddOnOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Addons')

   DECLARE @BundleOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Bundles')

   DECLARE @GroupOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Group')

   DECLARE @OmsOrderStateId_RETURNED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'RETURNED')
   DECLARE @OmsOrderStateId_CANCELED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'CANCELED')

   CREATE TABLE #ZnodeOmsOrderLineItems_temp (OmsOrderLineItemsId INT ,ParentOmsOrderLineItemsId INT,OmsOrderDetailsId INT , SKU  NVARCHAr(2000),
   OrderLineItemRelationshipTypeID INT ,AutoAddonSKU NVARCHAR(400),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),Custom4 NVARCHAR(MAX)
   ,Custom5 NVARCHAR(MAX), GroupId nvarchar(MAX),ProductName NVARCHAr(2000), Description nvarchar(MAX),Quantity NUMERIC(28,6), ROWID INT, ParentRowID INT)

  IF EXISTS (SELECT TOP 1 OmsOrderDetailsId  FROM ZnodeOmsOrderDetails WHERE  OmsOrderId =  @OmsOrderId AND IsActive =1 )
  BEGIN 

	  ;WITH CTE_OrderData AS
	  (
		  SELECT MIN(ZOOLI.OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ZOOLI.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			  ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4,
			  ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description,SUM(ZOOLI.Quantity) AS Quantity
		  FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		  INNER JOIN ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) ON ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId
		  WHERE  ZOOD.OmsOrderId =  @OmsOrderId AND ZOOD.IsActive =1 
		  AND CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 0 ELSE  ZOOLI.OrderLineItemStateId END  <> CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 1 ELSE  @OmsOrderStateId_RETURNED END 
		  GROUP BY ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4, ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description
	  )
	  INSERT INTO #ZnodeOmsOrderLineItems_temp
	  SELECT *
		,Row_number()Over(Order By OmsOrderLineItemsId )  RowId, NULL ParentRowId
	  FROM CTE_OrderData
	  ORDER BY OmsOrderLineItemsId 
  END

  ELSE 
  BEGIN
		;WITH CTE_OrderData AS
		  (
			  SELECT MIN(OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
				  ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				  ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
				  ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
			  FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
			  WHERE ( ZOO.OmsOrderLineItemsId = @OmsOrderLineItemsId OR ZOO.ParentOmsOrderLineItemsId = @OmsOrderLineItemsId ) 
			  AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE ZOO.OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
			  GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4, ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description
		 )
		 INSERT INTO #ZnodeOmsOrderLineItems_temp
		 SELECT *,Row_number()Over(Order By OmsOrderLineItemsId )   RowId, NULL ParentRowId
		 FROM CTE_OrderData

		INSERT INTO #ZnodeOmsOrderLineItems_temp 
		SELECT MIN(ZOO.OmsOrderLineItemsId) AS OmsOrderLineItemsId,MIN(ZOO.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
		ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
		ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
		ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
		,0 RowId, NULL ParentRowId
		FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
		WHERE ZOO.OmsOrderLineItemsId = (SELECT TOP 1 ParentOmsOrderLineItemsId FROM #ZnodeOmsOrderLineItems_temp TY WHERE TY.ParentOmsOrderLineItemsId IS NOT NULL 
		AND TY.OrderLineItemRelationshipTypeID <> @AddOnOrderLineItemRelationshipTypeId )
		AND ZOO.ParentOmsOrderLineItemsId  IS NULL
		AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
		AND NOT EXISTS(SELECT * FROM #ZnodeOmsOrderLineItems_temp tem WHERE tem.OmsOrderLineItemsId = ZOO.OmsOrderLineItemsId )
		GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
			ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description;

  END

     DECLARE @TBL_OmsSavedCartOld TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 DECLARE @TBL_OmsSavedCartNew TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 
	 SELECT SKU , OmsOrderLineItemsId, ParentOmsOrderLineItemsId, OrderLineItemRelationshipTypeID,Quantity 
	 INTO #ZnodeOmsSavedCartLineItemOld
	 FROM #ZnodeOmsOrderLineItems_temp a 

	 SELECT OmsOrderLineItemsId, PersonalizeCode, PersonalizeValue  
	 INTO #ZnodeOmsPersonalizeCartItemOld
	 FROM ZnodeOmsPersonalizeItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp t WHERE t.OmsOrderLineItemsId = a.OmsOrderLineItemsId)

	 SELECT SKU , OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeID, Quantity
	 INTO #ZnodeOmsSavedCartLineItemNew
	 FROM ZnodeOmsSavedCartLineItem a WITH (NOLOCK)
	 WHERE OmsSavedCartId = @OmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue   
	 INTO #ZnodeOmsPersonalizeCartItemNew
	 FROM ZnodeOmsPersonalizeCartItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 INSERT INTO @TBL_OmsSavedCartOld (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	 SELECT SKU , OmsOrderLineItemsId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemOld TBL_B WHERE TBL_B.OmsOrderLineItemsId = ISNULL(TBL_A.ParentOmsOrderLineItemsId,0)  ) ParentSKU
				, ParentOmsOrderLineItemsId
	 FROM #ZnodeOmsSavedCartLineItemOld TBL_A
	 WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId

	 ;With Cte_UpdateOld AS 
	 (
		SELECT ParentOmsOrderLineItemsId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsOrderLineItemsId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemOld a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN Cte_UpdateOld TBL_ON ON (TBL_ON.ParentOmsOrderLineItemsId  = TBL_O.OmsSavedCartLineItemId )

	  INSERT INTO @TBL_OmsSavedCartNew (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	  SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemNew TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL( TBL_A.ParentOmsSavedCartLineItemId,0)   ) ParentSKU
				, ParentOmsSavedCartLineItemId
	  FROM #ZnodeOmsSavedCartLineItemNew TBL_A
	  WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	 ;With Cte_UpdateNew AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )	 
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN Cte_UpdateNew TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000) 
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000)  
	  FROM @TBL_OmsSavedCartNew TBL_O 
	

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000)
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000) 
	  FROM @TBL_OmsSavedCartOld TBL_O 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartOld a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartNew a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	 UPDATE a 
	 SET  a.Quantity =  a.Quantity+d.Quantity 
	 FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId)

	 ;WITH CTE_UpdateOrder 
	 AS 
	 (
	   SELECT Sequence,  ROW_NUMBER()Over(order BY OmsSavedCartLineItemId ASC) RowId
	   FROM ZnodeOmsSavedCartLineItem WITH (NOLOCK)
	   WHERE  OmsSavedCartId = @OmsSavedCartId
	 
	 ) 
	 UPDATE CTE_UpdateOrder 
	 SET Sequence =RowId



	 DECLARE @DeletedId TABLE (OmsSavedCartLineItemId INT )

	
	 DELETE  FROM #ZnodeOmsOrderLineItems_temp OUTPUT DELETED.OmsOrderLineItemsId INTO @DeletedId WHERE OmsOrderLineItemsId IN (SELECT c.OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId))


	 DELETE FROM #ZnodeOmsOrderLineItems_temp WHERE ParentOmsOrderLineItemsId IN (SELECT OmsSavedCartLineItemId FROM @DeletedId)

	 DELETE TR FROM #ZnodeOmsOrderLineItems_temp TR 
	 WHERE NOT EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp YU WHERE TR.OmsOrderLineItemsId = YU.ParentOmsOrderLineItemsId  ) 
	 AND TR.ParentOmsOrderLineItemsId IS NULL 

   UPDATE #ZnodeOmsOrderLineItems_temp 
   SET ParentRowId = (SELECT TOP 1 RowId FROM #ZnodeOmsOrderLineItems_temp a WHERE a.OmsOrderLineItemsId = #ZnodeOmsOrderLineItems_temp.ParentOmsOrderLineItemsId ) 
	BEGIN TRANSACTION ReorderSaveCart
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails
											,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description)
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.Sequence  INTO @TBL_ZnodeOmsSavedCartLineItem
		SELECT NULL,@OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,NULL CustomText, NULL CartAddOnDetails
											,RowId,@UserId,@GetDate,@UserId,@GetDate,AutoAddonSKU,NULL OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description
		FROM #ZnodeOmsOrderLineItems_temp 
		ORDER BY OmsOrderLineItemsId 

		UPDATE #ZnodeOmsOrderLineItems_temp 
		SET ParentRowID = (SELECT TOP 1 ROWID FROM #ZnodeOmsOrderLineItems_temp WHERE OrderLineItemRelationshipTypeID IS NULL)
		where OrderLineItemRelationshipTypeID IS NOT NULL

            
		  UPDATE ab 
		  SET ab.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_ZnodeOmsSavedCartLineItem av WHERE av.RowId = b.ParentRowId   )
		  FROM ZnodeOmsSavedCartLineItem ab 
		  INNER JOIN @TBL_ZnodeOmsSavedCartLineItem a ON (a.OmsSavedCartLineItemId = ab.OmsSavedCartLineItemId ) 
		  INNER JOIN #ZnodeOmsOrderLineItems_temp b ON  (b.RowId = a.RowId  ) 

		  INSERT INTO ZnodeOmsPersonalizeCartItem (OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
		  SELECT c.OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,@UserId,@GetDate,@UserId,@GetDate,DesignId,ThumbnailURL
		  FROM ZnodeOmsPersonalizeItem  a 
		  INNER JOIN #ZnodeOmsOrderLineItems_temp b ON (a.OmsOrderLineItemsId = b.OmsOrderLineItemsId)
		  INNER JOIN @TBL_ZnodeOmsSavedCartLineItem c ON (c.RowId = b.RowId )

		  UPDATE ZOSCLI1 set Quantity = null
		  from ZnodeOmsSavedCartLineItem ZOSCLI1
		  where ParentOmsSavedCartLineItemId is null and OmsSavedCartId = @OmsSavedCartId
		  and Quantity is not null
		   and not exists(select * from ZnodeOmsSavedCartLineItem ZOSCLI where OrderLineItemRelationshipTypeId IN (@BundleOrderLineItemRelationshipTypeId,@GroupOrderLineItemRelationshipTypeId ) and ZOSCLI1.OmsSavedCartLineItemId = ZOSCLI.ParentOmsSavedCartLineItemId )

		  UPDATE ZnodeOmsSavedCart
		  SET ModifiedDate = GETDATE()
		  WHERE OmsSavedCartId = @OmsSavedCartId
	COMMIT TRANSACTION ReorderSaveCart
   SET @status = 1 
   
END TRY 
BEGIN CATCH 
	ROLLBACK TRANSACTION ReorderSaveCart
	SELECT ERROR_MESSAGE()
	SET @status = 0 

	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertSaveCartLineItemsForReOrder @OmsOrderId = '+CAST(@OmsOrderId AS VARCHAR(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@OmsSavedCartId='+CAST(@OmsSavedCartId AS VARCHAR(50))+',@OmsOrderLineItemsId='+CAST(@OmsOrderLineItemsId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
    SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
    EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_InsertSaveCartLineItemsForReOrder',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPimCategoryData')
	DROP PROC Znode_ImportPimCategoryData
GO

CREATE PROCEDURE [dbo].[Znode_ImportPimCategoryData]
(   @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         NVARCHAR(200),
    @ImportProcessLogId INT,
    @UserId             INT,
    @LocaleId           INT,
    @DefaultFamilyId    INT)
AS

    /*
      Summary : Finally Import data into ZnodePimProduct, ZnodePimAttributeValue and ZnodePimAttributeValueLocale Table 
      Process : Flat global temporary table will split into cloumn wise and associted with Znode Attributecodes,
    		    Create group of product with their attribute code and values and inseerted one by one products. 	   
    
      SourceColumnName : CSV file column headers
      TargetColumnName : Attributecode from ZnodePimAttribute Table 

	 ***  Need to log error if transaction failed during insertion of records into table.

	EXEC Znode_ImportPimCategoryData 
    */

     BEGIN
         SET NOCOUNT ON;
         BEGIN TRY
             
             DECLARE @SQLQuery NVARCHAR(MAX);
			 DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
             DECLARE @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @PimAttributeFamilyId INT, @NewProductId INT, @PimAttributeValueId INT, @status BIT= 0; 
             --Declare error Log Table 

			 IF OBJECT_ID('tempdb.dbo.#DuplicateCategory', 'U') IS NOT NULL 
		     DROP TABLE tempdb.dbo.#DuplicateCategory

			 IF OBJECT_ID('tempdb.dbo.#DefaultHideCategoryonMenu', 'U') IS NOT NULL   
			 DROP TABLE tempdb.dbo.#DefaultHideCategoryonMenu

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             IF @DefaultFamilyId = 0
                 BEGIN
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with cource column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @IsCategory = 1,
						  @DefaultFamilyId=@DefaultFamilyId;
                     UPDATE @FamilyAttributeDetail
                       SET
                           PimAttributeFamilyId = DBO.Fn_GetCategoryDefaultFamilyId();

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;
             ELSE
                 BEGIN
                     INSERT INTO @FamilyAttributeDetail
                     (PimAttributeId,
                      AttributeTypeName,
                      AttributeCode,
                      SourceColumnName,
                      IsRequired,
                      PimAttributeFamilyId
                     )
                     --Call Process to insert data of defeult family with cource column name and target column name 
                     EXEC Znode_ImportGetTemplateDetails
                          @TemplateId = @TemplateId,
                          @IsValidationRules = 0,
                          @IsIncludeRespectiveFamily = 1,
                          @DefaultFamilyId = @DefaultFamilyId,
                          @IsCategory = 1;

					---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
					Delete FAD from @FamilyAttributeDetail FAD
					where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
					and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
					               inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)
                 END;  
			 --Read all matched CategoryId with respect to their CategoryCode 
			 --SET @SQLQuery = 
			 --SELECT * FROM ZnodePimCategoryAttributeValue zpca INNER JOIN ZnodePimCategoryAttributeValueLocale zpcal 
			 --ON zpca.PimCategoryAttributeValueId = zpcal.PimCategoryAttributeValueId Inner join ZnodePimAttribute ZPA on zpca.PimAttributeId = zpa.PimAttributeId 
			 --AND ZPA.IsCategory =1 AND ZPA.AttributeCode = 'CategoryCode' 
			 --Inner join ' + @TableName +' tlb ON zpcal.CategoryValue = tlb.CategoryCode

		
             --Read all attribute details with their datatype 

             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeValue'
             )
                 BEGIN
                     CREATE TABLE #DefaultAttributeValue
                     (AttributeTypeName          VARCHAR(300),
                      PimAttributeDefaultValueId INT,
                      PimAttributeId             INT,
                      AttributeDefaultValueCode  VARCHAR(100)
                     );
                     INSERT INTO #DefaultAttributeValue
                     (AttributeTypeName,
                      PimAttributeDefaultValueId,
                      PimAttributeId,
                      AttributeDefaultValueCode
                     )
                     --Call Process to insert default data value 
                     EXEC Znode_ImportGetPimAttributeDefaultValue;
                 END;
             ELSE
                 BEGIN
                     DROP TABLE #DefaultAttributeValue;
                 END;  
         
             -- Split horizontal table into verticle table by column name and attribute Value with their 
             -- corresponding AttributeId, Default family , Default AttributeValue Id  
             DECLARE @PimCategoryDetail TABLE
             ([PimCategoryId]              [INT] NULL,
              [PimAttributeId]             [INT] NULL,
              [PimAttributeValueId]        [INT] NULL,
              [PimAttributeDefaultValueId] [INT] NULL,
              [PimAttributeFamilyId]       [INT] NULL,
              [LocaleId]                   [INT] NULL,
              [AttributeCode]              [VARCHAR](500) NULL,
              [AttributeValue]             [NVARCHAR](MAX) NULL,
              [RowNumber]                  INT 
             );
             -- Column wise split data from source table ( global temporary table ) and inserted into temporary table variable @PimCategoryDetail
             -- Add PimAttributeDefaultValue 

             DECLARE Cr_AttributeDetails CURSOR LOCAL FAST_FORWARD
             FOR SELECT PimAttributeId,
                        AttributeTypeName,
                        AttributeCode,
                        IsRequired,
                        SourceColumnName,
                        PimAttributeFamilyId
                 FROM @FamilyAttributeDetail
                 WHERE ISNULL(SourceColumnName, '') <> '';
             OPEN Cr_AttributeDetails;
             FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
             WHILE @@FETCH_STATUS = 0
                 BEGIN
                     SET @NewProductId = 0;
                     SET @SQLQuery = 'SELECT '''+CONVERT(VARCHAR(100), @PimAttributeFamilyId)+''' PimAttributeFamilyId, 0 PimCategoryId,'''+CONVERT(VARCHAR(100), @AttributeId)+''' AttributeId ,
						   (SELECT TOP 1 PimAttributeDefaultValueId FROM #DefaultAttributeValue Where PimAttributeId =  '+CONVERT(VARCHAR(100), @AttributeId)+'AND  AttributeDefaultValueCode = TN.'+@SourceColumnName+' ) PimAttributeDefaultValueId,'+@SourceColumnName+','+CONVERT(VARCHAR(100), @LocaleId)+'LocaleId,RowNumber FROM '+@TableName+' TN';
                     INSERT INTO @PimCategoryDetail
                     ([PimAttributeFamilyId],
                      [PimCategoryId],
                      [PimAttributeId],
                      [PimAttributeDefaultValueId],
                      AttributeValue,
                      LocaleId,
                      RowNumber
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                     FETCH NEXT FROM Cr_AttributeDetails INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @PimAttributeFamilyId;
                 END;
             CLOSE Cr_AttributeDetails;
             DEALLOCATE Cr_AttributeDetails;
             UPDATE ppdti
               SET
                   ppdti.AttributeValue = CASE
                                              WHEN ppdti.AttributeValue = 'Yes/No'
                                              THEN 'False'
                                          END
             FROM @PimCategoryDetail ppdti
                  INNER JOIN #DefaultAttributeValue dav ON dav.PimAttributeDefaultValueId = ppdti.PimAttributeDefaultValueId
             WHERE ISNULL(ppdti.AttributeValue, '') = '';

			 SELECT PCD.AttributeValue
			 INTO #DuplicateCategory
			 FROM @PimCategoryDetail PCD
			 INNER JOIN ZnodePimAttribute PA ON (PCD.PimAttributeId = PA.PimAttributeId)
			 where PA.AttributeCode = 'CategoryCode' 
			 GROUP BY PCD.AttributeValue
			 Having Count(*) > 1


			INSERT INTO ZnodeImportLog
			(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
			 SELECT '53' ,'CategoryCode',PCD.AttributeValue,PCD.RowNumber,@NewGUID,2,GETDATE(),2,GETDATE(),@ImportProcessLogId
			 FROM @PimCategoryDetail PCD
			 WHERE RowNumber IN (SELECT RowNumber frOM #DuplicateCategory DC 
								 INNER JOIN ZnodePimAttribute PA ON (PCD.PimAttributeId = PA.PimAttributeId)
								 WHERE PA.AttributeCode = 'CategoryCode' 
								 AND PCD.AttributeValue = DC.AttributeValue )

			SELECT PIMDTL.AttributeValue,PA.AttributeCode 
			INTO #DefaultHideCategoryonMenu
			FROM @PimCategoryDetail PIMDTL INNER JOIN ZnodePimAttribute PA ON (PIMDTL.PimAttributeId = PA.PimAttributeId)
			WHERE PA.AttributeCode='HideCategoryonMenu'

			INSERT INTO ZnodeImportLog  
			(ErrorDescription,ColumnName,Data,RowNumber,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId) 
			SELECT '68' ,'HideCategoryonMenu',PCD.AttributeValue,PCD.RowNumber,@NewGUID,2,GETDATE(),2,GETDATE(),@ImportProcessLogId  
			FROM @PimCategoryDetail PCD  
			WHERE RowNumber IN (SELECT RowNumber frOM #DefaultHideCategoryonMenu DC   
			INNER JOIN ZnodePimAttribute PA ON (PCD.PimAttributeId = PA.PimAttributeId)  
			WHERE PA.AttributeCode = 'HideCategoryonMenu'   
			AND PCD.AttributeValue = DC.AttributeValue ) AND PCD.AttributeValue NOT IN ('1','0','yes','no','true','false')

			
			 ----update mediaid for CategoryImage
			 select zm.FileName,max(MediaId) as MediaId, PCD.RowNumber
			 into #CategoryImage
			 from ZnodeMedia ZM
			 inner join @PimCategoryDetail PCD on ZM.FileName = PCD.AttributeValue
			 where exists(select * from ZnodePimAttribute c where PCD.PimAttributeId = c.PimAttributeId and c.AttributeCode = 'CategoryImage')
			 group by zm.FileName, PCD.RowNumber 
			 
			update a set a.AttributeValue = b.MediaId
			from @PimCategoryDetail a
			inner join #CategoryImage b on a.AttributeValue = b.FileName and a.RowNumber = b.RowNumber
				
			 ----update PimCategoryId present in znode on basis of CategoryCode
			 update d set  d.PimCategoryId = a.PimCategoryId
			 from ZnodePimCategoryAttributeValue a
			 inner join ZnodePimCategoryAttributeValueLocale b on a.PimCategoryAttributeValueId = b.PimCategoryAttributeValueId
			 inner join ZnodePimAttribute c on a.PimAttributeId = c.PimAttributeId
			 inner join @PimCategoryDetail d on d.AttributeValue = b.CategoryValue and c.PimAttributeId = d.PimAttributeId
			 where c.AttributeCode = 'CategoryCode' 

			 ----update PimCategoryId for other attributes if category is present
			 ;WITH CTE_UpdateCategoryId AS
			(
				select PimCategoryId, RowNumber from @PimCategoryDetail where isnull(PimCategoryId,0) <> 0
			)
			UPDATE PCD set PCD.PimCategoryId = UC.PimCategoryId
			FROM @PimCategoryDetail PCD
			INNER JOIN CTE_UpdateCategoryId UC on PCD.RowNumber = UC.RowNumber
			 ---------------------------

             -- Pass product records one by one 
             DECLARE @IncrementalId INT= 1;
             DECLARE @SequenceId INT=
             (
                 SELECT MAX(RowNumber)
                 FROM @PimCategoryDetail
             );
             DECLARE @PimCategoryDetailToInsert PIMCATEGORYDETAIL;  --User define table type to pass multiple records of product in single step

             WHILE @IncrementalId <= @SequenceId
                 BEGIN
                     INSERT INTO @PimCategoryDetailToInsert
                     ([PimCategoryId],
                      [PimAttributeId],
                      [PimAttributeValueId],
                      [PimAttributeDefaultValueId],
                      [PimAttributeFamilyId],
                      [LocaleId],
                      [AttributeCode],
                      [AttributeValue]
                     )
                            SELECT [PimCategoryId],
                                   [PimAttributeId],
                                   [PimAttributeValueId],
                                   [PimAttributeDefaultValueId],
                                   [PimAttributeFamilyId],
                                   [LocaleId],
                                   [AttributeCode],
                                   [AttributeValue]
                            FROM @PimCategoryDetail
                            WHERE [@PimCategoryDetail].RowNumber = @IncrementalId AND LTRIM(RTRIM([AttributeValue])) <> '';
                     --ORDER BY [@PimCategoryDetail].RowNumber;
                     ----Call process to finally insert data into 
                     ----------------------------------------------------------
                     --1. [dbo].[ZnodePimProduct]
                     --2. [dbo].[ZnodePimAttributeValue]
                     --3. [dbo].[ZnodePimAttributeValueLocale]

                     EXEC [Znode_ImportInsertUpdatePimCategory]
                          @InsertCategory = @PimCategoryDetailToInsert,
                          @UserID = @UserID,
                          @status = @status OUT,
						  @IsImport=1;--,@IsNotReturnOutput=1;
                     DELETE FROM @PimCategoryDetailToInsert;
                     SET @IncrementalId = @IncrementalId + 1;
                 END;

			
				-- Update Record count in log 
				DECLARE @FailedRecordCount BIGINT
				DECLARE @SuccessRecordCount BIGINT
				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
				EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount OUTPUT
				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;
				

             --Updating the import process status
			UPDATE ZnodeImportProcessLog
			SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
								WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
								WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
							END, 
				ProcessCompletedDate = getdate()
			WHERE ImportProcessLogId = @ImportProcessLogId;	   	  
            
			IF OBJECT_ID('tempdb.dbo.#DuplicateCategory', 'U') IS NOT NULL 
		     DROP TABLE tempdb.dbo.#DuplicateCategory

			IF OBJECT_ID('tempdb.dbo.#DefaultHideCategoryonMenu', 'U') IS NOT NULL   
			DROP TABLE tempdb.dbo.#DefaultHideCategoryonMenu

         END TRY
         BEGIN CATCH
             SELECT ERROR_MESSAGE(),ERROR_LINE(),ERROR_PROCEDURE();
 
			 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPimCategoryData @TableName = '+CAST(@TableName AS VARCHAR(max))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200)) +',@TemplateId='+CAST(@TemplateId AS VARCHAR(200)) +',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(10))+',@DefaultFamilyId='+CAST(@DefaultFamilyId AS VARCHAR(200));
            ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportPimCategoryData',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
            
         END CATCH;
     END;

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodePortalKlaviyoSetting')
BEGIN
	CREATE TABLE [dbo].[ZnodePortalKlaviyoSetting](
	[PortalKlaviyoSettingId] [int] IDENTITY(1,1) NOT NULL,
	[KlaviyoCode] [nvarchar](100) NULL,
	[PortalId] [int] NOT NULL,
	[UserName] [varchar](500) NULL,
	[Password] [varchar](500) NULL,
	[PublicApiKey] [varchar](500) NULL,
	[CreatedBy] [int] NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NOT NULL,
	[ModifiedDate] [datetime] NOT NULL,
	[IsActive] [bit] NOT NULL,
	 CONSTRAINT [PK_ZnodePortalKlaviyoSetting] PRIMARY KEY CLUSTERED 
	(
		[PortalKlaviyoSettingId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]
END

GO

IF NOT EXISTS(SELECT * FROM SYS.sysconstraints WHERE OBJECT_NAME(CONSTID) = 'FK_ZnodePortalKlaviyoSetting_ZnodePortal')
BEGIN
	ALTER TABLE [dbo].[ZnodePortalKlaviyoSetting]  WITH CHECK 
	ADD  CONSTRAINT [FK_ZnodePortalKlaviyoSetting_ZnodePortal] FOREIGN KEY([PortalId])
	REFERENCES [dbo].[ZnodePortal] ([PortalId])
END

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeOrderPayment')
BEGIN
	CREATE TABLE [dbo].[ZnodeOrderPayment] (
	[OrderPaymentId]        INT             IDENTITY (1, 1) NOT NULL,
	[OmsOrderId]        INT             NULL,
	[TransactionReference]        NVARCHAR (50)   NULL,
	[Amount]              DECIMAL   NULL,
	[TransactionStatus]            NVARCHAR (50)   NULL,
	[TransactionDate]            DATETIME   NULL,
	[CreatedBy]      INT             NOT NULL,
	[CreatedDate]    DATETIME        NOT NULL,
	[ModifiedBy]     INT             NOT NULL,
	[ModifiedDate]   DATETIME        NOT NULL,
	[PaymentSettingId]           INT    NULL,
	CONSTRAINT [PK_ZnodeOrderPayment] PRIMARY KEY CLUSTERED ([OrderPaymentId] ASC) WITH (FILLFACTOR = 90),
	CONSTRAINT [FK_ZnodeOrderPayment_ZnodeOMSOrder] FOREIGN KEY ([OmsOrderId]) REFERENCES [dbo].[ZnodeOMSOrder] ([OMSOrderId]),
	CONSTRAINT [FK_ZnodeOrderPayment_ZnodePaymentSetting] FOREIGN KEY ([PaymentSettingId]) REFERENCES [dbo].[ZnodePaymentSetting] ([PaymentSettingId])
	);
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOmsOrderDetail')
	DROP PROC Znode_GetOmsOrderDetail
GO

CREATE PROCEDURE [dbo].[Znode_GetOmsOrderDetail]
( 
	@WhereClause NVARCHAR(MAX),
	@Rows        INT            = 100,
	@PageNo      INT            = 1,
	@Order_BY    VARCHAR(1000)  = '',
	@RowsCount   INT OUT			,
	@UserId	   INT = 0 ,
	@IsFromAdmin int=0,
	@SalesRepUserId int = 0 
 )
AS
    /*
     Summary : This procedure is used to get the oms order detils
			   Records are fetched for those users who placed the order i.e UserId is Present in ZnodeUser and  ZnodeOmsOrderDetails tables
	 Unit Testing:

    EXEC [Znode_GetOmsOrderDetail_SCT] 'PortalId =1',@Order_BY = '',@RowsCount= 0, @UserId = 0 ,@Rows = 50, @PageNo = 1

	declare @p7 int
	set @p7=4
	exec sp_executesql N'Znode_GetOmsOrderDetail_SCT @WhereClause, @Rows,@PageNo,@Order_By,@RowCount OUT,@UserId,@IsFromAdmin',N'@WhereClause nvarchar(30),@Rows int,@PageNo int,@Order_By nvarchar(14),@RowCount int output,@UserId int,@IsFromAdmin int',@WhereClause=N'(PortalId in(''1'',''4'',''5'',''6''))',@Rows=50,@PageNo=1,@Order_By=N'orderdate desc',@RowCount=@p7 output,@UserId=0,@IsFromAdmin=1
	select @p7



   */
BEGIN
    BEGIN TRY
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
		DECLARE @SQL NVARCHAR(MAX), @ProcessType  varchar(50)='Order'
		DECLARE @OrderLineItemRelationshipTypeId INT
		SET @OrderLineItemRelationshipTypeId = ( SELECT top 1 OrderLineItemRelationshipTypeId  FROM ZnodeOmsOrderLineItemRelationshipType where Name = 'AddOns' )

		----Verifying that the @SalesRepUserId is having 'Sales Rep' role
		IF NOT EXISTS
		(
			SELECT * FROM ZnodeUser ZU
			INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
			INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
			INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
			Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
			AND ZU.UserId = @SalesRepUserId
		)   
		Begin
			SET @SalesRepUserId = 0
		End

		DECLARE @Fn_GetPaginationWhereClause VARCHAR(500) = dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows),
		@Fn_GetFilterWhereClause NVARCHAR(MAX) = ''
		set @Fn_GetFilterWhereClause=dbo.Fn_GetFilterWhereClause(@WhereClause)
			
		IF @Order_BY = ''
			set @Order_BY = 'OrderDate desc'

			set @Order_BY = replace(@Order_BY,'PortalId','ZODD.PortalId')
			set @Order_BY = replace(@Order_BY,'UserName','ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'''')+'' ''+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'''')')
			set @Order_BY = replace(@Order_BY,'email','ZODD.Email')
			set @Order_BY = replace(@Order_BY,'OrderState','case when ZOS.IsShowToCustomer=0 and '+cast( @IsFromAdmin as varchar(50))+' = 0 then ZOSC.Description else  ZOS.Description end')
			set @Order_BY = replace(@Order_BY,'PaymentStatus','ZOPS.Name')
			set @Order_BY = replace(@Order_BY,'PublishState','ZODPS.DisplayName')
			set @Order_BY = replace(@Order_BY,'StoreName','ZP.StoreName')

			Declare @Fn_GetPagingRowId NVARCHAR(MAX) = ' DENSE_RANK()Over('+ ' Order By '+CASE WHEN Isnull(@Order_BY,'') = '' THEN 'OmsOrderId DESC' ELSE @Order_BY + ',OmsOrderId DESC' END  + ') RowId '
						
			IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount

			IF OBJECT_ID('tempdb..#Portal') is not null
				DROP TABLE #Portal
			
			Create table #TBL_RowCount(RowsCount int )
			CREATE TABLE #tbl_GetRecurciveUserId  (ID INT IDENTITY(1,1) Primary key,UserId INT,ParentUserId INT)
			INSERT INTO #tbl_GetRecurciveUserId
			SELECT UserId,ParentUserId FROM dbo.Fn_GetRecurciveUserId (CAST(@UserId AS VARCHAR(50)),@ProcessType ) FNRU
			 
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'PortalId','ZODD.PortalId')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'UserName','ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'''')+'' ''+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'''')')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'email','ZODD.Email')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'OrderState','case when ZOS.IsShowToCustomer=0 and '+cast( @IsFromAdmin as varchar(50))+' = 0 then ZOSC.Description else  ZOS.Description end')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'PaymentStatus','ZOPS.Name')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'PublishState','ZODPS.DisplayName')
			set @Fn_GetFilterWhereClause = replace(@Fn_GetFilterWhereClause,'StoreName','ZP.StoreName')

			
		
	
		set @Fn_GetPagingRowId = replace(@Fn_GetPagingRowId,'OmsOrderId','Zoo.OmsOrderId')
		
		
		set @Rows = @PageNo * @Rows

		CREATE TABLE #Portal (PortalId int,StoreName varchar(200))
		insert into #Portal
		select PortalId,StoreName
		from ZnodePortal

		SET @SQL = '
		SELECT Distinct top '+cast(@Rows as varchar(10))+' Zoo.OmsOrderId,Zoo.OrderNumber, ZODD.PortalId,ZP.StoreName ,ZODD.CurrencyCode,
		case when ZOS.IsShowToCustomer=0 and '+cast( @IsFromAdmin as varchar(50))+' = 0 then ZOSC.Description else  ZOS.Description end  OrderState,ZODD.ShippingId,ZODD.PaymentTypeId,ZODD.PaymentSettingId
		,ZOPS.Name PaymentStatus,ZPS.Name PaymentType,CAST(1 AS BIT) ShippingStatus ,ZODD.OrderDate,ZODD.UserId,ISNULL(RTRIM(LTRIM(ZODD.FirstName)),'''')
		+'' ''+ISNULL(RTRIM(LTRIM(ZODD.LastName)),'''') UserName ,ZODD.PaymentTransactionToken ,ZODD.OrderTotalWithoutVoucher as Total,ZODD.OmsOrderDetailsId,ZODD.PoDocument,
		ZODD.Email ,ZODD.PhoneNumber ,ZODD.SubTotal ,ZODD.TaxCost ,ZODD.ShippingCost,ZODD.BillingPostalCode,ZODD.RemainingOrderAmount,
		ZODD.ModifiedDate AS OrderModifiedDate,  ZODD.PaymentDisplayName  ,isnull(Zoo.ExternalId,0) ExternalId,ZODD.CreditCardExpMonth,ZODD.CultureCode--,ZODD.TotalAdditionalCost
		,ZODD.CreditCardExpYear,ZODD.CardType,ZODD.CreditCardNumber,ZODD.PaymentExternalId,ZODPS.DisplayName as PublishState,
		'''' ProductName, 0 CountId, CAST (0 as bit) IsInRMA, '+@Fn_GetPagingRowId+'
		INTO #Cte_OrderLineDescribe
		FROM ZnodeOmsOrder (nolock) ZOO 
		INNER JOIN ZnodeOmsOrderDetails (nolock) ZODD ON (ZODD.OmsOrderId = ZOO.OmsOrderId AND  ZODD.IsActive = 1)
		INNER JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOO.PublishStateId)
		INNER JOIN #Portal ZP (nolock) ON ZODD.PortalId = ZP.PortalId
		LEFT JOIN ZnodePaymentType (nolock) ZPS ON (ZPS.PaymentTypeId = ZODD.PaymentTypeId )
		LEFT JOIN ZnodeOmsOrderStateShowToCustomer (nolock) ZOSC ON (ZOSC.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsOrderState (nolock) ZOS ON (ZOS.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsPaymentState (nolock) ZOPS ON (ZOPS.OmsPaymentStateId = ZODD.OmsPaymentStateId)
		WHERE (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZODD.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0 )  
		AND (EXISTS (SELECT TOP 1 1 FROM #tbl_GetRecurciveUserId FNRU WHERE FNRU.UserId = ZODD.UserId ) OR '+cast(@UserId as varchar(10))+'  =0 )'
		+ @Fn_GetFilterWhereClause+' 
		ORDER BY '+CASE WHEN Isnull(@Order_BY,'') = '' THEN 'OmsOrderId DESC' ELSE @Order_BY + ',OmsOrderId DESC' END +' 

		INSERT INTO #TBL_RowCount 
		SELECT count(*)
		FROM ZnodeOmsOrder (nolock) ZOO 
		INNER JOIN ZnodeOmsOrderDetails (nolock) ZODD ON (ZODD.OmsOrderId = ZOO.OmsOrderId AND  ZODD.IsActive = 1)
		INNER JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOO.PublishStateId)
		INNER JOIN #Portal ZP (nolock) ON ZODD.PortalId = ZP.PortalId
		LEFT JOIN ZnodePaymentType (nolock) ZPS ON (ZPS.PaymentTypeId = ZODD.PaymentTypeId )
		LEFT JOIN ZnodeOmsOrderStateShowToCustomer (nolock) ZOSC ON (ZOSC.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsOrderState (nolock) ZOS ON (ZOS.OmsOrderStateId = ZODD.OmsOrderStateId)
		LEFT JOIN ZnodeOmsPaymentState (nolock) ZOPS ON (ZOPS.OmsPaymentStateId = ZODD.OmsPaymentStateId)
		WHERE (EXISTS(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZODD.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0 )  
		AND (EXISTS (SELECT TOP 1 1 FROM #tbl_GetRecurciveUserId FNRU WHERE FNRU.UserId = ZODD.UserId ) OR '+cast(@UserId as varchar(10))+'  =0 )'
		+ @Fn_GetFilterWhereClause+' 
			
		Create index Ind_OrderLineDescribe_RowId on #Cte_OrderLineDescribe(RowId )

		SELECT OmsOrderId,OrderNumber,PortalId,StoreName,CurrencyCode,OrderState,ShippingId,
		PaymentTypeId,PaymentSettingId,PaymentStatus,PaymentType,ShippingStatus,OrderDate,UserId,UserName,PaymentTransactionToken,Total,
		PN OrderItem,a.OmsOrderDetailsId,CountId ItemCount, PoDocument AS PODocumentPath,IsInRMA ,
		Email,PhoneNumber,SubTotal,TaxCost,ShippingCost,BillingPostalCode,null ShippingPostalCode
		,OrderModifiedDate,PaymentDisplayName, a.RemainingOrderAmount,
		ExternalId,CreditCardExpMonth,CreditCardExpYear,CardType,CreditCardNumber,PaymentExternalId,CultureCode,PublishState --TotalAdditionalCost
		FROM #Cte_OrderLineDescribe a inner join (select OmsOrderDetailsId, min(ProductName) PN, sum(case when OmsOrderLineItemsId is null then 0 else 1 end ) CNT from ZnodeOmsOrderLineItems
		where ParentOmsOrderLineItemsId is not null group by OmsOrderDetailsId ) b on a.OmsOrderDetailsId = b.OmsOrderDetailsId
		' + @Fn_GetPaginationWhereClause +' order by RowId '

		--print @SQL
		EXEC(@SQL)
		Select @RowsCount= isnull(RowsCount  ,0) from #TBL_RowCount
		
		IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount

		IF OBJECT_ID('tempdb..#Portal') is not null
			DROP TABLE #Portal
		
    END TRY
    BEGIN CATCH
        DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOmsOrderDetail @WhereClause = '''+ISNULL(CAST(@WhereClause AS VARCHAR(max)),'''''')+''',@Rows='''+ISNULL(CAST(@Rows AS VARCHAR(50)),'''''')+''',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',
		@Order_BY='+ISNULL(@Order_BY,'''''')+',@UserId = '+ISNULL(CAST(@UserId AS VARCHAR(50)),'''')+',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')+',@IsFromAdmin='+ISNULL(CAST(@IsFromAdmin AS VARCHAR(10)),'''');
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetOmsOrderDetail',
		@ErrorInProcedure = 'Znode_GetOmsOrderDetail',
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentHistory')
	DROP PROC Znode_GetPaymentHistory
GO	 
	 
CREATE PROCEDURE [dbo].[Znode_GetPaymentHistory]
( 
	@OrderId  INT
)
AS 
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
	   SELECT OP.OrderPaymentId, OP.OmsOrderId, OP.TransactionReference,	OP.Amount, OP.TransactionStatus, OP.TransactionDate, 
			OP.PaymentSettingId, OOD.RemainingOrderAmount, OP.CreatedDate, OP.ModifiedDate, PT.PaymentDisplayName as PaymentType
	   FROM ZnodeOrderPayment OP
	   INNER JOIN ZnodeOmsOrderDetails OOD on OP.OmsOrderId = OOD.OmsOrderId
	   INNER JOIN ZnodePaymentSetting PT on OP.PaymentSettingId = PT.PaymentSettingId
	   WHERE OP.OmsOrderId=@OrderId
	END TRY
    BEGIN CATCH
		DECLARE @Status BIT ;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
		@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(), 
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentHistory @OrderId = '+CAST(@OrderId AS VARCHAR(50));
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetPaymentHistory',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
    END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrder')
	DROP PROC Znode_InsertUpdateOmsOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrder]
(
	@OrderXML XML,
	@UserId INT
)
AS
BEGIN
SET NOCOUNT ON;
BEGIN TRY

	DECLARE @GetDate DATETIME = GETDATE()
	DECLARE @OMSOrder TABLE(OmsOrderId INT,OrderNumber VARCHAR(200))
	DECLARE @OMSOrderDetail TABLE(OmsOrderId INT,OmsOrderDetailsId INT)
	DECLARE @OmsOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX),OrderLineItemRelationshipTypeId INT,ParentSku VARCHAR(600), GroupIdentifier INT)
	DECLARE @OmsParentOrderLineItems TABLE(RowId INT IDENTITY(1,1),OmsOrderDetailsId INT,OmsOrderLineItemsId INT, Sku VARCHAR(600), ParentOmsOrderLineItemsId INT, GroupId NVARCHAR(MAX), OrderLineItemRelationshipTypeId INT, GroupIdentifier INT)

	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);

	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);

	DECLARE @OrderLineItemRelationshipTypeIdBundles int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	DECLARE @OrderLineItemRelationshipTypeIdGroup int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);

	DECLARE @OrderLineItemRelationshipTypeIdConfig int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);


	CREATE TABLE #TempOrderData
	(
		RowId INT IDENTITY(1,1),OrderNumber VARCHAR(200), PublishStateId INT,OmsOrderId INT,OmsOrderStateId INT,
		DiscountAmount NUMERIC(28,6),SalesTax NUMERIC(28,6),TaxRate NUMERIC(28,6),IsOldOrder BIT,VAT NUMERIC(28,6),GST NUMERIC(28,6),
		PST NUMERIC(28,6),HST NUMERIC(28,6),Total NUMERIC(28,6),BillingAddressId INT,ShippingAddressId INT,ShippingId INT,
		PortalId INT,ShippingNumber NVARCHAR(max),TrackingNumber NVARCHAR(1000),CouponCode NVARCHAR(1000),
		PromoDescription NVARCHAR(max),ReferralUserId int,PurchaseOrderNumber NVARCHAR(1000),OmsPaymentStateId int,
		WebServiceDownloadDate datetime,PaymentSettingId int,PaymentTransactionToken NVARCHAR(600),ShipDate datetime,ReturnDate datetime,
		AddressId int,PoDocument NVARCHAR(600),IsActive bit,ExternalId NVARCHAR(1000),PaymentTypeId INT,CreatedBy INT,CreatedDate datetime,ModifiedBy INT,
		ModifiedDate datetime,CreditCardNumber VARCHAR(4),IsShippingCostEdited bit,IsTaxCostEdited bit,ShippingDifference NUMERIC(28,6),
		EstimateShippingCost NUMERIC(28,6),TransactionId NVARCHAR(800),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),
		Custom4 NVARCHAR(MAX),Custom5 NVARCHAR(MAX),FirstName NVARCHAR(200),LastName NVARCHAR(200),CardType VARCHAR(50),CreditCardExpMonth INT,
		CreditCardExpYear INT,TotalAdditionalCost NUMERIC(28,6),PaymentDisplayName NVARCHAR(2000),PaymentExternalId NVARCHAR(2000),
		CultureCode VARCHAR(200),DisplayName NVARCHAR(2000),InHandDate datetime,IpAddress VARCHAR(100),JobName NVARCHAR(200),
		ShippingConstraintCode NVARCHAR(100),ShippingDiscount NUMERIC(28,6),ShippingHandlingCharges NUMERIC(28,6),ReturnCharges NUMERIC(28,6),
		IsCalculateTaxAfterDiscount bit,Email VARCHAR(50),PhoneNumber VARCHAR(50),OrderTotalWithoutVoucher NUMERIC(28,6),ImportDuty NUMERIC(28,6),
		TaxCost NUMERIC(28,6),ShippingCost NUMERIC(28,6), SubTotal NUMERIC(28,6),CurrencyCode VARCHAR(100),OverDueAmount NUMERIC(28,6), ShippingTypeId INT,
		AccountNumber NVARCHAR(4000),ShippingMethod NVARCHAR(4000),PaymentCode NVARCHAR(400) ,PaymentStatusId Int, RemainingOrderAmount NUMERIC(28,6)
	)

	CREATE TABLE #TempOrderBillingAddress
	(
		AddressId INT,BillingFirstName VARCHAR(300),BillingLastName VARCHAR(300),BillingCountry VARCHAR(3000),BillingStateCode VARCHAR(300),
		BillingPostalCode VARCHAR(50),BillingPhoneNumber VARCHAR(50),BillingEmailId VARCHAR(50),BillingStreet1 VARCHAR(300),BillingStreet2 VARCHAR(300),
		BillingCity VARCHAR(3000),BillingCompanyName NVARCHAR(1200)
	)
	
	CREATE TABLE #TempParentLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), GroupIdentifier INT
	)

	CREATE TABLE #TempChildLineItemDetails
	(
		RowId INT IDENTITY(1,1),OrderLineItemRelationshipTypeId INT,OmsOrderDetailsId INT,OmsOrderShipmentId INT,RmaReasonForReturnId INT,Sku NVARCHAR(600),ProductName NVARCHAR(1000),
		Description NVARCHAR(max),Quantity NUMERIC(28,6),Price NUMERIC(28,6),Weight NUMERIC(28,6),DownloadLink NVARCHAR(max),DiscountAmount NUMERIC(28,6),
		ShipSeparately bit,ShipDate datetime,ReturnDate datetime,ShippingCost NUMERIC(28,6),PromoDescription NVARCHAR(max),TransactionNumber NVARCHAR(max),
		PaymentStatusId int,TrackingNumber NVARCHAR(max),IsAutoGeneratedTracking bit,OrderLineItemStateId int,IsRecurringBilling bit,RecurringBillingPeriod NVARCHAR(100),
		RecurringBillingCycles int,RecurringBillingFrequency NVARCHAR(100),RecurringBillingAmount NUMERIC(28,6),AppliedPromo NVARCHAR(max),CouponsApplied NVARCHAR(100),
		ExternalId NVARCHAR(1000),IsActive bit,CreatedBy int,CreatedDate datetime,ModifiedBy int,ModifiedDate datetime,AutoAddonSKU NVARCHAR(max),IsShippingReturn bit,
		PartialRefundAmount NUMERIC(28,6),Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),Custom4 NVARCHAR(max),Custom5 NVARCHAR(max),
		GroupId NVARCHAR(max),BundleQuantity int, TaxRuleId INT,TaxTransactionNumber NVARCHAR(1200),Comments NVARCHAR(MAX),SalesTax NUMERIC(28,6),VAT NUMERIC(28,6),
		GST NUMERIC(28,6),PST NUMERIC(28,6),HST NUMERIC(28,6),ImportDuty NUMERIC(28,6), ParentSku NVARCHAR(600), GroupIdentifier INT
	)

	CREATE TABLE #TempOrderAttribute
	(
		AttributeCode NVARCHAR(1000),AttributeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,AttributeValueCode NVARCHAR(1000), Sku VARCHAR(600), GroupId NVARCHAR(max), GroupIdentifier INT
	)

	CREATE TABLE #OmsPersonalizeItem
	(
		PersonalizeCode NVARCHAR(400),PersonalizeValue NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,
		ModifiedDate DATETIME,DesignId NVARCHAR(4000),ThumbnailURL NVARCHAR(MAX), Sku VARCHAR(600), GroupId NVARCHAR(max),
		GroupIdentifier INT
	)

	CREATE TABLE #OmsOrderDiscount
	(
		OmsDiscountTypeId INT,DiscountCode VARCHAR(300),DiscountAmount NUMERIC(28,6),Description NVARCHAR(MAX),CreatedBy INT,CreatedDate DATETIME,
		ModifiedBy INT,ModifiedDate DATETIME,PerQuantityDiscount NUMERIC(28,6),DiscountMultiplier NUMERIC(28,6),ParentOmsOrderLineItemsId INT,
		DiscountLevelTypeId INT,PromotionName NVARCHAR(1200),PromotionTypeId INT,DiscountAppliedSequence INT,PromotionMessage NVARCHAR(MAX),Sku VARCHAR(600),
		GroupId NVARCHAR(max)
	)

	--------Getting Order details
	INSERT INTO #TempOrderData
	(
		OrderNumber, PublishStateId ,OmsOrderId ,OmsOrderStateId ,DiscountAmount ,SalesTax ,TaxRate ,IsOldOrder ,
		VAT ,GST ,PST ,HST ,Total ,BillingAddressId ,ShippingAddressId ,ShippingId ,PortalId,
		ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
		,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
		,ExternalId,PaymentTypeId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
		,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
		,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
		,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
		,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,TaxCost,ShippingCost, SubTotal,
		CurrencyCode,OverDueAmount, ShippingTypeId, AccountNumber, ShippingMethod, PaymentCode, PaymentStatusId,RemainingOrderAmount
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderNumber[1]', 'NVARCHAR(Max)' ) END  AS OrderNumber,
		CASE WHEN Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PublishStateId[1]', 'NVARCHAR(Max)' ) END AS PublishStateId,
		CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
		CASE WHEN Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderStateId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderStateId,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRate[1]', 'NVARCHAR(Max)' ) END AS TaxRate,
		CASE WHEN Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') = '' THEN NULL ELSE Tbl.Col.value('IsOldOrder[1]', 'NVARCHAR(2000)') END AS IsOldOrder,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE  Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END  AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Total,
		CASE WHEN Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(Max)' ) END AS BillingAddressId,
		CASE WHEN Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingAddressId[1]', 'NVARCHAR(Max)' ) END AS ShippingAddressId,
		CASE WHEN (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) = '' THEN NULL ELSE (Tbl.Col.value( 'ShippingId[1]', 'NVARCHAR(Max)' )) END  AS ShippingId,
		CASE WHEN Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(Max)' ) END AS PortalId,
		Tbl.Col.value( 'ShippingNumber[1]', 'NVARCHAR(Max)' ) AS ShippingNumber,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		Tbl.Col.value( 'CouponCode[1]', 'NVARCHAR(Max)' ) AS CouponCode,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		CASE WHEN Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReferralUserId[1]', 'NVARCHAR(Max)' ) END  AS ReferralUserId,
		Tbl.Col.value( 'PurchaseOrderNumber[1]', 'NVARCHAR(Max)' ) AS PurchaseOrderNumber,
		CASE WHEN Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsPaymentStateId[1]', 'NVARCHAR(Max)' ) END AS OmsPaymentStateId,
		Tbl.Col.value( 'WebServiceDownloadDate[1]', 'NVARCHAR(Max)' ) AS WebServiceDownloadDate,
		CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END AS PaymentSettingId,
		Tbl.Col.value( 'PaymentTransactionToken[1]', 'NVARCHAR(Max)' ) AS PaymentTransactionToken,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) END AS AddressId,
		Tbl.Col.value( 'PoDocument[1]', 'NVARCHAR(Max)' ) AS PoDocument,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END  AS IsActive,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentTypeId[1]', 'NVARCHAR(Max)' ) END  AS PaymentTypeId,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'CreditCardNumber[1]', 'NVARCHAR(Max)' ) AS CreditCardNumber,
		CASE WHEN Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsShippingCostEdited,
		CASE WHEN Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsTaxCostEdited[1]', 'NVARCHAR(Max)' ) END AS IsTaxCostEdited,
		Tbl.Col.value( 'ShippingDifference[1]', 'NVARCHAR(Max)' ) AS ShippingDifference,
		CASE WHEN Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'EstimateShippingCost[1]', 'NVARCHAR(Max)' ) END AS EstimateShippingCost,
		Tbl.Col.value( 'TransactionId[1]', 'NVARCHAR(Max)' ) AS TransactionId,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CardType[1]', 'NVARCHAR(Max)' ) AS CardType,
		Tbl.Col.value( 'CreditCardExpMonth[1]', 'NVARCHAR(Max)' ) AS CreditCardExpMonth,
		Tbl.Col.value( 'CreditCardExpYear[1]', 'NVARCHAR(Max)' ) AS CreditCardExpYear,
		CASE WHEN Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TotalAdditionalCost[1]', 'NVARCHAR(Max)' ) END AS TotalAdditionalCost,
		Tbl.Col.value( 'PaymentDisplayName[1]', 'NVARCHAR(Max)' ) AS PaymentDisplayName,
		Tbl.Col.value( 'PaymentExternalId[1]', 'NVARCHAR(Max)' ) AS PaymentExternalId,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(Max)' ) AS CultureCode,
		Tbl.Col.value( 'DisplayName[1]', 'NVARCHAR(Max)' ) AS DisplayName,
		Tbl.Col.value( 'InHandDate[1]', 'NVARCHAR(Max)' ) AS InHandDate,
		Tbl.Col.value( 'IpAddress[1]', 'NVARCHAR(Max)' ) AS IpAddress,
		Tbl.Col.value( 'JobName[1]', 'NVARCHAR(Max)' ) AS JobName,
		Tbl.Col.value( 'ShippingConstraintCode[1]', 'NVARCHAR(Max)' ) AS ShippingConstraintCode,
		Tbl.Col.value( 'ShippingDiscount[1]', 'NVARCHAR(Max)' ) AS ShippingDiscount,
		Tbl.Col.value( 'ShippingHandlingCharges[1]', 'NVARCHAR(Max)' ) AS ShippingHandlingCharges,
		CASE WHEN Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'ReturnCharges[1]', 'NVARCHAR(Max)' ) END AS ReturnCharges,
		CASE WHEN Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsCalculateTaxAfterDiscount[1]', 'NVARCHAR(Max)' ) END AS IsCalculateTaxAfterDiscount,
		Tbl.Col.value( 'Email[1]', 'NVARCHAR(Max)' ) AS Email,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		CASE WHEN Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OrderTotalWithoutVoucher[1]', 'NVARCHAR(Max)' )  END AS OrderTotalWithoutVoucher,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN '' ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		CASE WHEN Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'TaxCost[1]', 'NVARCHAR(Max)' ) END  AS TaxCost,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		CASE WHEN Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'SubTotal[1]', 'NVARCHAR(Max)' ) END AS SubTotal,
		Tbl.Col.value( 'CurrencyCode[1]', 'NVARCHAR(Max)' ) AS CurrencyCode,
		CASE WHEN Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OverDueAmount[1]', 'NVARCHAR(Max)' ) END AS OverDueAmount,
		CASE WHEN Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingTypeId[1]', 'NVARCHAR(Max)' ) END AS ShippingTypeId,
		Tbl.Col.value( 'AccountNumber[1]', 'NVARCHAR(Max)' ) AS AccountNumber,
		Tbl.Col.value( 'ShippingMethod[1]', 'NVARCHAR(Max)' ) AS ShippingMethod,
		Tbl.Col.value( 'PaymentCode[1]', 'NVARCHAR(Max)' ) AS PaymentCode,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		CASE WHEN Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) END AS RemainingOrderAmount
	FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col);


	--Getting billing address info
	INSERT INTO #TempOrderBillingAddress
	(
		AddressId,BillingFirstName,BillingLastName,BillingCompanyName,BillingStreet1,BillingStreet2,
		BillingCity,BillingStateCode,BillingPostalCode,BillingCountry,BillingPhoneNumber,BillingEmailId
	)
	SELECT
		Tbl.Col.value( 'AddressId[1]', 'NVARCHAR(Max)' ) AS AddressId,
		Tbl.Col.value( 'FirstName[1]', 'NVARCHAR(Max)' ) AS FirstName,
		Tbl.Col.value( 'LastName[1]', 'NVARCHAR(Max)' ) AS LastName,
		Tbl.Col.value( 'CompanyName[1]', 'NVARCHAR(Max)' ) AS CompanyName,
		Tbl.Col.value( 'Street1[1]', 'NVARCHAR(Max)' ) AS Street1 ,
		Tbl.Col.value( 'Street2[1]', 'NVARCHAR(Max)' ) AS Street2,
		Tbl.Col.value( 'City[1]', 'NVARCHAR(Max)' ) AS City,
		Tbl.Col.value( 'StateCode[1]', 'NVARCHAR(Max)' ) AS StateCode,
		Tbl.Col.value( 'PostalCode[1]', 'NVARCHAR(Max)' ) AS PostalCode,
		Tbl.Col.value( 'Country[1]', 'NVARCHAR(Max)' ) AS Country,
		Tbl.Col.value( 'PhoneNumber[1]', 'NVARCHAR(Max)' ) AS PhoneNumber,
		Tbl.Col.value( 'EmailId[1]', 'NVARCHAR(Max)' ) AS EmailId
	FROM @OrderXML.nodes( '//PlaceOrderModel/BillingAddressModel' ) AS Tbl(Col);
	----Parent line item details insert
	INSERT INTO #TempParentLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END  AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		CASE WHEN Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) END AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) = ''  THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END  AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )= ''  THEN NULL ELSE Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel' ) AS Tbl(Col);

	----Child line item details insert
	INSERT INTO #TempChildLineItemDetails
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description,Quantity,
		Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber,
		PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles,
		RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy,
		ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity,
		TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty, ParentSku, GroupIdentifier
	)
	SELECT
		CASE WHEN Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemRelationshipTypeId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemRelationshipTypeId,
		CASE WHEN Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsOrderDetailsId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderDetailsId,
		CASE WHEN Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderShipmentId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderShipmentId,
		CASE WHEN Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RmaReasonForReturnId[1]', 'NVARCHAR(Max)' ) END AS RmaReasonForReturnId,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(2000)' ) AS ProductName,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(Max)' ) AS Quantity,
		CASE WHEN Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Price[1]', 'NVARCHAR(Max)' ) END AS Price,
		Tbl.Col.value( 'Weight[1]', 'NVARCHAR(Max)' ) AS Weight,
		Tbl.Col.value( 'DownloadLink[1]', 'NVARCHAR(Max)' ) AS DownloadLink,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'ShipSeparately[1]', 'NVARCHAR(Max)' ) AS ShipSeparately,
		CASE WHEN Tbl.Col.value( 'ShipDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE @GetDate END AS ShipDate,
		CASE WHEN Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ReturnDate[1]', 'NVARCHAR(Max)' ) END AS ReturnDate,
		CASE WHEN Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'ShippingCost[1]', 'NVARCHAR(Max)' ) END AS ShippingCost,
		Tbl.Col.value( 'PromoDescription[1]', 'NVARCHAR(Max)' ) AS PromoDescription,
		Tbl.Col.value( 'TransactionNumber[1]', 'NVARCHAR(Max)' ) AS TransactionNumber,
		CASE WHEN Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PaymentStatusId[1]', 'NVARCHAR(Max)' ) END AS PaymentStatusId,
		Tbl.Col.value( 'TrackingNumber[1]', 'NVARCHAR(Max)' ) AS TrackingNumber,
		CASE WHEN Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'IsAutoGeneratedTracking[1]', 'NVARCHAR(Max)' ) END AS IsAutoGeneratedTracking,
		CASE WHEN Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OrderLineItemStateId[1]', 'NVARCHAR(Max)' ) END AS OrderLineItemStateId,
		CASE WHEN Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'IsRecurringBilling[1]', 'NVARCHAR(Max)' ) END AS IsRecurringBilling,
		Tbl.Col.value( 'RecurringBillingPeriod[1]', 'NVARCHAR(Max)' ) AS RecurringBillingPeriod,
		Tbl.Col.value( 'RecurringBillingCycles[1]', 'NVARCHAR(Max)' ) AS RecurringBillingCycles,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingFrequency,
		Tbl.Col.value( 'RecurringBillingFrequency[1]', 'NVARCHAR(Max)' ) AS RecurringBillingAmount,
		Tbl.Col.value( 'AppliedPromo[1]', 'NVARCHAR(Max)' ) AS AppliedPromo,
		Tbl.Col.value( 'CouponsApplied[1]', 'NVARCHAR(Max)' ) AS CouponsApplied,
		Tbl.Col.value( 'ExternalId[1]', 'NVARCHAR(Max)' ) AS ExternalId,
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(Max)' ) AS IsActive,
		@UserId AS CreatedBy,
		@GetDate AS CreatedDate,
		@UserId AS ModifiedBy,
		@GetDate AS ModifiedDate,
		Tbl.Col.value( 'AutoAddonSKU[1]', 'NVARCHAR(Max)' ) AutoAddonSKU,
		CASE WHEN Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'IsShippingReturn[1]', 'NVARCHAR(Max)' ) END AS IsShippingReturn,
		CASE WHEN Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' )= '' THEN NULL ELSE Tbl.Col.value( 'PartialRefundAmount[1]', 'NVARCHAR(Max)' ) END AS  PartialRefundAmount,
		Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
		Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
		Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
		Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
		Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
		CASE WHEN Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'BundleQuantity[1]', 'NVARCHAR(Max)' ) END AS BundleQuantity,
		CASE WHEN Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TaxRuleId[1]', 'NVARCHAR(Max)' ) END AS TaxRuleId,
		Tbl.Col.value( 'TaxTransactionNumber[1]', 'NVARCHAR(Max)' ) AS TaxTransactionNumber,
		Tbl.Col.value( 'Comments[1]', 'NVARCHAR(Max)' ) AS Comments,
		CASE WHEN Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) ='' THEN NULL ELSE Tbl.Col.value( 'SalesTax[1]', 'NVARCHAR(Max)' ) END AS SalesTax,
		CASE WHEN Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'VAT[1]', 'NVARCHAR(Max)' ) END AS VAT,
		CASE WHEN Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'GST[1]', 'NVARCHAR(Max)' ) END AS GST,
		CASE WHEN Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'PST[1]', 'NVARCHAR(Max)' ) END AS PST,
		CASE WHEN Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'HST[1]', 'NVARCHAR(Max)' ) END AS HST,
		CASE WHEN Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE  Tbl.Col.value( 'ImportDuty[1]', 'NVARCHAR(Max)' ) END AS ImportDuty,
		Tbl.Col.value( 'ParentProductSKU[1]', 'NVARCHAR(Max)' ) AS ParentSku,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(Max)' ) AS GroupIdentifier
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection') AS Tbl(Col);

	--Updating parent for simple products
	UPDATE #TempChildLineItemDetails SET ParentSku = Sku WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple
	AND OrderLineItemRelationshipTypeId IS NOT NULL

BEGIN TRAN OrderInsert

	--Inserting order number which are unique and getting in xml from code side
	INSERT INTO ZnodeOmsOrder(IsQuoteOrder,OrderNumber,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PublishStateId,IsOldOrder)
	OUTPUT INSERTED.OmsOrderId, INSERTED.OrderNumber INTO @OMSOrder
	SELECT 0 AS IsQuoteOrder, OrderNumber,OrderNumber AS ExternalId,@UserId,@GetDate,@UserId,@GetDate,PublishStateId, CAST(0 AS BIT)
	FROM #TempOrderData
	WHERE ISNULL(OmsOrderId,0) = 0

	--If order is new then creating new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,RemainingOrderAmount
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,OBA.BillingCompanyName,
			OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry,OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,
			OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total
			,OD.ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,OD.BillingAddressId,PoDocument,CAST(1 AS BIT) AS IsActive
			,OD.ExternalId,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited
			,ShippingDifference,EstimateShippingCost,TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName,PaymentExternalId,CultureCode
			,OD.DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges
			,IsCalculateTaxAfterDiscount,Email,OD.PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,OD.RemainingOrderAmount
		FROM #TempOrderData OD
		INNER JOIN @OMSOrder OO ON OD.OrderNumber = OO.OrderNumber
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId

	END
	--If order managed then creating new order details and disable old order details
	ELSE
	BEGIN
		Declare @OldOmsOrderDetailsId INT
		SET @OldOmsOrderDetailsId = (SELECT TOP 1 OOD.OmsOrderDetailsId FROM ZnodeOmsOrderDetails OOD  WITH (NOLOCK) 
									 WHERE EXISTS(SELECT * FROM  #TempOrderData OD WHERE OOD.OmsOrderId = OD.OmsOrderId) AND OOD.IsActive = 1)

		INSERT INTO ZnodeOmsOrderDetails
		(
			OmsOrderId,PortalId,UserId,OrderDate,OmsOrderStateId,ShippingId,PaymentTypeId,BillingFirstName,BillingLastName --1
			,BillingCompanyName,BillingStreet1,BillingStreet2,BillingCity,BillingStateCode,BillingPostalCode,BillingCountry --2
			,BillingPhoneNumber,BillingEmailId,TaxCost,ShippingCost,SubTotal,DiscountAmount,CurrencyCode,OverDueAmount,Total --3
			,ShippingNumber,TrackingNumber,CouponCode,PromoDescription,ReferralUserId,PurchaseOrderNumber,OmsPaymentStateId --4
			,WebServiceDownloadDate,PaymentSettingId,PaymentTransactionToken,ShipDate,ReturnDate,AddressId,PoDocument,IsActive --5
			,ExternalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CreditCardNumber,IsShippingCostEdited,IsTaxCostEdited --6
			,ShippingDifference,EstimateShippingCost,TransactionId,Custom1,Custom2,Custom3,Custom4,Custom5,FirstName,LastName --7
			,CardType,CreditCardExpMonth,CreditCardExpYear,TotalAdditionalCost,PaymentDisplayName, --8
			PaymentExternalId,CultureCode, --9
			DisplayName,InHandDate,IpAddress,JobName,ShippingConstraintCode,ShippingDiscount,ShippingHandlingCharges,ReturnCharges --10
			,IsCalculateTaxAfterDiscount,Email,PhoneNumber,OrderTotalWithoutVoucher,ImportDuty,RemainingOrderAmount --11 
		)
		OUTPUT INSERTED.OmsOrderId, INSERTED.OmsOrderDetailsId INTO @OMSOrderDetail
		SELECT OO.OmsOrderId, OD.PortalId,@UserId,@GetDate,OD.OmsOrderStateId,OD.ShippingId,OD.PaymentTypeId,OBA.BillingFirstName,OBA.BillingLastName,--1
			OBA.BillingCompanyName,OBA.BillingStreet1,OBA.BillingStreet2,OBA.BillingCity,OBA.BillingStateCode,OBA.BillingPostalCode,OBA.BillingCountry, --2
			OBA.BillingPhoneNumber,OBA.BillingEmailId,OD.TaxCost,OD.ShippingCost,OD.SubTotal, OD.DiscountAmount,OD.CurrencyCode,OD.OverDueAmount,OD.Total, --3
			OD.ShippingNumber,OD.TrackingNumber,OD.CouponCode,OD.PromoDescription,OD.ReferralUserId,OD.PurchaseOrderNumber,OD.OmsPaymentStateId, --4
			OD.WebServiceDownloadDate,OD.PaymentSettingId,OD.PaymentTransactionToken,OD.ShipDate,OD.ReturnDate,OD.BillingAddressId,OD.PoDocument,CAST(1 AS BIT) AS IsActive --5
			,OD.ExternalId,OD.CreatedBy,OOD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.CreditCardNumber,OD.IsShippingCostEdited,OD.IsTaxCostEdited, --6
			OD.ShippingDifference,OD.EstimateShippingCost,OD.TransactionId,OD.Custom1,OD.Custom2,OD.Custom3,OD.Custom4,OD.Custom5,OD.FirstName,OD.LastName, --7
			OD.CardType,OD.CreditCardExpMonth,OD.CreditCardExpYear,OD.TotalAdditionalCost,CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentDisplayName ELSE OD.PaymentDisplayName END AS PaymentDisplayName, --8
			CASE WHEN OD.PaymentSettingId = OOD.PaymentSettingId THEN OOD.PaymentExternalId ELSE OD.PaymentExternalId END AS PaymentExternalId,OD.CultureCode, --9 
			OD.DisplayName,OD.InHandDate,OD.IpAddress,OD.JobName,OD.ShippingConstraintCode,OD.ShippingDiscount,OD.ShippingHandlingCharges,OD.ReturnCharges, --10
			OD.IsCalculateTaxAfterDiscount,OD.Email,OD.PhoneNumber,OD.OrderTotalWithoutVoucher,OD.ImportDuty,OD.RemainingOrderAmount --11
		FROM #TempOrderData OD
		INNER JOIN ZnodeOmsOrder OO WITH (NOLOCK) ON OD.OrderNumber = OO.OrderNumber
		INNER JOIN ZnodeOmsOrderDetails OOD  WITH (NOLOCK) ON OO.OmsOrderId = OOD.OmsOrderId AND OOD.IsActive = 1
		LEFT JOIN #TempOrderBillingAddress OBA ON OD.BillingAddressId = OBA.AddressId
	
		DECLARE @OmsOrderStateIdCancelled int =  (select top 1 OmsOrderStateId FROM ZnodeOmsOrderState WHERE OrderStateName = 'CANCELED')

		UPDATE ZnodeOmsOrderDetails SET IsActive = 0 , OmsOrderStateId = @OmsOrderStateIdCancelled
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId

		UPDATE ZnodeOmsOrderLineItems SET IsActive = 0
		WHERE OmsOrderDetailsId = @OldOmsOrderDetailsId
	END

	----Geting new OmsOrderDetailsId always
	Declare @OmsOrderDetailsId INT
	SET @OmsOrderDetailsId = ( SELECT TOP 1 OmsOrderDetailsId FROM @OMSOrderDetail )

	--Insert Order notes only for new order details
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		INSERT INTO ZnodeOmsNotes(OmsOrderDetailsId,Notes,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate )
		SELECT @OmsOrderDetailsId,Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) AS Notes,
			@UserId,@GetDate,@UserId,@GetDate
		FROM @OrderXML.nodes( '//PlaceOrderModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'AdditionalInstructions[1]', 'NVARCHAR(Max)' ) <> '';
	END

	----Inserting parent line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId,INSERTED.GroupIdentifier INTO @OmsParentOrderLineItems
	SELECT OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description--1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,ISNULL(IsActive,1) AS IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, GroupIdentifier --5
	FROM #TempParentLineItemDetails PLID

	----Inserting child line item data
	INSERT INTO ZnodeOmsOrderLineItems
	(
		OrderLineItemRelationshipTypeId,OmsOrderDetailsId,OmsOrderShipmentId,RmaReasonForReturnId,Sku,ProductName,Description --1
		,Quantity,Price,Weight,DownloadLink,DiscountAmount,ShipSeparately,ShipDate,ReturnDate,ShippingCost,PromoDescription,TransactionNumber --2
		,PaymentStatusId,TrackingNumber,IsAutoGeneratedTracking,OrderLineItemStateId,IsRecurringBilling,RecurringBillingPeriod,RecurringBillingCycles --3
		,RecurringBillingFrequency,RecurringBillingAmount,AppliedPromo,CouponsApplied,ExternalId,IsActive,CreatedBy,CreatedDate,ModifiedBy --4
		,ModifiedDate,AutoAddonSKU,IsShippingReturn,PartialRefundAmount,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,BundleQuantity, --5
		ParentSku, GroupIdentifier --6
	)
	OUTPUT INSERTED.OmsOrderDetailsId, INSERTED.OmsOrderLineItemsId, INSERTED.Sku,INSERTED.ParentOmsOrderLineItemsId, INSERTED.GroupId, INSERTED.OrderLineItemRelationshipTypeId, INSERTED.ParentSku, INSERTED.GroupIdentifier INTO @OmsOrderLineItems
	SELECT PLID.OrderLineItemRelationshipTypeId,@OmsOrderDetailsId,PLID.OmsOrderShipmentId,PLID.RmaReasonForReturnId,PLID.Sku,PLID.ProductName,PLID.Description, --1
		PLID.Quantity,PLID.Price,PLID.Weight,PLID.DownloadLink,PLID.DiscountAmount,PLID.ShipSeparately,PLID.ShipDate,PLID.ReturnDate,PLID.ShippingCost,PLID.PromoDescription,PLID.TransactionNumber, --2
		PLID.PaymentStatusId,PLID.TrackingNumber,PLID.IsAutoGeneratedTracking,PLID.OrderLineItemStateId,PLID.IsRecurringBilling,PLID.RecurringBillingPeriod,PLID.RecurringBillingCycles,--3
		PLID.RecurringBillingFrequency,PLID.RecurringBillingAmount,PLID.AppliedPromo,PLID.CouponsApplied,PLID.ExternalId,isnull(PLID.IsActive,1) AS IsActive,PLID.CreatedBy,PLID.CreatedDate,PLID.ModifiedBy, --4
		PLID.ModifiedDate,PLID.AutoAddonSKU,PLID.IsShippingReturn,PLID.PartialRefundAmount,PLID.Custom1,PLID.Custom2,PLID.Custom3,PLID.Custom4,PLID.Custom5,PLID.GroupId,PLID.BundleQuantity, --5
		case when PLID.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdSimple then PLID.Sku else PLID.ParentSku end AS ParentSku, GroupIdentifier --6
	FROM #TempChildLineItemDetails PLID

	--Updating ParentOmsOrderLineItemsId for child line items for simple, group and configurable products
	UPDATE A SET A.ParentOmsOrderLineItemsId = (SELECT TOP 1 OmsOrderLineItemsId FROM @OmsParentOrderLineItems d WHERE d.GroupIdentifier = a.GroupIdentifier AND A.ParentSku = D.Sku  and ISNULL(a.GroupId,'-') = ISNULL(d.GroupId,'-'))
	FROM @OmsOrderLineItems a
	WHERE a.OrderLineItemRelationshipTypeId NOT IN ( @OrderLineItemRelationshipTypeIdAddon, @OrderLineItemRelationshipTypeIdGroup)  
	AND a.ParentOmsOrderLineItemsId IS NULL 
	
	--Updating ParentOmsOrderLineItemsId for child line items for group products
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup)
	BEGIN
		---Getting child lineitems for group product
		;WITH Cte_GroupProductChild AS
		(
			SELECT GroupIdentifier,Sku, ParentSku, OmsOrderLineItemsId, ParentOmsOrderLineItemsId,Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsOrderLineItems
			WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdGroup
		)
		---Getting parent lineitems for group product
		,Cte_GroupProductParent AS 
		(
			SELECT GroupIdentifier,Sku, OmsOrderLineItemsId, Dense_Rank()Over(Partition By GroupIdentifier ORDER BY OmsOrderLineItemsId) AS RowId1 
			FROM @OmsParentOrderLineItems a
			WHERE OrderLineItemRelationshipTypeId IS NULL
			AND EXISTS(SELECT * FROM @OmsOrderLineItems b WHERE a.GroupIdentifier = b.GroupIdentifier AND a.Sku = b.ParentSku)
		)
		--Updating ParentOmsOrderLineItemsId on child for group products
		UPDATE a SET a.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM Cte_GroupProductChild a
		INNER JOIN Cte_GroupProductParent B ON A.GroupIdentifier = B.GroupIdentifier AND a.RowId1 = b.RowId1 AND b.Sku = a.ParentSku 
	END

	---Updating ParentOmsOrderLineItemsId for addons if present
	IF EXISTS(SELECT * FROM @OmsOrderLineItems WHERE OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
	BEGIN
		--Updating ParentOmsOrderLineItemsId for addon with Simple products , group products and configurable products
		UPDATE b SET b.ParentOmsOrderLineItemsId = c.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsOrderLineItems b on b.ParentSku = c.Sku AND c.GroupIdentifier = b.GroupIdentifier
		WHERE c.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon and c.OrderLineItemRelationshipTypeId is not null
		and b.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND b.ParentOmsOrderLineItemsId IS NULL
		
		--Updating ParentOmsOrderLineItemsId for addon with bundle products
		UPDATE c SET c.ParentOmsOrderLineItemsId = b.OmsOrderLineItemsId
		FROM @OmsOrderLineItems c
		INNER JOIN @OmsParentOrderLineItems b on B.sku = C.parentsku AND c.GroupIdentifier= b.GroupIdentifier
		WHERE B.OrderLineItemRelationshipTypeId is null 
		AND c.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
		AND C.ParentOmsOrderLineItemsId IS NULL
	 END
	 ---Updating ParentOmsOrderLineItemsId in main table
	 UPDATE a SET a.ParentOmsOrderLineItemsId = b.ParentOmsOrderLineItemsId
	 FROM  ZnodeOmsOrderLineItems a
	 INNER JOIN @OmsOrderLineItems b on a.OmsOrderLineItemsId = b.OmsOrderLineItemsId

	----Shipping details Start
	DECLARE @ShippingTypeId INT
	IF EXISTS(SELECT * FROM #TempOrderData WHERE ShippingTypeId IS NULL)
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM ZnodeShipping WHERE EXISTS(SELECT * FROM #TempOrderData WHERE ZnodeShipping.ShippingId = #TempOrderData.ShippingId))
	END
	ELSE
	BEGIN
		SET @ShippingTypeId = (SELECT TOP 1 ShippingTypeId FROM #TempOrderData)
	END
	IF EXISTS(SELECT * FROM ZnodeShippingTypes WITH (NOLOCK)  WHERE ShippingTypeId = @ShippingTypeId AND ClassName = 'ZnodeCustomerShipping')
	BEGIN
		INSERT INTO ZnodeOmsCustomerShipping(OmsOrderDetailsId,UserId,ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT TOP 1 @OmsOrderDetailsId,@UserId,@ShippingTypeId,AccountNumber,ShippingMethod,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		FROM #TempOrderData
	END
	----Shipping details end

	----Order tax details start
	----Inserting order tax data
	IF (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		INSERT INTO ZnodeOmsTaxOrderDetails(OmsOrderDetailsId,SalesTax,VAT,GST,PST,HST,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportDuty)
		SELECT @OmsOrderDetailsId,OD.SalesTax,OD.VAT,OD.GST,OD.PST,OD.HST,OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.ImportDuty
		FROM #TempOrderData OD
	END

	----Inserting order tax data for parent line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
	CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempParentLineItemDetails CLID
	INNER JOIN @OmsParentOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0

	----Inserting order tax data for child line item
	INSERT INTO ZnodeOmsTaxOrderLineDetails
	(
		OmsOrderLineItemsId,TaxRuleId,TaxTransactionNumber,Comments,SalesTax,VAT,GST,PST,HST,ImportDuty,
		CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
	)
	SELECT POLI.OmsOrderLineItemsId,CLID.TaxRuleId,CLID.TaxTransactionNumber,CLID.Comments,CLID.SalesTax,CLID.VAT,CLID.GST,CLID.PST,CLID.HST,CLID.ImportDuty,
		CLID.CreatedBy,CLID.CreatedDate,CLID.ModifiedBy,CLID.ModifiedDate
	FROM #TempChildLineItemDetails CLID
	INNER JOIN @OmsOrderLineItems POLI ON CLID.Sku = POLI.Sku AND ISNULL(CLID.GroupId,'') = ISNULL(POLI.GroupId,'') AND CLID.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NOT NULL
	AND (ISNULL(CLID.SalesTax,0)+ISNULL(CLID.VAT,0)+ISNULL(CLID.GST,0)+ISNULL(CLID.PST,0)+ISNULL(CLID.HST,0)) > 0
	----Order tax details end

	----Order attribte details start
	----Fetching order attributes FROM xml
	INSERT INTO #TempOrderAttribute(AttributeCode ,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode,Sku,GroupId, GroupIdentifier )
	SELECT
		Tbl.Col.value( 'AttributeCode[1]', 'NVARCHAR(Max)' ) AS AttributeCode,
		Tbl.Col.value( 'AttributeValue[1]', 'NVARCHAR(Max)' ) AS AttributeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'AttributeValueCode[1]', 'NVARCHAR(2000)' ) AS AttributeValueCode,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/OrderLineItem/PlaceOrderlineItemCollection/OrderAttribute/PlaceOrderAttributeModel' ) AS Tbl(Col);

	----Inserting order attributes data
	INSERT INTO ZnodeOmsOrderAttribute(OmsOrderLineItemsId,AttributeCode,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AttributeValueCode)
	SELECT POLI.OmsOrderLineItemsId, OA.AttributeCode,OA.AttributeValue,OA.CreatedBy,OA.CreatedDate,OA.ModifiedBy,OA.CreatedDate,OA.AttributeValueCode
	FROM #TempOrderAttribute OA
	INNER JOIN @OmsOrderLineItems POLI ON OA.Sku = POLI.Sku AND ISNULL(OA.GroupId,'') = ISNULL(POLI.GroupId,'') AND OA.GroupIdentifier = POLI.GroupIdentifier
	----Order attribte details end

	----Personalise details start
	----Fetching personalize order data
	INSERT INTO #OmsPersonalizeItem(PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL,Sku,GroupId, GroupIdentifier)
	SELECT
		Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode,
		Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue,
		@UserId,@GetDate,@UserId,@GetDate,
		Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(2000)' ) AS DesignId,
		Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(2000)' ) AS ThumbnailURL,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId,
		Tbl.Col.value( 'GroupIdentifier[1]', 'NVARCHAR(2000)' ) AS GroupIdentifier
	FROM @OrderXML.nodes( '//PlaceOrderModel/LineItems/PlaceOrderLineItemModel/PersonaliseDetails/PlaceOrderPersonaliseModel' ) AS Tbl(Col);

	--Inserting personalize order data
	INSERT INTO ZnodeOmsPersonalizeItem(OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
	SELECT OmsOrderLineItemsId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL
	FROM #OmsPersonalizeItem OPI
	INNER JOIN @OmsParentOrderLineItems POLI ON OPI.Sku = POLI.Sku AND ISNULL(OPI.GroupId,'') = ISNULL(POLI.GroupId,'') AND OPI.GroupIdentifier = POLI.GroupIdentifier
	WHERE POLI.ParentOmsOrderLineItemsId IS NULL
	----Personalise details end

	----discount details start
	----Fetching order discount data
	INSERT INTO #OmsOrderDiscount
	(
		OmsDiscountTypeId ,DiscountCode,DiscountAmount ,Description ,CreatedBy ,CreatedDate ,
		ModifiedBy ,ModifiedDate ,PerQuantityDiscount,DiscountMultiplier ,DiscountLevelTypeId ,
		PromotionName ,PromotionTypeId ,DiscountAppliedSequence,PromotionMessage ,Sku,GroupId 
	)
	SELECT
	CASE WHEN Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) ='' THEN NULL ELSE Tbl.Col.value( 'OmsDiscountTypeId[1]', 'NVARCHAR(2000)' ) END AS OmsDiscountTypeId,
		Tbl.Col.value( 'DiscountCode[1]', 'NVARCHAR(Max)' ) AS DiscountCode,
		CASE WHEN Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountAmount[1]', 'NVARCHAR(Max)' ) END AS DiscountAmount,
		Tbl.Col.value( 'Description[1]', 'NVARCHAR(2000)' ) AS Description,
		@UserId,@GetDate,@UserId,@GetDate,
		CASE WHEN Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl.Col.value( 'PerQuantityDiscount[1]', 'NVARCHAR(2000)' ) END AS PerQuantityDiscount,
		CASE WHEN Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'DiscountMultiplier[1]', 'NVARCHAR(2000)' ) END AS DiscountMultiplier,
		CASE WHEN Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'DiscountLevelTypeId[1]', 'NVARCHAR(2000)' ) END AS DiscountLevelTypeId,
		Tbl.Col.value( 'PromotionName[1]', 'NVARCHAR(2000)' ) AS PromotionName,
		CASE WHEN Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' )= '' THEN NULL ELSE Tbl.Col.value( 'PromotionTypeId[1]', 'NVARCHAR(2000)' ) END AS PromotionTypeId,
		Tbl.Col.value( 'DiscountAppliedSequence[1]', 'NVARCHAR(2000)' ) AS DiscountAppliedSequence,
		Tbl.Col.value( 'PromotionMessage[1]', 'NVARCHAR(2000)' ) AS PromotionMessage,
		Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	FROM @OrderXML.nodes('//PlaceOrderModel/OrderDiscounts/PlaceOrderDiscountModel') AS Tbl(Col)

	----Inserting order discount data
	--Inserting product level discount for simple and group products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.OmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
		OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,POLI.ParentOmsOrderLineItemsId,
		OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.Sku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'') 
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdSimple , @OrderLineItemRelationshipTypeIdGroup)
	
	--Inserting product level discount for config and bundle products
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,POLI.ParentOmsOrderLineItemsId,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	INNER JOIN @OmsOrderLineItems POLI ON OD.Sku = POLI.ParentSku AND ISNULL(OD.GroupId,'') = ISNULL(POLI.GroupId,'')
	WHERE isnull(OD.Sku,'') <> '' AND POLI.OrderLineItemRelationshipTypeId IN (@OrderLineItemRelationshipTypeIdBundles , @OrderLineItemRelationshipTypeIdConfig)
	
	--Inserting order level discount 
	INSERT INTO ZnodeOmsOrderDiscount
	(
		OmsOrderDetailsId,OmsOrderLineItemId,OmsDiscountTypeId,DiscountCode,DiscountAmount ,Description,
		CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,PerQuantityDiscount,DiscountMultiplier,ParentOmsOrderLineItemsId,
		DiscountLevelTypeId,PromotionName,PromotionTypeId,DiscountAppliedSequence,PromotionMessage
	)
	SELECT DISTINCT @OmsOrderDetailsId,NULL,OD.OmsDiscountTypeId,OD.DiscountCode,OD.DiscountAmount,OD.Description,
	OD.CreatedBy,OD.CreatedDate,OD.ModifiedBy,OD.ModifiedDate,OD.PerQuantityDiscount,OD.DiscountMultiplier,NULL,
	OD.DiscountLevelTypeId,OD.PromotionName,OD.PromotionTypeId,OD.DiscountAppliedSequence,OD.PromotionMessage
	FROM #OmsOrderDiscount OD
	WHERE isnull(OD.Sku,'') = ''
	----discount details end

	----Additional Cost details start
	IF OBJECT_ID('TEMPDB..#TempAdditionalCost') IS NOT NULL
	DROP TABLE #TempAdditionalCost
	--fetching additional cost details
	SELECT Tbl.Col.value( 'Sku[1]', 'NVARCHAR(2000)' ) AS Sku,
		Tbl1.Col.value( 'KeyName[1]', 'NVARCHAR(2000)' ) AS KeyName,
		CASE WHEN Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' )='' THEN NULL ELSE Tbl1.Col.value( 'KeyValue[1]', 'NVARCHAR(2000)' ) END AS KeyValue,
		Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(2000)' ) AS GroupId
	INTO #TempAdditionalCost
	FROM @OrderXML.nodes('//PlaceOrderModel/LineItems/PlaceOrderLineItemModel') AS Tbl(Col)
	CROSS APPLY Tbl.Col.nodes( '*:AdditionalCostList/AdditionalCost' ) AS Tbl1(Col);

	--Inserting additional cost details
	IF EXISTS(SELECT * FROM #TempAdditionalCost)
	BEGIN
		INSERT INTO ZnodeOmsOrderLineItemsAdditionalCost(OmsOrderLineItemsId,KeyName,KeyValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT OLI.OmsOrderLineItemsId, AC.KeyName, AC.KeyValue, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempAdditionalCost AC
		INNER JOIN @OmsOrderLineItems OLI ON AC.Sku = OLI.Sku AND ISNULL(AC.GroupId,'') = ISNULL(OLI.GroupId,'') 
		WHERE OLI.ParentOmsOrderLineItemsId IS NULL
		AND ISNULL(AC.KeyName,'') <> ''
	END
	----Additional Cost details end
	
	DECLARE @OmsOrderId INT
	IF EXISTS(SELECT * FROM @OMSOrder)
	BEGIN
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM @OMSOrder)
	END
	ELSE
	BEGIN 
		SET @OmsOrderId = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
	END
	----RMA details start
	IF (SELECT TOP 1 OmsOrderId FROM #TempOrderData) > 0
	BEGIN
		DECLARE @OldOmsOrderDetailID INT
		SET @OmsOrderID = (SELECT TOP 1 OmsOrderId FROM #TempOrderData)
		SET @OldOmsOrderDetailID = (SELECT TOP 1 OmsOrderDetailsId FROM ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderID AND OmsOrderDetailsId <> @OmsOrderDetailsId ORDER BY OmsOrderDetailsId DESC)

		UPDATE ZnodeRmaReturnDetails
		SET OmsOrderDetailsId = @OmsOrderDetailsId
		WHERE OmsOrderId = @OmsOrderID

		SELECT OOLI.OmsOrderLineItemsId AS OldOmsOrderLineItemsId, OOLI.OmsOrderDetailsId, OOLI.Sku, LI.OmsOrderLineItemsId AS NewOmsOrderLineItemsId
		INTO #OldOrderLineItems
		FROM ZnodeOmsOrderLineItems OOLI WITH (NOLOCK)
		INNER JOIN @OmsOrderLineItems LI ON LI.Sku = OOLI.Sku
		WHERE OOLI.OmsOrderDetailsId = @OldOmsOrderDetailID --AND OOLI.ParentOmsOrderLineItemsId IS NULL
 
		UPDATE RRLI SET RRLI.OmsOrderLineItemsId = OldLI.NewOmsOrderLineItemsId
		FROM ZnodeRmaReturnLineItems RRLI
		INNER JOIN #OldOrderLineItems OldLI ON RRLI.OmsOrderLineItemsId = OldOmsOrderLineItemsId
	
		UPDATE ZnodeOmsOrder set IsOldOrder = 0
		where OmsOrderId = @OmsOrderID
	END
	----RMA details end
	
	---Inserting OrderTaxDetails
	IF(NOT EXISTS(SELECT 1 from ZnodeOmsTaxRule where OmsOrderId= @OmsOrderId)) AND (SELECT TOP 1 TaxCost FROM #TempOrderData) > 0
	BEGIN
		DECLARE @TaxRate Numeric(28,6), @TaxRuleId INT
		SET @TaxRate = (SELECT TOP 1 TaxRate FROM #TempOrderData)
		SET @TaxRuleId = (SELECT TOP 1 TaxRuleId FROM #TempChildLineItemDetails)

		 EXEC [Znode_InsertOrderTaxDetails] @OmsOrderId = @OmsOrderId, @TaxRuleId = @TaxRuleId, @TaxRate = @TaxRate, @Status = 0
	END

	COMMIT TRAN OrderInsert

	SELECT TOP 1 OmsOrderId,@OmsOrderDetailsId AS OmsOrderDetailsId, cast(1 AS bit)  AS Status, '' AS ErrorMessage
	FROM @OMSOrderDetail

END TRY
BEGIN CATCH
	ROLLBACK TRAN OrderInsert
	SELECT TOP 1 0 AS OmsOrderId,0 AS OmsOrderDetailsId, cast(0 AS bit)  AS Status, ERROR_MESSAGE() AS ErrorMessage

	INSERT INTO ZnodeOmsFailedOrderPayments(PaymentCode,PaymentDisplayName,TransactionToken,TotalAmount,UserName,UserId,Email,PaymentSettingId,OrderNumber,OrderDate,PaymentStatusId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
	SELECT TOP 1 PaymentCode,PaymentDisplayName, isnull(PaymentTransactionToken,''),Total,a.FirstName+' '+a.LastName,@UserId,a.Email,a.PaymentSettingId,a.OrderNumber,@GetDate,PaymentStatusId,@UserId,@GetDate,@UserId,@GetDate
	FROM #TempOrderData A
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrder @OrderXML ='+CAST(@OrderXML AS VARCHAR(MAX))+' , @UserId = '+CAST(@UserId AS VARCHAR(50));

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_InsertUpdateOmsOrder',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
	--If error throw in SP the deleting records FROM order tables if data inserted
	EXEC Znode_DeleteOrderById @OrderDetailId=@OmsOrderDetailsId,@Status=0
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrderPayment')
	DROP PROC Znode_InsertUpdateOmsOrderPayment
GO


CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrderPayment]
(
	@OrderPaymentXML XML,
	@OrderId INT,
	@TransactionDate DATETIME,
	@UserId INT,
	@Status BIT = 0 OUT
)
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRAN OrderInsert
	BEGIN TRY

		DECLARE @GetDate DATETIME = GETDATE()

		IF OBJECT_ID('tempdb..#TempOrderPaymentData') IS NOT NULL
			DROP TABLE #TempOrderPaymentData
	
		CREATE TABLE #TempOrderPaymentData
			(OmsOrderId INT, TransactionReference NVARCHAR(50), Amount NUMERIC(18,0), TransactionStatus NVARCHAR(50), PaymentSettingId INT)
	
		--------Getting Order Payment details
		INSERT INTO #TempOrderPaymentData
			(OmsOrderId, TransactionReference, Amount, TransactionStatus , PaymentSettingId)

		SELECT
			CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
			Tbl.Col.value( 'TransactionReference[1]', 'NVARCHAR(Max)' ) AS TransactionReference,
			CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Amount,
			CASE WHEN Tbl.Col.value( 'TransactionStatus[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TransactionStatus[1]', 'NVARCHAR(Max)' ) END AS TransactionStatus,
			CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END  AS PaymentGatewayId
		FROM @OrderPaymentXML.nodes( '//OrderPaymentDataModel' ) AS Tbl(Col);
	
		INSERT INTO ZnodeOrderPayment
			(OmsOrderId, TransactionReference, Amount, TransactionStatus, TransactionDate, PaymentSettingId , CreatedBy, CreatedDate, ModifiedBy, ModifiedDate)
		SELECT OmsOrderId, TransactionReference, Amount, TransactionStatus, @TransactionDate, PaymentSettingId, @UserId, @GetDate, @UserId, @GetDate
		FROM #TempOrderPaymentData 

		SET @Status = 1;
		SELECT 1 AS Id,@Status AS Status;
	COMMIT TRAN OrderInsert
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN OrderInsert
		SET @Status = 0;

		SELECT 0 AS Id, @Status AS Status; 

		DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrderPayment @OrderPaymentXML ='+CAST(@OrderPaymentXML AS VARCHAR(MAX))+' ,@OrderId = '+CAST(@OrderId AS VARCHAR(50))
					+',@TransactionDate = '+CAST(@TransactionDate AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status = '+CAST(@Status AS VARCHAR(50));

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName    = 'Znode_InsertUpdateOmsOrderPayment',
		@ErrorInProcedure = @ERROR_PROCEDURE,
		@ErrorMessage     = @ErrorMessage,
		@ErrorLine        = @ErrorLine,
		@ErrorCall        = @ErrorCall;
	END CATCH
END

GO

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>AttributeCode</name><headertext>Checkbox</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format/><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl/><islinkparamfield/><ischeckbox>y</ischeckbox><checkboxparamfield/><iscontrol>n</iscontrol><controltype/><controlparamfield/><displaytext/><editactionurl/><editparamfield/><deleteactionurl/><deleteparamfield/><viewactionurl/><viewparamfield/><imageactionurl/><imageparamfield/><manageactionurl/><manageparamfield/><copyactionurl/><copyparamfield/><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class/><SearchControlType>--Select--</SearchControlType><SearchControlParameters/><DbParamField/><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>AttributeName</name><headertext>Attribute Name</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format/><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl/><islinkparamfield/><ischeckbox>n</ischeckbox><checkboxparamfield/><iscontrol>n</iscontrol><controltype/><controlparamfield/><displaytext/><editactionurl/><editparamfield/><deleteactionurl/><deleteparamfield/><viewactionurl/><viewparamfield/><imageactionurl/><imageparamfield/><manageactionurl/><manageparamfield/><copyactionurl/><copyparamfield/><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class/><SearchControlType>--Select--</SearchControlType><SearchControlParameters/><DbParamField/><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>IsFacets</name><headertext>Is Facets</headertext><width>30</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format/><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield/><ischeckbox>n</ischeckbox><checkboxparamfield/><iscontrol>n</iscontrol><controltype/><controlparamfield/><displaytext/><editactionurl/><editparamfield/><deleteactionurl/><deleteparamfield/><viewactionurl/><viewparamfield/><imageactionurl/><imageparamfield/><manageactionurl/><manageparamfield/><copyactionurl/><copyparamfield/><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class/><SearchControlType>--Select--</SearchControlType><SearchControlParameters/><DbParamField/><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>IsUseInSearch</name><headertext>Is Use In Search</headertext><width>0</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format/><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl/><islinkparamfield/><ischeckbox>n</ischeckbox><checkboxparamfield/><iscontrol>n</iscontrol><controltype/><controlparamfield/><displaytext/><editactionurl/><editparamfield/><deleteactionurl/><deleteparamfield/><viewactionurl/><viewparamfield/><imageactionurl/><imageparamfield/><manageactionurl/><manageparamfield/><copyactionurl/><copyparamfield/><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class/><SearchControlType>--Select--</SearchControlType><SearchControlParameters/><DbParamField/><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>BoostValue</name><headertext>Boost Value</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format/><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl/><islinkparamfield/><ischeckbox>n</ischeckbox><checkboxparamfield/><iscontrol>n</iscontrol><controltype/><controlparamfield/><displaytext/><editactionurl/><editparamfield/><deleteactionurl/><deleteparamfield/><viewactionurl/><viewparamfield/><imageactionurl/><imageparamfield/><manageactionurl/><manageparamfield/><copyactionurl/><copyparamfield/><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class/><SearchControlType>--Select--</SearchControlType><SearchControlParameters/><DbParamField/><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>SearchProfileId</name><headertext>Search Profile Id</headertext><width>0</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format/><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl/><islinkparamfield /><ischeckbox>n</ischeckbox><checkboxparamfield/><iscontrol>n</iscontrol><controltype/><controlparamfield/><displaytext/><editactionurl/><editparamfield/><deleteactionurl/><deleteparamfield/><viewactionurl/><viewparamfield/><imageactionurl/><imageparamfield/><manageactionurl/><manageparamfield/><copyactionurl/><copyparamfield/><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class/><SearchControlType>--Select--</SearchControlType><SearchControlParameters/><DbParamField/><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Delete</format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl/><islinkparamfield/><ischeckbox>n</ischeckbox><checkboxparamfield/><iscontrol>n</iscontrol><controltype/><controlparamfield/><displaytext>Delete</displaytext><editactionurl/><editparamfield/><deleteactionurl/><deleteparamfield/><viewactionurl/><viewparamfield/><imageactionurl/><imageparamfield/><manageactionurl>/Search/Search/UnAssociatedSearchAttribute</manageactionurl><manageparamfield>SerachProfilesAttributeMappingId</manageparamfield><copyactionurl/><copyparamfield/><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class/><SearchControlType>--Select--</SearchControlType><SearchControlParameters/><DbParamField/><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeUnAssociatedSearchAttributes'

GO

update ZnodeGlobalAttributeGroupLocale 
set AttributeGroupName='Warehouse Settings' 
where AttributeGroupName ='Stock Levels By Warehouse'

insert into ZnodeGlobalAttribute
(AttributeTypeId, AttributeCode, IsRequired, IsLocalizable, IsActive, DisplayOrder,HelpDescription,CreatedBy, CreatedDate, ModifiedBy,ModifiedDate, IsSystemDefined, GlobalEntityId)
select 
(select top 1 AttributeTypeId from ZnodeAttributeType where AttributeTypeName ='Yes/No' ),N'EnableInventoryStockNotification',0,1,1,2,
'When this setting is set as Yes and saved, Users will have the capability to register 
	for products that are out of stock and be notified when the product is back in stock',2,getdate(),2,getdate(),0, 
(select top 1 GlobalEntityId from znodeGlobalEntity where EntityName ='Store')
where not exists  (select AttributeCode from  ZnodeGlobalAttribute where AttributeCode ='EnableInventoryStockNotification')

insert into ZnodeGlobalAttributeLocale(LocaleId,GlobalAttributeId,AttributeName,Description,CreatedBy,
CreatedDate,ModifiedBy,ModifiedDate)
select 1,(select top 1 GlobalAttributeId from ZnodeGlobalAttribute where AttributeCode='EnableInventoryStockNotification'),
'Enable Inventory Stock Notification',
NULL,2,GETDATE(),2,GETDATE()
where not exists (select * from ZnodeGlobalAttributeLocale 
	where GlobalAttributeId=(SELECT TOP 1 GlobalAttributeId FROM ZnodeGlobalAttribute WHERE AttributeCode='EnableInventoryStockNotification')
	and LocaleId = 1)

insert into ZnodeGlobalAttributeGroupMapper (GlobalAttributeGroupId,GlobalAttributeId,AttributeDisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select (select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'WarehouseStockLevels'),
(select top 1 GlobalAttributeId from ZnodeGlobalAttribute where AttributeCode = 'EnableInventoryStockNotification'),null,2,getdate(),2,getdate()
where not exists(select * from ZnodeGlobalAttributeGroupMapper 
     where GlobalAttributeGroupId = (select top 1 GlobalAttributeGroupId from ZnodeGlobalAttributeGroup where GroupCode = 'WarehouseStockLevels')
	 and GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where AttributeCode = 'EnableInventoryStockNotification'))

insert into ZnodePortalGlobalAttributeValue(PortalId,GlobalAttributeId,GlobalAttributeDefaultValueId,AttributeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select PortalId,(select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'EnableInventoryStockNotification'),null,null,2,getdate(),2,getdate()
from ZnodePortal ZP
where not exists(select * from ZnodePortalGlobalAttributeValue ZPGA where ZP.PortalId = ZPGA.PortalId
      and ZPGA.GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'EnableInventoryStockNotification'))

insert into ZnodePortalGlobalAttributeValueLocale(PortalGlobalAttributeValueId,	LocaleId,	AttributeValue	,CreatedBy,	CreatedDate,	ModifiedBy	,ModifiedDate)
select PortalGlobalAttributeValueId,1,'true',2,getdate(),2,getdate()
from ZnodePortalGlobalAttributeValue ZPGA
where ZPGA.GlobalAttributeId = (select top 1 GlobalAttributeId from ZnodeGlobalAttribute where  AttributeCode = 'EnableInventoryStockNotification')
and not exists(select * from ZnodePortalGlobalAttributeValueLocale ZPGAVL where ZPGAVL.PortalGlobalAttributeValueId = ZPGA.PortalGlobalAttributeValueId
and LocaleId = 1)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertCartLineItemsForLater')
	DROP PROC Znode_InsertCartLineItemsForLater
GO

CREATE PROCEDURE [dbo].[Znode_InsertCartLineItemsForLater]
(
	@TemplateLineItemXML XML,
    @UserId              INT,
    @Status              BIT = 0 OUT
)
AS 
/* 
	Summary :- This Procedure is Used to create the Quote Template 
    Unit Testing 
    EXEC 
    SELECT * FROM ZnodeOmsTemplate
    SELECT * FROM ZnodeOmsTemplateLineItem
*/
    BEGIN
        BEGIN TRAN InsertUpdateSaveCartLineItem;
        BEGIN TRY
            SET NOCOUNT ON;
			DECLARE @OldQty INT, @SKU NVARCHAR(600), @GetDate DATETIME = dbo.Fn_GetDate();

            DECLARE @TBL_SavecartLineitems TABLE
            (
				RowId							INT IDENTITY(1, 1),
				OmsTemplateLineItemId           INT,
				ParentOmsTemplateLineItemId     INT,
				OmsTemplateId                   INT,
				SKU                             NVARCHAR(600),
				Quantity                        NUMERIC(28, 6),
				OrderLineItemRelationshipTypeID INT,
				CustomText                      NVARCHAR(MAX),
				CartAddOnDetails                NVARCHAR(MAX),
				[Sequence]                      INT,
				AddOnValueIds                   VARCHAR(MAX),
				BundleProductIds                VARCHAR(MAX),
				ConfigurableProductIds          VARCHAR(MAX),
				GroupProductIds                 VARCHAR(MAX)
            );

            DECLARE @OrderLineItemRelationshipTypeIdAddon INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'AddOns'
            );

            DECLARE @OrderLineItemRelationshipTypeIdBundle INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Bundles'
            );

            DECLARE @OrderLineItemRelationshipTypeIdConfigurable INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Configurable'
            );

            DECLARE @OrderLineItemRelationshipTypeIdGroup INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Group'
            );

            INSERT INTO @TBL_SavecartLineitems
            (
				OmsTemplateLineItemId,
				ParentOmsTemplateLineItemId,
				OmsTemplateId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails,
				[Sequence],
				AddOnValueIds,
				BundleProductIds,
				ConfigurableProductIds,
				GroupProductIds
            )
            SELECT Tbl.Col.value('OmsTemplateLineItemId[1]', 'NVARCHAR(2000)') AS OmsSavedCartLineItemId,
				Tbl.Col.value('ParentOmsTemplateLineItemId[1]', 'NVARCHAR(2000)') AS ParentOmsSavedCartLineItemId,
				Tbl.Col.value('OmsTemplateId[1]', 'NVARCHAR(2000)') AS OmsSavedCartId,
				Tbl.Col.value('SKU[1]', 'NVARCHAR(2000)') AS SKU,
				Tbl.Col.value('Quantity[1]', 'NVARCHAR(2000)') AS Quantity,
				Tbl.Col.value('OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)') AS OrderLineItemRelationshipTypeID,
				Tbl.Col.value('CustomText[1]', 'NVARCHAR(2000)') AS CustomText,
				Tbl.Col.value('CartAddOnDetails[1]', 'NVARCHAR(2000)') AS CartAddOnDetails,
				Tbl.Col.value('Sequence[1]', 'NVARCHAR(2000)') AS Sequence,
				Tbl.Col.value('AddonProducts[1]', 'NVARCHAR(2000)') AS AddOnValueIds,
				Tbl.Col.value('BundleProducts[1]', 'NVARCHAR(2000)') AS BundleProductIds,
				Tbl.Col.value('ConfigurableProducts[1]', 'NVARCHAR(2000)') AS ConfigurableProductIds,
				Tbl.Col.value('GroupProducts[1]', 'NVARCHAR(Max)') AS GroupProductIds
            FROM @TemplateLineItemXML.nodes('//ArrayOfAccountTemplateLineItemModel/AccountTemplateLineItemModel') AS Tbl(Col);
             
            DECLARE @OmsTemplateId INT, @OmsTemplateLineItemId INT;

            DECLARE @TBL_bundleAddonRows TABLE
            (
				RowId                           INT,
				SequenceId                      INT IDENTITY(1, 1),
				ParentOmsTemplateLineItemId     INT,
				SKU                             NVARCHAR(1000),
				Quantity                        NUMERIC(28, 6),
				OrderLineItemRelationshipTypeID INT,
				CustomText                      NVARCHAR(MAX),
				CartAddOnDetails                NVARCHAR(MAX)
            );

            DECLARE @AddonProductSKU NVARCHAR(MAX)=
            (
                SELECT TOP 1 AddOnValueIds
                FROM @TBL_SavecartLineitems
            ), @BundleProductSKU NVARCHAR(MAX)=
            (
                SELECT TOP 1 BundleProductIds
                FROM @TBL_SavecartLineitems
            );
            SET @OmsTemplateId =
            (
                SELECT TOP 1 OmsTemplateId
                FROM @TBL_SavecartLineitems
            );

            SET @SKU =
            (
                SELECT TOP 1 SKU
                FROM @TBL_SavecartLineitems
            );
            IF EXISTS
            (
                SELECT TOP 1 1
                FROM ZnodeOmsSavedCartLineItem AS qa
                WHERE EXISTS
                (
                    SELECT TOP 1 1
                    FROM @TBL_SavecartLineitems AS ssds
                    WHERE ssds.sku = qa.SKU
                )
            )
            BEGIN
				SELECT @OldQty = Quantity FROM ZnodeOmsTemplateLineItem
                WHERE OmsTemplateId = @OmsTemplateId AND SKU =@SKU;

                DELETE A 
				FROM ZnodeOmsTemplateLineItem A
                WHERE OmsTemplateId = @OmsTemplateId AND SKU =@SKU
					AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem 
									WHERE OmsTemplateId=A.OmsTemplateId AND ParentOmsTemplateLineItemId IS NOT NULL);
            END; 
			
            INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
            SELECT a.RowID,
                    NULL,
                    q.Item AS SKU,
                    a.Quantity,
                    @OrderLineItemRelationshipTypeIdAddon,
                    CustomText,
                    CartAddOnDetails
            FROM @TBL_SavecartLineitems AS a
            CROSS APPLY dbo.Split(a.AddOnValueIds, ',') AS q
            WHERE a.AddOnValueIds IS NOT NULL  AND a.AddOnValueIds <> '';  

            INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
			SELECT RowID,
				NULL,
				q.Item AS SKU,
				a.Quantity,
				@OrderLineItemRelationshipTypeIdBundle,
				CustomText,
				CartAddOnDetails
			FROM @TBL_SavecartLineitems AS a
			CROSS APPLY dbo.Split(a.BundleProductIds, ',') AS q
			WHERE a.BundleProductIds IS NOT NULL AND a.BundleProductIds <>'';
            
			INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
            SELECT RowID,
                NULL,
                q.Item AS SKU,
                a.Quantity,
                @OrderLineItemRelationshipTypeIdConfigurable,
                CustomText,
                CartAddOnDetails
            FROM @TBL_SavecartLineitems AS a
            CROSS APPLY dbo.Split(a.ConfigurableProductIds, ',') AS q
            WHERE a.ConfigurableProductIds IS NOT NULL AND a.ConfigurableProductIds <>'';
            
			INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
            SELECT RowID,
                NULL,
                SUBSTRING(q.Item, 1, CHARINDEX('~', q.Item)-1) AS SKU,
                SUBSTRING(q.Item, CHARINDEX('~', q.Item)+1, 4000) AS Quantity,
                @OrderLineItemRelationshipTypeIdGroup,
                CustomText,
                CartAddOnDetails
            FROM @TBL_SavecartLineitems AS a
            CROSS APPLY dbo.Split(a.GroupProductIds, ',') AS q
            WHERE a.GroupProductIds IS NOT NULL AND GroupProductIds <>''
			AND isnull(q.Item,'') <> ''; 

            DECLARE @Tbl_SAvecartIds TABLE
            (
				OmsTemplateLineItemId INT,
				RowId                 INT
            );
			 
			---Parent Product Update
			UPDATE TARGET
			SET TARGET.Quantity = SOURCE.Quantity,
				TARGET.ModifiedDate = @GetDate,
				TARGET.CreatedBy = @UserId 
			FROM ZnodeOmsTemplateLineItem TARGET
			INNER JOIN @TBL_SavecartLineitems SOURCE ON (TARGET.OmsTemplateId = SOURCE.OmsTemplateId
			AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)
			AND TARGET.SKU = SOURCE.SKU

			---Child Product Update
			UPDATE TARGET
			SET TARGET.Quantity = SCLI.Quantity,
				TARGET.ModifiedDate = @GetDate,
				TARGET.CreatedBy = @UserId 
			FROM ZnodeOmsTemplateLineItem TARGET
			INNER JOIN @TBL_SavecartLineitems SOURCE ON (TARGET.OmsTemplateId = SOURCE.OmsTemplateId
			    AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)
			INNER JOIN @TBL_bundleAddonRows SCLI ON Source.RowId = SCLI.RowId and TARGET.SKU = SCLI.SKU	
				
			INSERT INTO ZnodeOmsTemplateLineItem(ParentOmsTemplateLineItemId,OmsTemplateId,SKU,Quantity
				,OrderLineItemRelationshipTypeID,CustomText,CartAddOnDetails,[Sequence],CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
			SELECT NULL,@OmsTemplateId,Source.SKU,Source.Quantity,-- + ISNULL(@OldQty, 0),
				CASE
				WHEN Source.OrderLineItemRelationshipTypeID = 0
				THEN NULL
				ELSE Source.OrderLineItemRelationshipTypeID
				END,
				Source.CustomText,
				Source.CartAddOnDetails,
				1 --Source.Sequence
				,@UserId,@GetDate,@UserId,@GetDate
			FROM @TBL_SavecartLineitems Source
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem TARGET 
			WHERE TARGET.OmsTemplateId = Source.OmsTemplateId 
			AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)

			UPDATE @TBL_bundleAddonRows SET ParentOmsTemplateLineItemId=SCOPE_IDENTITY();

			INSERT INTO ZnodeOmsTemplateLineItem(ParentOmsTemplateLineItemId,OmsTemplateId,SKU,Quantity
				,OrderLineItemRelationshipTypeID, CustomText,CartAddOnDetails,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
			SELECT Source.ParentOmsTemplateLineItemId,@OmsTemplateId,Source.SKU,Source.Quantity,
				CASE
				WHEN Source.OrderLineItemRelationshipTypeID = 0
				THEN NULL
				ELSE Source.OrderLineItemRelationshipTypeID
				END,
				Source.CustomText,
				Source.CartAddOnDetails,
				Source.SequenceId+1
				,@UserId,@GetDate,@UserId,@GetDate
			FROM @TBL_bundleAddonRows Source
			--inner join @TBL_SavecartLineitems SCLI ON Source.RowId = SCLI.RowId
			--inner join ZnodeOmsTemplateLineItem ZOTLI ON ZOTLI.OmsTemplateId = @OmsTemplateId AND ZOTLI.ParentOmsTemplateLineItemId IS NULL AND ZOTLI.OrderLineItemRelationshipTypeID is null
			--AND SCLI.SKU = ZOTLI.SKU
			--WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem TARGET 
			--WHERE TARGET.OmsTemplateId = SCLI.OmsTemplateId 
			--AND TARGET.OmsTemplateLineItemId = SCLI.OmsTemplateLineItemId)
  			
            SET @Status = 1;
            COMMIT TRAN InsertUpdateSaveCartLineItem;
        END TRY
    BEGIN CATCH
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertCartLineItemsForLater @TemplateLineItemXML = '+CAST(@TemplateLineItemXML AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;
			
		ROLLBACK TRAN InsertUpdateSaveCartLineItem;

        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_InsertCartLineItemsForLater',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

UPDATE ZnodePimAttribute
SET IsSystemDefined = 1
WHERE AttributeCode='HideFromSearch' AND ISNULL(IsSystemDefined,0) = 0

UPDATE ZnodePimAttributeGroupMapper
SET IsSystemDefined = 1
WHERE PimAttributeId = (SELECT TOP 1 PimAttributeId FROM znodePimAttribute WHERE AttributeCode = 'HideFromSearch' AND IsSystemDefined = 1)
AND ISNULL(IsSystemDefined,0) = 0

UPDATE ZnodePimFamilyGroupMapper
SET IsSystemDefined = 1
WHERE PimAttributeId = (SELECT TOP 1 PimAttributeId FROM znodePimAttribute WHERE AttributeCode = 'HideFromSearch' AND IsSystemDefined = 1)
AND ISNULL(IsSystemDefined,0) = 0

INSERT INTO ZnodePimFamilyGroupMapper (PimAttributeFamilyId,PimAttributeGroupId,PimAttributeId,GroupDisplayOrder,IsSystemDefined
,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT PimAttributeFamilyId, (SELECT TOP 1 PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'ProductInfo'),
(SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideFromSearch'),500,1,2,GETDATE(),2,GETDATE()
FROM  ZnodePimAttributeFamily PAF
WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodePimFamilyGroupMapper PFG WHERE
PimAttributeId = (SELECT TOP 1 PimAttributeId FROM  ZnodePimAttribute WHERE AttributeCode = 'HideFromSearch')
AND PimAttributeGroupId = (SELECT TOP 1 PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode = 'ProductInfo')
AND PFG.PimAttributeFamilyId = PAF.PimAttributeFamilyId)
AND PAF.IsCategory = 0

GO

IF NOT EXISTS (SELECT TOP 1 1 FROM sys.tables WHERE Name = 'ZnodeStockNotice')
BEGIN
	CREATE TABLE [dbo].[ZnodeStockNotice](
	[StockNoticeId] [int] IDENTITY(1,1) NOT NULL,
	[ParentSKU] [varchar](255) NOT NULL,
	[SKU] [varchar](255) NOT NULL,
	[EmailId] [varchar](255) NOT NULL,
	[Quantity] [numeric](18, 0) NULL,
	[PortalId] [int] NOT NULL,
	[CatalogId] [int] NOT NULL,
	[IsEmailSent] [bit] NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreatedDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NOT NULL,
	[ModifiedDate] [datetime] NOT NULL,
	PRIMARY KEY CLUSTERED 
	(
		[StockNoticeId] ASC
	)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
	) ON [PRIMARY]
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteStockNotifications')
	DROP PROC Znode_DeleteStockNotifications
GO

Create PROCEDURE [dbo].[Znode_DeleteStockNotifications]
AS
BEGIN
	BEGIN TRY
	DECLARE @Status BIT;
	declare @DeleteSentEmail int , @DeletePendingEmails int

	select @DeleteSentEmail = (select Top 1  FeatureValues from ZnodeGlobalSetting where FeatureName = 'DeleteAlreadySentEmails')
	select @DeletePendingEmails = (select Top 1  FeatureValues from ZnodeGlobalSetting where FeatureName = 'DeletePendingEmails')

	IF OBJECT_ID('tempdb..#Tbl_StockNotice') IS NOT NULL
	DROP TABLE #Tbl_StockNotice

				Create TABLE #Tbl_StockNotice
				(
					  StockNoticeId  int,
					  EmailId    varchar(100),
					  DateDiffSent  int,
					  DateDiffPending int,
					  IsEmailSent bit
			    );

  insert into #Tbl_StockNotice(StockNoticeId, EmailId, DateDiffSent, DateDiffPending, IsEmailSent)
  select ZSN.StockNoticeId, ZSN.EmailId, (SELECT DATEDIFF(day,ZSN.ModifiedDate,  GETDATE())) as DateDiffSent ,
  (SELECT DATEDIFF(day, ZSN.CreatedDate, GETDATE() )) as DateDiffPending,ZSN.IsEmailSent  from ZnodeStockNotice ZSN

	
	DELETE FROM ZnodeStockNotice 
    WHERE StockNoticeId IN (SELECT StockNoticeId FROM #Tbl_StockNotice WHERE (IsEmailSent = 0 AND DateDiffPending > @DeletePendingEmails)
                   OR (IsEmailSent = 1 AND DateDiffSent > @deleteSentEmail))
		 
		 SET @Status = 1  
			  SELECT 1 AS ID,@Status AS Status; 
	
	END TRY

	BEGIN CATCH
		  SET @Status =0  
			  SELECT 1 AS ID,@Status AS Status; 
		select @Status
		DECLARE @Error_procedure VARCHAR(1000) = ERROR_PROCEDURE()
			,@ErrorMessage NVARCHAR(MAX) = ERROR_MESSAGE()
			,@ErrorLine VARCHAR(100) = ERROR_LINE()
			,@ErrorCall NVARCHAR(MAX) = 'EXEC Znode_DeleteStockNotifications';
		SELECT 0 AS ID
			,CAST(0 AS BIT) AS STATUS;
		EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_DeleteStockNotifications'
			,@ErrorInProcedure = ''
			,@ErrorMessage = @ErrorMessage
			,@ErrorLine = @ErrorLine
			,@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetRequestedInventory')
	DROP PROC Znode_GetRequestedInventory
GO

Create PROCEDURE [dbo].[Znode_GetRequestedInventory]
(
	@PortalId         INT
)
AS
BEGIN
	BEGIN TRY
		 DECLARE @SKU NVARCHAR(max) 
		 SELECT @SKU =  Substring((SELECT ',' + SKU  from ZnodeStockNotice where IsEmailSent = 0  FOR XML PAth('')), 2, 4000)	
		 		IF OBJECT_ID('tempdb..#Tbl_Inventory') IS NOT NULL
				DROP TABLE #Tbl_Inventory
				Create TABLE #Tbl_Inventory
				(
					  SKU            VARCHAR(300),
					  Quantity    NUMERIC(28, 6),
					  ReOrderLevel     NUMERIC(28, 6),
					  PortalId      int,
					  WarehouseName	varchar(100),
					  WarehouseCode	varchar(100),
					  DefaultInventoryCount varchar(1000),
			    );

				IF OBJECT_ID('tempdb..#Tbl_InStockProduct') IS NOT NULL
				DROP TABLE #Tbl_InStockProduct
				 		Create TABLE #Tbl_InStockProduct
				(
					  ParentSKU VARCHAR(300),
					  SKU            VARCHAR(300),
					  AvailableQuantity  NUMERIC(28, 6),
					  InStockQty NUMERIC(28, 6),
					  PublishProductId int,
				      ImageSmallPath varchar(500),
				      SeoUrl varchar(1000),
					  ProductName varchar(1000),
					  ProductAttributes nvarchar(MAX)
			    );

				IF OBJECT_ID('tempdb..#Tbl_PublishProduct') IS NOT NULL
				DROP TABLE #Tbl_PublishProduct
				Create TABLE #Tbl_PublishProduct
				(
				  SKU  VARCHAR(300),
				  PublishProductId int,
				  ImageSmallPath varchar(500),
				  SeoUrl varchar(1000),
				  ProductName varchar(1000),
				  ProductAttributes nvarchar(MAX)
				)

				insert into #Tbl_PublishProduct(SKU, PublishProductId, ImageSmallPath, SeoUrl, ProductName, ProductAttributes)
				select  distinct  ZPE.SKU, ZPE.ZnodeProductId, ZPE.ImageSmallPath, ZPE.SeoUrl, ZPE.Name, ZPE.Attributes  from ZnodeStockNotice  ZSN inner join  ZnodePublishVersionEntity ZPV on 
				ZPV.ZnodeCatalogId = ZSN.CatalogId 
				left join ZnodePublishProductEntity ZPE on ZPE.SKU = ZSN.SKU or ZPE.SKU = ZSN.ParentSKU 
				where ZPV.RevisionType = 'Production' and ZPV.VersionId = zpe.VersionId  and ZPE.IsActive = 1

			    insert into #Tbl_Inventory (SKU,	Quantity,	ReOrderLevel,	PortalId, WarehouseName, WarehouseCode, DefaultInventoryCount)
			    EXEC Znode_GetInventoryBySkus @SKUs=@SKU,@PortalId=@PortalId

				insert into #Tbl_InStockProduct(ParentSKU, SKU, AvailableQuantity, InStockQty, PublishProductId,
				ImageSmallPath, SeoUrl, ProductName, ProductAttributes)
				select ZSN.ParentSKU, ZSN.SKU, TBLI.Quantity, CASE WHEN TBLI.Quantity >= ZSN.Quantity THEN TBLI.Quantity  END, 
				(select top 1 PublishProductId from #Tbl_PublishProduct where SKU = ZSN.ParentSKU), PP.ImageSmallPath, (select top 1 SeoUrl from #Tbl_PublishProduct where SKU = ZSN.ParentSKU),
				PP.ProductName, PP.ProductAttributes
				from ZnodeStockNotice ZSN 
				inner join #Tbl_Inventory TBLI on ZSN.SKU = TBLI.SKU
				inner join #Tbl_PublishProduct PP on PP.SKU = ZSN.SKU
		
			   select distinct ZSN.SKU as ProductSKU,  ZSN.*,TSP. * from  ZnodeStockNotice ZSN inner join  #Tbl_InStockProduct TSP on ZSN.SKU = TSP.SKU where InStockQty is not null and ZSN.IsEmailSent = 0

	END TRY

	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000) = ERROR_PROCEDURE()
			,@ErrorMessage NVARCHAR(MAX) = ERROR_MESSAGE()
			,@ErrorLine VARCHAR(100) = ERROR_LINE()
			,@ErrorCall NVARCHAR(MAX) = 'EXEC Znode_GetRequestedInventory
			@PortalId = '+CAST(@PortalId AS int);
		SELECT 0 AS ID
			,CAST(0 AS BIT) AS STATUS;
		EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_GetRequestedInventory'
			,@ErrorInProcedure = ''
			,@ErrorMessage = @ErrorMessage
			,@ErrorLine = @ErrorLine
			,@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

INSERT INTO ZnodeEmailTemplate(TemplateName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'SendWaitingListNoticeInInventory',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeEmailTemplate WHERE TemplateName = 'SendWaitingListNoticeInInventory' )

INSERT INTO ZnodeEmailTemplateAreas(Name,Code,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'SendWaitingListNoticeInInventory','SendWaitingListNoticeInInventory',2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeEmailTemplateAreas WHERE name = 'SendWaitingListNoticeInInventory' )

INSERT INTO ZnodeEmailTemplateLocale(EmailTemplateId,Subject,Descriptions,Content,LocaleId,CreatedBy,
CreatedDate,ModifiedBy,ModifiedDate)
SELECT (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'SendWaitingListNoticeInInventory' ),
'Good News! Desired Product - #ProductName# is back in Inventory','This template is used for notifying customers that the desired items are now in stock',
'<div style="font-family: Arial, Helvetica; text-align: left; color: black; max-width: 1320px; margin: 0 auto;"><p style="padding: 0 1rem; margin: 10px 0px 0px; font-size: 14px; line-height: 1.714; letter-spacing: -0.005em; color: #172b4d;">Dear #EmailAddress#,<br /><br /><span id="docs-internal-guid-a8052d50-7fff-23a1-510e-5955f5c51fd8"><span style="font-size: 11pt; color: #000000; background-color: transparent; font-variant-numeric: normal; font-variant-east-asian: normal; vertical-align: baseline; white-space: pre-wrap;">We are excited to let you know that the desired product is back in stock</span></span></p><div style="width: 100%; padding: 0.5em; display: flex;"><div style="text-align: left; width: 30%; padding: 0.5em;">&nbsp; &nbsp;<a href="#ProductLink#"><img src="#Image#" /></a></div><div style="text-align: left; width: 70%; padding: 0.5em;"><p style="padding: 0 1rem; margin: 10px 0px 0px; font-size: 14px; line-height: 1.714; letter-spacing: -0.005em; color: #172b4d;">Product Name:&nbsp;<a href="#ProductLink#">#ProductName#</a></p><p style="padding: 0 1rem; margin: 10px 0px 0px; font-size: 14px; line-height: 1.714; letter-spacing: -0.005em; color: #172b4d;" >SKU: #SKU#</p><p style="padding: 0 1rem; margin: 10px 0px 0px; font-size: 14px; line-height: 1.714; letter-spacing: -0.005em; color: #172b4d;"></p></div></div><p style="padding: 0 1rem; margin: 10px 0px 0px; font-size: 14px; line-height: 1.714; letter-spacing: -0.005em; color: #172b4d;"><span style="background-color: transparent; font-size: 11pt; color: black;">&nbsp;Kindly, visit the <a href="#Url#">Web Store</a> or click on the <a href="#ProductLink#">link</a> to complete the order.<br /><br /></span><span style="font-size: 11pt; color: #000000; background-color: transparent; font-weight: 400; font-style: normal; font-variant: normal; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"> Thanks and Regards,<br /> #StoreName# Support</span></p></div>',
1,2,GETDATE(),2,GETDATE()
WHERE NOT EXISTS(SELECT * FROM ZnodeEmailTemplateLocale WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'SendWaitingListNoticeInInventory' )
AND LocaleId = 1 )

INSERT INTO ZnodeEmailTemplateMapper(EmailTemplateId,PortalId,EmailTemplateAreasId,IsActive,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,IsEnableBcc)
SELECT (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'SendWaitingListNoticeInInventory' ), PortalId,
(SELECT TOP 1 EmailTemplateAreasId FROM ZnodeEmailTemplateAreas WHERE Name = 'SendWaitingListNoticeInInventory'),1,2,GETDATE(),2,GETDATE(),0
FROM ZnodePortal zp
WHERE NOT EXISTS(SELECT * FROM ZnodeEmailTemplateMapper ZETM WHERE ZETM.EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName = 'SendWaitingListNoticeInInventory' )
	AND ZETM.PortalId = zp.PortalId AND EmailTemplateAreasId = (SELECT TOP 1 EmailTemplateAreasId FROM ZnodeEmailTemplateAreas WHERE Name = 'SendWaitingListNoticeInInventory'))

GO

INSERT INTO znodeglobalsetting (FeatureName,FeatureValues,FeatureSubValues,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'DeleteAlreadySentEmails','5',NULL,2, GETDATE(),2 , GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM znodeglobalsetting WHERE FeatureName = 'DeleteAlreadySentEmails')
GO

INSERT INTO znodeglobalsetting (FeatureName,FeatureValues,FeatureSubValues,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT 'DeletePendingEmails','90',NULL,2, GETDATE(),2 , GETDATE()
WHERE NOT EXISTS (SELECT TOP 1 1 FROM znodeglobalsetting WHERE FeatureName = 'DeletePendingEmails')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSetting')
	DROP PROC Znode_GetPaymentSetting
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSetting]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSetting @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT
										,PaymentDisplayName nvarchar(1200),PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50),IsUsedForWebStorePayment BIT)


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSetting @PortalIds,@ProfileIds,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId,ZPPS.IsUsedForWebStorePayment, ZPPOS.DisplayName PublishState 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 )

				 '
	 IF @userId <> 0 
	 BEGIN 
		SET @IsAssociated = 1  	
	 END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50))
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, 0 as IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId,ZPPS.IsUsedForWebStorePayment
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))
	   SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, 0 IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId,ZPPS.IsUsedForWebStorePayment
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo ,IsUsedForWebStorePayment

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowId ,CountNo,IsUsedForWebStorePayment
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowID,CountNo,IsUsedForWebStorePayment)
	 EXEC (@SQL)

	 IF @IsAssociated = 1 
	 BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,isnull(IsUsedForWebStorePayment,0) as IsUsedForWebStorePayment  
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForWebStorePayment,0) = 1
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE  ISNULL(IsUsedForWebStorePayment,0) = 1),0)
	END
	ELSE 
	BEGIN
	
		SELECT PaymentSettingId,PaymentApplicationSettingId,PS.PaymentTypeId,PaymentGatewayId,PaymentName,PS.IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,PS.CreatedBy,PS.CreatedDate,PS.ModifiedBy,PS.ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, 
							PaymentCode, GatewayCode,PS.IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,ISNULL(PS.IsUsedForWebStorePayment,0)IsUsedForWebStorePayment
		 FROM @TBL_PaymentSetting PS
		 WHERE (ISNULL(IsUsedForWebStorePayment,0) = 0)	
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE (ISNULL(IsUsedForWebStorePayment,0) = 0)),0)
	END

  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSetting @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSetting',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
  END CATCH
 END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingForOfflinePayment')
	DROP PROC Znode_GetPaymentSettingForOfflinePayment
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingForOfflinePayment]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT
										,PaymentDisplayName nvarchar(1200),PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50), IsUsedForOfflinePayment BIT,Code VARCHAR(100))


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSetting @PortalIds,@ProfileIds,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 )

				 '
	 IF @userId <> 0 
	 BEGIN 
		SET @IsAssociated = 1  	
	 END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50)) 
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName,0 as IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))
	   SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, 0 IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment ,ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo,IsUsedForOfflinePayment, Code

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowId ,CountNo, IsUsedForOfflinePayment, Code
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowID,CountNo,IsUsedForOfflinePayment,Code)
	 EXEC (@SQL)

	 IF @IsAssociated = 1 
	 BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,isnull(IsUsedForOfflinePayment,0) as IsUsedForOfflinePayment  
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForOfflinePayment,0) = 1
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE  ISNULL(IsUsedForOfflinePayment,0) = 1),0)
	END
	ELSE 
	BEGIN
	
		SELECT PaymentSettingId,PaymentApplicationSettingId,PS.PaymentTypeId,PaymentGatewayId,PaymentName,PS.IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,PS.CreatedBy,PS.CreatedDate,PS.ModifiedBy,PS.ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, 
							PaymentCode, GatewayCode,PS.IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,ISNULL(PS.IsUsedForOfflinePayment,0)IsUsedForOfflinePayment
		 FROM @TBL_PaymentSetting PS
		 WHERE (Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')	AND ISNULL(IsUsedForOfflinePayment,0) = 0)	
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE (Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')	AND ISNULL(IsUsedForOfflinePayment,0) = 0)),0)
	END

  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSettingForOfflinePayment',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
  END CATCH
END

GO

update ZnodeApplicationSetting 
set Setting='<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>PaymentSettingId</name>      <headertext>Checkbox</headertext>      <width>40</width>      <datatype>Int32</datatype>      <columntype>Int32</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>PaymentSettingId</islinkparamfield>      <ischeckbox>y</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>ID</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>n</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>PaymentCode</name>      <headertext>Payment Code</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>PaymentTypeId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>PaymentTypeId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Payment Option</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>PaymentDisplayName</name>      <headertext>Payment Display Name</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>100</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>PaymentTypeId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>PaymentTypeId</checkboxparamfield>      <iscontrol>y</iscontrol>      <controltype>Text</controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Payment Option</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>GatewayName</name>      <headertext>Payment Gateway</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>PaymentGatewayId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>PaymentGatewayId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Payment Gateway</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>IsActive</name>      <headertext>Enable</headertext>      <width>40</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>IsActive</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>IsActive</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Enable</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>DisplayOrder</name>      <headertext>Display Order</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>false</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>DisplayOrder</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>DisplayOrder</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Display Order</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>PublishState</name>      <headertext>Application Type</headertext>      <width>40</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>y</iscontrol>      <controltype>DropDown</controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>IsApprovalRequired</name>      <headertext>Is Approval Required</headertext>      <width>40</width>      <datatype>Boolean</datatype>      <columntype>Boolean</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>n</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>IsApprovalRequired</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>IsApprovalRequired</checkboxparamfield>      <iscontrol>y</iscontrol>      <controltype>DropDown</controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>9</id>      <name>Manage</name>      <headertext>Action</headertext>      <width>50</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>Edit|Delete</format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>y</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>y</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>PaymentSettingId</islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>PaymentSettingId</checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>Edit|Delete</displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>/Store/UpdatePortalPaymentSettings|/Store/RemoveAssociatedPaymentSetting</manageactionurl>      <manageparamfield>PaymentSettingId,PortalId|PaymentSettingId,PortalId,IsUsedForOfflinePayment</manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName='AssociatedPaymentListToPortal'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSetting')
	DROP PROC Znode_GetPaymentSetting
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSetting]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSetting @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),
										PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT,PaymentDisplayName nvarchar(1200),
										PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),
										IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50),IsUsedForWebStorePayment BIT )


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSetting @PortalIds,@ProfileIds,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, CASE WHEN ZPPS.PortalPaymentId IS NULL THEN 0 ELSE 1 END IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState , ZPPS.IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 )

				 '
	 IF @userId <> 0 
	 BEGIN 
		SET @IsAssociated = 1  	
	 END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50))+'
								AND  IsAssociated = '+CAST(@IsAssociated AS VARCHAR(50))+CASE WHEN @FilterWhereClause = '' THEN ' ' ELSE @FilterWhereClause END 
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, CASE WHEN ZPPS.ProfilePaymentSettingId IS NULL THEN 0 ELSE 1 END IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState , 0 AS IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))+'
									AND  IsAssociated = '+CAST(@IsAssociated AS VARCHAR(50))+CASE WHEN @FilterWhereClause = '' THEN ' ' ELSE @FilterWhereClause END 
	  SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, NULL IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState , 0 AS IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment,RowId ,CountNo
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,
						IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,
						PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment,RowID,CountNo)
	 EXEC (@SQL)

	 
	  
	IF @IsAssociated = 1 AND @ProfileId = 0
	BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
		 FROM @TBL_PaymentSetting
		 WHERE IsUsedForWebStorePayment = 1
		 ORDER BY RowID,DisplayOrder
		 SET @RowsCount = ISNULL((SELECT  COUNT(*) FROM @TBL_PaymentSetting WHERE IsUsedForWebStorePayment = 1),0)
	END
	ELSE
	BEGIN
		SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
		 FROM @TBL_PaymentSetting
		 ORDER BY RowID,DisplayOrder
		 SET @RowsCount = ISNULL((SELECT COUNT(*) CountNo FROM @TBL_PaymentSetting),0)
	END


  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSetting @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSetting',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
  END CATCH
 END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertSaveCartLineItemsForReOrder')
	DROP PROC Znode_InsertSaveCartLineItemsForReOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertSaveCartLineItemsForReOrder] 
(
	@OmsOrderId INT, 
	@OmsSavedCartId INT ,
	@UserId INT ,
	@OmsOrderLineItemsId INT = 0,
	@Status BIT = 0 OUT
)
AS 
BEGIN 
BEGIN TRY 
  SET NOCOUNT ON 
  DECLARE @TBL_ZnodeOmsSavedCartLineItem TABLE (OmsSavedCartLineItemId INT , RowId INT  )
  DECLARE @GetDate DATETIME = dbo.FN_getDate() 
  DECLARE @AddOnOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Addons')

   DECLARE @BundleOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Bundles')

   DECLARE @GroupOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Group')

   DECLARE @OmsOrderStateId_RETURNED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'RETURNED')
   DECLARE @OmsOrderStateId_CANCELED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'CANCELED')

   CREATE TABLE #ZnodeOmsOrderLineItems_temp (OmsOrderLineItemsId INT ,ParentOmsOrderLineItemsId INT,OmsOrderDetailsId INT , SKU  NVARCHAr(2000),
   OrderLineItemRelationshipTypeID INT ,AutoAddonSKU NVARCHAR(400),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),Custom4 NVARCHAR(MAX)
   ,Custom5 NVARCHAR(MAX), GroupId nvarchar(MAX),ProductName NVARCHAr(2000), Description nvarchar(MAX),Quantity NUMERIC(28,6), ROWID INT, ParentRowID INT)

  IF EXISTS (SELECT TOP 1 OmsOrderDetailsId  FROM ZnodeOmsOrderDetails WHERE  OmsOrderId =  @OmsOrderId AND IsActive =1 )
  BEGIN 

	  ;WITH CTE_OrderData AS
	  (
		  SELECT MIN(ZOOLI.OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ZOOLI.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			  ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4,
			  ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description,SUM(ZOOLI.Quantity) AS Quantity
		  FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		  INNER JOIN ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) ON ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId
		  WHERE  ZOOD.OmsOrderId =  @OmsOrderId AND ZOOD.IsActive =1 
		  AND CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 0 ELSE  ZOOLI.OrderLineItemStateId END  <> CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 1 ELSE  @OmsOrderStateId_RETURNED END 
		  GROUP BY ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4, ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description
	  )
	  INSERT INTO #ZnodeOmsOrderLineItems_temp
	  SELECT *
		,Row_number()Over(Order By OmsOrderLineItemsId )  RowId, NULL ParentRowId
	  FROM CTE_OrderData
	  ORDER BY OmsOrderLineItemsId 
  END

  ELSE 
  BEGIN
		;WITH CTE_OrderData AS
		  (
			  SELECT MIN(OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
				  ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				  ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
				  ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
			  FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
			  WHERE ( ZOO.OmsOrderLineItemsId = @OmsOrderLineItemsId OR ZOO.ParentOmsOrderLineItemsId = @OmsOrderLineItemsId ) 
			  AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE ZOO.OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
			  GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4, ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description
		 )
		 INSERT INTO #ZnodeOmsOrderLineItems_temp
		 SELECT *,Row_number()Over(Order By OmsOrderLineItemsId )   RowId, NULL ParentRowId
		 FROM CTE_OrderData

		INSERT INTO #ZnodeOmsOrderLineItems_temp 
		SELECT MIN(ZOO.OmsOrderLineItemsId) AS OmsOrderLineItemsId,MIN(ZOO.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
		ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
		ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
		ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
		,0 RowId, NULL ParentRowId
		FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
		WHERE ZOO.OmsOrderLineItemsId = (SELECT TOP 1 ParentOmsOrderLineItemsId FROM #ZnodeOmsOrderLineItems_temp TY WHERE TY.ParentOmsOrderLineItemsId IS NOT NULL 
		AND TY.OrderLineItemRelationshipTypeID <> @AddOnOrderLineItemRelationshipTypeId )
		AND ZOO.ParentOmsOrderLineItemsId  IS NULL
		AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
		AND NOT EXISTS(SELECT * FROM #ZnodeOmsOrderLineItems_temp tem WHERE tem.OmsOrderLineItemsId = ZOO.OmsOrderLineItemsId )
		GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
			ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description;

  END

     DECLARE @TBL_OmsSavedCartOld TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 DECLARE @TBL_OmsSavedCartNew TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 
	 SELECT SKU , OmsOrderLineItemsId, ParentOmsOrderLineItemsId, OrderLineItemRelationshipTypeID,Quantity 
	 INTO #ZnodeOmsSavedCartLineItemOld
	 FROM #ZnodeOmsOrderLineItems_temp a 

	 SELECT OmsOrderLineItemsId, PersonalizeCode, PersonalizeValue  
	 INTO #ZnodeOmsPersonalizeCartItemOld
	 FROM ZnodeOmsPersonalizeItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp t WHERE t.OmsOrderLineItemsId = a.OmsOrderLineItemsId)

	 SELECT SKU , OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeID, Quantity
	 INTO #ZnodeOmsSavedCartLineItemNew
	 FROM ZnodeOmsSavedCartLineItem a WITH (NOLOCK)
	 WHERE OmsSavedCartId = @OmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue   
	 INTO #ZnodeOmsPersonalizeCartItemNew
	 FROM ZnodeOmsPersonalizeCartItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 INSERT INTO @TBL_OmsSavedCartOld (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	 SELECT SKU , OmsOrderLineItemsId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemOld TBL_B WHERE TBL_B.OmsOrderLineItemsId = ISNULL(TBL_A.ParentOmsOrderLineItemsId,0)  ) ParentSKU
				, ParentOmsOrderLineItemsId
	 FROM #ZnodeOmsSavedCartLineItemOld TBL_A
	 WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId

	 ;With Cte_UpdateOld AS 
	 (
		SELECT ParentOmsOrderLineItemsId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsOrderLineItemsId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemOld a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN Cte_UpdateOld TBL_ON ON (TBL_ON.ParentOmsOrderLineItemsId  = TBL_O.OmsSavedCartLineItemId )

	  INSERT INTO @TBL_OmsSavedCartNew (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	  SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemNew TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL( TBL_A.ParentOmsSavedCartLineItemId,0)   ) ParentSKU
				, ParentOmsSavedCartLineItemId
	  FROM #ZnodeOmsSavedCartLineItemNew TBL_A
	  WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	 ;With Cte_UpdateNew AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )	 
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN Cte_UpdateNew TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000) 
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000)  
	  FROM @TBL_OmsSavedCartNew TBL_O 
	

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000)
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000) 
	  FROM @TBL_OmsSavedCartOld TBL_O 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartOld a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartNew a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	 UPDATE a 
	 SET  a.Quantity =  a.Quantity+d.Quantity 
	 FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId)

	 ;WITH CTE_UpdateOrder 
	 AS 
	 (
	   SELECT Sequence,  ROW_NUMBER()Over(order BY OmsSavedCartLineItemId ASC) RowId
	   FROM ZnodeOmsSavedCartLineItem WITH (NOLOCK)
	   WHERE  OmsSavedCartId = @OmsSavedCartId
	 
	 ) 
	 UPDATE CTE_UpdateOrder 
	 SET Sequence =RowId

		DECLARE @DeletedId TABLE (OmsSavedCartLineItemId INT )

	
		DELETE  FROM #ZnodeOmsOrderLineItems_temp OUTPUT DELETED.OmsOrderLineItemsId INTO @DeletedId WHERE OmsOrderLineItemsId IN (SELECT c.OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
		INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId))


		DELETE FROM #ZnodeOmsOrderLineItems_temp WHERE ParentOmsOrderLineItemsId IN (SELECT OmsSavedCartLineItemId FROM @DeletedId)

		DELETE TR FROM #ZnodeOmsOrderLineItems_temp TR 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp YU WHERE TR.OmsOrderLineItemsId = YU.ParentOmsOrderLineItemsId  ) 
		AND TR.ParentOmsOrderLineItemsId IS NULL 

		UPDATE #ZnodeOmsOrderLineItems_temp 
		SET ParentRowId = (SELECT TOP 1 RowId FROM #ZnodeOmsOrderLineItems_temp a WHERE a.OmsOrderLineItemsId = #ZnodeOmsOrderLineItems_temp.ParentOmsOrderLineItemsId ) 
	BEGIN TRANSACTION ReorderSaveCart
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails
											,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description)
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.Sequence  INTO @TBL_ZnodeOmsSavedCartLineItem
		SELECT NULL,@OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,NULL CustomText, NULL CartAddOnDetails
											,RowId,@UserId,@GetDate,@UserId,@GetDate,AutoAddonSKU,NULL OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description
		FROM #ZnodeOmsOrderLineItems_temp 
		ORDER BY OmsOrderLineItemsId 

		UPDATE #ZnodeOmsOrderLineItems_temp 
		SET ParentRowID = (SELECT TOP 1 ROWID FROM #ZnodeOmsOrderLineItems_temp WHERE OrderLineItemRelationshipTypeID IS NULL)
		where OrderLineItemRelationshipTypeID IS NOT NULL

		UPDATE ab 
		SET ab.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_ZnodeOmsSavedCartLineItem av WHERE av.RowId = b.ParentRowId   )
		FROM ZnodeOmsSavedCartLineItem ab 
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem a ON (a.OmsSavedCartLineItemId = ab.OmsSavedCartLineItemId ) 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON  (b.RowId = a.RowId  ) 

		INSERT INTO ZnodeOmsPersonalizeCartItem (OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
		SELECT c.OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,@UserId,@GetDate,@UserId,@GetDate,DesignId,ThumbnailURL
		FROM ZnodeOmsPersonalizeItem  a 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON (a.OmsOrderLineItemsId = b.OmsOrderLineItemsId)
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem c ON (c.RowId = b.RowId )

		UPDATE ZOSCLI1 set Quantity = null
		from ZnodeOmsSavedCartLineItem ZOSCLI1
		where ParentOmsSavedCartLineItemId is null and OmsSavedCartId = @OmsSavedCartId
		and Quantity is not null
		and not exists(select * from ZnodeOmsSavedCartLineItem ZOSCLI where OrderLineItemRelationshipTypeId IN (@BundleOrderLineItemRelationshipTypeId,@GroupOrderLineItemRelationshipTypeId ) and ZOSCLI1.OmsSavedCartLineItemId = ZOSCLI.ParentOmsSavedCartLineItemId )
		
		--Update Qty for Parentlineitem except simple product
		UPDATE ZOSCLI
		SET Quantity = ZOSCLI.Quantity+Old.Quantity
		FROM ZnodeOmsSavedCartLineItem ZOSCLI
		INNER JOIN #ZnodeOmsSavedCartLineItemNew New ON (ZOSCLI.OmsSavedCartLineItemId = New.OmsSavedCartLineItemId)
		INNER JOIN #ZnodeOmsSavedCartLineItemOld Old ON (New.SKU = Old.SKU)
		WHERE ZOSCLI.ParentOmsSavedCartLineItemId IS NULL AND OmsSavedCartId = @OmsSavedCartId AND ZOSCLI.Quantity IS NOT NULL
			--AND EXISTS(SELECT * FROM ZnodeOmsSavedCartLineItem ZOSCLI WHERE OrderLineItemRelationshipTypeId=@BundleOrderLineItemRelationshipTypeId)

		UPDATE ZnodeOmsSavedCart
		SET ModifiedDate = GETDATE()
		WHERE OmsSavedCartId = @OmsSavedCartId
	COMMIT TRANSACTION ReorderSaveCart
	SET @status = 1 
   
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION ReorderSaveCart
		SELECT ERROR_MESSAGE()
		SET @status = 0 

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertSaveCartLineItemsForReOrder @OmsOrderId = '+CAST(@OmsOrderId AS VARCHAR(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@OmsSavedCartId='+CAST(@OmsSavedCartId AS VARCHAR(50))+',@OmsOrderLineItemsId='+CAST(@OmsOrderLineItemsId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_InsertSaveCartLineItemsForReOrder',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSetting')
	DROP PROC Znode_GetPaymentSetting
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSetting]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSetting @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),
										PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT,PaymentDisplayName nvarchar(1200),
										PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),
										IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50),IsUsedForWebStorePayment BIT )


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSetting @PortalIds,@ProfileIds,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState , ZPPS.IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 )

				 '
	 IF @userId <> 0 
	 BEGIN 
		SET @IsAssociated = 1  	
	 END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50))
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, CASE WHEN ZPPS.ProfilePaymentSettingId IS NULL THEN 0 ELSE 1 END IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState , 0 AS IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))+'
									AND  IsAssociated = '+CAST(@IsAssociated AS VARCHAR(50))+CASE WHEN @FilterWhereClause = '' THEN ' ' ELSE @FilterWhereClause END 
	  SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, NULL IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState , 0 AS IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment,RowId ,CountNo
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,
						IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,
						PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment,RowID,CountNo)
	 EXEC (@SQL)

	 
	  
	IF @IsAssociated = 1 AND @ProfileId = 0
	BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
		 FROM @TBL_PaymentSetting
		 WHERE IsUsedForWebStorePayment = 1
		 ORDER BY RowID,DisplayOrder
		 SET @RowsCount = ISNULL((SELECT Count(*) FROM @TBL_PaymentSetting WHERE IsUsedForWebStorePayment = 1),0)
	END
	ELSE
	BEGIN
		SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
		 FROM @TBL_PaymentSetting
		 WHERE IsUsedForWebStorePayment = 0
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT Count(*) FROM @TBL_PaymentSetting WHERE IsUsedForWebStorePayment = 0),0)
	END


  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSetting @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSetting',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
  END CATCH
 END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingForOfflinePayment')
	DROP PROC Znode_GetPaymentSettingForOfflinePayment
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingForOfflinePayment]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT
										,PaymentDisplayName nvarchar(1200),PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50), IsUsedForOfflinePayment BIT,Code VARCHAR(100))


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSetting @PortalIds,0,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 )

				 '
	 IF @userId <> 0 
	 BEGIN 
		SET @IsAssociated = 1  	
	 END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50)) 
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName,0 as IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))
	   SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, 0 IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment ,ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo,IsUsedForOfflinePayment, Code

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowId ,CountNo, IsUsedForOfflinePayment, Code
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowID,CountNo,IsUsedForOfflinePayment,Code)
	 EXEC (@SQL)

	 IF @IsAssociated = 1 
	 BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,isnull(IsUsedForOfflinePayment,0) as IsUsedForOfflinePayment  
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForOfflinePayment,0) = 1
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE  ISNULL(IsUsedForOfflinePayment,0) = 1),0)
	END
	ELSE 
	BEGIN
	
		SELECT PaymentSettingId,PaymentApplicationSettingId,PS.PaymentTypeId,PaymentGatewayId,PaymentName,PS.IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,PS.CreatedBy,PS.CreatedDate,PS.ModifiedBy,PS.ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, 
							PaymentCode, GatewayCode,PS.IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,ISNULL(PS.IsUsedForOfflinePayment,0)IsUsedForOfflinePayment
		 FROM @TBL_PaymentSetting PS
		 WHERE (Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')	AND ISNULL(IsUsedForOfflinePayment,0) = 0)	
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE (Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')	AND ISNULL(IsUsedForOfflinePayment,0) = 0)),0)
	END

  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSettingForOfflinePayment',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
  END CATCH
 END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetSeoBySku')
	DROP PROC Znode_GetSeoBySku
GO

CREATE PROCEDURE [dbo].[Znode_GetSeoBySku]
(
        @Skus varchar(max),
        @PortalId int,
        @Status BIT = 0 OUT
)
AS
BEGIN
BEGIN TRY
        SET NOCOUNT ON;
        IF OBJECT_ID('tempdb..#Skus') IS NOT NULL

        DROP TABLE #Skus
        SELECT Item INTO #Skus from dbo.Split(@Skus,',')

        SELECT SEOUrl as SeoUrl,SEOCode as SKU 
        FROM ZnodeCMSSeoDetail D
        WHERE PortalId=@PortalId 
        AND EXISTS(select * from #Skus S WHERE D.SEOCode = S.Item)

        SET @Status=1;
END TRY
BEGIN CATCH
set @Status=0;
SELECT ERROR_MESSAGE()
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_UpdateInventoryPostOrder')
	DROP PROC Znode_UpdateInventoryPostOrder
GO

CREATE PROCEDURE [dbo].[Znode_UpdateInventoryPostOrder]
(
	@SkuXml xml,
	@PortalId int, 
	@UserId int, 
	@Status bit OUT, 
	@OmsOrderId INT,
	@IsDebug bit= 0
)
AS 
	/*
	Summary: (13671)   Inventory will be updated on the basis of "InventoryTracking" (Attribute Code) value in locale table 
				    If value id "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
				    If "AllowBackordering" then inventory will become negative
				    If "DontTrackInventory" then don't update inventory.
				    inventory will be get deducted from associated warehouse where quantity is available as per warehouse precedence. 
				    Validate total quantity 
	Input Parameters:
	SKU(Comma separated multiple), PortalId
	Unit Testing   
		Declare @Status bit 
		Exec Znode_UpdateInventory  @SkuXml = '<ArrayOfOrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>418</OrderLineItemId>
		<SKU>ap1534</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		<OrderWarehouseLineItemsModel>
		<OrderLineItemId>419</OrderLineItemId>
		<SKU>al8907</SKU>
		<InventoryTracking>DisablePurchasing</InventoryTracking>
		<Quantity>1.000000</Quantity>
		</OrderWarehouseLineItemsModel>
		</ArrayOfOrderWarehouseLineItemsModel>',@PortalId = 1,@UserId = 2,@Status = @Status

	*/
BEGIN
	BEGIN TRAN UpdateInventory;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @RoundOffValue INT= dbo.Fn_GetDefaultValue('InventoryRoundOff');
		DECLARE @TBL_XmlReturnToTable TABLE
		( 
			OrderLineItemId int, SKU nvarchar(max), InventoryTracking nvarchar(1000), Quantity numeric(28, 6),
			AllowBackOrder VARCHAR(100), SequenceNo int IDENTITY, OrderLineItemRelationshipTypeId int 
		);
		DECLARE @TBL_ErrorInventoryTracking TABLE
		( 
			SKU nvarchar(max), Quantity numeric(28, 6), InventoryTracking nvarchar(2000), AllowBackOrder varchar(100)
		);
		INSERT INTO @TBL_XmlReturnToTable( OrderLineItemId, SKU, InventoryTracking, Quantity,AllowBackOrder )
		SELECT Tbl.Col.value( 'OrderLineItemId[1]', 'INT' ) AS OrderLineItemId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) AS InventoryTracking, Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) AS Quantity
		, Tbl.Col.value( 'AllowBackOrder[1]', 'VARCHAR(100)' ) AS AllowBackOrder
		FROM @SkuXml.nodes( '//ArrayOfOrderWarehouseLineItemsModel/OrderWarehouseLineItemsModel' ) AS Tbl(Col)
		WHERE Tbl.Col.value( 'InventoryTracking[1]', 'NVARCHAR(2000)' ) <> 'DontTrackInventory' 
		AND Tbl.Col.value( 'Quantity[1]', 'Numeric(28,6)' ) > 0;

		DECLARE @Cur_WarehouseId int, @Cur_PortalId int, @Cur_PortalWarehouseId int, @Cur_WarehouseSequence int, @Cur_SKU varchar(200), @Cur_Quantity numeric(28, 6), @Cur_ReOrderLevel numeric(28, 6), @Cur_InventoryId int;

		DECLARE @RecurringQuantity numeric(28, 6), @BalanceQuantity numeric(28, 6)
		SET @Status = 0; 

		---Updating order line item
		UPDATE TBL SET OrderLineItemId = ZOOLI.OmsOrderLineItemsId, TBL.OrderLineItemRelationshipTypeId = ZOOLI.OrderLineItemRelationshipTypeId 
		FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		INNER JOIN @TBL_XmlReturnToTable TBL ON ZOOLI.Sku = TBL.SKU
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) WHERE ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId AND ZOOD.OmsOrderId = @OmsOrderId)
		AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL

		DECLARE @TBL_CalculateQuntity TABLE
		( 
			WarehouseId int, SKU varchar(200), MainQuantity numeric(28, 6), InventoryId int, OrderQuantity numeric(28, 6), UpdatedQuantity numeric(28, 6), WarehouseSequenceId int, InventoryTracking nvarchar(2000)
			, AllowBackOrder varchar(100)
		);
		
		DECLARE @TBL_AllwareHouseToportal TABLE
		( 
			WarehouseId int, PortalId int, PortalWarehouseId int, WarehouseSequenceFirst int, WarehouseSequence int, SKU varchar(200), Quantity numeric(28, 6), ReOrderLevel numeric(28, 6), InventoryId int
		);
		
		SELECT WarehouseId, PortalId, PortalWarehouseId, Precedence
		INTO #PortalWarehouse
		FROM [ZnodePortalWarehouse] WITH (NOLOCK)
		WHERE PortalId = @PortalId
		UNION 
		SELECT WarehouseId, @PortalId AS PortalId, PortalWarehouseId, Precedence
		FROM [dbo].[ZnodePortalAlternateWarehouse] AS zpaw WITH (NOLOCK)
		WHERE EXISTS ( SELECT TOP 1 1 FROM [ZnodePortalWarehouse] AS a WHERE zpaw.PortalWarehouseId = a.PortalWarehouseId AND  a.PortalId = @PortalId)  
		
		INSERT INTO @TBL_AllwareHouseToportal( WarehouseId, PortalId, PortalWarehouseId, SKU, Quantity, ReOrderLevel, InventoryId, WarehouseSequence, WarehouseSequenceFirst )
		SELECT ZPW.WarehouseId, ZPW.PortalId, zpw.PortalWarehouseId, zi.SKU, zi.Quantity, zi.ReOrderLevel, zi.InventoryId, DENSE_RANK() OVER(ORDER BY ZPW.WarehouseId), 1
		FROM dbo.ZnodeInventory AS zi WITH (NOLOCK)
		LEFT JOIN #PortalWarehouse AS ZPW ON ZPW.WarehouseId = ZI.WareHouseId AND  ZPW.PortalId = @PortalId
		WHERE EXISTS ( SELECT TOP 1 1  FROM @TBL_XmlReturnToTable AS TBXRT WHERE RTRIM(LTRIM(TBXRT.SKU)) = RTRIM(LTRIM(zi.SKU))) 
		AND ZPW.WarehouseId IS NOT NULL
		ORDER BY ZPW.Precedence DESC

		--Total Avaialble qunatity in all warehouse 
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			INSERT INTO @TBL_ErrorInventoryTracking 
			SELECT TBAHL.SKU, SUM(TBAHL.Quantity), InventoryTracking,TBXML.AllowBackOrder 
			FROM @TBL_XmlReturnToTable AS TBXML
			LEFT JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU) 
			INNER JOIN ZnodeOmsOrderLineItems b on (TBXML.orderlineitemid = b.OmsOrderLineItemsId)
			WHERE InventoryTracking = 'DisablePurchasing'
			AND b.OrderLineItemRelationshipTypeId IS NOT NULL
			GROUP BY TBXML.AllowBackOrder ,TBAHL.SKU, InventoryTracking HAVING SUM(TBAHL.Quantity) < 1 ORDER BY TBAHL.SKU;
			IF EXISTS ( SELECT TOP 1 1 FROM @TBL_ErrorInventoryTracking )
			BEGIN
				SET @Status = 0;
				RAISERROR(15600, -1, -1, 'DisablePurchasing');
			END;
		END;

		---Getting data for simple , configurable and bundle
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems ZOOLI WHERE TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId
			AND ZOOLI.ParentOmsOrderLineItemsId IS NOT NULL) 
		AND isnull(TBXML.OrderLineItemRelationshipTypeId,0) not in (SELECT OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType WHERE Name IN ('Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		---Getting data for group products
		INSERT INTO @TBL_CalculateQuntity
		SELECT WarehouseId, TBXML.SKU, TBAHL.Quantity, TBAHL.InventoryId, TBXML.Quantity, NULL AS UpdatedQuantity, DENSE_RANK() 
		OVER(ORDER BY WarehouseSequenceFirst,WarehouseSequence), InventoryTracking, TBXML.AllowBackOrder
		FROM @TBL_XmlReturnToTable AS TBXML	
		INNER  JOIN @TBL_AllwareHouseToportal AS TBAHL ON(TBAHL.SKU = TBXML.SKU)
		WHERE EXISTS(SELECT * FROM ZnodeOmsOrderLineItems ZOOLI where TBXML.OrderLineItemId = ZOOLI.OmsOrderLineItemsId and ZOOLI.ParentOmsOrderLineItemsId is null)
		AND TBXML.OrderLineItemRelationshipTypeId in (SELECT OrderLineItemRelationshipTypeId FROM ZnodeOmsOrderLineItemRelationshipType Where Name IN ('Group'))
		ORDER BY  WarehouseSequenceFirst,WarehouseSequence;

		;with cte as
		(
			SELECT WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	a.InventoryTracking,	AllowBackOrder,sum(OrderQuantity) as OrderQuantity
			FROM @TBL_CalculateQuntity A
			GROUP BY WarehouseId,	a.SKU,	MainQuantity,	InventoryId,	WarehouseSequenceId,	InventoryTracking,	AllowBackOrder
		)
		UPDATE b set  b.OrderQuantity = a.OrderQuantity
		FROM cte a
		INNER JOIN @TBL_CalculateQuntity b on a.SKU = b.SKU and a.InventoryId = b.InventoryId and a.WarehouseId = b.WarehouseId

		
		UPDATE @TBL_CalculateQuntity 
		SET UpdatedQuantity = MainQuantity - OrderQuantity  
		WHERE WarehouseSequenceId = 1;
		 		
		DECLARE @CountToRepeate int= ( SELECT count( distinct WarehouseId) FROM @TBL_CalculateQuntity),@Initializationofloop int= 2;
       
		WHILE @Initializationofloop <= @CountToRepeate 
				AND EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity AS a 
					WHERE UpdatedQuantity < 0  )
		BEGIN
		 
			UPDATE a  
			SET a.UpdatedQuantity = a.MainQuantity + b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = (@Initializationofloop - 1)) 
			WHERE a.WarehouseSequenceId = @Initializationofloop 
			AND b.UpdatedQuantity < 0
			AND b.UpdatedQuantity IS NOT NULL 

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			AND UpdatedQuantity < 0
			AND UpdatedQuantity IS NOT NULL 

			SET @Initializationofloop = @Initializationofloop + 1;
		END; 
		
		
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_CalculateQuntity WHERE ISNULL(UpdatedQuantity,0) < 0 AND @CountToRepeate >1)
		BEGIN 
			UPDATE a  
			SET a.UpdatedQuantity = b.UpdatedQuantity 
			FROM @TBL_CalculateQuntity a 
			INNER JOIN @TBL_CalculateQuntity b ON (a.Sku = b.Sku AND b.WarehouseSequenceId = @Initializationofloop -1 ) 
			WHERE a.WarehouseSequenceId = 1 
			AND ISNULL(b.UpdatedQuantity,0) < 0

			UPDATE @TBL_CalculateQuntity 
			SET UpdatedQuantity  = 0 
			WHERE WarehouseSequenceId = @Initializationofloop -1 
			--AND  InventoryTracking <> 'AllowBackordering'
			AND ISNULL(UpdatedQuantity,0) < 0
		END 
			
			
		--If "AllowBackordering" then inventory will go to be negative conside only single warehouse
		IF EXISTS(SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'AllowBackordering')
		BEGIN
			UPDATE ZI SET Quantity = Isnull(TBCQ.UpdatedQuantity,0) 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId)
			WHERE InventoryTracking = 'AllowBackordering' AND  UpdatedQuantity IS NOT NULL  ;
			SET @Status = 1;
		END;
		
		-- If @InventoryTracking is "DisablePurchasing" then subtracts currently selected quantity only when it will greater than zero.
		IF EXISTS ( SELECT TOP 1 1 FROM @TBL_XmlReturnToTable WHERE InventoryTracking = 'DisablePurchasing')
		BEGIN
			SET @BalanceQuantity = 1;
			UPDATE ZI 
			SET Quantity = CASE WHEN TBCQ.UpdatedQuantity < 0 THEN 0 ELSE TBCQ.UpdatedQuantity END 
			FROM dbo.ZnodeInventory ZI 
			INNER JOIN  @TBL_CalculateQuntity TBCQ ON(Zi.InventoryId = TBCQ.InventoryId) WHERE InventoryTracking = 'DisablePurchasing'
			AND TBCQ.UpdatedQuantity IS NOT NULL 
			;
		END;
		
		INSERT INTO ZnodeOmsOrderWarehouse( OmsOrderLineItemsId, WarehouseId,Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate )
		SELECT OrderLineItemId, WarehouseId,CASE WHEN UpdatedQuantity = 0 THEN MainQuantity ELSE MainQuantity - UpdatedQuantity END , @UserId, dbo.Fn_GetDate(), @UserId, dbo.Fn_GetDate() 
		FROM @TBL_CalculateQuntity AS TBCQ 
		INNER JOIN @TBL_XmlReturnToTable AS TBXR
			   ON(TBXR.SKU = TBCQ.SKU) WHERE UpdatedQuantity IS NOT NULL;
  
		SELECT DISTINCT SKU,
		 [dbo].[Fn_GetDefaultPriceRoundOffReturnNumeric](UpdatedQuantity) AS Quantity,
		  InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_CalculateQuntity
		WHERE UpdatedQuantity IS NOT NULL;

		SET @Status = 1;
		COMMIT TRAN UpdateInventory;
	END TRY
	BEGIN CATCH
	
		SET @Status = 0;
		SELECT SKU, Quantity, InventoryTracking,CAST(AllowBackOrder AS BIT) AllowBackOrder
		FROM @TBL_ErrorInventoryTracking;
		
		ROLLBACK TRAN UpdateInventory;
	END CATCH;
END;

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'RemainingOrderAmount' AND Object_ID = Object_ID(N'dbo.ZnodeOrderPayment'))
BEGIN
	ALTER TABLE ZnodeOrderPayment ADD RemainingOrderAmount DECIMAL NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'IsUsedForWebStorePayment' AND Object_ID = Object_ID(N'dbo.ZnodePortalPaymentSetting'))
BEGIN
	ALTER TABLE ZnodePortalPaymentSetting ADD IsUsedForWebStorePayment BIT NULL;
END

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'IsUsedForOfflinePayment' AND Object_ID = Object_ID(N'dbo.ZnodePortalPaymentSetting'))
BEGIN
	ALTER TABLE ZnodePortalPaymentSetting ADD IsUsedForOfflinePayment BIT NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCommonPaymentSetting')
	DROP PROC Znode_GetCommonPaymentSetting
GO

CREATE PROCEDURE [dbo].[Znode_GetCommonPaymentSetting]
(
	@PortalIds VARCHAR(2000) = '',
	@ProfileIds VARCHAR(2000) = '',
	@PaymentSettingIds VARCHAR(2000) = '' OUT
)
AS
/*
Summary:- This procedure is used to get payment setting of portal ids and profile ids
Unit Testing
EXEC Znode_GetCommonPaymentSetting
*/
BEGIN
BEGIN TRY
SET NOCOUNT ON
     
	DECLARE @TBL_PaymentSetting TABLE(PaymentSettingId INT , ProfileId int )

	INSERT INTO @TBL_PaymentSetting (PaymentSettingId,ProfileId)
	SELECT PaymentSettingId,ProfileId
	FROM ZnodeProfilePaymentSetting ZPPS
	WHERE EXISTS (SELECT TOP 1 1 FROM dbo.split(@ProfileIds,',') SP WHERE ZPPS.ProfileId = SP.Item)

	IF EXISTS (SELECT TOP 1 1 FROM @TBL_PaymentSetting )
	BEGIN
		SET @PaymentSettingIds = ISNULL(SUBSTRING(( SELECT ','+CAST(PaymentSettingId AS VARCHAR(50))
		FROM ZnodePortalPaymentSetting ZPPS
		WHERE ZPPS.IsUsedForWebStorePayment = 1 AND EXISTS (SELECT TOP 1 1 FROM dbo.split(@PortalIds,',') SP WHERE ZPPS.PortalId = SP.Item)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_PaymentSetting  TBPS WHERE TBPS.PaymentSettingId = ZPPS.PaymentSettingId ) FOR XML PATH ('')),2,4000),'')
	END
	
	IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_PaymentSetting ) OR @PaymentSettingIds = ''
	BEGIN
		SET @PaymentSettingIds = SUBSTRING((  SELECT ','+CAST(PaymentSettingId AS VARCHAR(50))
		FROM ZnodePortalPaymentSetting ZPPS
		WHERE ZPPS.IsUsedForWebStorePayment = 1 AND EXISTS (SELECT TOP 1 1 FROM dbo.split(@PortalIds,',') SP WHERE ZPPS.PortalId = SP.Item) FOR XML PATH ('')),2,4000)
		
	END
 
END TRY
BEGIN CATCH
	DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCommonPaymentSetting @PortalIds = '+@PortalIds+',@ProfileIds='+@ProfileIds+',@PaymentSettingIds='+@PaymentSettingIds+',@Status='+CAST(@Status AS VARCHAR(10));
             
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
 
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetCommonPaymentSetting',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetCommonPaymentSettingForOfflinePayment')
	DROP PROC Znode_GetCommonPaymentSettingForOfflinePayment
GO

CREATE PROCEDURE [dbo].[Znode_GetCommonPaymentSettingForOfflinePayment]
(
	@PortalIds VARCHAR(2000) = '',
	@ProfileIds VARCHAR(2000) = '',
	@PaymentSettingIds VARCHAR(2000) = '' OUT
)
AS
/*
Summary:- This procedure is used to get payment setting of portal ids and profile ids
Unit Testing
EXEC Znode_GetCommonPaymentSetting
*/
BEGIN
BEGIN TRY
SET NOCOUNT ON
     
	DECLARE @TBL_PaymentSetting TABLE(PaymentSettingId INT , ProfileId int )

	INSERT INTO @TBL_PaymentSetting (PaymentSettingId,ProfileId)
	SELECT PaymentSettingId,ProfileId
	FROM ZnodeProfilePaymentSetting ZPPS
	WHERE EXISTS (SELECT TOP 1 1 FROM dbo.split(@ProfileIds,',') SP WHERE ZPPS.ProfileId = SP.Item)

	IF EXISTS (SELECT TOP 1 1 FROM @TBL_PaymentSetting )
	BEGIN
		SET @PaymentSettingIds = ISNULL(SUBSTRING(( SELECT ','+CAST(PaymentSettingId AS VARCHAR(50))
		FROM ZnodePortalPaymentSetting ZPPS
		WHERE EXISTS (SELECT TOP 1 1 FROM dbo.split(@PortalIds,',') SP WHERE ZPPS.PortalId = SP.Item)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_PaymentSetting  TBPS WHERE TBPS.PaymentSettingId = ZPPS.PaymentSettingId ) FOR XML PATH ('')),2,4000),'')
	END
	
	IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_PaymentSetting ) OR @PaymentSettingIds = ''
	BEGIN
		SET @PaymentSettingIds = SUBSTRING((  SELECT ','+CAST(PaymentSettingId AS VARCHAR(50))
		FROM ZnodePortalPaymentSetting ZPPS
		WHERE EXISTS (SELECT TOP 1 1 FROM dbo.split(@PortalIds,',') SP WHERE ZPPS.PortalId = SP.Item) FOR XML PATH ('')),2,4000)
		
	END
 
END TRY
BEGIN CATCH
	DECLARE @Status BIT ;
	SET @Status = 0;
	DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetCommonPaymentSetting @PortalIds = '+@PortalIds+',@ProfileIds='+@ProfileIds+',@PaymentSettingIds='+@PaymentSettingIds+',@Status='+CAST(@Status AS VARCHAR(10));
             
	SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
 
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_GetCommonPaymentSetting',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentHistory')
	DROP PROC Znode_GetPaymentHistory
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentHistory]
( 
	@OrderId  INT
)
AS 
BEGIN
	SET NOCOUNT ON;
	BEGIN TRY
	   SELECT OP.OrderPaymentId, OP.OmsOrderId, OP.TransactionReference,	OP.Amount, OP.TransactionStatus, OP.TransactionDate, 
			OP.PaymentSettingId, OP.RemainingOrderAmount, OP.CreatedDate, OP.ModifiedDate, PT.PaymentDisplayName as PaymentType
	   FROM ZnodeOrderPayment OP
	   INNER JOIN ZnodeOmsOrderDetails OOD on OP.OmsOrderId = OOD.OmsOrderId
	   INNER JOIN ZnodePaymentSetting PT on OP.PaymentSettingId = PT.PaymentSettingId
	   WHERE OP.OmsOrderId=@OrderId and OOD.IsActive=1
	END TRY
    BEGIN CATCH
		DECLARE @Status BIT ;
		SET @Status = 0;

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), 
		@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(), 
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentHistory @OrderId = '+CAST(@OrderId AS VARCHAR(50));
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetPaymentHistory',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
    END CATCH;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingForOfflinePayment')
	DROP PROC Znode_GetPaymentSettingForOfflinePayment
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingForOfflinePayment]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT
										,PaymentDisplayName nvarchar(1200),PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50), IsUsedForOfflinePayment BIT,Code VARCHAR(100))


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSettingForOfflinePayment @PortalIds,0,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 )

				 '
	 IF @userId <> 0 
	 BEGIN 
		SET @IsAssociated = 1  	
	 END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50)) 
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName,0 as IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))
	   SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, 0 IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment ,ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo,IsUsedForOfflinePayment, Code

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowId ,CountNo, IsUsedForOfflinePayment, Code
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowID,CountNo,IsUsedForOfflinePayment,Code)
	 EXEC (@SQL)

	 IF @IsAssociated = 1 
	 BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,isnull(IsUsedForOfflinePayment,0) as IsUsedForOfflinePayment  
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForOfflinePayment,0) = 1
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE  ISNULL(IsUsedForOfflinePayment,0) = 1),0)
	END
	ELSE 
	BEGIN
	
		SELECT PaymentSettingId,PaymentApplicationSettingId,PS.PaymentTypeId,PaymentGatewayId,PaymentName,PS.IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,PS.CreatedBy,PS.CreatedDate,PS.ModifiedBy,PS.ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, 
							PaymentCode, GatewayCode,PS.IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,ISNULL(PS.IsUsedForOfflinePayment,0)IsUsedForOfflinePayment
		 FROM @TBL_PaymentSetting PS
		 WHERE (Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')	AND ISNULL(IsUsedForOfflinePayment,0) = 0)	
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE (Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')	AND ISNULL(IsUsedForOfflinePayment,0) = 0)),0)
	END

  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSettingForOfflinePayment',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
  END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrderPayment')
	DROP PROC Znode_InsertUpdateOmsOrderPayment
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrderPayment]
(
	@OrderPaymentXML XML,
	@OrderId INT,
	@TransactionDate DATETIME,
	@UserId INT,
	@Status BIT = 0 OUT
)
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRAN OrderInsert
	BEGIN TRY

		DECLARE @GetDate DATETIME = GETDATE()

		IF OBJECT_ID('tempdb..#TempOrderPaymentData') IS NOT NULL
			DROP TABLE #TempOrderPaymentData
	
		CREATE TABLE #TempOrderPaymentData
			(OmsOrderId INT, TransactionReference NVARCHAR(50), Amount NUMERIC(18,0), TransactionStatus NVARCHAR(50), PaymentSettingId INT, RemainingOrderAmount NUMERIC(18,0))
	
		--------Getting Order Payment details
		INSERT INTO #TempOrderPaymentData
			(OmsOrderId, TransactionReference, Amount, TransactionStatus , PaymentSettingId, RemainingOrderAmount)

		SELECT
			CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
			Tbl.Col.value( 'TransactionReference[1]', 'NVARCHAR(Max)' ) AS TransactionReference,
			CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Amount,
			CASE WHEN Tbl.Col.value( 'TransactionStatus[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TransactionStatus[1]', 'NVARCHAR(Max)' ) END AS TransactionStatus,
			CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END  AS PaymentGatewayId,
			CASE WHEN Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) END AS RemainingOrderAmount

		FROM @OrderPaymentXML.nodes( '//OrderPaymentDataModel' ) AS Tbl(Col);
	
		INSERT INTO ZnodeOrderPayment
			(OmsOrderId, TransactionReference, Amount, TransactionStatus, TransactionDate, PaymentSettingId , CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, RemainingOrderAmount)
		SELECT OmsOrderId, TransactionReference, Amount, TransactionStatus, @TransactionDate, PaymentSettingId, @UserId, @GetDate, @UserId, @GetDate, RemainingOrderAmount
		FROM #TempOrderPaymentData 

		SET @Status = 1;
		SELECT 1 AS Id,@Status AS Status;
	COMMIT TRAN OrderInsert
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN OrderInsert
		SET @Status = 0;

		SELECT 0 AS Id, @Status AS Status; 

		DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrderPayment @OrderPaymentXML ='+CAST(@OrderPaymentXML AS VARCHAR(MAX))+' ,@OrderId = '+CAST(@OrderId AS VARCHAR(50))
					+',@TransactionDate = '+CAST(@TransactionDate AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status = '+CAST(@Status AS VARCHAR(50));

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName    = 'Znode_InsertUpdateOmsOrderPayment',
		@ErrorInProcedure = @ERROR_PROCEDURE,
		@ErrorMessage     = @ErrorMessage,
		@ErrorLine        = @ErrorLine,
		@ErrorCall        = @ErrorCall;
	END CATCH
END

GO

update ZnodeApplicationSetting 
set Setting = '<?xml version="1.0" encoding="utf-16"?>  <columns>    <column>      <id>1</id>      <name>OrderNumber</name>      <headertext>Order/Invoice Number</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>y</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>2</id>      <name>FailedOrderTotalWithCurrency</name>      <headertext>Order Total</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>Decimal</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>3</id>      <name>OrderDate</name>      <headertext>Order/Transaction Date</headertext>      <width>0</width>      <datatype>DateTime</datatype>      <columntype>DateTime</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>4</id>      <name>PaymentDisplayName</name>      <headertext>Payment Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>5</id>      <name>PaymentStatus</name>      <headertext>Payment Status</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>true</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>6</id>      <name>TransactionToken</name>      <headertext>Transaction ID</headertext>      <width>0</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>y</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>n</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>7</id>      <name>UserName</name>      <headertext>Customer Name</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>    <column>      <id>8</id>      <name>Email</name>      <headertext>Email Address</headertext>      <width>30</width>      <datatype>String</datatype>      <columntype>String</columntype>      <allowsorting>false</allowsorting>      <allowpaging>true</allowpaging>      <format>      </format>      <isvisible>y</isvisible>      <mustshow>n</mustshow>      <musthide>n</musthide>      <maxlength>0</maxlength>      <isallowsearch>y</isallowsearch>      <isconditional>n</isconditional>      <isallowlink>n</isallowlink>      <islinkactionurl>      </islinkactionurl>      <islinkparamfield>      </islinkparamfield>      <ischeckbox>n</ischeckbox>      <checkboxparamfield>      </checkboxparamfield>      <iscontrol>n</iscontrol>      <controltype>      </controltype>      <controlparamfield>      </controlparamfield>      <displaytext>      </displaytext>      <editactionurl>      </editactionurl>      <editparamfield>      </editparamfield>      <deleteactionurl>      </deleteactionurl>      <deleteparamfield>      </deleteparamfield>      <viewactionurl>      </viewactionurl>      <viewparamfield>      </viewparamfield>      <imageactionurl>      </imageactionurl>      <imageparamfield>      </imageparamfield>      <manageactionurl>      </manageactionurl>      <manageparamfield>      </manageparamfield>      <copyactionurl>      </copyactionurl>      <copyparamfield>      </copyparamfield>      <xaxis>n</xaxis>      <yaxis>n</yaxis>      <isadvancesearch>y</isadvancesearch>      <Class>      </Class>      <SearchControlType>--Select--</SearchControlType>      <SearchControlParameters>      </SearchControlParameters>      <DbParamField>      </DbParamField>      <useMode>DataBase</useMode>      <IsGraph>n</IsGraph>      <allowdetailview>n</allowdetailview>    </column>  </columns>'
where ItemName = 'ZnodeOmsFailedOrderPayments'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = isnull(c.CatalogCode,'')) AND ISNULL(ii.RenameSynonymCode,'') = '' 

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	--SELECT '79', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	--FROM @InsertSearchSynonyms AS ii
	--WHERE (isnull(ii.SynonymCode,'') NOT LIKE '%[^a-zA-Z0-9]%')
	--AND NOT EXISTS (SELECT 1 FROM ZnodeImportLog WHERE ColumnName = 'SynonymCode')

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''
	AND exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''

	--INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	--SELECT '79', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	--FROM @InsertSearchSynonyms AS ii
	--WHERE (isnull(ii.RenameSynonymCode,'') NOT LIKE '%[^a-zA-Z0-9]%') and isnull(ii.RenameSynonymCode,'') <> ''
		
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False','Yes','No') AND ii.IsBidirectional <> ''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, CASE WHEN A.IsBidirectional = 'YES' THEN '1' WHEN A.IsBidirectional = 'NO' THEN '0' END, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode)
		
	--Update existing search synonym
	UPDATE ZSS 
	SET ZSS.SynonymCode = IPS.RenameSynonymCode, ZSS.OriginalTerm = CASE WHEN ISNULL(IPS.OriginalTerm,'') = '' THEN ZSS.OriginalTerm ELSE IPS.OriginalTerm END,
	ZSS.ReplacedBy =CASE WHEN ISNULL(IPS.ReplacedBy,'') = '' THEN ZSS.ReplacedBy ELSE IPS.ReplacedBy END,
	ZSS.IsBidirectional= CASE WHEN ISNULL (IPS.IsBidirectional,'') = '' THEN ZSS.IsBidirectional ELSE CASE WHEN IPS.IsBidirectional = 'YES' THEN '1' WHEN IPS.IsBidirectional = 'NO' THEN '0' END END,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
	WHERE ISNULL(IPS.RenameSynonymCode,'') <> ''

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = isnull(c.CatalogCode,'')) AND ISNULL(ii.RenameSynonymCode,'') = '' 

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.SynonymCode,'') LIKE '%[^a-zA-Z0-9]%')

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''
	AND exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.RenameSynonymCode,'') LIKE '%[^a-zA-Z0-9]%') and isnull(ii.RenameSynonymCode,'') <> ''
		
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False','Yes','No') AND ii.IsBidirectional <> ''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, CASE WHEN A.IsBidirectional = 'YES' THEN '1' WHEN A.IsBidirectional = 'NO' THEN '0' END, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode)
		
	--Update existing search synonym
	UPDATE ZSS 
	SET ZSS.SynonymCode = IPS.RenameSynonymCode, ZSS.OriginalTerm = CASE WHEN ISNULL(IPS.OriginalTerm,'') = '' THEN ZSS.OriginalTerm ELSE IPS.OriginalTerm END,
	ZSS.ReplacedBy =CASE WHEN ISNULL(IPS.ReplacedBy,'') = '' THEN ZSS.ReplacedBy ELSE IPS.ReplacedBy END,
	ZSS.IsBidirectional= CASE WHEN ISNULL (IPS.IsBidirectional,'') = '' THEN ZSS.IsBidirectional ELSE CASE WHEN IPS.IsBidirectional = 'YES' THEN '1' WHEN IPS.IsBidirectional = 'NO' THEN '0' END END,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
	WHERE ISNULL(IPS.RenameSynonymCode,'') <> ''

	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = isnull(c.CatalogCode,'')) AND ISNULL(ii.RenameSynonymCode,'') = '' 

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.SynonymCode,'') LIKE '%[^a-zA-Z0-9]%')

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''
	AND exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.RenameSynonymCode,'') LIKE '%[^a-zA-Z0-9]%') and isnull(ii.RenameSynonymCode,'') <> ''
		
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False','Yes','No') AND ii.IsBidirectional <> ''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, CASE WHEN A.IsBidirectional = 'YES' THEN '1' WHEN A.IsBidirectional = 'NO' THEN '0' ELSE A.IsBidirectional END, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode)
		
	--Update existing search synonym 
	UPDATE ZSS 
	SET ZSS.SynonymCode = CASE WHEN ISNULL(IPS.RenameSynonymCode,'') <> '' THEN IPS.RenameSynonymCode ELSE ZSS.SynonymCode END , ZSS.OriginalTerm = CASE WHEN ISNULL(IPS.OriginalTerm,'') = '' THEN ZSS.OriginalTerm ELSE IPS.OriginalTerm END,
	ZSS.ReplacedBy =CASE WHEN ISNULL(IPS.ReplacedBy,'') = '' THEN ZSS.ReplacedBy ELSE IPS.ReplacedBy END,
	ZSS.IsBidirectional= CASE WHEN ISNULL (IPS.IsBidirectional,'') = '' THEN ZSS.IsBidirectional ELSE CASE WHEN IPS.IsBidirectional = 'YES' THEN '1' WHEN IPS.IsBidirectional = 'NO' THEN '0' ELSE IPS.IsBidirectional END END,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
	
	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetOmsQuoteList')
	DROP PROC Znode_GetOmsQuoteList
GO

CREATE PROCEDURE [dbo].[Znode_GetOmsQuoteList]    
(     
  @WhereClause NVARCHAR(MAX),    
  @Rows        INT            = 100,    
  @PageNo      INT            = 1  ,    
  @Order_BY    VARCHAR(1000)  = '' ,    
  @RowsCount   INT OUT             ,    
  @AccountId   INT,    
  @UserId      INT            = 0,     
  @IsPendingPayment BIT = 0  ,     
  @IsParentPendingOrder  BIT = 1,
  @SalesRepUserId int = 0    
 )    
AS     
   /*    
  Summary :- This procedure is used to get the Quote list of account and Users    
    Fn_GetRecurciveAccounts is used to fetch AccountId and Its recursive ParentId      
    @InnerWhereClause contains AccountId fetched from the Function Fn_GetRecurciveAccounts     
    OrderDetails are fetched from the tables filtered by AccountId Present in @InnerWhereClause    
    OrderDetails are fetched in Descending order of OmsQuoteId    
     Unit Testing     
     
     EXEC Znode_GetOmsQuoteList '' ,@RowsCount = 50 ,@AccountId = 1,@UserId = 0      
    
*/    
     BEGIN    
         BEGIN TRY    
			SET NOCOUNT ON;    
			DECLARE @SQL VARCHAR(MAX)= '', @InnerWhereClause VARCHAR(MAX)= '', @ProcessType  varchar(50)='Quote',@QuoteFilter NVARCHAr(max)='';    
			
			----Verifying that the @SalesRepUserId is having 'Sales Rep' role
			IF NOT EXISTS
			(
				SELECT * FROM ZnodeUser ZU
				INNER JOIN AspNetZnodeUser ANZU ON ZU.UserName = ANZU.UserName
				INNER JOIN AspNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName
				INNER JOIN AspNetUserRoles ANUR ON ANU.Id = ANUR.UserId
				Where Exists(select * from AspNetRoles ANR Where Name = 'Sales Rep' AND ANUR.RoleId = ANR.Id) 
				AND ZU.UserId = @SalesRepUserId
			)   
			Begin
				SET @SalesRepUserId = 0
			End

            DECLARE @TBL_QuoteDetails TABLE (OmsQuoteId INT,UserName NVARCHAR(300),AccountName NVARCHAR(400),QuoteOrderTotal NUMERIC(28, 6),[OrderStatus] VARCHAR(300),    
            CreatedDate DATETIME,StoreName NVARCHAR(Max),CurrencyCode VARCHAR(100),CultureCode VARCHAR(100),PublishState nvarchar(600),RowId INT,CountNo INT,CreatedByName NVARCHAr(max) ,ModifiedByName NVARCHAR(max),IsConvertedToOrder bit,OrderType varchar(50), UserId INT, AccountCode nvarchar(100));    
           
             IF @UserId <> 0  AND @IsParentPendingOrder   = 1           
                 BEGIN    
                     SET @InnerWhereClause = ' AND '''+CAST(@UserId AS VARCHAR(max))+''' = ZU.UserId ';    
                    -- SET @AccountId = (SELECT TOP 1 AccountID FROM ZnodeUser WHERE UserId = @UserId);    
                 END    
             ELSE IF @IsParentPendingOrder   = 0     
                BEGIN    
				SET @InnerWhereClause = ' AND  EXISTS (SELECT TOP 1 1 FROM [dbo].[Fn_GetRecurciveUserId] ('+CAST(@UserId AS VARCHAR(50))+','''+@ProcessType+''') SP WHERE (SP.UserId = ZU.UserId OR SP.UserId IS NULL)  )';   
   
				SET @QuoteFilter =' AND EXISTS (SELECT TOP 1 1 FROM ZnodeOMSQuoteApproval WR WHERE WR.OmsQuoteId = ZOQ.OmsQuoteId AND ( Wr.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))+' OR Wr.UserId = '+CAST(@UserId AS VARCHAR(50))+'  ) ) ';        
				END    
    ELSE     
    BEGIN     
      SET @InnerWhereClause = ''    
    END       
          
    IF @IsPendingPayment =1     
    BEGIN     
       
     SET @InnerWhereClause = @InnerWhereClause+' AND NOT EXISTS ( SELECT TOP 1 1 FROM ZnodeUserGlobalAttributeValue a     
    INNER JOIN ZnodeUserGlobalAttributeValueLocale b  on (b.UserGlobalAttributeValueId = a.UserGlobalAttributeValueId)    
    INNER JOIN ZnodeGlobalAttribute c ON (c.GlobalAttributeid = a.GlobalAttributeId )    
    WHERE c.AttributeCOde = ''BillingAccountNumber'' AND a.UserId =  ZU.UserId AND b.AttributeValue = '''' ) AND ZOQ.IsPendingPayment =  1    '    
         
    END     
    ELSE     
    BEGIN    
       SET @InnerWhereClause = @InnerWhereClause+' AND ZOQ.IsPendingPayment = 0   '    
    END     
    
    SET @InnerWhereClause = @InnerWhereClause + CASE WHEN @AccountId > 0 THEN ' AND ZA.AccountId ='+CAST(@AccountId AS VARCHAR(200)) ELSE '' END     
    
    SET @SQL = '       
		;With Cte_GetQuoteDetail AS     
		(    
			SELECT distinct Zu.UserId ,ZOQ.OmsQuoteId,ZU.FirstName + CASE WHEN ZU.LastName IS NULL THEN '''' ELSE '' ''+Zu.LastName END UserName , QuoteOrderTotal , ZOOS.Description [OrderStatus]    
			,ZOQ.CreatedDate,ZA.Name AccountName,ZP.PortalId,Zp.StoreName , ZCC.CurrencyCode AS CurrencyCode, ZC.CultureCode AS CultureCode ,ZVGD.UserName CreatedByName , ZVGDI.UserName ModifiedByName,    
			case When ZOQ.IsConvertedToOrder IS NULL THEN 0 ELSE ZOQ.IsConvertedToOrder END IsConvertedToOrder,ISNULL(DT.QuoteTypeCode,'''') QuoteTypeCode,ZODPS.DisplayName as PublishState,
			'+case when cast(@IsParentPendingOrder as varchar(10)) = 0  then +'Case  When TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))  + ' then ''Approval Requested'' 
			else ''Pending For Approval'' END' else '''''' end +' OrderType, ZA.AccountCode    
			FROM ZnodeOmsQuote ZOQ    
			INNER JOIN ZnodeUser ZU ON (ZU.UserId = ZOQ.UserId)    
			LEFT JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOQ.PublishStateId)  
			LEFT JOIN ZnodeUserPortal ZUP ON ZU.UserId = ZUP.UserId    
			inner JOIN ZnodePortal ZP ON ZP.PortalId = Zoq.PortalId    
			'+CASE WHEN @IsParentPendingOrder = 0  THEN ' LEFT JOIN ZnodeOMSQuoteApproval TYUI ON (TYUI.OmsQuoteId = ZOQ.OmsQuoteId AND TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))+' ) ' ELSE '' END +'    
			LEFT JOIN ZnodePortalUnit ZPU ON (ZPU.PortalId = Zp.PortalId)    
			LEFT JOIN ZnodeCulture ZC ON (ZPU.CultureId = ZC.CultureId)    --- Changed join condition from CurrencyId to CultureId    
			LEFT JOIN ZnodeCurrency ZCC ON (ZC.CurrencyId = ZCC.CurrencyId)    --- Joined ZnodeCulture and ZnodeCurrency   
			LEFT JOIN ZnodeOmsOrderState ZOOS ON (ZOOS.OmsOrderStateId = '+CASE WHEN @IsParentPendingOrder = 0 AND EXISTS (SELECT TOP 1 1 FROM ZnodeOMSQuoteApproval OQ WHERE OQ.ApproverUserId = @UserId) THEN 'TYUI.OmsOrderStateId ' ELSE 'ZOQ.OmsOrderStateId' END  +' )     
			LEFT JOIN ZnodeAccount ZA ON (ZA.AccountId = ZU.AccountId )    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGD ON (ZVGD.UserId = ZOQ.CreatedBy )    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGDI ON (ZVGDI.UserId = ZOQ.ModifiedBy)    
			INNER JOIN ZnodeOmsQuoteType DT ON (DT.OmsQuoteTypeId = ZOQ.OmsQuoteTypeId)    
			WHERE DT.OmsQuoteTypeId <> (select top 1 OmsQuoteTypeId from ZnodeOmsQuoteType where QuoteTypeCode = ''QUOTE'')'+' '+@InnerWhereClause+@QuoteFilter+'    
			and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZOQ.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
			UNION 
			SELECT Zu.UserId ,ZOQ.OmsQuoteId,ZU.FirstName + CASE WHEN ZU.LastName IS NULL THEN '''' ELSE '' ''+Zu.LastName END UserName , QuoteOrderTotal , ZOOS.Description [OrderStatus]    
			,ZOQ.CreatedDate,ZA.Name AccountName,ZP.PortalId,Zp.StoreName , ZCC.CurrencyCode AS CurrencyCode, ZC.CultureCode AS CultureCode ,ZVGD.UserName CreatedByName , ZVGDI.UserName ModifiedByName,    
			case When ZOQ.IsConvertedToOrder IS NULL THEN 0 ELSE ZOQ.IsConvertedToOrder END IsConvertedToOrder,ISNULL(DT.QuoteTypeCode,'''') QuoteTypeCode,ZODPS.DisplayName as PublishState,
			'+case when cast(@IsParentPendingOrder as varchar(10)) = 0  then +'Case  When TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))  + ' then ''Approval Requested'' 
			else ''Pending For Approval'' END' else '''''' end +' OrderType, ZA.AccountCode    
			FROM ZnodeOmsQuote ZOQ    
			INNER JOIN ZnodeUser ZU ON (ZU.UserId = ZOQ.UserId)    
			LEFT JOIN ZnodePublishState ZODPS ON (ZODPS.PublishStateId = ZOQ.PublishStateId)  
			LEFT JOIN ZnodeUserPortal ZUP ON ZU.UserId = ZUP.UserId    
			inner JOIN ZnodePortal ZP ON ZP.PortalId = Zoq.PortalId    
			'+CASE WHEN @IsParentPendingOrder = 0  THEN ' LEFT JOIN ZnodeOMSQuoteApproval TYUI ON (TYUI.OmsQuoteId = ZOQ.OmsQuoteId AND TYUI.ApproverUserId ='+CAST(@UserId AS VARCHAR(50))+' ) ' ELSE '' END +'    
			LEFT JOIN ZnodePortalUnit ZPU ON (ZPU.PortalId = Zp.PortalId)    
			LEFT JOIN ZnodeCulture ZC ON (ZPU.CultureId = ZC.CultureId)    --- Changed join condition from CurrencyId to CultureId    
			LEFT JOIN ZnodeCurrency ZCC ON (ZC.CurrencyId = ZCC.CurrencyId)    --- Joined ZnodeCulture and ZnodeCurrency   
			LEFT JOIN ZnodeOmsOrderState ZOOS ON (ZOOS.OmsOrderStateId = '+CASE WHEN @IsParentPendingOrder = 0 AND EXISTS (SELECT TOP 1 1 FROM ZnodeOMSQuoteApproval OQ WHERE OQ.ApproverUserId = @UserId) THEN 'TYUI.OmsOrderStateId ' ELSE 'ZOQ.OmsOrderStateId' END  +' )     
			LEFT JOIN ZnodeAccount ZA ON (ZA.AccountId = ZU.AccountId )    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGD ON (ZVGD.UserId = ZOQ.CreatedBy )    
			LEFT JOIN [dbo].[View_GetUserDetails]  ZVGDI ON (ZVGDI.UserId = ZOQ.ModifiedBy)    
			INNER JOIN ZnodeOmsQuoteType DT ON (DT.OmsQuoteTypeId = ZOQ.OmsQuoteTypeId)    
			WHERE  DT.OmsQuoteTypeId <> (select top 1 OmsQuoteTypeId from ZnodeOmsQuoteType where QuoteTypeCode = ''QUOTE'')'+
			'AND DT.OmsQuoteTypeId = (select top 1 OmsQuoteTypeId from ZnodeOmsQuoteType where QuoteTypeCode = ''OAB'')'+' '+@InnerWhereClause+'    
			and (exists(select * from ZnodeSalesRepCustomerUserPortal SalRep where SalRep.SalesRepUserId = '+cast(@SalesRepUserId as varchar(10))+' and ZOQ.UserId = SalRep.CustomerUserid) or '+cast(@SalesRepUserId as varchar(10))+' = 0)
		)    
		, Cte_GetQuote AS     
		(    
			SELECT distinct OmsQuoteId,UserName ,AccountName , QuoteOrderTotal QuoteAmount, [OrderStatus]  ,CreatedDate ,StoreName,CurrencyCode, CultureCode,PublishState,CreatedByName , ModifiedByName ,IsConvertedToOrder,OrderType,'+dbo.Fn_GetPagingRowId(@Order_BY,'CreatedDate DESC 
			,OmsQuoteId DESC')+',Count(*)Over() CountNo ,UserId, AccountCode      
			FROM Cte_GetQuoteDetail    
			WHERE 1=1     
			'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'    
		)    
		SELECT distinct OmsQuoteId,UserName ,AccountName ,  QuoteAmount, [OrderStatus]  ,CreatedDate ,StoreName,CurrencyCode, CultureCode,PublishState,RowId,CountNo,CreatedByName , ModifiedByName,IsConvertedToOrder,OrderType, UserId , AccountCode   
		FROM Cte_GetQuote     
		'+dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows) 
	
      print @SQL
        INSERT INTO @TBL_QuoteDetails (OmsQuoteId, UserName, AccountName, QuoteOrderTotal ,OrderStatus, CreatedDate, StoreName,CurrencyCode, CultureCode,PublishState, RowId ,CountNo,CreatedByName , ModifiedByName,IsConvertedToOrder,OrderType, UserId, AccountCode)          
        EXEC (@SQL);   	
        SET @RowsCount = ISNULL((SELECT TOP 1 CountNo FROM @TBL_QuoteDetails), 0);    

        SELECT  OmsQuoteId,UserName,AccountName,QuoteOrderTotal,[OrderStatus],CreatedDate,StoreName,CurrencyCode, CultureCode,PublishState,CreatedByName , ModifiedByName,IsConvertedToOrder  ,OrderType , UserId, AccountCode 
        FROM @TBL_QuoteDetails 
		ORDER BY  RowId
		      
         END TRY    
         BEGIN CATCH    
		DECLARE @Status BIT ;    
		SET @Status = 0;    
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetOmsQuoteList @WhereClause = '+CAST(@WhereClause AS VARCHAR(max)  
		)+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@AccountId='+CAST(@AccountId AS VARCHAR(50))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@PortalId='+''  
		+',@Status='+CAST(@Status AS VARCHAR(10));    
                      
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                        
        
		EXEC Znode_InsertProcedureErrorLog    
		@ProcedureName = 'Znode_GetOmsQuoteList',    
		@ErrorInProcedure = @Error_procedure,    
		@ErrorMessage = @ErrorMessage,    
		@ErrorLine = @ErrorLine,    
		@ErrorCall = @ErrorCall;    
    END CATCH;    
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSetting')
	DROP PROC Znode_GetPaymentSetting
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSetting]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSetting @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),
										PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT,PaymentDisplayName nvarchar(1200),
										PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),
										IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50),IsUsedForWebStorePayment BIT )


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSetting @PortalIds,@ProfileIds,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState , ZPPS.IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 WHERE  ISNULL(ZPPS.IsUsedForWebStorePayment,0) =  CASE WHEN '+CAST(@IsAssociated AS VARCHAR(10)) +' = 1 THEN  1  ELSE 0 END
				 )

				 '
	 IF @userId <> 0 
	 BEGIN 
		SET @IsAssociated = 1  	
	 END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50))
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, CASE WHEN ZPPS.ProfilePaymentSettingId IS NULL THEN 0 ELSE 1 END IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState , 0 AS IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))+'
									AND  IsAssociated = '+CAST(@IsAssociated AS VARCHAR(50))+CASE WHEN @FilterWhereClause = '' THEN ' ' ELSE @FilterWhereClause END 
	  SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, NULL IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState , 0 AS IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment,RowId ,CountNo
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,
						IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,
						PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment,RowID,CountNo)
	 EXEC (@SQL)

	 
	  
	IF @IsAssociated = 1 AND @ProfileId = 0
	BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForWebStorePayment,0) = 1
		 ORDER BY RowID,DisplayOrder
		 SET @RowsCount = ISNULL((SELECT Count(*) FROM @TBL_PaymentSetting WHERE ISNULL(IsUsedForWebStorePayment,0) = 1),0)
	END
	ELSE
	BEGIN
		SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForWebStorePayment,0) = 0
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT Count(*) FROM @TBL_PaymentSetting WHERE ISNULL(IsUsedForWebStorePayment,0) = 0),0)
	END


  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSetting @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSetting',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingForOfflinePayment')
	DROP PROC Znode_GetPaymentSettingForOfflinePayment
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingForOfflinePayment]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT
										,PaymentDisplayName nvarchar(1200),PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50), IsUsedForOfflinePayment BIT,Code VARCHAR(100))


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSettingForOfflinePayment @PortalIds,0,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 WHERE  ISNULL(ZPPS.IsUsedForOfflinePayment,0) =  CASE WHEN '+CAST(@IsAssociated AS VARCHAR(10)) +' = 1 THEN  1  ELSE 0 END
				 
				 )

				 '
	 IF @userId <> 0 
	 BEGIN 
		SET @IsAssociated = 1  	
	 END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50)) 
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName,0 as IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))
	   SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, 0 IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment ,ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo,IsUsedForOfflinePayment, Code

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowId ,CountNo, IsUsedForOfflinePayment, Code
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowID,CountNo,IsUsedForOfflinePayment,Code)
	 EXEC (@SQL)

	 IF @IsAssociated = 1 
	 BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,isnull(IsUsedForOfflinePayment,0) as IsUsedForOfflinePayment  
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForOfflinePayment,0) = 1
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE  ISNULL(IsUsedForOfflinePayment,0) = 1),0)
	END
	ELSE 
	BEGIN
	
		SELECT PaymentSettingId,PaymentApplicationSettingId,PS.PaymentTypeId,PaymentGatewayId,PaymentName,PS.IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,PS.CreatedBy,PS.CreatedDate,PS.ModifiedBy,PS.ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, 
							PaymentCode, GatewayCode,PS.IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,ISNULL(PS.IsUsedForOfflinePayment,0)IsUsedForOfflinePayment
		 FROM @TBL_PaymentSetting PS
		 WHERE (Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')	AND ISNULL(IsUsedForOfflinePayment,0) = 0)	
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE (Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')	AND ISNULL(IsUsedForOfflinePayment,0) = 0)),0)
	END

  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSettingForOfflinePayment',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
	END CATCH
END

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Store','EditStoreKlaviyo',1,2,Getdate(),2,Getdate()
where not exists(select * from ZnodeActions where ControllerName = 'Store' and ActionName = 'EditStoreKlaviyo')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store')
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'EditStoreKlaviyo') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'EditStoreKlaviyo'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'EditStoreKlaviyo')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'EditStoreKlaviyo'))


GO

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>OrderNumber</name><headertext>Order Number</headertext><width>0</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/User/OrderReceipt</islinkactionurl><islinkparamfield>OmsOrderId,portalId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>UserName</name><headertext>Username</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>OrderState</name><headertext>Order Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>PaymentStatus</name><headertext>Payment Status</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>paymentStatus</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>PaymentDisplayName</name><headertext>Payment Type</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>OrderTotalWithCurrency</name><headertext>Order Amount</headertext><width>30</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>OrderDate</name><headertext>Order Date</headertext><width>30</width><datatype>Date</datatype><columntype>DateTime</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/OrderReceipt</manageactionurl><manageparamfield>OmsOrderId,portalId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeAccountOrderForWebstore'

GO

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>FullName</name><headertext>Full Name</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Full Name</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>UserName</name><headertext>Username</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>Email</name><headertext>Email Address</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Email Address</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>RoleName</name><headertext>Role</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Role</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>Manage</name><headertext>Order History</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>View</format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>View</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/AccountOrders</manageactionurl><manageparamfield>userId,accountId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>40</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format>Disable|Reset</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>y</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield>AccountId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>AccountId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Disable|Reset Password</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/User/EnableDisableAccountUsers|/User/AccountResetPassword</manageactionurl><manageparamfield>AccountId,UserId,IsLock|UserId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class>grid-action</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeAccountUserForWebstore'

GO

UPDATE ZnodeEmailTemplateLocale
SET Subject='Good News! Desired Product - #ProductName# is back in Stock'
WHERE EmailTemplateId = (SELECT TOP 1 EmailTemplateId FROM ZnodeEmailTemplate WHERE TemplateName='SendWaitingListNoticeInInventory')
AND LocaleId=1

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetGiftCardDetails')
	DROP PROC Znode_GetGiftCardDetails
GO

CREATE PROCEDURE [dbo].[Znode_GetGiftCardDetails]
(
	@VoucherCodes Varchar(max),
	@OmsOrderDetailsId   int
)
AS
BEGIN  
	BEGIN TRY  
		DECLARE @IsApplied as bit = 1;
		SET NOCOUNT ON;
		;With Cte_GiftCart as
		(
			Select Gift.GiftCardId,GiftHistory.OmsOrderDetailsId,Gift.PortalId,Gift.Name as VoucherName,Gift.CardNumber as VoucherNumber,GiftHistory.TransactionAmount as VoucherAmountUsed
			, @IsApplied as IsVoucherApplied, Gift.RemainingAmount as VoucherBalance, Gift.IsActive as IsActive,Gift.ExpirationDate, Gift.RemainingAmount, ZOD.OmsOrderId
			, ROW_NUMBER() OVER (ORDER BY ZOD.OmsOrderId) As Rn
			from ZnodeGiftCard Gift
			INNER JOIN ZnodeGiftCardHistory GiftHistory ON Gift.GiftCardId = GiftHistory.GiftCardId
			LEFT JOIN ZnodeOmsOrderDetails ZOD on (GiftHistory.OmsOrderDetailsId = ZOD.OmsOrderDetailsId AND ZOD.IsActive = 1)
			LEFT JOIN ZnodeOmsOrder ZO on (ZOD.OmsOrderId = ZO.OmsOrderId)
			Where Gift.CardNumber in (select ltrim(rtrim(Item)) From dbo.Split(@VoucherCodes,',')) AND GiftHistory.OmsOrderDetailsId = @OmsOrderDetailsId
		)
		,Cte_GiftCart1 as
		(
		   SELECT ZOD.OmsOrderId,GiftHistory.GiftCardId,Gift.RemainingAmount, min(GiftHistory.OmsOrderDetailsId) as OmsOrderDetailsId
		   FROM ZnodeGiftCardHistory GiftHistory
		   inner join ZnodeGiftCard Gift ON GiftHistory.GiftCardId = Gift.GiftCardId
		   LEFT JOIN ZnodeOmsOrderDetails ZOD on (GiftHistory.OmsOrderDetailsId = ZOD.OmsOrderDetailsId AND ZOD.IsActive = 1)
		   LEFT JOIN ZnodeOmsOrder ZO on (ZOD.OmsOrderId = ZO.OmsOrderId)  
		   WHERE EXISTS(select * from  Cte_GiftCart Gift where GiftHistory.GiftCardId = Gift.GiftCardId)
		   GROUP BY ZOD.OmsOrderId,GiftHistory.GiftCardId,Gift.RemainingAmount
		)
		,CTE_OrderVoucherAmount AS
	   (
		   SELECT ISNULL(cte.OmsOrderId,0) AS OmsOrderId,cte.OmsOrderDetailsId,Hist.GiftCardId, 
		   CASE WHEN cte.OmsOrderId IS NOT NULL THEN Hist.TransactionAmount ELSE Cte.RemainingAmount END as OrderVoucherAmount, ROW_NUMBER() OVER (ORDER BY cte.OmsOrderId) As Rn
		   FROM ZnodeGiftCardHistory Hist
		   LEFT join Cte_GiftCart1 Cte on Hist.GiftCardId = Cte.GiftCardId and Hist.OmsOrderDetailsId = Cte.OmsOrderDetailsId
		   WHERE EXISTS(select * from  Cte_GiftCart Gift where Hist.GiftCardId = Gift.GiftCardId AND Hist.OmsOrderDetailsId = Gift.OmsOrderDetailsId)
		   AND CASE WHEN cte.OmsOrderId IS NOT NULL THEN Hist.TransactionAmount ELSE Cte.RemainingAmount END IS NOT NULL
		)
		Select a.GiftCardId, PortalId,VoucherName,VoucherNumber,VoucherAmountUsed,
		  IsVoucherApplied, VoucherBalance, IsActive,ExpirationDate, RemainingAmount, OrderVoucherAmount
		from Cte_GiftCart a
		inner join CTE_OrderVoucherAmount b on a.GiftCardId = b.GiftCardId  AND isnull(a.OmsOrderId,0) = isnull(b.OmsOrderId,0) AND a.Rn=b.Rn
		Order By a.ExpirationDate, a.RemainingAmount

	END TRY  
	BEGIN CATCH  
   
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),  
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetGiftCardDetails @VoucherCodes = '+CAST(@VoucherCodes AS VARCHAR(MAX))+',@OmsOrderDetailsId='+CAST(@OmsOrderDetailsId AS VARCHAR(50))                  
		EXEC Znode_InsertProcedureErrorLog  
		@ProcedureName = 'Znode_GetGiftCardDetails',  
		@ErrorInProcedure = @Error_procedure,  
		@ErrorMessage = @ErrorMessage,  
		@ErrorLine = @ErrorLine,  
		@ErrorCall = @ErrorCall;  
	END CATCH  
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Desription' AND Object_ID = Object_ID(N'dbo.ZnodeAccount'))
BEGIN
	EXEC sp_rename 'ZnodeAccount.Desription', 'Description', 'column'
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Discription' AND Object_ID = Object_ID(N'dbo.ZnodeOmsDiscountType'))
BEGIN
	EXEC sp_rename 'ZnodeOmsDiscountType.Discription', 'Description', 'column'
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'PramotionAttributeId' AND Object_ID = Object_ID(N'dbo.ZnodePromotionAttribute'))
BEGIN
	EXEC sp_rename 'ZnodePromotionAttribute.PramotionAttributeId', 'PromotionAttributeId', 'column'
END

GO

IF EXISTS(SELECT 1 FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS WHERE CONSTRAINT_NAME = 'PK_ZnodePramotionAttribute' AND TABLE_NAME='ZnodePromotionAttribute')
BEGIN
	EXEC sp_rename 'dbo.ZnodePromotionAttribute.PK_ZnodePramotionAttribute', 'PK_ZnodePromotionAttribute'
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'PramotionAttributeValidationId' AND Object_ID = Object_ID(N'dbo.ZnodePromotionAttributeValidation'))
BEGIN
	EXEC sp_rename 'ZnodePromotionAttributeValidation.PramotionAttributeValidationId', 'PromotionAttributeValidationId', 'column'
END

GO

IF EXISTS(SELECT 1 FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS WHERE CONSTRAINT_NAME = 'PK_ZnodePramotionAttributeValidation' AND TABLE_NAME='ZnodePromotionAttributeValidation')
BEGIN
	EXEC sp_rename 'dbo.ZnodePromotionAttributeValidation.PK_ZnodePramotionAttributeValidation', 'PK_ZnodePromotionAttributeValidation'
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'PramotionAttributeId' AND Object_ID = Object_ID(N'dbo.ZnodePromotionAttributeValidation'))
BEGIN
	EXEC sp_rename 'ZnodePromotionAttributeValidation.PramotionAttributeId', 'PromotionAttributeId', 'column'
END

GO

IF EXISTS(SELECT 1 FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS WHERE CONSTRAINT_NAME = 'FK_ZnodePramotionAttributeValidation_ZnodePramotionAttributeValidation' AND TABLE_NAME='ZnodePromotionAttributeValidation')
BEGIN
	EXEC sp_rename N'dbo.FK_ZnodePramotionAttributeValidation_ZnodePramotionAttributeValidation', N'FK_ZnodePromotionAttributeValidation_ZnodePromotionAttributeValidation', N'OBJECT'
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'PramotionAttributeId' AND Object_ID = Object_ID(N'dbo.ZnodePromotionDiscountAttributeMapper'))
BEGIN
	EXEC sp_rename 'ZnodePromotionDiscountAttributeMapper.PramotionAttributeId', 'PromotionAttributeId', 'column'
END

GO

IF EXISTS(SELECT 1 FROM sys.views WHERE name='View_LoadCategoryProductList' and type='v')
DROP VIEW View_LoadCategoryProductList;
GO



CREATE View [dbo].[View_LoadCategoryProductList]
AS 
SELECT a.PimProductId , c.AttributeCode , b.AttributeValue , b.LocaleId , pcc.PimCategoryId , Case when pcc.PimProductId Is NULl THEN 0 ELSE 1 END IsAssociatedProduct
FROM ZnodePimAttributeValue a 
INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
INNER JOIN  ZnodePimAttributeValueLocale b ON ( b.PimAttributeValueId = a.PimAttributeValueId ) 
LEFT JOIN ZnodePimCategoryProduct pcc ON (pcc.PimProductId = a.PimProductId )

UNION ALL

SELECT a.PimProductId, b.AttributeCode,ZPPATAV.AttributeValue,ZPPATAV.LocaleId,pcc.PimCategoryId,Case when pcc.PimProductId Is NULl THEN 0 ELSE 1 END IsAssociatedProduct
FROM  ZnodePimProductAttributeTextAreaValue ZPPATAV
INNER JOIN ZnodePimAttributeValue a ON (a.PimAttributeValueId= ZPPATAV.PimAttributeValueId)
INNER JOIN ZnodePimAttribute b ON (a.PimAttributeId= b.PimAttributeId)
LEFT JOIN ZnodePimCategoryProduct pcc ON (pcc.PimProductId = a.PimProductId)

UNION ALL

SELECT a.PimProductId,b.AttributeCode,ZPPAM.MediaPath,ZPPAM.LocaleId,pcc.PimCategoryId,Case when pcc.PimProductId Is NULl THEN 0 ELSE 1 END IsAssociatedProduct
FROM ZnodePimProductAttributeMedia ZPPAM 
INNER JOIN ZnodePimAttributeValue a ON (a.PimAttributeValueId= ZPPAM.PimAttributeValueId)
INNER JOIN ZnodePimAttribute b ON (a.PimAttributeId= b.PimAttributeId)
LEFT JOIN ZnodePimCategoryProduct pcc ON (pcc.PimProductId = a.PimProductId)

UNION ALL

SELECT a.PimProductId,b.AttributeCode,ZPADV.AttributeDefaultValueCode,ZPPADV.LocaleId,pcc.PimCategoryId,Case when pcc.PimProductId Is NULl THEN 0 ELSE 1 END IsAssociatedProduct
FROM ZnodePimProductAttributeDefaultValue ZPPADV
INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON (ZPPADV.PimAttributeDefaultValueId = ZPADV.PimAttributeDefaultValueId)
INNER JOIN ZnodePimAttributeValue a ON (a.PimAttributeValueId= ZPPADV.PimAttributeValueId)
INNER JOIN ZnodePimAttribute b ON (a.PimAttributeId= b.PimAttributeId)
LEFT JOIN ZnodePimCategoryProduct pcc ON (pcc.PimProductId = a.PimProductId)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPromotionAttributeValues')
	DROP PROC Znode_GetPromotionAttributeValues
GO

CREATE PROCEDURE [dbo].[Znode_GetPromotionAttributeValues]
(@DiscountTypeName Nvarchar(max))
AS
 /*  
     Summary : Get Promotion Attribute with their validation rule and control name 
    Unit Testing 
    Exec Znode_GetPromotionAttributeValues 'Amount Off Brand'
   
*/
     BEGIN
         BEGIN TRY
             DECLARE @TBL_Detailrecord TABLE
             (PromotionAttributeId INT,
              AttributeTypeId      INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              IsRequired           BIT,
              IsLocalizable        BIT,
              AttributeName        NVARCHAR(600),
              RowId                INT,
              ControlName          VARCHAR(300),
              ValidationName       VARCHAR(100),
              SubValidationName    VARCHAR(300),
              RegExp               VARCHAR(300),
              ValidationValue      VARCHAR(300),
			  HelpDescription	   VARCHAR(MAX),
              IsRegExp             BIT
             );
             -- temp table for temporary store value 

             INSERT INTO @TBL_Detailrecord (PromotionAttributeId,AttributeTypeId,AttributeTypeName,AttributeCode,IsRequired,IsLocalizable,AttributeName,RowId,ControlName,
			 ValidationName,SubValidationName,RegExp,ValidationValue,HelpDescription,IsRegExp)

             SELECT DISTINCT ZPA.PromotionAttributeId,ZPA.AttributeTypeId,ZAT.AttributeTypeName,ZPA.AttributeCode,ZPA.IsRequired,ZPA.IsLocalizable,ZPA.AttributeName,
			 ISNULL(NULL, 0) AS RowId,ZAIV.ControlName,ZAIV.Name AS ValidationName,ZAIVR.ValidationName AS SubValidationName,ZAIVR.RegExp,ZPAV.Name AS ValidationValue,
			 ZPA.HelpDescription,CAST(CASE WHEN ZAIVR.RegExp IS NULL THEN 0 ELSE 1 END AS BIT) AS IsRegExp FROM [dbo].[ZnodePromotionAttribute] AS ZPA
			 INNER JOIN [dbo].[ZnodePromotionDiscountAttributeMapper] ZPDAM ON(ZPDAM.PromotionAttributeId = ZPA.PromotionAttributeId)
			 LEFT OUTER JOIN [dbo].ZnodePromotionAttributeValidation AS ZPAV ON(ZPAV.PromotionAttributeId = ZPA.PromotionAttributeId)
			 LEFT OUTER JOIN [dbo].ZnodeAttributeType AS ZAT ON(ZPA.AttributeTypeId = ZAT.AttributeTypeId)
			 LEFT OUTER JOIN [dbo].ZnodeAttributeInputValidation AS ZAIV ON(ZPAV.InputValidationId = ZAIV.InputValidationId)
			 LEFT OUTER JOIN [dbo].ZnodeAttributeInputValidationRule AS ZAIVR ON(ZPAV.InputValidationRuleId = ZAIVR.InputValidationRuleId)
             WHERE  (ZPDAM.DiscountTypeName = @DiscountTypeName OR @DiscountTypeName = '')
		
             -- chnages for isconfigurable attribute 
             SELECT PromotionAttributeId,AttributeTypeId,AttributeTypeName,AttributeCode,IsRequired,IsLocalizable,AttributeName,RowId,ControlName,ValidationName,
             SubValidationName,HelpDescription,RegExp,ValidationValue,IsRegExp FROM @TBL_Detailrecord ORDER BY PromotionAttributeId;
		
         END TRY
         BEGIN CATCH
             DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPromotionAttributeValues @DiscountTypeName = '+CAST(@DiscountTypeName AS nvarchar(500));
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_GetPromotionAttributeValues',
                  @ErrorInProcedure = @ERROR_PROCEDURE,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
			END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';
		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'Customer'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 

		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	BIT	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;
				
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);

		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '88', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' and  exists
		(
			SELECT top 1 1 FROM  AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN ZnodeAccount ZA on  ZU.AccountId = ZA.AccountId
		WHERE ANZU.UserName = ii.UserName and  ZA.AccountCode != ii.AccountCode
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '92', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> '' and  ISNULL(LTRIM(RTRIM(ii.RoleName)),'') IN ('User','Manager','Administrator')
		AND EXISTS(SELECT * FROM ZnodeUser a INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				--INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)						
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				INNER JOIN AspNetRoles ZD on u.RoleId = zd.Id
				WHERE (ii.UserName = c.UserName) and ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> ZD.Name )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))
				

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, ANU.LockoutEndDateUtc = case when IC.IsActive = 0 then @GetDate when IC.IsActive = 1 then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= Isnull(IC.EmailOptIn,0),
				ZU.IsActive		= IC.IsActive,
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive = 0 then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
				
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,Isnull(IC.EmailOptIn,0),IC.IsActive,IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
				  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> ''
				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''

				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> ''
				
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, ZD.Id as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)
				AND isnull(IC.RoleName,'') <> ''


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF NOT EXISTS (	SELECT TOP 1 1 FROM ZnodePaymentSetting PS
			INNER JOIN ZnodePaymentGateway PG ON PS.PaymentGatewayId=PG.PaymentGatewayId
			WHERE PG.GatewayCode = 'paymentech')
BEGIN
	DELETE PS
	FROM ZnodePaymentSetting PS
	INNER JOIN ZnodePaymentGateway PG ON PS.PaymentGatewayId=PG.PaymentGatewayId
	WHERE PG.GatewayCode = 'paymentech'

	DELETE FROM ZnodePaymentGateway WHERE GatewayCode = 'paymentech'
END

GO

IF NOT EXISTS (	SELECT TOP 1 1 FROM ZnodePaymentSetting PS
			INNER JOIN ZnodePaymentGateway PG ON PS.PaymentGatewayId=PG.PaymentGatewayId
			WHERE PG.GatewayCode = 'stripe')
BEGIN
	DELETE PS
	FROM ZnodePaymentSetting PS
	INNER JOIN ZnodePaymentGateway PG ON PS.PaymentGatewayId=PG.PaymentGatewayId
	WHERE PG.GatewayCode = 'stripe'

	DELETE FROM ZnodePaymentGateway WHERE GatewayCode = 'stripe'
END

GO

IF NOT EXISTS (	SELECT TOP 1 1 FROM ZnodePaymentSetting PS
			INNER JOIN ZnodePaymentGateway PG ON PS.PaymentGatewayId=PG.PaymentGatewayId
			WHERE PG.GatewayCode = 'worldpay')
BEGIN
	DELETE PS
	FROM ZnodePaymentSetting PS
	INNER JOIN ZnodePaymentGateway PG ON PS.PaymentGatewayId=PG.PaymentGatewayId
	WHERE PG.GatewayCode = 'worldpay'

	DELETE FROM ZnodePaymentGateway WHERE GatewayCode = 'worldpay'
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = isnull(c.CatalogCode,'')) AND ISNULL(ii.RenameSynonymCode,'') = '' 

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.SynonymCode,'') LIKE '%[^a-zA-Z0-9]%')

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''
	AND exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.RenameSynonymCode,'') LIKE '%[^a-zA-Z0-9]%') and isnull(ii.RenameSynonymCode,'') <> ''
		
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False','Yes','No') AND ii.IsBidirectional <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '53', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
			   WHERE ii.SynonymCode IN
			   (
				   select SynonymCode from @InsertSearchSynonyms
					group by SynonymCode
					having count(1)>1
			   );

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '53', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
			   WHERE ii.RenameSynonymCode IN
			   (
				   select RenameSynonymCode from @InsertSearchSynonyms
					group by RenameSynonymCode
					having count(1)>1
			   );

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, CASE WHEN A.IsBidirectional = 'YES' THEN '1' WHEN A.IsBidirectional = 'NO' THEN '0' ELSE A.IsBidirectional END, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode)
		
	--Update existing search synonym 
	UPDATE ZSS 
	SET ZSS.SynonymCode = CASE WHEN ISNULL(IPS.RenameSynonymCode,'') <> '' THEN IPS.RenameSynonymCode ELSE ZSS.SynonymCode END , ZSS.OriginalTerm = CASE WHEN ISNULL(IPS.OriginalTerm,'') = '' THEN ZSS.OriginalTerm ELSE IPS.OriginalTerm END,
	ZSS.ReplacedBy =CASE WHEN ISNULL(IPS.ReplacedBy,'') = '' THEN ZSS.ReplacedBy ELSE IPS.ReplacedBy END,
	ZSS.IsBidirectional= CASE WHEN ISNULL (IPS.IsBidirectional,'') = '' THEN ZSS.IsBidirectional ELSE CASE WHEN IPS.IsBidirectional = 'YES' THEN '1' WHEN IPS.IsBidirectional = 'NO' THEN '0' ELSE IPS.IsBidirectional END END,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
	
	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemConfigurable]
(
	 @SaveCartLineItemType TT_SavecartLineitems READONLY
	,@Userid INT = 0 
	,@OrderLineItemRelationshipTypeIdConfigurable INT
	,@OrderLineItemRelationshipTypeIdAddon INT	
)
AS 
BEGIN 
	BEGIN TRY
	SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 

	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT, OmsSavedCartId INT,SKU NVARCHAr(max),GroupId NVARCHAr(max),ParentOmsSavedCartLineItemId INT,OrderLineItemRelationshipTypeId INT ) 
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,ConfigurableProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.ConfigurableProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)

	 CREATE TABLE #NewConfigSavecartLineitemDetails 
	 (
		 GenId INT IDENTITY(1,1), RowId	INT, OmsSavedCartLineItemId	INT, ParentOmsSavedCartLineItemId INT,OmsSavedCartId INT
		,SKU NVARCHAR(MAX) ,Quantity	NUMERIC(28,6), OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX), Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	 
	--Getting new save cart data(configurable product)
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5, GroupId ,ProductName,MIN(Description) Description, 0 Id,NULL ParentSKU 
	FROM @SaveCartLineItemType a 
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	 
	--Getting new configurable product save cart data
	INSERT INTO #NewConfigSavecartLineitemDetails 
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
		,Quantity, @OrderLineItemRelationshipTypeIdConfigurable, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU
	FROM @SaveCartLineItemType a 
	WHERE ConfigurableProductIds <> ''
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
		,Quantity, CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	--Getting new configurable products save cart data if addon is present for any line item
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> '' THEN ConfigurableProductIds
			WHEN GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END ParentSKU 
	FROM @SaveCartLineItemType a 
	WHERE AddOnValueIds <> ''
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
		 
	SELECT * 
	INTO #ZnodeOmsSavedCartLineItem_NT
	FROM ZnodeOmsSavedCartLineItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId)

	CREATE TABLE #OldConfigSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU NVARCHAr(2000),OrderLineItemRelationshipTypeID INT )
	--Getting the old configurable save cart data if present for same SKU in the new save cart data for configurable product	 
	INSERT INTO #OldConfigSavecartLineitemDetails
	SELECT a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU ,a.OrderLineItemRelationshipTypeID 
	FROM #ZnodeOmsSavedCartLineItem_NT a
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.ConfigurableProductIds,''))
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable

	--Getting the old save cart Parent data
	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-') )
		AND b.OrderLineItemRelationshipTypeID IS NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldConfigSavecartLineitemDetails

	DELETE a 
	FROM #OldConfigSavecartLineitemDetails a 
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		
	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN		
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
		FROM #ZnodeOmsSavedCartLineItem_NT b 
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT DISTINCT SKU, STUFF(
									( SELECT ', ' + SKU FROM
										( SELECT DISTINCT SKU FROM #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId AND OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a
		WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL AND OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.ConfigurableProductIds SKU, STUFF(
										( SELECT ', ' + x.AddOnValueIds FROM
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b ON a.SKU = b.SKU AND a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldConfigSavecartLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldConfigSavecartLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		DELETE FROM #OldConfigSavecartLineitemDetails 
	END
	ELSE 
	BEGIN
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		 BEGIN 
			 DECLARE @parenTofAddon TABLE( ParentOmsSavedCartLineItemId INT)
			 INSERT INTO @parenTofAddon 
			 SELECT ParentOmsSavedCartLineItemId 
			 FROM #OldConfigSavecartLineitemDetails a 
			 WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
				AND (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsSavedCartLineItem_NT t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon)

			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)
				AND ParentOmsSavedCartLineItemId IS NOT NULL 
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL 
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsSavedCartLineItem_NT WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
			-- SELECT 3
			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )

			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM #ZnodeOmsSavedCartLineItem_NT a
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

			DELETE 
			FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 
			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL
		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
		 BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 
		 ELSE IF EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItem_NT Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') = '' )
		 BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 
	END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present		
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		 DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			 SELECT OmsSavedCartLineItemId 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
				 OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
			 DELETE n
			 FROM #OldConfigSavecartLineitemDetails n 
			 WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem )
	
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
			 AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldConfigSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
		END 
	END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails )
	BEGIN
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.ConfigurableProductIds AS SKU
					,a.PersonalizeCode
			 		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		 
		INNER JOIN #OldConfigSavecartLineitemDetails b1 ON a1.SKU = b1.SKU
		INNER JOIN #OldConfigSavecartLineitemDetails c1 ON (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId AND a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		FROM CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldConfigSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldConfigSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldConfigSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate 
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewConfigSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon
		 
		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S ON a.OmsSavedCartId = s.OmsSavedCartId AND a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewConfigSavecartLineitemDetails N
	LEFT JOIN #OldConfigSavecartLineitemDetails O ON N.OmsSavedCartId=O.OmsSavedCartId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			 ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon 
			 ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description ,ParentSKU 
		INTO #InsertNewConfigSavecartLineitem 
		FROM #NewConfigSavecartLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId)
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails ,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU 
		ORDER BY RowId, Id 
 	 
		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewConfigSavecartLineitem 
		WHERE Quantity <=0 
 
		--Updating the rowid INTo new save cart line item as new line item is merged INTo existing save cart item
		 ;WITH VTTY AS 
		( 
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU 
			FROM #InsertNewConfigSavecartLineitem m 
			INNER JOIN #InsertNewConfigSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU 
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
		) 
		UPDATE m1 
		SET m1.RowId = TYU.RowId 
		FROM #InsertNewConfigSavecartLineitem m1 
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId) 
 
		;WITH VTRET AS 
		( 
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM #InsertNewConfigSavecartLineitem 
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			Having SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		) 
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET) 
 
	 --Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,Sequence,	CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description) 
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.OmsSavedCartId,inserted.SKU,inserted.GroupId,INSERTED.ParentOmsSavedCartLineItemId,INSERTED.OrderLineItemRelationshipTypeId INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId) sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description 
		FROM #InsertNewConfigSavecartLineitem TH 

		SELECT MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			 
	
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM #Cte_newData r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND a.ParentOmsSavedCartLineItemId IS nULL 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )

	---------------------------------------------------------------------------------------------------------------------

		SELECT MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData1 
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM #Cte_newData1 r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND a.sequence in (SELECT MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId AND 
			a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null ) 
 
	---------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId ,b.SKU ,b.ParentSKU ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewConfigProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1 )) 
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) ON b.sku = c.sku AND b.OmsSavedCartId=c.OmsSavedCartId AND b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0 )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) AND c.ParentOmsSavedCartLineItemId is null
 
		 ;WITH table_update AS 
		 (
			 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId ) RowIdNo
			 FROM ZnodeOmsSavedCartLineItem a with (nolock)
			 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND a.ParentOmsSavedCartLineItemId IS NULL 
			 AND EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			 AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		 )
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) 
		FROM table_update a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND b.id =1 ) 
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) IS nOT NULL 

		;WITH Cte_Th AS 
		( 
			 SELECT RowId 
			 FROM #InsertNewConfigSavecartLineitem a 
			 GROUP BY RowId 
			 HAVING COUNT(NewRowId) <= 1 
		) 
		UPDATE a 
		SET a.Quantity = NULL,a.ModifiedDate = @GetDate 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0) 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_Th TY WHERE TY.RowId = b.RowId ) 
			AND a.OrderLineItemRelationshipTypeId IS NULL 
 
		UPDATE ZnodeOmsSavedCartLineItem 
		SET GROUPID = NULL 
		WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId ) 
		AND OrderLineItemRelationshipTypeId IS NOT NULL 
 
		;WITH Cte_UpdateSequence AS 
		( 
			 SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence 
			 FROM ZnodeOmsSavedCartLineItem 
			 WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId ) 
		) 
		UPDATE Cte_UpdateSequence 
		SET Sequence = RowId 

		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.ConfigurableProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b with (nolock) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL 
	
		DELETE 
		FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
		
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			 ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			 WHEN NOT MATCHED THEN 
				INSERT ( OmsSavedCartLineItemId, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES ( SOURCE.OmsSavedCartLineItemId, @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	END
	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductTypeAttributesValue')
	DROP PROC Znode_GetProductTypeAttributesValue
GO

CREATE PROCEDURE [dbo].[Znode_GetProductTypeAttributesValue]
(
	@WhereClause	NVARCHAR(MAX),
	@Rows			INT = 100,
	@PageNo			INT = 1,
	@Order_BY		VARCHAR(100) = '',
	@RowsCount		INT OUT
)
AS
/*
	Summary :- This Procedure is used to get the AttributeCode='ProductType' and SelectValues.Value='Configurable Product'
	Unit Testig 
	EXEC Znode_GetProductTypeAttributesValue 'ProductType','',100,1,'',0
	EXEC Znode_GetProductTypeAttributesValue 'ProductType',null,100,1,'',0
*/
BEGIN 
	SET NOCOUNT ON;
	BEGIN TRY
		--SELECT * FROM ZnodePimAttributeDefaultValue
		IF (@WhereClause LIKE '%configurable%') AND (@WhereClause NOT LIKE '%Configurable Product%')
		BEGIN
			SET @WhereClause=REPLACE(@WhereClause,'configurable','Configurable Product')
		END
		ELSE IF (@WhereClause LIKE '%config%') AND (@WhereClause NOT LIKE '%Configurable Product%')
		BEGIN
			SET @WhereClause=REPLACE(@WhereClause,'config','Configurable Product')
		END
		ELSE IF (@WhereClause LIKE '%con%') AND (@WhereClause NOT LIKE '%Configurable Product%')
		BEGIN
			SET @WhereClause=REPLACE(@WhereClause,'con','Configurable Product')
		END
		ELSE IF (@WhereClause LIKE '%simple%') AND (@WhereClause NOT LIKE '%Simple Product%')
		BEGIN
			SET @WhereClause=REPLACE(@WhereClause,'simple','Simple Product')
		END
		ELSE IF (@WhereClause LIKE '%grouped%') AND (@WhereClause NOT LIKE '%Grouped Product%')
		BEGIN
			SET @WhereClause=REPLACE(@WhereClause,'grouped','Grouped Product')
		END
		ELSE IF (@WhereClause LIKE '%group product%') AND (@WhereClause NOT LIKE '%Grouped Product%')
		BEGIN
			SET @WhereClause=REPLACE(@WhereClause,'group','Grouped')
		END
		ELSE IF (@WhereClause LIKE '%group%') AND (@WhereClause NOT LIKE '%Grouped Product%')
		BEGIN
			SET @WhereClause=REPLACE(@WhereClause,'group','Grouped Product')
		END
		ELSE IF (@WhereClause LIKE '%bundle%') AND (@WhereClause NOT LIKE '%Bundle Product%')
		BEGIN
			SET @WhereClause=REPLACE(@WhereClause,'bundle','Bundle Product')
		END
		--PRINT @WhereClause
		DECLARE @SQL NVARCHAR(MAX);--ZnodePublishProductEntity

		DECLARE @TBL_ZnodePublishProductEntity TABLE
		(PublishProductEntityId INT, VersionId INT, IndexId VARCHAR(300), ZnodeProductId INT, ZnodeCatalogId INT,
			SKU VARCHAR(300), LocaleId INT, [Name] VARCHAR(300), ZnodeCategoryIds INT, IsActive BIT,
			Attributes NVARCHAR(MAX), Brands NVARCHAR(MAX), CategoryName VARCHAR(300), CatalogName VARCHAR(300),
			DisplayOrder INT, RevisionType VARCHAR(50), AssociatedProductDisplayOrder INT, ProductIndex INT,
			SalesPrice VARCHAR(50), RetailPrice VARCHAR(50), CultureCode VARCHAR(50), CurrencySuffix VARCHAR(50),
			CurrencyCode VARCHAR(50), SeoDescription VARCHAR(1000), SeoKeywords VARCHAR(1000),
			SeoTitle VARCHAR(1000), SeoUrl VARCHAR(1000), ImageSmallPath VARCHAR(500), SKULower VARCHAR(50),
			RowId INT ,CountId INT
		)
		SET @SQL = '
		;With Cte_ZnodePublishProductEntity
		AS
		(
		SELECT PPE.PublishProductEntityId,PPE.VersionId,PPE.IndexId,PPE.ZnodeProductId,PPE.ZnodeCatalogId,PPE.SKU,
			PPE.LocaleId,PPE.[Name],PPE.ZnodeCategoryIds,PPE.IsActive,PPE.Attributes,PPE.Brands,PPE.CategoryName,
			PPE.CatalogName,PPE.DisplayOrder,PPE.RevisionType,PPE.AssociatedProductDisplayOrder,PPE.ProductIndex,
			PPE.SalesPrice,PPE.RetailPrice,PPE.CultureCode,PPE.CurrencySuffix,PPE.CurrencyCode,PPE.SeoDescription,
			PPE.SeoKeywords,PPE.SeoTitle,PPE.SeoUrl,PPE.ImageSmallPath,PPE.SKULower,PPAJ.AttributeCode
		FROM dbo.ZnodePublishProductEntity PPE WITH (NOLOCK)
		INNER JOIN ZnodePublishProduct PP WITH (NOLOCK) ON PPE.ZnodeProductId=PP.PublishProductId
			AND PPE.ZnodeCatalogId=PP.PublishCatalogId
		INNER JOIN ZnodePublishProductAttributeJson PPAJ WITH (NOLOCK) ON PP.PimProductId=PPAJ.PimProductId
		)

		,Cte_ZnodePublishProductEntity1
		AS (
		SELECT PublishProductEntityId,VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,
			LocaleId,[Name],ZnodeCategoryIds,IsActive,Attributes,Brands,CategoryName,
			CatalogName,DisplayOrder,RevisionType,AssociatedProductDisplayOrder,ProductIndex,
			SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,
			SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,
		'+[dbo].[Fn_GetPagingRowId](@Order_BY,'PublishProductEntityId DESC')+',COUNT(*) OVER() CountId
		FROM Cte_ZnodePublishProductEntity
		WHERE 1=1 '+[dbo].[Fn_GetFilterWhereClause](@WhereClause)+')

		SELECT DISTINCT PublishProductEntityId,VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,[Name],
			ZnodeCategoryIds,IsActive,Attributes,Brands,CategoryName,CatalogName,DisplayOrder,RevisionType,
			AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix,
			CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower,RowId,CountId
		FROM Cte_ZnodePublishProductEntity1 
		'+[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)+' '
	
		PRINT @sql
		INSERT INTO @TBL_ZnodePublishProductEntity
		EXEC (@SQL)

		SELECT PublishProductEntityId,VersionId,IndexId,ZnodeProductId,ZnodeCatalogId,SKU,LocaleId,[Name],
			ZnodeCategoryIds,IsActive,Attributes,Brands,CategoryName,CatalogName,DisplayOrder,RevisionType,
			AssociatedProductDisplayOrder,ProductIndex,SalesPrice,RetailPrice,CultureCode,CurrencySuffix,
			CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower
		FROM @TBL_ZnodePublishProductEntity

		SET @RowsCount = ISNULL((SELECT TOP 1 CountId FROM @TBL_ZnodePublishProductEntity),0)
	END TRY
	BEGIN CATCH
	DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(),
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(),
				@ErrorLine VARCHAR(100)= ERROR_LINE(), 
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetProductTypeAttributesValue @WhereClause = '''+ISNULL(@WhereClause,'''''')
					+''',@Rows='+ISNULL(CAST(@Rows AS VARCHAR(50)),'''''')+',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')
					+',@Order_BY='''+ISNULL(@Order_BY,'''''')+''',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')

		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

		EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetProductTypeAttributesValue',
				@ErrorInProcedure = 'Znode_GetProductTypeAttributesValue',
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_DeleteBrand')
	DROP PROC Znode_DeleteBrand
GO

CREATE  PROCEDURE [dbo].[Znode_DeleteBrand]
( @BrandId VARCHAR(2000) = '',
  @Status  BIT OUT,
  @BrandIds TransferId READONLY	,
  @IsDebug bit = 0 )
AS
 /*   
     Summary: Delete brand detail  
			  This procdure will delete brands if is associated with product or not 
			  here is no any check for association as per requirement 
			  Delete table sequence 
			  1.ZnodeBrandDetails
			  SELECT * FROM ZnodeBRandDetails
     Unit Testing  
			  begin tran 
			  EXEC Znode_DeleteBrand 17,1
			  rollback tran
   */
     BEGIN
         BEGIN TRAN DeleteBrand;
         BEGIN TRY
             SET NOCOUNT ON;
			 -- table use to hold the brand id 
             DECLARE @TBL_DeletdBrandId TABLE(BrandId INT, BrandCode NVARCHAR(1200)); 
             DECLARE @TBL_CMSSEODetailId TABLE(CMSSEODetailId INT);
             DECLARE @TBL_DeletedBrands TABLE(BrandId INT);
			 DECLARE @FinalCount INT = 0  

             INSERT INTO @TBL_DeletdBrandId
					SELECT a.BrandId , a.BrandCode
					FROM ZnodeBrandDetails a
					INNER JOIN dbo.split(@BrandId, ',') AS SP ON (a.BrandId = SP.Item)
					WHERE  @BrandId <> ''


			 INSERT INTO @TBL_DeletdBrandId (BrandId)
			   SELECT Id 
			   FROM @BrandIds


             INSERT INTO @TBL_CMSSEODetailId(CMSSEODetailId)
                    SELECT CMSSEODetailId
                    FROM ZnodeCMSSEODetail ZCSD
                         INNER JOIN ZnodeCMSSEOType ZST ON(ZCSD.CMSSEOTypeId = ZST.CMSSEOTypeId)
                    WHERE ZST.Name = 'Brand'
                          AND EXISTS
                    (
                        SELECT TOP 1 1
                        FROM @TBL_DeletdBrandId TBDB
                        WHERE TBDB.BrandCode = ZCSD.SEOCode
                    );

			Delete from ZnodePromotionBrand where  EXISTS
                    (
                        SELECT TOP 1 1
                        FROM @TBL_DeletdBrandId TBDB
                        WHERE TBDB.BrandId = ZnodePromotionBrand.BrandId
                    );
			 Delete from ZnodeCMSWidgetBrand  where  EXISTS
                    (
                        SELECT TOP 1 1
                        FROM @TBL_DeletdBrandId TBDB
                        WHERE TBDB.BrandId = ZnodeCMSWidgetBrand.BrandId
                    );
             DELETE FROM ZnodeCMSSEODetailLocale
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_CMSSEODetailId TBCSO
                 WHERE TBCSO.CMSSEODetailId = ZnodeCMSSEODetailLocale.CMSSEODetailId
             );
             DELETE FROM ZnodeCMSSEODetail
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_CMSSEODetailId TBCSO
                 WHERE TBCSO.CMSSEODetailId = ZnodeCMSSEODetail.CMSSEODetailId
             );

			  DELETE FROM ZnodeBrandPortal
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletdBrandId AS TBDA
                 WHERE TBDA.BrandId = ZnodeBrandPortal.BrandId
             );

			 DELETE FROM ZnodePortalBrand
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletdBrandId AS TBDA
                 WHERE TBDA.BrandId = ZnodePortalBrand.BrandId
             );

			  DELETE FROM ZnodeBrandProduct
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletdBrandId AS TBDA
                 WHERE TBDA.BrandId = ZnodeBrandProduct.BrandId
             );


             DELETE FROM ZnodeBrandDetailLocale
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletdBrandId AS TBDA
                 WHERE TBDA.BrandId = ZnodeBrandDetailLocale.BrandId
             );
             DELETE FROM ZnodeBrandDetails
             OUTPUT DELETED.BrandId
                    INTO @TBL_DeletedBrands
             WHERE EXISTS
             (
                 SELECT TOP 1 1
                 FROM @TBL_DeletdBrandId AS TBDA
                 WHERE TBDA.BrandId = ZnodeBrandDetails.BrandId
             );


			 SET @FinalCount = (	SELECT COUNT(1)
							FROM dbo.split( @BrandId, ',' ) AS a   WHERE @BrandId <> '' 
							)
			SET @FinalCount = CASE WHEN @FinalCount = 0 THEN  (	SELECT COUNT(1)
							FROM @BrandIds AS a
							)	ELSE @FinalCount END


             IF
             (
                 SELECT COUNT(1)
                 FROM @TBL_DeletedBrands
             ) = @FinalCount
              -- check statement if count is equal the data set return true aother wise false 
                 BEGIN
                     SELECT 1 AS ID,
                            CAST(1 AS BIT) AS Status;
                     SET @Status = 1;
                 END;
             ELSE
                 BEGIN
                     SELECT 0 AS ID,
                            CAST(0 AS BIT) AS Status;
                     SET @Status = 0;
                 END;
             COMMIT TRAN DeleteBrand;
         END TRY
         BEGIN CATCH
             DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_DeleteBrand @BrandId = '+@BrandId+',@Status='+CAST(@Status AS VARCHAR(50));
             SELECT 0 AS ID,
        CAST(0 AS BIT) AS Status,ERROR_MESSAGE();
             SET @Status = 0;
             ROLLBACK TRAN DeleteBrand;
             EXEC Znode_InsertProcedureErrorLog
                  @ProcedureName = 'Znode_DeleteBrand',
                  @ErrorInProcedure = @Error_procedure,
                  @ErrorMessage = @ErrorMessage,
                  @ErrorLine = @ErrorLine,
                  @ErrorCall = @ErrorCall;
         END CATCH;
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductTypeAttributesValue')
	DROP PROC Znode_GetProductTypeAttributesValue
GO


delete from [ZnodePimFamilyGroupMapper]
where PimAttributeFamilyId = (select TOP 1 PimAttributeFamilyId from ZnodePimAttributeFamily WHERE FamilyCode = 'DefaultCategory') 
AND PimAttributeGroupId in (SELECT PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode IN ('ProductSetting','ShippingSettings'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSetting')
	DROP PROC Znode_GetPaymentSetting
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSetting]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSetting @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),
										PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT,PaymentDisplayName nvarchar(1200),
										PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),
										IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50),IsUsedForWebStorePayment BIT )


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSetting @PortalIds,@ProfileIds,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState , ZPPS.IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 WHERE  ISNULL(ZPPS.IsUsedForWebStorePayment,0) =  CASE WHEN '+CAST(@IsAssociated AS VARCHAR(10)) +' = 1 THEN  1  ELSE 0 END
				 )

				 '
	 --IF @userId <> 0 
	 --BEGIN 
		--SET @IsAssociated = 1  	
	 --END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50))
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, CASE WHEN ZPPS.ProfilePaymentSettingId IS NULL THEN 0 ELSE 1 END IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState , 0 AS IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))+'
									AND  IsAssociated = '+CAST(@IsAssociated AS VARCHAR(50))+CASE WHEN @FilterWhereClause = '' THEN ' ' ELSE @FilterWhereClause END 
	  SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, NULL IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState , 0 AS IsUsedForWebStorePayment
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment,RowId ,CountNo
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,
						IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,
						PortalPaymentGroupId,PublishState,IsUsedForWebStorePayment,RowID,CountNo)
	 EXEC (@SQL)

	 
	  
	IF @IsAssociated = 1 AND @ProfileId = 0
	BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForWebStorePayment,0) = 1
		 ORDER BY RowID,DisplayOrder
		 SET @RowsCount = ISNULL((SELECT Count(*) FROM @TBL_PaymentSetting WHERE ISNULL(IsUsedForWebStorePayment,0) = 1),0)
	END
	ELSE
	BEGIN
		SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForWebStorePayment,0) = 0
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT Count(*) FROM @TBL_PaymentSetting WHERE ISNULL(IsUsedForWebStorePayment,0) = 0),0)
	END


  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSetting @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSetting',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
  END CATCH
 END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingForOfflinePayment')
	DROP PROC Znode_GetPaymentSettingForOfflinePayment
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingForOfflinePayment]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT
										,PaymentDisplayName nvarchar(1200),PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50), IsUsedForOfflinePayment BIT,Code VARCHAR(100))


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSettingForOfflinePayment @PortalIds,0,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 



	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 WHERE  ISNULL(ZPPS.IsUsedForOfflinePayment,0) =  CASE WHEN '+CAST(@IsAssociated AS VARCHAR(10)) +' = 1 THEN  1  ELSE 0 END
				 
				 )

				 '
	 --IF @userId <> 0 
	 --BEGIN 
		--SET @IsAssociated = 1  	
	 --END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50)) 
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName,0 as IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))
	   SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, 0 IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment ,ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo,IsUsedForOfflinePayment, Code

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowId ,CountNo, IsUsedForOfflinePayment, Code
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowID,CountNo,IsUsedForOfflinePayment,Code)
	 EXEC (@SQL)

	 IF @IsAssociated = 1 
	 BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,isnull(IsUsedForOfflinePayment,0) as IsUsedForOfflinePayment  
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForOfflinePayment,0) = 1
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE  ISNULL(IsUsedForOfflinePayment,0) = 1),0)
	END
	ELSE 
	BEGIN
	
		SELECT PaymentSettingId,PaymentApplicationSettingId,PS.PaymentTypeId,PaymentGatewayId,PaymentName,PS.IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,PS.CreatedBy,PS.CreatedDate,PS.ModifiedBy,PS.ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, 
							PaymentCode, GatewayCode,PS.IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,ISNULL(PS.IsUsedForOfflinePayment,0)IsUsedForOfflinePayment
		 FROM @TBL_PaymentSetting PS
		 WHERE (Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')	AND ISNULL(IsUsedForOfflinePayment,0) = 0)	
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT COUNT(*) FROM @TBL_PaymentSetting WHERE (Code IN ('CREDITCARD','AUTOMATEDCLEARINGHOUSE')	AND ISNULL(IsUsedForOfflinePayment,0) = 0)),0)
	END

  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSettingForOfflinePayment',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
  END CATCH
 END

GO

update ZnodePortalPaymentSetting set IsUsedForWebStorePayment = 1
update ZnodePortalPaymentSetting set IsUsedForOfflinePayment = 0 where IsUsedForOfflinePayment is null 

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_PostSubmitOrderProcess')
	DROP PROC Znode_PostSubmitOrderProcess
GO

CREATE PROCEDURE [dbo].[Znode_PostSubmitOrderProcess]
(
	@PostOrderXml XML,
	@InventoryData XML,
	@UserId INT,
	@PortalId INT = 0,
	@Status BIT OUT
)
AS
BEGIN
BEGIN TRY
--BEGIN TRAN PostOrder
	DECLARE @OmsOrderDetailsId INT
	DECLARE @OmsOrderId INT = (SELECT Tbl.Col.value( 'OrderID[1]', 'NVARCHAR(2000)' ) AS OrderId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsGuest BIT = (SELECT Tbl.Col.value( 'IsGuest[1]', 'NVARCHAR(2000)' ) AS IsGuest FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))

	DECLARE @OmsCookieMappingId INT = (SELECT Tbl.Col.value( 'CookieMappingId[1]', 'NVARCHAR(2000)' ) AS CookieMappingId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @BillingAddressId INT = (SELECT Tbl.Col.value( 'BillingAddressId[1]', 'NVARCHAR(2000)' ) AS BillingAddressId FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	DECLARE @IsReferralCommission BIT = (SELECT Tbl.Col.value( 'IsReferralCommission[1]', 'NVARCHAR(2000)' ) AS IsReferralCommission FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	DECLARE @CommissionAmount NUMERIC(26,6) = (SELECT Tbl.Col.value( 'CommissionAmount[1]', 'NVARCHAR(2000)' ) AS CommissionAmount FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col))
	
	SET @OmsOrderDetailsId = (SELECT OmsOrderDetailsId from ZnodeOmsOrderDetails WHERE OmsOrderId = @OmsOrderId AND IsActive = 1)
	DECLARE @SetBillingShippingFlags BIT = (SELECT Tbl.Col.value( 'SetBillingShippingFlags[1]', 'NVARCHAR(2000)' ) AS SetBillingShippingFlags FROM @PostOrderXml.nodes('//PostOrderSubmitModel') AS Tbl(Col)) 
	DECLARE @GetDate DATETIME = GETDATE()
	
	--Fetching required user details 
	DECLARE @ReferralCommissionTypeId INT, @ReferralCommission NUMERIC(28,6) , @FirstName VARCHAR(100),@LastName VARCHAR(100)
	SELECT @FirstName = FirstName,@LastName = LastName, @ReferralCommission = CASE WHEN ReferralCommission IS NULL THEN 0 ELSE ReferralCommission END, @ReferralCommissionTypeId = ReferralCommissionTypeId
	FROM ZnodeUser WITH (NOLOCK) 
	WHERE UserId = @UserId
	
	---Voucher model fetch
	CREATE TABLE #TempVoucher
	(
		VoucherBalance NUMERIC(28,6),VoucherNumber NVARCHAR(600),VoucherMessage NVARCHAR(MAX),IsVoucherValid BIT,
		IsVoucherApplied BIT,VoucherAmountUsed NUMERIC(28,6),VoucherName NVARCHAR(600),ExpirationDate DATETIME,
		CultureCode NVARCHAR(600),PortalId INT,IsExistInOrder BIT,UserId INT,IsActive BIT,OrderVoucherAmount NUMERIC(28,6)
	)

	INSERT INTO #TempVoucher
	(
		VoucherBalance ,VoucherNumber,VoucherMessage ,IsVoucherValid ,
		IsVoucherApplied ,VoucherAmountUsed ,VoucherName ,ExpirationDate ,
		CultureCode ,PortalId ,IsExistInOrder ,UserId ,IsActive ,OrderVoucherAmount 
	)
	SELECT Tbl.Col.value( 'VoucherBalance[1]', 'NVARCHAR(2000)' ) AS VoucherBalance,
		Tbl.Col.value( 'VoucherNumber[1]', 'NVARCHAR(2000)' ) AS VoucherNumber,
		Tbl.Col.value( 'VoucherMessage[1]', 'NVARCHAR(2000)' ) AS VoucherMessage,
		Tbl.Col.value( 'IsVoucherValid[1]', 'NVARCHAR(2000)' ) AS IsVoucherValid,
		Tbl.Col.value( 'IsVoucherApplied[1]', 'NVARCHAR(2000)' ) AS IsVoucherApplied,
		Tbl.Col.value( 'VoucherAmountUsed[1]', 'NVARCHAR(2000)' ) AS VoucherAmountUsed,
		Tbl.Col.value( 'VoucherName[1]', 'NVARCHAR(2000)' ) AS VoucherName,
		Tbl.Col.value( 'ExpirationDate[1]', 'NVARCHAR(2000)' ) AS ExpirationDate,
		Tbl.Col.value( 'CultureCode[1]', 'NVARCHAR(2000)' ) AS CultureCode,
		Tbl.Col.value( 'PortalId[1]', 'NVARCHAR(2000)' ) AS PortalId,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,
		Tbl.Col.value( 'UserId[1]', 'NVARCHAR(2000)' ) AS UserId,	
		Tbl.Col.value( 'IsActive[1]', 'NVARCHAR(2000)' ) AS IsActive,
		Tbl.Col.value( 'OrderVoucherAmount[1]', 'NVARCHAR(2000)' ) AS OrderVoucherAmount
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Vouchers/VoucherModel') AS Tbl(Col)


	----Promotion coupon start
	DECLARE @TempPromotionCoupon DBO.PromotionCoupons

	INSERT INTO @TempPromotionCoupon
	SELECT Tbl.Col.value( 'Code[1]', 'NVARCHAR(2000)' ) AS Code,
		Tbl.Col.value( 'IsExistInOrder[1]', 'NVARCHAR(2000)' ) AS IsExistInOrder,@OmsOrderId AS OmsOrderId
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/Coupons/CouponModel') AS Tbl(Col)

	--Deduct promotion coupon count
	EXEC [Znode_PromotionCouponDeduct] @PromotionCoupons = @TempPromotionCoupon
	----Promotion coupon END
	
	--Deduct inventory quantity
	EXEC [Znode_UpdateInventoryPostOrder] @SkuXml = @InventoryData,@PortalId = @PortalId, @UserId= @UserId,@OmsOrderId=@OmsOrderId,@Status = 0

	----Voucher start
	IF EXISTS(SELECT * FROM #TempVoucher)
	BEGIN
		INSERT INTO ZnodeGiftCardHistory(GiftCardId,TransactionDate,TransactionAmount,OmsOrderDetailsId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,Notes,RemainingAmount)
		SELECT GC.GiftCardId, @GetDate, VoucherAmountUsed,@OmsOrderDetailsId,@UserId, @GetDate, @UserId, @GetDate, 'Voucher is used to make payments for the order' as Notes, NULL AS RemainingAmount
		FROM #TempVoucher V
		INNER JOIN ZnodeGiftCard GC WITH (NOLOCK) ON V.VoucherNumber = GC.CardNumber

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('TRUE','1'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = V.VoucherBalance
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('TRUE','1')
		END

		IF EXISTS(SELECT * FROM #TempVoucher WHERE IsExistInOrder IN ('FALSE','0'))
		BEGIN
			UPDATE GC SET GC.RemainingAmount = GC.RemainingAmount - V.VoucherAmountUsed
			FROM #TempVoucher V
			INNER JOIN ZnodeGiftCard GC ON V.VoucherNumber = GC.CardNumber
			WHERE IsExistInOrder IN ('FALSE','0')
		END
	END
	----Voucher end
	
	--Update user details
	IF @FirstName IS NULL
	BEGIN
		DECLARE @FirstName1 VARCHAR(300), @LastName1 VARCHAR(300), @PhoneNumber VARCHAR(300)
		SELECT @FirstName1=FirstName, @LastName1 = LastName, @PhoneNumber=PhoneNumber
		FROM ZnodeAddress WITH (NOLOCK)  WHERE AddressId = @BillingAddressId

		UPDATE ZnodeUser 
		SET FirstName = @FirstName, LastName = @LastName, PhoneNumber = @PhoneNumber
		WHERE UserId = @UserId
	END

	--Update address details
	IF @SetBillingShippingFlags IN ('TRUE','1')
	BEGIN
		UPDATE ZnodeAddress
		SET IsBilling = 1, IsShipping = 1
		WHERE AddressId = @BillingAddressId
	END

	--ReferralCommission details
	IF @IsReferralCommission IN ('TRUE','1')
	BEGIN
		INSERT INTO ZnodeOmsReferralCommission
		(
			UserId,OmsOrderDetailsId,OrderCommission,TransactionId,Description,ReferralCommission,ReferralCommissionTypeId
			,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
		)
		SELECT @UserId,@OmsOrderDetailsId,CASE WHEN @ReferralCommissionTypeId =1 THEN ((@CommissionAmount * ISNULL(@ReferralCommission,0)) / 100) ELSE @ReferralCommission END AS OrderCommission,'' AS TransactionId,'' AS Description,@ReferralCommission,@ReferralCommissionTypeId
			,@UserId,@GetDate,@UserId,@GetDate
	END
	
	---OmsTaxOrderSummary details
	IF EXISTS(SELECT * FROM ZnodeOmsTaxOrderSummary WITH (NOLOCK)  WHERE OmsOrderDetailsId = @OmsOrderDetailsId)
	BEGIN
		DELETE FROM ZnodeOmsTaxOrderSummary WHERE OmsOrderDetailsId = @OmsOrderDetailsId
	END

	INSERT INTO ZnodeOmsTaxOrderSummary (OmsOrderDetailsId,Tax,Rate,TaxName,TaxTypeName)
	SELECT 	@OmsOrderDetailsId AS OmsOrderDetailsId,
		Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) AS Tax,
		Tbl.Col.value( 'Rate[1]', 'NVARCHAR(2000)' ) AS Rate,
		Tbl.Col.value( 'TaxName[1]', 'NVARCHAR(2000)' ) AS TaxName,
		Tbl.Col.value( 'TaxTypeName[1]', 'NVARCHAR(2000)' ) AS TaxTypeName
	FROM @PostOrderXml.nodes('//PostOrderSubmitModel/TaxSummaryList/TaxSummaryModel') AS Tbl(Col)
	WHERE Tbl.Col.value( 'Tax[1]', 'NVARCHAR(2000)' ) IS NOT NULL
	--------

	--Remove 
	EXEC [Znode_DeleteSavedCartItem] @OmsCookieMappingId = @OmsCookieMappingId, @UserId = @UserId,@PortalId = @PortalId,@Status = 0  

	SET @Status = 1
	--COMMIT TRAN PostOrder
END TRY
BEGIN CATCH
--ROLLBACK TRAN PostOrder
	SET @Status = 0
	
	DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
	@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_PostSubmitOrderProcess @PostOrderXml ='+CAST(@PostOrderXml AS VARCHAR(MAX))+' , @InventoryData = '+CAST(@InventoryData AS VARCHAR(50))+',@UserId ='+CAST(@UserId AS VARCHAR(50))+',@PortalId ='+CAST(@PortalId AS VARCHAR(50))+',@Status ='+CAST(@Status AS VARCHAR(50));
	
	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName    = 'Znode_PostSubmitOrderProcess',
	@ErrorInProcedure = @ERROR_PROCEDURE,
	@ErrorMessage     = @ErrorMessage,
	@ErrorLine        = @ErrorLine,
	@ErrorCall        = @ErrorCall;
END CATCH

END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPaymentSettingForOfflinePayment')
	DROP PROC Znode_GetPaymentSettingForOfflinePayment
GO

CREATE PROCEDURE [dbo].[Znode_GetPaymentSettingForOfflinePayment]
(
  @WhereClause  NVARCHAR(Max)  = '',
  @Rows         INT            = 100,
  @PageNo       INT            = 1,
  @Order_BY     VARCHAR(1000)  = ' DisplayOrder ASC',
  @RowsCount    INT OUT            ,
  @PortalId     INT            = 0 ,
  @ProfileId    INT            = 0 ,
  @UserId       INT			   = 0 ,
  @IsAssociated INT            = 0
)
AS
 /*
   Summary :- This procedure is used to get the associated and Unassociated list of paymentsetting for portal and profile

   Unit Testing

   DECLARE @profilei int = 0
   EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '', @RowsCount =  @profilei OUT ,@PortalId = 0 ,@ProfileId= 0 ,@IsAssociated = 0 ,@UserId= 0  SELECT  @profilei

 */
 BEGIN
  BEGIN TRY
   SET NOCOUNT ON
     DECLARE @SQL NVARCHAR(MAX)= '',@FilterWhereClause VARCHAR(2000) = '' ,@InternalOrderBy VARCHAR(2000)= ''

	 DECLARE @TBL_PaymentSetting TABLE (PaymentSettingId INT, PaymentApplicationSettingId INT,PaymentTypeId INT,PaymentGatewayId INT
										,PaymentName VARCHAR(600),IsActive BIT,DisplayOrder INT,IsTestMode BIT,IsPoDocUploadEnable BIT
										,IsPoDocRequire BIT,CreatedBy INT,CreatedDate DATETIME,ModifiedBy INT,ModifiedDate DATETIME
										,PortalId INT,StoreName NVARCHAR(max),IsAssociated BIT,ProfileId int,ProfileName NVARCHAR(200),PaymentTypeName VARCHAr(500),GatewayName VARCHAR(300),RowId INT,CountNo INT
										,PaymentDisplayName nvarchar(1200),PaymentExternalId VARCHAR(100),IsApprovalRequired BIT,PaymentCode VARCHAR(200),GatewayCode VARCHAR(200),IsCallToPaymentAPI BIT,IsBillingAddressOptional Bit,IsOABRequired BIT,PortalPaymentGroupId INT,PublishState VARCHAR(50), IsUsedForOfflinePayment BIT,Code VARCHAR(100))


     IF ISNULL(@UserId,0) <> 0  OR (ISNULL(@PortalId,0) > 0 AND ISNULL(@ProfileId,0) > 0)
	 BEGIN
	  DECLARE  @PortalIds VARCHAR(2000) = '' ,@ProfileIds VARCHAR(2000) = '' ,@PaymentSettingIds VARCHAR(2000)
	  IF ISNULL(@UserId,0) <> 0
	  BEGIN
	  SET @PortalIds = @PortalId
	  EXEC Znode_GetUserPortalAndProfile @UserId ,@PortalIds OUT,@ProfileIds OUT
	  END
	  ELSE
	  BEGIN
	   SET @PortalIds = @PortalId
	   SET @ProfileIds = @ProfileId

	  END
	  SET @ProfileIds = CASE WHEN CAST(@ProfileId AS VARCHAr(200))  <= '0' THEN @ProfileIds ELSE CAST(@ProfileId AS VARCHAr(200)) END 
	  EXEC Znode_GetCommonPaymentSettingForOfflinePayment @PortalIds,0,@PaymentSettingIds OUT

	  SET @FilterWhereClause = ' AND  PaymentSettingId IN ('+ISNULL(@PaymentSettingIds,'0')+') '

	 END

	 SELECT PaymentSettingId ,ZPPG.PortalPaymentGroupId,ZPA.PortalId 
	 INTO #ZnodePortalPaymentApprovers
	 FROM ZnodePortalPaymentApprovers ZPPA 
	 INNER JOIN [ZnodePortalPaymentGroup] ZPPG ON( ZPPA.PortalPaymentGroupId = ZPPG.PortalPaymentGroupId)  
     INNER JOIN [ZnodePortalApproval] ZPA ON (ZPA.PortalApprovalId = ZPPG.PortalApprovalId) 
	 WHERE  ZPA.EnableApprovalManagement =1 AND ZPA.PortalId = @PortalId AND ZPPG.isActive = 1 

	 IF @IsAssociated = 0
	 BEGIN
		SET @WhereClause = @WhereClause+CASE WHEN @WhereClause = '' THEN ' Code IN (''CREDITCARD'',''AUTOMATEDCLEARINGHOUSE'')' ELSE ' AND Code IN (''CREDITCARD'',''AUTOMATEDCLEARINGHOUSE'')' END
	 END

	IF ISNULL(@PortalId,0) > 0 AND (   ISNULL(@ProfileId,0) = 0)
	BEGIN
	 SET @SQL = '
	             ;With Cte_PaymentSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ZPS.DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,ZP.PortalId,ZP.StoreName, 0 as IsAssociated, NULL ProfileId, NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						, CASE WHEN ZPPS.PaymentDisplayName IS NULL OR ZPPS.PaymentDisplayName = ''''  THEN ZPS.PaymentDisplayName ELSE ZPPS.PaymentDisplayName END   PaymentDisplayName,  ZPPS.PaymentExternalId ,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,ISNULL(ZPS.IsOABRequired,0) IsOABRequired
						 ,YU.PortalPaymentGroupId, ZPPOS.DisplayName PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodePortal ZP
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS on ( ZPPS.PortalId = ZP.PortalId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId )
				 WHERE  ISNULL(ZPPS.IsUsedForOfflinePayment,0) =  CASE WHEN '+CAST(@IsAssociated AS VARCHAR(10)) +' = 1 THEN  1  ELSE 0 END
				 
				 )

				 '
	 --IF @userId <> 0 
	 --BEGIN 
		--SET @IsAssociated = 1  	
	 --END 
	 
	 SET @FilterWhereClause = ' WHERE PortalId = '+CAST(@PortalId AS VARCHAR(50)) 
	 SET @InternalOrderBy = ' PaymentSettingId,PortalId '
    END
	ELSE IF ISNULL(@ProfileId,0) > 0 AND ( ISNULL(@UserId,0) = 0 AND  ISNULL(@PortalId,0) = 0)
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT  ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,CASE WHEN '+CAST(@ProfileId AS VARCHAR(200))+' >= 0 AND '+CAST(@IsAssociated AS VARCHAR(200))+' = 1 THEN ISNULL(ZPPS.DisplayOrder,ZPS.DisplayOrder) ELSE ZPS.DisplayOrder END AS DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName,0 as IsAssociated ,ZP.ProfileId,ZP.ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName
						,ZPS.PaymentDisplayName	, NULL PaymentExternalId,
						 CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired  , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI, ZPS.IsBillingAddressOptional,0 IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment, ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId)
				 CROSS APPLY ZnodeProfile ZP
				 LEFT JOIN ZnodeProfilePaymentSetting ZPPS on ( ZPPS.ProfileId = ZP.ProfileId AND ZPPS.PaymentSettingId = ZPS.PaymentSettingId)
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = ZPPS.PublishStateId)
				 )
               '
	   SET @FilterWhereClause = ' WHERE ProfileId = '+CAST(@ProfileId AS VARCHAR(50))
	   SET @InternalOrderBy = ' PaymentSettingId,ProfileId '
	END
	ELSE
	BEGIN
	  SET @SQL = '
	            ;With Cte_PaymenTSetting AS
				 (
				 SELECT   ZPS.PaymentSettingId,ZPS.PaymentApplicationSettingId,ZPS.PaymentTypeId,ZPS.PaymentGatewayId,ZPS.PaymentName,ZPS.IsActive
						,ISNULL(YOPU.DisplayOrder, ZPS.DisplayOrder) DisplayOrder,ZPS.IsTestMode,ZPS.IsPoDocUploadEnable,ZPS.IsPoDocRequire,ZPS.CreatedBy,ZPS.CreatedDate,ZPS.ModifiedBy,ZPS.ModifiedDate
						,NULL PortalId,NULL StoreName, 0 IsAssociated ,NULL ProfileId,NULL ProfileName,ZPT.BehaviorType PaymentTypeName,ZPG.GatewayName	
						,  CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  AND ZPPS.PaymentDisplayName  IS NOT NULL  THEN ZPPS.PaymentDisplayName  ELSE  ZPS.PaymentDisplayName   END PaymentDisplayName   , NULL PaymentExternalId, CASE WHEN YU.PaymentSettingId IS NOT NULL  THEN 1 ELSE 0 END AS IsApprovalRequired 
						 , ZPS.PaymentCode, ZPG.GatewayCode,ZPT.IsCallToPaymentAPI ,ZPS.IsBillingAddressOptional,ZPS.IsOABRequired,YU.PortalPaymentGroupId
						 , ISNULL(ZPPOS.DisplayName,''Production'' )  PublishState, ZPPS.IsUsedForOfflinePayment ,ZPT.Code 
				 FROM ZnodePaymentSetting ZPS
				 INNER JOIN ZnodePaymentType  ZPT ON (ZPT.PaymentTypeId = ZPS.PaymentTypeId)
				 LEFT JOIN ZnodePaymentGateway ZPG ON (ZPG.PaymentGatewayId= ZPS.PaymentGatewayId)
				 LEFT JOIN ZnodeProfilePaymentSetting YOPU ON (YOPU.PaymentSettingId = ZPS.PaymentSettingId AND YOPU.ProfileId = '+CAST(@ProfileId AS NVARCHAr(200))+')
				 LEFT JOIN #ZnodePortalPaymentApprovers YU ON (YU.PaymentSettingId = ZPS.PaymentSettingId) 
				 LEFT JOIN ZnodePortalPaymentSetting ZPPS ON (ZPS.PaymentSettingId  = ZPPS.PaymentSettingId AND ZPPS.PortalId = CASE WHEN '+CAST(@PortalId AS VARCHAR(100))+' > 0  THEN '+CAST(@PortalId AS VARCHAR(100))+' ELSE  YU.PortalId END    )
				 LEFT JOIN ZnodePublishState ZPPOS ON (ZPPOS.PublishStateId = '+CASE WHEN  CAST(@ProfileId AS VARCHAr(200))  > '0' AND EXISTS (SELECT TOP 1 1 FROM ZnodeProfilePaymentSetting NT WHERE NT.ProfileId  = @ProfileId ) 
				 THEN  ' YOPU.PublishStateId '  ELSE ' ZPPS.PublishStateId ' END +')
				  ) '
	 SET @FilterWhereClause = CASE WHEN @FilterWhereClause ='' THEN ' WHERE 1=1 ' ELSE ' WHERE 1=1 '+@FilterWhereClause END
	 SET @InternalOrderBy = ' PaymentSettingId '
	END

	SET @SQL = @SQL+ ', Cte_PaymentSettingFilter AS
				 (

					SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName , PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState
						,'+dbo.Fn_GetPagingRowId(@Order_BY,@InternalOrderBy)+',Count(*)Over() CountNo,IsUsedForOfflinePayment, Code

					FROM Cte_PaymenTSetting
				    '+@FilterWhereClause+'
					'+dbo.Fn_GetFilterWhereClause(@WhereClause)+'
				 )

				 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowId ,CountNo, IsUsedForOfflinePayment, Code
				 FROM Cte_PaymentSettingFilter '
				 +[dbo].[Fn_GetPaginationWhereClause](@PageNo,@Rows)

     PRINT @SQL 
	
	 INSERT INTO @TBL_PaymentSetting (PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
						,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
						,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI,IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,RowID,CountNo,IsUsedForOfflinePayment,Code)
	 EXEC (@SQL)

	 IF @IsAssociated = 1 
	 BEGIN
		 SELECT PaymentSettingId,PaymentApplicationSettingId,PaymentTypeId,PaymentGatewayId,PaymentName,IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, PaymentCode, GatewayCode,IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,isnull(IsUsedForOfflinePayment,0) as IsUsedForOfflinePayment  
		 FROM @TBL_PaymentSetting
		 WHERE ISNULL(IsUsedForOfflinePayment,0) = 1
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT top 1 CountNo FROM @TBL_PaymentSetting),0)
	END
	ELSE 
	BEGIN
	
		SELECT PaymentSettingId,PaymentApplicationSettingId,PS.PaymentTypeId,PaymentGatewayId,PaymentName,PS.IsActive
							,DisplayOrder,IsTestMode,IsPoDocUploadEnable,IsPoDocRequire,PS.CreatedBy,PS.CreatedDate,PS.ModifiedBy,PS.ModifiedDate
							,PortalId,StoreName, ProfileId, ProfileName,PaymentTypeName,GatewayName,PaymentDisplayName,PaymentExternalId,IsApprovalRequired, 
							PaymentCode, GatewayCode,PS.IsCallToPaymentAPI, IsBillingAddressOptional,IsOABRequired,PortalPaymentGroupId,PublishState,ISNULL(PS.IsUsedForOfflinePayment,0)IsUsedForOfflinePayment
		 FROM @TBL_PaymentSetting PS
		 WHERE ( ISNULL(IsUsedForOfflinePayment,0) = 0)	
		 ORDER BY RowID,DisplayOrder

		 SET @RowsCount = ISNULL((SELECT top 1 CountNo FROM @TBL_PaymentSetting ),0)
	END

  END TRY
  BEGIN CATCH
             DECLARE @Status BIT ;
		     SET @Status = 0;
		     DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_GetPaymentSettingForOfflinePayment @WhereClause = '+CAST(@WhereClause AS VARCHAR(max))+',@Rows='+CAST(@Rows AS VARCHAR(50))+',@PageNo='+CAST(@PageNo AS VARCHAR(50))+',@Order_BY='+@Order_BY+',@PortalId='+CAST(@PortalId AS VARCHAR(50))+',@ProfileId='+CAST(@ProfileId AS VARCHAR(50))+',@IsAssociated='+CAST(@IsAssociated AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@RowsCount='+CAST(@RowsCount AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));

             SELECT 0 AS ID,CAST(0 AS BIT) AS Status;

             EXEC Znode_InsertProcedureErrorLog
				@ProcedureName = 'Znode_GetPaymentSettingForOfflinePayment',
				@ErrorInProcedure = @Error_procedure,
				@ErrorMessage = @ErrorMessage,
				@ErrorLine = @ErrorLine,
				@ErrorCall = @ErrorCall;
  END CATCH
 END



GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetProductsAttributeValue_newTesting')
	DROP PROC Znode_GetProductsAttributeValue_newTesting
GO

CREATE PROCEDURE [dbo].[Znode_GetProductsAttributeValue_newTesting]  
(   
	@PimProductId  transferid readonly ,  
    @AttributeId transferid readonly,  
    @LocaleId      INT = 0,  
	@IsPublish bit = 0, 
	@IsFilesNameRequired Bit =0
)  
AS  
/*   
		Summary:- This Procedure is used to get the product attribute values   
		The result is fetched from all locale for ProductId provided  
		Unit Testing   
		EXEC Znode_GetProductsAttributeValue_1 '2146','ProductName,SKU,Price,Quantity,IsActive,ProductType,Image,Assortment,DisplayOrder,Style,Material',0  
		SELECT * FROM ZnodePIMProduct  
		DECLARE @Tyr TransferId   
		,  @Tyr1   TransferId   
		INSERT INTO @Tyr   
		SELECT   
		EXEC Znode_GetProductsAttributeValue '121','ProductName,SKU,Price,Quantity,IsActive,ProductType,Image,Assortment,DisplayOrder,Style,Material',1  
		EXEC Znode_GetProductsAttributeValue '121','ProductName,SKU,Price,Quantity,IsActive,ProductType,Image,Assortment,DisplayOrder,Style,Material',2,@IsPublish =1   
*/   
  BEGIN  
     BEGIN TRY  
     SET NOCOUNT ON;  
        
	 --  DECLARE #TBL_AttributeValue1 TABLE (PimAttributeValueId INT , PimAttributeId INT , PimProductId INT,AttributeCode VARCHAR(200)  )  
     DECLARE @DefaultLocaleId INT = dbo.FN_GetDefaultLocaleID()  
  
	 -- INSERT INTO  (PimAttributeValueId , PimAttributeId , PimProductId,AttributeCode )  
           SELECT PimAttributeValueId , ZPAV.PimAttributeId , PimProductId,AttributeCode   
     INTO #TBL_AttributeValue1  
     FROM ZnodePimAttributeValue ZPAV   
     INNER JOIN  ZnodePimAttribute ZPA ON (ZPA.PimAttributeId = ZPAV.PimAttributeId)    
     WHERE EXISTS (SELECT TOP 1 1 FROM @PimProductId TBLP WHERE TBLP.Id = ZPAV.PimProductId )  
     AND EXISTS (SELECT TOP 1 1 FROM @AttributeId TBLA WHERE TBLA.Id = ZPAV.PimAttributeId  )  
     
   CREATE TABLE #TBL_AttributeValue  (PimAttributeValueId INT  , PimAttributeId  INT , PimProductId INT ,AttributeCode NVARCHAR(600),AttributeValue NVARCHAR(max),TypeOfData INT   
      ,PimAttributeValueLocaleId INT ,LocaleId INT , RowId INT,PimAttributeDefaultValueId INT  )  
          INSERT INTO #TBL_AttributeValue (PimAttributeValueId   , PimAttributeId   , PimProductId  ,AttributeCode ,AttributeValue ,TypeOfData    
      ,PimAttributeValueLocaleId  ,LocaleId  , RowId    )     
    SELECT TBLAV.PimAttributeValueId , TBLAV.PimAttributeId , PimProductId,AttributeCode,ZPAVL.AttributeValue,1 TypeOfData  
      ,ZPAVL.ZnodePimAttributeValueLocaleId PimAttributeValueLocaleId,LocaleId,COUNT(*)Over(Partition By TBLAV.PimProductId,PimAttributeId ORDER BY TBLAV.PimProductId,PimAttributeId  ) RowId  
        FROM ZnodePimAttributeValueLocale  ZPAVL   
    INNER JOIN #TBL_AttributeValue1 TBLAV ON (TBLAV.PimAttributeValueId = ZPAVL.PimAttributeValueId)  
    WHERE LocaleId = @DefaultLocaleId OR LocaleId = @LocaleId   
     
    INSERT INTO #TBL_AttributeValue (PimAttributeValueId   , PimAttributeId   , PimProductId  ,AttributeCode ,AttributeValue ,TypeOfData    
      ,PimAttributeValueLocaleId  ,LocaleId  , RowId )  
    SELECT TBLAV.PimAttributeValueId , TBLAV.PimAttributeId , PimProductId,AttributeCode,ZPAVL.AttributeValue,1 TypeOfData  
      ,ZPAVL.PimProductAttributeTextAreaValueId PimAttributeValueLocaleId,LocaleId,COUNT(*)Over(Partition By TBLAV.PimProductId,PimAttributeId ORDER BY TBLAV.PimProductId,PimAttributeId  ) RowId  
    FROM ZnodePimProductAttributeTextAreaValue  ZPAVL   
    INNER JOIN #TBL_AttributeValue1 TBLAV ON (TBLAV.PimAttributeValueId = ZPAVL.PimAttributeValueId)  
    WHERE LocaleId = @DefaultLocaleId OR LocaleId = @LocaleId   
     
    INSERT INTO #TBL_AttributeValue (PimAttributeValueId   , PimAttributeId   , PimProductId  ,AttributeCode ,AttributeValue ,TypeOfData    
      ,PimAttributeValueLocaleId  ,LocaleId  , RowId ,PimAttributeDefaultValueId   )  
    SELECT TBLAV.PimAttributeValueId , TBLAV.PimAttributeId , PimProductId,AttributeCode,  
           CAST( ZPAVL.PimAttributeDefaultValueId AS VARCHAR(2000)),2 TypeOfData  
      ,ZPAVL.PimProductAttributeDefaultValueId PimAttributeValueLocaleId,LocaleId  
      ,COUNT(*)Over(Partition By TBLAV.PimProductId,PimAttributeId ORDER BY TBLAV.PimProductId,PimAttributeId  ) RowId  
      ,PimAttributeDefaultValueId  
    FROM ZnodePimProductAttributeDefaultValue  ZPAVL   
    INNER JOIN #TBL_AttributeValue1 TBLAV ON (TBLAV.PimAttributeValueId = ZPAVL.PimAttributeValueId)  
    WHERE LocaleId = @DefaultLocaleId OR LocaleId = @LocaleId   
      
    INSERT INTO #TBL_AttributeValue (PimAttributeValueId   , PimAttributeId   , PimProductId  ,AttributeCode ,AttributeValue ,TypeOfData    
      ,PimAttributeValueLocaleId  ,LocaleId  , RowId   )  
    SELECT TBLAV.PimAttributeValueId , TBLAV.PimAttributeId , PimProductId,AttributeCode,CAST( ZPAVL.MediaId AS VARCHAR(2000)) ,3 TypeOfData  
      ,ZPAVL.PimProductAttributeMediaId PimAttributeValueLocaleId,ZPAVL.LocaleId,COUNT(*)Over(Partition By TBLAV.PimProductId,PimAttributeId ORDER BY TBLAV.PimProductId,PimAttributeId  ) RowId  
    FROM ZnodePimProductAttributeMedia  ZPAVL   
    INNER JOIN #TBL_AttributeValue1 TBLAV ON (TBLAV.PimAttributeValueId = ZPAVL.PimAttributeValueId)  
    WHERE LocaleId = @DefaultLocaleId OR LocaleId = @LocaleId   
    
	 DECLARE @url VARCHAR(1000)
	 SELECT @url= CONCAT (FeatureValues,FeatureSubValues) FROM ZnodeGlobalSetting WHERE FeatureName='ProductImagePath'
			 
     SELECT ZPPADV.PimAttributeValueId   
     ,ZPADVL.AttributeDefaultValue AttributeDefaultValue ,ZPADVL.localeID LocaleId ,ZPPADV.PimProductId   
     ,ZPPADV.AttributeCode,ZPPADV.PimAttributeId,TEY.AttributeDefaultValueCode    
     into #Cte_GetDefaultData
	 FROM #TBL_AttributeValue ZPPADV   
     INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimAttributeValueId = ZPPADV.PimAttributeValueId)  
     INNER JOIN ZnodePimAttributeDefaultValue TEY ON (TEY.PimAttributeDefaultValueId  = ZPPADV.PimAttributeDefaultValueId )  
     INNER JOIN ZnodePimAttributeDefaultValuelocale ZPADVL ON (ZPADVL.PimAttributeDefaultValueId = TEY.PimAttributeDefaultValueId )  
     WHERE ZPPADV.localeID  IN (@LocaleId,@DefaultLocaleId)  
     AND TypeOfData = 2   
     AND ZPPADV.LocaleId  = CASE WHEN RowId >= 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
   
	--insert into Cte_AttributeValueDefault
     SELECT AttributeDefaultValue  ,PimProductId ,AttributeCode,PimAttributeId ,AttributeDefaultValueCode   
     into #Cte_AttributeValueDefault
	 FROM #Cte_GetDefaultData   
     WHERE LocaleId = @LocaleId   
     --UNION 
	 insert into #Cte_AttributeValueDefault   
     SELECT  AttributeDefaultValue  ,PimProductId ,AttributeCode,PimAttributeId,AttributeDefaultValueCode   
     FROM #Cte_GetDefaultData a   
     WHERE LocaleId = @DefaultLocaleId   
     AND NOT EXISTS (SELECT TOP 1 1 FROM #Cte_GetDefaultData b WHERE b.PimAttributeValueId = a.PimAttributeValueId AND b.LocaleId= @LocaleId)  
      --  )  
    
	create table #AttributeValueDefaultData( PimProductId int,	AttributeValue varchar(max),	AttributeCode varchar(300),	PimAttributeId int,	AttributeDefaultValue varchar(2000), PimAttributeValueLocaleId int,FilesName varchar(max) Null)  
    
	SELECT ZM.MediaId,[dbo].[Fn_GetMediaThumbnailMediaPath]( zm.PATH) MediaPath,ZM.FileName
	into #ZnodeMediaFileNameDetails
	FROM ZnodeMedia ZM 
	WHERE Exists (Select 1
	FROM #TBL_AttributeValue TBLAV   
	WHERE  LocaleId  = CASE WHEN RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
	AND TypeOfData = 3 
	and ZM.MediaId = TBLAV.AttributeValue  ) 


	insert into #AttributeValueDefaultData(PimProductId,AttributeValue,AttributeCode,PimAttributeId,AttributeDefaultValue)  
    SELECT  PimProductId, AttributeValue,  AttributeCode,  PimAttributeId, NULL AttributeDefaultValue    
    FROM  #TBL_AttributeValue   
             WHERE LocaleId  = CASE WHEN RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
    AND TypeOfData = 1    

   UNION ALL  
   SELECT DISTINCT PimProductId,
			 SUBSTRING ((SELECT ',' + AttributeDefaultValue 
													FROM #Cte_AttributeValueDefault CTEAI 
													WHERE CTEAI.PimProductId = CTEA.PimProductId 
													AND CTEAI.PimAttributeId = CTEA.PimAttributeId
													FOR XML PATH ('')   ),2,4000) AttributeDefaultValue,AttributeCode ,PimAttributeId
			 ,SUBSTRING ((SELECT ',' + AttributeDefaultValueCode 
													FROM #Cte_AttributeValueDefault CTEAI1 
													WHERE CTEAI1.PimProductId = CTEA.PimProductId 
													AND CTEAI1.PimAttributeId = CTEA.PimAttributeId
													FOR XML PATH ('')   ),2,4000) AttributeDefaultValue
				
			FROM #Cte_AttributeValueDefault  CTEA 
     	--UNION ALL   
		If @IsFilesNameRequired =1
		Begin
			insert into #AttributeValueDefaultData( PimProductId ,	AttributeValue,	AttributeCode ,	PimAttributeId ,	AttributeDefaultValue , PimAttributeValueLocaleId,FilesName )  
			SELECT DISTINCT PimProductId,  
			SUBSTRING ((SELECT ','+MediaPath FROM #ZnodeMediaFileNameDetails ZM 
			WHERE ZM.MediaId = TBLAV.AttributeValue  FOR XML PATH (''), TYPE).value('.', 'varchar(Max)') ,2,4000)  ,
			AttributeCode,PimAttributeId,NULL AttributeDefaultValue , PimAttributeValueLocaleId,
			SUBSTRING ((SELECT ','+ZM.FileName FROM #ZnodeMediaFileNameDetails ZM WHERE ZM.MediaId = TBLAV.AttributeValue   
			FOR XML PATH (''), TYPE).value('.', 'varchar(Max)') ,2,4000)
			FROM #TBL_AttributeValue TBLAV   
			WHERE  LocaleId  = CASE WHEN RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
			AND TypeOfData = 3  
			--and AttributeCode <>'ProductImage'
			-- GROUP BY PimAttributeId,PimProductId,AttributeCode  
			--Custom changes issues occured in fornt end code to include new stored procedure. Making change in base sp 
			--for immidiate requirment.
			--PCNA replace ProductImage by PrimaryImage attribute.
			--Declare @PimProductImageAttributeId int 
			--select @PimProductImageAttributeId  = PimAttributeId from ZnodePimAttribute where AttributeCode ='ProductImage'  and Iscategory =0 

			--INSERT INTO #AttributeValueDefaultData(PimProductId,AttributeValue,AttributeCode,PimAttributeId,AttributeDefaultValue,PimAttributeValueLocaleId )  
			--SELECT DISTINCT PimProductId,  
			--Isnull(@url+'/' + isnull(TBLAV.AttributeValue ,''),'' )
			--,'ProductImage' ,@PimProductImageAttributeId   , NULL AttributeDefaultValue , PimAttributeValueLocaleId
			--FROM #TBL_AttributeValue TBLAV   
			--WHERE  LocaleId  = CASE WHEN RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
			--AND TBLAV.AttributeCode = 'PrimaryImage'

		End
		Else
		Begin
			insert into #AttributeValueDefaultData( PimProductId ,	AttributeValue,	AttributeCode ,	PimAttributeId ,	AttributeDefaultValue , PimAttributeValueLocaleId,FilesName )  
			SELECT DISTINCT PimProductId,  
			SUBSTRING ((SELECT ','+MediaPath FROM #ZnodeMediaFileNameDetails ZM 
			WHERE ZM.MediaId = TBLAV.AttributeValue  FOR XML PATH (''), TYPE).value('.', 'varchar(Max)') ,2,4000)  ,
			AttributeCode,PimAttributeId,NULL AttributeDefaultValue , PimAttributeValueLocaleId,
			NULL 
			FROM #TBL_AttributeValue TBLAV   
			WHERE  LocaleId  = CASE WHEN RowId = 2 THEN  @LocaleId ELSE @DefaultLocaleId END   
			AND TypeOfData = 3  
			-- GROUP BY PimAttributeId,PimProductId,AttributeCode  
		End


		If @IsFilesNameRequired =1
		Begin
			select PimProductId,AttributeValue,AttributeCode,PimAttributeId,AttributeDefaultValue,FilesName
			from #AttributeValueDefaultData
			order by PimAttributeValueLocaleId  
		End
		Else
		Begin
			select PimProductId,AttributeValue,AttributeCode,PimAttributeId,AttributeDefaultValue
			from #AttributeValueDefaultData
			order by PimAttributeValueLocaleId
		End

   END TRY  
         BEGIN CATCH  
    
		SELECT ERROR_MESSAGE()  
		DECLARE @Status BIT ;  
		SET @Status = 0;  
   
         END CATCH;  
     END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSEODetails')
	DROP PROC Znode_ImportSEODetails
GO

CREATE PROCEDURE [dbo].[Znode_ImportSEODetails]
(  
   @TableName NVARCHAR(100), 
   @Status BIT OUT, 
   @UserId INT, 
   @ImportProcessLogId INT, 
   @NewGUId NVARCHAR(200), 
   @LocaleId INT= 1,
   @PortalId INT ,
   @CsvColumnString NVARCHAR(max)
)  
AS  
 --------------------------------------------------------------------------------------  
 -- Summary :  Import SEO Details  
   
 -- Unit Testing :   
 --------------------------------------------------------------------------------------  
  
BEGIN  
BEGIN TRAN A;  
BEGIN TRY  
   
	DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max);  
	DECLARE @GetDate DATETIME= dbo.Fn_GetDate();  
    
    
	DECLARE @CMSSEOTypeProduct INT ,@CMSSEOTypeCategory INT  
  
	SELECT @CMSSEOTypeProduct = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product'  
	SELECT @CMSSEOTypeCategory = CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Category'  
  
  
	-- Three type of import required three table varible for product , category AND brAND  
	DECLARE @InsertSEODetails TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),   
		RobotTag VARCHAR(50), GUID NVARCHAR(400)  
	);  
  
	DECLARE @InsertSEODetailsOFProducts TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
	DECLARE @InsertSEODetailsOFCategory TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),  
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200), 
		RobotTag VARCHAR(50),GUID NVARCHAR(400)
	);  
  
	DECLARE @InsertSEODetailsOFBrAND TABLE  
	(   
		RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, ImportType varchar(20), Code NVARCHAR(300),   
		IsRedirect BIT ,MetaInformation NVARCHAR(max),PortalId INT ,SEOUrl NVARCHAR(max),IsActive varchar(10),  
		SEOTitle NVARCHAR(max),SEODescription NVARCHAR(max),SEOKeywords NVARCHAR(max),   
		RedirectFROM NVARCHAR(max),RedirectTo NVARCHAR(max), EnableRedirection BIT, CanonicalURL VARCHAR(200),  
		RobotTag VARCHAR(50),GUID NVARCHAR(400) 
	);  
  
    
	DECLARE @InsertedZnodeCMSSEODetail TABLE  
	(   
		CMSSEODetailId INT , SEOCode Varchar(4000), CMSSEOTypeId INT  
	);  
    
	--SET @SSQL = 'SELECT RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,GUID  FROM '+@TableName;  
	SET @SSQL = 'SELECT RowNumber,'+@CsvColumnString+',GUID  FROM '+@TableName;  
  
	INSERT INTO @InsertSEODetails(RowNumber,ImportType,Code,IsRedirect,MetaInformation,SEOUrl,IsActive,SEOTitle,SEODescription,SEOKeywords,RedirectFrom,RedirectTo,EnableRedirection,CanonicalURL,RobotTag,GUID )  
	EXEC sys.sp_sqlexec @SSQL;  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '30', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.SEOURL IN (SELECT ISD.SEOURL FROM @InsertSEODetails ISD Group by ISD.SEOUrl having count(*) > 1 ) 
	    
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '10', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.SEOUrl = ii.SEOUrl AND ZCSD.PortalId = @PortalId
	AND ZCSD.SEOCode <> ii.Code  AND EXISTS  
	(SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale dl WHERE dl.CMSSEODetailId = ZCSD.CMSSEODetailId AND dl.LocaleId = @LocaleId  
	AND dl.SEODescription = ii.SEODescription AND dl.SEOTitle = ii.SEOTitle AND dl.SEOKeywords = ii.SEOKeywords))   
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '53', 'RedirectFrom', RedirectFrom, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM IN (SELECT ISD.RedirectFROM FROM @InsertSEODetails ISD Group by ISD.RedirectFROM having count(*) > 1 )   
	AND (ii.RedirectFROM <> '' )

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '35', 'RedirectFrom\RedirectTo', RedirectFROM + '  ' + RedirectTo  , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii   
	WHERE ii.RedirectFROM = ii.RedirectTo  
	AND (ii.RedirectFROM <> '' AND ii.RedirectTo <> '' )
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '102', 'SEOUrl', SEOUrl, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE LTRIM(RTRIM(ISNULL(ii.SEOUrl,''))) like '% %' -----space not allowed  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'ImportType', ImportType, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.ImportType NOT IN   
	(  
		SELECT NAME FROM ZnodeCMSSEOType WHERE NAME NOT IN ('Content Page','BlogNews','Brand')  
	);  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '68', 'IsActive', IsActive, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.IsActive not IN ('True','1','Yes','FALSE','0','No')
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '9', 'RobotTag', RobotTag, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetails AS ii  
	WHERE ii.RobotTag not IN ( 'INDEX_FOLLOW','NOINDEX_NOFOLLOW','NOINDEX_FOLLOW','INDEX_NOFOLLOW','1','2','3','4') 
	AND ISNULL(ii.RobotTag,'')<>''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SEOCode - ' + ISNULL(Code,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSEODetails IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	
	-------------------------------------------------------------------------------------------------------------------------------  
  
	INSERT INTO @InsertSEODetailsOFProducts(  RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
	CASE WHEN IsActive IN ('True','1','Yes') 
	Then 1 
	ELSE 0
	END as IsActive, SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Product'  
  
  
	INSERT INTO @InsertSEODetailsOFCategory( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl , 
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Category'  
  
	INSERT INTO @InsertSEODetailsOFBrand( RowNumber , ImportType , Code ,   
	IsRedirect ,MetaInformation ,SEOUrl ,IsActive ,  
	SEOTitle ,SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag , GUID )  
	SELECT RowNumber , ImportType , Code , IsRedirect ,MetaInformation ,SEOUrl ,
		CASE WHEN IsActive IN ('True','1','Yes') Then 1 ELSE 0 END as IsActive, SEOTitle ,
		SEODescription ,SEOKeywords, RedirectFrom, RedirectTo,EnableRedirection, CanonicalURL, RobotTag, GUID  
	FROM @InsertSEODetails WHERE ImportType = 'Brand'  
  
  
	-- start Functional Validation   
	--1. Product  
	--2. Category  
	--3. Content Page  
	--4. BrAND  
	-----------------------------------------------  
  
    
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'SKU', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFProducts AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPAVL.AttributeValue  
		FROM ZnodePimAttributeValue ZPAV   
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'SKU' AND ZPAVL.AttributeValue IS NOT NULL   
	)  AND ImportType = 'Product';  
  

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'Category', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFCategory AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT ZPCAVL.CategoryValue  
		FROM ZnodePimCategoryAttributeValue ZPCAV   
		INNER JOIN ZnodePimCategoryAttributeValueLocale ZPCAVL on ZPCAV.PimCategoryAttributeValueId = ZPCAVL.PimCategoryAttributeValueId  
		INNER JOIN ZnodePimAttribute ZPA on ZPCAV.PimAttributeId = ZPA.PimAttributeId  
		WHERE ZPA.AttributeCode = 'CategoryCode' AND ZPCAVL.CategoryValue IS NOT NULL  
	)  AND ImportType = 'Category';  
  
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
	SELECT '103', 'Brand', CODE, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
	FROM @InsertSEODetailsOFBrAND AS ii  
	WHERE ii.CODE NOT IN   
	(  
		SELECT BrandCode FROM ZnodeBrandDetails WHERE BrandCode IS NOT NULL  
	)  AND ImportType = 'Brand';  
    
	
	--Note : Content page import is not required   
    
	-- End Function Validation    
	-----------------------------------------------  
	--- Delete Invalid Data after functional validatin    
 
	DELETE FROM @InsertSEODetails  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  


	DELETE FROM @InsertSEODetailsOFProducts  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFCategory  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
	DELETE FROM @InsertSEODetailsOFBrAND  
	WHERE RowNumber IN  
	(  
		SELECT DISTINCT   
		RowNumber  
		FROM ZnodeImportLog  
		WHERE ImportProcessLogId = @ImportProcessLogId  AND RowNumber is not null   
	);  
  
 
	-- Insert Product Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFProducts)  
	BEGIN  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords
			,ZCSDL.CanonicalURL = ISD.CanonicalURL
			,ZCSDL.RobotTag = ISD.RobotTag  
		FROM @InsertSEODetailsOFProducts ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId = @PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		----Making product as draft if SEOUrl is changed for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertSEODetailsOFProducts ISD    
			INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code
			WHERE ZPAVL.AttributeValue = ZCSD.SEOCode)
     
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate, CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeProduct   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
     
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeProduct,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate FROM   
		@InsertSEODetailsOFProducts ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeProduct AND ZCSD.SEOCode = ISD.Code AND  ZCSD.PortalId =@PortalId   );  
    
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFProducts ISD ON IZCSD.SEOCode = ISD.Code   

		----Making product as draft if SEOUrl is inserted for part of partial publish
		UPDATE ZPP SET ZPP.PublishStateId = (SELECT TOP 1 PublishStateId FROM ZnodePublishState WHERE StateName = 'Draft')
		FROM ZnodePimProduct ZPP
		INNER JOIN ZnodePimAttributeValue ZPAV ON ZPP.PimProductId = ZPAV.PimProductId
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
		WHERE EXISTS (SELECT * FROM ZnodePimAttribute zpa WHERE zpa.AttributeCode = 'SKU' AND ZPAV.PimAttributeId = zpa.PimAttributeId)
		AND EXISTS(SELECT * FROM @InsertedZnodeCMSSEODetail IZCSD WHERE ZPAVL.AttributeValue = IZCSD.SEOCode)
  
		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFProducts SDP  
		WHERE IsRedirect = 1
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
  
	END  
  
	-- Insert Category Data   
	IF EXISTS (SELECT TOP 1 1 FROM @InsertSEODetailsOFCategory)  
	BEGIN  
  
		UPDATE ZCSD SET ZCSD.IsRedirect = ISD.IsRedirect ,  
			ZCSD.MetaInformation =  ISD.MetaInformation,  
			ZCSD.SEOUrl=  ISD.SEOUrl,  
			ZCSD.IsPublish = 0  
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId;  
     
     
		UPDATE ZCSDL SET ZCSDL.SEOTitle = ISD.SEOTitle  
			,ZCSDL.SEODescription = ISD.SEODescription  
			,ZCSDL.SEOKeywords= ISD.SEOKeywords 
			,CanonicalURL = ISD.CanonicalURL
			,RobotTag = ISD.RobotTag
		FROM @InsertSEODetailsOFCategory ISD    
		INNER JOIN ZnodeCMSSEODetail ZCSD ON  ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode = ISD.Code  
		INNER JOIN ZnodeCMSSEODetailLocale ZCSDL ON ZCSD.CMSSEODetailId = ZCSDL.CMSSEODetailId  
		WHERE  ZCSD.PortalId  =@PortalId AND ZCSDL.LocaleId = @LocaleId;   
  
		INSERT INTO ZnodeCMSSEODetailLocale (CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT CSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag  
		FROM ZnodeCMSSEODetail CSD  
		INNER JOIN @InsertSEODetailsOFProducts ISD ON CSD.SEOCode = ISD.Code AND CSD.CMSSEOTypeId = @CMSSEOTypeCategory   
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetailLocale CSDL WHERE CSDL.LocaleId = @LocaleId AND CSD.CMSSEODetailId = CSDL.CMSSEODetailId )  
		AND CSD.portalId = @PortalId  
  
  
		DELETE FROM @InsertedZnodeCMSSEODetail  

		INSERT INTO ZnodeCMSSEODetail(CMSSEOTypeId,SEOCode,IsRedirect,MetaInformation,PortalId,SEOUrl,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
		OUTPUT Inserted.CMSSEODetailId,Inserted.SEOCode,Inserted.CMSSEOTypeId INTO @InsertedZnodeCMSSEODetail    
		SELECT DISTINCT @CMSSEOTypeCategory,ISD.Code , ISD.IsRedirect,ISD.MetaInformation,@PortalId,ISD.SEOUrl,@USerId, @GetDate,@USerId, @GetDate   
		FROM @InsertSEODetailsOFCategory ISD    
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSSEODetail ZCSD WHERE ZCSD.CMSSEOTypeId = @CMSSEOTypeCategory AND ZCSD.SEOCode  = ISD.Code AND ZCSD.PortalId = @PortalId );  
  
		INSERT INTO ZnodeCMSSEODetailLocale(CMSSEODetailId,LocaleId,SEOTitle,SEODescription,SEOKeywords,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,CanonicalURL,RobotTag)  
		SELECT DISTINCT IZCSD.CMSSEODetailId,@LocaleId,ISD.SEOTitle,ISD.SEODescription,ISD.SEOKeywords,@USerId, @GetDate,@USerId, @GetDate,CanonicalURL,RobotTag   
		FROM @InsertedZnodeCMSSEODetail IZCSD   
		INNER JOIN @InsertSEODetailsOFCategory ISD ON IZCSD.SEOCode = ISD.Code   
		WHERE IZCSD.CMSSEOTypeId =@CMSSEOTypeCategory    

		-----RedirectUrlInsert  
		INSERT INTO ZnodeCMSUrlRedirect ( RedirectFrom,RedirectTo,IsActive,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)  
		SELECT RedirectFrom,RedirectTo,
		EnableRedirection,@PortalId as PortalId ,2 as CreatedBy,@GetDate as CreatedDate,2 as ModifiedBy,@GetDate as ModifiedDate  
		FROM @InsertSEODetailsOFCategory SDP  
		WHERE IsRedirect = 1 
		AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeCMSUrlRedirect ZCR 
			WHERE ZCR.RedirectFROM = SDP.RedirectFROM AND ZCR.RedirectTo = SDP.RedirectTo)
			AND (SDP.RedirectFROM <> '' AND SDP.RedirectTo <> '' )
	END  

	-- UPDATE Record count IN log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSEODetails
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
	WHERE ImportProcessLogId = @ImportProcessLogId;
	


	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
						WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
						WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
					END, 
		ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId; 
  
COMMIT TRAN A;  
END TRY  
BEGIN CATCH  
ROLLBACK TRAN A;

	SET @Status = 0;  
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE(); 

	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportSEODetails @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@LocaleId='+CAST(@LocaleId AS VARCHAR(max)) +',@PortalId='+CAST(@PortalId AS VARCHAR(max)) +',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max)) ;

	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total AND fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSEODetails',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;
    
END CATCH;  
END;

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'Amount' AND Object_ID = Object_ID(N'dbo.ZnodeOrderPayment'))
BEGIN
	ALTER TABLE ZnodeOrderPayment ALTER COLUMN Amount NUMERIC(28, 6)   NULL;
END

GO

IF EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'RemainingOrderAmount' AND Object_ID = Object_ID(N'dbo.ZnodeOrderPayment'))
BEGIN
	ALTER TABLE ZnodeOrderPayment ALTER COLUMN RemainingOrderAmount NUMERIC(28, 6)   NULL;
END


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateOmsOrderPayment')
	DROP PROC Znode_InsertUpdateOmsOrderPayment
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateOmsOrderPayment]
(
	@OrderPaymentXML XML,
	@OrderId INT,
	@TransactionDate DATETIME,
	@UserId INT,
	@Status BIT = 0 OUT
)
AS
BEGIN
	SET NOCOUNT ON;
	BEGIN TRAN OrderInsert
	BEGIN TRY

		DECLARE @GetDate DATETIME = GETDATE()

		IF OBJECT_ID('tempdb..#TempOrderPaymentData') IS NOT NULL
			DROP TABLE #TempOrderPaymentData
	
		CREATE TABLE #TempOrderPaymentData
			(OmsOrderId INT, TransactionReference NVARCHAR(50), Amount NUMERIC(28,6), TransactionStatus NVARCHAR(50), PaymentSettingId INT, RemainingOrderAmount NUMERIC(28,6))
	
		--------Getting Order Payment details
		INSERT INTO #TempOrderPaymentData
			(OmsOrderId, TransactionReference, Amount, TransactionStatus , PaymentSettingId, RemainingOrderAmount)

		SELECT
			CASE WHEN Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) = '' THEN NULL ELSE Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(2000)' ) END AS OmsOrderId,
			Tbl.Col.value( 'TransactionReference[1]', 'NVARCHAR(Max)' ) AS TransactionReference,
			CASE WHEN Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'Total[1]', 'NVARCHAR(Max)' ) END AS Amount,
			CASE WHEN Tbl.Col.value( 'TransactionStatus[1]', 'NVARCHAR(Max)' )='' THEN NULL ELSE Tbl.Col.value( 'TransactionStatus[1]', 'NVARCHAR(Max)' ) END AS TransactionStatus,
			CASE WHEN Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'PaymentSettingId[1]', 'NVARCHAR(Max)' ) END  AS PaymentGatewayId,
			CASE WHEN Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) = '' THEN NULL ELSE Tbl.Col.value( 'RemainingOrderAmount[1]', 'NVARCHAR(Max)' ) END AS RemainingOrderAmount

		FROM @OrderPaymentXML.nodes( '//OrderPaymentDataModel' ) AS Tbl(Col);
	
		INSERT INTO ZnodeOrderPayment
			(OmsOrderId, TransactionReference, Amount, TransactionStatus, TransactionDate, PaymentSettingId , CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, RemainingOrderAmount)
		SELECT OmsOrderId, TransactionReference, Amount, TransactionStatus, @TransactionDate, PaymentSettingId, @UserId, @GetDate, @UserId, @GetDate, RemainingOrderAmount
		FROM #TempOrderPaymentData 

		SET @Status = 1;
		SELECT 1 AS Id,@Status AS Status;
	COMMIT TRAN OrderInsert
	END TRY
	BEGIN CATCH
		ROLLBACK TRAN OrderInsert
		SET @Status = 0;

		SELECT 0 AS Id, @Status AS Status; 

		DECLARE @ERROR_PROCEDURE VARCHAR(1000)= ERROR_PROCEDURE(), 
				@ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
				@ErrorLine VARCHAR(100)= ERROR_LINE(),
				@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertUpdateOmsOrderPayment @OrderPaymentXML ='+CAST(@OrderPaymentXML AS VARCHAR(MAX))+' ,@OrderId = '+CAST(@OrderId AS VARCHAR(50))
					+',@TransactionDate = '+CAST(@TransactionDate AS VARCHAR(50))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status = '+CAST(@Status AS VARCHAR(50));

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName    = 'Znode_InsertUpdateOmsOrderPayment',
		@ErrorInProcedure = @ERROR_PROCEDURE,
		@ErrorMessage     = @ErrorMessage,
		@ErrorLine        = @ErrorLine,
		@ErrorCall        = @ErrorCall;
	END CATCH
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPriceList')
	DROP PROC Znode_ImportPriceList
GO

CREATE PROCEDURE [dbo].[Znode_ImportPriceList]
(
	@TableName nvarchar(100),
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int,
	@NewGUId nvarchar(200),
	@PriceListId int )
AS 
	/*
	----Summary:  Import RetailPrice List 
	----		  Input XML data extracted in table format (table variable name:  #InsertPriceForValidation) by using  @xml.nodes 
	----		  Validate data column wise and store error log into @ErrorLogForInsertPrice table 
	----          Remove wrong data from table #InsertPriceForValidation and inserted correct data into @InsertPrice table for 
	----		  further processing (Importing to target database )
	---- Version 1 : Required Validation 
	---- UomName should not be null 
	---- Data for this RetailPrice list is already available  
	---- Version 2 : Required Validation 
	---- If UomName will be null then insert first record from UomTable and If UomName is wrong then raise error
	---- SKU with retailprice data is available with price list id will insert 
	---- multiple SKU with retail price is available then updated last sku details to price table and price tier table for respective price list
	----1. Import functionality should be provided only for single price list (Validate - Pending) 
	----  Tier price : TierStartQuantity should not between TierStartQuantity and TierEndQuantity for already existing SKU 
	----  In case of update details for SKU if any kind of price value will null then avoid it to update on existing value. 
	----2. From XML only SKU and RetailPrice is mandatory
	----3. SKUActivation date sholud be less than SKUExpriration date
	----4. Activation date sholud be less than Expiration date
	----5. If Tier RetailPrice has values and TierSartQuantity /TierEndQuantity or both has null value then it should not get updated/created.
	----6. ActivationDate and ExpirationDate value for tier price will be SKUActivationDate SKUExprirationDate 
	--- Change History : 
	--Remove column which is used to store range of qunatity by single column Quantity from table ZnodeTierProduct 
	--Manditory Retail price in Znodepricetable 
	-- SKUActivationfrom date and to date will used for tier price will store in single table ZnodePrice
	--Unit Testing   
	
*/
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
	    DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		
		IF OBJECT_ID('#InsertPriceForValidation', 'U') IS NOT NULL 
			DROP TABLE #InsertPriceForValidation
		ELSE 
			CREATE TABLE #InsertPriceForValidation 
			(SKU varchar(300) NULL, TierStartQuantity varchar(300) NULL, RetailPrice varchar(300) NULL, SalesPrice varchar(300) NULL, TierPrice varchar(300) NULL, SKUActivationDate varchar(300) NULL, SKUExpirationDate varchar(300) NULL,
			Custom1 varchar(300) NULL, Custom2 varchar(300) NULL, Custom3 varchar(300) NULL,CostPrice varchar(100), RowNumber varchar(300) NULL)

		IF OBJECT_ID('#InsertPrice', 'U') IS NOT NULL 
			DROP TABLE #InsertPrice
		ELSE 
			CREATE TABLE #InsertPrice 
			( 
				SKU varchar(300), TierStartQuantity numeric(28, 6) NULL, RetailPrice numeric(28, 6) NULL, SalesPrice numeric(28, 6) NULL, TierPrice numeric(28, 6) NULL, SKUActivationDate varchar(300) NULL, SKUExpirationDate varchar(300) NULL,
				Custom1 varchar(300) NULL, Custom2 varchar(300) NULL, Custom3 varchar(300) NULL,CostPrice numeric(28, 6), RowNumber varchar(300)
			);
	
	
		DECLARE @SKU TABLE
		( 
				SKU nvarchar(300)
		);
		INSERT INTO @SKU
			   SELECT b.AttributeValue
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;


		DECLARE @RoundOffValue int, @MessageDisplay nvarchar(100); 
		-- Retrive RoundOff Value from global setting 

		SELECT @RoundOffValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'PriceRoundOff';
	
		--@MessageDisplay will use to display validate message for input inventory value  

		DECLARE @sSql nvarchar(max);
		SET @sSql = ' Select @MessageDisplay_new = Convert(Numeric(28, '+CONVERT(nvarchar(200), @RoundOffValue)+'), 999999.000000000 ) ';
		EXEC SP_EXecutesql @sSql, N'@MessageDisplay_new NVARCHAR(100) OUT', @MessageDisplay_new = @MessageDisplay OUT;
		

		SET @SSQL = 'Select SKU,TierStartQuantity ,RetailPrice,SalesPrice,TierPrice,SKUActivationDate ,SKUExpirationDate ,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber FROM '+@TableName;
		INSERT INTO #InsertPriceForValidation( SKU, TierStartQuantity, RetailPrice, SalesPrice, TierPrice, SKUActivationDate, SKUExpirationDate,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber )
		EXEC sys.sp_sqlexec @SSQL;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'TierPrice', TierPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(TierPrice)=0  
				or exists(select * from ZnodeCulture where Symbol is not null and TierPrice like '%'+Symbol+'%')) and ISNULL(TierPrice,'')<>''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'SalesPrice', SalesPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(SalesPrice)=0	or exists(select * from ZnodeCulture where Symbol is not null and SalesPrice like '%'+Symbol+'%'))
				and ISNULL(SalesPrice,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'RetailPrice', RetailPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(RetailPrice)=0 or exists(select * from ZnodeCulture where Symbol is not null and RetailPrice like '%'+Symbol+'%')) and ISNULL(RetailPrice,'')<>''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'CostPrice', CostPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(CostPrice)=0	or exists(select * from ZnodeCulture where Symbol is not null and CostPrice like '%'+Symbol+'%'))
				and ISNULL(CostPrice,'')<>''
		
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertPriceForValidation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL
			   			  	
	    --- Delete Invalid Data after functional validation 
		DELETE FROM #InsertPriceForValidation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  Guid = @NewGUId
		);
		-- 1)  Validation for SKU is pending Proper data not found and 
		--Discussion still open for Publish version where we create SKU and use the SKU code for validation 
		--Select * from ZnodePimAttributeValue  where PimAttributeId =248
		--select * from View_ZnodePimAttributeValue Vzpa Inner join ZnodePimAttribute Zpa on Vzpa.PimAttributeId=Zpa.PimAttributeId where Zpa.AttributeCode = 'SKU'
		--Select * from ZnodePimAttribute where AttributeCode = 'SKU'
		--------------------------------------------------------------------------------------
		--2)  Start Data Type Validation for XML Data  
		--------------------------------------------------------------------------------------			
		---------------------------------------------------------------------------------------
		---------If UOM will blank then retrive top -- Finctionality pending 
		---Validate 
		
		INSERT INTO #InsertPrice( SKU, TierStartQuantity, RetailPrice, SalesPrice, TierPrice, SKUActivationDate, SKUExpirationDate,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber )
			   SELECT SKU,
					  CASE
					  WHEN CONVERT(Varchar(100),TierStartQuantity) = '' THEN 0
					  ELSE CONVERT(numeric(28, 6), TierStartQuantity)
					  END, CONVERT(numeric(28, 6), RetailPrice),
															  CASE
															  WHEN SalesPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), SalesPrice)
															  END,
															  CASE
															  WHEN TierPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), TierPrice)
															  END, SKUActivationDate, SKUExpirationDate,
															   Custom1, Custom2, Custom3,
															   CASE
															  WHEN CostPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), CostPrice)
															  END, RowNumber
			   FROM #InsertPriceForValidation;
			 
		--------------------------------------------------------------------------------------
		--- start Functional Validation 
		--------------------------------------------------------------------------------------
		--- Verify SKU is present or not 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertPrice AS ii
		WHERE ii.SKU NOT IN
		(
			SELECT SKU
			FROM @SKU
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '39', 'SKUActivationDate', SKUActivationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPrice AS IP
			   WHERE cast(SKUActivationDate as datetime) > cast(SKUExpirationDate as datetime) AND 
					 ISNULL(SKUExpirationDate, '') <> '';
					 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '108', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation
			   WHERE( TierPrice IS NULL OR TierPrice = '0') AND  TierStartQuantity  = '';
			  
			  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '109', 'TierPrice', TierPrice, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation WHERE( TierPrice IS NULL OR  TierPrice = '') AND TierStartQuantity  <> 0;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '26', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation IPV
			   WHERE TierStartQuantity = ''  
				AND	( TierPrice <> ''  OR TierPrice IS NULL ) 

			  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '26', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation IPV
			   WHERE TierStartQuantity <> '' AND 
			    ISNULL(CAST(TierStartQuantity AS numeric(28, 6)), 0) <= 0 
				AND	( TierPrice <> ''  OR TierPrice IS NULL ) 
		
		
				  
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertPrice IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

			 
 	
		-- End Function Validation 	
		---------------------------
		--- Delete Invalid Data after functional validation 
		DELETE FROM #InsertPrice
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  Guid = @NewGUId
		);
	
		-- Remove duplicate records 
		--insert into @RemoveDuplicateInsertPrice
		--(SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber )
		--Select SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber FROM @InsertPrice 
		
		--Delete from @InsertPrice 

		--insert into @InsertPrice (SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber)
		--Select SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber from @RemoveDuplicateInsertPrice rdip WHERE rdip.RowNumber IN
		--(
		--	SELECT MAX(ipi.RowNumber) FROM @InsertPrice ipi WHERE rdip.PriceListCode = ipi.PriceListCode AND rdip.SKU = ipi.SKU
		--);

		--Validate StartQuantity and EndQuantity from PriceTier : This validation only for existing data 
		--INSERT INTO @ErrorLogForInsertPrice (RowNumber,SKU,TierStartQuantity ,RetailPrice ,SalesPrice,TierPrice,Uom ,UnitSize,PriceListCode,PriceListName,CurrencyId ,ActivationDate,ExpirationDate,SKUActivationDate,SKUExpirationDate,SequenceNumber,ErrorDescription) 
		--Select IP.RowNumber,IP.SKU,IP.TierStartQuantity ,IP.RetailPrice ,IP.SalesPrice,IP.TierPrice,IP.Uom ,IP.UnitSize,IP.PriceListCode,IP.PriceListName,IP.CurrencyId ,IP.ActivationDate,IP.ExpirationDate,IP.SKUActivationDate,IP.SKUExpirationDate,IP.SequenceNumber,
		--'TierStartQuantity already exists in PriceTier table for SKU '
		--From @InsertPrice IP  Inner join
		--ZnodePriceList Zpl ON Zpl.Listcode = IP.PriceListcode and Zpl.ListName = IP.PriceListName
		--INNER JOIN ZnodeUOM Zu ON ltrim(rtrim(IP.Uom)) = ltrim(rtrim(Zu.Uom)) 
		--INNER JOIN ZnodePriceTier ZPT  ON ZPT.PriceListId = Zpl.PriceListId 
		--AND ZPT.SKU = IP.SKU
		--Where IP.TierStartQuantity  = ZPT.Quantity  
		--- Delete Invalid Data after  Validate StartQuantity and EndQuantity from PriceTier
		
		--INSERT INTO ZnodeUOM (Uom,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--Select distinct ltrim(rtrim(Uom)) , @UserId,@GetDate,@UserId,@GetDate  from @InsertPrice 
		--where ltrim(rtrim(Uom)) not in (Select ltrim(rtrim(UOM)) From ZnodeUOM where UOM  is not null )
		
		DECLARE @FailedRecordCount BIGINT, @SuccessRecordCount BIGINT 
	
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;

		SELECT @SuccessRecordCount = COUNT(DISTINCT ROWNUMBER) FROM #InsertPrice WHERE 	ROWNUMBER IS NOT NULL ;

		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		UPDATE ZP
				SET ZP.SalesPrice = IP.SalesPrice, ZP.RetailPrice = CASE
				WHEN CONVERT(varchar(100), ISNULL(IP.RetailPrice, '')) <> '' THEN IP.RetailPrice
				END, ZP.ActivationDate = CASE
				WHEN ISNULL(IP.SKUActivationDate, '') <> '' THEN IP.SKUActivationDate
				ELSE NULL
				END, ZP.ExpirationDate = CASE
				WHEN ISNULL(IP.SKUExpirationDate, '') <> '' THEN IP.SKUExpirationDate
				ELSE NULL
				END, ZP.ModifiedBy = @UserId, ZP.ModifiedDate = @GetDate,
				ZP.CostPrice =IP.CostPrice
		FROM #InsertPrice IP INNER JOIN ZnodePrice ZP ON ZP.PriceListId = @PriceListId AND  ZP.SKU = IP.SKU  
			 --Retrive last record from price list of specific SKU ListCode and Name 									
		WHERE IP.RowNumber IN
		(
			SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU 
		);
		INSERT INTO ZnodePrice( PriceListId, SKU, SalesPrice, RetailPrice, ActivationDate, ExpirationDate, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate,CostPrice )
			   SELECT @PriceListId, IP.SKU, IP.SalesPrice, IP.RetailPrice,
																						   CASE
																						   WHEN ISNULL(IP.SKUActivationDate, '') = '' THEN NULL
																						   ELSE IP.SKUActivationDate
																						   END,
																						   CASE
																						   WHEN ISNULL(IP.SKUExpirationDate, '') = '' THEN NULL
																						   ELSE IP.SKUExpirationDate
																						   END, @UserId, @GetDate, @UserId, @GetDate,IP.CostPrice
			   FROM #InsertPrice AS IP
			   WHERE NOT EXISTS
			   (
				   SELECT TOP 1 1
				   FROM ZnodePrice
				   WHERE ZnodePrice.PriceListId = @PriceListId AND 
						 ZnodePrice.SKU = IP.SKU 
			   ) AND 
					 IP.RowNumber IN
			   (
					SELECT MAX(IPI.RowNumber)
					FROM #InsertPrice AS IPI
					WHERE IPI.SKU = IP.SKU 
			   );

			 

		IF EXISTS
		(
			SELECT TOP 1 1
			FROM #InsertPrice
			WHERE CONVERT(varchar(100), TierStartQuantity) <> '' AND 
				  (CONVERT(varchar(100), TierPrice) <> '' OR CONVERT (varchar(100), TierPrice) IS NOT NULL)
		)
		BEGIN
		
			UPDATE ZPT
			  SET ZPT.Price = IP.TierPrice, ZPT.ModifiedBy = @UserId, ZPT.ModifiedDate = @GetDate,
			  ZPT.Custom1 = IP.Custom1,ZPT.Custom2 = IP.Custom2, ZPT.Custom3 = IP.Custom3 
			FROM #InsertPrice IP INNER JOIN ZnodePriceTier ZPT ON ZPT.PriceListId = @PriceListId AND  ZPT.SKU = IP.SKU AND ZPT.Quantity = IP.TierStartQuantity 
		    --Retrive last record from price list of specific SKU ListCode and Name 
			WHERE IP.RowNumber IN
			(
				SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU AND IPI.TierStartQuantity = IP.TierStartQuantity 
			);

			INSERT INTO ZnodePriceTier( PriceListId, SKU, Price, Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, Custom1, Custom2, Custom3 )
				   SELECT @PriceListId, IP.SKU, IP.TierPrice, IP.TierStartQuantity,  @UserId, @GetDate, @UserId, @GetDate, Custom1, Custom2, Custom3
				   FROM #InsertPrice AS IP 
				   WHERE NOT EXISTS
				   (
					   SELECT TOP 1 1 FROM ZnodePriceTier WHERE ZnodePriceTier.PriceListId = @PriceListId AND  ZnodePriceTier.SKU = IP.SKU AND 
							 ZnodePriceTier.Quantity = IP.TierStartQuantity
				   ) AND  IP.RowNumber IN
				   (
					   SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU AND  IPI.TierStartQuantity = IP.TierStartQuantity
				   );
		END;  

		SET @Status = 1;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		-- COMMIT TRAN ImportProducts;
		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPriceList @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PriceListId='+CAST(@PriceListId AS VARCHAR(max));
		
		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportPriceList',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;


GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = isnull(c.CatalogCode,'')) AND ISNULL(ii.RenameSynonymCode,'') = '' 

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.SynonymCode,'') LIKE '%[^a-zA-Z0-9]%')

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''
	AND exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.RenameSynonymCode,'') LIKE '%[^a-zA-Z0-9]%') and isnull(ii.RenameSynonymCode,'') <> ''
		
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False','Yes','No') AND ii.IsBidirectional <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '53', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
			   WHERE ii.SynonymCode IN
			   (
				   select SynonymCode from @InsertSearchSynonyms
					group by SynonymCode
					having count(1)>1
			   );

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '53', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
			   WHERE ii.RenameSynonymCode IN
			   (
				   select RenameSynonymCode from @InsertSearchSynonyms
					group by RenameSynonymCode
					having count(1)>1
			   ) AND ISNULL(ii.RenameSynonymCode,'') <> ''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;

	--Update existing search synonym 
	UPDATE ZSS 
	SET ZSS.SynonymCode = CASE WHEN ISNULL(IPS.RenameSynonymCode,'') <> '' THEN IPS.RenameSynonymCode ELSE ZSS.SynonymCode END , ZSS.OriginalTerm = CASE WHEN ISNULL(IPS.OriginalTerm,'') = '' THEN ZSS.OriginalTerm ELSE IPS.OriginalTerm END,
	ZSS.ReplacedBy =CASE WHEN ISNULL(IPS.ReplacedBy,'') = '' THEN ZSS.ReplacedBy ELSE IPS.ReplacedBy END,
	ZSS.IsBidirectional= CASE WHEN ISNULL (IPS.IsBidirectional,'') = '' THEN ZSS.IsBidirectional ELSE CASE WHEN IPS.IsBidirectional = 'YES' THEN '1' WHEN IPS.IsBidirectional = 'NO' THEN '0' ELSE IPS.IsBidirectional END END,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, CASE WHEN A.IsBidirectional = 'YES' THEN '1' WHEN A.IsBidirectional = 'NO' THEN '0' ELSE A.IsBidirectional END, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode)
		
	
	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPartialValidatePimProductData')
	DROP PROC Znode_ImportPartialValidatePimProductData
GO

CREATE PROCEDURE [dbo].[Znode_ImportPartialValidatePimProductData]
(   @ImportHeadName     VARCHAR(200),
    @TableName          VARCHAR(200),
    @NewGUID            NVARCHAR(200),
    @TemplateId         INT,
    @UserId             INT,
    @LocaleId           INT           = 1,
    @IsCategory         INT           = 0,
    @DefaultFamilyId    INT           = 0,
    @ImportProcessLogId INT,
    @PriceListId        INT,
	@CountryCode VARCHAR(100) = '',
	@PimCatalogId         INT    = 0 ,
	@PortalId int = 0,
	@IsAccountAddress bit = 0  
)
AS
     SET NOCOUNT ON;

/*
    Summary :   Import PimProduct ( for partial attribute import ) 
    Process :   Admin site will upload excel / csv file in database and create global temporary table
				Procedure Znode_ImportValidatePimProductData will validate data with attribute validation rule
				If datatype validation issue found in input daata will logged into table "ZnodeImportLog"
				If Data is correct and record count in table ZnodeImportLog will be 0 then process for import data into Base tables
				To import data call procedure "Znode_ImportPimProductData"
    		  
				SourceColumnName: CSV file column headers
				TargetColumnName: Attributecode from ZnodePimAttribute Table (Consider those Attributecodes configured with default family only)
*/

     BEGIN
         BEGIN TRY
             SET NOCOUNT ON;
             --BEGIN TRAN TRN_ImportValidProductData;
             DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
             DECLARE @SQLQuery NVARCHAR(MAX), @AttributeTypeName NVARCHAR(10), @AttributeCode NVARCHAR(300), @AttributeId INT, @IsRequired BIT, @SourceColumnName NVARCHAR(600), @ControlName VARCHAR(300), @ValidationName VARCHAR(100), @SubValidationName VARCHAR(300), @ValidationValue VARCHAR(300), @RegExp VARCHAR(300), @CreateDateString NVARCHAR(300), @DefaultLocaleId INT, @ImportHeadId INT, @CheckedSourceColumn NVARCHAR(600)= '', @Status BIT= 0,
			    @CsvColumnString nvarchar(max), @FailedRecordCount BIGINT,
				@SuccessRecordCount BIGINT
              --To get the total record count for update purpose in catch block
             SET @SQLQuery = 'SELECT '+CAST(@ImportProcessLogId AS VARCHAR(10))+',COUNT(*) FROM '+@TableName
			 INSERT INTO Znode_ImportCsvRowCount
			 EXEC (@SQLQuery) 

			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus(0)
			WHERE ImportProcessLogId = @ImportProcessLogId AND Status IS NULL;

             DECLARE @FamilyAttributeDetail TABLE
             (PimAttributeId       INT,
              AttributeTypeName    VARCHAR(300),
              AttributeCode        VARCHAR(300),
              SourceColumnName     NVARCHAR(600),
              IsRequired           BIT,
              PimAttributeFamilyId INT
             );
             DECLARE @AttributeDetail TABLE
             (PimAttributeId    INT,
              AttributeTypeName VARCHAR(300),
              AttributeCode     VARCHAR(300),
              SourceColumnName  NVARCHAR(600),
              IsRequired        BIT,
              ControlName       VARCHAR(300),
              ValidationName    VARCHAR(100),
              SubValidationName VARCHAR(300),
              ValidationValue   VARCHAR(300),
              RegExp            VARCHAR(300)
             );

             DECLARE @GlobalTempTableColumns TABLE(ColumnName NVARCHAR);
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#InvalidDefaultData'
             )
                 CREATE TABLE #InvalidDefaultData
                 (RowNumber  INT,
                  Value      NVARCHAR(MAX),
                  ColumnName NVARCHAR(600)
                 );
             ELSE
             DROP TABLE #InvalidDefaultData;
             IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM INFORMATION_SCHEMA.TABLES
                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#GlobalTempTableColumns'
             )
                 BEGIN

                     SET @SQLQuery = 'SELECT Column_Name, '''+@ImportHeadName+''' AS ImportHeadName  from tempdb.INFORMATION_SCHEMA.COLUMNS	where table_name = object_name(object_id('''+@TableName+'''),
					(select database_id from sys.databases where name = ''tempdb''))';
                     CREATE TABLE #GlobalTempTableColumns
                     (ColumnName   NVARCHAR(MAX),
                      TypeOfImport NVARCHAR(100)
                     );
                     INSERT INTO #GlobalTempTableColumns
                     (ColumnName,
                      TypeOfImport
                     )
                     EXEC sys.sp_sqlexec
                          @SQLQuery;
                 END;
		  -- If Exists ( Select  count(1)  from #GlobalTempTableColumns GROUP BY ColumnName  Having count(1) > 1 )
		  -- Begin
			 --   INSERT INTO ZnodeImportLog(ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
    --               Select  46,ColumnName,'',@newGUID,@UserId,@GetDate,@UserId,@GetDate, @ImportProcessLogId  from #GlobalTempTableColumns GROUP BY ColumnName  Having count(1) > 1 
				
				----'Multiple occurance of column are not allow for'
		  -- END

             IF EXISTS
             (
                 SELECT TOP 1 1
                 FROM #GlobalTempTableColumns
                 WHERE ColumnName IN('PimCategoryId', 'PimProductId', 'RowNumber')
             )
                 BEGIN
                     INSERT INTO ZnodeImportLog
                     (ErrorDescription,
                      ColumnName,
                      Data,
                      GUID,
                      CreatedBy,
                      CreatedDate,
                      ModifiedBy,
                      ModifiedDate,
                      ImportProcessLogId
                     )
                     VALUES
                     (43,
                      '',
                      '',
                      @newGUID,
                      @UserId,
                      @GetDate,
                      @UserId,
                      @GetDate,
                      @ImportProcessLogId
                     );
                 END;
             SET @DefaultLocaleId = dbo.Fn_GetDefaultLocaleId();
             --Remove old error log 
             --DELETE FROM ZnodeImportLog WHERE ImportProcessLogId in (select ImportProcessLogId  FROM ZnodeImportProcessLog  WHERE ImportTemplateId  = @TemplateId )
             --GUID = @NewGUID;
             --Delete FROM ZnodeImportProcessLog  WHERE ImportTemplateId  = @TemplateId 
		
             IF NOT EXISTS
             (
                 SELECT TOP 1 1  FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )
                 BEGIN
                     IF @ImportHeadName = 'ProductUpdate'
                      BEGIN
						  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
							  SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null ';
						  ELSE 
							 SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimProductId int null Primary KEY CLUSTERED(RowNumber)';
						 
						  EXEC sys.sp_sqlexec @SQLQuery;
			         END;
                     ELSE
                     IF @ImportHeadName = 'Category'
                         BEGIN
							  IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null ';
							  ElSE
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1),PimCategoryId int null Primary KEY CLUSTERED(RowNumber) ';
						  
							  EXEC sys.sp_sqlexec @SQLQuery;
                         END;
                     ELSE
                         BEGIN
							IF @@VERSION LIKE '%Azure%' OR @@VERSION LIKE '%Express Edition%'
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) ';
							Else 
								SET @SQLQuery = 'Alter table '+@TableName+' Add  RowNumber BIGINT Identity(1,1) Primary KEY CLUSTERED(RowNumber)';
							
							EXEC sys.sp_sqlexec @SQLQuery;
                         END;;
                 END



			--Retrive PimProductId on the basis of SKU for update product 
			SET @SQLQuery = 'UPDATE tlb SET tlb.PimProductId = ZPAV.PimProductId 
							FROM ZnodePimAttributeValue AS ZPAV INNER JOIN ZnodePimAttributeValueLocale AS ZPAVL ON 
							(ZPAVL.PimAttributeValueId = ZPAV.PimAttributeValueId) 
							INNER JOIN [dbo].[ZnodePimAttribute] ZPA on ZPAV.PimAttributeId = ZPA.PimAttributeId AND ZPA.AttributeCode= ''SKU'' 
							INNER JOIN '+@TableName+' tlb ON ZPAVL.AttributeValue = ltrim(rtrim(tlb.SKU)) ';
			EXEC sys.sp_sqlexec	@SQLQuery	 	
	
			SET @SQLQuery = 'Select 98 ,''SKU'', SKU, '''+ @newGUID + ''',' + Convert(nvarchar(100),@UserId) + ',''' +  Convert(nvarchar(100),@GetDate) + ''',' + Convert(nvarchar(100),@UserId) + ',''' + Convert(nvarchar(100),@GetDate) + ''',' +  Convert(nvarchar(100),@ImportProcessLogId)  + ',RowNumber   from  '+ @TableName + ' where PimProductId Is null ';
			INSERT INTO ZnodeImportLog
                     (ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId,RowNumber )
        	EXEC sys.sp_sqlexec	@SQLQuery	 	


			--SET @SQLQuery = '
			--INSERT INTO ZnodeImportLog
			--		(ErrorDescription,ColumnName,Data,GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId,RowNumber )
			--Select 98 ,''Attribute '', a.Name , '''+ @NewGUID + ''',' + Convert(nvarchar(100),@UserId) + ',''' +  Convert(nvarchar(100),@GetDate) + ''',' + Convert(nvarchar(100),@UserId) + ',''' + Convert(nvarchar(100),@GetDate) + ''',' +  Convert(nvarchar(100),@ImportProcessLogId)  + ',' +
			--' NULL  from tempdb.sys.columns a
			--inner join tempdb.sys.tables b on a.object_id = b.object_id 
			--where b.name in (''##ProductUpdate_' + @NewGUID +''') 
			--and NOT EXISTS (Select TOP 1 1 FROM ZnodePimAttribute PA WHERE a.name = PA.AttributeCode) AND a.Name <> ''guid''' 

   --     	EXEC sys.sp_sqlexec	@SQLQuery	 	

			SET @SQLQuery = 'Delete from  '+@TableName+ ' where PimProductId Is null ';
			EXEC sys.sp_sqlexec	@SQLQuery	 	
			
			DECLARE @RecordCount Bigint 
			SET @SQLQuery = ' Select @RecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
			EXEC sp_executesql @SQLQuery, N'@RecordCount BIGINT out' , @RecordCount=@RecordCount out


			--Generate new process for current import 
            --INSERT INTO ZnodeImportProcessLog(ImportTemplateId,Status,ProcessStartedDate,ProcessCompletedDate,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
            --SELECT @TemplateId,dbo.Fn_GetImportStatus(0),@GetDate,NULL,@UserId,@GetDate,@UserId,@GetDate;
            --SET @ImportProcessLogId = @@IDENTITY;

             SET @CreateDateString = CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''','+CONVERT(VARCHAR(100), @UserId)+','''+CONVERT(VARCHAR(100), @GetDate)+''', '+CONVERT(VARCHAR(100), @ImportProcessLogId);

             SELECT TOP 1 @ImportHeadId = ImportHeadId FROM ZnodeImportTemplate WHERE ImportTemplateId = @TemplateId;
             IF @ImportHeadName IN('ProductUpdate') AND @RecordCount > 0  
                 BEGIN 
					SET @IsCategory = 0 
				    --Get all default attribute values in attribute 
                    INSERT INTO @FamilyAttributeDetail
                    (PimAttributeId,AttributeTypeName,AttributeCode,SourceColumnName,IsRequired,PimAttributeFamilyId)
                    --Call Process to insert data of defeult family with source column name and target column name 
					SELECT distinct zpa.PimAttributeId, zat.AttributeTypeName, zpa.AttributeCode, zitm.SourceColumnName, zpa.IsRequired ,0
					FROM dbo.ZnodePimAttribute AS zpa INNER JOIN dbo.ZnodeAttributeType AS zat ON zat.AttributeTypeId = zpa.AttributeTypeId 
					LEFT OUTER JOIN dbo.ZnodeImportTemplateMapping AS zitm
					ON zpa.AttributeCode = zitm.SourceColumnName AND zitm.ImportTemplateId = @TemplateId
					WHERE zpa.IsCategory = 0 
	             END;
            -- Check attributes are manditory and not provided with source table
		   	if @TABLENAME	like '%tempdb..%'
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from tempdb.sys.columns where object_id = object_id('''+@TABLENAME+'''));';
			else 
				SET @SQLQuery = 'SELECT 42 AS ErrorDescription , SourceColumnName , '''' , '''+@NewGUID+''','+@CreateDateString+' from ZnodeImportTemplateMapping where ImportTemplateId = '+CONVERT(VARCHAR(100), @TemplateId)+' and ltrim(rtrim(SourceColumnName)) <> '''' AND ltrim(rtrim(SourceColumnName)) not in ( select isnull(Name ,'''') from sys.columns where object_id = object_id('''+@TABLENAME+'''));';
		 
		 
     		INSERT INTO ZnodeImportLog(ErrorDescription, ColumnName, Data, GUID,CreatedBy, CreatedDate,  ModifiedBy,ModifiedDate,ImportProcessLogId )
            EXEC sys.sp_sqlexec  @SQLQuery;
            IF NOT EXISTS
             (
                 SELECT TOP 1 1
                 FROM ZnodeImportLog
                 WHERE Guid = @NewGUID
                       AND ErrorDescription IN(43, 42)
                 AND ImportProcessLogId = @ImportProcessLogId
             )  AND @RecordCount > 0  
                 BEGIN
                     --Get all default attribute values in attribute 
                     IF @ImportHeadName IN('ProductUpdate', 'Category')
                         BEGIN
                             -- Check attributes are manditory and not provided with source table
                             --INSERT INTO ZnodeImportLog
                             --(ErrorDescription,
                             -- ColumnName,
                             -- Data,
                             -- GUID,
                             -- CreatedBy,
                             -- CreatedDate,
                             -- ModifiedBy,
                             -- ModifiedDate,
                             -- ImportProcessLogId
                             --)
                             --       SELECT '14' AS ErrorDescription,
                             --              AttributeCode,
                             --              '',
                             --              @NewGUID,
                             --              @UserId,
                             --              @GetDate,
                             --              @UserId,
                             --              @GetDate,
                             --              @ImportProcessLogId
                             --       FROM @FamilyAttributeDetail
                             --       WHERE ISNULL(SourceColumnName, '') = ''
                             --             AND IsRequired = 1;  

                             -- Read all attribute details with their datatype
                             INSERT INTO @AttributeDetail
                             (PimAttributeId,
                              AttributeTypeName,
                              AttributeCode,
                              SourceColumnName,
                              IsRequired,
                              ControlName,
                              ValidationName,
                              SubValidationName,
                              ValidationValue,
                              RegExp
                             )
                             EXEC Znode_ImportGetTemplateDetails
                                  @TemplateId=@TemplateId,
								  @DefaultFamilyId=@DefaultFamilyId;

							 ---- Deleted Attribute which are not provided in product import CSV and required attribute not mapped with AttributeGroup
							 Delete FAD from @AttributeDetail FAD
							 where AttributeCode not in (select Name from tempdb.sys.columns where object_id = object_id(@TableName))
							 and not exists(select * from ZnodePimAttributeGroupMapper ZPAGM inner join ZnodePimFamilyGroupMapper ZPFGM on ZPAGM.PimAttributeGroupId = ZPFGM.PimAttributeGroupId 
										   inner join ZnodePimAttribute ZPA on ZPAGM.PimAttributeId = ZPA.PimAttributeId and FAD.AttributeCode = ZPA.AttributeCode)

                             DELETE FROM @AttributeDetail
                             WHERE AttributeTypeName = 'Image'
                                   AND ValidationName <> 'IsAllowMultiUpload';
                             IF NOT EXISTS
                             (
                                 SELECT TOP 1 1
                                 FROM INFORMATION_SCHEMA.TABLES
                                 WHERE INFORMATION_SCHEMA.TABLES.TABLE_NAME = '#DefaultAttributeCode'
                             )
                                 BEGIN
                                     CREATE TABLE #DefaultAttributeCode
                                     (AttributeTypeName          VARCHAR(300),
                                      PimAttributeDefaultValueId INT,
                                      PimAttributeId             INT,
                                      AttributeDefaultValueCode  VARCHAR(100)
                                     );
                                     INSERT INTO #DefaultAttributeCode
                                     (AttributeTypeName,
                                      PimAttributeDefaultValueId,
                                      PimAttributeId,
                                      AttributeDefaultValueCode
                                     )
                                     --Call Process to insert default data value 
                                     EXEC Znode_ImportGetPimAttributeDefaultValue;
                                     DELETE FROM #DefaultAttributeCode
                                     WHERE AttributeTypeName = 'Yes/No';
                                 END;
                             ELSE
                                 BEGIN
                                     DROP TABLE #DefaultAttributeCode;
                                 END;
                         END;

                     --	Check attributes are not mapped with (Default / Other) family of Pim Product
                     --	INSERT INTO ZnodeImportLog ( ErrorDescription , ColumnName , Data , GUID , CreatedBy , CreatedDate , ModifiedBy , ModifiedDate , ImportProcessLogId)
                     --	SELECT '1' AS ErrorDescription , SourceColumnName , '' , @NewGUID , @UserId , @GetDate , @UserId , @GetDate , @ImportProcessLogId
                     --	FROM @AttributeDetail WHERE PimAttributeId NOT IN ( SELECT zpfgm.PimAttributeId FROM dbo.ZnodePimFamilyGroupMapper AS zpfgm);
                     --	Verify data in global temporary table (column wise)
						
                     DECLARE Cr_Attribute CURSOR LOCAL FAST_FORWARD
                     FOR SELECT PimAttributeId,
                                AttributeTypeName,
                                AttributeCode,
                                IsRequired,
                                SourceColumnName,
                                ControlName,
                                ValidationName,
                                SubValidationName,
                                ValidationValue,
                                RegExp
                         FROM @AttributeDetail
                         WHERE ISNULL(SourceColumnName, '') <> '';
                     OPEN Cr_Attribute;
                     FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                     WHILE @@FETCH_STATUS = 0
                         BEGIN
				             IF @AttributeTypeName = 'Number'
                                 BEGIN
							      EXEC Znode_ImportValidateNumber
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check invalid date
							
                             IF @AttributeTypeName = 'Date'
                                 BEGIN
                                     EXEC Znode_ImportValidateDate
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @ImportHeadId = @ImportHeadId,
                                          @ImportProcessLogId = @ImportProcessLogId;
                                 END;
							 -- Check Manditory Data
		 					 IF @IsRequired = 1 AND @CheckedSourceColumn <> @SourceColumnName
								BEGIN
									SET @CheckedSourceColumn = @SourceColumnName;
									EXEC Znode_ImportValidateManditoryData
									@TableName = @TableName,
									@SourceColumnName = @SourceColumnName,
									@CreateDateString = @CreateDateString,
									@ValidationName = @ValidationName,
									@ControlName = @ControlName,
									@ValidationValue = @ValidationValue,
									@NewGUID = @NewGUID,
									@ImportHeadId = @ImportHeadId;
								END;
							 --END 
							
                             IF @AttributeTypeName = 'Text'
                                 BEGIN
									--For link product
									DECLARE @IsIgnoreProcess BIT = CASE WHEN EXISTS (SELECT TOP 1 1 FROM ZnodePimAttribute WHERE AttributeCode = (SELECT TOP 1 TargetColumnName
								    FROM ZnodeImportTemplateMapping a 
									INNER JOIN ZnodeImportTemplate b ON (b.ImportTemplateId = a.ImportTemplateId )
									WHERE TemplateName = 'ProductUpdate'
									AND a.TargetColumnName <> 'SKU'
								   )
								    AND AttributeTypeId = (SELECT TOP 1 AttributeTypeId FROM ZnodeAttributeType WHERE  AttributeTypeName = 'link' )
								   ) THEN 1 ELSE 0 END 
								 
						              EXEC Znode_ImportValidateManditoryText
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId,
										  @IsIgnoreProcess = @IsIgnoreProcess;
                                 END;
                             IF @AttributeTypeName = 'Image'
                                 BEGIN
                                     EXEC Znode_ImportValidateImageData
                                          @TableName = @TableName,
                                          @SourceColumnName = @SourceColumnName,
                                          @CreateDateString = @CreateDateString,
                                          @ValidationName = @ValidationName,
                                          @ControlName = @ControlName,
                                          @ValidationValue = @ValidationValue,
                                          @NewGUID = @NewGUID,
                                          @LocaleId = @LocaleId,
                                          @DefaultLocaleId = @DefaultLocaleId,
                                          @AttributeId = @AttributeId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @ImportHeadId = @ImportHeadId;
                                 END;

								 --For link product
								 IF @AttributeTypeName = 'Link'
                                 BEGIN
										--To get the product SKU in temp table
										SELECT ZPAV.PimProductId, ZPAVL.AttributeValue as SKU
										INTO #ProductSKU
										FROM ZnodePimAttributeValue ZPAV
										INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId 
										WHERE EXISTS(SELECT * FROM ZnodePimAttribute ZPA WHERE ZPAV.PimAttributeId = zpa.PimAttributeId AND ZPA.AttributeCode = 'SKU')

                                     	SET @SQLQuery = 'SELECT ''98'' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], '+@SourceColumnName+' AS  AttributeValue,RowNumber ,GUID,  '+@CreateDateString+' 
											FROM '+@TableName+' a 
											CROSS APPLY DBO.SPLIT('+@SourceColumnName+','','')S WHERE RowNumber in (SELECT RowNumber FROM '+@TableName+' WHERE  NOT EXISTS  (Select TOP 1 1  FROM #ProductSKU WHERE SKU = S.Item ) 
											)
											';
                     
											INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
											EXEC sys.sp_sqlexec @SQLQuery;
				
                                 END;

                             --Check Default data value is valid 
                             IF @ImportHeadName IN('ProductUpdate', 'Category')
                                 BEGIN
                                     IF @AttributeId IN
                                     (
                                         SELECT PimAttributeId
                                         FROM #DefaultAttributeCode
                                     )
                                         BEGIN
							
                                                   ---Verify Image file is exists in media table or not 
                                             SET @SQLQuery = ' INSERT INTO #InvalidDefaultData (RowNumber, Value, ColumnName) 
                                             SELECT ROWNUMBER , (Select TOP 1 Item from dbo.split(' + @SourceColumnName + ','','')  SP WHERE NOT EXISTS 
                                             (Select ToP 1 1 FROM #DefaultAttributeCode DAC WHERE 
                                              DAC.AttributeTypeName <> ''Yes/No'' AND DAC.AttributeDefaultValueCode IS NOT NULL AND DAC.PimAttributeId = 
                                             ' + CONVERT(VARCHAR(100), @AttributeId) + ' AND ltrim(rtrim(SP.Item) ) = DAC.AttributeDefaultValueCode
                                             )), ''' + @SourceColumnName + ''' as [ColumnName]  FROM ' + @TableName
                                             + ' Where ISnull(' + @SourceColumnName +  ','''') <> '''''

						
                                             EXEC sys.sp_sqlexec @SQLQuery;
                                             -- Check Invalid Image 
                                             
											 SET @SQLQuery = 'SELECT ''9 '' ErrorDescription,'''+@SourceColumnName+''' as [ColumnName], 
                                             Value AS  AttributeValue,RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM #InvalidDefaultData Where Value IS NOT NULL'
                                             INSERT INTO ZnodeImportLog (ErrorDescription, ColumnName, Data, RowNumber, GUID,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
                                             EXEC sys.sp_sqlexec @SQLQuery;

											 Delete from #InvalidDefaultData

       
                                         END;
                                 END;
							
                             FETCH NEXT FROM Cr_Attribute INTO @AttributeId, @AttributeTypeName, @AttributeCode, @IsRequired, @SourceColumnName, @ControlName, @ValidationName, @SubValidationName, @ValidationValue, @RegExp;
                         END;
                     CLOSE Cr_Attribute;
                     DEALLOCATE Cr_Attribute;
                     --SELECT top 1 1 FROM @FamilyAttributeDetail where  iSNULL(SourceColumnName,'') = ''  and IsRequired = 1
                 END;
            --COMMIT TRAN TRN_ImportValidProductData;
			 

		IF @ImportHeadName IN('ProductUpdate')
		 BEGIN
		 Declare @SQLQueryNew NVARCHAR(4000)
		 Declare @SourceColumnNameProduct nvarchar(4000)   	 
		 SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		 AND ImportTemplateId = @TemplateId

		
  	--	 SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName = ''SKU  '' + ' + '  ' +@SourceColumnNameProduct + ' ' + ' + ' + ' '  + ' ZIL.ColumnName + ''  Attribute''
		 --FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			--  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber is not null';
            
			--SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  ' +@SourceColumnNameProduct+ '+' + ''' ]'' 
		 --   FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			--WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
   --         PRINT @SQLQueryNew

            SET @SQLQueryNew = 'Update ZIL SET ZIL.ColumnName =   ZIL.ColumnName ' + '  ' + ' + ' + ' '  + ''' [  SKU - '' + ' + '  ' +@SourceColumnNameProduct+ '+' + ''' ]'' 
		    FROM  '+@TableName+' T Inner join  ZnodeImportLog  ZIL ON T.Rownumber = ZIL.RowNumber 
			WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND ZIL.Rownumber IS NOT NULL';
            PRINT @SQLQueryNew

			EXEC sys.sp_sqlexec  @SQLQueryNew;
			
		END 

					 	 		 
  			 SET @SQLQuery = 'Delete FROM  '+@TableName+' Where Rownumber in (Select Rownumber from ZnodeImportLog  WHERE ImportProcessLogId = '+CONVERT(VARCHAR(100), @ImportProcessLogId)+' AND Rownumber is not null)';
             EXEC sys.sp_sqlexec  @SQLQuery;

			 ---------------------------------------------------------------------------

		--	 Declare @SourceColumnNameProduct nvarchar(4000)  
		--	 Declare @SQLQueryNew NVARCHAR(4000) 	 
		-- SELECT @SourceColumnNameProduct =  SourceColumnName from ZnodeImportTemplateMapping where TargetColumnName = 'SKU'
		-- AND ImportTemplateId = @TemplateId


		--INSERT INTO ZnodeImportLog  (ErrorDescription,ColumnName, Data, GUID,CreatedBy,
  --          CreatedDate,ModifiedBy,ModifiedDate,ImportProcessLogId)
		--	EXEC sys.sp_sqlexec  @SQLQueryNew;

		--	SET @SQLQueryNew = 'SELECT ''Successfully Imported '' ErrorDescription,''SKU'',
		--	'''+@SourceColumnNameProduct+''' AS [Data], 
  --          RowNumber ,'''+@NewGUID+''',  '+@CreateDateString+' FROM '+@TableName+' WHERE Rownumber IS NOT NULL'

------------------------------------------------------------------------------------------------

		 --SET @SQLQuery = 'Select *  FROM  '+@TableName
   --          EXEC sys.sp_sqlexec  @SQLQuery;

             IF @ImportHeadName IN('ProductUpdate')
                 BEGIN
                     IF NOT EXISTS
                
					 (
						 SELECT TOP 1 1
						 FROM ZnodeImportLog
						 WHERE Guid = @NewGUID
							   AND ErrorDescription IN (43, 42)
						 AND ImportProcessLogId = @ImportProcessLogId
					 ) AND @RecordCount > 0 
                         BEGIN
                             IF @IsCategory = 0
                                 BEGIN
                                     EXEC Znode_ImportPartialPimProductData
                                          @TableName = @TableName,
                                          @NewGUID = @NewGUID,
                                          @TemplateId = @TemplateId,
                                          @ImportProcessLogId = @ImportProcessLogId,
                                          @UserId = @UserId,
                                          @LocaleId = @LocaleId,
                                          @DefaultFamilyId = @DefaultFamilyId;
	
                                 END;
                            
                         END;

					ELSE 
					BEGIN
					-- Update Record count in log 					
					SET @SQLQuery = ' Select @FailedRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
					EXEC	sp_executesql @SQLQuery , N'@FailedRecordCount BIGINT out' , @FailedRecordCount =@FailedRecordCount out
					
					SELECT @SuccessRecordCount = 0
					UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
					WHERE ImportProcessLogId = @ImportProcessLogId;
					END

                 END
				
			SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
			SET @SQLQuery = ' Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM '+ @TableName ;
			
			EXEC	sp_executesql @SQLQuery, N'@SuccessRecordCount BIGINT out' , @SuccessRecordCount=@SuccessRecordCount out

			UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount, TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
			WHERE ImportProcessLogId = @ImportProcessLogId;

		   EXEC Znode_ImportReadErrorLog
                  @ImportProcessLogId = @ImportProcessLogId,
                  @NewGUID = @NewGUID;
             DROP TABLE #GlobalTempTableColumns;

             ---- Finally call product insert process if error not found in error log table 
             --IF EXISTS
             --(
             --    SELECT TOP 1 1
             --    FROM ZnodeImportLog
             --    WHERE ImportProcessLogId = @ImportProcessLogId
             --          AND Guid = @NewGUID
             --)
             --    BEGIN
                    --Updating the import process status
					UPDATE ZnodeImportProcessLog
					SET Status = CASE WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
										WHEN ISNULL(FailedRecordcount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
										WHEN ISNULL(FailedRecordcount,0) > 0 AND ISNULL(FailedRecordcount,0) = ISNULL(TotalProcessedRecords,0) THEN dbo.Fn_GetImportStatus( 3 )
									END, 
						ProcessCompletedDate = getdate()
					WHERE ImportProcessLogId = @ImportProcessLogId;
                 --END;
		
				--SET @SQLQuery = 'select TOP 1 * from  ' + @TableName
				--EXEC sys.sp_sqlexec @SQLQuery;
        END TRY
      
		BEGIN CATCH 
		DECLARE @TempCount TABLE (Id INT)

		Declare @SQL Varchar(max) = 'Select Count(*) As Id From '+@TableName
		INSERT INTO @TempCount
		EXEC (@SQL)

			SET @Status = 0;
			DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), 
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPartialValidatePimProductData @ImportHeadName = '''+ISNULL(@ImportHeadName,'''''')+''',@TableName='''+ISNULL(CAST(@TableName AS
			VARCHAR(50)),'''''')+''',@TemplateId='+ISNULL(CAST(@TemplateId AS VARCHAR(50)),'''')+',@NewGUID='''+ISNULL(@NewGUID,'''''')+''',@UserId='+ISNULL(CAST(@UserId AS VARCHAR(50)),'''')+',@LocaleId='+ISNULL(CAST(@LocaleId AS VARCHAR(50)),'''')+',
			@IsCategory='+ISNULL(CAST(@IsCategory AS VARCHAR(50)),'''')+',@DefaultFamilyId='+ISNULL(CAST(@DefaultFamilyId AS VARCHAR(50)),'''')+',@ImportProcessLogId='+ISNULL(CAST(@ImportProcessLogId AS VARCHAR(50)),'''')+',
			@PriceListId='+ISNULL(CAST(@PriceListId AS VARCHAR(50)),'''')+',@CountryCode='''+ISNULL(CAST(@CountryCode AS VARCHAR(50)),'''''')+''',@PimCatalogId='+ISNULL(CAST(@PimCatalogId AS VARCHAR(50)),'''')+',
			@PortalId='+ISNULL(CAST(@PortalId AS VARCHAR(50)),'''')+',@IsAccountAddress='+ISNULL(CAST(@IsAccountAddress AS VARCHAR(50)),'''')

			SELECT 0 AS ID,CAST(0 AS BIT) AS Status;       
			
			---Import process updating fail due to database error
			UPDATE ZnodeImportProcessLog
			SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
			WHERE ImportProcessLogId = @ImportProcessLogId;

			---Loging error for Import process due to database error
		    INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		    SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

			--Updating total and fail record count
		    UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		    TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		    WHERE ImportProcessLogId = @ImportProcessLogId;

			EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_ImportPartialValidatePimProductData',
			@ErrorInProcedure = 'Znode_ImportPartialValidatePimProductData',
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
		END CATCH 

     END;

GO

Delete from [ZnodePimFamilyGroupMapper]
where PimAttributeFamilyId IN (select PimAttributeFamilyId from ZnodePimAttributeFamily WHERE IsCategory = 1) 
AND PimAttributeGroupId in (SELECT PimAttributeGroupId FROM ZnodePimAttributeGroup WHERE GroupCode IN ('ProductSetting','ShippingSettings'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportPriceList')
	DROP PROC Znode_ImportPriceList
GO

CREATE PROCEDURE [dbo].[Znode_ImportPriceList]
(
	@TableName nvarchar(100),
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int,
	@NewGUId nvarchar(200),
	@PriceListId int )
AS 
	/*
	----Summary:  Import RetailPrice List 
	----		  Input XML data extracted in table format (table variable name:  #InsertPriceForValidation) by using  @xml.nodes 
	----		  Validate data column wise and store error log into @ErrorLogForInsertPrice table 
	----          Remove wrong data from table #InsertPriceForValidation and inserted correct data into @InsertPrice table for 
	----		  further processing (Importing to target database )
	---- Version 1 : Required Validation 
	---- UomName should not be null 
	---- Data for this RetailPrice list is already available  
	---- Version 2 : Required Validation 
	---- If UomName will be null then insert first record from UomTable and If UomName is wrong then raise error
	---- SKU with retailprice data is available with price list id will insert 
	---- multiple SKU with retail price is available then updated last sku details to price table and price tier table for respective price list
	----1. Import functionality should be provided only for single price list (Validate - Pending) 
	----  Tier price : TierStartQuantity should not between TierStartQuantity and TierEndQuantity for already existing SKU 
	----  In case of update details for SKU if any kind of price value will null then avoid it to update on existing value. 
	----2. From XML only SKU and RetailPrice is mandatory
	----3. SKUActivation date sholud be less than SKUExpriration date
	----4. Activation date sholud be less than Expiration date
	----5. If Tier RetailPrice has values and TierSartQuantity /TierEndQuantity or both has null value then it should not get updated/created.
	----6. ActivationDate and ExpirationDate value for tier price will be SKUActivationDate SKUExprirationDate 
	--- Change History : 
	--Remove column which is used to store range of qunatity by single column Quantity from table ZnodeTierProduct 
	--Manditory Retail price in Znodepricetable 
	-- SKUActivationfrom date and to date will used for tier price will store in single table ZnodePrice
	--Unit Testing   
	
*/
BEGIN
	BEGIN TRAN A;
	BEGIN TRY
	    DECLARE @GetDate DATETIME = dbo.Fn_GetDate();
		
		IF OBJECT_ID('#InsertPriceForValidation', 'U') IS NOT NULL 
			DROP TABLE #InsertPriceForValidation
		ELSE 
			CREATE TABLE #InsertPriceForValidation 
			(SKU varchar(300) NULL, TierStartQuantity varchar(300) NULL, RetailPrice varchar(300) NULL, SalesPrice varchar(300) NULL, TierPrice varchar(300) NULL, SKUActivationDate varchar(300) NULL, SKUExpirationDate varchar(300) NULL,
			Custom1 varchar(300) NULL, Custom2 varchar(300) NULL, Custom3 varchar(300) NULL,CostPrice varchar(100), RowNumber varchar(300) NULL)

		IF OBJECT_ID('#InsertPrice', 'U') IS NOT NULL 
			DROP TABLE #InsertPrice
		ELSE 
			CREATE TABLE #InsertPrice 
			( 
				SKU varchar(300), TierStartQuantity numeric(28, 6) NULL, RetailPrice numeric(28, 6) NULL, SalesPrice numeric(28, 6) NULL, TierPrice numeric(28, 6) NULL, SKUActivationDate varchar(300) NULL, SKUExpirationDate varchar(300) NULL,
				Custom1 varchar(300) NULL, Custom2 varchar(300) NULL, Custom3 varchar(300) NULL,CostPrice numeric(28, 6), RowNumber varchar(300)
			);
	
	
		DECLARE @SKU TABLE
		( 
				SKU nvarchar(300)
		);
		INSERT INTO @SKU
			   SELECT b.AttributeValue
			   FROM ZnodePimAttributeValue AS a
					INNER JOIN
					ZnodePimAttributeValueLocale AS b
					ON a.PimAttributeId = dbo.Fn_GetProductSKUAttributeId() AND 
					   a.PimAttributeValueId = b.PimAttributeValueId;


		DECLARE @RoundOffValue int, @MessageDisplay nvarchar(100); 
		-- Retrive RoundOff Value from global setting 

		SELECT @RoundOffValue = FeatureValues FROM ZnodeGlobalSetting WHERE FeatureName = 'PriceRoundOff';
	
		--@MessageDisplay will use to display validate message for input inventory value  

		DECLARE @sSql nvarchar(max);
		SET @sSql = ' Select @MessageDisplay_new = Convert(Numeric(28, '+CONVERT(nvarchar(200), @RoundOffValue)+'), 999999.000000000 ) ';
		EXEC SP_EXecutesql @sSql, N'@MessageDisplay_new NVARCHAR(100) OUT', @MessageDisplay_new = @MessageDisplay OUT;
		

		SET @SSQL = 'Select SKU,TierStartQuantity ,RetailPrice,SalesPrice,TierPrice,SKUActivationDate ,SKUExpirationDate ,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber FROM '+@TableName;
		INSERT INTO #InsertPriceForValidation( SKU, TierStartQuantity, RetailPrice, SalesPrice, TierPrice, SKUActivationDate, SKUExpirationDate,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber )
		EXEC sys.sp_sqlexec @SSQL;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '113', 'TierPrice', TierPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE  CONVERT(varchar(100), TierPrice) ='' AND CONVERT(varchar(100), TierStartQuantity) <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '114', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE  CONVERT(varchar(100), TierStartQuantity) ='' AND CONVERT(varchar(100), TierPrice) <> ''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'TierPrice', TierPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(TierPrice)=0  
				or exists(select * from ZnodeCulture where Symbol is not null and TierPrice like '%'+Symbol+'%')) and ISNULL(TierPrice,'')<>''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'SalesPrice', SalesPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(SalesPrice)=0	or exists(select * from ZnodeCulture where Symbol is not null and SalesPrice like '%'+Symbol+'%'))
				and ISNULL(SalesPrice,'')<>''

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'RetailPrice', RetailPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(RetailPrice)=0 or exists(select * from ZnodeCulture where Symbol is not null and RetailPrice like '%'+Symbol+'%')) and ISNULL(RetailPrice,'')<>''
		
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '2', 'CostPrice', CostPrice, @NewGUId, RowNumber , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
				FROM #InsertPriceForValidation
				WHERE (isnumeric(CostPrice)=0	or exists(select * from ZnodeCulture where Symbol is not null and CostPrice like '%'+Symbol+'%'))
				and ISNULL(CostPrice,'')<>''
		
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertPriceForValidation IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL
			   			  	
	    --- Delete Invalid Data after functional validation 
		DELETE FROM #InsertPriceForValidation
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  Guid = @NewGUId
		);
		-- 1)  Validation for SKU is pending Proper data not found and 
		--Discussion still open for Publish version where we create SKU and use the SKU code for validation 
		--Select * from ZnodePimAttributeValue  where PimAttributeId =248
		--select * from View_ZnodePimAttributeValue Vzpa Inner join ZnodePimAttribute Zpa on Vzpa.PimAttributeId=Zpa.PimAttributeId where Zpa.AttributeCode = 'SKU'
		--Select * from ZnodePimAttribute where AttributeCode = 'SKU'
		--------------------------------------------------------------------------------------
		--2)  Start Data Type Validation for XML Data  
		--------------------------------------------------------------------------------------			
		---------------------------------------------------------------------------------------
		---------If UOM will blank then retrive top -- Finctionality pending 
		---Validate 
		
		INSERT INTO #InsertPrice( SKU, TierStartQuantity, RetailPrice, SalesPrice, TierPrice, SKUActivationDate, SKUExpirationDate,
		 Custom1, Custom2, Custom3,CostPrice, RowNumber )
			   SELECT SKU,
					  CASE
					  WHEN CONVERT(Varchar(100),TierStartQuantity) = '' THEN 0
					  ELSE CONVERT(numeric(28, 6), TierStartQuantity)
					  END, CONVERT(numeric(28, 6), RetailPrice),
															  CASE
															  WHEN SalesPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), SalesPrice)
															  END,
															  CASE
															  WHEN TierPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), TierPrice)
															  END, SKUActivationDate, SKUExpirationDate,
															   Custom1, Custom2, Custom3,
															   CASE
															  WHEN CostPrice = '' THEN NULL
															  ELSE CONVERT(numeric(28, 6), CostPrice)
															  END, RowNumber
			   FROM #InsertPriceForValidation;
			 
		--------------------------------------------------------------------------------------
		--- start Functional Validation 
		--------------------------------------------------------------------------------------
		--- Verify SKU is present or not 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '98', 'SKU', SKU, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
		FROM #InsertPrice AS ii
		WHERE ii.SKU NOT IN
		(
			SELECT SKU
			FROM @SKU
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '39', 'SKUActivationDate', SKUActivationDate, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPrice AS IP
			   WHERE cast(SKUActivationDate as datetime) > cast(SKUExpirationDate as datetime) AND 
					 ISNULL(SKUExpirationDate, '') <> '';
					 
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '108', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation
			   WHERE( TierPrice IS NULL OR TierPrice = '0') AND  TierStartQuantity  = '';
			  
			  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '109', 'TierPrice', TierPrice, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation WHERE( TierPrice IS NULL OR  TierPrice = '') AND TierStartQuantity  <> 0;

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '26', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation IPV
			   WHERE TierStartQuantity = ''  
				AND	( TierPrice <> ''  OR TierPrice IS NULL ) 

			  
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
			   SELECT '26', 'TierStartQuantity', TierStartQuantity, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
			   FROM #InsertPriceForValidation IPV
			   WHERE TierStartQuantity <> '' AND 
			    ISNULL(CAST(TierStartQuantity AS numeric(28, 6)), 0) <= 0 
				AND	( TierPrice <> ''  OR TierPrice IS NULL ) 
		
		
				  
		UPDATE ZIL
			   SET ZIL.ColumnName =   ZIL.ColumnName + ' [ SKU - ' + ISNULL(SKU,'') + ' ] '
			   FROM ZnodeImportLog ZIL 
			   INNER JOIN #InsertPrice IPA ON (ZIL.RowNumber = IPA.RowNumber)
			   WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

			 
 	
		-- End Function Validation 	
		---------------------------
		--- Delete Invalid Data after functional validation 
		DELETE FROM #InsertPrice
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId AND 
				  Guid = @NewGUId
		);
	
		-- Remove duplicate records 
		--insert into @RemoveDuplicateInsertPrice
		--(SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber )
		--Select SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber FROM @InsertPrice 
		
		--Delete from @InsertPrice 

		--insert into @InsertPrice (SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber)
		--Select SKU,TierStartQuantity, RetailPrice , SalesPrice , TierPrice , Uom , UnitSize , PriceListCode , PriceListName , CurrencyId , ActivationDate , ExpirationDate 
		--, SKUActivationDate , SKUExpirationDate , RowNumber from @RemoveDuplicateInsertPrice rdip WHERE rdip.RowNumber IN
		--(
		--	SELECT MAX(ipi.RowNumber) FROM @InsertPrice ipi WHERE rdip.PriceListCode = ipi.PriceListCode AND rdip.SKU = ipi.SKU
		--);

		--Validate StartQuantity and EndQuantity from PriceTier : This validation only for existing data 
		--INSERT INTO @ErrorLogForInsertPrice (RowNumber,SKU,TierStartQuantity ,RetailPrice ,SalesPrice,TierPrice,Uom ,UnitSize,PriceListCode,PriceListName,CurrencyId ,ActivationDate,ExpirationDate,SKUActivationDate,SKUExpirationDate,SequenceNumber,ErrorDescription) 
		--Select IP.RowNumber,IP.SKU,IP.TierStartQuantity ,IP.RetailPrice ,IP.SalesPrice,IP.TierPrice,IP.Uom ,IP.UnitSize,IP.PriceListCode,IP.PriceListName,IP.CurrencyId ,IP.ActivationDate,IP.ExpirationDate,IP.SKUActivationDate,IP.SKUExpirationDate,IP.SequenceNumber,
		--'TierStartQuantity already exists in PriceTier table for SKU '
		--From @InsertPrice IP  Inner join
		--ZnodePriceList Zpl ON Zpl.Listcode = IP.PriceListcode and Zpl.ListName = IP.PriceListName
		--INNER JOIN ZnodeUOM Zu ON ltrim(rtrim(IP.Uom)) = ltrim(rtrim(Zu.Uom)) 
		--INNER JOIN ZnodePriceTier ZPT  ON ZPT.PriceListId = Zpl.PriceListId 
		--AND ZPT.SKU = IP.SKU
		--Where IP.TierStartQuantity  = ZPT.Quantity  
		--- Delete Invalid Data after  Validate StartQuantity and EndQuantity from PriceTier
		
		--INSERT INTO ZnodeUOM (Uom,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		--Select distinct ltrim(rtrim(Uom)) , @UserId,@GetDate,@UserId,@GetDate  from @InsertPrice 
		--where ltrim(rtrim(Uom)) not in (Select ltrim(rtrim(UOM)) From ZnodeUOM where UOM  is not null )
		
		DECLARE @FailedRecordCount BIGINT, @SuccessRecordCount BIGINT 
	
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;

		SELECT @SuccessRecordCount = COUNT(DISTINCT ROWNUMBER) FROM #InsertPrice WHERE 	ROWNUMBER IS NOT NULL ;

		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount,
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
		WHERE ImportProcessLogId = @ImportProcessLogId;

		UPDATE ZP
				SET ZP.SalesPrice = IP.SalesPrice, ZP.RetailPrice = CASE
				WHEN CONVERT(varchar(100), ISNULL(IP.RetailPrice, '')) <> '' THEN IP.RetailPrice
				END, ZP.ActivationDate = CASE
				WHEN ISNULL(IP.SKUActivationDate, '') <> '' THEN IP.SKUActivationDate
				ELSE NULL
				END, ZP.ExpirationDate = CASE
				WHEN ISNULL(IP.SKUExpirationDate, '') <> '' THEN IP.SKUExpirationDate
				ELSE NULL
				END, ZP.ModifiedBy = @UserId, ZP.ModifiedDate = @GetDate,
				ZP.CostPrice =IP.CostPrice
		FROM #InsertPrice IP INNER JOIN ZnodePrice ZP ON ZP.PriceListId = @PriceListId AND  ZP.SKU = IP.SKU  
			 --Retrive last record from price list of specific SKU ListCode and Name 									
		WHERE IP.RowNumber IN
		(
			SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU 
		);
		INSERT INTO ZnodePrice( PriceListId, SKU, SalesPrice, RetailPrice, ActivationDate, ExpirationDate, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate,CostPrice )
			   SELECT @PriceListId, IP.SKU, IP.SalesPrice, IP.RetailPrice,
																						   CASE
																						   WHEN ISNULL(IP.SKUActivationDate, '') = '' THEN NULL
																						   ELSE IP.SKUActivationDate
																						   END,
																						   CASE
																						   WHEN ISNULL(IP.SKUExpirationDate, '') = '' THEN NULL
																						   ELSE IP.SKUExpirationDate
																						   END, @UserId, @GetDate, @UserId, @GetDate,IP.CostPrice
			   FROM #InsertPrice AS IP
			   WHERE NOT EXISTS
			   (
				   SELECT TOP 1 1
				   FROM ZnodePrice
				   WHERE ZnodePrice.PriceListId = @PriceListId AND 
						 ZnodePrice.SKU = IP.SKU 
			   ) AND 
					 IP.RowNumber IN
			   (
					SELECT MAX(IPI.RowNumber)
					FROM #InsertPrice AS IPI
					WHERE IPI.SKU = IP.SKU 
			   );

			 

		IF EXISTS
		(
			SELECT TOP 1 1
			FROM #InsertPrice
			WHERE CONVERT(varchar(100), TierStartQuantity) <> '' AND 
				  (CONVERT(varchar(100), TierPrice) <> '' OR CONVERT (varchar(100), TierPrice) IS NOT NULL)
		)
		BEGIN
		
			UPDATE ZPT
			  SET ZPT.Price = IP.TierPrice, ZPT.ModifiedBy = @UserId, ZPT.ModifiedDate = @GetDate,
			  ZPT.Custom1 = IP.Custom1,ZPT.Custom2 = IP.Custom2, ZPT.Custom3 = IP.Custom3 
			FROM #InsertPrice IP INNER JOIN ZnodePriceTier ZPT ON ZPT.PriceListId = @PriceListId AND  ZPT.SKU = IP.SKU AND ZPT.Quantity = IP.TierStartQuantity 
		    --Retrive last record from price list of specific SKU ListCode and Name 
			WHERE IP.RowNumber IN
			(
				SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU AND IPI.TierStartQuantity = IP.TierStartQuantity 
			);

			INSERT INTO ZnodePriceTier( PriceListId, SKU, Price, Quantity, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, Custom1, Custom2, Custom3 )
				   SELECT @PriceListId, IP.SKU, IP.TierPrice, IP.TierStartQuantity,  @UserId, @GetDate, @UserId, @GetDate, Custom1, Custom2, Custom3
				   FROM #InsertPrice AS IP 
				   WHERE NOT EXISTS
				   (
					   SELECT TOP 1 1 FROM ZnodePriceTier WHERE ZnodePriceTier.PriceListId = @PriceListId AND  ZnodePriceTier.SKU = IP.SKU AND 
							 ZnodePriceTier.Quantity = IP.TierStartQuantity
				   ) AND  IP.RowNumber IN
				   (
					   SELECT MAX(IPI.RowNumber) FROM #InsertPrice AS IPI WHERE IPI.SKU = IP.SKU AND  IPI.TierStartQuantity = IP.TierStartQuantity
				   );
		END;  

		SET @Status = 1;
		
		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		-- COMMIT TRAN ImportProducts;
		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();

		DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportPriceList @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200))+',@PriceListId='+CAST(@PriceListId AS VARCHAR(max));
		
		---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportPriceList',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;

	END CATCH;
END;

GO

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 113,'Text','Tier Price must be included to import a Tier Quantity.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 113)

insert into ZnodeMessage(MessageCode,MessageType,MessageName,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select 114,'Text','Tier Quantity must be included to import a Tier Price.',2,getdate(),2,getdate()
where not exists(select * from ZnodeMessage where MessageCode = 114)

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_OmsFailedOrderPaymentsList')
	DROP PROC Znode_OmsFailedOrderPaymentsList
GO

CREATE PROCEDURE [dbo].[Znode_OmsFailedOrderPaymentsList]
( 
	@WhereClause NVARCHAR(MAX),
	@Rows        INT            = 100,
	@PageNo      INT            = 1,
	@Order_BY    VARCHAR(1000)  = '',
	@RowsCount   INT OUT			
 )
AS
/*
	Summary : This procedure is used to get the oms failed order payment details

	Unit Testing:

	EXEC [Znode_OmsFailedOrderPaymentsList] 'PortalId =1',@Order_BY = '',@RowsCount= 0, @UserId = 0 ,@Rows = 50, @PageNo = 1

	declare @p7 int
	set @p7=4
	exec sp_executesql N'Znode_OmsFailedOrderPaymentsList @WhereClause, @Rows,@PageNo,@Order_By,@RowCount OUT',N'@WhereClause nvarchar(30),
		@Rows int,@PageNo int,@Order_By nvarchar(14),@RowCount int output',@WhereClause=N'',@Rows=50,@PageNo=1,@Order_By=N'orderdate desc',
		@RowCount=@p7 output
	select @p7
*/
BEGIN
    BEGIN TRY
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
		DECLARE @SQL NVARCHAR(MAX)

		DECLARE @Fn_GetPaginationWhereClause VARCHAR(500) = dbo.Fn_GetPaginationWhereClause(@PageNo,@Rows),
			@Fn_GetFilterWhereClause NVARCHAR(MAX) = ''
		SET @Fn_GetFilterWhereClause=dbo.Fn_GetFilterWhereClause(@WhereClause)
			
		IF @Order_BY = ''
			SET @Order_BY = 'OrderDate desc'

			SET @Order_BY = REPLACE(@Order_BY,'PaymentName','ZOFOP.PaymentDisplayName')
			SET @Order_BY = REPLACE(@Order_BY,'CustomerName','ZOFOP.UserName')
			SET @Order_BY = REPLACE(@Order_BY,'EmailAddress','ZOFOP.Email')
			SET @Order_BY = REPLACE(@Order_BY,'PaymentStatus','ZOPS.Name')
			SET @Order_BY = REPLACE(@Order_BY,'failedordertotalwithcurrency','ZOFOP.TotalAmount')
			
			DECLARE @Fn_GetPagingRowId NVARCHAR(MAX) = ' DENSE_RANK()Over('+ ' Order By '+CASE WHEN ISNULL(@Order_BY,'') = '' THEN 'OmsFailedOrderPaymentId DESC' ELSE @Order_BY + ',OmsFailedOrderPaymentId DESC' END  + ') RowId '
						
			IF OBJECT_ID('tempdb..#TBL_RowCount') IS NOT NULL
				DROP TABLE #TBL_RowCount
			
			CREATE TABLE #TBL_RowCount(RowsCount INT)
			 
			SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'PaymentName','ZOFOP.PaymentDisplayName')
			SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'CustomerName','ZOFOP.UserName')
			SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'EmailAddress','ZOFOP.Email')
			SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'PaymentStatus','ZOPS.Name')
			SET @Fn_GetFilterWhereClause = REPLACE(@Fn_GetFilterWhereClause,'failedordertotalwithcurrency','ZOFOP.TotalAmount')

			SET @Fn_GetPagingRowId = REPLACE(@Fn_GetPagingRowId,'OmsFailedOrderPaymentId','OmsFailedOrderPaymentId')

			SET @Rows = @PageNo * @Rows

		SET @SQL = '
		SELECT DISTINCT TOP '+CAST(@Rows as VARCHAR(10))+' ZOFOP.OrderNumber,ZOFOP.TotalAmount,ZOFOP.OrderDate,
			ZOFOP.PaymentDisplayName As PaymentName,ZOFOP.PaymentStatusId,ZOPS.Name PaymentStatus,
			ZOFOP.TransactionToken,ZOFOP.UserName As CustomerName,ZOFOP.Email As EmailAddress, '+@Fn_GetPagingRowId+' ,
			ZOFOP.OmsFailedOrderPaymentId
		INTO #Cte_OrderLineDescribe
		FROM ZnodeOmsFailedOrderPayments ZOFOP WITH (NOLOCK)
		LEFT JOIN ZnodeOmsPaymentState ZOPS WITH (NOLOCK) ON (ZOPS.OmsPaymentStateId = ZOFOP.PaymentStatusId)
		WHERE 1=1 '+ @Fn_GetFilterWhereClause+' 
		ORDER BY '+CASE WHEN ISNULL(@Order_BY,'') = '' THEN 'ZOFOP.OmsFailedOrderPaymentId DESC' ELSE @Order_BY + ',ZOFOP.OmsFailedOrderPaymentId DESC' END +' 

		INSERT INTO #TBL_RowCount
		SELECT COUNT(*)
		FROM ZnodeOmsFailedOrderPayments ZOFOP WITH (NOLOCK)
		LEFT JOIN ZnodeOmsPaymentState ZOPS WITH (NOLOCK) ON (ZOPS.OmsPaymentStateId = ZOFOP.PaymentStatusId)
		WHERE 1=1 '+ @Fn_GetFilterWhereClause+' 
			
		Create index Ind_OrderLineDescribe_RowId on #Cte_OrderLineDescribe(RowId )

		SELECT OrderNumber,TotalAmount,OrderDate,PaymentName AS PaymentDisplayName,PaymentStatusId,PaymentStatus,TransactionToken
			,CustomerName AS UserName,EmailAddress AS Email
		FROM #Cte_OrderLineDescribe
		' + @Fn_GetPaginationWhereClause +' order by RowId '

		PRINT @SQL
		EXEC(@SQL)
		Select @RowsCount= isnull(RowsCount  ,0) from #TBL_RowCount
		
		IF OBJECT_ID('tempdb..#TBL_RowCount') is not null
				DROP TABLE #TBL_RowCount
		
    END TRY
    BEGIN CATCH
DECLARE @Status BIT ;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_OmsFailedOrderPaymentsList @WhereClause = '''+ISNULL(CAST(@WhereClause AS VARCHAR(max)),'''''')+''',@Rows='''+ISNULL(CAST(@Rows AS VARCHAR(50)),'''''')+''',@PageNo='+ISNULL(CAST(@PageNo AS VARCHAR(50)),'''')+',
		@Order_BY='+ISNULL(@Order_BY,'''''')+',@RowsCount='+ISNULL(CAST(@RowsCount AS VARCHAR(50)),'''')+',''';
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_OmsFailedOrderPaymentsList',
		@ErrorInProcedure = 'Znode_OmsFailedOrderPaymentsList',
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportCustomer')
	DROP PROC Znode_ImportCustomer
GO

CREATE PROCEDURE [dbo].[Znode_ImportCustomer]
(
	  @TableName NVARCHAR(100), 
	  @Status BIT OUT, 
	  @UserId INT, 
	  @ImportProcessLogId INT, 
	  @NewGUId NVARCHAR(200), 
	  @LocaleId INT= 0,
	  @PortalId INT ,
	  @CsvColumnString NVARCHAR(max)
)
AS
	--------------------------------------------------------------------------------------
	-- Summary :  Import SEO Details
	
	-- Unit Testing : 
	--------------------------------------------------------------------------------------

BEGIN
	BEGIN TRAN A;
	BEGIN TRY
		DECLARE @MessageDisplay NVARCHAR(100), @SSQL NVARCHAR(max),@AspNetZnodeUserId NVARCHAR(256),@ASPNetUsersId NVARCHAR(256),
		@PasswordHash NVARCHAR(max),@SecurityStamp NVARCHAR(max),@RoleId NVARCHAR(256),@IsAllowGlobalLevelUserCreation NVARCHAR(10)
		Declare @ProfileId  INT
		DECLARE @FailedRecordCount BIGINT
		DECLARE @SuccessRecordCount BIGINT
		 
		SET @SecurityStamp = '0wVYOZNK4g4kKz9wNs-UHw2'
		SET @PasswordHash = 'APy4Tm1KbRG6oy7h3r85UDh/lCW4JeOi2O2Mfsb3OjkpWTp1YfucMAvvcmUqNaSOlA==';
		SELECT  @RoleId  = Id FROM AspNetRoles WHERE   NAME = 'Customer'  

		SELECT @IsAllowGlobalLevelUserCreation = FeatureValues FROM ZnodeGlobalsetting WHERE FeatureName = 'AllowGlobalLevelUserCreation'

		DECLARE @GetDate DATETIME= dbo.Fn_GetDate();
		-- Retrive RoundOff Value FROM global setting 

		-- Three type of import required three table varible for product , category and brand
		CREATE TABLE #InsertCustomer 
		( 
			RowId INT IDENTITY(1, 1) PRIMARY KEY, RowNumber INT, UserName NVARCHAR(512) ,FirstName	NVARCHAR(200),
			LastName NVARCHAR(200), BudgetAmount	NUMERIC,Email	NVARCHAR(100),PhoneNumber	NVARCHAR(100),
		    EmailOptIn	BIT	,ReferralStatus	NVARCHAR(40),IsActive	varchar(100)	,ExternalId	NVARCHAR(max),CreatedDate DATETIME,
			ProfileName varchar(200),AccountCode NVARCHAR(100),DepartmentName varchar(300),RoleName NVARCHAR(256), GUID NVARCHAR(400)
			,PerOrderLimit INT,	PerOrderAnnualLimit NVARCHAR(100),BillingAccountNumber NVARCHAR(100),EnableUserShippingAddressSuggestion  NVARCHAR(100),
			EnablePowerBIReportOnWebStore BIT,Custom1 NVARCHAR(max),Custom2 NVARCHAR(max),Custom3 NVARCHAR(max),
			Custom4 NVARCHAR(max),Custom5 NVARCHAR(max)
		);

		SET @SSQL = 'INSERT INTO #InsertCustomer( RowNumber,' + @CsvColumnString + ',GUID)
		             SELECT RowNumber,' + @CsvColumnString + ',GUID FROM '+ @TableName;
		
		EXEC sys.sp_sqlexec @SSQL;
				
		SELECT TOP 1 @ProfileId   =  ProfileId FROM ZnodePortalprofile WHERE Portalid = @Portalid and IsDefaultRegistedProfile=1
		IF( Isnull(@ProfileId ,0) = 0 ) 
		Begin
		
		
				INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
				SELECT '62', 'Default Portal Profile', '', @NewGUId, 1 , @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
							
				UPDATE ZnodeImportProcessLog
				SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
				WHERE ImportProcessLogId = @ImportProcessLogId;
			

				SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog 
				WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
				SELECT @SuccessRecordCount = 0

				UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
				TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
				WHERE ImportProcessLogId = @ImportProcessLogId;

				DELETE FROM #InsertCustomer 
				SET @Status = 0;

				COMMIT TRAN A;
				Return 0 
		End

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '35', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.UserName like '%;%'
				
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '30', 'UserName', UserName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ltrim(rtrim(ii.UserName)) IN 
		(SELECT ltrim(rtrim(UserName))  FROM #InsertCustomer GROUP BY ltrim(rtrim(UserName))  having count(*) > 1 )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '104', 'Email', Email, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ii.Email not like '%_@_%_.__%' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )  
		SELECT '68', 'IsActive',  IsActive , @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId  
		FROM #InsertCustomer AS ii  
		WHERE ii.IsActive not in ('True','1','Yes','FALSE','0','No','')

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '77', 'AccountCode', ii.AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer ii 
		WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' 
		AND NOT EXISTS(SELECT * FROM ZnodeAccount za INNER JOIN ZnodePortalAccount zpa on za.AccountId = zpa.AccountId
			WHERE  ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za.AccountCode and zpa.PortalId = @PortalId )
		AND EXISTS(SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount za1 WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = za1.AccountCode );

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '73', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !=''   and ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') not IN 
		(
			SELECT ISNULL(LTRIM(RTRIM(AccountCode)),'') FROM ZnodeAccount   
		);

		

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '88', 'AccountCode', AccountCode, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') !='' and  exists
		(
			SELECT top 1 1 FROM  AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
		INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
		INNER JOIN ZnodeAccount ZA on  ZU.AccountId = ZA.AccountId
		WHERE ANZU.UserName = ii.UserName and  ZA.AccountCode != ii.AccountCode
		);

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '92', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> '' and  ISNULL(LTRIM(RTRIM(ii.RoleName)),'') IN ('User','Manager','Administrator')
		AND EXISTS(SELECT * FROM ZnodeUser a INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				--INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)						
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				INNER JOIN AspNetRoles ZD on u.RoleId = zd.Id
				WHERE (ii.UserName = c.UserName) and ISNULL(LTRIM(RTRIM(ii.RoleName)),'') <> ZD.Name )

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '75', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE   ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') ='' and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' 

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '74', 'RoleName', RoleName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE --ltrim(rtrim(ii.RoleName)) not IN ('User','Manager','Administrator') and ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and
			ISNULL(LTRIM(RTRIM(RoleName)),'') <> '' and not exists (SELECT top 1 1 FROM  AspNetRoles ANR WHERE name IN ('User','Manager','Administrator') and  ANR.name =ii.RoleName)

		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '76', 'DepartmentName', DepartmentName, @NewGUId, RowNumber, @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId
		FROM #InsertCustomer AS ii
		WHERE ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') <> ''
		AND NOT EXISTS(SELECT * FROM  ZnodeAccount ZA INNER JOIN ZnodeDepartment ZD on ZA.AccountId = ZD.AccountId
			WHERE ISNULL(LTRIM(RTRIM(ii.AccountCode)),'') = ltrim(rtrim(za.AccountCode))
			and ISNULL(LTRIM(RTRIM(ii.DepartmentName)),'') = ltrim(rtrim(ZD.DepartmentName)))
				

		UPDATE ZIL
		SET ZIL.ColumnName =   ZIL.ColumnName + ' [ UserName - ' + ISNULL(UserName,'') + ' ] '
		FROM ZnodeImportLog ZIL 
		INNER JOIN #InsertCustomer IPA ON (ZIL.RowNumber = IPA.RowNumber)
		WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

		--Note : Content page import is not required 
		
		-- END Function Validation 	
		-----------------------------------------------
		--- Delete Invalid Data after functional validatin  

		DELETE FROM #InsertCustomer
		WHERE RowNumber IN
		(
			SELECT DISTINCT 
				   RowNumber
			FROM ZnodeImportLog
			WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
			--AND GUID = @NewGUID
		);


		-- Update Record count IN log 
        
		SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
		SELECT @SuccessRecordCount = count(DISTINCT RowNumber) FROM #InsertCustomer
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount , 
		TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0))
		WHERE ImportProcessLogId = @ImportProcessLogId;
		-- END

		-- Insert Product Data 
				
				
				DECLARE @InsertedAspNetZnodeUser TABLE (AspNetZnodeUserId NVARCHAR(256) ,UserName NVARCHAR(512),PortalId INT )
				DECLARE @InsertedASPNetUsers TABLE (Id NVARCHAR(256) ,UserName NVARCHAR(512))
				DECLARE @InsertZnodeUser TABLE (UserId INT,AspNetUserId NVARCHAR(256),CreatedDate DATETIME )

				UPDATE ANU SET 
				ANU.PhoneNumber	= IC.PhoneNumber, ANU.LockoutEndDateUtc = case when IC.IsActive = 0 then @GetDate when IC.IsActive = 1 then null else ANU.LockoutEndDateUtc END
				FROM AspNetZnodeUser ANZU 
				INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				----Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				UPDATE ZU SET 
				ZU.FirstName	= IC.FirstName,
				ZU.LastName		= IC.LastName,
				--ZU.MiddleName	= IC.MiddleName,
				ZU.BudgetAmount = IC.BudgetAmount,
				ZU.Email		= IC.Email,
				ZU.PhoneNumber	= IC.PhoneNumber,
				ZU.EmailOptIn	= Isnull(IC.EmailOptIn,0),
				ZU.IsActive		= IC.IsActive,
				ZU.Custom1 = IC.Custom1,
				ZU.Custom2 = IC.Custom2,
				ZU.Custom3 = IC.Custom3,
				ZU.Custom4 = IC.Custom4,
				ZU.Custom5 = IC.Custom5
				--ZU.ExternalId = ExternalId
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName 
				WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZU.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END
				--WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0)

				INSERT INTO AspNetZnodeUser (AspNetZnodeUserId, UserName, PortalId)		
				OUTPUT INSERTED.AspNetZnodeUserId, INSERTED.UserName, INSERTED.PortalId	INTO  @InsertedAspNetZnodeUser 			 
				SELECT NEWID(),IC.UserName, @PortalId FROM #InsertCustomer IC 
				WHERE NOT EXISTS (SELECT TOP 1 1  FROM AspNetZnodeUser ANZ 
					WHERE CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(ANZ.PortalId,0) END = CASE WHEN @IsAllowGlobalLevelUserCreation = 'true' THEN -1 ELSE Isnull(@PortalId ,0) END 
					AND ANZ.UserName = IC.UserName)

				INSERT INTO ASPNetUsers (Id,Email,EmailConfirmed,PasswordHash,SecurityStamp,PhoneNumber,PhoneNumberConfirmed,TwoFactorEnabled,
				LockoutEndDateUtc,LockOutEnabled,AccessFailedCount,PasswordChangedDate,UserName)
				OUTPUT inserted.Id, inserted.UserName INTO @InsertedASPNetUsers
				SELECT NewId(), Email,0 ,@PasswordHash,@SecurityStamp,PhoneNumber,0,0,case when A.IsActive = 0 then @GetDate else null END LockoutEndDateUtc,1 LockoutEnabled,
				0,@GetDate,AspNetZnodeUserId FROM #InsertCustomer A INNER JOIN @InsertedAspNetZnodeUser  B 
				ON A.UserName = B.UserName
				
				INSERT INTO  ZnodeUser(AspNetUserId,FirstName,LastName,CustomerPaymentGUID,Email,PhoneNumber,EmailOptIn,
				IsActive,ExternalId, CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,UserName,Custom1,Custom2,Custom3,Custom4,Custom5)
				OUTPUT Inserted.UserId, Inserted.AspNetUserId,Inserted.CreatedDate INTO @InsertZnodeUser
				SELECT IANU.Id AspNetUserId ,IC.FirstName,IC.LastName,null CustomerPaymentGUID,IC.Email
				,IC.PhoneNumber,Isnull(IC.EmailOptIn,0),IC.IsActive,IC.ExternalId, @UserId,
				CASE WHEN IC.CreatedDate IS NULL OR IC.CreatedDate = '' THEN  @Getdate ELSE IC.CreatedDate END,
				@UserId,@Getdate,IC.UserName,IC.Custom1,IC.Custom2,IC.Custom3,IC.Custom4,IC.Custom5
				FROM #InsertCustomer IC INNER JOIN 
				@InsertedAspNetZnodeUser IANZU ON IC.UserName = IANZU.UserName  INNER JOIN 
				@InsertedASPNetUsers IANU ON IANZU.AspNetZnodeUserId = IANU.UserName 
				  	     
				INSERT INTO AspNetUserRoles (UserId,RoleId)  SELECT AspNetUserId, @RoleID FROM @InsertZnodeUser 
				INSERT INTO ZnodeUserPortal (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
				SELECT UserId, @PortalId , @UserId, IZU.CreatedDate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU

				INSERT INTO ZnodeAccountUserPermission(UserId,AccountPermissionAccessId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT UserId, 4 , @UserId, @Getdate,@UserId,@Getdate 
				FROM @InsertZnodeUser IZU
		
				------------INSERT INTO ZnodeUserGlobalAttributeValue
	
				IF OBJECT_ID('tempdb..#globaldata') IS NOT NULL 
					DROP TABLE #globaldata
				
				SELECT ZU.userid,PerOrderLimit,
					PerOrderAnnualLimit,
					BillingAccountNumber,
					EnableUserShippingAddressSuggestion,
					EnablePowerBIReportOnWebStore 
				INTO #globaldata
				FROM znodeuser ZU INNER JOIN  #InsertCustomer IC on IC.Email =ZU.EMAIL
				WHERE ZU.userid IN (SELECT userid FROM @InsertZnodeUser)
				GROUP BY ZU.userid,PerOrderLimit,
									PerOrderAnnualLimit,
									BillingAccountNumber,
									EnableUserShippingAddressSuggestion,
									EnablePowerBIReportOnWebStore 

				IF OBJECT_ID('tempdb..#globaldata1') IS NOT NULL DROP TABLE #globaldata1
				SELECT * INTO #globaldata1 FROM (SELECT userid, Cast(PerOrderLimit as varchar(100)) PerOrderLimit,
				 Cast(PerOrderAnnualLimit as varchar(100)) PerOrderAnnualLimit,
				 Cast(BillingAccountNumber as varchar(100)) BillingAccountNumber,
				 Cast(case when cast(EnableUserShippingAddressSuggestion as varchar(10))= '1' or cast(EnableUserShippingAddressSuggestion as varchar(10)) ='YES' or  cast(EnableUserShippingAddressSuggestion as varchar(10)) ='True' then 'True' else 'False'  END  as varchar(100)) EnableUserShippingAddressSuggestion,
				 Cast(case when cast(EnablePowerBIReportOnWebStore as varchar(10))= '1'  or cast(EnablePowerBIReportOnWebStore as varchar(10)) ='YES' or  cast(EnablePowerBIReportOnWebStore as varchar(10)) ='True' then 'True' else 'False' END  as varchar(100)) EnablePowerBIReportOnWebStore FROM #globaldata) ab
				UNPIVOT  
				   (avalue FOR acode IN   
					  (PerOrderLimit,
				PerOrderAnnualLimit,
				BillingAccountNumber,
				EnableUserShippingAddressSuggestion,
				EnablePowerBIReportOnWebStore)  
				)AS unpvt;  

				INSERT INTO ZnodeUserGlobalAttributeValue (UserId,	GlobalAttributeId,	GlobalAttributeDefaultValueId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT g.Userid,ZGA.GlobalAttributeId,null,null,@UserId,@Getdate,@UserId,@Getdate
					FROM #globaldata1 g INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode
					WHERE NOT EXISTS (SELECT top 1 1 FROM ZnodeUserGlobalAttributeValue ZGAV WHERE ZGAV.Userid =g.Userid and ZGA.GlobalAttributeId=ZGAV.GlobalAttributeId)

				INSERT INTO ZnodeUserGlobalAttributeValuelocale(UserGlobalAttributeValueId,	LocaleId,	AttributeValue,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate,	GlobalAttributeDefaultValueId,	MediaId,	MediaPath)
				SELECT UserGlobalAttributeValueId, @LocaleId,avalue ,@UserId,@Getdate,@UserId,@Getdate,null,null,null
					FROM ZnodeUserGlobalAttributeValue ZUGAV INNER JOIN #globaldata1 g on ZUGAV.userid =g.userid
						INNER JOIN ZnodeGlobalAttribute ZGA on ZGA.AttributeCode =g.acode and ZGA.GlobalAttributeId = ZUGAV.GlobalAttributeId
						WHERE NOT EXISTS (SELECT Top 1 1 FROM ZnodeUserGlobalAttributeValuelocale z WHERE z.UserGlobalAttributeValueId = ZUGAV.UserGlobalAttributeValueId)

				---------------------------------------------------------------------------------

				declare @Profile table (ProfileId INT)

				INSERT INTO ZnodeProfile (ProfileName,ShowOnPartnerSignup,Weighting,TaxExempt,DefaultExternalAccountNo,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,ParentProfileId)
				OUTPUT inserted.ProfileId INTO @Profile(ProfileId)
				SELECT Distinct ProfileName, 0, null,0, replace(ltrim(rtrim(ProfileName)),' ','') as DefaultExternalAccountNo, @UserId,@Getdate, @UserId,@Getdate, null as ParentProfileId				
				FROM #InsertCustomer IC
				WHERE NOT EXISTS(SELECT * FROM ZnodeProfile ZP WHERE IC.ProfileName = ZP.ProfileName )
				AND ISNULL(ic.ProfileName,'') <> ''

				INSERT INTO ZnodePortalProfile (PortalId,	ProfileId,	IsDefaultAnonymousProfile,	IsDefaultRegistedProfile,	CreatedBy,	CreatedDate,	ModifiedBy,	ModifiedDate)
				SELECT @PortalId, ProfileId, 0 AS IsDefaultAnonymousProfile, 0 AS IsDefaultRegistedProfile, @UserId,@Getdate, @UserId,@Getdate
				FROM @Profile

				UPDATE ZnodeUserProfile 
				SET ProfileId = COALESCE(ZP.ProfileId,@ProfileId)
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeUserProfile u ON u.UserId = a.UserId
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				--WHERE IC.ProfileName <> ''
				
				INSERT INTO ZnodeUserProfile (ProfileId,UserId,IsDefault,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT COALESCE(ZP.ProfileId,@ProfileId)  , a.UserId, 1 , @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				LEFT join ZnodeProfile ZP on IC.ProfileName = ZP.ProfileName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeUserProfile u WHERE u.UserId = a.UserId )
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)

				---to update accountid agaist user
				UPDATE ZU SET ZU.AccountId = ZA.AccountId 
				FROM AspNetZnodeUser ANZU INNER JOIN ASPNetUsers ANU ON ANZU.AspNetZnodeUserId = ANU.UserName 
				INNER JOIN ZnodeUser ZU ON ANU.ID = ZU.AspNetUserId	 
				INNER JOIN #InsertCustomer IC ON ANZU.UserName = IC.UserName
				INNER JOIN ZnodeAccount ZA ON ZA.AccountCode = IC.AccountCode 
				--INNER JOIN @InsertZnodeUser IZU on IZU.UserId =ZU.UserId
				WHERE Isnull(ANZU.PortalId,0) = Isnull(@PortalId ,0) and isnull(IC.AccountCode,'') <> ''
				
				update ZDU set ZDU.DepartmentId = ZD.DepartmentId, ModifiedBy = @UserId, ModifiedDate = @Getdate
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				INNER JOIN ZnodeDepartmentUser ZDU on ZDU.UserId = a.UserId
				WHERE isnull(IC.DepartmentName,'') <> ''

				INSERT INTO ZnodeDepartmentUser(UserId,DepartmentId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
				SELECT a.UserId, ZD.DepartmentId, @UserId,a.CreatedDate,@UserId,@Getdate 
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN ZnodeDepartment ZD on IC.DepartmentName = ZD.DepartmentName
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM ZnodeDepartmentUser u WHERE u.UserId = a.UserId)
				AND isnull(IC.DepartmentName,'') <> ''
		
				update u set u.RoleId = ZD.Id
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				INNER JOIN AspNetUserRoles u on u.UserId = b.Id
				WHERE isnull(IC.RoleName,'') <> ''
				
				INSERT INTO AspNetUserRoles(UserId,RoleId)
				SELECT b.Id as ASPNetUserId, ZD.Id as RoleId
				FROM ZnodeUser a
				INNER JOIN ASPNetUsers b on (b.Id = a.AspNetUserId)
				INNER JOIN AspNetZnodeUser c on (c.AspNetZnodeUserId = b.UserName)
				INNER JOIN #InsertCustomer IC on (IC.UserName = c.UserName)
				INNER JOIN AspNetRoles ZD on IC.RoleName = ZD.Name
				WHERE NOT EXISTS (SELECT TOP  1 1 FROM AspNetUserRoles u WHERE u.UserId = b.Id)
				AND EXISTS(SELECT * FROM @InsertZnodeUser IZU WHERE A.UserId = IZU.UserId)
				AND isnull(IC.RoleName,'') <> ''


		--Updating the import process status
		UPDATE ZnodeImportProcessLog
		SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
							WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
							WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
						END, 
			ProcessCompletedDate = getdate()
		WHERE ImportProcessLogId = @ImportProcessLogId;

		COMMIT TRAN A;
	END TRY
	BEGIN CATCH
	ROLLBACK TRAN A;

		SET @Status = 0;
		SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
		 DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportCustomer @TableName = '+CAST(@TableName AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@PortalId='+CAST(@PortalId AS VARCHAR(10))+',@CsvColumnString='+CAST(@CsvColumnString AS VARCHAR(max));
              	
		 ---Import process updating fail due to database error
		UPDATE ZnodeImportProcessLog
		SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
		WHERE ImportProcessLogId = @ImportProcessLogId;

		---Loging error for Import process due to database error
		INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
		SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

		--Updating total and fail record count
		UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
		TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId)
		WHERE ImportProcessLogId = @ImportProcessLogId;

        EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_ImportCustomer',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertCartLineItemsForLater')
	DROP PROC Znode_InsertCartLineItemsForLater
GO

CREATE PROCEDURE [dbo].[Znode_InsertCartLineItemsForLater]
(
	@TemplateLineItemXML XML,
    @UserId              INT,
    @Status              BIT = 0 OUT
)
AS 
/* 
	Summary :- This Procedure is Used to create the Quote Template 
    Unit Testing 
    EXEC 
    SELECT * FROM ZnodeOmsTemplate
    SELECT * FROM ZnodeOmsTemplateLineItem
*/
    BEGIN
        BEGIN TRAN InsertUpdateSaveCartLineItem;
        BEGIN TRY
            SET NOCOUNT ON;
			DECLARE @OldQty INT, @SKU NVARCHAR(600), @GetDate DATETIME = dbo.Fn_GetDate();

            DECLARE @TBL_SavecartLineitems TABLE
            (
				RowId							INT IDENTITY(1, 1),
				OmsTemplateLineItemId           INT,
				ParentOmsTemplateLineItemId     INT,
				OmsTemplateId                   INT,
				SKU                             NVARCHAR(600),
				Quantity                        NUMERIC(28, 6),
				OrderLineItemRelationshipTypeID INT,
				CustomText                      NVARCHAR(MAX),
				CartAddOnDetails                NVARCHAR(MAX),
				[Sequence]                      INT,
				AddOnValueIds                   VARCHAR(MAX),
				BundleProductIds                VARCHAR(MAX),
				ConfigurableProductIds          VARCHAR(MAX),
				GroupProductIds                 VARCHAR(MAX)
            );

            DECLARE @OrderLineItemRelationshipTypeIdAddon INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'AddOns'
            );

            DECLARE @OrderLineItemRelationshipTypeIdBundle INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Bundles'
            );

            DECLARE @OrderLineItemRelationshipTypeIdConfigurable INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Configurable'
            );

            DECLARE @OrderLineItemRelationshipTypeIdGroup INT=
            (
                SELECT TOP 1 OrderLineItemRelationshipTypeId
                FROM ZnodeOmsOrderLineItemRelationshipType
                WHERE [Name] = 'Group'
            );

            INSERT INTO @TBL_SavecartLineitems
            (
				OmsTemplateLineItemId,
				ParentOmsTemplateLineItemId,
				OmsTemplateId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails,
				[Sequence],
				AddOnValueIds,
				BundleProductIds,
				ConfigurableProductIds,
				GroupProductIds
            )
            SELECT Tbl.Col.value('OmsTemplateLineItemId[1]', 'NVARCHAR(2000)') AS OmsSavedCartLineItemId,
				Tbl.Col.value('ParentOmsTemplateLineItemId[1]', 'NVARCHAR(2000)') AS ParentOmsSavedCartLineItemId,
				Tbl.Col.value('OmsTemplateId[1]', 'NVARCHAR(2000)') AS OmsSavedCartId,
				Tbl.Col.value('SKU[1]', 'NVARCHAR(2000)') AS SKU,
				Tbl.Col.value('Quantity[1]', 'NVARCHAR(2000)') AS Quantity,
				Tbl.Col.value('OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)') AS OrderLineItemRelationshipTypeID,
				Tbl.Col.value('CustomText[1]', 'NVARCHAR(2000)') AS CustomText,
				Tbl.Col.value('CartAddOnDetails[1]', 'NVARCHAR(2000)') AS CartAddOnDetails,
				Tbl.Col.value('Sequence[1]', 'NVARCHAR(2000)') AS Sequence,
				Tbl.Col.value('AddonProducts[1]', 'NVARCHAR(2000)') AS AddOnValueIds,
				Tbl.Col.value('BundleProducts[1]', 'NVARCHAR(2000)') AS BundleProductIds,
				Tbl.Col.value('ConfigurableProducts[1]', 'NVARCHAR(2000)') AS ConfigurableProductIds,
				Tbl.Col.value('GroupProducts[1]', 'NVARCHAR(Max)') AS GroupProductIds
            FROM @TemplateLineItemXML.nodes('//ArrayOfAccountTemplateLineItemModel/AccountTemplateLineItemModel') AS Tbl(Col);
             
            DECLARE @OmsTemplateId INT, @OmsTemplateLineItemId INT;

            DECLARE @TBL_bundleAddonRows TABLE
            (
				RowId                           INT,
				SequenceId                      INT IDENTITY(1, 1),
				ParentOmsTemplateLineItemId     INT,
				SKU                             NVARCHAR(1000),
				Quantity                        NUMERIC(28, 6),
				OrderLineItemRelationshipTypeID INT,
				CustomText                      NVARCHAR(MAX),
				CartAddOnDetails                NVARCHAR(MAX)
            );

            DECLARE @AddonProductSKU NVARCHAR(MAX)=
            (
                SELECT TOP 1 AddOnValueIds
                FROM @TBL_SavecartLineitems
            ), @BundleProductSKU NVARCHAR(MAX)=
            (
                SELECT TOP 1 BundleProductIds
                FROM @TBL_SavecartLineitems
            );
            SET @OmsTemplateId =
            (
                SELECT TOP 1 OmsTemplateId
                FROM @TBL_SavecartLineitems
            );

            SET @SKU =
            (
                SELECT TOP 1 SKU
                FROM @TBL_SavecartLineitems
            );
    --        IF EXISTS
    --        (
    --            SELECT TOP 1 1
    --            FROM ZnodeOmsSavedCartLineItem AS qa
    --            WHERE EXISTS
    --            (
    --                SELECT TOP 1 1
    --                FROM @TBL_SavecartLineitems AS ssds
    --                WHERE ssds.sku = qa.SKU
    --            )
    --        )
    --        BEGIN
				--SELECT @OldQty = Quantity FROM ZnodeOmsTemplateLineItem
    --            WHERE OmsTemplateId = @OmsTemplateId AND SKU =@SKU;

    --            DELETE A 
				--FROM ZnodeOmsTemplateLineItem A
    --            WHERE OmsTemplateId = @OmsTemplateId AND SKU =@SKU
				--	AND NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem 
				--					WHERE OmsTemplateId=A.OmsTemplateId AND ParentOmsTemplateLineItemId IS NOT NULL);
    --        END; 
			
            INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
            SELECT a.RowID,
                    NULL,
                    q.Item AS SKU,
                    a.Quantity,
                    @OrderLineItemRelationshipTypeIdAddon,
                    CustomText,
                    CartAddOnDetails
            FROM @TBL_SavecartLineitems AS a
            CROSS APPLY dbo.Split(a.AddOnValueIds, ',') AS q
            WHERE a.AddOnValueIds IS NOT NULL  AND a.AddOnValueIds <> '';  

            INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
			SELECT RowID,
				NULL,
				q.Item AS SKU,
				a.Quantity,
				@OrderLineItemRelationshipTypeIdBundle,
				CustomText,
				CartAddOnDetails
			FROM @TBL_SavecartLineitems AS a
			CROSS APPLY dbo.Split(a.BundleProductIds, ',') AS q
			WHERE a.BundleProductIds IS NOT NULL AND a.BundleProductIds <>'';
            
			INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
            SELECT RowID,
                NULL,
                q.Item AS SKU,
                a.Quantity,
                @OrderLineItemRelationshipTypeIdConfigurable,
                CustomText,
                CartAddOnDetails
            FROM @TBL_SavecartLineitems AS a
            CROSS APPLY dbo.Split(a.ConfigurableProductIds, ',') AS q
            WHERE a.ConfigurableProductIds IS NOT NULL AND a.ConfigurableProductIds <>'';
            
			INSERT INTO @TBL_bundleAddonRows
            (
				RowId,
				ParentOmsTemplateLineItemId,
				SKU,
				Quantity,
				OrderLineItemRelationshipTypeID,
				CustomText,
				CartAddOnDetails
            )
            SELECT RowID,
                NULL,
                SUBSTRING(q.Item, 1, CHARINDEX('~', q.Item)-1) AS SKU,
                SUBSTRING(q.Item, CHARINDEX('~', q.Item)+1, 4000) AS Quantity,
                @OrderLineItemRelationshipTypeIdGroup,
                CustomText,
                CartAddOnDetails
            FROM @TBL_SavecartLineitems AS a
            CROSS APPLY dbo.Split(a.GroupProductIds, ',') AS q
            WHERE a.GroupProductIds IS NOT NULL AND GroupProductIds <>''
			AND isnull(q.Item,'') <> ''; 

            DECLARE @Tbl_SAvecartIds TABLE
            (
				OmsTemplateLineItemId INT,
				RowId                 INT
            );
			 
			---Parent Product Update
			UPDATE TARGET
			SET TARGET.Quantity = SOURCE.Quantity,
				TARGET.ModifiedDate = @GetDate,
				TARGET.CreatedBy = @UserId 
			FROM ZnodeOmsTemplateLineItem TARGET
			INNER JOIN @TBL_SavecartLineitems SOURCE ON (TARGET.OmsTemplateId = SOURCE.OmsTemplateId
			AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)
			AND TARGET.SKU = SOURCE.SKU
			WHERE ISNULL(SOURCE.OmsTemplateLineItemId,0) <> 0

			---Child Product Update
			UPDATE TARGET
			SET TARGET.Quantity = SCLI.Quantity,
				TARGET.ModifiedDate = @GetDate,
				TARGET.CreatedBy = @UserId 
			FROM ZnodeOmsTemplateLineItem TARGET
			INNER JOIN @TBL_SavecartLineitems SOURCE ON (TARGET.OmsTemplateId = SOURCE.OmsTemplateId
			    AND TARGET.OmsTemplateLineItemId = SOURCE.OmsTemplateLineItemId)
			INNER JOIN @TBL_bundleAddonRows SCLI ON Source.RowId = SCLI.RowId and TARGET.SKU = SCLI.SKU	
			WHERE ISNULL(SOURCE.OmsTemplateLineItemId,0) <> 0


			---Merging the Parent Product quantity
			UPDATE TARGET
			SET TARGET.Quantity = TARGET.Quantity+SOURCE.Quantity,
				TARGET.ModifiedDate = @GetDate,
				TARGET.CreatedBy = @UserId 
			FROM ZnodeOmsTemplateLineItem TARGET
			INNER JOIN @TBL_SavecartLineitems SOURCE ON (TARGET.OmsTemplateId = SOURCE.OmsTemplateId
			AND TARGET.SKU = SOURCE.SKU)
			WHERE ISNULL(SOURCE.OmsTemplateLineItemId,0) = 0 AND TARGET.ParentOmsTemplateLineItemId IS NULL

			---Merging the Child Product quantity
			UPDATE TARGET
			SET TARGET.Quantity = TARGET.Quantity+SCLI.Quantity,
				TARGET.ModifiedDate = @GetDate,
				TARGET.CreatedBy = @UserId 
			FROM ZnodeOmsTemplateLineItem TARGET
			INNER JOIN @TBL_SavecartLineitems SOURCE ON (TARGET.OmsTemplateId = SOURCE.OmsTemplateId)
			INNER JOIN @TBL_bundleAddonRows SCLI ON Source.RowId = SCLI.RowId and TARGET.SKU = SCLI.SKU	
			WHERE ISNULL(SOURCE.OmsTemplateLineItemId,0) = 0 AND TARGET.ParentOmsTemplateLineItemId IS NOT NULL

			DECLARE @OmsTemplateLineItem TABLE (OmsTemplateLineItemId INT,SKU VARCHAR(600))
				
			INSERT INTO ZnodeOmsTemplateLineItem(ParentOmsTemplateLineItemId,OmsTemplateId,SKU,Quantity
				,OrderLineItemRelationshipTypeID,CustomText,CartAddOnDetails,[Sequence],CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)    
			OUTPUT inserted.OmsTemplateLineItemId,inserted.SKU INTO @OmsTemplateLineItem
			SELECT NULL,@OmsTemplateId,Source.SKU,Source.Quantity,-- + ISNULL(@OldQty, 0),
				CASE
				WHEN Source.OrderLineItemRelationshipTypeID = 0
				THEN NULL
				ELSE Source.OrderLineItemRelationshipTypeID
				END,
				Source.CustomText,
				Source.CartAddOnDetails,
				1 --Source.Sequence
				,@UserId,@GetDate,@UserId,@GetDate
			FROM @TBL_SavecartLineitems Source
			WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem TARGET 
			WHERE TARGET.OmsTemplateId = Source.OmsTemplateId 
			AND TARGET.SKU = SOURCE.SKU AND TARGET.ParentOmsTemplateLineItemId IS NULL)

			UPDATE @TBL_bundleAddonRows SET ParentOmsTemplateLineItemId=(SELECT TOP 1 OmsTemplateLineItemId FROM @OmsTemplateLineItem);

			INSERT INTO ZnodeOmsTemplateLineItem(ParentOmsTemplateLineItemId,OmsTemplateId,SKU,Quantity
				,OrderLineItemRelationshipTypeID, CustomText,CartAddOnDetails,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate) 
			SELECT Source.ParentOmsTemplateLineItemId,@OmsTemplateId,Source.SKU,Source.Quantity,
				CASE
				WHEN Source.OrderLineItemRelationshipTypeID = 0
				THEN NULL
				ELSE Source.OrderLineItemRelationshipTypeID
				END,
				Source.CustomText,
				Source.CartAddOnDetails,
				Source.SequenceId+1
				,@UserId,@GetDate,@UserId,@GetDate
			FROM @TBL_bundleAddonRows Source
			WHERE Source.ParentOmsTemplateLineItemId IS NOT NULL
			--inner join @TBL_SavecartLineitems SCLI ON Source.RowId = SCLI.RowId
			--inner join ZnodeOmsTemplateLineItem ZOTLI ON ZOTLI.OmsTemplateId = @OmsTemplateId AND ZOTLI.ParentOmsTemplateLineItemId IS NULL AND ZOTLI.OrderLineItemRelationshipTypeID is null
			--AND SCLI.SKU = ZOTLI.SKU
			--WHERE NOT EXISTS (SELECT TOP 1 1 FROM ZnodeOmsTemplateLineItem TARGET 
			--WHERE TARGET.OmsTemplateId = SCLI.OmsTemplateId 
			--AND TARGET.OmsTemplateLineItemId = SCLI.OmsTemplateLineItemId)
  			
            SET @Status = 1;
            COMMIT TRAN InsertUpdateSaveCartLineItem;
        END TRY
    BEGIN CATCH
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
			@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertCartLineItemsForLater @TemplateLineItemXML = '+CAST(@TemplateLineItemXML AS VARCHAR(max))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
        SELECT 0 AS ID,CAST(0 AS BIT) AS Status;
			
		ROLLBACK TRAN InsertUpdateSaveCartLineItem;

        EXEC Znode_InsertProcedureErrorLog
			@ProcedureName = 'Znode_InsertCartLineItemsForLater',
			@ErrorInProcedure = @Error_procedure,
			@ErrorMessage = @ErrorMessage,
			@ErrorLine = @ErrorLine,
			@ErrorCall = @ErrorCall;
    END CATCH;
END;

GO

update ZnodeGlobalAttributeGroupLocale 
set AttributeGroupName='Return Settings' 
where AttributeGroupName='Return Setting'

GO

update ZnodeApplicationSetting
set Setting='<?xml version="1.0" encoding="utf-16"?><columns><column><id>1</id><name>HighlightId</name><headertext>Checkbox</headertext><width>10</width><datatype>Int32</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>y</ischeckbox><checkboxparamfield>HighlightId</checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>HighlightName</name><headertext>Name</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>y</isallowlink><islinkactionurl>/Highlight/Edit</islinkactionurl><islinkparamfield>HighlightId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>HighlightType</name><headertext>Highlight Type</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>IsActive</name><headertext>Status</headertext><width>10</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>DisplayOrder</name><headertext>Display Order</headertext><width>10</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>y</isvisible><mustshow>n</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>7</id><name>MediaId</name><headertext>MediaId</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>false</allowpaging><format></format><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext></displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl></manageactionurl><manageparamfield></manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>8</id><name>Manage</name><headertext>Action</headertext><width>0</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl></islinkactionurl><islinkparamfield></islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield></checkboxparamfield><iscontrol>n</iscontrol><controltype></controltype><controlparamfield></controlparamfield><displaytext>Edit|Delete</displaytext><editactionurl></editactionurl><editparamfield></editparamfield><deleteactionurl></deleteactionurl><deleteparamfield></deleteparamfield><viewactionurl></viewactionurl><viewparamfield></viewparamfield><imageactionurl></imageactionurl><imageparamfield></imageparamfield><manageactionurl>/Highlight/Edit|/Highlight/Delete</manageactionurl><manageparamfield>HighlightId,LocaleId|HighlightId</manageparamfield><copyactionurl></copyactionurl><copyparamfield></copyparamfield><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class></Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters></SearchControlParameters><DbParamField></DbParamField><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName='ZnodeHighlight'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertSaveCartLineItemsForReOrder')
	DROP PROC Znode_InsertSaveCartLineItemsForReOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertSaveCartLineItemsForReOrder] 
(
	@OmsOrderId INT, 
	@OmsSavedCartId INT ,
	@UserId INT ,
	@OmsOrderLineItemsId INT = 0,
	@Status BIT = 0 OUT
)
AS 
BEGIN 
BEGIN TRY 
  SET NOCOUNT ON 
  DECLARE @TBL_ZnodeOmsSavedCartLineItem TABLE (OmsSavedCartLineItemId INT , RowId INT)
  DECLARE @GetDate DATETIME = dbo.FN_getDate() 
  DECLARE @AddOnOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Addons')

   DECLARE @BundleOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Bundles')

   DECLARE @GroupOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Group')

   DECLARE @OmsOrderStateId_RETURNED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'RETURNED')
   DECLARE @OmsOrderStateId_CANCELED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'CANCELED')

   CREATE TABLE #ZnodeOmsOrderLineItems_temp (OmsOrderLineItemsId INT ,ParentOmsOrderLineItemsId INT,OmsOrderDetailsId INT , SKU  NVARCHAr(2000),
   OrderLineItemRelationshipTypeID INT ,AutoAddonSKU NVARCHAR(400),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),Custom4 NVARCHAR(MAX)
   ,Custom5 NVARCHAR(MAX), GroupId nvarchar(MAX),ProductName NVARCHAr(2000), Description nvarchar(MAX),Quantity NUMERIC(28,6), ROWID INT, ParentRowID INT)

  IF EXISTS (SELECT TOP 1 OmsOrderDetailsId  FROM ZnodeOmsOrderDetails WHERE  OmsOrderId =  @OmsOrderId AND IsActive =1 )
  BEGIN 

	  ;WITH CTE_OrderData AS
	  (
		  SELECT MIN(ZOOLI.OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ZOOLI.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			  ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4,
			  ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description,SUM(ZOOLI.Quantity) AS Quantity
		  FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		  INNER JOIN ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) ON ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId
		  WHERE  ZOOD.OmsOrderId =  @OmsOrderId AND ZOOD.IsActive =1 
		  AND CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 0 ELSE  ZOOLI.OrderLineItemStateId END  <> CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 1 ELSE  @OmsOrderStateId_RETURNED END 
		  GROUP BY ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4, ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description
	  )
	  INSERT INTO #ZnodeOmsOrderLineItems_temp
	  SELECT *
		,Row_number()Over(Order By OmsOrderLineItemsId )  RowId, NULL ParentRowId
	  FROM CTE_OrderData
	  ORDER BY OmsOrderLineItemsId 
  END

  ELSE 
  BEGIN
		;WITH CTE_OrderData AS
		  (
			  SELECT MIN(OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
				  ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				  ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
				  ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
			  FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
			  WHERE ( ZOO.OmsOrderLineItemsId = @OmsOrderLineItemsId OR ZOO.ParentOmsOrderLineItemsId = @OmsOrderLineItemsId ) 
			  AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE ZOO.OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
			  GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4, ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description
		 )
		 INSERT INTO #ZnodeOmsOrderLineItems_temp
		 SELECT *,Row_number()Over(Order By OmsOrderLineItemsId )   RowId, NULL ParentRowId
		 FROM CTE_OrderData

		INSERT INTO #ZnodeOmsOrderLineItems_temp 
		SELECT MIN(ZOO.OmsOrderLineItemsId) AS OmsOrderLineItemsId,MIN(ZOO.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
		ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
		ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
		ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
		,0 RowId, NULL ParentRowId
		FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
		WHERE ZOO.OmsOrderLineItemsId = (SELECT TOP 1 ParentOmsOrderLineItemsId FROM #ZnodeOmsOrderLineItems_temp TY WHERE TY.ParentOmsOrderLineItemsId IS NOT NULL 
		AND TY.OrderLineItemRelationshipTypeID <> @AddOnOrderLineItemRelationshipTypeId )
		AND ZOO.ParentOmsOrderLineItemsId  IS NULL
		AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
		AND NOT EXISTS(SELECT * FROM #ZnodeOmsOrderLineItems_temp tem WHERE tem.OmsOrderLineItemsId = ZOO.OmsOrderLineItemsId )
		GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
			ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description;

  END

     DECLARE @TBL_OmsSavedCartOld TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 DECLARE @TBL_OmsSavedCartNew TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 
	 SELECT SKU , OmsOrderLineItemsId, ParentOmsOrderLineItemsId, OrderLineItemRelationshipTypeID,Quantity 
	 INTO #ZnodeOmsSavedCartLineItemOld
	 FROM #ZnodeOmsOrderLineItems_temp a 

	 SELECT OmsOrderLineItemsId, PersonalizeCode, PersonalizeValue  
	 INTO #ZnodeOmsPersonalizeCartItemOld
	 FROM ZnodeOmsPersonalizeItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp t WHERE t.OmsOrderLineItemsId = a.OmsOrderLineItemsId)

	 SELECT SKU , OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeID, Quantity
	 INTO #ZnodeOmsSavedCartLineItemNew
	 FROM ZnodeOmsSavedCartLineItem a WITH (NOLOCK)
	 WHERE OmsSavedCartId = @OmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue   
	 INTO #ZnodeOmsPersonalizeCartItemNew
	 FROM ZnodeOmsPersonalizeCartItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 INSERT INTO @TBL_OmsSavedCartOld (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	 SELECT SKU , OmsOrderLineItemsId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemOld TBL_B WHERE TBL_B.OmsOrderLineItemsId = ISNULL(TBL_A.ParentOmsOrderLineItemsId,0)  ) ParentSKU
				, ParentOmsOrderLineItemsId
	 FROM #ZnodeOmsSavedCartLineItemOld TBL_A
	 WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId

	 ;With Cte_UpdateOld AS 
	 (
		SELECT ParentOmsOrderLineItemsId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsOrderLineItemsId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemOld a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN Cte_UpdateOld TBL_ON ON (TBL_ON.ParentOmsOrderLineItemsId  = TBL_O.OmsSavedCartLineItemId )

	  INSERT INTO @TBL_OmsSavedCartNew (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	  SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemNew TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL( TBL_A.ParentOmsSavedCartLineItemId,0)   ) ParentSKU
				, ParentOmsSavedCartLineItemId
	  FROM #ZnodeOmsSavedCartLineItemNew TBL_A
	  WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	 ;With Cte_UpdateNew AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )	 
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN Cte_UpdateNew TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000) 
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000)  
	  FROM @TBL_OmsSavedCartNew TBL_O 
	

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000)
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000) 
	  FROM @TBL_OmsSavedCartOld TBL_O 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartOld a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartNew a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	 UPDATE a 
	 SET  a.Quantity =  a.Quantity+d.Quantity 
	 FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId)

	 ;WITH CTE_UpdateOrder 
	 AS 
	 (
	   SELECT Sequence,  ROW_NUMBER()Over(order BY OmsSavedCartLineItemId ASC) RowId
	   FROM ZnodeOmsSavedCartLineItem WITH (NOLOCK)
	   WHERE  OmsSavedCartId = @OmsSavedCartId
	 
	 ) 
	 UPDATE CTE_UpdateOrder 
	 SET Sequence = RowId

		DECLARE @DeletedId TABLE (OmsSavedCartLineItemId INT )

	
		DELETE  FROM #ZnodeOmsOrderLineItems_temp OUTPUT DELETED.OmsOrderLineItemsId INTO @DeletedId WHERE OmsOrderLineItemsId IN (SELECT c.OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
		INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId))


		DELETE FROM #ZnodeOmsOrderLineItems_temp WHERE ParentOmsOrderLineItemsId IN (SELECT OmsSavedCartLineItemId FROM @DeletedId)

		DELETE TR FROM #ZnodeOmsOrderLineItems_temp TR 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp YU WHERE TR.OmsOrderLineItemsId = YU.ParentOmsOrderLineItemsId  ) 
		AND TR.ParentOmsOrderLineItemsId IS NULL 

		UPDATE B
		SET B.ParentRowID = A.ROWID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON A.OmsOrderLineItemsId = B.ParentOmsOrderLineItemsId
		WHERE A.ParentOmsOrderLineItemsId IS NULL

		UPDATE B
		SET B.ParentRowID = A.ParentRowID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON (A.OrderLineItemRelationshipTypeID=B.OrderLineItemRelationshipTypeID)
		WHERE A.ParentOmsOrderLineItemsId IS NOT NULL AND B.ParentRowID IS NULL


	BEGIN TRANSACTION ReorderSaveCart
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails
											,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description)
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.Sequence INTO @TBL_ZnodeOmsSavedCartLineItem 
		SELECT NULL,@OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,NULL CustomText, NULL CartAddOnDetails
											,RowId,@UserId,@GetDate,@UserId,@GetDate,AutoAddonSKU,NULL OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description
		FROM #ZnodeOmsOrderLineItems_temp 
		ORDER BY OmsOrderLineItemsId 

		UPDATE ab 
		SET ab.ParentOmsSavedCartLineItemId = 
			(SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_ZnodeOmsSavedCartLineItem av WHERE av.RowId = b.ParentRowID)
		FROM ZnodeOmsSavedCartLineItem ab 
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem a ON (a.OmsSavedCartLineItemId = ab.OmsSavedCartLineItemId) 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON  (b.RowId = a.RowId) 

		INSERT INTO ZnodeOmsPersonalizeCartItem (OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
		SELECT c.OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,@UserId,@GetDate,@UserId,@GetDate,DesignId,ThumbnailURL
		FROM ZnodeOmsPersonalizeItem  a 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON (a.OmsOrderLineItemsId = b.OmsOrderLineItemsId)
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem c ON (c.RowId = b.RowId)

		UPDATE ZOSCLI1 set Quantity = null
		from ZnodeOmsSavedCartLineItem ZOSCLI1
		where ParentOmsSavedCartLineItemId is null and OmsSavedCartId = @OmsSavedCartId
		and Quantity is not null
		and not exists(select * from ZnodeOmsSavedCartLineItem ZOSCLI where OrderLineItemRelationshipTypeId IN (@BundleOrderLineItemRelationshipTypeId,@GroupOrderLineItemRelationshipTypeId ) and ZOSCLI1.OmsSavedCartLineItemId = ZOSCLI.ParentOmsSavedCartLineItemId )

		--Update Qty for Parentlineitem except simple product
		UPDATE ZOSCLI
		SET Quantity = ZOSCLI.Quantity+Old.Quantity
		FROM ZnodeOmsSavedCartLineItem ZOSCLI
		INNER JOIN #ZnodeOmsSavedCartLineItemNew New ON (ZOSCLI.OmsSavedCartLineItemId = New.OmsSavedCartLineItemId)
		INNER JOIN #ZnodeOmsSavedCartLineItemOld Old ON (New.SKU = Old.SKU)
		WHERE ZOSCLI.ParentOmsSavedCartLineItemId IS NULL AND OmsSavedCartId = @OmsSavedCartId AND ZOSCLI.Quantity IS NOT NULL
	    --AND EXISTS(SELECT * FROM ZnodeOmsSavedCartLineItem ZOSCLI WHERE OrderLineItemRelationshipTypeId=@BundleOrderLineItemRelationshipTypeId)

		UPDATE ZnodeOmsSavedCart
		SET ModifiedDate = GETDATE()
		WHERE OmsSavedCartId = @OmsSavedCartId
	COMMIT TRANSACTION ReorderSaveCart
	SET @status = 1 
   
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION ReorderSaveCart
		SELECT ERROR_MESSAGE()
		SET @status = 0 

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertSaveCartLineItemsForReOrder @OmsOrderId = '+CAST(@OmsOrderId AS VARCHAR(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@OmsSavedCartId='+CAST(@OmsSavedCartId AS VARCHAR(50))+',@OmsOrderLineItemsId='+CAST(@OmsOrderLineItemsId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_InsertSaveCartLineItemsForReOrder',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH 
END

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Store','GetAssociatedInvoiceManagementPaymentList',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'GetAssociatedInvoiceManagementPaymentList')

INSERT INTO ZnodeActionMenu ( MenuId,        ActionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store')        
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'GetAssociatedInvoiceManagementPaymentList') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'GetAssociatedInvoiceManagementPaymentList'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,        ActionId, AccessPermissionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'GetAssociatedInvoiceManagementPaymentList')        
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'GetAssociatedInvoiceManagementPaymentList'))

---ZPD-16959
INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Store','EditStoreKlaviyo',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'EditStoreKlaviyo')

INSERT INTO ZnodeActionMenu ( MenuId,        ActionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store')        
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'EditStoreKlaviyo') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'EditStoreKlaviyo'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,        ActionId, AccessPermissionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'EditStoreKlaviyo')        
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'EditStoreKlaviyo'))

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetRequestedInventory')
	DROP PROC Znode_GetRequestedInventory
GO

Create PROCEDURE [dbo].[Znode_GetRequestedInventory]

AS
BEGIN
	BEGIN TRY
		 DECLARE @SKU NVARCHAR(max) 
		 	
		DECLARE @PortalId int
		 		IF OBJECT_ID('tempdb..#Tbl_Inventory') IS NOT NULL
				DROP TABLE #Tbl_Inventory
				Create TABLE #Tbl_Inventory
				(
					  SKU            VARCHAR(300),
					  Quantity    NUMERIC(28, 6),
					  ReOrderLevel     NUMERIC(28, 6),
					  PortalId      int,
					  WarehouseName	varchar(100),
					  WarehouseCode	varchar(100),
					  DefaultInventoryCount varchar(1000),
			    );

				IF OBJECT_ID('tempdb..#Tbl_InStockProduct') IS NOT NULL
				DROP TABLE #Tbl_InStockProduct
				 		Create TABLE #Tbl_InStockProduct
				(
					  StockNoticeId int,
					  ParentSKU VARCHAR(300),
					  SKU            VARCHAR(300),
					  AvailableQuantity  NUMERIC(28, 6),
					  InStockQty NUMERIC(28, 6),
					  PublishProductId int,
				      ImageSmallPath varchar(500),
				      SeoUrl varchar(1000),
					  ProductName varchar(1000),
					  ProductAttributes nvarchar(MAX)
			    );

				IF OBJECT_ID('tempdb..#Tbl_PublishProduct') IS NOT NULL
				DROP TABLE #Tbl_PublishProduct
				Create TABLE #Tbl_PublishProduct
				(
					  SKU  VARCHAR(300),
					  PublishProductId int,
					  ImageSmallPath varchar(500),
					  SeoUrl varchar(1000),
					  ProductName varchar(1000),
					  ProductAttributes nvarchar(MAX)
				)

				SELECT ZPE.SKU, ZPE.ZnodeProductId, ZPE.ImageSmallPath, ZPE.SeoUrl, ZPE.Name, ZPE.Attributes ,ZPE.IsActive, ZPE.VersionId
				INTO #PublishProductEntity
				FROM ZnodePublishProductEntity ZPE WITH (NOLOCK)
				WHERE EXISTS(SELECT * FROM ZnodeStockNotice ZSN WHERE ZPE.SKU = ZSN.SKU OR ZPE.SKU = ZSN.ParentSKU AND ZPE.ZnodeCatalogId = ZSN.CatalogId )
				AND ZPE.IsActive = 1
				AND EXISTS(SELECT * FROM ZnodePublishVersionEntity ZPV WHERE ZPV.ZnodeCatalogId = ZPE.ZnodeCatalogId AND ZPV.RevisionType = 'Production' AND ZPV.VersionId = ZPE.VersionId)


				INSERT INTO #Tbl_PublishProduct(SKU, PublishProductId, ImageSmallPath, SeoUrl, ProductName, ProductAttributes)
				SELECT DISTINCT ZPE.SKU, ZPE.ZnodeProductId, ZPE.ImageSmallPath, ZPE.SeoUrl, ZPE.Name, ZPE.Attributes  
				FROM ZnodeStockNotice  ZSN 
				inner JOIN #PublishProductEntity ZPE ON ZPE.SKU = ZSN.SKU  or ZPE.SKU = ZSN.ParentSKU

				DECLARE CUR_PortalId Cursor For
				SELECT DISTINCT PortalId
				FROM ZnodeStockNotice WHERE IsEmailSent = 0

				OPEN CUR_PortalId
				FETCH NEXT FROM CUR_PortalId INTo @PortalId

				WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @SKU = ''
					SELECT @SKU =  Substring((SELECT distinct ',' + SKU  FROM ZnodeStockNotice WHERE PortalId = @PortalId AND IsEmailSent = 0  FOR XML PAth('')), 2, 4000)
					
					INSERT INTO #Tbl_Inventory (SKU,	Quantity,	ReOrderLevel,	PortalId, WarehouseName, WarehouseCode, DefaultInventoryCount)
					EXEC Znode_GetInventoryBySkus @SKUs=@SKU,@PortalId=@PortalId
					FETCH NEXT FROM CUR_PortalId INTO @PortalId

					
			    END
				CLOSE CUR_PortalId
				DEALLOCATE CUR_PortalId

				INSERT INTO #Tbl_InStockProduct(StockNoticeId, ParentSKU, SKU, AvailableQuantity, InStockQty, PublishProductId,
				ImageSmallPath, SeoUrl, ProductName, ProductAttributes)
				SELECT ZSN.StockNoticeId, ZSN.ParentSKU, ZSN.SKU, TBLI.Quantity, CASE WHEN TBLI.Quantity >= ZSN.Quantity THEN TBLI.Quantity  END, 
					PP1.PublishProductId, PP.ImageSmallPath, 
					PP1.SeoUrl,
					PP.ProductName, PP.ProductAttributes
				FROM ZnodeStockNotice ZSN 
				INNER JOIN #Tbl_Inventory TBLI ON ZSN.SKU = TBLI.SKU 
				INNER JOIN #Tbl_PublishProduct PP ON PP.SKU = ZSN.SKU
				INNER JOIN #Tbl_PublishProduct PP1 ON PP1.SKU = ZSN.ParentSKU
				where TBLI.PortalId = ZSN.PortalId
		
			   SELECT DISTINCT ZSN.SKU as ProductSKU,  ZSN.*,TSP. * 
			   FROM ZnodeStockNotice ZSN 
			   INNER JOIN #Tbl_InStockProduct TSP ON ZSN.SKU = TSP.SKU  and ZSN.StockNoticeId = TSP.StockNoticeId
			   WHERE TSP.InStockQty IS NOT NULL AND ZSN.IsEmailSent = 0 



	END TRY

	BEGIN CATCH
		DECLARE @Status BIT;
		SET @Status = 0;
		DECLARE @Error_procedure VARCHAR(1000) = ERROR_PROCEDURE()
			,@ErrorMessage NVARCHAR(MAX) = ERROR_MESSAGE()
			,@ErrorLine VARCHAR(100) = ERROR_LINE()
			,@ErrorCall NVARCHAR(MAX) = 'EXEC Znode_GetRequestedInventory'
		SELECT 0 AS ID
			,CAST(0 AS BIT) AS STATUS;
		EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_GetRequestedInventory'
			,@ErrorInProcedure = ''
			,@ErrorMessage = @ErrorMessage
			,@ErrorLine = @ErrorLine
			,@ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_GetPublishSingleProductJson')
	DROP PROC Znode_GetPublishSingleProductJson
GO

CREATE PROCEDURE [dbo].[Znode_GetPublishSingleProductJson]
(
	 @PublishCatalogId INT = 0 
	,@VersionId       VARCHAR(50) = 0 
	,@PimProductId    TransferId Readonly 
	,@UserId		  INT = 0 
	,@TokenId nvarchar(max)= ''	
	,@LocaleIds TransferId READONLY
	,@PublishStateId INT = 0  
	,@RevisionType varchar(50)
	,@Status bit = 0 OutPut
	
)
AS


--Declare @PimProductId TransferId 
--insert into @PimProductId  select 230147
-- EXEC Znode_GetPublishSingleProductJson  @PublishCatalogId = 0 ,@VersionId= 0 ,@PimProductId =@PimProductId, @UserId=2 ,@RevisionType ='Production'


BEGIN 
BEGIN TRY 
 SET NOCOUNT ON 

EXEC Znode_InsertUpdatePimAttributeJson 1 
EXEC Znode_InsertUpdateCustomeFieldJson 1
EXEC Znode_InsertUpdateAttributeDefaultValueJson 1 

DECLARE @PimMediaAttributeId INT = dbo.Fn_GetProductImageAttributeId()
				
Select ZPLPD.PimParentProductId, ZPLPD.PimProductId, ZPLPD.PimAttributeId, ZPAVL.AttributeValue as SKU
into #LinkProduct
FROM ZnodePimLinkProductDetail ZPLPD 
INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId = ZPLPD.PimProductId)
INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON ZPAV.PimAttributeValueId = ZPAVL.PimAttributeValueId
WHERE exists(select * from ZnodePimAttribute ZPA where ZPA.PimAttributeId = ZPAV.PimAttributeId and ZPA.AttributeCode = 'SKU')
and exists(select * from @PimProductId pp where ZPLPD.PimParentProductId = pp.Id)

select * into #PimProductId from @PimProductId

create index Idx_#PimProductId_Id on #PimProductId(Id)
 IF OBJECT_ID('tempdb..#Cte_BrandData') is not null
 BEGIN 
	DROP TABLE #Cte_BrandData
 END 
 

 IF OBJECT_ID('tempdb..#ProductIds') is not null
 BEGIN 
	DROP TABLE #ProductIds
 END 

			Create Table #ProductIds (PimProductId int, PublishProductId  int )
			
			--DECLARE @PimProductAttributeJson TABLE(PimAttributeJsonId INT  PRIMARY KEY ,PimAttributeId INT,LocaleId INT  )
			CREATE TABLE #PimProductAttributeJson (PimAttributeJsonId INT  PRIMARY KEY ,PimAttributeId INT,LocaleId INT  )
			DECLARE @PimDefaultValueLocale  TABLE (PimAttributeDefaultJsonId INT  PRIMARY KEY ,PimAttributeDefaultValueId INT ,LocaleId INT ) 
			DECLARE @ProductNamePimAttributeId INT = dbo.Fn_GetProductNameAttributeId(),@DefaultLocaleId INT= Dbo.Fn_GetDefaultLocaleId(),@LocaleId INT = 0 
			,@SkuPimAttributeId  INT =  dbo.Fn_GetProductSKUAttributeId() , @IsActivePimAttributeId INT =  dbo.Fn_GetProductIsActiveAttributeId()
			DECLARE @GetDate DATETIME =dbo.Fn_GetDate()
			DECLARE @TBL_LocaleId  TABLE (RowId INT IDENTITY(1,1) PRIMARY KEY  , LocaleId INT )

			DECLARE @DomainUrl varchar(max) = (select TOp 1 URL FROM ZnodeMediaConfiguration WHERE IsActive =1)

			INSERT INTO @TBL_LocaleId (LocaleId)
			SELECT  LocaleId
			FROM ZnodeLocale MT
			WHERE IsActive = 1
			AND (EXISTS (SELECT TOP 1 1  FROM @LocaleIds RT WHERE RT.Id = MT.LocaleId )
			OR NOT EXISTS (SELECT TOP 1 1 FROM @LocaleIds )) 
	
			-----to update link products newly addded and deleted from PIM
			delete ZPAP
			from ZnodePublishAssociatedProduct ZPAP
			where ZPAP.IsLink = 1
			AND not exists(select * from ZnodePimLinkProductDetail ZPPD where ZPAP.ParentPimProductId = ZPPD.PimParentProductId AND ZPAP.PimProductId = ZPPD.PimProductId)
			and exists(select * from #PimProductId PP where PP.Id = ZPAP.ParentPimProductId )

			UPDATE ZPACP SET ZPACP.DisplayOrder = ZPLPD.DisplayOrder
			from ZnodePimLinkProductDetail ZPLPD
			INNER JOIN ZnodePimCategoryProduct ZPCP ON ZPLPD.PimParentProductId = ZPCP.PimProductId
			INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId
			INNER JOIN ZnodePublishAssociatedProduct ZPACP ON ZPCH.PimCatalogId = ZPACP.PimCatalogId and ZPLPD.PimParentProductId = ZPACP.ParentPimProductId AND ZPLPD.PimProductId = ZPACP.PimProductId 
			where exists(select * from #PimProductId PP where PP.Id = ZPLPD.PimParentProductId )
			AND ZPACP.IsLink = 1

			insert into ZnodePublishAssociatedProduct(PimCatalogId,ParentPimProductId,PimProductId,PublishStateId,IsConfigurable,IsBundle,IsGroup,IsAddOn,IsLink,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
			select distinct ZPCH.PimCatalogId, ZPLPD.PimParentProductId, ZPLPD.PimProductId, @PublishStateId, 0, 0, 0, 0, 1, ZPLPD.DisplayOrder, @UserId,@GetDate ,@UserId , @GetDate
			from ZnodePimLinkProductDetail ZPLPD
			INNER JOIN ZnodePimCategoryProduct ZPCP ON ZPLPD.PimParentProductId = ZPCP.PimProductId
			INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId
			where exists(select * from #PimProductId PP where PP.Id = ZPLPD.PimParentProductId )
			and not exists(select * from ZnodePublishAssociatedProduct ZPACP where ZPCH.PimCatalogId = ZPACP.PimCatalogId and ZPLPD.PimParentProductId = ZPACP.ParentPimProductId AND ZPLPD.PimProductId = ZPACP.PimProductId  )
		
			-----to update config products newly addded and deleted from PIM
			delete ZPAP
			from ZnodePublishAssociatedProduct ZPAP
			where ZPAP.IsConfigurable = 1
			AND exists(select * from ZnodePimProductTypeAssociation ZPPD where ZPAP.ParentPimProductId = ZPPD.PimParentProductId )
			and exists(select * from #PimProductId PP where PP.Id = ZPAP.ParentPimProductId )

			Update ZPACP SET ZPACP.DisplayOrder = ZPLPD.DisplayOrder
			from ZnodePimProductTypeAssociation ZPLPD
			INNER JOIN ZnodePimCategoryProduct ZPCP ON ZPLPD.PimParentProductId = ZPCP.PimProductId
			INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId
			INNER JOIN ZnodePublishAssociatedProduct ZPACP ON ZPCH.PimCatalogId = ZPACP.PimCatalogId and ZPLPD.PimParentProductId = ZPACP.ParentPimProductId AND ZPLPD.PimProductId = ZPACP.PimProductId
			where exists(select * from #PimProductId PP where PP.Id = ZPLPD.PimParentProductId )
			AND ZPACP.IsConfigurable = 1

			insert into ZnodePublishAssociatedProduct(PimCatalogId,ParentPimProductId,PimProductId,PublishStateId,IsConfigurable,IsBundle,IsGroup,IsAddOn,IsLink,DisplayOrder,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate, IsDefault)
			select distinct ZPCH.PimCatalogId, ZPLPD.PimParentProductId, ZPLPD.PimProductId, @PublishStateId, 1, 0, 0, 0, 0, ZPLPD.DisplayOrder, @UserId,@GetDate ,@UserId , @GetDate, ZPLPD.IsDefault
			from ZnodePimProductTypeAssociation ZPLPD
			INNER JOIN ZnodePimCategoryProduct ZPCP ON ZPLPD.PimParentProductId = ZPCP.PimProductId
			INNER JOIN ZnodePimCategoryHierarchy ZPCH ON ZPCP.PimCategoryId = ZPCH.PimCategoryId
			where exists(select * from #PimProductId PP where PP.Id = ZPLPD.PimParentProductId )
			and not exists(select * from ZnodePublishAssociatedProduct ZPACP where ZPCH.PimCatalogId = ZPACP.PimCatalogId and ZPLPD.PimParentProductId = ZPACP.ParentPimProductId AND ZPLPD.PimProductId = ZPACP.PimProductId  )
			--group by ZPCH.PimCatalogId, ZPLPD.PimParentProductId, ZPLPD.PimProductId, ZPLPD.DisplayOrder, ZPLPD.IsDefault
			-------

			DECLARE @Counter INT =1 ,@maxCountId INT = (SELECT max(RowId) FROM @TBL_LocaleId ) 

			CREATE TABLE #TBL_PublishCatalogId (PublishCatalogId INT,PublishProductId INT,PimProductId  INT   , VersionId INT ,LocaleId INT, PriceListId INT , PortalId INT ,MaxSmallWidth NVARCHAr(max)  )
			CREATE INDEX idx_#TBL_PublishCatalogIdPimProductId on #TBL_PublishCatalogId(PimProductId)
			CREATE INDEX idx_#TBL_PublishCatalogIdPimPublishCatalogId on #TBL_PublishCatalogId(PublishCatalogId)

			INSERT INTO #TBL_PublishCatalogId 
			SELECT Distinct ZPP.PublishCatalogId , ZPP.PublishProductId,PimProductId, 0,0 ,
			(SELECT TOP 1 PriceListId FROM ZnodePriceListPortal NT 
			INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=NT.PortalId  
			ORDER BY NT.Precedence ASC ) ,TY.PortalId,
			(SELECT TOP 1  MAX(MaxSmallWidth) FROM ZnodeGlobalMediaDisplaySetting)
			FROM ZnodePublishProduct ZPP 
			LEFT JOIN ZnodePortalCatalog TY ON (TY.PublishCatalogId = ZPP.PublishCatalogId)
			WHERE (EXISTS (SELECT TOP 1 1 FROM #PimProductId SP WHERE SP.Id = ZPP.PimProductId  
			AND  (@PublishCatalogId IS NULL OR @PublishCatalogId = 0 ))
			OR  (ZPP.PublishCatalogId = @PublishCatalogId ))
			And Exists 
			(Select TOP 1 1 from ZnodePublishVersionEntity ZPCP  where ZPCP.ZnodeCatalogId  = ZPP.PublishCatalogId AND ZPCP.IsPublishSuccess =1 )

			Insert into #ProductIds (PimProductId,PublishProductId) Select distinct PimProductId,PublishProductId from #TBL_PublishCatalogId  

             Create TABLE #TBL_ZnodeTempPublish (PimProductId INT , AttributeCode VARCHAR(300) ,AttributeValue NVARCHAR(max) ) 			
			 DECLARE @TBL_AttributeVAlueLocale TABLE(PimProductId INT,PimAttributeId INT,ZnodePimAttributeValueLocaleId INT,LocaleId INT ,AttributeValue Nvarchar(1000) )


			 INSERT INTO @TBL_AttributeValueLocale (PimProductId ,PimAttributeId ,ZnodePimAttributeValueLocaleId ,LocaleId ,AttributeValue )
			 SELECT VIR.PimProductId,PimAttributeId,ZnodePimAttributeValueLocaleId,VIR.LocaleId, ''
			 FROM View_LoadManageProductInternal VIR
			 INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = VIR.PimProductId)
			 UNION ALL 
			 SELECT VIR.PimProductId,PimAttributeId,PimProductAttributeMediaId,ZPDE.LocaleId , ''
			 FROM ZnodePimAttributeValue  VIR
			 INNER JOIN ZnodePimProductAttributeMedia ZPDE ON (ZPDE.PimAttributeValueId = VIR.PimAttributeValueId )
			 WHERE EXISTS (SELECT TOP 1 1 FROM #ProductIds ZPP WHERE (ZPP.PimProductId = VIR.PimProductId) )
			 Union All 
			 SELECT VIR.PimProductId,VIR.PimAttributeId,ZPDVL.PimAttributeDefaultValueLocaleId,ZPDVL.LocaleId ,ZPDVL.AttributeDefaultValue
			   FROM ZnodePimAttributeValue  VIR
			 INNER JOIN ZnodePimAttribute D ON ( D.PimAttributeId=VIR.PimAttributeId AND D.IsPersonalizable =1 )
			 INNER JOIN ZnodePimAttributeDefaultValue ZPADV ON ZPADV.PimAttributeId = D.PimAttributeId
			 INNER JOIN ZnodePimAttributeDefaultValueLocale ZPDVL   on (ZPADV.PimAttributeDefaultValueId = ZPDVL.PimAttributeDefaultValueId)
			 WHERE ( ZPDVL.LocaleId = @DefaultLocaleId OR ZPDVL.LocaleId = @LocaleId )
			 AND EXISTS(SELECT TOP 1 1 FROM #ProductIds ZPP WHERE (ZPP.PimProductId = VIR.PimProductId) )
			 Union All 
			 SELECT VIR.PimProductId,VIR.PimAttributeId,'','' ,''
			 FROM ZnodePimAttributeValue  VIR
			 INNER JOIN ZnodePimAttribute D ON ( D.PimAttributeId=VIR.PimAttributeId AND D.IsPersonalizable =1 )
			 WHERE  EXISTS(SELECT TOP 1 1 FROM #ProductIds ZPP WHERE (ZPP.PimProductId = VIR.PimProductId) )
		
				--insert INTO #ZnodePrice
				SELECT RetailPrice,SalesPrice,ZC.CurrencyCode,ZCC.CultureCode ,ZCC.Symbol CurrencySuffix,TYU.PublishProductId ,isnull(ZPC1.IsAllowIndexing,0) as IsAllowIndexing
				into #ZnodePrice
				FROM ZnodePrice ZP 
				INNER JOIN ZnodePriceList ZPL ON (ZPL.PriceListId = ZP.PriceListId)
				INNER JOIN ZnodeCurrency ZC oN (ZC.CurrencyId = ZPL.CurrencyId )
				INNER JOIN ZnodeCulture ZCC ON (ZCC.CultureId = ZPL.CultureId)
				INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZP.SKU ) 
				INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)
				INNER JOIN ZnodePublishCatalog ZPC ON (TYU.PublishCatalogId = ZPC.PublishCatalogId)
				INNER JOIN ZnodePimCatalog ZPC1 ON (ZPC.PimCatalogId = ZPC1.PimCatalogId)
				WHERE EXISTS (SELECT TOP 1 1 FROM #TBL_PublishCatalogId TYUR WHERE TYUR.PriceListId = ZPL.PriceListId AND TYUR.PublishCatalogId = TYU.PublishCatalogId
				AND TYU.PublishProductId = TYUR.PublishProductId)
				AND TY.LocaleId = dbo.Fn_GetDefaultLocaleId()
				AND EXISTS (SELECT TOP 1 1 FROM ZnodePriceListPortal ZPLP 
				INNER JOIN ZnodePimCatalog ZPC on ZPC.PortalId=ZPLP.PortalId WHERE ZPLP.PriceListId=ZP.PriceListId )
				
				--insert INTO #ProductSKU
				SELECT ZCSD.SEOUrl , ZCDL.SEODescription,ZCDL.SEOKeywords ,ZCDL.SEOTitle, TYU.PublishProductId ,isnull(ZPC1.IsAllowIndexing,0) as IsAllowIndexing
				INTO #ProductSKU
				FROM ZnodeCMSSEODetail ZCSD 
				INNER JOIN ZnodeCMSSEODetailLocale ZCDL ON (ZCDL.CMSSEODetailId = ZCSD.CMSSEODetailId)
				INNER JOIN ZnodePublishProductDetail TY ON (TY.SKU = ZCSD.SEOCode AND ZCDL.LocaleId = TY.LocaleId) 
				INNER JOIN ZnodePublishProduct TYU ON (TYU.PublishProductId = TY.PublishProductId)
				INNER JOIN ZnodePublishCatalog ZPC ON (TYU.PublishCatalogId = ZPC.PublishCatalogId)
				INNER JOIN ZnodePimCatalog ZPC1 ON (ZPC.PimCatalogId = ZPC1.PimCatalogId)
				WHERE CMSSEOTypeId = (SELECT TOP 1 CMSSEOTypeId FROM ZnodeCMSSEOType WHERE Name = 'Product') 
				AND EXISTS (SELECT TOP 1 1  FROM #TBL_PublishCatalogId TYUR WHERE  TYUR.PublishCatalogId = TYU.PublishCatalogId
				AND TYU.PublishProductId = TYUR.PublishProductId)
				AND ZCDL.LocaleId = dbo.Fn_GetDefaultLocaleId()
				and ZCSD.PortalId = isnull(ZPC1.PortalId,0)

			
				--insert INTO #ProductImages
				SELECT  TUI.PublishCatalogId, TYU.PublishProductId , @DomainUrl +'Catalog/'  + CAST(Max(ZPC1.PortalId) AS VARCHAr(100)) + '/'+ CAST(Isnull(Max(TUI.MaxSmallWidth),'') AS VARCHAR(100)) + '/' + Isnull(RT.MediaPath,'') AS ImageSmallPath    
				,isnull(ZPC1.IsAllowIndexing,0) as IsAllowIndexing
				INTO #ProductImages
				FROM ZnodePimAttributeValue ZPAV 
				INNER JOIN ZnodePublishProduct TYU ON (TYU.PimProductId  = ZPAV.PimProductId)
				INNER JOIN ZnodePimProductAttributeMedia  RT ON ( RT.PimAttributeValueId = ZPAV.PimAttributeValueId )
				INNER JOIN #TBL_PublishCatalogId TUI ON (TUI.PublishProductId = TYU.PublishProductId AND TUI.PublishCatalogId = TYU.PublishCatalogId
						 )--AND  TUI.LocaleId = dbo.Fn_GetDefaultLocaleId()
				INNER JOIN ZnodePublishCatalog ZPC ON (TYU.PublishCatalogId = ZPC.PublishCatalogId)
				INNER JOIN ZnodePimCatalog ZPC1 ON (ZPC.PimCatalogId = ZPC1.PimCatalogId)
				WHERE  RT.LocaleId = dbo.Fn_GetDefaultLocaleId()
				AND ZPAV.PimAttributeId = (SELECT TOp 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'ProductImage')
				group by TUI.PublishCatalogId, TYU.PublishProductId ,isnull(RT.MediaPath,''),isnull(ZPC1.IsAllowIndexing,0) 
		  -- end
	  
WHILE @Counter <= @maxCountId
BEGIN
 SET @LocaleId = (SELECT TOP 1 LocaleId FROM @TBL_LocaleId WHERE RowId = @Counter)

  INSERT INTO #PimProductAttributeJson 
  SELECT PimAttributeJsonId ,PimAttributeId,LocaleId
  FROM ZnodePimAttributeJSON
  WHERE LocaleId = @LocaleId
  
  INSERT INTO #PimProductAttributeJson 
  SELECT PimAttributeJsonId ,PimAttributeId,LocaleId
  FROM ZnodePimAttributeJSON ZPAX
  WHERE ZPAX.LocaleId = @DefaultLocaleId  
  AND NOT EXISTS (SELECT TOP 1 1 FROM #PimProductAttributeJson ZPAXI WHERE ZPAXI.PimAttributeId = ZPAX.PimAttributeId )

  INSERT INTO @PimDefaultValueLocale
  SELECT PimAttributeDefaultJsonId,PimAttributeDefaultValueId,LocaleId 
  FROM ZnodePimAttributeDefaultJson
  WHERE localeId = @LocaleId

  INSERT INTO @PimDefaultValueLocale 
   SELECT PimAttributeDefaultJsonId,PimAttributeDefaultValueId,LocaleId 
  FROM ZnodePimAttributeDefaultJson ZX
  WHERE localeId = @DefaultLocaleId
  AND NOT EXISTS (SELECT TOP 1 1 FROM @PimDefaultValueLocale TRTR WHERE TRTR.PimAttributeDefaultValueId = ZX.PimAttributeDefaultValueId)
  
 
  --DECLARE @TBL_AttributeVAlue TABLE(PimProductId INT,PimAttributeId INT,ZnodePimAttributeValueLocaleId INT  )
  --DECLARE @TBL_CustomeFiled TABLE (PimCustomeFieldJsonId INT ,CustomCode VARCHAR(300),PimProductId INT ,LocaleId INT )
  CREATE TABLE #TBL_CustomeFiled  (PimCustomeFieldJsonId INT ,CustomCode VARCHAR(300),PimProductId INT ,LocaleId INT )
  CREATE TABLE #TBL_AttributeVAlue (PimProductId INT,PimAttributeId INT,ZnodePimAttributeValueLocaleId INT  )



  INSERT INTO #TBL_CustomeFiled (PimCustomeFieldJsonId,PimProductId ,LocaleId,CustomCode)
  SELECT  PimCustomeFieldJsonId,RTR.PimProductId ,RTR.LocaleId,CustomCode
  FROM ZnodePimCustomeFieldJson RTR 
  INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = RTR.PimProductId)
  WHERE RTR.LocaleId = @LocaleId
 

  INSERT INTO #TBL_CustomeFiled (PimCustomeFieldJsonId,PimProductId ,LocaleId,CustomCode)
  SELECT  Distinct  PimCustomeFieldJsonId,ITR.PimProductId ,ITR.LocaleId,CustomCode
  FROM ZnodePimCustomeFieldJson ITR
  INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = ITR.PimProductId)
  WHERE ITR.LocaleId = @DefaultLocaleId
  AND NOT EXISTS (SELECT TOP 1 1 FROM #TBL_CustomeFiled TBL  WHERE ITR.CustomCode = TBL.CustomCode AND ITR.PimProductId = TBL.PimProductId)
  

    INSERT INTO #TBL_AttributeVAlue (PimProductId ,PimAttributeId ,ZnodePimAttributeValueLocaleId )
    SELECT Distinct  PimProductId,PimAttributeId,ZnodePimAttributeValueLocaleId
	FROM @TBL_AttributeVAlueLocale
    WHERE LocaleId = @LocaleId

    
	INSERT INTO #TBL_AttributeVAlue(PimProductId ,PimAttributeId ,ZnodePimAttributeValueLocaleId )
	SELECT VI.PimProductId,PimAttributeId,ZnodePimAttributeValueLocaleId
	FROM @TBL_AttributeVAlueLocale VI 
    WHERE VI.LocaleId = @DefaultLocaleId 
	AND NOT EXISTS (SELECT TOP 1 1 FROM #TBL_AttributeVAlue  CTE WHERE CTE.PimProductId = VI.PimProductId AND CTE.PimAttributeId = VI.PimAttributeId )
 
	------------Facet Merging Patch --------------
	IF OBJECT_ID('tempdb..#PimChildProductFacets') is not null
	BEGIN 
		DROP TABLE #PimChildProductFacets
	END 

	IF OBJECT_ID('tempdb..#PimAttributeDefaultXML') is not null
	BEGIN 
		DROP TABLE #PimAttributeDefaultXML
	END
	----Getting parent facets data
	Select  ZPPADV.PimAttributeDefaultValueId, ZPAV_Parent.PimAttributeValueId, ZPPADV.LocaleId
	Into #PimChildProductFacets
	from ZnodePimAttributeValue ZPAV_Parent
	inner join ZnodePimProductAttributeDefaultValue ZPPADV ON ZPAV_Parent.PimAttributeValueId = ZPPADV.PimAttributeValueId 
	where exists(select * from #ProductIds ZPPC where ZPAV_Parent.PimProductId = ZPPC.PimProductId )

	----Getting child facets for merging	
	insert into #PimChildProductFacets	  
	Select distinct ZPPADV.PimAttributeDefaultValueId, ZPAV_Parent.PimAttributeValueId, ZPPADV.LocaleId
	from ZnodePimAttributeValue ZPAV_Parent
	inner join ZnodePimProductTypeAssociation ZPPTA ON ZPAV_Parent.PimProductId = ZPPTA.PimParentProductId
	inner join ZnodePimAttributeValue ZPAV_Child ON ZPPTA.PimProductId = ZPAV_Child.PimProductId AND ZPAV_Parent.PimAttributeId = ZPAV_Child.PimAttributeId
	inner join ZnodePimProductAttributeDefaultValue ZPPADV ON ZPAV_Child.PimAttributeValueId = ZPPADV.PimAttributeValueId 
	where exists(select * from ZnodePimFrontendProperties ZPFP where ZPAV_Parent.PimAttributeId = ZPFP.PimAttributeId and ZPFP.IsFacets = 1)
	and exists(select * from #ProductIds ZPPC where ZPAV_Parent.PimProductId = ZPPC.PimProductId )
	and not exists(select * from ZnodePimProductAttributeDefaultValue ZPPADV1 where ZPAV_Parent.PimAttributeValueId = ZPPADV1.PimAttributeValueId 
		            and ZPPADV1.PimAttributeDefaultValueId = ZPPADV.PimAttributeDefaultValueId )

	----Merging childs facet attribute Default value XML for parent
	Create table #PimAttributeDefaultXML (DefaultValueJson nvarchar(max), PimAttributeValueId int, LocaleId int )

    Insert into #PimAttributeDefaultXML (DefaultValueJson , PimAttributeValueId , LocaleId )
	select  ZPADX.DefaultValueJson, ZPPADV.PimAttributeValueId, ZPPADV.LocaleId
	from #PimChildProductFacets ZPPADV		  
	inner join ZnodePimAttributeDefaultJson ZPADX ON ( ZPPADV.PimAttributeDefaultValueId = ZPADX.PimAttributeDefaultValueId )--AND ZPPADV.LocaleId = ZPADX.LocaleId)
	INNER JOIN @PimDefaultValueLocale GH ON (GH.PimAttributeDefaultJsonId = ZPADX.PimAttributeDefaultJsonId)
	
	IF ( @LocaleId <> @DefaultLocaleId )
	BEGIN
		Insert into #PimAttributeDefaultXML (DefaultValueJson , PimAttributeValueId , LocaleId )
		Select  ZPADX.DefaultValueJson, ZPPADV.PimAttributeValueId, @LocaleId
		from #PimChildProductFacets ZPPADV		  
		inner join ZnodePimAttributeDefaultJson ZPADX ON ( ZPPADV.PimAttributeDefaultValueId = ZPADX.PimAttributeDefaultValueId )--AND ZPPADV.LocaleId = ZPADX.LocaleId)
		INNER JOIN @PimDefaultValueLocale GH ON (GH.PimAttributeDefaultJsonId = ZPADX.PimAttributeDefaultJsonId)
		Where Not exists (select TOP 1 1 From #PimAttributeDefaultXML X Where X.LocaleId = @LocaleId and 
		 ZPPADV.PimAttributeValueId = X.PimAttributeValueId) and GH.LocaleId = @DefaultLocaleId
	END
	------------Facet Merging Patch --------------   

	 IF OBJECT_ID('tempdb..#View_LoadManageProductInternal') is not null
	 BEGIN 
		DROP TABLE #View_LoadManageProductInternal
	 END 

	SELECT a.PimProductId ,b.AttributeValue as AttributeValue , b.LocaleId  ,a.PimAttributeId,c.AttributeCode ,b.ZnodePimAttributeValueLocaleId
	into #View_LoadManageProductInternal
	FROM ZnodePimAttributeValue a 
	INNER JOIN  ZnodePimAttributeValueLocale b ON ( b.PimAttributeValueId = a.PimAttributeValueId )
	INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
	INNER JOIN ZnodePimAttributeJSON c1   ON (c1.PimAttributeId = a.PimAttributeId )
	INNER JOIN #PimProductAttributeJson b1 ON (b1.PimAttributeJsonId = c1.PimAttributeJsonId )
	INNER JOIN #TBL_AttributeVAlue CTE ON (Cte.PimAttributeId = a.PimAttributeId AND Cte.ZnodePimAttributeValueLocaleId = b.ZnodePimAttributeValueLocaleId)
	UNION ALL
	SELECT a.PimProductId,ZPPATAV.AttributeValue AS AttributeValue  
	,ZPPATAV.LocaleId,a.PimAttributeId,c.AttributeCode  ,ZPPATAV.PimProductAttributeTextAreaValueId
	FROM ZnodePimAttributeValue a 
	INNER JOIN ZnodePimProductAttributeTextAreaValue ZPPATAV ON (ZPPATAV.PimAttributeValueId = a.PimAttributeValueId )
	INNER JOIN ZnodePimAttribute c ON ( c.PimAttributeId=a.PimAttributeId )
	INNER JOIN ZnodePimAttributeJSON c1   ON (c1.PimAttributeId = a.PimAttributeId )
	INNER JOIN #PimProductAttributeJson b1 ON (b1.PimAttributeJsonId = c1.PimAttributeJsonId )
	INNER JOIN #TBL_AttributeVAlue CTE ON (Cte.PimAttributeId = a.PimAttributeId AND Cte.ZnodePimAttributeValueLocaleId = ZPPATAV.PimProductAttributeTextAreaValueId)
	
	INSERT INTO #TBL_ZnodeTempPublish  
		SELECT  a.PimProductId,a.AttributeCode , 
			JSON_MODIFY (JSON_MODIFY (Json_Query( c.AttributeJSON  ) , '$.AttributeValues' ,  
			ISNULL(a.AttributeValue,'') ) ,'$.SelectValues',Json_Query('[]'))
			AS 'AttributeValue'
		FROM #View_LoadManageProductInternal a 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = a.PimAttributeId )
		INNER JOIN #PimProductAttributeJson b ON (b.PimAttributeJsonId = c.PimAttributeJsonId )
		INNER JOIN #TBL_AttributeVAlue CTE ON (Cte.PimAttributeId = a.PimAttributeId AND Cte.ZnodePimAttributeValueLocaleId = a.ZnodePimAttributeValueLocaleId)
	UNION ALL 
			SELECT  a.PimProductId,c.AttributeCode , 
			JSON_MODIFY (JSON_MODIFY (Json_Query( c.AttributeJSON  ) , '$.AttributeValues' ,  
			ISNULL(TAVL.AttributeValue,'') ) ,'$.SelectValues',Json_Query('[]'))
			AS 'AttributeValue'
		FROM ZnodePimAttributeValue  a 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = a.PimAttributeId )
		INNER JOIN #PimProductAttributeJson b ON (b.PimAttributeJsonId = c.PimAttributeJsonId )
		INNER JOIN ZnodePImAttribute ZPA  ON (ZPA.PimAttributeId = a.PimAttributeId)
		INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = a.PimProductId)
		Inner JOIN @TBL_AttributeVAlueLocale TAVL ON  (c.PimAttributeId = TAVL.PimAttributeId  and ZPP.PimProductId = TAVL.PimProductId )
		WHERE ZPA.IsPersonalizable = 1 
		AND NOT EXISTS ( SELECT TOP 1 1 FROM ZnodePimAttributeValueLocale q WHERE q.PimAttributeValueId = a.PimAttributeValueId) 
	UNION ALL 
		SELECT THB.PimProductId,THB.CustomCode,
		--'<Attributes><AttributeEntity>'+CustomeFiledJson +'</AttributeEntity></Attributes>' 
		JSON_MODIFY (Json_Query( CustomeFiledJson ) ,'$.SelectValues',Json_Query('[]')) 
		FROM ZnodePimCustomeFieldJson THB 
		INNER JOIN #TBL_CustomeFiled TRTE ON (TRTE.PimCustomeFieldJsonId = THB.PimCustomeFieldJsonId)
		UNION ALL 
		SELECT ZPAV.PimProductId,c.AttributeCode,
			JSON_MODIFY (JSON_MODIFY (c.AttributeJson,'$.AttributeValues',''), '$.SelectValues',
			Isnull((SELECT 
			Isnull(JSON_VALUE(DefaultValueJson, '$.Code'),'') Code 
			,Isnull(JSON_VALUE(DefaultValueJson, '$.LocaleId'),0) LocaleId
			,IsNull(JSON_VALUE(DefaultValueJson, '$.Value'),'') Value
			,IsNull(JSON_VALUE(DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
			,Isnull(JSON_VALUE(DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
			,Isnull(JSON_VALUE(DefaultValueJson, '$.IsEditable'),'false') IsEditable
			,Isnull(JSON_VALUE(DefaultValueJson, '$.SwatchText'),'') SwatchText
			,Isnull(JSON_VALUE(DefaultValueJson, '$.Path'),'') Path
			FROM #PimAttributeDefaultXML ZPADV
			WHERE (ZPADV.PimAttributeValueId = ZPAV.PimAttributeValueId) For JSON Auto 
			),'[]') 
		)  AttributeValue
		FROM ZnodePimAttributeValue ZPAV  With (NoLock)
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = ZPAV.PimAttributeId )
		INNER JOIN #PimProductAttributeJson b ON (b.PimAttributeJsonId = c.PimAttributeJsonId )
		INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = ZPAV.PimProductId)
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeDefaultValue ZPADVL 
		WHERE ZPADVL.PimAttributeValueId = ZPAV.PimAttributeValueId)
	UNION ALL 
		SELECT DISTINCT  ZPAV.PimProductId,c.AttributeCode,
			JSON_MODIFY (JSON_MODIFY (Json_Query( c.AttributeJson  ) , '$.AttributeValues',  
			ISNULL((Select stuff( 
			(SELECT ','+ZPPG.MediaPath 
			FROM ZnodePimProductAttributeMedia ZPPG INNER JOIN  #TBL_AttributeVAlue TBLV ON 
			(	TBLV.PimProductId=  ZPAV.PimProductId AND TBLV.PimAttributeId = ZPAV.PimAttributeId )
			WHERE ZPPG.PimProductAttributeMediaId = TBLV.ZnodePimAttributeValueLocaleId
			FOR XML PATH(''),Type).value('.', 'varchar(max)'), 1, 1, '')),'') ) ,'$.SelectValues',Json_Query('[]'))   
			AS 'AttributeEntity'
		FROM ZnodePimAttributeValue ZPAV 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = ZPAV.PimAttributeId )
		INNER JOIN #PimProductAttributeJson b ON (b.PimAttributeJsonId = c.PimAttributeJsonId )
		INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = ZPAV.PimProductId)
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeMedia ZPADVL WHERE ZPADVL.PimAttributeValueId = ZPAV.PimAttributeValueId)
	UNION ALL 
		SELECT ZPLP.PimParentProductId ,c.AttributeCode, 
			JSON_MODIFY( JSON_Modify(c.AttributeJson , '$.AttributeValues' , 
			ISNULL(SUBSTRING((SELECT ','+cast( LP.SKU as varchar(600)) 
							 FROM #LinkProduct LP
							 WHERE LP.PimParentProductId = ZPLP.PimParentProductId 
							 AND LP.PimAttributeId = ZPLP.PimAttributeId
		FOR XML PATH ('') ),2,4000),'')),'$.SelectValues',Json_Query('[]'))   
	
		FROM ZnodePimLinkProductDetail ZPLP 
		INNER JOIN #TBL_PublishCatalogId ZPP ON (ZPP.PimProductId = ZPLP.PimParentProductId)
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = ZPLP.PimAttributeId )
		INNER JOIN #PimProductAttributeJson b ON (b.PimAttributeJsonId = c.PimAttributeJsonId )
		GROUP BY ZPLP.PimParentProductId , ZPP.PublishProductId  ,ZPLP.PimAttributeId,c.AttributeCode,c.AttributeJson,ZPP.PublishCatalogId
	UNION ALL 
		SELECT ZPAV.PimProductId,'DefaultSkuForConfigurable' ,
			JSON_MODIFY( JSON_Modify(
			REPLACE(REPLACE (c.AttributeJson,'ProductType','DefaultSkuForConfigurable'),'Product Type','Default Sku For Configurable'),
			'$.AttributeValues' , 
			ISNULL(SUBSTRING((SELECT ','+CAST(adl.AttributeValue AS VARCHAR(50)) 
		FROM ZnodePimAttributeValue ad 
		inner join ZnodePimAttributeValueLocale adl on ad.PimattributeValueId = adl.PimAttributeValueId
		INNER JOIN ZnodePimProductTypeAssociation yt ON (yt.PimProductId = ad.PimProductId)
		WHERE EXISTS (select * from #ProductIds p where yt.PimParentProductId = p.PimProductId)
		AND Ad.PimAttributeId =(select top 1 PimAttributeId from ZnodePimAttribute zpa where zpa.AttributeCode = 'SKU')
		AND yt.PimParentProductId = ZPAV.PimProductId 
		ORDER BY yt.DisplayOrder , yt.PimProductTypeAssociationId ASC FOR XML PATH ('') ),2,4000),'')),'$.SelectValues',Json_Query('[]'))   
		FROM ZnodePimAttributeValue ZPAV  
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = ZPAV.PimAttributeId )
		INNER JOIN #ProductIds ZPP ON (ZPP.PimProductId = ZPAV.PimProductId)
		WHERE EXISTS (SELECT TOP 1 1 FROM ZnodePimProductAttributeDefaultValue ZPADVL 
		INNER JOIN ZnodePimAttributeDefaultValue dr ON (dr.PimAttributeDefaultValueId = ZPADVL.PimAttributeDefaultValueId)
		WHERE ZPADVL.PimAttributeValueId = ZPAV.PimAttributeValueId
		AND dr.AttributeDefaultValueCode= 'ConfigurableProduct' 
		)
		AND EXISTS (select * from #PimProductAttributeJson b where b.PimAttributeJsonId = c.PimAttributeJsonId)
		AND c.AttributeCode = 'ProductType' 
	UNION ALL
		SELECT DISTINCT  UOP.PimProductId,c.AttributeCode,
			JSON_MODIFY (JSON_MODIFY (c.AttributeJson,'$.AttributeValues',''), '$.SelectValues',
			Isnull((SELECT  DISTINCT 
			Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Code'),'') Code 
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.LocaleId'),0) LocaleId
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Value'),'') Value
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.AttributeDefaultValue'),'') AttributeDefaultValue
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.DisplayOrder'),0) DisplayOrder
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.IsEditable'),'false') IsEditable
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.SwatchText'),'') SwatchText
			,Isnull(JSON_VALUE(AA.DefaultValueJson, '$.Path'),'') Path 
			,ISNULL(ZPA.DisplayOrder,0)  AS VariantDisplayOrder 
			,ISNULL(ZPAVL_SKU.AttributeValue,'')   AS VariantSKU 
			--,Isnull(ZM.Path,'') 
		,ZM.Path AS VariantImagePath 
		FROM ZnodePimAttributeDefaultJson AA 
		INNER JOIN ZnodePimProductAttributeDefaultValue ZPADV ON ( ZPADV.PimAttributeDefaultValueId = AA.PimAttributeDefaultValueId )
		INNER JOIN ZnodePimAttributeValue ZPAV1 ON (ZPAV1.PimAttributeValueId= ZPADV.PimAttributeValueId )
		-- check/join for active variants 
		INNER JOIN ZnodePimAttributeValue ZPAV ON (ZPAV.PimProductId =ZPAV1.PimProductId)
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL ON (ZPAV.PimAttributevalueid = ZPAVL.PimAttributeValueId AND ZPAVL.AttributeValue = 'True')
		INNER JOIN ZnodePimProductTypeAssociation YUP ON (YUP.PimProductId = ZPAV1.PimProductId)
		-- SKU
		INNER JOIN ZnodePimAttributeValue ZPAV_SKU ON(YUP.PimProductId = ZPAV_SKU.PimProductId)
		INNER JOIN ZnodePimAttributeValueLocale ZPAVL_SKU ON (ZPAVL_SKU.PimAttributeValueId = ZPAV_SKU.PimAttributeValueId)
		LEFT JOIN ZnodePimAttribute ZPA ON (ZPA.PimattributeId = ZPAV1.PimAttributeId)
		--VariantImagePath
		LEFT  JOIN ZnodePimAttributeValue ZPAV12 ON (ZPAV12.PimProductId= YUP.PimProductId  AND ZPAV12.PimAttributeId = @PimMediaAttributeId ) 
		LEFT JOIN ZnodePimProductAttributeMedia ZPAVM ON (ZPAVM.PimAttributeValueId= ZPAV12.PimAttributeValueId ) 
		LEFT JOIN ZnodeMedia ZM ON (ZM.MediaId = ZPAVM.MediaId)
		WHERE (YUP.PimParentProductId  = UOP.PimProductId AND ZPAV1.pimAttributeId = UOP.PimAttributeId )
		-- Active Variants
		AND ZPAV.PimAttributeId = (SELECT TOP 1 PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'IsActive')
		-- VariantSKU
		AND ZPAV_SKU.PimAttributeId = (SELECT PimAttributeId FROM ZnodePimAttribute WHERE AttributeCode = 'SKU')
		For JSON Auto 
		),'[]')) 
				
		--</AttributeEntity></Attributes>' 
		FROM ZnodePimConfigureProductAttribute UOP 
		INNER JOIN ZnodePimAttributeJSON c   ON (c.PimAttributeId = UOP.PimAttributeId )
		WHERE  exists(select * from #TBL_PublishCatalogId PPCP1 where UOP.PimProductId = PPCP1.PimProductId )
		AND EXISTS (select * from #PimProductAttributeJson b where b.PimAttributeJsonId = c.PimAttributeJsonId)

			-------------configurable attribute 
			---------------------------------------------------------------------
			
			If (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%'  ) 
				Delete from ZnodePublishProductEntity where ZnodeProductId  in (select a.PublishProductId from #TBL_PublishCatalogId
				A inner join ZnodePublishProductDetail B on A.PublishProductId   =B.PublishProductId   )
				AND LocaleId = @LocaleId
				AND VersionId in (SELECT VersionId FROM ZnodePublishVersionEntity where RevisionType = 'PREVIEW')
			If (@RevisionType like '%Production%' OR @RevisionType = 'None')
				Delete from ZnodePublishProductEntity where ZnodeProductId  in (select A.PublishProductId from #TBL_PublishCatalogId
				A inner join ZnodePublishProductDetail B on A.PublishProductId   =B.PublishProductId   )
				AND LocaleId = @LocaleId
				AND VersionId in (SELECT VersionId FROM ZnodePublishVersionEntity where RevisionType = 'PRODUCTION')

			Insert into ZnodePublishProductEntity (
					VersionId, --1
					IndexId, --2 
					ZnodeProductId,ZnodeCatalogId, --3
					SKU,LocaleId, --4 
					Name,ZnodeCategoryIds, --5
					IsActive, -- 6 
					Attributes, -- 7 
					Brands, -- 9
					CategoryName, --9
					CatalogName,DisplayOrder, --10 
					RevisionType,AssociatedProductDisplayOrder, --11
					ProductIndex,--12
					SalesPrice,RetailPrice,CultureCode,CurrencySuffix,CurrencyCode,SeoDescription,SeoKeywords,SeoTitle,SeoUrl,ImageSmallPath,SKULower --13 
					)
 			SELECT distinct ZPVE.VersionId, --1 
			CAST(ISNULL(ZPCP.ProductIndex,1) AS VARCHAr(100)) + CAST(ISNULL(ZPC.PublishCategoryId,'')  AS VARCHAR(50))  + 
			CAST(Isnull(ZPP.PublishCatalogId ,'')  AS VARCHAR(50)) + CAST( @LocaleId AS VARCHAR(50)) IndexId, --2 
			CAST(ZPP.PublishProductId AS VARCHAR(50)) PublishProductId,CAST(ZPP.PublishCatalogId  AS VARCHAR(50)) PublishCatalogId,  --3 
			CAST(ISNULL(ZPPDFG.SKU ,'') AS NVARCHAR(2000)) SKU,CAST( Isnull(@LocaleId ,'') AS VARCHAR(50)) LocaleId, -- 4 
			CAST(isnull(ZPPDFG.ProductName,'') AS NVARCHAR(2000) )  ProductName ,CAST(ISNULL(ZPCD.PublishCategoryId,'')  AS VARCHAR(50)) PublishCategoryId  -- 5 
			,CAST(ISNULL(ZPPDFG.IsActive ,'0') AS VARCHAR(50)) IsActive , --6 
			'[' +
				(Select STUFF((SELECT distinct ','+ AttributeValue from #TBL_ZnodeTempPublish TY WHERE TY.PimProductId = ZPP.PimProductId   
				FOR XML Path ('')) ,1,1,'')  ) 
			+ ']' xmlvalue,  -- 7 
			'[]' Brands  --8 
			,CAST(isnull(PublishCategoryName,'') AS NVARCHAR(2000)) CategoryName  --9
			,CAST(Isnull(CatalogName,'')  AS NVARCHAR(2000)) CatalogName,CAST(ISNULL(ZPCCF.DisplayOrder,'') AS VARCHAR(50)) DisplayOrder  -- 10  
			,ZPVE.RevisionType RevisionType , 0 AssociatedProductDisplayOrder,-- pending  -- 11 
			Isnull(ZPCP.ProductIndex,1),  -- 12 

			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(CAST(SalesPrice  AS varchar(500)),'') else '' end SalesPrice , 
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(CAST(RetailPrice  AS varchar(500)),'') else '' end RetailPrice , 
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(CultureCode ,'') else '' end CultureCode , 
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(CurrencySuffix ,'') else '' end CurrencySuffix , 
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(CurrencyCode ,'') else '' end CurrencyCode , 
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(SEODescription,'') else '' end SEODescriptionForIndex,
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(SEOKeywords,'') else '' end SEOKeywords,
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(SEOTitle,'') else '' end SEOTitle,
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(SEOUrl ,'') else '' end SEOUrl,
			Case When TBZP.IsAllowIndexing = 1 then  ISNULL(ImageSmallPath,'') else '' end ImageSmallPath,
			CAST(ISNULL(LOWER(ZPPDFG.SKU) ,'') AS NVARCHAR(100)) Lower_SKU -- 13
	FROM  #TBL_PublishCatalogId zpp
	INNER JOIN ZnodePublishCatalog ZPCV ON (ZPCV.PublishCatalogId = ZPP.PublishCatalogId)
	INNER JOIN ZnodePublishProductDetail ZPPDFG ON (ZPPDFG.PublishProductId =  ZPP.PublishProductId)
	INNER JOIN ZnodePublishVersionEntity ZPVE ON (ZPVE.ZnodeCatalogId  = ZPP.PublishCatalogId AND ZPVE.IsPublishSuccess =1 AND ZPVE.LocaleId = @LocaleId )
	LEFT JOIN #ZnodePrice TBZP ON (TBZP.PublishProductId = ZPP.PublishProductId)
	LEFT JOIN #ProductSKU TBPS ON (TBPS.PublishProductId = ZPP.PublishProductId)
	LEFT JOIN #ProductImages TBPI ON (TBPI.PublishProductId = ZPP.PublishProductId  )
	LEFT JOIN ZnodePublishCategoryProduct ZPCP ON (ZPCP.PublishProductId = ZPP.PublishProductId AND ZPCP.PublishCatalogId = ZPP.PublishCatalogId)
	LEFT JOIN ZnodePublishCategory ZPC ON (ZPC.PublishCatalogId = ZPCP.PublishCatalogId AND   ZPC.PublishCategoryId = ZPCP.PublishCategoryId)
	LEFT JOIN ZnodePimCategoryProduct ZPCCF ON (ZPCCF.PimCategoryId = ZPC.PimCategoryId  AND ZPCCF.PimProductId = ZPP.PimProductId )
	LEFT JOIN ZnodePimCategoryHierarchy ZPCH ON (ZPCH.PimCatalogId = ZPCV.PimCatalogId AND  ZPCH.PimCategoryHierarchyId =  ZPC.PimCategoryHierarchyId) 
	LEFT JOIN ZnodePublishCategoryDetail ZPCD ON (ZPCD.PublishCategoryId = ZPCP.PublishCategoryId AND ZPCD.LocaleId = @LocaleId )
	WHERE ZPPDFG.LocaleId = @LocaleId
		--AND zpp.LocaleId = @LocaleId
	AND 
		(
			(ZPVE.RevisionType =  Case when  (@RevisionType like '%Preview%'  OR @RevisionType like '%Production%' ) then 'Preview' End ) 
			OR 
			(ZPVE.RevisionType =  Case when (@RevisionType like '%Production%' OR @RevisionType = 'None') then  'Production'  end )
		)


	DELETE FROM #TBL_ZnodeTempPublish
	IF OBJECT_ID('tempdb..#PimProductAttributeJson') is not null
	 BEGIN 
		DELETE FROM #PimProductAttributeJson
	 END
	 IF OBJECT_ID('tempdb..#TBL_CustomeFiled') is not null
	 BEGIN 
	 DROP TABLE #TBL_CustomeFiled
	 END
	 IF OBJECT_ID('tempdb..#TBL_AttributeVAlue') is not null
	 BEGIN 
	 DROP TABLE #TBL_AttributeVAlue
	 END
 
	DELETE FROM @PimDefaultValueLocale
SET @Counter = @counter + 1 
END

SET @Status =1 

END TRY 
BEGIN CATCH 
	SET @Status =0  
	 SELECT 1 AS ID,@Status AS Status;   
	 DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), 
		@ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC [Znode_GetPublishSingleProductJson] 
		@PublishCatalogId = '+CAST(@PublishCatalogId  AS VARCHAR	(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10))
				
	EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_GetPublishSingleProductJson',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
END CATCH
END

GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Store','EditStoreSMSNotification',1,2,Getdate(),2,Getdate()
where not exists(select * from ZnodeActions where ControllerName = 'Store' and ActionName = 'EditStoreSMSNotification')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store')
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'EditStoreSMSNotification') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'EditStoreSMSNotification'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'EditStoreSMSNotification')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'EditStoreSMSNotification'))

GO

IF NOT EXISTS(SELECT 1 FROM sys.columns WHERE Name = N'CustomUnitPrice' AND Object_ID = Object_ID(N'dbo.ZnodeOmsSavedCartLineItem'))
BEGIN
	ALTER TABLE dbo.ZnodeOmsSavedCartLineItem ADD CustomUnitPrice NUMERIC(28, 6) NULL;
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable
GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup
GO

IF EXISTS(SELECT 1 FROM sys.types WHERE is_table_type = 1 AND name = 'TT_SavecartLineitems')
	DROP TYPE TT_SavecartLineitems;
GO
	CREATE TYPE [dbo].[TT_SavecartLineitems] AS TABLE (
    [RowId]                           INT             NULL,
    [OmsSavedCartLineItemId]          INT             NULL,
    [ParentOmsSavedCartLineItemId]    INT             NULL,
    [OmsSavedCartId]                  INT             NULL,
    [SKU]                             NVARCHAR (600)  NULL,
    [Quantity]                        NUMERIC (28, 6) NULL,
    [OrderLineItemRelationshipTypeID] INT             NULL,
    [CustomText]                      NVARCHAR (MAX)  NULL,
    [CartAddOnDetails]                NVARCHAR (MAX)  NULL,
    [Sequence]                        INT             NULL,
    [AddOnValueIds]                   VARCHAR (MAX)   NULL,
    [BundleProductIds]                VARCHAR (MAX)   NULL,
    [ConfigurableProductIds]          VARCHAR (MAX)   NULL,
    [GroupProductIds]                 VARCHAR (MAX)   NULL,
    [PersonalisedAttribute]           XML             NULL,
    [AutoAddon]                       VARCHAR (MAX)   NULL,
    [OmsOrderId]                      INT             NULL,
    [ItemDetails]                     NVARCHAR (MAX)  NULL,
    [Custom1]                         NVARCHAR (MAX)  NULL,
    [Custom2]                         NVARCHAR (MAX)  NULL,
    [Custom3]                         NVARCHAR (MAX)  NULL,
    [Custom4]                         NVARCHAR (MAX)  NULL,
    [Custom5]                         NVARCHAR (MAX)  NULL,
    [GroupId]                         NVARCHAR (MAX)  NULL,
    [ProductName]                     NVARCHAR (1000) NULL,
    [Description]                     NVARCHAR (MAX)  NULL,
    [AddOnQuantity]                   NVARCHAR (MAX)  NULL,
	[CustomUnitPrice]                NUMERIC  (28, 6) NULL
	);

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemBundle')
	DROP PROC Znode_InsertUpdateSaveCartLineItemBundle
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemBundle]
 (
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0
	,@OrderLineItemRelationshipTypeIdBundle INT
	,@OrderLineItemRelationshipTypeIdAddon INT
 )
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
    --Declared the variables
    DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
   
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,BundleProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.BundleProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 

	CREATE TABLE #NewBundleSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	
	--Getting new save cart data(bundle product)
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU ,
		CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new bundle product save cart data
	INSERT INTO #NewBundleSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdBundle, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,
				CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE BundleProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, BundleProductIds
	,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		
	--Getting new Bundle products save cart data if addon is present for any line item
	INSERT INTO #NewBundleSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
	,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU , CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice

    CREATE TABLE #OldBundleSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old bundle save cart data if present for same SKU in the new save cart data for bundle product		 
	INSERT INTO #OldBundleSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a   
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.BundleProductIds,'')   )   
    AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle   

	--Getting the old save cart Parent data
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldBundleSavecartLineitemDetails

	DELETE a FROM #OldBundleSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldBundleSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old bundle product save cart addon data for old line items if present
	INSERT INTO #OldBundleSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b 
	INNER JOIN #OldBundleSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	

		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
									( SELECT  ', ' + SKU FROM    
										( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											WHERE a.ParentOmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a WHERE a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.BundleProductIds SKU, STUFF(
										( SELECT  ', ' + x.AddOnValueIds FROM    
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											WHERE a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		if NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		begin
			DELETE FROM #OldBundleSavecartLineitemDetails
		end

		END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldBundleSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldBundleSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 

			 DECLARE @parenTofAddon INT  = 0 
			 SET @parenTofAddon = (SELECT TOP 1 ParentOmsSavedCartLineItemId 
			 FROM #OldBundleSavecartLineitemDetails a
			 WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  )

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId <> @parenTofAddon  AND ParentOmsSavedCartLineItemId IS NOT NULL  

			 DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldBundleSavecartLineitemDetails m)
			 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			  BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			  END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem   WHERE ParentOmsSavedCartLineItemId =@parenTofAddon AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldBundleSavecartLineitemDetails
			END 

		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) >= 1 
		 BEGIN 
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 END 
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewBundleSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  BEGIN 
		    DELETE FROM #OldBundleSavecartLineitemDetails
		  END 
		   ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 
		   DELETE FROM #OldBundleSavecartLineitemDetails
		 END 

	END 
	
	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldBundleSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			   SELECT OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		 
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
		     (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldBundleSavecartLineitemDetails)  )
		 BEGIN 
		   
			   DELETE n FROM #OldBundleSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldBundleSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldBundleSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldBundleSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 
		END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU or a.SKU = b.sku)
			WHERE isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on ( a.BundleProductIds = b.SKU )
			WHERE isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldBundleSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c WHERE b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)


		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldBundleSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c WHERE (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			LEFT JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewBundleSavecartLineitemDetails b ON a.BundleProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldBundleSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
	
		--Delete parent entry if child not present
		DELETE a FROM #OldBundleSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.BundleProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldBundleSavecartLineitemDetails b on a.BundleProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldBundleSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldBundleSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c WHERE a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches	
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate,
		a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldBundleSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon

		 --UPDATE Ab SET ab.Quantity = a.Quantity   
   --      FROM ZnodeOmsSavedCartLineItem a  
   --      INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
   --      INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		 --WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		 UPDATE Ab 
		 SET Ab.Quantity = Ab.Quantity+ty.Quantity,
		 Ab.Custom1 = ty.Custom1,
		 Ab.Custom2 = ty.Custom2,
		 Ab.Custom3 = ty.Custom3,
		 Ab.Custom4 = ty.Custom4,
		 Ab.Custom5 = ty.Custom5,
		 ab.ModifiedDate = @GetDate, 
		 a.CustomUnitPrice = ty.CustomUnitPrice  
         FROM ZnodeOmsSavedCartLineItem a  
         INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
         INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  ) 
		 INNER JOIN #NewBundleSavecartLineitemDetails ty ON (ty.SKU = b.SKU)  
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  
		 AND EXISTS(SELECT * FROM #OldBundleSavecartLineitemDetails ov WHERE a.OmsSavedCartLineItemId = ov.OmsSavedCartLineItemId)  

	END 
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldBundleSavecartLineitemDetails )
	BEGIN 
			
		UPDATE #NewBundleSavecartLineitemDetails
		SET ParentSKU = (SELECT TOP 1 SKU FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID IS NULL )
		WHERE OrderLineItemRelationshipTypeID  = @OrderLineItemRelationshipTypeIdAddon 
		AND EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) 
		
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU ,CustomUnitPrice 
		 INTO #InsertNewBundleSavecartLineitem   
		 FROM  #NewBundleSavecartLineitemDetails  
		 GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU ,CustomUnitPrice
		 ORDER BY RowId, Id   
   
		--Removing the line item having Quantity <=0 
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE Quantity <=0  

		;WITH Add_Dup AS
		(
			SELECT  Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM  #InsertNewBundleSavecartLineitem
			GROUP BY SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID
			HAVING OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon	
		)
		DELETE FROM #InsertNewBundleSavecartLineitem
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Add_Dup WHERE Add_Dup.NewRowId = #InsertNewBundleSavecartLineitem.NewRowId)
		AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		--Updating the rowid INTo new save cart line item AS new line item is merged INTo existing save cart item
		 ;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			   FROM #InsertNewBundleSavecartLineitem m  
			INNER JOIN  #InsertNewBundleSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID IN ( @OrderLineItemRelationshipTypeIdAddon , @OrderLineItemRelationshipTypeIdBundle)   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewBundleSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
      
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID   
			FROM #InsertNewBundleSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeID  
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)   
		DELETE FROM #InsertNewBundleSavecartLineitem WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
	   --Inserting the new cart line item if not merged in existing save cart line item
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description , CustomUnitPrice 
       FROM  #InsertNewBundleSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData 
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL  
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
  
		--------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
		AND  EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) 
		AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab WHERE a.OmsSavedCartId = ab.OmsSavedCartId and 
		 a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		-----------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewBuldleProduct
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = b.id OR b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( CASE WHEN EXISTS (SELECT TOP 1 1 FROM #NewBundleSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdBundle) THEN 0 ELSE 1 END = ISNULL(a.ParentOmsSavedCartLineItemId,0) OR ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  AND c.ParentOmsSavedCartLineItemId IS NULL
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId)  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	   ;WITH table_update AS 
	   (
		 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
		 FROM ZnodeOmsSavedCartLineItem a
		 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
		 AND a.ParentOmsSavedCartLineItemId IS NULL  
		 AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewBundleSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
		 AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
	   )
		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewBuldleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
			FROM #NewBuldleProduct  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
  
		;WITH Cte_Th AS   
		(             
			  SELECT RowId    
			 FROM #InsertNewBundleSavecartLineitem a   
			 GROUP BY RowId   
			 HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewBundleSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE Ab SET ab.Quantity = a.Quantity,
			ab.ModifiedDate = @GetDate, ab.CustomUnitPrice = b.CustomUnitPrice   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN ZnodeOmsSavedCartLineItem ab ON (ab.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)  
		INNER JOIN @SaveCartLineItemType b ON (a.OmsSavedCartId = b.OmsSavedCartId  )   
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdBundle  

		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewBundleSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		 (  
		   SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
		   FROM ZnodeOmsSavedCartLineItem   
		   WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewBundleSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		 )   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL
		and b.OmsSavedCartLineItemId = (select min(OmsSavedCartLineItemId) FROM @OmsInsertedData d WHERE b.OmsSavedCartLineItemId = d.OmsSavedCartLineItemId)
	 
		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		END 
END TRY
BEGIN CATCH 
  SELECT ERROR_MESSAGE()
END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemConfigurable')
	DROP PROC Znode_InsertUpdateSaveCartLineItemConfigurable
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemConfigurable]
(
	 @SaveCartLineItemType TT_SavecartLineitems READONLY
	,@Userid INT = 0 
	,@OrderLineItemRelationshipTypeIdConfigurable INT
	,@OrderLineItemRelationshipTypeIdAddon INT	
)
AS 
BEGIN 
	BEGIN TRY
	SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 

	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT, OmsSavedCartId INT,SKU NVARCHAr(max),GroupId NVARCHAr(max),ParentOmsSavedCartLineItemId INT,OrderLineItemRelationshipTypeId INT ) 
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,ConfigurableProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.ConfigurableProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)

	 CREATE TABLE #NewConfigSavecartLineitemDetails 
	 (
		 GenId INT IDENTITY(1,1), RowId	INT, OmsSavedCartLineItemId	INT, ParentOmsSavedCartLineItemId INT,OmsSavedCartId INT
		,SKU NVARCHAR(MAX) ,Quantity	NUMERIC(28,6), OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT	,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX), Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	 
	--Getting new save cart data(configurable product)
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5, GroupId ,ProductName,MIN(Description) Description, 0 Id,NULL ParentSKU ,
		CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new configurable product save cart data
	INSERT INTO #NewConfigSavecartLineitemDetails 
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
		,Quantity, @OrderLineItemRelationshipTypeIdConfigurable, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,
		CustomUnitPrice
	FROM @SaveCartLineItemType a 
	WHERE ConfigurableProductIds <> ''
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, ConfigurableProductIds
		,Quantity, CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,
		CustomUnitPrice
	
	--Getting new configurable products save cart data if addon is present for any line item
	INSERT INTO #NewConfigSavecartLineitemDetails
	SELECT MIN(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> '' THEN ConfigurableProductIds
			WHEN GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType a 
	WHERE AddOnValueIds <> ''
	GROUP BY OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		 
	SELECT * 
	INTO #ZnodeOmsSavedCartLineItem_NT
	FROM ZnodeOmsSavedCartLineItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId)

	CREATE TABLE #OldConfigSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU NVARCHAr(2000),OrderLineItemRelationshipTypeID INT )
	--Getting the old configurable save cart data if present for same SKU in the new save cart data for configurable product	 
	INSERT INTO #OldConfigSavecartLineitemDetails
	SELECT a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU ,a.OrderLineItemRelationshipTypeID 
	FROM #ZnodeOmsSavedCartLineItem_NT a
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.ConfigurableProductIds,''))
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable

	--Getting the old save cart Parent data
	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-') )
		AND b.OrderLineItemRelationshipTypeID IS NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldConfigSavecartLineitemDetails

	DELETE a 
	FROM #OldConfigSavecartLineitemDetails a 
	WHERE NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	INSERT INTO #OldConfigSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
	FROM #ZnodeOmsSavedCartLineItem_NT b 
	INNER JOIN #OldConfigSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		
	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN		
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU, b.OrderLineItemRelationshipTypeID
		FROM #ZnodeOmsSavedCartLineItem_NT b 
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT DISTINCT SKU, STUFF(
									( SELECT ', ' + SKU FROM
										( SELECT DISTINCT SKU FROM #OldValueForAddon b 
											where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId AND OrderLineItemRelationshipTypeID = 1 ) x 
											FOR XML PATH('')
									), 1, 2, ''
									) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a
		WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL AND OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.ConfigurableProductIds SKU, STUFF(
										( SELECT ', ' + x.AddOnValueIds FROM
										( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
											where a.SKU=b.SKU ) x
											FOR XML PATH('')
										), 1, 2, ''
									) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b ON a.SKU = b.SKU AND a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldConfigSavecartLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldConfigSavecartLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		DELETE FROM #OldConfigSavecartLineitemDetails 
	END
	ELSE 
	BEGIN
		 IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
		 BEGIN 
			 DECLARE @parenTofAddon TABLE( ParentOmsSavedCartLineItemId INT)
			 INSERT INTO @parenTofAddon 
			 SELECT ParentOmsSavedCartLineItemId 
			 FROM #OldConfigSavecartLineitemDetails a 
			 WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
				AND (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsSavedCartLineItem_NT t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon)

			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)
				AND ParentOmsSavedCartLineItemId IS NOT NULL 
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL 
		 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
			 IF (SELECT COUNT (DISTINCT SKU ) FROM #ZnodeOmsSavedCartLineItem_NT WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
			 BEGIN 
				DELETE FROM #OldConfigSavecartLineitemDetails 
			 END 
		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 
			-- SELECT 3
			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )

			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM #ZnodeOmsSavedCartLineItem_NT a
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

			DELETE 
			FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		 
			 DELETE 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldConfigSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL
		 END
		 ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM #OldConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM #NewConfigSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon )
		 BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 
		 ELSE IF EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItem_NT Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdConfigurable AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') = '' )
		 BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails 
		 END 
	END 

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present		
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		 DELETE FROM #OldConfigSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
			 DELETE FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			 SELECT OmsSavedCartLineItemId 
			 FROM #OldConfigSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
				 OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldConfigSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				 AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
			 DELETE n
			 FROM #OldConfigSavecartLineitemDetails n 
			 WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem )
	
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
			 AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldConfigSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldConfigSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldConfigSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise)
		END 
	END 

	IF EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails )
	BEGIN
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem AND personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.ConfigurableProductIds AS SKU
					,a.PersonalizeCode
			 		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		 
		INNER JOIN #OldConfigSavecartLineitemDetails b1 ON a1.SKU = b1.SKU
		INNER JOIN #OldConfigSavecartLineitemDetails c1 ON (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId AND a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewConfigSavecartLineitemDetails b ON a.ConfigurableProductIds = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		FROM CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldConfigSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldConfigSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldConfigSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5,
		a.ModifiedDate = @GetDate ,
		a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewConfigSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon
		 
		 UPDATE a
		 SET a.Quantity = a.Quantity+s.AddOnQuantity,
		 a.ModifiedDate = @GetDate
		 FROM ZnodeOmsSavedCartLineItem a
		 INNER JOIN #OldConfigSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		 INNER JOIN @SaveCartLineItemType S ON a.OmsSavedCartId = s.OmsSavedCartId AND a.SKU = s.AddOnValueIds
		 WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewConfigSavecartLineitemDetails N
	LEFT JOIN #OldConfigSavecartLineitemDetails O ON N.OmsSavedCartId=O.OmsSavedCartId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldConfigSavecartLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		--Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			 ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon 
			 ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description ,ParentSKU,CustomUnitPrice 
		INTO #InsertNewConfigSavecartLineitem 
		FROM #NewConfigSavecartLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId)
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails ,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU ,CustomUnitPrice 
		ORDER BY RowId, Id 
 	 
		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewConfigSavecartLineitem 
		WHERE Quantity <=0 
 
		--Updating the rowid INTo new save cart line item as new line item is merged INTo existing save cart item
		 ;WITH VTTY AS 
		( 
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU 
			FROM #InsertNewConfigSavecartLineitem m 
			INNER JOIN #InsertNewConfigSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU 
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
		) 
		UPDATE m1 
		SET m1.RowId = TYU.RowId 
		FROM #InsertNewConfigSavecartLineitem m1 
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId) 
 
		;WITH VTRET AS 
		( 
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			FROM #InsertNewConfigSavecartLineitem 
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID 
			Having SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		) 
		DELETE FROM #InsertNewConfigSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET) 
 
	 --Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,Sequence,	CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice ) 
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.OmsSavedCartId,inserted.SKU,inserted.GroupId,INSERTED.ParentOmsSavedCartLineItemId,INSERTED.OrderLineItemRelationshipTypeId INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId 
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId) sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon 
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description ,CustomUnitPrice 
		FROM #InsertNewConfigSavecartLineitem TH 

		SELECT MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			 
	
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM #Cte_newData r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND a.ParentOmsSavedCartLineItemId IS nULL 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )

	---------------------------------------------------------------------------------------------------------------------

		SELECT MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO #Cte_newData1 
		FROM @OmsInsertedData a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-') ) 
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID			

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM #Cte_newData1 r 
		WHERE r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-') Order by b.RowId ) 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1 ) 
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND a.sequence in (SELECT MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId AND 
			a.SKU = ab.sku AND ab.OrderLineItemRelationshipTypeId is not null ) 
 
	---------------------------------------------------------------------------------------------------------------------------

		SELECT a.OmsSavedCartLineItemId , b.RowId ,b.SKU ,b.ParentSKU ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewConfigProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1 )) 
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) ON b.sku = c.sku AND b.OmsSavedCartId=c.OmsSavedCartId AND b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0 )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) AND c.ParentOmsSavedCartLineItemId is null
 
		 ;WITH table_update AS 
		 (
			 SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId ) RowIdNo
			 FROM ZnodeOmsSavedCartLineItem a with (nolock)
			 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL 
			 AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 
			 AND a.ParentOmsSavedCartLineItemId IS NULL 
			 AND EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			 AND EXISTS (SELECT TOP 1 1 FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		 )
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) 
		FROM table_update a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND b.id =1 ) 
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewConfigProduct r 
		WHERE r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo GROUP BY r.ParentSKU, r.SKU ) IS nOT NULL 

		;WITH Cte_Th AS 
		( 
			 SELECT RowId 
			 FROM #InsertNewConfigSavecartLineitem a 
			 GROUP BY RowId 
			 HAVING COUNT(NewRowId) <= 1 
		) 
		UPDATE a 
		SET a.Quantity = NULL,a.ModifiedDate = @GetDate 
		FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN #InsertNewConfigSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0) 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM Cte_Th TY WHERE TY.RowId = b.RowId ) 
			AND a.OrderLineItemRelationshipTypeId IS NULL 
 
		UPDATE ZnodeOmsSavedCartLineItem 
		SET GROUPID = NULL 
		WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId ) 
		AND OrderLineItemRelationshipTypeId IS NOT NULL 
 
		;WITH Cte_UpdateSequence AS 
		( 
			 SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence 
			 FROM ZnodeOmsSavedCartLineItem 
			 WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewConfigSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId ) 
		) 
		UPDATE Cte_UpdateSequence 
		SET Sequence = RowId 

		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.ConfigurableProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b with (nolock) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS not nULL 
	
		DELETE 
		FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
		
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			 ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			 WHEN NOT MATCHED THEN 
				INSERT ( OmsSavedCartLineItemId, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES ( SOURCE.OmsSavedCartLineItemId, @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	END
	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemGroup]
(
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdGroup INT
	,@OrderLineItemRelationshipTypeIdAddon INT
)
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
	
	DECLARE @OmsInsertedData TABLE (SKU varchar(600),OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,GroupProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.GroupProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	CREATE TABLE #NewGroupSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT ,OmsSavedCartLineItemId	INT,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	int
		,SKU	NVARCHAR(MAX) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	INT ,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT ,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT ,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	 
	--Getting new save cart data(group product)
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new group product save cart data
	INSERT INTO #NewGroupSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdGroup, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,CustomUnitPrice  
	FROM @SaveCartLineItemType  a 
	WHERE GroupProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
		,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		
	--Getting new group products save cart data if addon is present for any line item
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		 

	CREATE TABLE #OldGroupSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old group save cart data if present for same SKU in the new save cart data for group product	 	 
	INSERT INTO #OldGroupSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.GroupProductIds,'')   )   
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup   

	--Getting the old save cart Parent data
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
		AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldGroupSavecartLineitemDetails

	DELETE a FROM #OldGroupSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldGroupSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old config product save cart addon data for old line items if present
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.GroupProductIds SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldGroupSavecartLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldGroupSavecartLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN
		DELETE FROM #OldGroupSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails a
			WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t with (nolock) WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldGroupSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS  NULL  

			IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSavecartLineitemDetails
			END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem with (nolock)  WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSavecartLineitemDetails
			END
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 
			-- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup  )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL
		END
		ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails
		END 
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails
		END  
	END

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present	
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN
		DELETE FROM #OldGroupSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId IN (
				SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues)) 
				OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
				(SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails)  )
		BEGIN
			DELETE n 
			FROM #OldGroupSavecartLineitemDetails n 
			WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldGroupSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	END
	
	IF EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails)
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
					INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
					where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
			a.PersonalizeCode
			,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU)
			where isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.GroupProductIds
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldGroupSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.GroupProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldGroupSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldGroupSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
				--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			WHERE ISNULL(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldGroupSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldGroupSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
			a.Custom1 = ty.Custom1,
			a.Custom2 = ty.Custom2,
			a.Custom3 = ty.Custom3,
			a.Custom4 = ty.Custom4,
			a.Custom5 = ty.Custom5,
			a.ModifiedDate = @GetDate ,
			a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewGroupSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		UPDATE a
		SET a.Quantity = a.Quantity+s.AddOnQuantity,
			a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewGroupSavecartLineitemDetails N
	LEFT JOIN #OldGroupSavecartLineitemDetails O ON N.OmsSavedCartId=O.OmsSavedCartId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		SELECT RowId, Id ,Row_number()Over(ORDER BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewId() ) Sequence ,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU ,CustomUnitPrice 
		INTO #InsertNewGroupSavecartLineitem   
		FROM #NewGroupSavecartLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId) OR ParentSKU IS NULL
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU, CustomUnitPrice
		ORDER BY RowId, Id

		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewGroupSavecartLineitem
		WHERE Quantity <=0
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS
		(
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU
			FROM #InsertNewGroupSavecartLineitem m
			INNER JOIN  #InsertNewGroupSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		)
		UPDATE m1   
		SET m1.RowId = TYU.RowId
		FROM #InsertNewGroupSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  

		;WITH VTRET AS   
		(
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU, OrderLineItemRelationshipTypeId 
			FROM #InsertNewGroupSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeId
			HAVING SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)
		DELETE 
		FROM #InsertNewGroupSavecartLineitem 
		WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice)  
		OUTPUT INSERTED.SKU,INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description, CustomUnitPrice
		FROM  #InsertNewGroupSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO  #Cte_newData
		FROM ZnodeOmsSavedCartLineItem a  with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS nULL   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
  
		-----------------------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData1
		FROM ZnodeOmsSavedCartLineItem a with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId and 
				a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		----------------------------------------------------------------------------------------------------------------------------

		SELECT DISTINCT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  --,Row_number()Over(ORDER BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #Cte_newAddon1
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) and c.ParentOmsSavedCartLineItemId is null

		-- Added to get distinct records.
		SELECT *,ROW_NUMBER()OVER(ORDER BY OmsSavedCartLineItemId) RowIdNo 
		INTO #Cte_newAddon 
		FROM #Cte_newAddon1

		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(ORDER BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
				AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
				AND a.ParentOmsSavedCartLineItemId IS NULL  
				AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
				AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		)
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #Cte_newAddon  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId)  FROM #Cte_newAddon  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewGroupSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		 )
		UPDATE a 
		SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewGroupSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
			AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(ORDER BY OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewGroupSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.GroupProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b WITH (NOLOCK) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL  

		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	END 

	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemQuantity')
	DROP PROC Znode_InsertUpdateSaveCartLineItemQuantity
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemQuantity](
	  @CartLineItemXML xml, @UserId int,@Status bit OUT )
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
	BEGIN TRAN InsertUpdateSaveCartLineItem;
	BEGIN TRY
		SET NOCOUNT ON;
		DECLARE @GetDate datetime= dbo.Fn_GetDate();
		DECLARE @AddOnQuantity numeric(28, 6)= 0;
		DECLARE @IsAddProduct   BIT = 0 
		DECLARE @OmsSavedCartLineItemId INT = 0
		DECLARE @TBL_SavecartLineitems TABLE
		( 
			RowId int , OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
			CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
			AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
			Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
			nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max), CustomUnitPrice numeric(28, 6)
		);

		DECLARE @OrderLineItemRelationshipTypeIdAddon int =
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'AddOns'
		);
		DECLARE @OrderLineItemRelationshipTypeIdSimple int =
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Simple'
		);
		DECLARE @OrderLineItemRelationshipTypeIdGroup int=
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Group'
		);
		DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Configurable'
		);
		 DECLARE @OrderLineItemRelationshipTypeIdBundle int=
		(
			SELECT TOP 1 OrderLineItemRelationshipTypeId
			FROM ZnodeOmsOrderLineItemRelationshipType
			WHERE [Name] = 'Bundles'
		);
		INSERT INTO @TBL_SavecartLineitems( RowId,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
		Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity,CustomUnitPrice )
			   SELECT DENSE_RANK()Over(Order BY Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' )) RowId ,Tbl.Col.value( 'OmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartLineItemId, Tbl.Col.value( 'ParentOmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsSavedCartLineItemId, Tbl.Col.value( 'OmsSavedCartId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
			   , Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ) AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			          Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
					  Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
					  Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
					  Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
					  Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
					  Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
					  Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
					  Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
					  Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
					  Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
					  Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity,
					  Tbl.Col.value( 'CustomUnitPrice[1]', 'NVARCHAR(2000)' ) AS CustomUnitPrice
			   FROM @CartLineItemXML.nodes( '//ArrayOfSavedCartLineItemModel/SavedCartLineItemModel' ) AS Tbl(Col);
			  

			  IF OBJECT_ID('tempdb..#TBL_SavecartLineitems') is not null
				drop table #TBL_SavecartLineitems

			 IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
				drop table #OldValueForAddon

			  SELECT * INTO #TBL_SavecartLineitems FROM @TBL_SavecartLineitems
			

			UPDATE ZnodeOmsSavedCart
			SET ModifiedDate = GETDATE()
			WHERE OmsSavedCartId = (SELECT TOP 1  OmsSavedCartId FROM @TBL_SavecartLineitems)
				

			  UPDATE  @TBL_SavecartLineitems
			  SET 	Description = ISNUll(Description,'') 

			IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
			 BEGIN 				
				 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 
				    SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
					, ModifiedDate = @GetDate,CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
					WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 
					 
					--UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					AND SCLI.BundleProductIds <> ''

					DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
				 END 
				  DECLARE @TBL_bundleProduct TT_SavecartLineitems 
				  INSERT INTO @TBL_bundleProduct 
				  SELECT *  
				  FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(BundleProductIds,'') <> '' 
				
				  EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
				  DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
				  SET @OmsSavedCartLineItemId = 0 
				END 
			IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
			    BEGIN 				
				 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 

				   SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
				   	UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
					, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
					WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId
					
					--UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE  ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate,CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					AND SCLI.ConfigurableProductIds <> ''

					DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
				 END 
				  DECLARE @TBL_Configurable TT_SavecartLineitems 
				  INSERT INTO @TBL_Configurable 
				  SELECT *  
				  FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(ConfigurableProductIds,'') <> '' 

				  
				  EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
				  DELETE FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(ConfigurableProductIds,'') <> ''
				  SET @OmsSavedCartLineItemId = 0  
				END 
				IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
			    BEGIN 				
				 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 
				   SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				   	UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId ), CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
					WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId
					
					--UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND  OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					AND SCLI.GroupProductIds <> ''

					DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
				 END 
				  DECLARE @TBL_Group TT_SavecartLineitems 
				  INSERT INTO @TBL_Group 
				  SELECT *  
				  FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(GroupProductIds,'') <> '' 

				
				  EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
				  
				  DELETE FROM @TBL_SavecartLineitems 
				  WHERE ISNULL(GroupProductIds,'') <> ''
				  SET @OmsSavedCartLineItemId = 0  
				END 
				 
                IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
				 BEGIN 
				 
				   SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
				   	UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
					, ModifiedDate = @GetDate
					WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId
				
				 --   UPDATE ZnodeOmsSavedCartLineItem 
					--SET Quantity = (SELECT TOP 1 AddOnQuantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0)
					--WHERE ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId  
					--AND OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					UPDATE ZnodeOmsSavedCartLineItem 
					SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
					FROM ZnodeOmsSavedCartLineItem ZOSCLI
					INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
					WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
					DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
				 END 
			 
			

			  DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
			  DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
			  INSERT INTO @TBL_Personalise
			  SELECT DISTINCT NULL 
							,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		  ,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					  ,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					  ,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			  FROM (SELECT TOP 1 PersonalisedAttribute Valuex FROM  @TBL_SavecartLineitems TRTR  ) a 
			  CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
			   ----To update saved cart item personalise value from given line item
			  DECLARE @TBL_Personalise1 TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
			  INSERT INTO @TBL_Personalise1
			  SELECT DISTINCT a.OmsSavedCartLineItemId 
					  ,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		  ,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					  ,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					  ,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			  FROM (SELECT TOP 1 OmsSavedCartLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SavecartLineitems TRTR ) a 
			  CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
			  CREATE TABLE #tempoi (GenId INT IDENTITY(1,1),RowId	int	,OmsSavedCartLineItemId	int	 ,ParentOmsSavedCartLineItemId	int,OmsSavedCartId	int
									,SKU	nvarchar(max) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	int	,CustomText	nvarchar(max)
									,CartAddOnDetails	nvarchar(max),Sequence	int	,AutoAddon	varchar(max)	,OmsOrderId	int	,ItemDetails	nvarchar(max)
									,Custom1	nvarchar(max)  ,Custom2	nvarchar(max),Custom3	nvarchar(max),Custom4	nvarchar(max),Custom5	nvarchar(max)
									,GroupId	nvarchar(max) ,ProductName	nvarchar(max),Description	nvarchar(max),Id	int,ParentSKU NVARCHAR(max))
				   
			   INSERT INTO #tempoi
			   SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
			   FROM @TBL_SavecartLineitems a 
			   GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			  
			   INSERT INTO #tempoi
			   SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
			   FROM @TBL_SavecartLineitems  a 
			   WHERE ISNULL(BundleProductIds,'') =  '' 
			   AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
			   	   GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
					,Quantity,  CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			  
     		   INSERT INTO #tempoi
			   SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
					,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
					,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
					WHEN  GroupProductIds <> '' THEN GroupProductIds 
					WHEN BundleProductIds <> '' THEN BundleProductIds 
					 ELSE SKU END     ParentSKU 
			   FROM @TBL_SavecartLineitems  a 
			   WHERE AddOnValueIds <> ''
			   	   GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
					,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
					,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
           --hack
		
		 CREATE TABLE #OldValue (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
		 
		INSERT INTO #OldValue  
		SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	  	FROM ZnodeOmsSavedCartLineItem a   
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
        AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

			

		INSERT INTO #OldValue 
		SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValue c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
		AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
		DELETE a FROM #OldValue a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldValue b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
		------Merge Addon for same product
		SELECT * INTO #OldValueForAddon from #OldValue
		
		INSERT INTO #OldValue 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValue c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		
		
		------Merge Addon for same product
		IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
		BEGIN

			INSERT INTO #OldValueForAddon 
			SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
			FROM ZnodeOmsSavedCartLineItem b 
			INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
			AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

			SELECT distinct SKU, STUFF(
										( SELECT  ', ' + SKU FROM    
											( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
											  where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
											  FOR XML PATH('')
										), 1, 2, ''
									 ) AddOns
			INTO #AddOnsExists
			from #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

			SELECT distinct a.SKU, STUFF(
										 ( SELECT  ', ' + x.AddOnValueIds FROM    
											( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
											  where a.SKU=b.SKU ) x
											  FOR XML PATH('')
										 ), 1, 2, ''
									   ) AddOns
			INTO #AddOnAdded
			from @TBL_SavecartLineitems a

			if not exists(select * from #AddOnsExists a inner join #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
			begin
				delete from #OldValue
			end

		END

		IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldValue a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		
		DELETE FROM #OldValue 
		END 
		ELSE 
		BEGIN 
	    
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		 BEGIN 
		 
		 DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
		 INSERT INTO  @parenTofAddon 
		 SELECT  ParentOmsSavedCartLineItemId FROM #OldValue WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

		 DELETE FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
					AND ParentOmsSavedCartLineItemId IS NOT NULL  
					AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

		 DELETE FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldValue m)
		 AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		 END 
		 ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		 BEGIN 

		 -- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a 
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldValue WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldValue WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			 DELETE FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldValue m)
		 AND ParentOmsSavedCartLineItemId IS  NULL  

		 END
		 ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldValue ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		      AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		 BEGIN 

		   DELETE FROM #OldValue
		 END 
		END 
			
	

		DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
		INSERT INTO @TBL_Personaloldvalues
		SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
		FROM ZnodeOmsPersonalizeCartItem  a 
		WHERE EXISTS (SELECT TOP 1 1 FROM #OldValue TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
		

		IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		   AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
		BEGIN 
		 DELETE FROM #OldValue
		END 
		ELSE 
		BEGIN 
		 IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		   
		   DELETE FROM #OldValue WHERE OmsSavedCartLineItemId IN (
		   SELECT OmsSavedCartLineItemId FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
		   OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldValue WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
		   AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		   
		
		   
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		 AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		 BEGIN 
		   
		   

		   DELETE n FROM #OldValue n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
		   OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		   
		  
		   
		 END 
		 ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		        AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldValue YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		       AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldValue WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		 BEGIN 
		     DELETE FROM #OldValue WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		 END 


		  
		END 

		----delete old value from table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;with cte as
		(
			select distinct b.*
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute as varchar(max)),'') = ''
		)
		,cte2 as
		(
			select c.ParentOmsSavedCartLineItemId
			from #OldValue a
			inner join ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			inner join ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		)
		delete a from #OldValue a
		inner join cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		inner join cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----delete old value from table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;with cte as
		(
			select distinct b.*, 
			Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on ( a.SKU = b.sku)
			CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
			where isnull(cast(a.PersonalisedAttribute as varchar(max)),'') <> ''
		)
		,cte2 as
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			from #OldValue a
			inner join ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			where not exists(select * from cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
			                 and b.PersonalizeValue = c.PersonalizeValue )
		)
		delete a from #OldValue a
		inner join cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		inner join cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;with cte as
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU as SKU
					,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on a.SKU = b.SKU
			CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
			Inner join ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		delete b1
		from #OldValue b1 
		where not exists(select * from cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
	    and exists(select * from cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;with cte as
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
					,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			  		,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
					,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
					,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
			FROM @TBL_SavecartLineitems a 
			Inner Join #OldValue b on a.SKU = b.SKU
			CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
			Inner join ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		delete b1
		from cte a1		  
		Inner Join #OldValue b1 on a1.sku = b1.SKU
		where not exists(select * from ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		IF EXISTS (SELECT TOP 1 1 FROM #OldValue )
		BEGIN 

		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldValue b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #tempoi ty ON (ty.SKU = b.SKU)


		END 
		ELSE 
		BEGIN 
		
		
			   
    SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
     INTO #yuuete   
     FROM  #tempoi  
     GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails ,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
     ORDER BY RowId, Id   
       	
			     
    DELETE FROM #yuuete WHERE Quantity <=0  
  
     ;WITH VTTY AS   
    (  
    SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
       FROM #yuuete m  
    INNER JOIN  #yuuete TY1 ON TY1.SKU = m.ParentSKU   
    WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
    )   
	
    UPDATE m1   
    SET m1.RowId = TYU.RowId  
    FROM #yuuete m1   
    INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
    ;WITH VTRET AS   
    (  
    SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
    FROM #yuuete   
    GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
	Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
    )   
    
    DELETE FROM #yuuete WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  
	
	

	
     
       INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
       OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
	   SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
       ,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
       ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
       FROM  #yuuete  TH  

 
	 --;with Cte_newData AS   
  --  (  
    SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
	, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
	INTO #Cte_newData
    FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
    WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
	--	AND NOT EXISTS (SELECT TOP 1 1 FROM #OldValue TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #yuuete TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
     GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID
				
    --)   
	
  
    UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
    WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
    FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
    WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
    AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
    AND a.ParentOmsSavedCartLineItemId IS nULL   
  

    
    --;with Cte_newAddon AS   
    --(  
    SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
    INTO #Cte_newAddon
	FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
	INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
    WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
    AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null
  --  )   
  


  --  SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
	 --FROM ZnodeOmsSavedCartLineItem a
	 --WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
  --   AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
  --   AND a.ParentOmsSavedCartLineItemId IS NULL  
	 --AND EXISTS (SELECT TOP 1 1  FROM  #yuuete ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
	 --AND EXISTS (SELECT TOP 1 1 FROM #Cte_newAddon TI WHERE TI.SKU = a.SKU)



   ;with table_update AS 
   (
     SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
	 FROM ZnodeOmsSavedCartLineItem a
	 WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
     AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
     AND a.ParentOmsSavedCartLineItemId IS NULL  
	 AND EXISTS (SELECT TOP 1 1  FROM  #yuuete ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
	 AND EXISTS (SELECT TOP 1 1 FROM #Cte_newAddon TI WHERE TI.SKU = a.SKU)
   )

    UPDATE a SET  
   --SELECT  a.OmsSavedCartLineItemId,
	a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
	FROM #Cte_newAddon  r  
    WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
    FROM table_update a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
    WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
	  FROM #Cte_newAddon  r  
    WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 

	
	  
    ;with Cte_Th AS   
    (             
      SELECT RowId    
     FROM #yuuete a   
     GROUP BY RowId   
     HAVING COUNT(NewRowId) <= 1   
      )   
    UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
    FROM ZnodeOmsSavedCartLineItem a  
    INNER JOIN #yuuete b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
    WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
     AND a.OrderLineItemRelationshipTypeId IS NULL   
  
    UPDATE  ZnodeOmsSavedCartLineItem   
    SET GROUPID = NULL   
    WHERE  EXISTS (SELECT TOP 1 1  FROM #yuuete RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
    AND OrderLineItemRelationshipTypeId IS NOT NULL     
       ;With Cte_UpdateSequence AS   
     (  
       SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
       FROM ZnodeOmsSavedCartLineItem   
       WHERE EXISTS (SELECT TOP 1 1 FROM #yuuete TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
     )   
    UPDATE Cte_UpdateSequence  
    SET  Sequence = RowId  
	
	----To update saved cart item personalise value from given line item	
	if exists(select * from @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
	Begin
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise1 SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	end		
	
	UPDATE @TBL_Personalise
	SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
	FROM @OmsInsertedData a 
	INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
	WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
	DELETE FROM ZnodeOmsPersonalizeCartItem 
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
    MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
	USING @TBL_Personalise SOURCE
		   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
	WHEN NOT MATCHED THEN 
		    INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
			VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
END 

	
	SET @Status = 1;
	COMMIT TRAN InsertUpdateSaveCartLineItem;
	END TRY
	BEGIN CATCH
		SELECT ERROR_MESSAGE()	
		SET @Status = 0;
		DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
 AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@Status='+CAST(@Status AS varchar(10));

		SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
		ROLLBACK TRAN InsertUpdateSaveCartLineItem;
		EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItem', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
	END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper')
	DROP PROC Znode_InsertUpdateSaveCartLineItemQuantityWrapper
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemQuantityWrapper]
(
	@CartLineItemXML xml, 
	@UserId int,
	@PortalId Int,
	@OmsCookieMappingId INT = 0 
)
AS 
   /* 
    Summary: THis Procedure is USed to save and edit the saved cart line item      
    Unit Testing 
	begin tran  
    Exec Znode_InsertUpdateSaveCartLineItem @CartLineItemXML= '<ArrayOfSavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>BlueGreenYellow</SKU>
    <Quantity>1.000000</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>1</Sequence>
    <AddonProducts>YELLOW</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts>GREEN</ConfigurableProducts>
  </SavedCartLineItemModel>
  <SavedCartLineItemModel>
    <OmsSavedCartLineItemId>0</OmsSavedCartLineItemId>
    <ParentOmsSavedCartLineItemId>0</ParentOmsSavedCartLineItemId>
    <OmsSavedCartId>1259</OmsSavedCartId>
    <SKU>ap1534</SKU>
    <Quantity>1.0</Quantity>
    <OrderLineItemRelationshipTypeId>0</OrderLineItemRelationshipTypeId>
    <Sequence>2</Sequence>
    <AddonProducts >PINK</AddonProducts>
    <BundleProducts />
    <ConfigurableProducts />
    <PersonaliseValuesList>Address~Hello</PersonaliseValuesList>
  </SavedCartLineItemModel>
</ArrayOfSavedCartLineItemModel>' , @UserId=1 ,@Status=0
	rollback tran
*/
BEGIN
BEGIN TRAN InsertUpdateSaveCartLineItem;
BEGIN TRY
SET NOCOUNT ON;
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate();
	DECLARE @AddOnQuantity numeric(28, 6)= 0;
	DECLARE @IsAddProduct   BIT = 0 
	DECLARE @OmsSavedCartLineItemId INT = 0
	
	DECLARE @TBL_SavecartLineitems TABLE
	( 
		RowId int IDENTITY(1,1), OmsSavedCartLineItemId int, ParentOmsSavedCartLineItemId int, OmsSavedCartId int, SKU nvarchar(600), Quantity numeric(28, 6), OrderLineItemRelationshipTypeID int, CustomText nvarchar(max), 
		CartAddOnDetails nvarchar(max), Sequence int, AddOnValueIds varchar(max), BundleProductIds varchar(max), ConfigurableProductIds varchar(max), GroupProductIds varchar(max), PersonalisedAttribute XML, 
		AutoAddon varchar(max), OmsOrderId int, ItemDetails nvarchar(max),
		Custom1	nvarchar(max),Custom2 nvarchar(max),Custom3 nvarchar(max),Custom4
		nvarchar(max),Custom5 nvarchar(max),GroupId NVARCHAR(max) ,ProductName Nvarchar(1000) , Description NVARCHAR(max),AddOnQuantity NVARCHAR(max), CustomUnitPrice numeric(28, 6)
	);

	--Set the OrderLineItemRelationshipTypeId for Addons product
	DECLARE @OrderLineItemRelationshipTypeIdAddon int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'AddOns'
	);
	--Set the OrderLineItemRelationshipTypeId for simple product
	DECLARE @OrderLineItemRelationshipTypeIdSimple int =
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Simple'
	);
	--Set the OrderLineItemRelationshipTypeId for group product
	DECLARE @OrderLineItemRelationshipTypeIdGroup int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Group'
	);
	--Set the OrderLineItemRelationshipTypeId for Configurable product
	DECLARE @OrderLineItemRelationshipTypeIdConfigurable int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Configurable'
	);
	--Set the OrderLineItemRelationshipTypeId for Bundles product	
	DECLARE @OrderLineItemRelationshipTypeIdBundle int=
	(
		SELECT TOP 1 OrderLineItemRelationshipTypeId
		FROM ZnodeOmsOrderLineItemRelationshipType
		WHERE [Name] = 'Bundles'
	);

	-----Getting OmsSaveCartId FROM @OmsCookieMappingId
	DECLARE @OmsSavedCartId int
	--Getting OmsCookieMappingId on basis of @UserId and portalid if @UserId > 0 (Not a guest User)
	IF isnull(@OmsCookieMappingId,0)=0 and isnull(@UserId,0) <> 0  
	Begin
		SET @OmsCookieMappingId = (SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) where isnull(UserId,0) = @UserID AND isnull(PortalId,0) = @PortalId)
	END

	IF Not Exists(SELECT top 1 OmsCookieMappingId FROM ZnodeOmsCookieMapping with (nolock) Where OmsCookieMappingId = @OmsCookieMappingId)
	Begin
		INSERT INTO ZnodeOmsCookieMapping (UserId,PortalId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT case when @UserId = 0 then null else @UserId end ,@PortalId,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsCookieMappingId = @@IDENTITY
	End
	----To get the oms savecartid on basis of @OmsCookieMappingId 
	SET @OmsSavedCartId = (SELECT top 1 OmsSavedCartId FROM ZnodeOmsSavedCart with (nolock) where OmsCookieMappingId = @OmsCookieMappingId)
	
	----If omssavecartid not present in ZnodeOmsSavedCart table then inserting new record to generated omssavecartid 
	IF isnull(@OmsSavedCartId,0) = 0
	BEGIN
		INSERT INTO ZnodeOmsSavedCart(OmsCookieMappingId,SalesTax,RecurringSalesTax,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
		SELECT @OmsCookieMappingId,Null,Null,@UserId,@GetDate,@UserId,@GetDate

		SET @OmsSavedCartId = @@IDENTITY
	END

	--Fetching data FROM xml to table format and inserted into table @TBL_SavecartLineitems
	INSERT INTO @TBL_SavecartLineitems( OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU, Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence, AddOnValueIds, BundleProductIds, ConfigurableProductIds, GroupProductIds, PersonalisedAttribute, AutoAddon, OmsOrderId, ItemDetails,
	Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,Description,AddOnQuantity, CustomUnitPrice )
	SELECT Tbl.Col.value( 'OmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS OmsSavedCartLineItemId, Tbl.Col.value( 'ParentOmsSavedCartLineItemId[1]', 'NVARCHAR(2000)' ) AS ParentOmsSavedCartLineItemId, @OmsSavedCartId AS OmsSavedCartId, Tbl.Col.value( 'SKU[1]', 'NVARCHAR(2000)' ) AS SKU, Tbl.Col.value( 'Quantity[1]', 'NVARCHAR(2000)' ) AS Quantity
	, Tbl.Col.value( 'OrderLineItemRelationshipTypeID[1]', 'NVARCHAR(2000)' ) AS OrderLineItemRelationshipTypeID, Tbl.Col.value( 'CustomText[1]', 'NVARCHAR(2000)' ) AS CustomText, Tbl.Col.value( 'CartAddOnDetails[1]', 'NVARCHAR(2000)' ) AS CartAddOnDetails, Tbl.Col.value( 'Sequence[1]', 'NVARCHAR(2000)' ) AS Sequence, Tbl.Col.value( 'AddonProducts[1]', 'NVARCHAR(2000)' ) AS AddOnValueIds, ISNULL(Tbl.Col.value( 'BundleProducts[1]', 'NVARCHAR(2000)' ),'') AS BundleProductIds, ISNULL(Tbl.Col.value( 'ConfigurableProducts[1]', 'NVARCHAR(2000)' ),'') AS ConfigurableProductIds, ISNULL(Tbl.Col.value( 'GroupProducts[1]', 'NVARCHAR(Max)' ),'') AS GroupProductIds, 
			Tbl.Col.query('(PersonaliseValuesDetail/node())') AS PersonaliseValuesDetail, Tbl.Col.value( 'AutoAddon[1]', 'NVARCHAR(Max)' ) AS AutoAddon, Tbl.Col.value( 'OmsOrderId[1]', 'NVARCHAR(Max)' ) AS OmsOrderId,
			Tbl.Col.value( 'ItemDetails[1]', 'NVARCHAR(Max)' ) AS ItemDetails,
			Tbl.Col.value( 'Custom1[1]', 'NVARCHAR(Max)' ) AS Custom1,
			Tbl.Col.value( 'Custom2[1]', 'NVARCHAR(Max)' ) AS Custom2,
			Tbl.Col.value( 'Custom3[1]', 'NVARCHAR(Max)' ) AS Custom3,
			Tbl.Col.value( 'Custom4[1]', 'NVARCHAR(Max)' ) AS Custom4,
			Tbl.Col.value( 'Custom5[1]', 'NVARCHAR(Max)' ) AS Custom5,
			Tbl.Col.value( 'GroupId[1]', 'NVARCHAR(Max)' ) AS GroupId,
			Tbl.Col.value( 'ProductName[1]', 'NVARCHAR(Max)' ) AS ProductName,
			Tbl.Col.value( 'Description[1]', 'NVARCHAR(Max)' ) AS Description, 
			Tbl.Col.value( 'AddOnQuantity[1]', 'NVARCHAR(2000)' ) AS AddOnQuantity,
			Tbl.Col.value( 'CustomUnitPrice[1]', 'NVARCHAR(2000)' ) AS CustomUnitPrice
	FROM @CartLineItemXML.nodes( '//ArrayOfSavedCartLineItemModel/SavedCartLineItemModel' ) AS Tbl(Col);

	IF OBJECT_ID('tempdb..#TBL_SavecartLineitems') is not null
		DROP TABLE #TBL_SavecartLineitems

	IF OBJECT_ID('tempdb..#OldValueForAddon') is not null
		DROP TABLE #OldValueForAddon

	SELECT * INTO #TBL_SavecartLineitems FROM @TBL_SavecartLineitems
			
	UPDATE ZnodeOmsSavedCart
	SET ModifiedDate = GETDATE()
	WHERE OmsSavedCartId = (SELECT TOP 1  OmsSavedCartId FROM @TBL_SavecartLineitems)

	UPDATE  @TBL_SavecartLineitems
	SET 	Description = ISNUll(Description,'') 

	--Save cart execution code for bundle product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0 )

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0)
			, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			WHERE ( OmsSavedCartLineItemId = @OmsSavedCartLineItemId  
			OR ParentOmsSavedCartLineItemId =  @OmsSavedCartLineItemId   ) 

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate,CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.BundleProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE BundleProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 

		--Getting bundle save cart line item entries into table to pass for bundle prodcut sp
		DECLARE @TBL_bundleProduct TT_SavecartLineitems 
		INSERT INTO @TBL_bundleProduct 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(BundleProductIds,'') <> '' 
				
		EXEC Znode_InsertUpdateSaveCartLineItemBundle @TBL_bundleProduct,@userId,@OrderLineItemRelationshipTypeIdBundle,@OrderLineItemRelationshipTypeIdAddon
				 
		DELETE FROM  @TBL_SavecartLineitems WHERE ISNULL(BundleProductIds,'') <> '' 
		SET @OmsSavedCartLineItemId = 0 
	END 
	--Save cart execution code for configurable product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 

			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
				 
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
			, ModifiedDate = @GetDate,CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.ConfigurableProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE ConfigurableProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for configurable prodcut sp
		DECLARE @TBL_Configurable TT_SavecartLineitems 
		INSERT INTO @TBL_Configurable 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> '' 
		  
		EXEC Znode_InsertUpdateSaveCartLineItemConfigurable @TBL_Configurable,@userId,@OrderLineItemRelationshipTypeIdConfigurable,@OrderLineItemRelationshipTypeIdAddon
				  
		DELETE FROM @TBL_SavecartLineitems 
		WHERE ISNULL(ConfigurableProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	--Save cart execution code for group product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' )
	BEGIN 				
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0  ) 
		BEGIN 
			--Updating the existing save cart for group product
			SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0 )
			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId = @OmsSavedCartLineItemId ), CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

			UPDATE ZnodeOmsSavedCartLineItem 
			SET Quantity = AddOnQuantity, ModifiedDate = @GetDate, CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
			FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
			INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = SCLI.OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
			WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
			AND SCLI.GroupProductIds <> ''

			--After update the existing cart with new save cart then deleting those records which are updated
			DELETE	FROM @TBL_SavecartLineitems WHERE GroupProductIds <> '' AND OmsSavedCartLineItemId <> 0
		END 
		--Getting bundle save cart line item entries into table to pass for group prodcut sp
		DECLARE @TBL_Group TT_SavecartLineitems 
		INSERT INTO @TBL_Group 
		SELECT *  
		FROM @TBL_SavecartLineitems 
		WHERE ISNULL(GroupProductIds,'') <> '' 
		
		EXEC Znode_InsertUpdateSaveCartLineItemGroup @TBL_Group,@userId,@OrderLineItemRelationshipTypeIdGroup,@OrderLineItemRelationshipTypeIdAddon
		
		--After update the existing cart with new save cart then deleting those records which are updated
		DELETE FROM @TBL_SavecartLineitems WHERE ISNULL(GroupProductIds,'') <> ''
		SET @OmsSavedCartLineItemId = 0  
	END 
	
	--This part is for updating the cart for existing line items for simple product
	IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0  ) 
	BEGIN 
				 
		SET @OmsSavedCartLineItemId  = (SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId <> 0 )
		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = (SELECT TOP 1 Quantity FROM @TBL_SavecartLineitems WHERE  OmsSavedCartLineItemId = @OmsSavedCartLineItemId )
		, ModifiedDate = @GetDate , CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
		WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId

		DECLARE @ParentOmsSavedCartLineItemId INT = 0
		SET @ParentOmsSavedCartLineItemId = (select ParentOmsSavedCartLineItemId from ZnodeOmsSavedCartLineItem WHERE OmsSavedCartLineItemId = @OmsSavedCartLineItemId)

		UPDATE ZnodeOmsSavedCartLineItem 
		SET  CustomUnitPrice = (SELECT TOP 1 CustomUnitPrice FROM @TBL_SavecartLineitems)
		WHERE OmsSavedCartLineItemId = @ParentOmsSavedCartLineItemId

		UPDATE ZnodeOmsSavedCartLineItem 
		SET Quantity = AddOnQuantity, ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem ZOSCLI with (nolock)
		INNER JOIN @TBL_SavecartLineitems SCLI ON ZOSCLI.ParentOmsSavedCartLineItemId = @OmsSavedCartLineItemId AND ZOSCLI.OmsSavedCartId = SCLI.OmsSavedCartId AND ZOSCLI.SKU = SCLI.AddOnValueIds
		WHERE ZOSCLI.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
					
		DELETE	FROM @TBL_SavecartLineitems WHERE OmsSavedCartLineItemId <> 0
	END 
	--Save cart execution code for Simple product
	DECLARE @OmsInsertedData TABLE (OmsSavedCartLineItemId INT )
	--Inserting the personalise data into variable table @TBL_Personalise for inserting the personalise data for new products
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId int,SKU Varchar(600) ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.SKU
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM @TBL_SavecartLineitems a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col) 
			  
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise1 TABLE (OmsSavedCartLineItemId INT ,PersonalizeCode NVARCHAr(max),PersonalizeValue NVARCHAr(max),DesignId NVARCHAr(max), ThumbnailURL NVARCHAr(max))
	INSERT INTO @TBL_Personalise1
	SELECT DISTINCT a.OmsSavedCartLineItemId 
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(Max)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(Max)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(Max)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(Max)' ) AS ThumbnailURL
	FROM (SELECT TOP 1 OmsSavedCartLineItemId,PersonalisedAttribute Valuex FROM  #TBL_SavecartLineitems TRTR ) a 
	CROSS APPLY	a.Valuex.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  
		    
			
	CREATE TABLE #NewSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT	,OmsSavedCartLineItemId	INT	 ,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	INT
		,SKU	NVARCHAR(MAX) ,Quantity	NUMERIC(28,6)	,OrderLineItemRelationshipTypeID	INT	,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	int	,AutoAddon	varchar(MAX)	,OmsOrderId	INT	,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX)
	)
	
	--Getting new save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU 
	FROM @TBL_SavecartLineitems a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
	
	--Getting new simple product save cart data
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, @OrderLineItemRelationshipTypeIdSimple, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE ISNULL(BundleProductIds,'') =  '' 
	AND  ISNULL(GroupProductIds,'') = ''	AND ISNULL(	ConfigurableProductIds,'') = ''
		GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity,  CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName
			
	--Getting new Group,Bundle and Configurable products save cart data if addon is present for any line item
	INSERT INTO #NewSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
		WHEN  GroupProductIds <> '' THEN GroupProductIds 
		WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU 
	FROM @TBL_SavecartLineitems  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
	,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
	,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU
	
	CREATE TABLE #OldSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old save cart data if present for same SKU in the new save cart data for simple product	 
	INSERT INTO #OldSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.SKU,'')   )   
	AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple   

	--Getting the old save cart Parent data 
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
	AND  b.OrderLineItemRelationshipTypeID IS NULL 
		 
	DELETE a FROM #OldSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 
		
	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldSavecartLineitemDetails
		
	--Getting the old save cart addon data for old line items if present
	INSERT INTO #OldSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
	AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN

		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b with (nolock)
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT distinct a.SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @TBL_SavecartLineitems b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @TBL_SavecartLineitems a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldSavecartLineitemDetails
		END

	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_SavecartLineitems ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldSavecartLineitemDetails a WHERE	
	ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN 
		
		DELETE FROM #OldSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
	    
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN 
		 
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  
		 
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 

			DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple  )
			AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
			OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldSavecartLineitemDetails m)
			AND ParentOmsSavedCartLineItemId IS  NULL  

		END
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_SavecartLineitems WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 

			DELETE FROM #OldSavecartLineitemDetails
		END 
	END 

	--Getting the personalise data for old save cart if present
	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)

	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
	AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN 
		DELETE FROM #OldSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
		   
			DELETE FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId IN (
			SELECT OmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ) ) 
			OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
			AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues ))
		      
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 

			DELETE n FROM #OldSavecartLineitemDetails n WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
	   
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	  
	END 

	--If already exists cart 
	IF EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*
			FROM @TBL_SavecartLineitems a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			SELECT c.ParentOmsSavedCartLineItemId
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsSavedCartLineItem c on a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			SELECT distinct b.*, 
				a.PersonalizeCode
				,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on ( a.SKU = b.sku)
			where a.PersonalizeValue <> ''
		)
		,cte2 AS
		(
			SELECT a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
						and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.SKU AS SKU
				,a.PersonalizeCode
				,a.PersonalizeValue
				,a.DesignId
				,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldSavecartLineitemDetails b ON a.SKU = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
			--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewSavecartLineitemDetails  b ON a.SKU = b.SKU
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0 AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		inner join CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		inner join #OldSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
	--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
	
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.SKU
						,d.PersonalizeCode
				,d.PersonalizeValue
				,d.DesignId
				,d.ThumbnailURL
				FROM @TBL_SavecartLineitems a 
				INNER JOIN #OldSavecartLineitemDetails b on a.SKU = b.SKU
				INNER JOIN @TBL_Personalise d on d.SKU = a.SKU
				INNER JOIN ZnodeOmsPersonalizeCartItem  c  with (nolock)  on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
				WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM cte a1		  
		INNER JOIN #OldSavecartLineitemDetails b1 on a1.sku = b1.SKU
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)

		--Updating the cart if old and new cart data matches 
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
		a.Custom1 = ty.Custom1,
		a.Custom2 = ty.Custom2,
		a.Custom3 = ty.Custom3,
		a.Custom4 = ty.Custom4,
		a.Custom5 = ty.Custom5, 
		a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewSavecartLineitemDetails ty ON (ty.SKU = b.SKU)

	END 
	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldSavecartLineitemDetails )
	BEGIN 
	    --Getting the new save cart data and generating row no. for new save cart insert
		SELECT RowId, Id ,Row_number()Over(Order BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewId() ) Sequence ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU  
		INTO #InsertNewSavecartLineitem   
		FROM  #NewSavecartLineitemDetails  
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails ,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU   
		ORDER BY RowId, Id   
       	
		--Removing the line item having Quantity <=0	     
		DELETE FROM #InsertNewSavecartLineitem WHERE Quantity <=0  
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS   
		(  
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU   
			FROM #InsertNewSavecartLineitem m  
			INNER JOIN  #InsertNewSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU   
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon   
		)   
		UPDATE m1   
		SET m1.RowId = TYU.RowId  
		FROM #InsertNewSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  
        
		--Deleting the new save cart line item if cart line item is merged
		;WITH VTRET AS   
		(  
			SELECT RowId,id,Min(NewRowId) NewRowId ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID  
			FROM #InsertNewSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU ,OrderLineItemRelationshipTypeID
			Having  SKU = ParentSKU  AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdSimple
		)   
		DELETE FROM #InsertNewSavecartLineitem WHERE NewRowId IN (SELECT NewRowId FROM VTRET)  

		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description)  
		OUTPUT INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		,CustomText,CartAddOnDetails,ROW_NUMBER()Over(Order BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
		,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description   
		FROM  #InsertNewSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
		, b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU  
		INTO #ParentOmsSavedCartId
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		AND CASE WHEN EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TU WHERE TU.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdSimple)  THEN ISNULL(a.OrderLineItemRelationshipTypeID,0) ELSE 0 END = 0 
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #ParentOmsSavedCartId  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  Order by b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
		AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
		AND a.ParentOmsSavedCartLineItemId IS nULL   

		SELECT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(Order BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #NewSimpleProduct
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1 
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
		AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  and c.ParentOmsSavedCartLineItemId is null

		--Updating ParentOmsSavedCartLineItemId for newly added save cart line item
		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(Order BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS NULL  
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1 FROM #NewSimpleProduct TI WHERE TI.SKU = a.SKU)
		)
		UPDATE a SET  
		a.ParentOmsSavedCartLineItemId =(SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #NewSimpleProduct  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU   GROUP BY r.ParentSKU, r.SKU  )    IS NOT NULL 
	 
		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		)   
		UPDATE a SET a.Quantity =  NULL , a.ModifiedDate = @GetDate  
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		AND OrderLineItemRelationshipTypeId IS NOT NULL     

		;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(Order By OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET  Sequence = RowId  
	
		----To update saved cart item personalise value FROM given line item	
		IF EXISTS(SELECT * FROM @TBL_Personalise1 where isnull(PersonalizeValue,'') <> '' and isnull(OmsSavedCartLineItemId,0) <> 0)
		BEGIN
			DELETE FROM ZnodeOmsPersonalizeCartItem 
			WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise1 yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )

			MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
			USING @TBL_Personalise1 SOURCE
			ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			WHEN NOT MATCHED THEN 
			INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
							,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
			VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
							,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
		END		
	
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN ZnodeOmsSavedCartLineItem b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL 
	
		DELETE FROM ZnodeOmsPersonalizeCartItem 
		WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
						
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
		ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
		WHEN NOT MATCHED THEN 
		INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
					,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
		VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
					,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
  
		
		 
	END 

	Declare @OutputTable Table (CartCount numeric(28,6))

	INSERT INTO @OutputTable
	EXEC [Znode_GetOmsSavedCartLineItemCount] @OmsCookieMappingId = @OmsCookieMappingId,@UserId=@UserId,@PortalId=@UserId
	

	SELECT CAST(1 AS bit) AS Status,@OmsSavedCartId AS SavedCartId,@OmsCookieMappingId AS CookieMappingId,CartCount
	FROM @OutputTable

COMMIT TRAN InsertUpdateSaveCartLineItem;
END TRY
BEGIN CATCH
	SELECT ERROR_MESSAGE()	
	DECLARE @Error_procedure varchar(1000)= ERROR_PROCEDURE(), @ErrorMessage nvarchar(max)= ERROR_MESSAGE(), @ErrorLine varchar(100)= ERROR_LINE(), @ErrorCall nvarchar(max)= 'EXEC Znode_InsertUpdateSaveCartLineItem @CartLineItemXML = '+CAST(@CartLineItemXML
	AS varchar(max))+',@UserId = '+CAST(@UserId AS varchar(50))+',@PortalId='+CAST(@PortalId AS varchar(10))+',@OmsCookieMappingId='+CAST(@OmsCookieMappingId AS varchar(10));

	SELECT 0 AS ID, CAST(0 AS bit) AS Status,ERROR_MESSAGE();
	ROLLBACK TRAN InsertUpdateSaveCartLineItem;
	EXEC Znode_InsertProcedureErrorLog @ProcedureName = 'Znode_InsertUpdateSaveCartLineItemQuantityWrapper', @ErrorInProcedure = @Error_procedure, @ErrorMessage = @ErrorMessage, @ErrorLine = @ErrorLine, @ErrorCall = @ErrorCall;
END CATCH;
END;

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertUpdateSaveCartLineItemGroup')
	DROP PROC Znode_InsertUpdateSaveCartLineItemGroup
GO

CREATE PROCEDURE [dbo].[Znode_InsertUpdateSaveCartLineItemGroup]
(
	 @SaveCartLineItemType TT_SavecartLineitems READONLY  
	,@Userid  INT = 0 
	,@OrderLineItemRelationshipTypeIdGroup INT
	,@OrderLineItemRelationshipTypeIdAddon INT
)
AS 
BEGIN 
BEGIN TRY 
SET NOCOUNT ON 
	--Declared the variables
	DECLARE @GetDate datetime= dbo.Fn_GetDate(); 
	
	DECLARE @OmsInsertedData TABLE (SKU varchar(600),OmsSavedCartLineItemId INT ) 	
	----To update saved cart item personalise value FROM given line item
	DECLARE @TBL_Personalise TABLE (OmsSavedCartLineItemId INT, ParentOmsSavedCartLineItemId INT,GroupProductIds VARCHAR(600) ,PersonalizeCode NVARCHAR(MAX),PersonalizeValue NVARCHAR(MAX),DesignId NVARCHAR(MAX), ThumbnailURL NVARCHAR(MAX))
	INSERT INTO @TBL_Personalise
	SELECT DISTINCT Null, a.ParentOmsSavedCartLineItemId,a.GroupProductIds
			,Tbl.Col.value( 'PersonalizeCode[1]', 'NVARCHAR(MAX)' ) AS PersonalizeCode
			,Tbl.Col.value( 'PersonalizeValue[1]', 'NVARCHAR(MAX)' ) AS PersonalizeValue
			,Tbl.Col.value( 'DesignId[1]', 'NVARCHAR(MAX)' ) AS DesignId
			,Tbl.Col.value( 'ThumbnailURL[1]', 'NVARCHAR(MAX)' ) AS ThumbnailURL
	FROM @SaveCartLineItemType a 
	CROSS APPLY a.PersonalisedAttribute.nodes( '//PersonaliseValueModel' ) AS Tbl(Col)  

	CREATE TABLE #NewGroupSavecartLineitemDetails 
	(
		GenId INT IDENTITY(1,1),RowId	INT ,OmsSavedCartLineItemId	INT,ParentOmsSavedCartLineItemId	INT,OmsSavedCartId	int
		,SKU	NVARCHAR(MAX) ,Quantity	numeric(28,6)	,OrderLineItemRelationshipTypeID	INT ,CustomText	NVARCHAR(MAX)
		,CartAddOnDetails	NVARCHAR(MAX),Sequence	INT ,AutoAddon	VARCHAR(MAX)	,OmsOrderId	INT ,ItemDetails	NVARCHAR(MAX)
		,Custom1	NVARCHAR(MAX)  ,Custom2	NVARCHAR(MAX),Custom3	NVARCHAR(MAX),Custom4	NVARCHAR(MAX),Custom5	NVARCHAR(MAX)
		,GroupId	NVARCHAR(MAX) ,ProductName	NVARCHAR(MAX),Description	NVARCHAR(MAX),Id	INT,ParentSKU NVARCHAR(MAX),
		CustomUnitPrice NUMERIC(28,6)
	)
	 
	--Getting new save cart data(group product)
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,  GroupId ,ProductName,min(Description)Description	,0 Id,NULL ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType a 
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, SKU
		,Quantity, OrderLineItemRelationshipTypeID, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,CustomUnitPrice
	 
	--Getting new group product save cart data
	INSERT INTO #NewGroupSavecartLineitemDetails 
	SELECT   Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
				,Quantity, @OrderLineItemRelationshipTypeIdGroup, CustomText, CartAddOnDetails, Sequence
				,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id,SKU ParentSKU,CustomUnitPrice  
	FROM @SaveCartLineItemType  a 
	WHERE GroupProductIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, GroupProductIds
		,Quantity,  CustomText, CartAddOnDetails, Sequence ,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		
	--Getting new group products save cart data if addon is present for any line item
	INSERT INTO #NewGroupSavecartLineitemDetails
	SELECT  Min(RowId )RowId ,OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity, @OrderLineItemRelationshipTypeIdAddon, CustomText, CartAddOnDetails, Sequence
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,min(Description)Description	,1 Id 
		,CASE WHEN ConfigurableProductIds <> ''  THEN ConfigurableProductIds
			WHEN  GroupProductIds <> '' THEN GroupProductIds 
			WHEN BundleProductIds <> '' THEN BundleProductIds 
			ELSE SKU END     ParentSKU ,CustomUnitPrice
	FROM @SaveCartLineItemType  a 
	WHERE AddOnValueIds <> ''
	GROUP BY  OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OmsSavedCartId, AddOnValueIds
		,AddOnQuantity,  CustomText, CartAddOnDetails, Sequence ,ConfigurableProductIds,GroupProductIds,	BundleProductIds
		,AutoAddon, OmsOrderId, ItemDetails,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId,ProductName,SKU,CustomUnitPrice
		 

	CREATE TABLE #OldGroupSavecartLineitemDetails (OmsSavedCartId INT ,OmsSavedCartLineItemId INT,ParentOmsSavedCartLineItemId INT , SKU  NVARCHAr(2000),OrderLineItemRelationshipTypeID INT  )
	--Getting the old group save cart data if present for same SKU in the new save cart data for group product	 	 
	INSERT INTO #OldGroupSavecartLineitemDetails  
	SELECT  a.OmsSavedCartId,a.OmsSavedCartLineItemId,a.ParentOmsSavedCartLineItemId , a.SKU  ,a.OrderLineItemRelationshipTypeID 
	FROM ZnodeOmsSavedCartLineItem a with (nolock)  
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = a.OmsSavedCartId AND ISNULL(a.SKU,'') = ISNULL(TY.GroupProductIds,'')   )   
		AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup   

	--Getting the old save cart Parent data
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT DISTINCT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.ParentOmsSavedCartLineItemId  = b.OmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.SKU,'') AND ISNULL(b.Groupid,'-') = ISNULL(TY.Groupid,'-')  )
		AND  b.OrderLineItemRelationshipTypeID IS NULL 

	------Merge Addon for same product
	SELECT * INTO #OldValueForAddon FROM #OldGroupSavecartLineitemDetails

	DELETE a FROM #OldGroupSavecartLineitemDetails a WHERE NOT EXISTS (SELECT TOP 1 1  FROM #OldGroupSavecartLineitemDetails b WHERE b.ParentOmsSavedCartLineItemId IS NULL AND b.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId)
	AND a.ParentOmsSavedCartLineItemId IS NOT NULL 

	--Getting the old config product save cart addon data for old line items if present
	INSERT INTO #OldGroupSavecartLineitemDetails 
	SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
	FROM ZnodeOmsSavedCartLineItem b with (nolock)
	INNER JOIN #OldGroupSavecartLineitemDetails c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
	WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

	------Merge Addon for same product
	IF EXISTS(SELECT * FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'') <> '' )
	BEGIN
		INSERT INTO #OldValueForAddon 
		SELECT b.OmsSavedCartId,b.OmsSavedCartLineItemId,b.ParentOmsSavedCartLineItemId , b.SKU  ,b.OrderLineItemRelationshipTypeID  
		FROM ZnodeOmsSavedCartLineItem b 
		INNER JOIN #OldValueForAddon c ON (c.OmsSavedCartLineItemId  = b.ParentOmsSavedCartLineItemId AND c.OmsSavedCartId = b.OmsSavedCartId)
		WHERE EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType  TY WHERE TY.OmsSavedCartId = b.OmsSavedCartId )--AND ISNULL(b.SKU,'') = ISNULL(TY.AddOnValueIds,'') )
		AND  b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon

		SELECT distinct SKU, STUFF(
								( SELECT  ', ' + SKU FROM    
									( SELECT DISTINCT SKU FROM     #OldValueForAddon b 
										where a.OmsSavedCartLineItemId=b.ParentOmsSavedCartLineItemId and OrderLineItemRelationshipTypeID = 1 ) x 
										FOR XML PATH('')
								), 1, 2, ''
								) AddOns
		INTO #AddOnsExists
		FROM #OldValueForAddon a where a.ParentOmsSavedCartLineItemId is not null and OrderLineItemRelationshipTypeID<>1

		SELECT DISTINCT a.GroupProductIds SKU, STUFF(
									( SELECT  ', ' + x.AddOnValueIds FROM    
									( SELECT DISTINCT b.AddOnValueIds FROM @SaveCartLineItemType b
										where a.SKU=b.SKU ) x
										FOR XML PATH('')
									), 1, 2, ''
								) AddOns
		INTO #AddOnAdded
		FROM @SaveCartLineItemType a

		IF NOT EXISTS(SELECT * FROM #AddOnsExists a INNER JOIN #AddOnAdded b on a.SKU = b.SKU and a.AddOns = b.AddOns )
		BEGIN
			DELETE FROM #OldGroupSavecartLineitemDetails
		END
	END

	--If addon present in new and old save cart data and not matches the addon data (old and new for merge) then removing the old save cart data FROM #OldSavecartLineitemDetails
	IF NOT EXISTS (SELECT TOP 1 1  FROM @SaveCartLineItemType ty WHERE EXISTS (SELECT TOP 1 1 FROM 	#OldGroupSavecartLineitemDetails a WHERE	
		ISNULL(TY.AddOnValueIds,'') = a.SKU AND  a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ))
		AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
	BEGIN
		DELETE FROM #OldGroupSavecartLineitemDetails 
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  <> '' )
		BEGIN
			DECLARE @parenTofAddon  TABLE( ParentOmsSavedCartLineItemId INT  )  
			INSERT INTO  @parenTofAddon 
			SELECT  ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails a
			WHERE a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
			AND (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem  t with (nolock) WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId AND   t.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) = (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		  
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId NOT IN (SELECT ParentOmsSavedCartLineItemId FROM  @parenTofAddon)   
				AND ParentOmsSavedCartLineItemId IS NOT NULL  
				AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon

			 DELETE 
			 FROM #OldGroupSavecartLineitemDetails 
			 WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS  NULL  

			IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSavecartLineitemDetails
			END 
			IF (SELECT COUNT (DISTINCT SKU ) FROM  ZnodeOmsSavedCartLineItem with (nolock)  WHERE ParentOmsSavedCartLineItemId IN (SELECT ParentOmsSavedCartLineItemId FROM @parenTofAddon)AND   OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
			BEGIN 
				DELETE FROM #OldGroupSavecartLineitemDetails
			END
		END 
		ELSE IF (SELECT COUNT (OmsSavedCartLineItemId) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS NULL ) > 1 
		BEGIN 
			-- SELECT 3
		    DECLARE @TBL_deleteParentOmsSavedCartLineItemId TABLE (OmsSavedCartLineItemId INT )
			INSERT INTO @TBL_deleteParentOmsSavedCartLineItemId 
			SELECT ParentOmsSavedCartLineItemId
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup  )
				AND OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon 

			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
				OR ParentOmsSavedCartLineItemId IN (SELECT OmsSavedCartLineItemId FROM @TBL_deleteParentOmsSavedCartLineItemId)
		    
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId NOT IN (SELECT ISNULL(m.ParentOmsSavedCartLineItemId,0) FROM #OldGroupSavecartLineitemDetails m)
				AND ParentOmsSavedCartLineItemId IS NULL
		END
		ELSE IF (SELECT COUNT (DISTINCT SKU ) FROM  #OldGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon ) <> (SELECT COUNT (DISTINCT SKU ) FROM  #NewGroupSavecartLineitemDetails  WHERE OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  )
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails
		END 
		ELSE IF  EXISTS (SELECT TOP 1 1 FROM ZnodeOmsSavedCartLineItem Wt WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails ty WHERE ty.OmsSavedCartId = wt.OmsSavedCartId AND ty.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdGroup AND wt.ParentOmsSavedCartLineItemId= ty.OmsSavedCartLineItemId  ) AND wt.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon)
			AND EXISTS (SELECT TOP 1 1 FROM @SaveCartLineItemType WHERE ISNULL(AddOnValueIds,'')  = '' )
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails
		END  
	END

	DECLARE @TBL_Personaloldvalues TABLE (OmsSavedCartLineItemId INT , PersonalizeCode NVARCHAr(max), PersonalizeValue NVARCHAr(max))
	--Getting the personalise data for old save cart if present	
	INSERT INTO @TBL_Personaloldvalues
	SELECT OmsSavedCartLineItemId , PersonalizeCode, PersonalizeValue
	FROM ZnodeOmsPersonalizeCartItem  a 
	WHERE EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails TY WHERE TY.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise TU WHERE TU.PersonalizeCode = a.PersonalizeCode AND TU.PersonalizeValue = a.PersonalizeValue)
		
	IF  NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise )
	BEGIN
		DELETE FROM #OldGroupSavecartLineitemDetails
	END 
	ELSE 
	BEGIN 
		IF EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
		AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
		BEGIN 
			DELETE 
			FROM #OldGroupSavecartLineitemDetails 
			WHERE OmsSavedCartLineItemId IN (
				SELECT OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues)) 
				OR OmsSavedCartLineItemId IN ( SELECT ParentOmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails WHERE OmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues )
				AND ParentOmsSavedCartLineItemId NOT IN (SELECT OmsSavedCartLineItemId FROM @TBL_Personaloldvalues))
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1 FROM @TBL_Personaloldvalues)
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) > 1 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) <>
				(SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM ZnodeOmsSavedCartLineItem WHERE ParentOmsSavedCartLineItemId IS nULL and OmsSavedCartLineItemId in (select OmsSavedCartLineItemId FROM #OldGroupSavecartLineitemDetails)  )
		BEGIN
			DELETE n 
			FROM #OldGroupSavecartLineitemDetails n 
			WHERE OmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem WHERE n.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId  )
			OR ParentOmsSavedCartLineItemId  IN (SELECT OmsSavedCartLineItemId FROM ZnodeOmsPersonalizeCartItem   )
		END 
		ELSE IF NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
			AND EXISTS (SELECT TOP 1 1 FROM ZnodeOmsPersonalizeCartItem m WHERE EXISTS (SELECT Top 1 1 FROM #OldGroupSavecartLineitemDetails YU WHERE YU.OmsSavedCartLineItemId = m.OmsSavedCartLineItemId )) 
			AND (SELECT COUNT (DISTINCT OmsSavedCartLineItemId ) FROM #OldGroupSavecartLineitemDetails WHERE ParentOmsSavedCartLineItemId IS nULL ) = 1
		BEGIN 
			DELETE FROM #OldGroupSavecartLineitemDetails WHERE NOT EXISTS (SELECT TOP 1 1  FROM @TBL_Personalise)
		END 
	END
	
	IF EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails)
	BEGIN
		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU not having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*
			FROM @SaveCartLineItemType a 
					INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU or a.SKU = b.sku)
					where isnull(cast(a.PersonalisedAttribute AS varchar(max)),'') = ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		----DELETE old value FROM table which having personalise data in ZnodeOmsPersonalizeCartItem but same SKU having personalise value for new cart item
		;WITH cte AS
		(
			select distinct b.*, 
			a.PersonalizeCode
			,a.PersonalizeValue
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on ( a.GroupProductIds = b.SKU)
			where isnull(a.PersonalizeValue,'') <> ''
		)
		,cte2 AS
		(
			select a.ParentOmsSavedCartLineItemId, b.PersonalizeCode, b.PersonalizeValue
			FROM #OldGroupSavecartLineitemDetails a
			INNER JOIN ZnodeOmsPersonalizeCartItem b on b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId
			WHERE NOT EXISTS(SELECT * FROM cte c where b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and b.PersonalizeCode = c.PersonalizeCode 
								and b.PersonalizeValue = c.PersonalizeValue )
		)
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		INNER JOIN cte b on a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		INNER JOIN cte2 c on (a.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or a.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId)

		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,b.ParentOmsSavedCartLineItemId , a.GroupProductIds
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE b1
		FROM #OldGroupSavecartLineitemDetails b1 
		WHERE NOT EXISTS(SELECT * FROM cte c where (b1.OmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId or b1.ParentOmsSavedCartLineItemId = c.ParentOmsSavedCartLineItemId))
		AND EXISTS(SELECT * FROM cte)

		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is different for same line item then New lineItem will generate
		--------If lineitem present in ZnodeOmsPersonalizeCartItem and personalize value is same for same line item then Quantity will added
		;WITH cte AS
		(
			SELECT b.OmsSavedCartLineItemId ,a.ParentOmsSavedCartLineItemId , a.GroupProductIds AS SKU
					,a.PersonalizeCode
			  		,a.PersonalizeValue
					,a.DesignId
					,a.ThumbnailURL
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b on a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c on b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
			WHERE a.OmsSavedCartLineItemId = 0
		)
		DELETE c1
		FROM cte a1		  
		INNER JOIN #OldGroupSavecartLineitemDetails b1 on a1.SKU = b1.SKU
		INNER JOIN #OldGroupSavecartLineitemDetails c1 on (b1.ParentOmsSavedCartLineItemId = c1.OmsSavedCartLineItemId OR b1.OmsSavedCartLineItemId = c1.OmsSavedCartLineItemId)
		WHERE NOT EXISTS(SELECT * FROM ZnodeOmsPersonalizeCartItem c where a1.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId and a1.PersonalizeValue = c.PersonalizeValue)
		-----Delete old save cart with multiple personalize data 
		;WITH CTE_OldPersonalizeCodeCount as
		(
			SELECT b.OmsSavedCartLineItemId ,b.SKU,count(distinct c.PersonalizeCode) as CntPersonalizeCode				
			FROM @TBL_Personalise a 
			INNER JOIN #OldGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			INNER JOIN ZnodeOmsPersonalizeCartItem c ON b.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId 
				--and a.PersonalizeCode = c.PersonalizeCode
			WHERE isnull(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY b.OmsSavedCartLineItemId ,b.SKU
		)
		,CTE_NewPersonalizeCodeCount as
		(
			SELECT isnull(a.OmsSavedCartLineItemId,0) as OmsSavedCartLineItemId,b.SKU,count(a.PersonalizeCode) as CntPersonalizeCode
			FROM @TBL_Personalise a 
			INNER JOIN #NewGroupSavecartLineitemDetails b ON a.GroupProductIds = b.SKU
			WHERE ISNULL(a.OmsSavedCartLineItemId,0) = 0
			GROUP BY a.OmsSavedCartLineItemId ,b.SKU
		)
		DELETE c
		from CTE_OldPersonalizeCodeCount a
		INNER JOIN CTE_NewPersonalizeCodeCount b on a.SKU = b.SKU and a.CntPersonalizeCode <> b.CntPersonalizeCode
		INNER JOIN #OldGroupSavecartLineitemDetails c on b.SKU = c.SKU and a.OmsSavedCartLineItemId = c.OmsSavedCartLineItemId
		
		--Delete parent entry if child not present
		DELETE a FROM #OldGroupSavecartLineitemDetails a
		WHERE NOT EXISTS(SELECT * FROM #OldGroupSavecartLineitemDetails b where a.OmsSavedCartLineItemId = b.ParentOmsSavedCartLineItemId)
		AND a.ParentOmsSavedCartLineItemId IS NULL

		--Updating the cart if old and new cart data matches
		UPDATE a
		SET a.Quantity = a.Quantity+ty.Quantity,
			a.Custom1 = ty.Custom1,
			a.Custom2 = ty.Custom2,
			a.Custom3 = ty.Custom3,
			a.Custom4 = ty.Custom4,
			a.Custom5 = ty.Custom5,
			a.ModifiedDate = @GetDate ,
			a.CustomUnitPrice = ty.CustomUnitPrice
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN #NewGroupSavecartLineitemDetails ty ON (ty.SKU = b.SKU)
		WHERE a.OrderLineItemRelationshipTypeId <> @OrderLineItemRelationshipTypeIdAddon

		UPDATE a
		SET a.Quantity = a.Quantity+s.AddOnQuantity,
			a.ModifiedDate = @GetDate
		FROM ZnodeOmsSavedCartLineItem a
		INNER JOIN #OldGroupSavecartLineitemDetails b ON (a.ParentOmsSavedCartLineItemId = b.OmsSavedCartLineItemId)
		INNER JOIN @SaveCartLineItemType S on a.OmsSavedCartId = s.OmsSavedCartId and a.SKU = s.AddOnValueIds
		WHERE a.OrderLineItemRelationshipTypeId = @OrderLineItemRelationshipTypeIdAddon
	END

	--Added condition to add new product which is coming with existing product.
	IF OBJECT_ID('tempdb..#NewRowId') IS NOT NULL
		DROP TABLE #NewRowId;

	SELECT N.RowId
	INTO #NewRowId
	FROM #NewGroupSavecartLineitemDetails N
	LEFT JOIN #OldGroupSavecartLineitemDetails O ON N.OmsSavedCartId=O.OmsSavedCartId AND N.SKU=O.SKU
	WHERE O.SKU IS NULL

	--Inserting the new save cart data if old and new cart data not match
	IF NOT EXISTS (SELECT TOP 1 1 FROM #OldGroupSavecartLineitemDetails)
		OR EXISTS (SELECT TOP 1 1 FROM #NewRowId) --Added condition to add new product which is coming with existing product.
	BEGIN
		SELECT RowId, Id ,Row_number()Over(ORDER BY RowId, Id,GenId) NewRowId , ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewId() ) Sequence ,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,min(Description)Description  ,ParentSKU ,CustomUnitPrice 
		INTO #InsertNewGroupSavecartLineitem   
		FROM #NewGroupSavecartLineitemDetails
		WHERE RowId IN (SELECT RowId FROM #NewRowId) OR ParentSKU IS NULL
		GROUP BY ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
		   ,CustomText,CartAddOnDetails ,AutoAddon  
		   ,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,RowId, Id ,GenId,ParentSKU, CustomUnitPrice
		ORDER BY RowId, Id

		--Removing the line item having Quantity <=0 
		DELETE 
		FROM #InsertNewGroupSavecartLineitem
		WHERE Quantity <=0
  
		--Updating the rowid into new save cart line item as new line item is merged into existing save cart item
		;WITH VTTY AS
		(
			SELECT m.RowId OldRowId , TY1.RowId , TY1.SKU
			FROM #InsertNewGroupSavecartLineitem m
			INNER JOIN  #InsertNewGroupSavecartLineitem TY1 ON TY1.SKU = m.ParentSKU
			WHERE m.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
		)
		UPDATE m1   
		SET m1.RowId = TYU.RowId
		FROM #InsertNewGroupSavecartLineitem m1   
		INNER JOIN VTTY TYU ON (TYU.OldRowId = m1.RowId)  

		;WITH VTRET AS   
		(
			SELECT RowId,id,Min(NewRowId)NewRowId ,SKU ,ParentSKU, OrderLineItemRelationshipTypeId 
			FROM #InsertNewGroupSavecartLineitem   
			GROUP BY RowId,id ,SKU ,ParentSKU  ,OrderLineItemRelationshipTypeId
			HAVING SKU = ParentSKU AND OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		)
		DELETE 
		FROM #InsertNewGroupSavecartLineitem 
		WHERE NewRowId  IN (SELECT NewRowId FROM VTRET)   
     
		--Inserting the new cart line item if not merged in existing save cart line item
		INSERT INTO  ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,Sequence,CreatedBY,CreatedDate,ModifiedBy ,ModifiedDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description,CustomUnitPrice)  
		OUTPUT INSERTED.SKU,INSERTED.OmsSavedCartLineItemId  INTO @OmsInsertedData 
		SELECT NULL ,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId  
			,CustomText,CartAddOnDetails,ROW_NUMBER()Over(ORDER BY NewRowId)  sequence,@UserId,@GetDate,@UserId,@GetDate,AutoAddon  
			,OmsOrderId,Custom1,Custom2,Custom3 ,Custom4 ,Custom5,GroupId,ProductName ,Description, CustomUnitPrice
		FROM  #InsertNewGroupSavecartLineitem  TH  

		SELECT  MAX(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId 
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU 
		INTO  #Cte_newData
		FROM ZnodeOmsSavedCartLineItem a  with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon  
			AND a.ParentOmsSavedCartLineItemId IS nULL   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
  
		-----------------------------------------------------------------------------------------------------------------------------------

		SELECT  MIN(a.OmsSavedCartLineItemId ) OmsSavedCartLineItemId
			,b.RowId ,b.GroupId ,b.SKU ,b.ParentSKU
		INTO #Cte_newData1
		FROM ZnodeOmsSavedCartLineItem a with (nolock)
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ISNULL(b.GroupId,'-') = ISNULL(a.GroupId,'-')  )  
		WHERE ISNULL(a.ParentOmsSavedCartLineItemId,0) =0  
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
				AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon
		 GROUP BY b.RowId ,b.GroupId ,b.SKU	,b.ParentSKU,b.OrderLineItemRelationshipTypeID	  

		UPDATE a SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 OmsSavedCartLineItemId FROM  #Cte_newData1  r  
		WHERE  r.RowId = b.RowId AND ISNULL(r.GroupId,'-') = ISNULL(a.GroupId,'-')  ORDER BY b.RowId )   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =1  )   
		WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
			AND b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon   
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
			AND  a.sequence in (SELECT  MIN(ab.sequence) FROM ZnodeOmsSavedCartLineItem ab where a.OmsSavedCartId = ab.OmsSavedCartId and 
				a.SKU = ab.sku and ab.OrderLineItemRelationshipTypeId is not null  ) 

		----------------------------------------------------------------------------------------------------------------------------

		SELECT DISTINCT a.OmsSavedCartLineItemId , b.RowId  ,b.SKU ,b.ParentSKU  ,Row_number()Over(ORDER BY c.OmsSavedCartLineItemId )RowIdNo
		INTO #Cte_newAddon
		FROM ZnodeOmsSavedCartLineItem a with (nolock) 
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.ParentSKU AND ( b.Id = 1  ))  
		INNER JOIN ZnodeOmsSavedCartLineItem c with (nolock) on b.sku = c.sku and b.OmsSavedCartId=c.OmsSavedCartId and b.Id = 1
		WHERE ( ISNULL(a.ParentOmsSavedCartLineItemId,0) <> 0   )
			AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon
			AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
			AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId ) and c.ParentOmsSavedCartLineItemId is null

		---- Added to get distinct records.
		--SELECT *,ROW_NUMBER()OVER(ORDER BY OmsSavedCartLineItemId) RowIdNo 
		--INTO #Cte_newAddon 
		--FROM #Cte_newAddon1

		;WITH table_update AS 
		(
			SELECT * , ROW_NUMBER()Over(ORDER BY OmsSavedCartLineItemId  ) RowIdNo
			FROM ZnodeOmsSavedCartLineItem a with (nolock)
			WHERE a.OrderLineItemRelationshipTypeId IS NOT NULL   
				AND a.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon  
				AND a.ParentOmsSavedCartLineItemId IS NULL  
				AND EXISTS (SELECT TOP 1 1  FROM  #InsertNewGroupSavecartLineitem ty WHERE ty.OmsSavedCartId = a.OmsSavedCartId )
				AND EXISTS (SELECT TOP 1 1  FROM @OmsInsertedData ui WHERE ui.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId )
		)
		UPDATE a 
		SET a.ParentOmsSavedCartLineItemId = (SELECT TOP 1 max(OmsSavedCartLineItemId) 
		FROM #Cte_newAddon  r  
		WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )   
		FROM table_update a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.OrderLineItemRelationshipTypeID = @OrderLineItemRelationshipTypeIdAddon AND  b.id =1 )   
		WHERE (SELECT TOP 1 max(OmsSavedCartLineItemId)  FROM #Cte_newAddon  r  
			WHERE  r.ParentSKU = b.ParentSKU AND a.SKU = r.SKU AND a.RowIdNo = r.RowIdNo  GROUP BY r.ParentSKU, r.SKU  )    IS nOT NULL 

		;WITH Cte_Th AS   
		(             
			SELECT RowId    
			FROM #InsertNewGroupSavecartLineitem a   
			GROUP BY RowId   
			HAVING COUNT(NewRowId) <= 1   
		 )
		UPDATE a 
		SET a.Quantity =  NULL,
			a.ModifiedDate = @GetDate   
		FROM ZnodeOmsSavedCartLineItem a  
		INNER JOIN #InsertNewGroupSavecartLineitem b ON (a.OmsSavedCartId = b.OmsSavedCartId AND a.SKU = b.SKU AND b.id =0)   
		WHERE NOT EXISTS (SELECT TOP 1 1  FROM Cte_Th TY WHERE TY.RowId = b.RowId )  
		 AND a.OrderLineItemRelationshipTypeId IS NULL   
  
		UPDATE  ZnodeOmsSavedCartLineItem   
		SET GROUPID = NULL   
		WHERE  EXISTS (SELECT TOP 1 1  FROM #InsertNewGroupSavecartLineitem RT WHERE RT.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
			AND OrderLineItemRelationshipTypeId IS NOT NULL     
       
	   ;WITH Cte_UpdateSequence AS   
		(  
			SELECT OmsSavedCartLineItemId ,Row_Number()Over(ORDER BY OmsSavedCartLineItemId) RowId , Sequence   
			FROM ZnodeOmsSavedCartLineItem with (nolock)  
			WHERE EXISTS (SELECT TOP 1 1 FROM #InsertNewGroupSavecartLineitem TH WHERE TH.OmsSavedCartId = ZnodeOmsSavedCartLineItem.OmsSavedCartId )  
		)   
		UPDATE Cte_UpdateSequence  
		SET Sequence = RowId  
			
		UPDATE @TBL_Personalise
		SET OmsSavedCartLineItemId = b.OmsSavedCartLineItemId
		FROM @OmsInsertedData a 
		INNER JOIN @TBL_Personalise c ON a.SKU = c.GroupProductIds
		INNER JOIN ZnodeOmsSavedCartLineItem b WITH (NOLOCK) ON (a.OmsSavedCartLineItemId = b.OmsSavedCartLineItemId and b.OrderLineItemRelationshipTypeID <> @OrderLineItemRelationshipTypeIdAddon)
		WHERE b.ParentOmsSavedCartLineItemId IS NOT NULL  

		DELETE FROM ZnodeOmsPersonalizeCartItem	WHERE EXISTS (SELECT TOP 1 1 FROM @TBL_Personalise yu WHERE yu.OmsSavedCartLineItemId = ZnodeOmsPersonalizeCartItem.OmsSavedCartLineItemId )
			
		----Inserting saved cart item personalise value FROM given line item
		MERGE INTO ZnodeOmsPersonalizeCartItem TARGET 
		USING @TBL_Personalise SOURCE
			   ON (TARGET.OmsSavedCartLineItemId = SOURCE.OmsSavedCartLineItemId ) 
			   WHEN NOT MATCHED THEN 
				INSERT  ( OmsSavedCartLineItemId,  CreatedBy, CreatedDate, ModifiedBy, ModifiedDate
								,PersonalizeCode, PersonalizeValue,DesignId	,ThumbnailURL )
				VALUES (  SOURCE.OmsSavedCartLineItemId,  @userId, @getdate, @userId, @getdate
								,SOURCE.PersonalizeCode, SOURCE.PersonalizeValue,SOURCE.DesignId	,SOURCE.ThumbnailURL ) ;
	END 

	END TRY
	BEGIN CATCH 
		SELECT ERROR_MESSAGE()
	END CATCH 
END

GO

update ZnodeApplicationSetting 
set Setting = '<?xml version="1.0" encoding="UTF-8"?><columns><column><id>1</id><name>PimDownloadableProductKeyId</name><headertext>Checkbox</headertext><width>40</width><datatype>String</datatype><columntype>Int32</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format /><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield /><ischeckbox>y</ischeckbox><checkboxparamfield /><iscontrol>n</iscontrol><controltype /><controlparamfield /><displaytext>ID</displaytext><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class /><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>2</id><name>SKU</name><headertext>SKU</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format /><isvisible>n</isvisible><mustshow>n</mustshow><musthide>y</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield>ProductId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>ProductId</checkboxparamfield><iscontrol>n</iscontrol><controltype /><controlparamfield /><displaytext>Code</displaytext><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class /><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>3</id><name>DownloadableProductKey</name><headertext>Product Key</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format /><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>150</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield>ProductId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>ProductId</checkboxparamfield><iscontrol>y</iscontrol><controltype>Text</controltype><controlparamfield /><displaytext /><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class /><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>4</id><name>DownloadableProductURL</name><headertext>Download URL</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format /><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>150</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield>ProductId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>ProductId</checkboxparamfield><iscontrol>y</iscontrol><controltype>Text</controltype><controlparamfield /><displaytext /><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class /><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>5</id><name>IsUsed</name><headertext>Is Used</headertext><width>40</width><datatype>Boolean</datatype><columntype>Boolean</columntype><allowsorting>true</allowsorting><allowpaging>true</allowpaging><format /><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>y</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield>LocaleId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield /><iscontrol>n</iscontrol><controltype /><controlparamfield /><displaytext /><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl /><manageparamfield /><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>n</isadvancesearch><Class>z-isused</Class><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column><column><id>6</id><name>Manage</name><headertext>Action</headertext><width>50</width><datatype>String</datatype><columntype>String</columntype><allowsorting>false</allowsorting><allowpaging>true</allowpaging><format>Edit|Delete</format><isvisible>y</isvisible><mustshow>y</mustshow><musthide>n</musthide><maxlength>0</maxlength><isallowsearch>n</isallowsearch><isconditional>n</isconditional><isallowlink>n</isallowlink><islinkactionurl /><islinkparamfield>productId</islinkparamfield><ischeckbox>n</ischeckbox><checkboxparamfield>Id</checkboxparamfield><iscontrol>n</iscontrol><controltype /><controlparamfield /><displaytext>Edit|Delete</displaytext><editactionurl /><editparamfield /><deleteactionurl /><deleteparamfield /><viewactionurl /><viewparamfield /><imageactionurl /><imageparamfield /><manageactionurl>/Inventory/UpdateDownloadableProductKey|/Inventory/DeleteDownloadableProductKeys</manageactionurl><manageparamfield>PimDownloadableProductKeyId|PimDownloadableProductKeyId</manageparamfield><copyactionurl /><copyparamfield /><xaxis>n</xaxis><yaxis>n</yaxis><isadvancesearch>y</isadvancesearch><Class /><SearchControlType>--Select--</SearchControlType><SearchControlParameters /><DbParamField /><useMode>DataBase</useMode><IsGraph>n</IsGraph><allowdetailview>n</allowdetailview></column></columns>'
where ItemName = 'ZnodePimDownloadableProductKeyForInventory'

GO

insert into ZnodePortalFeature(PortalFeatureName,	CreatedBy,	CreatedDate	,ModifiedBy,	ModifiedDate)
select 'Enable_Save_For_Later',	2,	getdate(),	2	,getdate()
where not exists(select * from ZnodePortalFeature where PortalFeatureName = 'Enable_Save_For_Later')

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_ImportSynonyms')
	DROP PROC Znode_ImportSynonyms
GO

CREATE PROCEDURE [dbo].[Znode_ImportSynonyms]
(
	@TableName nvarchar(100), 
	@Status bit OUT, 
	@UserId int, 
	@ImportProcessLogId int, 
	@NewGUId nvarchar(200)
)
AS
--------------------------------------------------------------------------------------
-- Summary :  This procedure is used to import the synonyms
	
-- Unit Testing: 

--------------------------------------------------------------------------------------
BEGIN
BEGIN TRAN A;
BEGIN TRY
	DECLARE @SSQL nvarchar(max);
	DECLARE @GetDate datetime= dbo.Fn_GetDate(), @LocaleId int  ;
	SELECT @LocaleId = DBO.Fn_GetDefaultLocaleId();

	DECLARE @InsertSearchSynonyms TABLE
	( 
		RowId int IDENTITY(1, 1) PRIMARY KEY, RowNumber int, CatalogCode varchar(max), SynonymCode varchar(max), RenameSynonymCode varchar(max), OriginalTerm varchar(max), ReplacedBy varchar(max),IsBidirectional varchar(100), GUID nvarchar(400)		
	);
	
	SET @SSQL = 'Select RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID FROM '+@TableName;
	INSERT INTO @InsertSearchSynonyms( RowNumber,CatalogCode,SynonymCode,RenameSynonymCode,OriginalTerm,ReplacedBy,IsBidirectional ,GUID)
	EXEC sys.sp_sqlexec @SSQL;

	--Getting existing catalog
	DECLARE @CatalogCode TABLE
	( 
		CatalogCode nvarchar(100), PublishCatalogId INT
	);
	INSERT INTO @CatalogCode
	SELECT CatalogCode,PublishCatalogId
	FROM ZnodePimCatalog a
	INNER JOIN ZnodePublishCatalog b on a.PimCatalogId = b.PimCatalogId

	-- Start Functional Validation on columns
	-----------------------------------------------
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '95', 'CatalogCode', CatalogCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE not exists(select * from @CatalogCode c where ii.CatalogCode = isnull(c.CatalogCode,'')) AND ISNULL(ii.RenameSynonymCode,'') = '' 

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.SynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.SynonymCode,'') LIKE '%[^a-zA-Z0-9]%')

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ii.SynonymCode) > 100 AND isnull(ii.SynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '96', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.RenameSynonymCode) AND ISNULL(ii.RenameSynonymCode,'') <> ''
	AND exists(select * from ZnodeSearchSynonyms i where i.SynonymCode = ii.SynonymCode)

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE len(ltrim(rtrim(ii.RenameSynonymCode))) > 100 AND ISNULL(ii.RenameSynonymCode,'') <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '79', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE (isnull(ii.RenameSynonymCode,'') LIKE '%[^a-zA-Z0-9]%') and isnull(ii.RenameSynonymCode,'') <> ''
		
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.OriginalTerm,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'OriginalTerm - '+Case when LEN(i.Item) >100 then i.Item else '' end, OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'OriginalTerm', OriginalTerm, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(OriginalTerm,'|') i
	WHERE isnull(ii.OriginalTerm,'') <> ''
	GROUP BY SynonymCode, OriginalTerm, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.ReplacedBy,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '78', 'ReplacedBy - '+Case when LEN(i.Item) >100 then i.Item else '' end, ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> '' AND LEN(i.Item) > 100

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '97', 'ReplacedBy', ReplacedBy, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	CROSS APPLY DBO.Split(ReplacedBy,'|') i
	WHERE isnull(ii.ReplacedBy,'') <> ''
	GROUP BY SynonymCode, ReplacedBy, RowNumber
	HAVING COUNT(i.Item) > 20

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '84', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE isnull(ii.IsBidirectional,'') = '' AND ISNULL(ii.RenameSynonymCode,'') = ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '68', 'IsBidirectional', IsBidirectional, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
	WHERE ii.IsBidirectional not in ('1','0','True','False','Yes','No') AND ii.IsBidirectional <> ''

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '53', 'SynonymCode', SynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
			   WHERE ii.SynonymCode IN
			   (
				   select SynonymCode from @InsertSearchSynonyms
					group by SynonymCode
					having count(1)>1
			   );

	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, RowNumber, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '53', 'RenameSynonymCode', RenameSynonymCode, @NewGUId, RowNumber, 2, @GetDate, 2, @GetDate, @ImportProcessLogId
	FROM @InsertSearchSynonyms AS ii
			   WHERE ii.RenameSynonymCode IN
			   (
				   select RenameSynonymCode from @InsertSearchSynonyms
					group by RenameSynonymCode
					having count(1)>1
			   ) AND ISNULL(ii.RenameSynonymCode,'') <> ''

	UPDATE ZIL
	SET ZIL.ColumnName =   ZIL.ColumnName + ' [ Synonym - ' + ISNULL(SynonymCode,'') + ' ] '
	FROM ZnodeImportLog ZIL 
	INNER JOIN @InsertSearchSynonyms IPA ON (ZIL.RowNumber = IPA.RowNumber)
	WHERE  ZIL.ImportProcessLogId = @ImportProcessLogId AND ZIL.RowNumber IS NOT NULL

	-- End Function Validation 	
	-----------------------------------------------
	-- Delete Invalid Data after functional validatin  
	DELETE FROM @InsertSearchSynonyms
	WHERE RowNumber IN
	(
	SELECT DISTINCT 
	RowNumber
	FROM ZnodeImportLog
	WHERE ImportProcessLogId = @ImportProcessLogId  and RowNumber is not null 
	);
		
	-- Update Record count in log 
	DECLARE @FailedRecordCount BIGINT
	DECLARE @SuccessRecordCount BIGINT
	SELECT @FailedRecordCount = COUNT(DISTINCT RowNumber) FROM ZnodeImportLog WHERE RowNumber IS NOT NULL AND  ImportProcessLogId = @ImportProcessLogId;
	Select @SuccessRecordCount = count(DISTINCT RowNumber) FROM @InsertSearchSynonyms
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = @FailedRecordCount , SuccessRecordCount = @SuccessRecordCount ,
	TotalProcessedRecords = (ISNULL(@FailedRecordCount,0) + ISNULL(@SuccessRecordCount,0)) 
	WHERE ImportProcessLogId = @ImportProcessLogId;

	--Update existing search synonym 
	UPDATE ZSS 
	SET ZSS.SynonymCode = CASE WHEN ISNULL(IPS.RenameSynonymCode,'') <> '' THEN IPS.RenameSynonymCode ELSE ZSS.SynonymCode END , ZSS.OriginalTerm = CASE WHEN ISNULL(IPS.OriginalTerm,'') = '' THEN ZSS.OriginalTerm ELSE IPS.OriginalTerm END,
	ZSS.ReplacedBy =CASE WHEN ISNULL(IPS.ReplacedBy,'') = '' THEN ZSS.ReplacedBy ELSE IPS.ReplacedBy END,
	ZSS.IsBidirectional= CASE WHEN ISNULL (IPS.IsBidirectional,'') = '' THEN ZSS.IsBidirectional ELSE CASE WHEN IPS.IsBidirectional = 'YES' THEN '1' WHEN IPS.IsBidirectional = 'NO' THEN '0' ELSE IPS.IsBidirectional END END,
	ZSS.ModifiedBy = @UserId, ZSS.ModifiedDate = @GetDate
	FROM ZnodeSearchSynonyms ZSS
	INNER JOIN @InsertSearchSynonyms IPS ON ZSS.SynonymCode = IPS.SynonymCode
		
	--- Insert data into base table ZnodeSearchSynonyms
	INSERT INTO ZnodeSearchSynonyms (PublishCatalogId,OriginalTerm,ReplacedBy,IsBidirectional,LocaleId,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SynonymCode)
	SELECT B.PublishCatalogId, A.OriginalTerm, A.ReplacedBy, CASE WHEN A.IsBidirectional = 'YES' THEN '1' WHEN A.IsBidirectional = 'NO' THEN '0' ELSE A.IsBidirectional END, @LocaleId,@UserId,@GetDate,@UserId,@GetDate,a.SynonymCode
	FROM @InsertSearchSynonyms A
	INNER JOIN @CatalogCode B ON A.CatalogCode = B.CatalogCode
	WHERE NOT EXISTS(SELECT * FROM ZnodeSearchSynonyms ZSS WHERE A.SynonymCode = ZSS.SynonymCode OR (A.RenameSynonymCode = ZSS.SynonymCode))
		
	
	--Updating the import process status
	UPDATE ZnodeImportProcessLog
	SET Status = CASE WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 4 )
			WHEN ISNULL(@FailedRecordCount,0) = 0 AND ISNULL(@SuccessRecordCount,0) > 0 THEN dbo.Fn_GetImportStatus( 2 )
			WHEN ISNULL(@FailedRecordCount,0) > 0 AND ISNULL(@SuccessRecordCount,0) = 0 THEN dbo.Fn_GetImportStatus( 3 )
		END, 
	ProcessCompletedDate = getdate()
	WHERE ImportProcessLogId = @ImportProcessLogId;

COMMIT TRAN A;
END TRY
BEGIN CATCH
ROLLBACK TRAN A;

	SET @Status = 0;
	SELECT ERROR_LINE(), ERROR_MESSAGE(), ERROR_PROCEDURE();
		
	DECLARE @Error_procedure VARCHAR(8000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(), @ErrorCall NVARCHAR(MAX)= 'EXEC Znode_ImportAttributes @TableName = '+CAST(@TableName AS VARCHAR(max)) +',@Status='+ CAST(@Status AS VARCHAR(10))+',@UserId = '+CAST(@UserId AS VARCHAR(50))+',@ImportProcessLogId='+CAST(@ImportProcessLogId AS VARCHAR(10))+',@NewGUId='+CAST(@NewGUId AS VARCHAR(200));


	---Import process updating fail due to database error
	UPDATE ZnodeImportProcessLog
	SET Status = dbo.Fn_GetImportStatus( 3 ), ProcessCompletedDate = @GetDate
	WHERE ImportProcessLogId = @ImportProcessLogId;

	---Loging error for Import process due to database error
	INSERT INTO ZnodeImportLog( ErrorDescription, ColumnName, Data, GUID, CreatedBy, CreatedDate, ModifiedBy, ModifiedDate, ImportProcessLogId )
	SELECT '93', '', '', @NewGUId,  @UserId, @GetDate, @UserId, @GetDate, @ImportProcessLogId

	--Updating total and fail record count
	UPDATE ZnodeImportProcessLog SET FailedRecordcount = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) WHERE ImportProcessLogId = @ImportProcessLogId) , SuccessRecordCount = 0 ,
	TotalProcessedRecords = (SELECT TOP 1 RowsCount FROM Znode_ImportCsvRowCount with (nolock) Where ImportProcessLogId = @ImportProcessLogId)
	WHERE ImportProcessLogId = @ImportProcessLogId;

	EXEC Znode_InsertProcedureErrorLog
	@ProcedureName = 'Znode_ImportSynonyms',
	@ErrorInProcedure = @Error_procedure,
	@ErrorMessage = @ErrorMessage,
	@ErrorLine = @ErrorLine,
	@ErrorCall = @ErrorCall;

END CATCH;
END;

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','CreateScheduler',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'CreateScheduler')

INSERT INTO ZnodeActionMenu ( MenuId,        ActionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')        
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'CreateScheduler') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'CreateScheduler'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,        ActionId, AccessPermissionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'CreateScheduler')        
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'CreateScheduler'))


INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'ContentContainer','EditScheduler',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditScheduler')

INSERT INTO ZnodeActionMenu ( MenuId,        ActionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer')        
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditScheduler') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditScheduler'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,        ActionId, AccessPermissionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditScheduler')        
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Content Containers' AND ControllerName = 'ContentContainer') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'ContentContainer' and ActionName = 'EditScheduler'))


GO

Insert  INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
select NULL ,'Store','GetProviderTypeForm',1,2,Getdate(),2,Getdate()
where not exists(select * from ZnodeActions where ControllerName = 'Store' and ActionName = 'GetProviderTypeForm')

insert into ZnodeActionMenu ( MenuId, ActionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
 (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store')
    ,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'GetProviderTypeForm') ,2,Getdate(),2,Getdate()
where not exists (select * from ZnodeActionMenu where MenuId =
     (select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'GetProviderTypeForm'))

insert into ZnodeMenuActionsPermission ( MenuId, ActionId, AccessPermissionId, CreatedBy ,CreatedDate, ModifiedBy, ModifiedDate )
select
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store')
,(select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'GetProviderTypeForm')
,1,2,Getdate(),2,Getdate() where not exists
(select * from ZnodeMenuActionsPermission where MenuId =
(select TOP 1 MenuId from ZnodeMenu where MenuName = 'Stores' AND ControllerName = 'Store') and ActionId =
     (select TOP 1 ActionId from ZnodeActions where ControllerName = 'Store' and ActionName= 'GetProviderTypeForm'))

GO

UPDATE ZnodeCMSWidgetTitleConfiguration
SET CMSWidgetsId=(SELECT TOP 1 CMSWidgetsId FROM ZnodeCMSWidgets WHERE Code='LinkPanel')
WHERE TitleCode='Register for a Business Account'
AND CMSWidgetsId = (SELECT TOP 1 CMSWidgetsId FROM ZnodeCMSWidgets WHERE Code='Helps')
AND WidgetsKey='2243'
AND CMSMappingId=(SELECT TOP 1 PortalId FROM ZnodePortal WHERE StoreCode='MaxwellsHardware' OR CompanyName='Maxwell''s Hardware')
AND TypeOFMapping='PortalMapping'

GO

IF EXISTS(SELECT * FROM SYS.PROCEDURES WHERE NAME = 'Znode_InsertSaveCartLineItemsForReOrder')
	DROP PROC Znode_InsertSaveCartLineItemsForReOrder
GO

CREATE PROCEDURE [dbo].[Znode_InsertSaveCartLineItemsForReOrder] 
(
	@OmsOrderId INT, 
	@OmsSavedCartId INT ,
	@UserId INT ,
	@OmsOrderLineItemsId INT = 0,
	@Status BIT = 0 OUT
)
AS 
BEGIN 
BEGIN TRY 
  SET NOCOUNT ON 
  DECLARE @TBL_ZnodeOmsSavedCartLineItem TABLE (OmsSavedCartLineItemId INT , RowId INT)
  DECLARE @GetDate DATETIME = dbo.FN_getDate() 
  DECLARE @AddOnOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Addons')

   DECLARE @BundleOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Bundles')

   DECLARE @GroupOrderLineItemRelationshipTypeId INT = (SELECT TOP 1 OrderLineItemRelationshipTypeId 
															FROM ZnodeOmsOrderLineItemRelationshipType
															WHERE Name = 'Group')

   DECLARE @OmsOrderStateId_RETURNED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'RETURNED')
   DECLARE @OmsOrderStateId_CANCELED INT = (SELECT TOP 1 ZOOS.OmsOrderStateId FROM ZnodeOmsOrderState ZOOS WHERE ZOOS.OrderStateName = 'CANCELED')

   CREATE TABLE #ZnodeOmsOrderLineItems_temp (OmsOrderLineItemsId INT ,ParentOmsOrderLineItemsId INT,OmsOrderDetailsId INT , SKU  NVARCHAr(2000),
   OrderLineItemRelationshipTypeID INT ,AutoAddonSKU NVARCHAR(400),Custom1 NVARCHAR(MAX),Custom2 NVARCHAR(MAX),Custom3 NVARCHAR(MAX),Custom4 NVARCHAR(MAX)
   ,Custom5 NVARCHAR(MAX), GroupId nvarchar(MAX),ProductName NVARCHAr(2000), Description nvarchar(MAX),Quantity NUMERIC(28,6), ROWID INT, ParentRowID INT)

  IF EXISTS (SELECT TOP 1 OmsOrderDetailsId  FROM ZnodeOmsOrderDetails WHERE  OmsOrderId =  @OmsOrderId AND IsActive =1 )
  BEGIN 

	  ;WITH CTE_OrderData AS
	  (
		  SELECT MIN(ZOOLI.OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ZOOLI.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			  ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4,
			  ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description,SUM(ZOOLI.Quantity) AS Quantity
		  FROM ZnodeOmsOrderLineItems ZOOLI WITH (NOLOCK)
		  INNER JOIN ZnodeOmsOrderDetails ZOOD WITH (NOLOCK) ON ZOOLI.OmsOrderDetailsId = ZOOD.OmsOrderDetailsId
		  WHERE  ZOOD.OmsOrderId =  @OmsOrderId AND ZOOD.IsActive =1 
		  AND CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 0 ELSE  ZOOLI.OrderLineItemStateId END  <> CASE WHEN ZOOD.OmsOrderStateId = @OmsOrderStateId_CANCELED THEN 1 ELSE  @OmsOrderStateId_RETURNED END 
		  GROUP BY ZOOLI.OmsOrderDetailsId,ZOOLI.SKU,ZOOLI.OrderLineItemRelationshipTypeID,ZOOLI.AutoAddonSKU,
			ZOOLI.Custom1,ZOOLI.Custom2,ZOOLI.Custom3,ZOOLI.Custom4, ZOOLI.Custom5,ZOOLI.GroupId,ZOOLI.ProductName,ZOOLI.Description
	  )
	  INSERT INTO #ZnodeOmsOrderLineItems_temp
	  SELECT *
		,Row_number()Over(Order By OmsOrderLineItemsId )  RowId, NULL ParentRowId
	  FROM CTE_OrderData
	  ORDER BY OmsOrderLineItemsId 
  END

  ELSE 
  BEGIN
		;WITH CTE_OrderData AS
		  (
			  SELECT MIN(OmsOrderLineItemsId) AS OmsOrderLineItemsId, MIN(ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
				  ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				  ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
				  ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
			  FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
			  WHERE ( ZOO.OmsOrderLineItemsId = @OmsOrderLineItemsId OR ZOO.ParentOmsOrderLineItemsId = @OmsOrderLineItemsId ) 
			  AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE ZOO.OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
			  GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
				ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4, ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description
		 )
		 INSERT INTO #ZnodeOmsOrderLineItems_temp
		 SELECT *,Row_number()Over(Order By OmsOrderLineItemsId )   RowId, NULL ParentRowId
		 FROM CTE_OrderData

		INSERT INTO #ZnodeOmsOrderLineItems_temp 
		SELECT MIN(ZOO.OmsOrderLineItemsId) AS OmsOrderLineItemsId,MIN(ZOO.ParentOmsOrderLineItemsId) AS ParentOmsOrderLineItemsId,
		ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
		ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,
		ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description,SUM(ZOO.Quantity) AS Quantity
		,0 RowId, NULL ParentRowId
		FROM ZnodeOmsOrderLineItems ZOO WITH (NOLOCK)
		WHERE ZOO.OmsOrderLineItemsId = (SELECT TOP 1 ParentOmsOrderLineItemsId FROM #ZnodeOmsOrderLineItems_temp TY WHERE TY.ParentOmsOrderLineItemsId IS NOT NULL 
		AND TY.OrderLineItemRelationshipTypeID <> @AddOnOrderLineItemRelationshipTypeId )
		AND ZOO.ParentOmsOrderLineItemsId  IS NULL
		AND NOT EXISTS(SELECT * FROM ZnodeOmsOrderState ZOOS WHERE OrderLineItemStateId = ZOOS.OmsOrderStateId AND ZOOS.OrderStateName IN ( 'RETURNED'))
		AND NOT EXISTS(SELECT * FROM #ZnodeOmsOrderLineItems_temp tem WHERE tem.OmsOrderLineItemsId = ZOO.OmsOrderLineItemsId )
		GROUP BY ZOO.OmsOrderDetailsId,ZOO.SKU,ZOO.OrderLineItemRelationshipTypeID,ZOO.AutoAddonSKU,
			ZOO.Custom1,ZOO.Custom2,ZOO.Custom3,ZOO.Custom4,ZOO.Custom5,ZOO.GroupId,ZOO.ProductName,ZOO.Description;

  END

     DECLARE @TBL_OmsSavedCartOld TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 DECLARE @TBL_OmsSavedCartNew TABLE(SKU NVARCHAR(2000), OmsSavedCartLineItemId INT ,ParentSKU NVARCHAR(2000) , ParentOmsSavedCartLineItemId INT ,AddOnSKU NVARCHAR(2000), OmsSavedCartLineItemIdAddOn NVARCHAR(2000) ,PersonalizeCode NVARCHAR(1200), PersonalizeValue  NVARCHAr(max)  )

	 
	 SELECT SKU , OmsOrderLineItemsId, ParentOmsOrderLineItemsId, OrderLineItemRelationshipTypeID,Quantity 
	 INTO #ZnodeOmsSavedCartLineItemOld
	 FROM #ZnodeOmsOrderLineItems_temp a 

	 SELECT OmsOrderLineItemsId, PersonalizeCode, PersonalizeValue  
	 INTO #ZnodeOmsPersonalizeCartItemOld
	 FROM ZnodeOmsPersonalizeItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp t WHERE t.OmsOrderLineItemsId = a.OmsOrderLineItemsId)

	 SELECT SKU , OmsSavedCartLineItemId, ParentOmsSavedCartLineItemId, OrderLineItemRelationshipTypeID, Quantity
	 INTO #ZnodeOmsSavedCartLineItemNew
	 FROM ZnodeOmsSavedCartLineItem a WITH (NOLOCK)
	 WHERE OmsSavedCartId = @OmsSavedCartId 


	 SELECT OmsSavedCartLineItemId, PersonalizeCode, PersonalizeValue   
	 INTO #ZnodeOmsPersonalizeCartItemNew
	 FROM ZnodeOmsPersonalizeCartItem a WITH (NOLOCK)
	 WHERE EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)

	 INSERT INTO @TBL_OmsSavedCartOld (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	 SELECT SKU , OmsOrderLineItemsId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemOld TBL_B WHERE TBL_B.OmsOrderLineItemsId = ISNULL(TBL_A.ParentOmsOrderLineItemsId,0)  ) ParentSKU
				, ParentOmsOrderLineItemsId
	 FROM #ZnodeOmsSavedCartLineItemOld TBL_A
	 WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId

	 ;With Cte_UpdateOld AS 
	 (
		SELECT ParentOmsOrderLineItemsId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsOrderLineItemsId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemOld t WHERE t.ParentOmsOrderLineItemsId = a.ParentOmsOrderLineItemsId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemOld a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartOld TBL_O 
	 INNER JOIN Cte_UpdateOld TBL_ON ON (TBL_ON.ParentOmsOrderLineItemsId  = TBL_O.OmsSavedCartLineItemId )

	  INSERT INTO @TBL_OmsSavedCartNew (SKU,OmsSavedCartLineItemId,ParentSKU,ParentOmsSavedCartLineItemId)
	  SELECT SKU , OmsSavedCartLineItemId,(SELECT TOP 1 SKU FROM #ZnodeOmsSavedCartLineItemNew TBL_B WHERE TBL_B.OmsSavedCartLineItemId = ISNULL( TBL_A.ParentOmsSavedCartLineItemId,0)   ) ParentSKU
				, ParentOmsSavedCartLineItemId
	  FROM #ZnodeOmsSavedCartLineItemNew TBL_A
	  WHERE OrderLineItemRelationshipTypeId IS NOT NULL AND OrderLineItemRelationshipTypeId <> @AddOnOrderLineItemRelationshipTypeId
	 
	 ;With Cte_UpdateNew AS 
	 (
		SELECT ParentOmsSavedCartLineItemId , SUBSTRING((SELECT ','+SKU FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  SKU
		     , SUBSTRING((SELECT ','+CAST(OmsSavedCartLineItemId AS NVARCHAR(max)) FROM #ZnodeOmsSavedCartLineItemNew t WHERE t.ParentOmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId FOR XML PATH('') ),2,4000)  OmsSavedCartLineItemId
		FROM #ZnodeOmsSavedCartLineItemNew a 
		WHERE a.OrderLineItemRelationshipTypeId = @AddOnOrderLineItemRelationshipTypeId
	 )	 
	 UPDATE TBL_O
	 SET TBL_O.AddOnSKU =  TBL_ON.SKU
		,TBL_O.OmsSavedCartLineItemIdAddOn =  TBL_ON.OmsSavedCartLineItemId
	 FROM @TBL_OmsSavedCartNew TBL_O 
	 INNER JOIN Cte_UpdateNew TBL_ON ON (TBL_ON.ParentOmsSavedCartLineItemId  = TBL_O.OmsSavedCartLineItemId )

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000) 
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemNew TBL_ON WHERE TBL_ON.OmsSavedCartLineItemId  = TBL_O.ParentOmsSavedCartLineItemId   FOR XML PATH ('')),2,4000)  
	  FROM @TBL_OmsSavedCartNew TBL_O 
	

	  UPDATE TBL_O
	  SET TBL_O.PersonalizeCode = SUBSTRING((SELECT ','+TBL_ON.PersonalizeCode FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000)
		,TBL_O.PersonalizeValue =  SUBSTRING((SELECT ','+TBL_ON.PersonalizeValue FROM #ZnodeOmsPersonalizeCartItemOld TBL_ON WHERE  TBL_ON.OmsOrderLineItemsId  = TBL_O.ParentOmsSavedCartLineItemId  FOR XML PATH ('')),2,4000) 
	  FROM @TBL_OmsSavedCartOld TBL_O 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartOld RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartOld a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	  UPDATE a 
	  SET   a.PersonalizeCode = ISNULL((SELECT TOP 1 PersonalizeCode FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeCode)
	  ,a.PersonalizeValue = ISNULL((SELECT TOP 1 PersonalizeValue FROM @TBL_OmsSavedCartNew RT WHERE RT.OmsSavedCartLineItemId = a.ParentOmsSavedCartLineItemId  ),a.PersonalizeValue)
	  FROM @TBL_OmsSavedCartNew a 
	  WHERE a.ParentOmsSavedCartLineItemId IS NOT NULL 

	 UPDATE a 
	 SET  a.Quantity =  a.Quantity+d.Quantity 
	 FROM ZnodeOmsSavedCartLineItem a 
	 INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
	 INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
	 INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId)

	 ;WITH CTE_UpdateOrder 
	 AS 
	 (
	   SELECT Sequence,  ROW_NUMBER()Over(order BY OmsSavedCartLineItemId ASC) RowId
	   FROM ZnodeOmsSavedCartLineItem WITH (NOLOCK)
	   WHERE  OmsSavedCartId = @OmsSavedCartId
	 
	 ) 
	 UPDATE CTE_UpdateOrder 
	 SET Sequence = RowId

		DECLARE @DeletedId TABLE (OmsSavedCartLineItemId INT )

	
		DELETE  FROM #ZnodeOmsOrderLineItems_temp OUTPUT DELETED.OmsOrderLineItemsId INTO @DeletedId WHERE OmsOrderLineItemsId IN (SELECT c.OmsSavedCartLineItemId FROM ZnodeOmsSavedCartLineItem a 
		INNER JOIN @TBL_OmsSavedCartNew b ON (b.OmsSavedCartLineItemId = a.OmsSavedCartLineItemId)
		INNER JOIN @TBL_OmsSavedCartOld c ON (c.SKU = b.SKU AND c.ParentSKU = b.ParentSKU AND ISNULL(c.AddOnSKU,'-1') = ISNULL(b.AddOnSKU,'-1') AND ISNULL(c.PersonalizeCode,'-1') = ISNULL(b.PersonalizeCode,'-1') AND ISNULL(c.PersonalizeValue,'-1') = ISNULL(b.PersonalizeValue,'-1')) 
		INNER JOIN #ZnodeOmsSavedCartLineItemOld d ON (d.OmsOrderLineItemsId = c.OmsSavedCartLineItemId))


		DELETE FROM #ZnodeOmsOrderLineItems_temp WHERE ParentOmsOrderLineItemsId IN (SELECT OmsSavedCartLineItemId FROM @DeletedId)

		DELETE TR FROM #ZnodeOmsOrderLineItems_temp TR 
		WHERE NOT EXISTS (SELECT TOP 1 1 FROM #ZnodeOmsOrderLineItems_temp YU WHERE TR.OmsOrderLineItemsId = YU.ParentOmsOrderLineItemsId  ) 
		AND TR.ParentOmsOrderLineItemsId IS NULL 

		UPDATE B
		SET B.ParentRowID = A.ROWID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON A.OmsOrderLineItemsId = B.ParentOmsOrderLineItemsId
		WHERE A.ParentOmsOrderLineItemsId IS NULL

		UPDATE B
		SET B.ParentRowID = A.ParentRowID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON (A.OrderLineItemRelationshipTypeID=B.OrderLineItemRelationshipTypeID)
		WHERE A.ParentOmsOrderLineItemsId IS NOT NULL AND B.ParentRowID IS NULL

		UPDATE B
		SET B.ParentRowID = A.ROWID
		FROM #ZnodeOmsOrderLineItems_temp A
		INNER JOIN #ZnodeOmsOrderLineItems_temp B ON (A.OmsOrderLineItemsId=B.ParentOmsOrderLineItemsId AND B.OrderLineItemRelationshipTypeID IS NOT NULL)
		WHERE A.ParentOmsOrderLineItemsId IS NOT NULL AND B.ParentRowID IS NULL AND B.OrderLineItemRelationshipTypeID=@AddOnOrderLineItemRelationshipTypeId

	BEGIN TRANSACTION ReorderSaveCart
		INSERT INTO ZnodeOmsSavedCartLineItem (ParentOmsSavedCartLineItemId,OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,CustomText,CartAddOnDetails
											,Sequence,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,AutoAddon,OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description)
		OUTPUT INSERTED.OmsSavedCartLineItemId,INSERTED.Sequence INTO @TBL_ZnodeOmsSavedCartLineItem 
		SELECT NULL,@OmsSavedCartId,SKU,Quantity,OrderLineItemRelationshipTypeId,NULL CustomText, NULL CartAddOnDetails
											,RowId,@UserId,@GetDate,@UserId,@GetDate,AutoAddonSKU,NULL OmsOrderId,Custom1,Custom2,Custom3,Custom4,Custom5,GroupId
											,ProductName,Description
		FROM #ZnodeOmsOrderLineItems_temp 
		ORDER BY OmsOrderLineItemsId 

		UPDATE ab 
		SET ab.ParentOmsSavedCartLineItemId = 
			(SELECT TOP 1 OmsSavedCartLineItemId FROM @TBL_ZnodeOmsSavedCartLineItem av WHERE av.RowId = b.ParentRowID)
		FROM ZnodeOmsSavedCartLineItem ab 
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem a ON (a.OmsSavedCartLineItemId = ab.OmsSavedCartLineItemId) 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON  (b.RowId = a.RowId) 

		INSERT INTO ZnodeOmsPersonalizeCartItem (OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,DesignId,ThumbnailURL)
		SELECT c.OmsSavedCartLineItemId,PersonalizeCode,PersonalizeValue,@UserId,@GetDate,@UserId,@GetDate,DesignId,ThumbnailURL
		FROM ZnodeOmsPersonalizeItem  a 
		INNER JOIN #ZnodeOmsOrderLineItems_temp b ON (a.OmsOrderLineItemsId = b.OmsOrderLineItemsId)
		INNER JOIN @TBL_ZnodeOmsSavedCartLineItem c ON (c.RowId = b.RowId)

		UPDATE ZOSCLI1 set Quantity = null
		from ZnodeOmsSavedCartLineItem ZOSCLI1
		where ParentOmsSavedCartLineItemId is null and OmsSavedCartId = @OmsSavedCartId
		and Quantity is not null
		and not exists(select * from ZnodeOmsSavedCartLineItem ZOSCLI where OrderLineItemRelationshipTypeId IN (@BundleOrderLineItemRelationshipTypeId,@GroupOrderLineItemRelationshipTypeId ) and ZOSCLI1.OmsSavedCartLineItemId = ZOSCLI.ParentOmsSavedCartLineItemId )

		--Update Qty for Parentlineitem except simple product
		UPDATE ZOSCLI
		SET Quantity = ZOSCLI.Quantity+Old.Quantity
		FROM ZnodeOmsSavedCartLineItem ZOSCLI
		INNER JOIN #ZnodeOmsSavedCartLineItemNew New ON (ZOSCLI.OmsSavedCartLineItemId = New.OmsSavedCartLineItemId)
		INNER JOIN #ZnodeOmsSavedCartLineItemOld Old ON (New.SKU = Old.SKU)
		WHERE ZOSCLI.ParentOmsSavedCartLineItemId IS NULL AND OmsSavedCartId = @OmsSavedCartId AND ZOSCLI.Quantity IS NOT NULL
	    --AND EXISTS(SELECT * FROM ZnodeOmsSavedCartLineItem ZOSCLI WHERE OrderLineItemRelationshipTypeId=@BundleOrderLineItemRelationshipTypeId)

		UPDATE ZnodeOmsSavedCart
		SET ModifiedDate = GETDATE()
		WHERE OmsSavedCartId = @OmsSavedCartId
	COMMIT TRANSACTION ReorderSaveCart
	SET @status = 1 
   
	END TRY 
	BEGIN CATCH 
		ROLLBACK TRANSACTION ReorderSaveCart
		SELECT ERROR_MESSAGE()
		SET @status = 0 

		DECLARE @Error_procedure VARCHAR(1000)= ERROR_PROCEDURE(), @ErrorMessage NVARCHAR(MAX)= ERROR_MESSAGE(), @ErrorLine VARCHAR(100)= ERROR_LINE(),
		@ErrorCall NVARCHAR(MAX)= 'EXEC Znode_InsertSaveCartLineItemsForReOrder @OmsOrderId = '+CAST(@OmsOrderId AS VARCHAR(max))+',@UserId='+CAST(@UserId AS VARCHAR(50))+',@OmsSavedCartId='+CAST(@OmsSavedCartId AS VARCHAR(50))+',@OmsOrderLineItemsId='+CAST(@OmsOrderLineItemsId AS VARCHAR(50))+',@Status='+CAST(@Status AS VARCHAR(10));
              			 
		SELECT 0 AS ID,CAST(0 AS BIT) AS Status;                    
		  
		EXEC Znode_InsertProcedureErrorLog
		@ProcedureName = 'Znode_InsertSaveCartLineItemsForReOrder',
		@ErrorInProcedure = @Error_procedure,
		@ErrorMessage = @ErrorMessage,
		@ErrorLine = @ErrorLine,
		@ErrorCall = @ErrorCall;
	END CATCH 
END

GO

UPDATE ZnodeCMSWidgetTitleConfiguration
SET CMSWidgetsId=(SELECT TOP 1 CMSWidgetsId FROM ZnodeCMSWidgets WHERE Code='LinkPanel')
WHERE TitleCode='Promotional Products'
AND CMSWidgetsId = (SELECT TOP 1 CMSWidgetsId FROM ZnodeCMSWidgets WHERE Code='Helps')
AND WidgetsKey='2253'
AND CMSMappingId=(SELECT TOP 1 PortalId FROM ZnodePortal WHERE StoreCode='MaxwellsHardware' OR CompanyName='Maxwell''s Hardware')
AND TypeOFMapping='PortalMapping'

GO

UPDATE ZnodeCMSWidgetTitleConfiguration
SET CMSWidgetsId=(SELECT TOP 1 CMSWidgetsId FROM ZnodeCMSWidgets WHERE Code='LinkPanel')
WHERE TitleCode='Promotional Products'
	AND CMSWidgetsId = (SELECT TOP 1 CMSWidgetsId FROM ZnodeCMSWidgets WHERE Code='Helps')
	AND WidgetsKey='2253'
	AND CMSMappingId=(SELECT TOP 1 PortalId FROM ZnodePortal WHERE StoreCode='MaxwellsHardware' OR CompanyName='Maxwell''s Hardware')
	AND TypeOFMapping='PortalMapping'

GO

INSERT INTO ZnodeActions (AreaName,ControllerName,ActionName,IsGlobalAccess,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate)
SELECT NULL ,'Store','GetUnassociatedPaymentListForInvoice',0,2,Getdate(),2,Getdate() WHERE NOT EXISTS
(SELECT * FROM ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'GetUnassociatedPaymentListForInvoice')

INSERT INTO ZnodeActionMenu ( MenuId,        ActionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
 (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store')        
    ,(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'GetUnassociatedPaymentListForInvoice') ,2,Getdate(),2,Getdate()
WHERE NOT EXISTS (SELECT * FROM ZnodeActionMenu WHERE MenuId = 
     (SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store') and ActionId = 
     (SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'GetUnassociatedPaymentListForInvoice'))

INSERT INTO ZnodeMenuActionsPermission ( MenuId,        ActionId, AccessPermissionId,        CreatedBy ,CreatedDate,        ModifiedBy, ModifiedDate )
SELECT 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store'),
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'GetUnassociatedPaymentListForInvoice')        
,1,2,Getdate(),2,Getdate() WHERE NOT EXISTS 
(SELECT * FROM ZnodeMenuActionsPermission WHERE MenuId = 
(SELECT TOP 1 MenuId from ZnodeMenu WHERE MenuName = 'Stores' AND ControllerName = 'Store') and ActionId = 
(SELECT TOP 1 ActionId from ZnodeActions WHERE ControllerName = 'Store' and ActionName = 'GetUnassociatedPaymentListForInvoice'))

